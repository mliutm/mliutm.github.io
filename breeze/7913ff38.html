<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ElasticSearch集群 | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ElasticSearch集群内容 ES集群概念 ES集群搭建  https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;43437056    123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676"><meta property="og:type" content="article"><meta property="og:title" content="ElasticSearch集群"><meta property="og:url" content="https://mliutm.github.io/breeze/7913ff38.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="ElasticSearch集群内容 ES集群概念 ES集群搭建  https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;43437056    123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/premium_photo-1695185954894-e9382c6f4da8.jpg"><meta property="article:published_time" content="2024-01-14T14:34:16.000Z"><meta property="article:modified_time" content="2024-01-14T14:43:35.019Z"><meta property="article:author" content="清风"><meta property="article:tag" content="ES集群"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/premium_photo-1695185954894-e9382c6f4da8.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/7913ff38.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ElasticSearch集群",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-14 22:43:35"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/premium_photo-1695185954894-e9382c6f4da8.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-14T14:34:16.000Z" title="发表于 2024-01-14 22:34:16">2024-01-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-14T14:43:35.019Z" title="更新于 2024-01-14 22:43:35">2024-01-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E8%83%BD%E6%8F%90%E5%8D%87/">技能提升</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="ElasticSearch集群"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ElasticSearch集群"><a href="#ElasticSearch集群" class="headerlink" title="ElasticSearch集群"></a>ElasticSearch集群</h1><h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ul><li>ES集群概念</li><li>ES集群搭建</li></ul><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/43437056">https://zhuanlan.zhihu.com/p/43437056</a></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">一、 硬件环境选择：-比极高</span><br><span class="line">如果有条件，尽可能使用SSD硬盘， 不错的CPU。ES的厉害之处在于ES本身的分布式架构以及lucene的特性。IO的提升，会极大改进ES的速度和性能。</span><br><span class="line">二、系统拓朴设计：es节点类型比例设置合理</span><br><span class="line">ES集群在架构拓朴时，一般都会采用Hot-Warm的架构模式，即设置<span class="number">3</span>种不同类型的节点：Master节点、data 节点和 Warm(client)节点。</span><br><span class="line">三、ES的内存设置：</span><br><span class="line">由于ES构建基于lucene, 而lucene设计强大之处在于lucene能够很好的利用操作系统内存来缓存索引数据，以提供快速的查询性能。lucene的索引文件segements是存储在单文件中的，并且不可变，对于OS来说，能够很友好地将索引文件保持在<span class="keyword">cache</span>中，以便快速访问；因此，我们很有必要将一半的物理内存留给lucene ; 另一半的物理内存留给ES（JVM heap )。所以， 在ES内存设置方面，可以遵循以下原则：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 当机器内存小于<span class="number">64</span>G时，遵循通用的原则，<span class="number">50</span>%给ES，<span class="number">50</span>%留给lucene。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 当机器内存大于<span class="number">64</span>G时，遵循以下原则：</span><br><span class="line"></span><br><span class="line">a. 如果主要的使用场景是全文检索, 那么建议给ES Heap分配 <span class="number">4</span>~<span class="number">32</span>G的内存即可；其它内存留给操作系统, 供lucene使用（segments <span class="keyword">cache</span>), 以提供更快的查询性能。</span><br><span class="line">b. 如果主要的使用场景是聚合或排序， 并且大多数是numerics, dates, geo_points 以及not_analyzed的字符类型， 建议分配给ES Heap分配 <span class="number">4</span>~<span class="number">32</span>G的内存即可，其它内存留给操作系统，供lucene使用(doc <span class="keyword">values</span> <span class="keyword">cache</span>)，提供快速的基于文档的聚类、排序性能。</span><br><span class="line">c. 如果使用场景是聚合或排序，并且都是基于analyzed字符数据，这时需要更多的 heap size, 建议机器上运行多ES实例，每个实例保持不超过<span class="number">50</span>%的ES heap设置(但不超过<span class="number">32</span>G，堆内存设置<span class="number">32</span>G以下时，JVM使用对象指标压缩技巧节省空间)，<span class="number">50</span>%以上留给lucene。</span><br><span class="line"><span class="number">3.</span> 禁止swap，一旦允许内存与磁盘的交换，会引起致命的性能问题。 通过： 在elasticsearch.yml 中 bootstrap.memory_lock: <span class="keyword">true</span>， 以保持JVM锁定内存，保证ES的性能。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> GC设置原则：</span><br><span class="line"></span><br><span class="line">a. 保持GC的现有设置，默认设置为：Concurrent-Mark <span class="keyword">and</span> Sweep (CMS)，别换成G1GC，因为目前G1还有很多BUG。</span><br><span class="line">b. 保持线程池的现有设置，目前ES的线程池较<span class="number">1.</span>X有了较多优化设置，保持现状即可；默认线程池大小等于CPU核心数。如果一定要改，按公式（（CPU核心数* <span class="number">3</span>）/ <span class="number">2</span>）+ <span class="number">1</span> 设置；不能超过CPU核心数的<span class="number">2</span>倍；但是不建议修改默认配置，否则会对CPU造成硬伤。</span><br><span class="line"></span><br><span class="line">四、 集群分片设置：</span><br><span class="line">ES一旦创建好索引后，就无法调整分片的设置，而在ES中，一个分片实际上对应一个lucene 索引，而lucene索引的读写会占用很多的系统资源，因此，分片数不能设置过大；所以，在创建索引时，合理配置分片数是非常重要的。一般来说，我们遵循一些原则：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 控制每个分片占用的硬盘容量不超过ES的最大JVM的堆空间设置（一般设置不超过<span class="number">32</span>G，参加上文的JVM设置原则），因此，如果索引的总容量在<span class="number">500</span>G左右，那分片大小在<span class="number">16</span>个左右即可；当然，最好同时考虑原则<span class="number">2</span>。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 考虑一下node数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了<span class="number">1</span>个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的<span class="number">3</span>倍。</span><br><span class="line">五、 <span class="keyword">Mapping</span>建模:</span><br><span class="line"><span class="number">1.</span> 尽量避免使用nested或 parent/child，能不用就不用；nested query慢， parent/child query 更慢，比nested query慢上百倍；因此能在<span class="keyword">mapping</span>设计阶段搞定的（大宽表设计或采用比较smart的数据结构），就不要用父子关系的<span class="keyword">mapping</span>。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 如果一定要使用nested fields，保证nested fields字段不能过多，目前ES默认限制是<span class="number">50</span>。参考：</span><br><span class="line"></span><br><span class="line"><span class="keyword">index</span>.<span class="keyword">mapping</span>.nested_fields.<span class="keyword">limit</span> ：<span class="number">50</span></span><br><span class="line">因为针对<span class="number">1</span>个document, 每一个nested field, 都会生成一个独立的document, 这将使Doc数量剧增，影响查询效率，尤其是<span class="keyword">JOIN</span>的效率。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 避免使用动态值作字段(key), 动态递增的<span class="keyword">mapping</span>，会导致集群崩溃；同样，也需要控制字段的数量，业务中不使用的字段，就不要索引。控制索引的字段数量、<span class="keyword">mapping</span>深度、索引字段的类型，对于ES的性能优化是重中之重。以下是ES关于字段数、<span class="keyword">mapping</span>深度的一些默认设置：</span><br><span class="line"></span><br><span class="line"><span class="keyword">index</span>.<span class="keyword">mapping</span>.nested_objects.<span class="keyword">limit</span> :<span class="number">10000</span></span><br><span class="line"><span class="keyword">index</span>.<span class="keyword">mapping</span>.total_fields.<span class="keyword">limit</span>:<span class="number">1000</span></span><br><span class="line"><span class="keyword">index</span>.<span class="keyword">mapping</span>.depth.<span class="keyword">limit</span>: <span class="number">20</span></span><br><span class="line"></span><br><span class="line">六、 索引优化设置：</span><br><span class="line"><span class="number">1.</span>设置refresh_interval 为<span class="number">-1</span>，同时设置number_of_replicas 为<span class="number">0</span>，通过关闭<span class="keyword">refresh</span>间隔周期，同时不设置副本来提高写性能。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 修改index_buffer_size 的设置，可以设置成百分数，也可设置成具体的大小，大小可根据集群的规模做不同的设置测试。</span><br><span class="line"></span><br><span class="line"> indices.memory.index_buffer_size：<span class="number">10</span>%（默认）</span><br><span class="line">indices.memory.min_index_buffer_size： <span class="number">48</span>mb（默认）</span><br><span class="line">indices.memory.max_index_buffer_size</span><br><span class="line"><span class="number">3.</span> 修改translog相关的设置：</span><br><span class="line"></span><br><span class="line">a. 控制数据从内存到硬盘的操作频率，以减少硬盘IO。可将sync_interval的时间设置大一些。</span><br><span class="line"><span class="keyword">index</span>.translog.sync_interval：<span class="number">5</span>s(默认)。</span><br><span class="line">b. 控制tranlog数据块的大小，达到threshold大小时，才会flush到lucene索引文件。</span><br><span class="line"><span class="keyword">index</span>.translog.flush_threshold_size：<span class="number">512</span>mb(默认)</span><br><span class="line"><span class="number">4.</span> _id字段的使用，应尽可能避免自定义_id, 以避免针对ID的版本管理；建议使用ES的默认ID生成策略或使用数字类型ID做为主键。</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> _all字段及_source字段的使用，应该注意场景和需要，_all字段包含了所有的索引字段，方便做全文检索，如果无此需求，可以禁用；_source存储了原始的document内容，如果没有获取原始文档数据的需求，可通过设置includes、excludes 属性来定义放入_source的字段。</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 合理的配置使用<span class="keyword">index</span>属性，analyzed 和not_analyzed，根据业务需求来控制字段是否分词或不分词。只有 groupby需求的字段，配置时就设置成not_analyzed, 以提高查询或聚类的效率。</span><br><span class="line"></span><br><span class="line">七、 查询优化：</span><br><span class="line"><span class="number">1.</span> query_string 或 multi_match的查询字段越多， 查询越慢。可以在<span class="keyword">mapping</span>阶段，利用copy_to属性将多字段的值索引到一个新字段，multi_match时，用新的字段查询。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 日期字段的查询， 尤其是用now 的查询实际上是不存在缓存的，因此， 可以从业务的角度来考虑是否一定要用now, 毕竟利用query <span class="keyword">cache</span> 是能够大大提高查询效率的。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 查询结果集的大小不能随意设置成大得离谱的值， 如query.setSize不能设置成 <span class="type">Integer</span>.MAX_VALUE， 因为ES内部需要建立一个数据结构来放指定大小的结果集数据。</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 尽量避免使用script，万不得已需要使用的话，选择painless &amp; experssions 引擎。一旦使用script查询，一定要注意控制返回，千万不要有死循环（如下错误的例子），因为ES没有脚本运行的超时控制，只要当前的脚本没执行完，该查询会一直阻塞。</span><br><span class="line"></span><br><span class="line">如： &#123;</span><br><span class="line">    “script_fields”：&#123;</span><br><span class="line">        “test1”：&#123;</span><br><span class="line">            “lang”：“groovy”，</span><br><span class="line">            “script”：“<span class="keyword">while</span>（<span class="keyword">true</span>）&#123;print <span class="string">&#x27;don’t use script&#x27;</span>&#125;”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5.</span> 避免层级过深的聚合查询， 层级过深的<span class="keyword">group</span> <span class="keyword">by</span> , 会导致内存、CPU消耗，建议在服务层通过程序来组装业务，也可以通过pipeline的方式来优化。</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> 复用预索引数据方式来提高AGG性能：</span><br><span class="line"></span><br><span class="line">如通过 terms aggregations 替代 range aggregations， 如要根据年龄来分组，分组目标是: 少年（<span class="number">14</span>岁以下） 青年（<span class="number">14</span><span class="number">-28</span>） 中年（<span class="number">29</span><span class="number">-50</span>） 老年（<span class="number">51</span>以上）， 可以在索引的时候设置一个age_group字段，预先将数据进行分类。从而不用按age来做range aggregations, 通过age_group字段就可以了。</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> <span class="keyword">Cache</span>的设置及使用：</span><br><span class="line"></span><br><span class="line">a) QueryCache: ES查询的时候，使用filter查询会使用query <span class="keyword">cache</span>, 如果业务场景中的过滤查询比较多，建议将querycache设置大一些，以提高查询速度。</span><br><span class="line"></span><br><span class="line">indices.queries.<span class="keyword">cache</span>.size： <span class="number">10</span>%（默认），可设置成百分比，也可设置成具体值，如<span class="number">256</span>mb。</span><br><span class="line">当然也可以禁用查询缓存（默认是开启）， 通过<span class="keyword">index</span>.queries.cache.enabled：<span class="keyword">false</span>设置。</span><br><span class="line"></span><br><span class="line">b) FieldDataCache: 在聚类或排序时，field data <span class="keyword">cache</span>会使用频繁，因此，设置字段数据缓存的大小，在聚类或排序场景较多的情形下很有必要，可通过indices.fielddata.<span class="keyword">cache</span>.size：<span class="number">30</span>% 或具体值<span class="number">10</span>GB来设置。但是如果场景或数据变更比较频繁，设置<span class="keyword">cache</span>并不是好的做法，因为缓存加载的开销也是特别大的。</span><br><span class="line"></span><br><span class="line">c) ShardRequestCache: 查询请求发起后，每个分片会将结果返回给协调节点(Coordinating Node), 由协调节点将结果整合。</span><br><span class="line"></span><br><span class="line">如果有需求，可以设置开启; 通过设置index.requests.<span class="keyword">cache</span>.enable: true来开启。</span><br><span class="line"></span><br><span class="line">不过，shard request <span class="keyword">cache</span>只缓存hits.total, aggregations, suggestions类型的数据，并不会缓存hits的内容。也可以通过设置indices.requests.<span class="keyword">cache</span>.size: <span class="number">1</span>%（默认）来控制缓存空间大小。</span><br></pre></td></tr></table></figure><h2 id="一-ElasticSearch集群概念"><a href="#一-ElasticSearch集群概念" class="headerlink" title="一.ElasticSearch集群概念"></a>一.ElasticSearch集群概念</h2><h3 id="1-elasticsearch-head安装"><a href="#1-elasticsearch-head安装" class="headerlink" title="1 elasticsearch head安装"></a>1 elasticsearch head安装</h3><p>和kibana一样是一个图形界面工具，只能它更加强大，可以看到shard。</p><p>1)安装</p><p>下载</p><p>npm install -g cnpm –registry&#x3D;<a target="_blank" rel="noopener" href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a></p><p>cnpm install</p><p>cnpm run start</p><ol start="2"><li><p>配置</p><p>修改 elasticsearch&#x2F;config&#x2F;elasticsearch.yml</p></li></ol><p>http.cors.enabled: true</p><p>http.cors.allow-origin: “*”</p><ol start="3"><li>使用</li></ol><h3 id="2-集群相关概念"><a href="#2-集群相关概念" class="headerlink" title="2.集群相关概念"></a>2.集群相关概念</h3><h4 id="1-1-为什么要集群"><a href="#1-1-为什么要集群" class="headerlink" title="1.1.为什么要集群"></a>1.1.为什么要集群</h4><ul><li>单节点故障</li><li>支持高并发</li><li>海量数据存储</li></ul><h4 id="1-2-ES几大核心概念"><a href="#1-2-ES几大核心概念" class="headerlink" title="1.2.ES几大核心概念"></a>1.2.ES几大核心概念</h4><p><img src="/breeze/7913ff38/1675843129467.png" alt="1675843129467"></p><h5 id="1-Cluster：集群"><a href="#1-Cluster：集群" class="headerlink" title="1.Cluster：集群"></a>1.Cluster：集群</h5><p>包含多个节点，每个节点属于哪个集群是通过一个集群名称（集群名称，默认是elasticsearch）来决定的，对于中小型应用来说，刚开始一个集群就一个节点很正常</p><h5 id="2-Node：节点"><a href="#2-Node：节点" class="headerlink" title="2.Node：节点"></a>2.Node：节点</h5><p>集群中的一个节点，节点也有一个名称（默认是随机分配的），节点名称很重要（在执行运维管理操作的时候），默认节点会去加入一个名称为”elasticsearch”的集群，如果直接启动一堆节点，那么它们会自动组成一个elasticsearch集群，当然一个节点也可以组成一个elasticsearch集群</p><h5 id="3-shard（分片）"><a href="#3-shard（分片）" class="headerlink" title="3.shard（分片）"></a>3.shard（分片）</h5><p>单台机器无法存储大量数据，es可以将一个索引中的数据切分为多个shard，分布在多台服务器上存储。有了shard就可以横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能。每个shard都是一个lucene index。</p><h5 id="4-replica（复制品）"><a href="#4-replica（复制品）" class="headerlink" title="4.replica（复制品）"></a>4.replica（复制品）</h5><p>任何一个服务器随时可能故障或宕机，此时shard可能就会丢失，因此可以为每个shard创建多个replica副本。replica可以在shard故障时提供备用服务，保证数据不丢失，多个replica还可以提升搜索操作的吞吐量和性能。primary shard（建立索引库时一次设置，不能修改，默认5个），replica shard（随时修改数量，默认1个），默认每个索引10个shard，5个primary shard，5个replica shard，最小的高可用配置，是2台服务器。</p><p><img src="/breeze/7913ff38/1635917669260.png" alt="1635917669260"></p><h5 id="5-集群的健康状况"><a href="#5-集群的健康状况" class="headerlink" title="5.集群的健康状况"></a>5.集群的健康状况</h5><ul><li><p>green</p><p>所有的primary shard和replica shard 都是active活动状态 - 集群健康</p></li><li><p>yellow</p><p>所有的primary shard处于active活动状态，有部分的replica shard不处于active状态 - 集群能用</p></li><li><p>red</p><p>至少有一个primary shard不处于active活动状态就会出现red - 集群不健康-用不了</p></li></ul><h4 id="1-3-ES节点类型"><a href="#1-3-ES节点类型" class="headerlink" title="1.3.ES节点类型"></a>1.3.ES节点类型</h4><p>默认情况下，elasticsearch集群中每个节点都有成为主节点的资格，也都存储数据，还可以提供查询服务。在生产环境下，如果不修改elasticsearch节点的角色信息，在高数据量，高并发的场景下集群容易出现脑裂等问题。这些功能是由两个属性控制的。node.master 和 node.data 默认情况下这两个属性的值都是true。</p><table><thead><tr><th>配置</th><th>值</th><th>解释</th></tr></thead><tbody><tr><td>node.master</td><td>true</td><td>是否是主节点</td></tr><tr><td>node.data</td><td>true</td><td>是否存储数据</td></tr></tbody></table><ul><li><p>主节点master</p><p>node.master&#x3D;true,代表该节点有成为主节点资格，主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。一般会把主节点和数据节点分开，node.master&#x3D;true , node.data&#x3D;false</p></li><li><p><strong>数据节点data(shard)</strong></p><p>node.data&#x3D;true,数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等,数据节点对CPU,IO,内存要求较高，优化节点的时候需要做状态监控，资源不够时要做节点扩充。配置：mode.master&#x3D;false,mode.data&#x3D;true</p></li><li><p>负载均衡节点client</p><p>当主节点和数据节点配置都设置为false的时候，该节点只能处理路由请求，处理搜索，分发索引操作等，从本质上来说该客户节点表现为智能负载平衡器。配置：mode.master&#x3D;false,mode.data&#x3D;false</p></li><li><p>最佳实践</p><p>在一个生产集群中我们可以对这些节点的职责进行划分，建议集群中设置3台以上的节点作为master候选节点，这些节点只负责成为主节点，维护整个集群的状态。再根据数据量设置一批data节点，这些节点只负责存储数据，后期提供建立索引和查询索引的服务，这样的话如果用户请求比较频繁，这些节点的压力也会比较大，所以在集群中建议再设置一批client节点(node.master: false node.data: false)，这些节点只负责处理用户请求，实现请求转发，负载均衡等功能。<strong>3 6 3</strong></p></li></ul><h3 id="3-ES的集群理解"><a href="#3-ES的集群理解" class="headerlink" title="3.ES的集群理解"></a>3.ES的集群理解</h3><h4 id="2-1-shard-replica机制"><a href="#2-1-shard-replica机制" class="headerlink" title="2.1.shard&amp;replica机制"></a>2.1.shard&amp;replica机制</h4><ul><li><p>一个索引库包含多个shard，一个shard是最小工作单元，存储部分数据，完整的建立索引和处理索引的能力</p></li><li><p>primary shard不能和自己的replica shard放在同一个节点上（否则节点宕机，primary shard和副本都丢失，起不到容错的作用），但是可以和其他primary shard的replica shard放在同一个节点上</p></li><li><p>增减数据节点时，shard会自动在nodes中负载均衡</p><p><img src="/breeze/7913ff38/1635917467589.png" alt="1635917467589"></p></li><li><p>primary shard和replica shard，每个document肯定只存在于某一个primary shard以及其对应的replica shard中，不可能存在于多个primary shard,当文档被添加的时候，会根据routing_id(默认是document的id)进行”<code>hash(routing_id) % shardNumber（主）</code>“ 运算确定文档存储的Shard。</p></li><li><p>replica shard是primary shard的副本，负责容错，以及承担读请求负载 - 读写分离</p></li><li><p>primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随时修改</p></li><li><p>primary shard的默认数量是5，replica默认是1，默认有10个shard，5个primary shard，5个replica shard</p></li></ul><h4 id="2-2-图解Shard分配"><a href="#2-2-图解Shard分配" class="headerlink" title="2.2.图解Shard分配"></a>2.2.图解Shard分配</h4><h5 id="1-单node环境下创建index"><a href="#1-单node环境下创建index" class="headerlink" title="1.单node环境下创建index"></a>1.单node环境下创建index</h5><p>单node环境下，创建一个index，有3个primary shard，3个replica shard</p><p><img src="/breeze/7913ff38/image-20191115150151306.png" alt="image-20191115150151306"></p><ul><li>这个时候，只会将3个primary shard分配到仅有的一个node上去，另外3个replica shard是无法分配的</li><li>集群status是yellow</li><li>集群可以正常工作，但是一旦出现节点宕机，数据全部丢失，而且集群不可用，无法承接任何请求</li></ul><h5 id="2-两个node环境下创建index"><a href="#2-两个node环境下创建index" class="headerlink" title="2.两个node环境下创建index"></a>2.两个node环境下创建index</h5><p>2个node环境下，创建一个index, 3个primary shard，3个replica shard</p><p><img src="/breeze/7913ff38/image-20191115150344097.png" alt="image-20191115150344097"></p><h5 id="3-扩容极限，提升容错"><a href="#3-扩容极限，提升容错" class="headerlink" title="3.扩容极限，提升容错"></a>3.扩容极限，提升容错</h5><p>如何让性能达到更优?</p><ul><li>每个Node更少的Shard,每个Shard资源跟充沛,性能更高</li><li>扩容极限：6个shard（3 primary，3 replica），最多扩容到6台机器，每个shard可以占用单台服务器的所有资源，性能最好</li><li>超出扩容极限，动态修改replica数量，9个shard（3primary，6 replica），扩容到9台机器，比6台机器时，拥有2倍的读吞吐量</li></ul><h4 id="2-3-容错机制"><a href="#2-3-容错机制" class="headerlink" title="2.3.容错机制"></a>2.3.容错机制</h4><ul><li><p>master node宕机，自动进行master选举， - Red</p><p>集群只有一个可用master,其他的设置node.master为true,说明是master候选节点,当啊master宕机是会从候选中选择一个作为新的master</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wlei0618/article/details/126690213">https://blog.csdn.net/wlei0618/article/details/126690213</a></p></li><li><p>Replica容错：将replica提升为新的primary shard，- yellow</p><p>当某个PrimaryShard (主分片)节点宕机,这个PrimaryShard的某个Replic Shard(备分片)会通过选举成为PrimaryShard。新的主分片选举成功后,那么保证了主分片的完整性，但是少了一个备分片,所以状态变成了黄色</p><p>重启宕机节点：会生成新的ReplicShard,如果宕机前有数据，会像恢复之前的数据，然后从PrimaryShard中拷贝新的数据，这样做的好处是：1.恢复性能好 ， 2.可以避免数据同步延迟造成的数据丢失问题(在宕机的一瞬间,有些数据还没同步到ReplicShard,可能会导致数据丢失)</p></li></ul><h3 id="4-集群搭建"><a href="#4-集群搭建" class="headerlink" title="4.集群搭建"></a>4.集群搭建</h3><h4 id="3-1-环境准备"><a href="#3-1-环境准备" class="headerlink" title="3.1.环境准备"></a>3.1.环境准备</h4><p>真实环境</p><table><thead><tr><th>NodeName</th><th>Web端口，客户端端口</th></tr></thead><tbody><tr><td>node-1</td><td>172.168.1.1:9200 172.168.1.1:9300</td></tr><tr><td>node-2</td><td>172.168.1.2:9200 172.168.1.2:9300</td></tr><tr><td>node-3</td><td>172.168.1.3:9200 172.168.1.3:9300</td></tr></tbody></table><p>模拟环境</p><table><thead><tr><th>NodeName</th><th>Web端口，客户端端口</th></tr></thead><tbody><tr><td>node-1</td><td>127.0.0.1:9201 127.0.0.1:9301</td></tr><tr><td>node-2</td><td>127.0.0.1:9202 127.0.0.1:9302</td></tr><tr><td>node-3</td><td>127.0.0.1:9203 127.0.0.1:9303</td></tr></tbody></table><p>注意:需要准备三个ES(拷贝),然后删除data目录 ， 如果电脑内存不够，可以把jvm.properties中的内存设置改小</p><h4 id="3-2-配置说明"><a href="#3-2-配置说明" class="headerlink" title="3.2.配置说明"></a>3.2.配置说明</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- cluster<span class="selector-class">.name</span></span><br><span class="line"></span><br><span class="line">  集群名，自定义集群名，默认为elasticsearch，建议修改，因为低版本多播模式下同一网段下相同集群名会自动加入同一集群，如生产环境这样易造成数据运维紊乱。</span><br><span class="line"></span><br><span class="line">- node<span class="selector-class">.name</span></span><br><span class="line"></span><br><span class="line">  节点名，同一集群下要求每个节点的节点名不一致，起到区分节点和辨认节点作用</span><br><span class="line"></span><br><span class="line">- node<span class="selector-class">.master</span></span><br><span class="line"></span><br><span class="line">  是否为主节点，选项为true或false，当为true时在集群启动时该节点为主节点，在宕机或任务挂掉之后会选举新的主节点，恢复后该节点依然为主节点</span><br><span class="line"></span><br><span class="line">- node<span class="selector-class">.data</span></span><br><span class="line"></span><br><span class="line">  是否处理数据，选项为true或false。负责数据的相关操作</span><br><span class="line"></span><br><span class="line">- path<span class="selector-class">.data</span></span><br><span class="line"></span><br><span class="line">  默认数据路径，可用逗号分隔多个路径</span><br><span class="line"></span><br><span class="line">- path<span class="selector-class">.logs</span></span><br><span class="line"></span><br><span class="line">  默认日志路径</span><br><span class="line"></span><br><span class="line">- bootstrap<span class="selector-class">.mlockall</span></span><br><span class="line"></span><br><span class="line">  内存锁，选项为true或false，用来确保用户在es-jvm中设置的ES_HEAP_SIZE参数内存可以使用一半以上而又不溢出</span><br><span class="line"></span><br><span class="line">- network<span class="selector-class">.host</span></span><br><span class="line"></span><br><span class="line">  对外暴露的host，<span class="number">0.0</span>.<span class="number">0.0</span>时暴露给外网</span><br><span class="line"></span><br><span class="line">- http<span class="selector-class">.port</span></span><br><span class="line"></span><br><span class="line">  对外访问的端口号，默认为<span class="number">9200</span>，所以外界访问该节点一般为http:<span class="comment">//ip:9200/</span></span><br><span class="line"></span><br><span class="line">- transport<span class="selector-class">.tcp</span><span class="selector-class">.port</span></span><br><span class="line"></span><br><span class="line">  集群间通信的端口号，默认为<span class="number">9300</span></span><br><span class="line"></span><br><span class="line">- discovery<span class="selector-class">.zen</span><span class="selector-class">.ping</span><span class="selector-class">.unicast</span><span class="selector-class">.hosts</span></span><br><span class="line"></span><br><span class="line">  集群的ip集合，可指定端口，默认为<span class="number">9300</span>，如 <span class="selector-attr">[<span class="string">&quot;192.168.1.101&quot;</span>,<span class="string">&quot;192.168.1.102&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">- discovery<span class="selector-class">.zen</span><span class="selector-class">.minimum_master_nodes</span></span><br><span class="line"></span><br><span class="line">  最少的主节点个数，为了防止脑裂，最好设置为(总结点数/<span class="number">2</span> + <span class="number">1</span>)个</span><br><span class="line"></span><br><span class="line">- discovery<span class="selector-class">.zen</span><span class="selector-class">.ping_timeout</span></span><br><span class="line"></span><br><span class="line">  主节点选举超时时间设置</span><br><span class="line"></span><br><span class="line">- gateway<span class="selector-class">.recover_after_nodes</span></span><br><span class="line"></span><br><span class="line">  值为n，网关控制在n个节点启动之后才恢复整个集群</span><br><span class="line"></span><br><span class="line">- node<span class="selector-class">.max_local_storage_nodes</span></span><br><span class="line"></span><br><span class="line">  值为n，一个系统中最多启用节点个数为n</span><br><span class="line"></span><br><span class="line">- action<span class="selector-class">.destructive_requires_name</span></span><br><span class="line"></span><br><span class="line">  选项为true或false，删除indices是否需要现实名字</span><br></pre></td></tr></table></figure><h4 id="3-3-修改ES配置"><a href="#3-3-修改ES配置" class="headerlink" title="3.3.修改ES配置"></a>3.3.修改ES配置</h4><ul><li>Node1-配置</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统一的集群名</span></span><br><span class="line">cluster.name: my-ealsticsearch</span><br><span class="line"><span class="comment"># 当前节点名</span></span><br><span class="line">node.name: node-1</span><br><span class="line"><span class="comment"># 对外暴露端口使外网访问</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="comment"># 对外暴露端口</span></span><br><span class="line">http.port: 9201</span><br><span class="line"><span class="comment">#集群间通讯端口号</span></span><br><span class="line">transport.tcp.port: 9301</span><br><span class="line"><span class="comment">#集群的ip集合，可指定端口，默认为9300</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: <span class="section">[&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;,&quot;127.0.0.1:9303&quot;]</span></span><br></pre></td></tr></table></figure><ul><li>Node2-配置</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统一的集群名</span></span><br><span class="line">cluster.name: my-ealsticsearch</span><br><span class="line"><span class="comment"># 当前节点名</span></span><br><span class="line">node.name: node-2</span><br><span class="line"><span class="comment"># 对外暴露端口使外网访问</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="comment"># 对外暴露端口</span></span><br><span class="line">http.port: 9202</span><br><span class="line"><span class="comment">#集群间通讯端口号</span></span><br><span class="line">transport.tcp.port: 9302</span><br><span class="line"><span class="comment">#集群的ip集合，可指定端口，默认为9300</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: <span class="section">[&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;,&quot;127.0.0.1:9303&quot;]</span></span><br></pre></td></tr></table></figure><ul><li>Node3-配置</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统一的集群名</span></span><br><span class="line">cluster.name: my-ealsticsearch</span><br><span class="line"><span class="comment"># 当前节点名</span></span><br><span class="line">node.name: node-3</span><br><span class="line"><span class="comment"># 对外暴露端口使外网访问</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="comment"># 对外暴露端口</span></span><br><span class="line">http.port: 9203</span><br><span class="line"><span class="comment">#集群间通讯端口号</span></span><br><span class="line">transport.tcp.port: 9303</span><br><span class="line"><span class="comment">#集群的ip集合，可指定端口，默认为9300</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: <span class="section">[&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;,&quot;127.0.0.1:9303&quot;]</span></span><br></pre></td></tr></table></figure><p>分别启动三个ES节点 ， 访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:9201/">http://127.0.0.1:9201/</a></p><h3 id="5连接集群"><a href="#5连接集群" class="headerlink" title="5连接集群"></a>5连接集群</h3><h4 id="4-1-修改kibana配置"><a href="#4-1-修改kibana配置" class="headerlink" title="4.1.修改kibana配置"></a>4.1.修改kibana配置</h4><p>5.5版本</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">elasticsearch.url:</span> <span class="string">&quot;http://localhost:9201&quot;</span></span><br></pre></td></tr></table></figure><p>连接其中一个节点自然能连接上整个集群 ， 然后启动Kibana</p><h4 id="4-2-集群查看命令"><a href="#4-2-集群查看命令" class="headerlink" title="4.2.集群查看命令"></a>4.2.集群查看命令</h4><p>创建索引</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="keyword">shopping</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;settings&quot;</span><span class="operator">:</span>&#123;</span><br><span class="line">		<span class="string">&quot;number_of_shards&quot;</span><span class="operator">:</span>5,</span><br><span class="line">		<span class="string">&quot;number_of_replicas&quot;</span><span class="operator">:</span>1</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>GET _cat&#x2F;nodes?v	：查看Node</p></li><li><p>GET _cat&#x2F;indices?v : 查看索引库</p></li></ul><h2 id="二-JavaApi操作ES"><a href="#二-JavaApi操作ES" class="headerlink" title="二.JavaApi操作ES"></a>二.JavaApi操作ES</h2><h3 id="1-集成ES-trasportclient"><a href="#1-集成ES-trasportclient" class="headerlink" title="1.集成ES-trasportclient"></a>1.集成ES-trasportclient</h3><h4 id="1-1-导入依赖"><a href="#1-1-导入依赖" class="headerlink" title="1.1.导入依赖"></a>1.1.导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="1-2-连接ES"><a href="#1-2-连接ES" class="headerlink" title="1.2.连接ES"></a>1.2.连接ES</h4><p>编写工具</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESClientUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TransportClient <span class="title function_">getClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Settings</span> <span class="variable">settings</span> <span class="operator">=</span> Settings.builder()</span><br><span class="line">        .put(<span class="string">&quot;cluster.name&quot;</span>,<span class="string">&quot;my-ealsticsearch&quot;</span>)</span><br><span class="line">        <span class="comment">//.put(&quot;client.transport.sniff&quot;, true).build();</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                    .addTransportAddress(</span><br><span class="line">                    		<span class="keyword">new</span> <span class="title class_">InetSocketTransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9303</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-文档CRUD"><a href="#1-3-文档CRUD" class="headerlink" title="1.3.文档CRUD"></a>1.3.文档CRUD</h4><h5 id="1-添加文档"><a href="#1-添加文档" class="headerlink" title="1.添加文档"></a>1.添加文档</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAdd</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//获取客户端对象</span></span><br><span class="line">  <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> ESClientUtil.getClient();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建索引</span></span><br><span class="line">  <span class="type">IndexRequestBuilder</span> <span class="variable">indexRequestBuilder</span> <span class="operator">=</span> client.prepareIndex(<span class="string">&quot;shopping&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  Map&lt;String,Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  data.put(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>);</span><br><span class="line">  data.put(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">  data.put(<span class="string">&quot;age&quot;</span>,<span class="number">11</span>);</span><br><span class="line">  <span class="comment">//获取结果</span></span><br><span class="line">  <span class="type">IndexResponse</span> <span class="variable">indexResponse</span> <span class="operator">=</span> indexRequestBuilder.setSource(data).get();</span><br><span class="line"></span><br><span class="line">  System.out.println(indexResponse);</span><br><span class="line">  client.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-获取文档"><a href="#2-获取文档" class="headerlink" title="2.获取文档"></a>2.获取文档</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetResponse response = client.prepareGet(<span class="string">&quot;crm&quot;</span>, <span class="string">&quot;vip&quot;</span>, <span class="string">&quot;1&quot;</span>).<span class="built_in">get</span>();</span><br></pre></td></tr></table></figure><h5 id="3-更新文档"><a href="#3-更新文档" class="headerlink" title="3.更新文档"></a>3.更新文档</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//获取客户端对象</span></span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> ESClientUtil.getClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改索引</span></span><br><span class="line">        <span class="type">UpdateRequestBuilder</span> <span class="variable">updateRequestBuilder</span> <span class="operator">=</span> client.prepareUpdate(<span class="string">&quot;shopping&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        Map&lt;String,Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">&quot;id&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        data.put(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">        data.put(<span class="string">&quot;age&quot;</span>,<span class="number">11</span>);</span><br><span class="line">        <span class="comment">//获取结果设置修改内容</span></span><br><span class="line">        <span class="type">UpdateResponse</span> <span class="variable">updateResponse</span> <span class="operator">=</span> updateRequestBuilder.setDoc(data).get();</span><br><span class="line"></span><br><span class="line">        System.out.println(updateResponse);</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>4.删除文档</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="comment">//获取客户端对象</span></span><br><span class="line">       <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> ESClientUtil.getClient();</span><br><span class="line"></span><br><span class="line">       <span class="type">DeleteRequestBuilder</span> <span class="variable">deleteRequestBuilder</span> <span class="operator">=</span> client.prepareDelete(<span class="string">&quot;shopping&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">       <span class="type">DeleteResponse</span> <span class="variable">deleteResponse</span> <span class="operator">=</span> deleteRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">       System.out.println(deleteResponse);</span><br><span class="line">       client.close();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h5 id="4-批量操作"><a href="#4-批量操作" class="headerlink" title="4.批量操作"></a>4.批量操作</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBuilkAdd</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="comment">//获取客户端对象</span></span><br><span class="line">       <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> ESClientUtil.getClient();</span><br><span class="line"></span><br><span class="line">       <span class="type">BulkRequestBuilder</span> <span class="variable">bulkRequestBuilder</span> <span class="operator">=</span> client.prepareBulk();</span><br><span class="line"></span><br><span class="line">       Map&lt;String,Object&gt; data1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       data1.put(<span class="string">&quot;id&quot;</span>,<span class="number">11</span>);</span><br><span class="line">       data1.put(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">       data1.put(<span class="string">&quot;age&quot;</span>,<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">       bulkRequestBuilder.add(client.prepareIndex(<span class="string">&quot;shopping&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;11&quot;</span>).setSource(data1));</span><br><span class="line"></span><br><span class="line">       Map&lt;String,Object&gt; data2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       data2.put(<span class="string">&quot;id&quot;</span>,<span class="number">22</span>);</span><br><span class="line">       data2.put(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">       data2.put(<span class="string">&quot;age&quot;</span>,<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line">       bulkRequestBuilder.add(client.prepareIndex(<span class="string">&quot;shopping&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;11&quot;</span>).setSource(data2));</span><br><span class="line"></span><br><span class="line">       <span class="type">BulkResponse</span> <span class="variable">bulkItemResponses</span> <span class="operator">=</span> bulkRequestBuilder.get();</span><br><span class="line">       Iterator&lt;BulkItemResponse&gt; iterator = bulkItemResponses.iterator();</span><br><span class="line">       <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">           <span class="type">BulkItemResponse</span> <span class="variable">next</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">           System.out.println(next.getResponse());</span><br><span class="line">       &#125;</span><br><span class="line">       client.close();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h5 id="5-查询"><a href="#5-查询" class="headerlink" title="5.查询"></a>5.查询</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearch</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="comment">//获取客户端对象</span></span><br><span class="line">       <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> ESClientUtil.getClient();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="type">SearchRequestBuilder</span> <span class="variable">searchRequestBuilder</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;shopping&quot;</span>);</span><br><span class="line">       searchRequestBuilder.setTypes(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">       searchRequestBuilder.setFrom(<span class="number">0</span>);</span><br><span class="line">       searchRequestBuilder.setSize(<span class="number">10</span>);</span><br><span class="line">       searchRequestBuilder.addSort(<span class="string">&quot;age&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//查询条件</span></span><br><span class="line">       <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">       List&lt;QueryBuilder&gt; must = boolQueryBuilder.must();</span><br><span class="line">       must.add(QueryBuilders.matchQuery(<span class="string">&quot;username&quot;</span> , <span class="string">&quot;zs&quot;</span>));</span><br><span class="line"></span><br><span class="line">       List&lt;QueryBuilder&gt; filter = boolQueryBuilder.filter();</span><br><span class="line">       filter.add(QueryBuilders.rangeQuery(<span class="string">&quot;age&quot;</span>).lte(<span class="number">20</span>).gte(<span class="number">10</span>));</span><br><span class="line">       filter.add(QueryBuilders.termQuery(<span class="string">&quot;id&quot;</span>,<span class="number">11</span>));</span><br><span class="line"></span><br><span class="line">       searchRequestBuilder.setQuery(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">       <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> searchRequestBuilder.get();</span><br><span class="line"></span><br><span class="line">       <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line"></span><br><span class="line">       System.out.println(<span class="string">&quot;条数：&quot;</span>+hits.getTotalHits());</span><br><span class="line">       <span class="keyword">for</span> (SearchHit hit : hits.getHits()) &#123;</span><br><span class="line">           System.out.println(hit.getSource());</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       client.close();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="2-基于SpringBoot操作ES"><a href="#2-基于SpringBoot操作ES" class="headerlink" title="2.基于SpringBoot操作ES"></a>2.基于SpringBoot操作ES</h3><h4 id="2-1-导入依赖"><a href="#2-1-导入依赖" class="headerlink" title="2.1.导入依赖"></a>2.1.导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-配置ES"><a href="#2-2-配置ES" class="headerlink" title="2.2.配置ES"></a>2.2.配置ES</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-search</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">elasticsearch:</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">my-ealsticsearch</span> <span class="comment">#elasticsearch</span></span><br><span class="line">      <span class="attr">cluster-nodes:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9301,127.0.0.1:9302,127.0.0.1:9303</span> <span class="comment">#9200是图形界面端,9300代码端</span></span><br></pre></td></tr></table></figure><h4 id="2-3-创建Document对象"><a href="#2-3-创建Document对象" class="headerlink" title="2.3.创建Document对象"></a>2.3.创建Document对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;hrm&quot;,type = &quot;course&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseDoc</span> &#123;</span><br><span class="line">    <span class="comment">//PUT  /hrmtest/coursetest/1</span></span><br><span class="line">    <span class="meta">@Id</span> <span class="comment">//文档对象的ID就是该字段的值</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//课程名称</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;,searchAnalyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//价格</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Float)</span></span><br><span class="line">    <span class="keyword">private</span> Float price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-创建Repository"><a href="#2-4-创建Repository" class="headerlink" title="2.4.创建Repository"></a>2.4.创建Repository</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseElasticsearchRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;CourseDoc,Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-测试代码"><a href="#2-5-测试代码" class="headerlink" title="2.5.测试代码"></a>2.5.测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = SearchApp.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//功能有限</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseElasticsearchRepository repository;</span><br><span class="line"></span><br><span class="line">    /</span><br><span class="line">     * <span class="number">1.</span>创库</span><br><span class="line">     * <span class="number">2.</span>映射</span><br><span class="line">     * <span class="number">3.</span>存储</span><br><span class="line">     */</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateIndex</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建索引库：解析 CourseDoc上的 @Document 创建索引库</span></span><br><span class="line">        elasticsearchTemplate.createIndex(CourseDoc.class);</span><br><span class="line">        <span class="comment">//创建映射</span></span><br><span class="line">        elasticsearchTemplate.putMapping(CourseDoc.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span> ;i &lt; <span class="number">100</span> ; i++)&#123;</span><br><span class="line">            System.out.println(repository.getClass());</span><br><span class="line">            <span class="type">CourseDoc</span> <span class="variable">courseDoc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseDoc</span>();</span><br><span class="line">            courseDoc.setName(<span class="string">&quot;XXXX&quot;</span>);</span><br><span class="line">            courseDoc.setId(i);</span><br><span class="line">            repository.save(courseDoc);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;保存成功...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三.总结"></a>三.总结</h2><p>es优化</p><p>​ 1 拓扑设计(选择合理的节点类型): 3(1主+2候选)+6(数据节点)+3(客户端节点)</p><p>​ 2 对数据节点进行分片优化 3primary shard 6个replicashard</p><p>​ 3 配置优化: 对数据节点内存设置 刷新相关的配置 translog相关的配置</p><p>​ 4 代码优化</p><p>​ 自定义映射</p><p>​ 查询优化</p><h3 id="1-重点内容"><a href="#1-重点内容" class="headerlink" title="1.重点内容"></a>1.重点内容</h3><ul><li>ES节点分类</li><li>ES分片机制</li><li>添加数据获取数据</li><li>ES搭建集群</li></ul><h3 id="2-面试必备"><a href="#2-面试必备" class="headerlink" title="2.面试必备"></a>2.面试必备</h3><ul><li><p>为什么用ES做全文检索比数据库使用 like 快 %jxxkk%</p><pre><code>比数据库模糊查询效率高   基于倒排实现(关键字匹配,文档id--&gt;获取文档)  
正排:select name from t_user where name like ...
</code></pre><p>支持高亮</p><p>相关度排序</p></li><li><p>ES底层用到了什么数据结构</p><p>正排索引:通过文档或者数据库中行,找字段 select name from t_user where id &#x3D;1</p><p>倒排索引: 先找字段(keyword),确定文档id,再通过文档id找到文档</p><p><img src="/breeze/7913ff38/1690531682507.png" alt="1690531682507"></p></li><li><p>说说你理解的ES分片(Shard)机制</p><p>​ 创建索引库会指定有多少primary shard,为了冗余还为每个primary shard创建多个replica shard</p><p>.我们保存的文档只会在特定一个primary shard中,以及它的raplca shard! 解决了单点故障,支持高并发(多个primary shard同时并发,读写分离),海量数据存储(每个节点放到数据都是不一样)!</p></li><li><p>什么情况下ES集群不可用</p><p>有的primary shard分配不了,丢失数据.</p></li><li><p>ES内部是如何进行并发控制的 : 多个线程操作同一个文档</p><p>​ 答version 乐观锁 {id,name,num:1,version} -1 -1</p></li><li><p>Mysql中的数据库，表，行，列 在ES中是怎么对应的 ,ES层级关系 7.0</p></li><li><p>如果我要把一个User表中的数据存储到ES中，我应该怎么做</p><p>(1) 创建一个索引库，可以用kibana或者用Java代码</p><p>(2) 然后做文档映射-，可以用kibana或者用Java代码</p><p>(3) 然后通过ES的Java的API去添加数据到索引库</p><p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p></li><li><p><strong>描述一下ES添加文档的过程</strong></p><p>(1) 客户端请求一个协调节点coordinating node(负载均衡节点) ,时时刻刻在做shard的发现</p><p>(2) 协调节点根据算法选择一个primary shard: 算法 hash(document_id) % (num_of_primary_shards) 0 1 2 3 4</p><p>(3) 对应的primary shard 所在节点保存完数据后，将数据同步到replica shard。</p><p>(4) 协调节点coordinating node 发现 primary shard和所有 replica shard都搞定之后返回结果给客户端</p></li></ul><p><img src="/breeze/7913ff38/1680159198266.png" alt="1680159198266"></p><ul><li><p><strong>数据节点存储数据详细流程：</strong></p><p>(1) 当分片所在的节点接收到来自协调节点的请求后，会将请求写入到Memory Buffer，然后定时（默认是每隔1秒）写入到Filesystem Cache，这个从Momery Buffer到Filesystem Cache的过程就叫做refresh</p><p>(2) 当然在某些情况下，存在Momery Buffer和Filesystem Cache的数据可能会丢失，ES是通过translog的机制来保证数据的可靠性的。其实现机制是接收到请求后，同时也会写入到translog中，当Filesystem cache中的数据写入到磁盘中时，才会清除掉，这个过程叫做flush；</p><p>(3)在flush过程中，内存中的缓冲将被清除，内容被写入一个新段，段的fsync将创建一个新的提交点，并将内容刷新到磁盘，旧的translog将被删除并开始一个新的translog。<br>flush触发的时机是定时触发（默认30分钟）或者translog变得太大（默认为512M）时；</p></li></ul><p><img src="/breeze/7913ff38/1693885682669.png" alt="1693885682669"></p><ul><li><p><strong>详细描述一下Elasticsearch获取文档的过程</strong></p><p>(1) 客户端请求一个协调节点coordinating node</p><p>(2) coordinate node 根据算法hash(document_id) % (num_of_primary_shards)，找到该primary_shard所对应的replica shard.，此时会使用 round-robin随机轮询算法，在 primary shard 以及其所有 replica 中随机选择一个，让读请求负载均衡</p><p>(3) 接收到请求的 node 返回 document 给调节点 coordinate node。</p><p>(4) coordinate node 返回 document 给客户端。</p></li><li><p>详细描述一下Elasticsearch搜索过程 dsl doc1 doc2</p><p>(1) 在初始查询阶段时，查询会广播到索引中每一个分片拷贝（主分片或者副本分片）。</p><p>(2) 每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列。PS：在搜索的时候是会查询Filesystem Cache的，但是有部分数据还在Memory Buffer，所以搜索是近实时的。–es是一个近实时搜索引擎</p><p>(3) 每个分片返回各自优先队列中所有文档的 ID 和排序值给协调节点，协调节点它合并这些值到自己的优先队列中来产生一个全局排序后的结果列表。</p><p>(4) 接下来就是 取回阶段，协调节点辨别出哪些文档需要被取回并向相关的分片提交多个 GET 请求。每个分片加载并 丰富 文档，如果有需要的话，接着返回文档给协调节点。一旦所有的文档都被取回了，协调节点返回结果给客户端。</p></li></ul><p>总结：查询请求 -&gt; 每个分片执行查询，结果(文档ID，排序值)转到优先队列 -&gt; 每个分片返回队列数据给协调节点 -&gt; 协调节点处理全局排序 -&gt; 根据文档ID去每个分片查询完整数据 -&gt; 返回客户端。</p><ul><li><p><strong>详细描述一下Elasticsearch更新和删除文档的过程</strong></p><p>删除和更新也都是写操作，但是Elasticsearch中的文档是不可变的，因此不能被删除或者改动以展示其变更；　磁盘上的每个段都有一个相应的.del文件。当删除请求发送后，文档并没有真的被删除，而是在.del文件中被标记为删除。该文档依然能匹配查询，但是会在结果中被过滤掉。当段合并时，在.del文件中被标记为删除的文档将不会被写入新段。</p><p>在新的文档被创建时，Elasticsearch会为该文档指定一个版本号，当执行更新时，旧版本的文档在.del文件中被标记为删除，新版本的文档被索引到一个新段。旧版本的文档依然能匹配查询，但是会在结果中被过滤掉。</p></li><li><p>ES有几种节点类型？他们的作用分别是什么</p><ul><li>主节点</li><li>数据节点</li><li>协调节点&#x2F;客户端节点</li></ul></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/7913ff38.html">https://mliutm.github.io/breeze/7913ff38.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ES%E9%9B%86%E7%BE%A4/">ES集群</a></div><div class="post_share"><div class="social-share" data-image="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">认证授权-SpringSecurity</div></div></a></div><div class="next-post pull-right"><a href="/breeze/37cf2cfd.html" title="Redis集群"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis集群</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ElasticSearch%E9%9B%86%E7%BE%A4"><span class="toc-text">ElasticSearch集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-text">内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-ElasticSearch%E9%9B%86%E7%BE%A4%E6%A6%82%E5%BF%B5"><span class="toc-text">一.ElasticSearch集群概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-elasticsearch-head%E5%AE%89%E8%A3%85"><span class="toc-text">1 elasticsearch head安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9B%86%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">2.集群相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%9B%86%E7%BE%A4"><span class="toc-text">1.1.为什么要集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-ES%E5%87%A0%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">1.2.ES几大核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Cluster%EF%BC%9A%E9%9B%86%E7%BE%A4"><span class="toc-text">1.Cluster：集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Node%EF%BC%9A%E8%8A%82%E7%82%B9"><span class="toc-text">2.Node：节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-shard%EF%BC%88%E5%88%86%E7%89%87%EF%BC%89"><span class="toc-text">3.shard（分片）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-replica%EF%BC%88%E5%A4%8D%E5%88%B6%E5%93%81%EF%BC%89"><span class="toc-text">4.replica（复制品）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E9%9B%86%E7%BE%A4%E7%9A%84%E5%81%A5%E5%BA%B7%E7%8A%B6%E5%86%B5"><span class="toc-text">5.集群的健康状况</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-ES%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.3.ES节点类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ES%E7%9A%84%E9%9B%86%E7%BE%A4%E7%90%86%E8%A7%A3"><span class="toc-text">3.ES的集群理解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-shard-replica%E6%9C%BA%E5%88%B6"><span class="toc-text">2.1.shard&amp;replica机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%9B%BE%E8%A7%A3Shard%E5%88%86%E9%85%8D"><span class="toc-text">2.2.图解Shard分配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8D%95node%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%9B%E5%BB%BAindex"><span class="toc-text">1.单node环境下创建index</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%B8%A4%E4%B8%AAnode%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%9B%E5%BB%BAindex"><span class="toc-text">2.两个node环境下创建index</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%89%A9%E5%AE%B9%E6%9E%81%E9%99%90%EF%BC%8C%E6%8F%90%E5%8D%87%E5%AE%B9%E9%94%99"><span class="toc-text">3.扩容极限，提升容错</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="toc-text">2.3.容错机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-text">4.集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">3.1.环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-text">3.2.配置说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E4%BF%AE%E6%94%B9ES%E9%85%8D%E7%BD%AE"><span class="toc-text">3.3.修改ES配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E8%BF%9E%E6%8E%A5%E9%9B%86%E7%BE%A4"><span class="toc-text">5连接集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E4%BF%AE%E6%94%B9kibana%E9%85%8D%E7%BD%AE"><span class="toc-text">4.1.修改kibana配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E9%9B%86%E7%BE%A4%E6%9F%A5%E7%9C%8B%E5%91%BD%E4%BB%A4"><span class="toc-text">4.2.集群查看命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-JavaApi%E6%93%8D%E4%BD%9CES"><span class="toc-text">二.JavaApi操作ES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9B%86%E6%88%90ES-trasportclient"><span class="toc-text">1.集成ES-trasportclient</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%BF%9E%E6%8E%A5ES"><span class="toc-text">1.2.连接ES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%96%87%E6%A1%A3CRUD"><span class="toc-text">1.3.文档CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-text">1.添加文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E6%96%87%E6%A1%A3"><span class="toc-text">2.获取文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-text">3.更新文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">4.批量操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%9F%A5%E8%AF%A2"><span class="toc-text">5.查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8ESpringBoot%E6%93%8D%E4%BD%9CES"><span class="toc-text">2.基于SpringBoot操作ES</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">2.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E9%85%8D%E7%BD%AEES"><span class="toc-text">2.2.配置ES</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%88%9B%E5%BB%BADocument%E5%AF%B9%E8%B1%A1"><span class="toc-text">2.3.创建Document对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E5%88%9B%E5%BB%BARepository"><span class="toc-text">2.4.创建Repository</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-text">2.5.测试代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%80%BB%E7%BB%93"><span class="toc-text">三.总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%87%8D%E7%82%B9%E5%86%85%E5%AE%B9"><span class="toc-text">1.重点内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9D%A2%E8%AF%95%E5%BF%85%E5%A4%87"><span class="toc-text">2.面试必备</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/premium_photo-1695185954894-e9382c6f4da8.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>