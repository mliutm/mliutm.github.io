<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>蓉礼购-购物车（六） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="购物车一 购物车需求​        想买不一定立即买，等着舔狗来买单！加入购物车，其实他妈的和现实生活中一样，拿一些货品放到购物车，最后拿去结算。  二  购物车实现方式 1 方案1：数据库方案​      放到数据库表中存放。  ​		优点：安全、简单 ​         缺点：必须要登陆！ userId？？？      数据库压力过大。 2 方案2： cookie&#x2F;localstr"><meta property="og:type" content="article"><meta property="og:title" content="蓉礼购-购物车（六）"><meta property="og:url" content="https://mliutm.github.io/breeze/2602ce24.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="购物车一 购物车需求​        想买不一定立即买，等着舔狗来买单！加入购物车，其实他妈的和现实生活中一样，拿一些货品放到购物车，最后拿去结算。  二  购物车实现方式 1 方案1：数据库方案​      放到数据库表中存放。  ​		优点：安全、简单 ​         缺点：必须要登陆！ userId？？？      数据库压力过大。 2 方案2： cookie&#x2F;localstr"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><meta property="article:published_time" content="2024-01-13T11:52:52.000Z"><meta property="article:modified_time" content="2024-01-17T12:30:06.348Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta property="article:tag" content="任务调度"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/2602ce24.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"蓉礼购-购物车（六）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-17 20:30:06"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">78</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">蓉礼购-购物车（六）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-13T11:52:52.000Z" title="发表于 2024-01-13 19:52:52">2024-01-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-17T12:30:06.348Z" title="更新于 2024-01-17 20:30:06">2024-01-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E8%93%89%E7%A4%BC%E8%B4%AD/">蓉礼购</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>51分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="蓉礼购-购物车（六）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="购物车"><a href="#购物车" class="headerlink" title="购物车"></a>购物车</h1><h2 id="一-购物车需求"><a href="#一-购物车需求" class="headerlink" title="一 购物车需求"></a>一 购物车需求</h2><p>​ 想买不一定立即买，等着舔狗来买单！加入购物车，其实他妈的和现实生活中一样，拿一些货品放到购物车，最后拿去结算。</p><p><img src="/breeze/2602ce24/1668674865606.png" alt="1668674865606"></p><h2 id="二-购物车实现方式"><a href="#二-购物车实现方式" class="headerlink" title="二  购物车实现方式"></a>二 购物车实现方式</h2><p><img src="/breeze/2602ce24/image-20240116164325915.png" alt="image-20240116164325915"></p><h3 id="1-方案1：数据库方案"><a href="#1-方案1：数据库方案" class="headerlink" title="1 方案1：数据库方案"></a>1 方案1：数据库方案</h3><p>​ 放到数据库表中存放。</p><p>​ 优点：安全、简单</p><p>​ 缺点：必须要登陆！ userId？？？ 数据库压力过大。</p><h3 id="2-方案2：-cookie-localstroge-数据库-一般不用"><a href="#2-方案2：-cookie-localstroge-数据库-一般不用" class="headerlink" title="2 方案2： cookie&#x2F;localstroge+数据库(一般不用)"></a>2 方案2： cookie&#x2F;localstroge+数据库(一般不用)</h3><p>​ 没有登陆的时候放到cookie，登陆后同步到数据库。</p><p>​ 仅仅提高了用户体验，没有实质改变。 移动互联时代,app上面没有cookie&#x2F;localstroge,但是可以存放到本地!</p><h3 id="3-方案3-redis"><a href="#3-方案3-redis" class="headerlink" title="3 方案3:redis"></a>3 方案3:redis</h3><p>​ 数据量少</p><h3 id="4-方案4-redis-数据库"><a href="#4-方案4-redis-数据库" class="headerlink" title="4 方案4:  redis+数据库"></a>4 方案4: redis+数据库</h3><p>​ redis存放热点购物车,长时间不访问放入数据库</p><p>​ 支持并发高</p><p>​ 降低数据库压力</p><p>选型: 数据量小,并发不高选1,3 高并发方案4</p><h2 id="三-方案1实现"><a href="#三-方案1实现" class="headerlink" title="三    方案1实现"></a>三 方案1实现</h2><h3 id="1-购物车设计"><a href="#1-购物车设计" class="headerlink" title="1 购物车设计"></a>1 购物车设计</h3><h4 id="1-界面"><a href="#1-界面" class="headerlink" title="1 界面"></a>1 界面</h4><p><img src="/breeze/2602ce24/1688539364758.png" alt="1688539364758"></p><p><img src="/breeze/2602ce24/1668675554231.png" alt="1668675554231"></p><p>​ Map&lt;店铺信息(id,name),List<shopcar>&gt;</shopcar></p><p><strong>新建gift-shoppingcar服务</strong></p><ul><li><p>依赖导入模仿之前的</p></li><li><p>nacos相关配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gift-shoppingcar</span> <span class="comment">#服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># 配置中心</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">2dad5a3c-0258-4a8d-862c-34e12f04735a</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span> <span class="comment"># 分组</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/gift_car?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=true</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">2000ms</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.mliutm.gift.domain,com.mliutm.gift.query</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">cn.mliutm.gift:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure></li><li><p>本地yaml配置（bootstrap.yaml)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># 配置中心</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">2dad5a3c-0258-4a8d-862c-34e12f04735a</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span> <span class="comment"># 分组</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">application-shoppingcar</span> <span class="comment"># 配置文件前缀</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 配置文件格式</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mliutm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2024年01月09日 19:49:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@describe</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.mliutm.gift.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCarApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ShoppingCarApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p>2 表设计</p><p><img src="/breeze/2602ce24/1671783209552.png" alt="1671783209552"></p><h4 id="3-流程设计"><a href="#3-流程设计" class="headerlink" title="3 流程设计"></a>3 流程设计</h4><p>列表展示</p><p>​ 加入购物车 ajax</p><p>​ 删除 ajax</p><p>​ 修改数目 ajax</p><p>​ 勾选 ajax</p><h3 id="2-购物车的实现"><a href="#2-购物车的实现" class="headerlink" title="2 购物车的实现"></a>2 购物车的实现</h3><h4 id="1-添加"><a href="#1-添加" class="headerlink" title="1 添加"></a>1 添加</h4><p>参数:skuid,num</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">controller</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addCarDto  传递的实体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Ajaxresult转换结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">add</span><span class="params">(<span class="meta">@Valid</span>  <span class="meta">@RequestBody</span> AddCarDto addCarDto)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            addCarDto.setUserId(<span class="number">17L</span>); <span class="comment">//以后获取当前登陆用户就ok,现在先写死</span></span><br><span class="line">            addCarDto.setUsername(<span class="string">&quot;13330964748&quot;</span>);</span><br><span class="line">            shopCarService.add(addCarDto);</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setMessage(<span class="string">&quot;保存对象失败！&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">service</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">add</span><span class="params">(AddCarDto addCarDto)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方案1 如果前台传入完整sku信息,就不用到礼物中心查询.   网页端,做了页面静态,需要提前一json对象的方式缓存在当前页面中,app端要缓存到本地.---前端做的事情过多,不是特别好</span></span><br><span class="line">        <span class="comment">// 方案2 只传入skuid,num,需要到礼物中心远程查询(采纳)</span></span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> giftClient.get(addCarDto.getSkuId());</span><br><span class="line">        <span class="keyword">if</span> (!ajaxResult.isSuccess())</span><br><span class="line">            <span class="keyword">return</span> ajaxResult;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> (String) ajaxResult.getResultObj();</span><br><span class="line">        <span class="type">GoodsSku</span> <span class="variable">goodsSku</span> <span class="operator">=</span> JSONObject.parseObject(jsonStr,GoodsSku.class);</span><br><span class="line">        <span class="type">ShopCar</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShopCar</span>();</span><br><span class="line">        car.setSpuId(goodsSku.getSpuId());</span><br><span class="line">        car.setSpuName(goodsSku.getSpuName());</span><br><span class="line">        car.setSkuId(goodsSku.getId());</span><br><span class="line">        car.setSkuInfo(goodsSku.getSkuName());</span><br><span class="line">        car.setAddPrice(goodsSku.getPrice());</span><br><span class="line">        car.setPrice(goodsSku.getPrice());</span><br><span class="line">        car.setUserId(addCarDto.getUserId());</span><br><span class="line">        car.setUsername(addCarDto.getUsername());</span><br><span class="line">        car.setTenantId(goodsSku.getTenantId());</span><br><span class="line">        car.setTenantName(goodsSku.getTenantId()+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        car.setSelect(<span class="literal">false</span>);</span><br><span class="line">        car.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        car.setNum(addCarDto.getNum());</span><br><span class="line"></span><br><span class="line">        shopCarMapper.insert(car);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="2-删除"><a href="#2-删除" class="headerlink" title="2 删除"></a>2 删除</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 删除对象信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(value=&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            shopCarService.deleteById(id);</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setMessage(<span class="string">&quot;删除对象失败！&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="3-修改"><a href="#3-修改" class="headerlink" title="3 修改"></a>3 修改</h4><h5 id="3-1-修改数目"><a href="#3-1-修改数目" class="headerlink" title="3.1 修改数目"></a>3.1 修改数目</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改数目  carId  num</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/num&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> AjaxResult <span class="title function_">changeNum</span><span class="params">(<span class="meta">@Valid</span>  <span class="meta">@RequestBody</span> ChangeNumDto changeNumDto)</span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           shopCarService.changeNum(changeNumDto);</span><br><span class="line">           <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> AjaxResult.me().setMessage(<span class="string">&quot;保存对象失败！&quot;</span>+e.getMessage());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   service</span><br><span class="line">      <span class="meta">@Transactional</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeNum</span><span class="params">(ChangeNumDto changeNumDto)</span> &#123;</span><br><span class="line">       shopCarMapper.changeNum(changeNumDto);</span><br><span class="line">   </span><br><span class="line">   mapper</span><br><span class="line">   <span class="meta">@Update(&quot;update t_shop_car set num = #&#123;num&#125; where id=#&#123;carId&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">changeNum</span><span class="params">(ChangeNumDto changeNumDto)</span>;</span><br></pre></td></tr></table></figure><h5 id="3-3-选中"><a href="#3-3-选中" class="headerlink" title="3.3 选中"></a>3.3 选中</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">controller</span><br><span class="line"><span class="comment">//勾选</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/select&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">select</span><span class="params">(<span class="meta">@Valid</span>  <span class="meta">@RequestBody</span> CarSelectDto carSelectDto)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            shopCarService.select(carSelectDto);</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setMessage(<span class="string">&quot;保存对象失败！&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">serivce</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(CarSelectDto carSelectDto)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">select</span> <span class="operator">=</span> carSelectDto.getSelect();</span><br><span class="line">        <span class="keyword">if</span> (select!=<span class="number">1</span> &amp;&amp; select!=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;非法输入!&quot;</span>);</span><br><span class="line">        shopCarMapper.select(carSelectDto);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">mapper</span><br><span class="line"> <span class="meta">@Update(&quot;update t_shop_car set is_select = #&#123;select&#125; where id=#&#123;carId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(CarSelectDto carSelectDto)</span>;</span><br></pre></td></tr></table></figure><h4 id="4-列表"><a href="#4-列表" class="headerlink" title="4 列表"></a>4 列表</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">//要作为mapkey,必须重新hashcode,equals</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TenantIdName</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long tenantId;</span><br><span class="line">    <span class="keyword">private</span> String tenantName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">TenantIdName</span> <span class="variable">that</span> <span class="operator">=</span> (TenantIdName) o;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(tenantId, that.tenantId) &amp;&amp;</span><br><span class="line">                Objects.equals(tenantName, that.tenantName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(tenantId, tenantName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">controller</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查看所有的员工信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/* 店铺1(id,name)  List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">        店铺2(id,name)  List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">        店铺3(id,name)  List&lt;ShopCar&gt;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">17L</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           Map&lt;TenantIdName,List&lt;ShopCar&gt;&gt; map = shopCarService.listUserCar(userId);</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setResultObj(JSONObject.toJSONString(map));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;获取所有失败！&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">service</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; <span class="title function_">listUserCar</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户所有的购物车明细</span></span><br><span class="line">        List&lt;ShopCar&gt; shopCars = shopCarMapper</span><br><span class="line">                .selectList(<span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;ShopCar&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                        .orderBy(<span class="string">&quot;tenant_id&quot;</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历分组</span></span><br><span class="line">        shopCars.forEach(shopCar -&gt; &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">tenantId</span> <span class="operator">=</span> shopCar.getTenantId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantName</span> <span class="operator">=</span> shopCar.getTenantName();</span><br><span class="line">            <span class="type">TenantIdName</span> <span class="variable">tenantIdName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TenantIdName</span>(tenantId,tenantName);</span><br><span class="line">            List&lt;ShopCar&gt; list = result.get(tenantIdName);</span><br><span class="line">            <span class="keyword">if</span> (list==<span class="literal">null</span>)&#123;  <span class="comment">//第一次今天没有list</span></span><br><span class="line">                list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                list.add(shopCar);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//后续有list,直接作为元素加入进去就ok</span></span><br><span class="line">                list.add(shopCar);</span><br><span class="line">            &#125;</span><br><span class="line">            result.put(tenantIdName,list);  <span class="comment">//不能重复</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="四-方案4实现"><a href="#四-方案4实现" class="headerlink" title="四    方案4实现"></a>四 方案4实现</h2><h3 id="1-方案设计"><a href="#1-方案设计" class="headerlink" title="1  方案设计"></a>1 方案设计</h3><p><img src="/breeze/2602ce24/1683872511312-1705479345776-1.png" alt="1683872511312"></p><h3 id="2-实现"><a href="#2-实现" class="headerlink" title="2  实现"></a>2 实现</h3><h4 id="2-1-搭建微服务"><a href="#2-1-搭建微服务" class="headerlink" title="2.1 搭建微服务"></a>2.1 搭建微服务</h4><p>​ 略过</p><h4 id="2-2-redis操作"><a href="#2-2-redis操作" class="headerlink" title="2.2 redis操作"></a>2.2 redis操作</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopCarMapper, ShopCar&gt; <span class="keyword">implements</span> <span class="title class_">IShopCarService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GiftClient giftClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShopCarMapper shopCarMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_CAR_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;user_car&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shopcar.expire.time&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> shopCarExpireTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">add</span><span class="params">(AddCarDto addCarDto)</span> &#123;</span><br><span class="line">        <span class="comment">// 方案1 如果前台传入完整sku信息,就不用到礼物中心查询.   网页端,做了页面静态,需要提前一json对象的方式缓存在当前页面中,app端要缓存到本地.---前端做的事情过多,不是特别好</span></span><br><span class="line">        <span class="comment">// 方案2 只传入skuid,num,需要到礼物中心远程查询(采纳)</span></span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> giftClient.get(addCarDto.getSkuId());</span><br><span class="line">        <span class="keyword">if</span> (!ajaxResult.getSuccess())</span><br><span class="line">            <span class="keyword">return</span> ajaxResult;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> (String) ajaxResult.getResultObj();</span><br><span class="line">        <span class="type">Sku</span> <span class="variable">sku</span> <span class="operator">=</span> JSONObject.parseObject(jsonStr,Sku.class);</span><br><span class="line">        <span class="type">ShopCar</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShopCar</span>();</span><br><span class="line">        car.setSpuId(sku.getSpuId());</span><br><span class="line">        car.setSpuName(sku.getSpuName());</span><br><span class="line">        car.setSkuId(sku.getId());</span><br><span class="line">        car.setSkuInfo(sku.getSkuName());</span><br><span class="line">        car.setAddPrice(sku.getPrice());</span><br><span class="line">        car.setPrice(sku.getPrice());</span><br><span class="line">        car.setUserId(addCarDto.getUserId());</span><br><span class="line">        car.setUsername(addCarDto.getUsername());</span><br><span class="line">        car.setTenantId(sku.getTenantId());</span><br><span class="line">        car.setTenantName(sku.getTenantId()+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        car.setSelect(<span class="number">0</span>);</span><br><span class="line">        car.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        car.setNum(addCarDto.getNum());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//直接放入redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + car.getUserId();</span><br><span class="line">        <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);<span class="comment">//K(user_car_用户id) k(skuId) v(skuJsondata)</span></span><br><span class="line">        putDataInRedis(operations, sku.getId(), car);</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据库删除  1 carId  2skuId userId</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeNum</span><span class="params">(ChangeNumDto changeNumDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + changeNumDto.getUserId();</span><br><span class="line">        <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);<span class="comment">//K(user_car_用户id) k(skuId) v(skuJsondata)</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">kk</span> <span class="operator">=</span> changeNumDto.getSkuId().toString();</span><br><span class="line">        <span class="keyword">if</span> (operations.hasKey(kk))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//先查询出sku数据,修改数目后,再放进去</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">skuJsonStr</span> <span class="operator">=</span> (String) operations.get(kk);</span><br><span class="line">            <span class="type">ShopCar</span> <span class="variable">car</span> <span class="operator">=</span> JSONObject.parseObject(skuJsonStr, ShopCar.class);</span><br><span class="line">            car.setNum(changeNumDto.getNum());</span><br><span class="line">            putDataInRedis(operations, kk, car);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">(SelectCarDto carSelectDto)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">select</span> <span class="operator">=</span> carSelectDto.getSelect();</span><br><span class="line">        <span class="keyword">if</span> (select!=<span class="number">1</span> &amp;&amp; select!=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;非法输入!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + carSelectDto.getUserId();</span><br><span class="line">        <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);<span class="comment">//K(user_car_用户id) k(skuId) v(skuJsondata)</span></span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; skuIds = carSelectDto.getSkuIds();</span><br><span class="line">        skuIds.forEach(kk-&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">kkk</span> <span class="operator">=</span> kk.toString();</span><br><span class="line">            <span class="keyword">if</span> (operations.hasKey(kkk))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//先查询出sku数据,修改数目后,再放进去</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">skuJsonStr</span> <span class="operator">=</span> (String) operations.get(kkk);</span><br><span class="line">                <span class="type">ShopCar</span> <span class="variable">car</span> <span class="operator">=</span> JSONObject.parseObject(skuJsonStr, ShopCar.class);</span><br><span class="line">                car.setSelect(carSelectDto.getSelect());</span><br><span class="line">                putDataInRedis(operations, kkk, car);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; <span class="title function_">list</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + userId;</span><br><span class="line">        <span class="comment">//查询数据</span></span><br><span class="line">        List&lt;String&gt; shopCars = getDataFromRedis(key);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(shopCars))&#123;  <span class="comment">//redis中有数据</span></span><br><span class="line">            <span class="comment">//分组</span></span><br><span class="line">            Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; collect = shopCars.stream().map(shopCarsJsonStr-&gt;&#123;</span><br><span class="line">                <span class="keyword">return</span> JSONObject.parseObject(shopCarsJsonStr,ShopCar.class); <span class="comment">//把json字符串转换为ShopCar对象</span></span><br><span class="line">            &#125;).filter(shopCar -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> !shopCar.isDel();  <span class="comment">//true是要</span></span><br><span class="line">            &#125;).collect(Collectors.groupingBy(shopCar -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TenantIdName</span>(shopCar.getTenantId(),shopCar.getTenantName()); <span class="comment">//分组</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="keyword">return</span> collect;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1没有数据</span></span><br><span class="line">            List&lt;ShopCar&gt; shopCarsFromDb =  shopCarMapper.selectList(<span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;ShopCar&gt;().eq(<span class="string">&quot;user_id&quot;</span>,userId));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3分组返回</span></span><br><span class="line">            <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);</span><br><span class="line">            Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; collect = shopCarsFromDb.stream()</span><br><span class="line">                    .collect(Collectors.groupingBy(shopCar -&gt; &#123;</span><br><span class="line">                <span class="comment">//2放入redis</span></span><br><span class="line">                putDataInRedis(operations,shopCar.getSkuId(),shopCar);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TenantIdName</span>(shopCar.getTenantId(),shopCar.getTenantName()); <span class="comment">//分组</span></span><br><span class="line">            &#125;));</span><br><span class="line">            <span class="keyword">return</span> collect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">del</span><span class="params">(DelCarDto delCarDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Message&lt;String&gt; message = MessageBuilder.withPayload(JSONObject.toJSONString(delCarDto)).build();</span><br><span class="line">        <span class="comment">//发送事务消息</span></span><br><span class="line">        <span class="type">TransactionSendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> rocketMQTemplate.sendMessageInTransaction(</span><br><span class="line">                ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL,</span><br><span class="line">                ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL_TOPIC</span><br><span class="line">                        + <span class="string">&quot;:&quot;</span> + ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL_TOPIC_TAG,</span><br><span class="line">                message,</span><br><span class="line">                <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//本地事务-redis逻辑删除</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//消费者-数据库删除=reids物理删除</span></span><br><span class="line">        <span class="keyword">return</span> sendResult.getSendStatus()== SendStatus.SEND_OK?</span><br><span class="line">                AjaxResult.me():AjaxResult.me()</span><br><span class="line">                .setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;发送消息失败!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">executeDelShopCarLocalTransaction</span><span class="params">(DelCarDto dto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//做redis逻辑删除</span></span><br><span class="line">            List&lt;Long&gt; skuIds = dto.getSkuIds();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> dto.getUserId();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + userId;</span><br><span class="line">            <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);</span><br><span class="line">            skuIds.forEach(skuId-&gt;&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">kk</span> <span class="operator">=</span> skuId.toString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">shopCarJsonStr</span> <span class="operator">=</span> (String) operations.get(kk);</span><br><span class="line">                <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> JSONObject.parseObject(shopCarJsonStr, ShopCar.class);</span><br><span class="line">                shopCar.setDel(<span class="literal">true</span>);</span><br><span class="line">                operations.put(kk,JSONObject.toJSONString(shopCar));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">checkDelShopCarLocalTransaction</span><span class="params">(DelCarDto dto)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//做redis逻辑删除</span></span><br><span class="line">            List&lt;Long&gt; skuIds = dto.getSkuIds();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> dto.getUserId();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_CAR_PREFIX + userId;</span><br><span class="line">            <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);</span><br><span class="line">            <span class="type">String</span> <span class="variable">skuJsonStr</span> <span class="operator">=</span> (String) operations.get(skuIds.get(<span class="number">0</span>).toString());</span><br><span class="line">            <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> JSONObject.parseObject(skuJsonStr, ShopCar.class);</span><br><span class="line">            <span class="keyword">return</span> shopCar.isDel()?AjaxResult.me():AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;jfjfjjf&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; <span class="title function_">getDataFromRedis</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);</span><br><span class="line">        operations.expire(shopCarExpireTime,TimeUnit.SECONDS);</span><br><span class="line">        List&lt;String&gt; shopCars = operations.values();</span><br><span class="line">        <span class="keyword">return</span> shopCars;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">putDataInRedis</span><span class="params">(BoundHashOperations operations, Object kk, ShopCar car)</span> &#123;</span><br><span class="line">        operations.put(kk.toString(), JSONObject.toJSONString(car));</span><br><span class="line">        operations.expire(shopCarExpireTime, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.listener.trans;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.constants.ShopCarMqConstants;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.dto.DelCarDto;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.service.IShopCarService;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.util.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQTransactionListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQLocalTransactionListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQLocalTransactionState;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQTransactionListener( txProducerGroup = ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelShopCarRocketMQLocalTransactionListener</span> <span class="keyword">implements</span> <span class="title class_">RocketMQLocalTransactionListener</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IShopCarService shopCarService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RocketMQLocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message message, Object o)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = (<span class="type">byte</span>[]) message.getPayload();</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">            <span class="type">DelCarDto</span> <span class="variable">dto</span>  <span class="operator">=</span> JSONObject.parseObject(jsonStr, DelCarDto.class);</span><br><span class="line">            <span class="type">AjaxResult</span> <span class="variable">result</span> <span class="operator">=</span> shopCarService.executeDelShopCarLocalTransaction(dto);</span><br><span class="line">            <span class="keyword">if</span> (result.getSuccess()) &#123;</span><br><span class="line">                <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RocketMQLocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = (<span class="type">byte</span>[]) message.getPayload();</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">            <span class="type">DelCarDto</span> <span class="variable">dto</span>  <span class="operator">=</span> JSONObject.parseObject(jsonStr, DelCarDto.class);</span><br><span class="line"></span><br><span class="line">            <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> shopCarService.checkDelShopCarLocalTransaction(dto);</span><br><span class="line">            <span class="keyword">return</span> ajaxResult.getSuccess() ? RocketMQLocalTransactionState.COMMIT</span><br><span class="line">                    :RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.listener.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.constants.ShopCarMqConstants;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.domain.ShopCar;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.dto.DelCarDto;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.mapper.ShopCarMapper;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.service.impl.ShopCarServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.EntityWrapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.BoundHashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(topic = ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL_TOPIC,</span></span><br><span class="line"><span class="meta">        selectorExpression=ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL_TOPIC_TAG,</span></span><br><span class="line"><span class="meta">        consumerGroup = ShopCarMqConstants.TX_PRODUCER_GROUP_SHOPCAR_DEL_CONSUMER)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarDelRocketMQMsgListener</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;MessageExt&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShopCarMapper shopCarMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(MessageExt messageExt)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = messageExt.getBody();</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">            <span class="type">DelCarDto</span> <span class="variable">delDto</span>  <span class="operator">=</span> JSONObject.parseObject(jsonStr, DelCarDto.class);</span><br><span class="line">            log.error(delDto+<span class="string">&quot;&quot;</span>);</span><br><span class="line">            List&lt;Long&gt; skuIds = delDto.getSkuIds();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> delDto.getUserId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//删除数据库</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">delNum</span> <span class="operator">=</span> shopCarMapper.delete(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;ShopCar&gt;()</span><br><span class="line">                            .eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                            .and()</span><br><span class="line">                            .in(<span class="string">&quot;sku_id&quot;</span>, skuIds)</span><br><span class="line">            );</span><br><span class="line">            log.error(<span class="string">&quot;删除了%s条数据!&quot;</span>,delNum);</span><br><span class="line">            <span class="comment">//删除redis</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ShopCarServiceImpl.USER_CAR_PREFIX + userId;</span><br><span class="line">            <span class="type">BoundHashOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundHashOps(key);</span><br><span class="line">            skuIds.forEach(skuId-&gt;&#123;</span><br><span class="line">                operations.delete(skuId.toString());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;删除购物车失败!&quot;</span>);  <span class="comment">//抛出错误,会重试消费</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-3-数据库同步"><a href="#2-3-数据库同步" class="headerlink" title="2.3 数据库同步"></a>2.3 数据库同步</h4><h5 id="2-3-1-定时任务入门"><a href="#2-3-1-定时任务入门" class="headerlink" title="2.3.1 定时任务入门"></a>2.3.1 定时任务入门</h5><h6 id="2-3-1-1-什么是定时任务"><a href="#2-3-1-1-什么是定时任务" class="headerlink" title="2.3.1.1.什么是定时任务"></a>2.3.1.1.什么是定时任务</h6><p>定时任务是按照指定时间周期运行任务。使用场景为在某个固定时间点执行，或者周期性的去执行某个任务，比如：每天晚上24点做数据汇总，定时发送短信等。</p><h6 id="2-3-1-2-常见定时任务方案"><a href="#2-3-1-2-常见定时任务方案" class="headerlink" title="2.3.1.2.常见定时任务方案"></a>2.3.1.2.常见定时任务方案</h6><ul><li>While + Sleep : 通过循环加休眠的方式定时执行</li><li>Timer和TimerTask实现 ：JDK自带的定时任务，可以实现简单的间隔执行任务（在指定时间点执行某一任务，也能定时的周期性执行），无法实现按日历去调度执行任务。</li><li>ScheduledExecutorService : Java并发包下,JDK1.5出现，是比较理想的定时任务实现方案。Eureka就使用的是它</li><li>QuartZ : 使用Quartz，它是一个异步任务调度框架，功能丰富，可以实现按日历调度,支持持久化。</li><li>使用Spring Task，Spring 3.0后提供Spring Task实现任务调度，支持按日历调度，相比Quartz功能稍简单，但是在开发基本够用，支持注解编程方式。</li><li>SpringBoot中的Schedule ：通过@EnableScheduling+@Scheduled最实现定时任务，底层使用的是Spring Task</li><li>xxl-job</li></ul><h6 id="2-3-1-3-quartz入门-原生实现"><a href="#2-3-1-3-quartz入门-原生实现" class="headerlink" title="2.3.1.3 quartz入门-原生实现"></a>2.3.1.3 quartz入门-原生实现</h6><p>概念:</p><p>​ Quartz 是一个开源的作业调度框架。在使用这个框架之前，我们需要知道几个基本的概念<strong>Job</strong>，<strong>Trigger</strong>以及<strong>Schedule</strong>：</p><p>​	<strong>Job和JobDetail</strong><br>​	既然是作业调度，那么肯定要有作业呀，这个作业就是Job。在定义我们自己的Job的时候，只需要实现Job接口，然后在execute方法里编写具体的业务逻辑即可。也可以继承QuartzJobBean类并重写executeInternal方法，因为QuartzJobBean类也是实现了Job接口。</p><p>JobDetail里么有一个JobDataMap–&gt;定义一些定时任务执行的参数</p><p><strong>Trigger</strong></p><p>​	有了任务之后，就该设置任务的触发事件了，在Quartz中使用Trigger来描述触发Job执行的时间触发规则。一个Job可以添加多个Trigger，但是一个Trigger只能绑定一个Job。</p><p>Quartz中一共有四种Trigger：</p><p>SimpleTrigger：这种触发器可以在给定时刻触发作业，并且可选择以指定的时间间隔重复。<br>CronTrigger：用过定时任务的小伙伴应该会猜到这个是干什么的吧。这个触发器可以设置一个Cron表达式，指定任务的执行周期。<br>CalendarIntervalTrigger：用于根据重复的日历时间间隔触发。<br><strong>DailyTimeIntervalTrigger</strong>：用于根据每天重复的时间间隔触发任务的触发器。</p><p><strong>Schedule</strong></p><p>Schedule所扮演的是一个执行者的角色，将JobDetail和Trigger注册到Schedule中，它就会按照指定的规则去执行任务。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>简单实用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleJobTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> SchedulerException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">//任务详情</span></span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class)</span><br><span class="line">                .withIdentity(<span class="string">&quot;myJob&quot;</span>,<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">JobDataMap</span> <span class="variable">jobDataMap</span> <span class="operator">=</span> jobDetail.getJobDataMap();</span><br><span class="line">        <span class="comment">//传递参数   对象(Json转换)</span></span><br><span class="line">        jobDataMap.put(<span class="string">&quot;your are diaomao!&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发条件</span></span><br><span class="line">        <span class="comment">//MutableTrigger trigger = CronScheduleBuilder</span></span><br><span class="line">        <span class="comment">// .cronSchedule(&quot;* * 3 * * ? &quot;).build();</span></span><br><span class="line">        <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder</span><br><span class="line">                .newTrigger()</span><br><span class="line">                .withSchedule(CronScheduleBuilder</span><br><span class="line">                        .cronSchedule(<span class="string">&quot;0/5 * * * * ? &quot;</span>))</span><br><span class="line">                .forJob(jobDetail)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交给调度器</span></span><br><span class="line">        <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>().getScheduler();</span><br><span class="line">        scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">        scheduler.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.mliutm.gift;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span></span><br><span class="line">            <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> jobExecutionContext.getJobDetail();</span><br><span class="line">        <span class="type">JobDataMap</span> <span class="variable">jobDataMap</span> <span class="operator">=</span> jobDetail.getJobDataMap();</span><br><span class="line">        System.out.println(jobDataMap.get(<span class="string">&quot;your are diaomao!&quot;</span>));</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>)</span><br><span class="line">                .format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="2-3-1-4-springboot-quartz"><a href="#2-3-1-4-springboot-quartz" class="headerlink" title="2.3.1.4 springboot quartz"></a>2.3.1.4 springboot quartz</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.quartz.MyJob;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = App.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringbootQurartzTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SchedulerFactoryBean factoryBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1 springboot版本</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testBoot</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//任务详情</span></span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class)</span><br><span class="line">                .withIdentity(<span class="string">&quot;myJob&quot;</span>,<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">JobDataMap</span> <span class="variable">jobDataMap</span> <span class="operator">=</span> jobDetail.getJobDataMap();</span><br><span class="line">        <span class="comment">//传递参数   对象(Json转换)</span></span><br><span class="line">        jobDataMap.put(<span class="string">&quot;your are diaomao!&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发条件</span></span><br><span class="line">        <span class="comment">//MutableTrigger trigger = CronScheduleBuilder</span></span><br><span class="line">        <span class="comment">// .cronSchedule(&quot;* * 3 * * ? &quot;).build();</span></span><br><span class="line">        <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder</span><br><span class="line">                .newTrigger()</span><br><span class="line">                .withSchedule(CronScheduleBuilder</span><br><span class="line">                        .cronSchedule(<span class="string">&quot;0/5 * * * * ? &quot;</span>))</span><br><span class="line">                .forJob(jobDetail)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交给调度器</span></span><br><span class="line">        <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> factoryBean.getScheduler();</span><br><span class="line">        scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">        scheduler.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="2-3-1-5-springboot-quartz-持久化-在已经支持数据库的环境测试"><a href="#2-3-1-5-springboot-quartz-持久化-在已经支持数据库的环境测试" class="headerlink" title="2.3.1.5 springboot quartz-持久化(在已经支持数据库的环境测试)"></a>2.3.1.5 springboot quartz-持久化(在已经支持数据库的环境测试)</h6><p>导入sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : localhost_3306</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 50720</span></span><br><span class="line"><span class="comment"> Source Host           : localhost:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : gift_car</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 50720</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 15/05/2023 14:15:34</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_blob_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_blob_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_blob_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `BLOB_DATA` <span class="type">blob</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `SCHED_NAME`(`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `qrtz_blob_triggers_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">REFERENCES</span> `qrtz_triggers` (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_blob_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_calendars</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_calendars`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_calendars`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `CALENDAR_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `CALENDAR` <span class="type">blob</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `CALENDAR_NAME`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_calendars</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_cron_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_cron_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_cron_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `CRON_EXPRESSION` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TIME_ZONE_ID` <span class="type">varchar</span>(<span class="number">80</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `qrtz_cron_triggers_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">REFERENCES</span> `qrtz_triggers` (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_cron_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_fired_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_fired_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_fired_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ENTRY_ID` <span class="type">varchar</span>(<span class="number">95</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `INSTANCE_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `FIRED_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `SCHED_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `PRIORITY` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `STATE` <span class="type">varchar</span>(<span class="number">16</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `IS_NONCONCURRENT` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `REQUESTS_RECOVERY` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `ENTRY_ID`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_TRIG_INST_NAME`(`SCHED_NAME`, `INSTANCE_NAME`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_INST_JOB_REQ_RCVRY`(`SCHED_NAME`, `INSTANCE_NAME`, `REQUESTS_RECOVERY`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_J_G`(`SCHED_NAME`, `JOB_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_JG`(`SCHED_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_T_G`(`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_FT_TG`(`SCHED_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_fired_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_job_details</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_job_details`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_job_details`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `DESCRIPTION` <span class="type">varchar</span>(<span class="number">250</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_CLASS_NAME` <span class="type">varchar</span>(<span class="number">250</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `IS_DURABLE` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `IS_NONCONCURRENT` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `IS_UPDATE_DATA` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `REQUESTS_RECOVERY` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_DATA` <span class="type">blob</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `JOB_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_J_REQ_RECOVERY`(`SCHED_NAME`, `REQUESTS_RECOVERY`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_J_GRP`(`SCHED_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_job_details</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_locks</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_locks`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_locks`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `LOCK_NAME` <span class="type">varchar</span>(<span class="number">40</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `LOCK_NAME`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_locks</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `qrtz_locks` <span class="keyword">VALUES</span> (<span class="string">&#x27;communityScheduler&#x27;</span>, <span class="string">&#x27;STATE_ACCESS&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_paused_trigger_grps</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_paused_trigger_grps`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_paused_trigger_grps`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_paused_trigger_grps</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_scheduler_state</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_scheduler_state`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_scheduler_state`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `INSTANCE_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `LAST_CHECKIN_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `CHECKIN_INTERVAL` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `INSTANCE_NAME`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_scheduler_state</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `qrtz_scheduler_state` <span class="keyword">VALUES</span> (<span class="string">&#x27;communityScheduler&#x27;</span>, <span class="string">&#x27;XTZJ-20221121PX1684131250594&#x27;</span>, <span class="number">1684131331529</span>, <span class="number">7500</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_simple_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_simple_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_simple_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `REPEAT_COUNT` <span class="type">bigint</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `REPEAT_INTERVAL` <span class="type">bigint</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TIMES_TRIGGERED` <span class="type">bigint</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `qrtz_simple_triggers_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">REFERENCES</span> `qrtz_triggers` (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_simple_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_simprop_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_simprop_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_simprop_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `STR_PROP_1` <span class="type">varchar</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `STR_PROP_2` <span class="type">varchar</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `STR_PROP_3` <span class="type">varchar</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `INT_PROP_1` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `INT_PROP_2` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `LONG_PROP_1` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `LONG_PROP_2` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `DEC_PROP_1` <span class="type">decimal</span>(<span class="number">13</span>, <span class="number">4</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `DEC_PROP_2` <span class="type">decimal</span>(<span class="number">13</span>, <span class="number">4</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `BOOL_PROP_1` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `BOOL_PROP_2` <span class="type">varchar</span>(<span class="number">1</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `qrtz_simprop_triggers_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">REFERENCES</span> `qrtz_triggers` (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_simprop_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for qrtz_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `qrtz_triggers`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `qrtz_triggers`  (</span><br><span class="line">  `SCHED_NAME` <span class="type">varchar</span>(<span class="number">120</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_GROUP` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `DESCRIPTION` <span class="type">varchar</span>(<span class="number">250</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `NEXT_FIRE_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `PREV_FIRE_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `PRIORITY` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_STATE` <span class="type">varchar</span>(<span class="number">16</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `TRIGGER_TYPE` <span class="type">varchar</span>(<span class="number">8</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `START_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `END_TIME` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `CALENDAR_NAME` <span class="type">varchar</span>(<span class="number">190</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `MISFIRE_INSTR` <span class="type">smallint</span>(<span class="number">2</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `JOB_DATA` <span class="type">blob</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_J`(`SCHED_NAME`, `JOB_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_JG`(`SCHED_NAME`, `JOB_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_C`(`SCHED_NAME`, `CALENDAR_NAME`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_G`(`SCHED_NAME`, `TRIGGER_GROUP`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_STATE`(`SCHED_NAME`, `TRIGGER_STATE`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_N_STATE`(`SCHED_NAME`, `TRIGGER_NAME`, `TRIGGER_GROUP`, `TRIGGER_STATE`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_N_G_STATE`(`SCHED_NAME`, `TRIGGER_GROUP`, `TRIGGER_STATE`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_NEXT_FIRE_TIME`(`SCHED_NAME`, `NEXT_FIRE_TIME`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_NFT_ST`(`SCHED_NAME`, `TRIGGER_STATE`, `NEXT_FIRE_TIME`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_NFT_MISFIRE`(`SCHED_NAME`, `MISFIRE_INSTR`, `NEXT_FIRE_TIME`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_NFT_ST_MISFIRE`(`SCHED_NAME`, `MISFIRE_INSTR`, `NEXT_FIRE_TIME`, `TRIGGER_STATE`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `IDX_QRTZ_T_NFT_ST_MISFIRE_GRP`(`SCHED_NAME`, `MISFIRE_INSTR`, `NEXT_FIRE_TIME`, `TRIGGER_GROUP`, `TRIGGER_STATE`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `qrtz_triggers_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`SCHED_NAME`, `JOB_NAME`, `JOB_GROUP`) <span class="keyword">REFERENCES</span> `qrtz_job_details` (`SCHED_NAME`, `JOB_NAME`, `JOB_GROUP`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of qrtz_triggers</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">quartz:</span></span><br><span class="line">    <span class="attr">job-store-type:</span> <span class="string">jdbc</span></span><br><span class="line">    <span class="attr">scheduler-name:</span> <span class="string">communityScheduler</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">org:</span></span><br><span class="line">        <span class="attr">quartz:</span></span><br><span class="line">          <span class="attr">scheduler:</span></span><br><span class="line">            <span class="attr">instanceId:</span> <span class="string">AUTO</span></span><br><span class="line">          <span class="attr">jobStore:</span></span><br><span class="line">            <span class="attr">class:</span> <span class="string">org.springframework.scheduling.quartz.LocalDataSourceJobStore</span></span><br><span class="line">            <span class="attr">driverDelegateClass:</span> <span class="string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></span><br><span class="line">            <span class="attr">isClustered:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">tablePrefix:</span> <span class="string">QRTZ_</span></span><br><span class="line">          <span class="attr">threadPool:</span></span><br><span class="line">            <span class="attr">class:</span> <span class="string">org.quartz.simpl.SimpleThreadPool</span></span><br><span class="line">            <span class="attr">threadCount:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><p>测试</p><p>​ 测试类中,保存持久化数据,然后启动项目看它还在没有……</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = CarStart.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleJobTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SchedulerFactoryBean factoryBean;</span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">       <span class="comment">//任务详情</span></span><br><span class="line">       <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class)</span><br><span class="line">               .withIdentity(<span class="string">&quot;myJob&quot;</span>,<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="type">JobDataMap</span> <span class="variable">jobDataMap</span> <span class="operator">=</span> jobDetail.getJobDataMap();</span><br><span class="line">       <span class="comment">//传递参数   对象(Json转换)</span></span><br><span class="line">       jobDataMap.put(<span class="string">&quot;your are diaomao!&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//触发条件</span></span><br><span class="line">       <span class="comment">//MutableTrigger trigger = CronScheduleBuilder</span></span><br><span class="line">       <span class="comment">// .cronSchedule(&quot;* * 3 * * ? &quot;).build();</span></span><br><span class="line">       <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder</span><br><span class="line">               .newTrigger()</span><br><span class="line">               .withSchedule(CronScheduleBuilder</span><br><span class="line">                       .cronSchedule(<span class="string">&quot;0/5 * * * * ? &quot;</span>))</span><br><span class="line">               .forJob(jobDetail)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//交给调度器</span></span><br><span class="line">       Scheduler scheduler= factoryBean.getScheduler();</span><br><span class="line">       scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">       scheduler.start();</span><br><span class="line"></span><br><span class="line">       Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDel</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">       Scheduler scheduler= factoryBean.getScheduler();</span><br><span class="line">       scheduler.deleteJob(<span class="keyword">new</span> <span class="title class_">JobKey</span>(<span class="string">&quot;myJob&quot;</span>,<span class="string">&quot;xxxx&quot;</span>));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&#x2F;&#x2F;代码不要放到test,要放java</p><h5 id="2-3-2-Quartz实战"><a href="#2-3-2-Quartz实战" class="headerlink" title="2.3.2 Quartz实战"></a>2.3.2 Quartz实战</h5><p>pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;cn.mliutm.gift.mapper&quot;)</span></span><br><span class="line"><span class="meta">@ServletComponentScan(&quot;cn.mliutm.gift.web.listener&quot;)</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarStart</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ShopCarStart.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddShopSysCarRedisDataToDbJobListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IAddSysShopCarRedisDataToDbJobService addSysShopCarRedisDataToDbJobService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;容器启动的时候调用!&quot;</span>);</span><br><span class="line">        addSysShopCarRedisDataToDbJobService.add();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;容器摧毁的时候调用!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddSysShopCarRedisDataToDbJobServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IAddSysShopCarRedisDataToDbJobService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SchedulerFactoryBean factoryBean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;AddSysShopCarRedisDataToDbJobLock&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1开启分布式锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">// 2判断有没有定时任务</span></span><br><span class="line">            <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> factoryBean.getScheduler();</span><br><span class="line">            <span class="type">JobKey</span> <span class="variable">jobKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobKey</span>(<span class="string">&quot;AddSysShopCarRedisDataToDbJob&quot;</span>, <span class="string">&quot;mliutm&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> scheduler.checkExists(jobKey); <span class="comment">//是否已经被调度了</span></span><br><span class="line">            <span class="keyword">if</span> (!exists)&#123;</span><br><span class="line">                <span class="comment">//3如果没有添加一个</span></span><br><span class="line">                <span class="comment">//任务详情</span></span><br><span class="line">                <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> JobBuilder.newJob(AddShopCarRedisDataSysToDbJob.class)</span><br><span class="line">                        .withIdentity(jobKey.getName(), jobKey.getGroup())</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="comment">//触发条件</span></span><br><span class="line">                <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder</span><br><span class="line">                        .newTrigger()</span><br><span class="line">                        .withSchedule(CronScheduleBuilder</span><br><span class="line">                                <span class="comment">//每天凌晨1点执行</span></span><br><span class="line">                                <span class="comment">//.cronSchedule(&quot;0 0 1 * * ? * &quot;))</span></span><br><span class="line">                                .cronSchedule(<span class="string">&quot;0/1 * * * * ? * &quot;</span>))</span><br><span class="line">                        .forJob(jobDetail)</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//交给调度器</span></span><br><span class="line">                scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">                scheduler.start();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//4否则不做事情,打个日志...</span></span><br><span class="line">                log.error(<span class="string">&quot;AddShopCarRedisDataSysToDbJob existsed!&quot;</span>);</span><br><span class="line">                scheduler.resumeJob(jobKey);</span><br><span class="line">                scheduler.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭分布式锁</span></span><br><span class="line">            <span class="keyword">if</span> (lock != <span class="literal">null</span>) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>job</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddShopCarRedisDataSysToDbJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println( jobExecutionContext.getJobDetail().getKey().getName()+<span class="string">&quot;&quot;</span>+<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>)</span><br><span class="line">                .format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">ShopCarServiceImpl </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;car.group.strategy&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String carGroupStrategy;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String  REDIS_KEY_IS_EXECUTE= <span class="string">&quot;redis_key_is_execute&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sysData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(REDIS_KEY_IS_EXECUTE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//加上分布式锁</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(REDIS_KEY_IS_EXECUTE);</span><br><span class="line">            <span class="keyword">if</span> (o==<span class="literal">null</span> || o.equals(<span class="string">&quot;false&quot;</span>)) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(REDIS_KEY_IS_EXECUTE,<span class="string">&quot;true&quot;</span>,<span class="number">1</span>,TimeUnit.HOURS);</span><br><span class="line">                <span class="comment">//1 分组</span></span><br><span class="line">                <span class="comment">//获取所有人的key,一个人就是一个可以 3000W/50W=60</span></span><br><span class="line">                Set&lt;String&gt; keys = redisTemplate.keys(USER_CAR_PREFIX + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">                <span class="comment">/*List&lt;List&lt;String&gt;&gt; groupResult = new ArrayList&lt;&gt;(60);//外层放60个(组),里面放没一组数据</span></span><br><span class="line"><span class="comment">                // 第一组 索引是0</span></span><br><span class="line"><span class="comment">                // 第二组 索引是1</span></span><br><span class="line"><span class="comment">                keys.forEach(key-&gt;&#123;</span></span><br><span class="line"><span class="comment">                    int groupIndex = key.hashCode() % 60; //0-59 算出自己属于那一组</span></span><br><span class="line"><span class="comment">                    List&lt;String&gt; strings = groupResult.get(groupIndex);</span></span><br><span class="line"><span class="comment">                    if (CollectionUtil.isNotEmpty(strings))  //判断是否有其他成员</span></span><br><span class="line"><span class="comment">                        strings.add(key); //如果有吧自己作为成员放进去就ok</span></span><br><span class="line"><span class="comment">                    else&#123; //新建一个组,吧自己放入这个组,</span></span><br><span class="line"><span class="comment">                        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">                        list.add(key); //成员放入</span></span><br><span class="line"><span class="comment">                        groupResult.add(groupIndex,list); //添加组</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;);*/</span></span><br><span class="line">                <span class="type">ShopCarKeyGroupStrategy</span> <span class="variable">groupStrategy</span> <span class="operator">=</span> ShopCarKeyGroupStrategyFactory</span><br><span class="line">                        .createInstance(carGroupStrategy);</span><br><span class="line">                List&lt;List&lt;String&gt;&gt; groupResult = groupStrategy.group(keys);</span><br><span class="line">                <span class="comment">//2 批量同步数据到数据库</span></span><br><span class="line">                groupResult.forEach(list -&gt; &#123;</span><br><span class="line">                    List&lt;ShopCar&gt; bulkOprData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10000</span>);</span><br><span class="line">                    list.forEach(key -&gt; &#123;</span><br><span class="line">                        <span class="comment">//user-car-1</span></span><br><span class="line">                        <span class="type">BoundHashOperations</span> <span class="variable">boundHashOperations</span> <span class="operator">=</span> redisTemplate</span><br><span class="line">                                .boundHashOps(key);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//这个用户的购物车</span></span><br><span class="line">                        Set&lt;String&gt; allSkuCars = boundHashOperations.keys();</span><br><span class="line"></span><br><span class="line">                        allSkuCars.forEach(hashKey -&gt; &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> (String) boundHashOperations.get(hashKey);</span><br><span class="line">                            <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> JSONObject.parseObject(jsonStr, ShopCar.class);</span><br><span class="line">                            bulkOprData.add(shopCar);</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">//做一次批量插入-一组就插入一次</span></span><br><span class="line">                    <span class="comment">//调用函数实现-- 遍历50w,区分如果有就update,否则就添加</span></span><br><span class="line">                    shopCarMapper.insertOrUpdateBatch(bulkOprData);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                log.error(<span class="string">&quot;sysJob executed in today!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            redisTemplate.delete(REDIS_KEY_IS_EXECUTE);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock != <span class="literal">null</span>) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;insert id=<span class="string">&quot;insertOrUpdateBatch&quot;</span> parameterType=<span class="string">&quot;ShopCar&quot;</span>&gt;</span><br><span class="line">         insert into <span class="title function_">t_shop_car</span><span class="params">(</span></span><br><span class="line"><span class="params">            id,</span></span><br><span class="line"><span class="params">            spu_id,</span></span><br><span class="line"><span class="params">            spu_name,</span></span><br><span class="line"><span class="params">            sku_id,</span></span><br><span class="line"><span class="params">            sku_info,</span></span><br><span class="line"><span class="params">            num,</span></span><br><span class="line"><span class="params">            tenant_id,</span></span><br><span class="line"><span class="params">            tenant_name,</span></span><br><span class="line"><span class="params">            user_id,</span></span><br><span class="line"><span class="params">            username,</span></span><br><span class="line"><span class="params">            is_select,</span></span><br><span class="line"><span class="params">            add_price,</span></span><br><span class="line"><span class="params">            price,</span></span><br><span class="line"><span class="params">            create_time,</span></span><br><span class="line"><span class="params">            update_time</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        )</span></span><br><span class="line">        values</span><br><span class="line">        &lt;foreach collection=<span class="string">&quot;list&quot;</span> item=<span class="string">&quot;shopCar&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt;</span><br><span class="line">           (</span><br><span class="line">            #&#123;shopCar.id&#125;,</span><br><span class="line">            #&#123;shopCar.spuId&#125;,</span><br><span class="line">            #&#123;shopCar.spuName&#125;,</span><br><span class="line">            #&#123;shopCar.skuId&#125;,</span><br><span class="line">            #&#123;shopCar.skuInfo&#125;,</span><br><span class="line">            #&#123;shopCar.num&#125;,</span><br><span class="line">            #&#123;shopCar.tenantId&#125;,</span><br><span class="line">            #&#123;shopCar.tenantName&#125;,</span><br><span class="line">            #&#123;shopCar.userId&#125;,</span><br><span class="line">            #&#123;shopCar.username&#125;,</span><br><span class="line">            #&#123;shopCar.select&#125;,</span><br><span class="line">            #&#123;shopCar.addPrice&#125;,</span><br><span class="line">            #&#123;shopCar.price&#125;,</span><br><span class="line">            #&#123;shopCar.createTime&#125;,</span><br><span class="line">            #&#123;shopCar.updateTime&#125;</span><br><span class="line">            )</span><br><span class="line">        &lt;/foreach&gt;</span><br><span class="line">        on duplicate key update</span><br><span class="line">            spu_id=values(spu_id),</span><br><span class="line">            spu_name=values(spu_name),</span><br><span class="line">            sku_id=values(sku_id),</span><br><span class="line">            sku_info=values(sku_info),</span><br><span class="line">            num=values(num),</span><br><span class="line">            tenant_id=values(tenant_id),</span><br><span class="line">            tenant_name=values(tenant_name),</span><br><span class="line">            user_id=values(user_id),</span><br><span class="line">            username=values(username),</span><br><span class="line">            is_select=values(is_select),</span><br><span class="line">            add_price=values(add_price),</span><br><span class="line">            price=values(price),</span><br><span class="line">            create_time=values(create_time),</span><br><span class="line">            update_time=values(update_time)</span><br><span class="line">    &lt;/insert&gt;</span><br></pre></td></tr></table></figure><p>分组策略模式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只是定义一个策略接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShopCarKeyGroupStrategy</span> &#123;</span><br><span class="line">    List&lt;List&lt;String&gt;&gt; <span class="title function_">group</span><span class="params">(Set&lt;String&gt; keys)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarKeyHashGroupStrategy</span> <span class="keyword">implements</span> <span class="title class_">ShopCarKeyGroupStrategy</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;List&lt;String&gt;&gt; <span class="title function_">group</span><span class="params">(Set&lt;String&gt; keys)</span> &#123;</span><br><span class="line">        List&lt;List&lt;String&gt;&gt; groupResult = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">60</span>);<span class="comment">//外层放60个(组),里面放没一组数据</span></span><br><span class="line">        <span class="comment">// 第一组 索引是0</span></span><br><span class="line">        <span class="comment">// 第二组 索引是1</span></span><br><span class="line">        keys.forEach(key-&gt;&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">groupIndex</span> <span class="operator">=</span> key.hashCode() % <span class="number">60</span>; <span class="comment">//0-59 算出自己属于那一组</span></span><br><span class="line">            List&lt;String&gt; strings = groupResult.get(groupIndex);</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtil.isNotEmpty(strings))  <span class="comment">//判断是否有其他成员</span></span><br><span class="line">                strings.add(key); <span class="comment">//如果有吧自己作为成员放进去就ok</span></span><br><span class="line">            <span class="keyword">else</span>&#123; <span class="comment">//新建一个组,吧自己放入这个组,</span></span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                list.add(key); <span class="comment">//成员放入</span></span><br><span class="line">                groupResult.add(groupIndex,list); <span class="comment">//添加组</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> groupResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 策略工厂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarKeyGroupStrategyFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ShopCarKeyGroupStrategy</span> <span class="variable">defalutShopCarKeyGroupStrategy</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ShopCarKeyHashGroupStrategy</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ShopCarKeyGroupStrategy <span class="title function_">createInstance</span></span><br><span class="line">            <span class="params">(String carGroupStrategy)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(carGroupStrategy))</span><br><span class="line">            <span class="keyword">return</span> defalutShopCarKeyGroupStrategy;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;? <span class="keyword">extends</span> <span class="title class_">ShopCarKeyGroupStrategy</span> &gt; clazz =</span><br><span class="line">                    (Class&lt;? <span class="keyword">extends</span> <span class="title class_">ShopCarKeyGroupStrategy</span>&gt;) Class.forName(carGroupStrategy);</span><br><span class="line">            <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;invalid Strategy &#123;1&#125;,using defalut groupStrategy!&quot;</span>,carGroupStrategy);</span><br><span class="line">            <span class="keyword">return</span> defalutShopCarKeyGroupStrategy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-3-3-xxl-job-实战"><a href="#2-3-3-xxl-job-实战" class="headerlink" title="2.3.3 xxl-job 实战"></a>2.3.3 xxl-job 实战</h5><h6 id="2-3-3-1-搭建gift-basic-xxljob模块"><a href="#2-3-3-1-搭建gift-basic-xxljob模块" class="headerlink" title="2.3.3.1 搭建gift-basic-xxljob模块"></a>2.3.3.1 搭建gift-basic-xxljob模块</h6><p>​	在gift-basic-parent下创建gift-basic-xxljob子模块</p><p>​	在pom.xml中导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ********************** embed server: netty + gson ********************** --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-codec-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.90.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ********************** plugin ********************** --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- groovy-all --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- spring-context --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ********************** base ********************** --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- slf4j --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- javax.annotation-api --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>直接从xxl-job项目中的xxl-job-core项目中,导入包下所有的类到gift-basic-xxljob模块中</p><p><img src="/breeze/2602ce24/1695780220957.png" alt="1695780220957"></p><p><strong>另一种在购物车服务中引入xxl-job的方式</strong></p><ul><li><p>直接将xxl-job-core在本地打成一个jar包</p><p><img src="/breeze/2602ce24/image-20240117170717345.png" alt="image-20240117170717345"></p></li><li><p>在公共依赖的服务中，导入xxl-job-core的依赖</p><p><img src="/breeze/2602ce24/image-20240117170809738.png" alt="image-20240117170809738"></p><p>可以在购物车服务的依赖中看到已经引入了xxl-job-core的jar包，至此购物车服务也可以正常使用xxl-job了</p><p><img src="/breeze/2602ce24/image-20240117171027827.png" alt="image-20240117171027827"></p><p><strong>经测试：通过该方法引入的xxl-job可以正常使用</strong></p></li></ul><h6 id="2-3-3-2-修改gift-shopcar-service服务"><a href="#2-3-3-2-修改gift-shopcar-service服务" class="headerlink" title="2.3.3.2 修改gift-shopcar-service服务"></a>2.3.3.2 修改gift-shopcar-service服务</h6><p>在pom.xml中依赖gift-basic-xxljob模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.mliutm.gift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gift-basic-xxljob<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改bootstrap.yml配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://127.0.0.1:18080/xxl-job-admin</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">gift-shopcar</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9998</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="attr">ip:</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">      <span class="comment"># address:  rpc的连接地址  ip:port</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>拷贝XxlJobConfig配置文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-job config</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2017-04-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      1、引入依赖：</span></span><br><span class="line"><span class="comment">     *          &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span></span><br><span class="line"><span class="comment">     *         &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      2、配置文件，或者容器启动变量</span></span><br><span class="line"><span class="comment">     *          spring.cloud.inetutils.preferred-networks: &#x27;xxx.xxx.xxx.&#x27;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      3、获取IP</span></span><br><span class="line"><span class="comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="2-3-3-3-注册到调度中心"><a href="#2-3-3-3-注册到调度中心" class="headerlink" title="2.3.3.3 注册到调度中心"></a>2.3.3.3 注册到调度中心</h6><p><img src="/breeze/2602ce24/1695780424149.png" alt="1695780424149"></p><p>在购物车服务中写一个jobHandler</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarRedisDataToDbHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;shopCarRedisDataToDbJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shopCarRedisDataToDbJobHandler</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;购物车数据同步开始.................................&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将该jobHandler添加到调度中心的任务管理中</p><p><img src="/breeze/2602ce24/1695780517832.png" alt="1695780517832"></p><h3 id="将Redis中的数据写入MySQL"><a href="#将Redis中的数据写入MySQL" class="headerlink" title="将Redis中的数据写入MySQL"></a>将Redis中的数据写入MySQL</h3><p><strong>将redis中的数据写入数据库需要注意什么？（基本操作）</strong></p><ul><li>有的数据是写入操作（之前的mysql中没有相应的数据）</li><li>有的数据是更新操作（之前的mysql中有相应的数据）</li></ul><p><strong>上面的操作虽然可以实现数据同步，但是并不合理</strong></p><p><font color="red">原因：假如这个系统日活用户用40W，其中只用20W用过购物车（redis中有20W个key），这20W用户名下的购物车中各有10条数据，则一共用200W条数据。在单线程下，这个效率会很低很低。</font></p><p><strong>如何解决：</strong></p><ul><li><p>将key进行分组，20W的key不要使用一个线程进行处理。</p><p>对key进行分组：</p><ol><li>按数据量进行分组：1-5W一组；6-10W一组；。。。这样的话，20W条数据需要四个线程来处理。</li><li>一致性hash原则进行分组：hash(key)%100(组) – 一组2000个数据</li></ol></li><li><p>结合使用多线程来处理</p></li></ul><p><strong>如何分组？</strong></p><p><mark>策略模式 + 工厂方法</mark></p><p>策略模式：使用两个策略进行分组</p><ul><li>按数据量进行分组</li><li>使用一致性hash进行分组</li></ul><p><img src="/breeze/2602ce24/image-20240117184904559.png" alt="image-20240117184904559"></p><p><strong>IKeyGroupStrategy 策略接口</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.strategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IKeysGroupStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, List&lt;Object&gt;&gt; <span class="title function_">groupData</span><span class="params">(Set&lt;Object&gt; set)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>KeysGroupWithHashStrategy 策略实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.strategy.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.IKeysGroupStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeysGroupWithHashStrategy</span> <span class="keyword">implements</span> <span class="title class_">IKeysGroupStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Object&gt;&gt; <span class="title function_">groupData</span><span class="params">(Set&lt;Object&gt; set)</span> &#123;</span><br><span class="line">        Map&lt;String, List&lt;Object&gt;&gt; keyMap = set.stream().collect(Collectors.groupingBy(x -&gt; x.hashCode() % <span class="number">100</span> + <span class="string">&quot;&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> keyMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>KeysGroupWithSizeStrategy 策略实现</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.strategy.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.IKeysGroupStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeysGroupWithSizeStrategy</span> <span class="keyword">implements</span> <span class="title class_">IKeysGroupStrategy</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Object&gt;&gt; <span class="title function_">groupData</span><span class="params">(Set&lt;Object&gt; set)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>KeysGroupStrategyFactory 工厂</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.strategy.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.IKeysGroupStrategy;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.impl.KeysGroupWithHashStrategy;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.impl.KeysGroupWithSizeStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeysGroupStrategyFactory</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        创建对象的完全限定名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IKeysGroupStrategy <span class="title function_">getInstance</span><span class="params">(String className)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = Class.forName(className);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aClass.newInstance();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> KeysGroupWithHashStrategy)&#123;</span><br><span class="line">                <span class="keyword">return</span> (KeysGroupWithHashStrategy)o;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeysGroupWithSizeStrategy</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在本地bootstrap.yml或者远程的nacos中对应的yaml文件中进行如下配置：动态的选择需要哪种策略进行分组</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groupClassName:</span></span><br><span class="line">  <span class="attr">keysGroupStrategy:</span> <span class="string">com.mliutm.gift.strategy.impl.KeysGroupWithHashStrategy</span></span><br></pre></td></tr></table></figure><p><strong>在类中注入该配置：使用@Value注解+@RefreshScope（方式一）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;groupClassName.keysGroupStrategy&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String keysGroupStrategy;</span><br></pre></td></tr></table></figure><p><strong>方式二：直接使用@ConfigurationProperties注解即可，这种适合注入多个属性，将属性注入到被@ConfigurationProperties标注的类中，这个类会被spring容器所管理，直接在需要用到配置文件中的属性的地方，注入该类即可，然后取出需要的属性。</strong></p><p><strong>在ShopCar中添加一个数据库中没有的字段</strong></p><p><img src="/breeze/2602ce24/image-20240117192802195.png" alt="image-20240117192802195"></p><p><strong>完整的同步代码：ShopCarServiceImpl <mark>及其重要</mark></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.EntityWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.Wrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.client.GiftClient;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.domain.GoodsSku;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.domain.ShopCar;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.dto.AddCarDto;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.dto.TenantIdName;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.enums.ResponseCode;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.mapper.ShopCarMapper;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.service.IShopCarService;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.IKeysGroupStrategy;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.strategy.factory.KeysGroupStrategyFactory;</span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.util.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.BoundHashOperations;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 服务实现类</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mliutm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2024-01-09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopCarServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopCarMapper, ShopCar&gt; <span class="keyword">implements</span> <span class="title class_">IShopCarService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">car_in_redis_prefix</span> <span class="operator">=</span> <span class="string">&quot;car_in_redis_prefix:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GiftClient giftClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;groupClassName.keysGroupStrategy&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String keysGroupStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加数据到redis的方法</span></span><br><span class="line"><span class="comment">     * 抑制 skuId  数量</span></span><br><span class="line"><span class="comment">     * 1.先去redis里面找当前用户的购物车数据是存在</span></span><br><span class="line"><span class="comment">     * 2.如果存在</span></span><br><span class="line"><span class="comment">     * 3.不存在--&gt;没有在redis存放过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCar</span><span class="params">(AddCarDto addCarDto)</span> &#123;</span><br><span class="line">        BoundHashOperations&lt;Object, Object, Object&gt; ops = redisTemplate.boundHashOps(car_in_redis_prefix + addCarDto.getUserId());</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; values = ops.values();</span><br><span class="line">        <span class="comment">//当前key下面有存储的有数据</span></span><br><span class="line">        <span class="keyword">if</span> (values != <span class="literal">null</span> &amp;&amp; values.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//1.是否包含添加的skuid数据</span></span><br><span class="line">            <span class="comment">//获取当前的 大Key 下面的所有的小key</span></span><br><span class="line">            Set&lt;Object&gt; keys = ops.keys();</span><br><span class="line">            <span class="keyword">if</span> (keys.contains(addCarDto.getSkuId() + <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//取出数据在原来的基础上+1 shopCar</span></span><br><span class="line">                <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> (ShopCar) ops.get(addCarDto.getSkuId() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">                shopCar.setNum(shopCar.getNum() + <span class="number">1</span>);</span><br><span class="line">                <span class="comment">//把新的数据存放到redis 覆盖以前的数据</span></span><br><span class="line">                ops.put(addCarDto.getSkuId() + <span class="string">&quot;&quot;</span>, shopCar);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> getShopCar(addCarDto);</span><br><span class="line">                ops.put(shopCar.getSkuId() + <span class="string">&quot;&quot;</span>, shopCar);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//当有数据</span></span><br><span class="line">            <span class="comment">//1.去数据库前的key下面没查询当前用户的购物车数据,应该全部取出来</span></span><br><span class="line">            Wrapper&lt;ShopCar&gt; wrapper = <span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;&gt;();</span><br><span class="line">            wrapper.eq(<span class="string">&quot;user_id&quot;</span>, addCarDto.getUserId());</span><br><span class="line">            List&lt;ShopCar&gt; shopCars = selectList(wrapper);</span><br><span class="line">            <span class="comment">//2.取出来的数据id是否包含当前操作的skuid</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (shopCars != <span class="literal">null</span> &amp;&amp; shopCars.size() &gt; <span class="number">0</span>) &#123;<span class="comment">//3.如果包含--在原来的数量上+1</span></span><br><span class="line">                <span class="keyword">for</span> (ShopCar shopCar : shopCars) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (shopCar.getId().equals(addCarDto.getSkuId())) &#123;</span><br><span class="line">                        shopCar.setNum(shopCar.getNum() + <span class="number">1</span>);</span><br><span class="line">                        flag = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ops.put(shopCar.getSkuId() + <span class="string">&quot;&quot;</span>, shopCar);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//4.如果不包含--新加的一个数据</span></span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> getShopCar(addCarDto);</span><br><span class="line">                ops.put(shopCar.getSkuId() + <span class="string">&quot;&quot;</span>, shopCar);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//把数据同步到redis里面;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchDelete</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ShopCar <span class="title function_">getShopCar</span><span class="params">(AddCarDto addCarDto)</span> &#123;</span><br><span class="line">        <span class="comment">//3.如果没有添加过,根据skuid 获取对应的sku spu 租户等信息</span></span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> giftClient.get(addCarDto.getSkuId());</span><br><span class="line">        <span class="keyword">if</span> (!ajaxResult.getSuccess()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCode.RESPONSE_CODE_500);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.1 把AjaxResult里面的数据解析出来</span></span><br><span class="line">        <span class="type">GoodsSku</span> <span class="variable">goodsSku</span> <span class="operator">=</span> JSON.parseObject(JSON.toJSONString(ajaxResult.getData()), GoodsSku.class);</span><br><span class="line">        <span class="type">ShopCar</span> <span class="variable">shopCar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShopCar</span>();</span><br><span class="line">        shopCar.setSpuId(goodsSku.getSpuId());</span><br><span class="line">        shopCar.setSpuName(goodsSku.getSpuName());</span><br><span class="line">        shopCar.setSkuId(goodsSku.getId());</span><br><span class="line">        shopCar.setSkuInfo(goodsSku.getSkuName());</span><br><span class="line">        shopCar.setAddPrice(goodsSku.getPrice());</span><br><span class="line">        shopCar.setPrice(goodsSku.getPrice());</span><br><span class="line">        shopCar.setUserId(addCarDto.getUserId());</span><br><span class="line">        shopCar.setUsername(addCarDto.getUsername());</span><br><span class="line">        shopCar.setTenantId(goodsSku.getTenantId());</span><br><span class="line">        shopCar.setTenantName(goodsSku.getTenantName());</span><br><span class="line">        shopCar.setSelect(<span class="literal">true</span>);</span><br><span class="line">        shopCar.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        shopCar.setNum(addCarDto.getNum());</span><br><span class="line">        <span class="keyword">return</span> shopCar;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        1.查询redis的数据</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; <span class="title function_">selectCar</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">        <span class="comment">//使用大key去redis获取数据</span></span><br><span class="line">        BoundHashOperations&lt;Object, Object, ShopCar&gt; ops = redisTemplate.boundHashOps(car_in_redis_prefix + l);</span><br><span class="line">        <span class="comment">//获取大key下面的所有的value</span></span><br><span class="line">        List&lt;ShopCar&gt; shopCars = ops.values();</span><br><span class="line">        <span class="keyword">if</span> (shopCars == <span class="literal">null</span> || shopCars.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//没有获取到,从数据库里面查询</span></span><br><span class="line">            Wrapper&lt;ShopCar&gt; wrapper = <span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;&gt;();</span><br><span class="line">            wrapper.eq(<span class="string">&quot;user_id&quot;</span>, l);</span><br><span class="line">            shopCars = selectList(wrapper);</span><br><span class="line">            <span class="comment">//放到redis里面</span></span><br><span class="line">            shopCars.forEach(shopCar -&gt; &#123;</span><br><span class="line">                ops.put(shopCar.getSkuId() + <span class="string">&quot;&quot;</span>, shopCar);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            数据的组装</span></span><br><span class="line"><span class="comment">                同一个租户的数据是一个List</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            Map</span></span><br><span class="line"><span class="comment">                key        value</span></span><br><span class="line"><span class="comment">               租户的名字    List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">            店铺1(id,name)  List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">            店铺2(id,name)  List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">            店铺3(id,name)  List&lt;ShopCar&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        Map&lt;TenantIdName, List&lt;ShopCar&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">/* for (ShopCar shopCar : shopCars) &#123;</span></span><br><span class="line"><span class="comment">            TenantIdName tenantIdName = new TenantIdName(shopCar.getTenantId(),shopCar.getTenantName());</span></span><br><span class="line"><span class="comment">            //map里面key 包含 tenantIdName</span></span><br><span class="line"><span class="comment">            if (map.containsKey(tenantIdName))&#123;</span></span><br><span class="line"><span class="comment">                List&lt;ShopCar&gt; cars = map.get(tenantIdName);</span></span><br><span class="line"><span class="comment">                cars.add(shopCar);</span></span><br><span class="line"><span class="comment">            &#125;else &#123;//没有包含</span></span><br><span class="line"><span class="comment">                ArrayList&lt;ShopCar&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">                list.add(shopCar);</span></span><br><span class="line"><span class="comment">                List&lt;Object&gt; objects = Arrays.asList();</span></span><br><span class="line"><span class="comment">                map.put(tenantIdName,list);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        map = shopCars.stream().collect(Collectors.groupingBy(x -&gt;</span><br><span class="line">                                                              <span class="keyword">new</span> <span class="title class_">TenantIdName</span>(x.getTenantId(), x.getTenantName())</span><br><span class="line">                                                             ));</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis和数据库的同步逻辑:</span></span><br><span class="line"><span class="comment">     * 40W---&gt;20w(redis:20w-key * 10)--&gt;200w的数据</span></span><br><span class="line"><span class="comment">     * 效率会很低?</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * key 进行分组 20</span></span><br><span class="line"><span class="comment">     * 1.按照数据量分组 1-5组 5-10组 ...</span></span><br><span class="line"><span class="comment">     * 2.一致性hash原则分组  hash(key)%100 --2000个数据</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 策略模式 + 工厂方法</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 多线程 数据的同步</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//获取以指定的前缀开头的key</span></span><br><span class="line">        Set&lt;Object&gt; keys = redisTemplate.keys(car_in_redis_prefix + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Object&gt;&gt; keyMap = keys.stream().collect(Collectors.groupingBy(x -&gt; x.hashCode() % <span class="number">100</span> + <span class="string">&quot;&quot;</span>));</span><br><span class="line">        <span class="comment">//动态获取分组工厂策略</span></span><br><span class="line">        <span class="type">IKeysGroupStrategy</span> <span class="variable">strategy</span> <span class="operator">=</span> KeysGroupStrategyFactory.getInstance(keysGroupStrategy);</span><br><span class="line">        <span class="comment">//经过工厂处理以后的分组数据</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        stringListMap</span></span><br><span class="line"><span class="comment">        key(0 - 99) value</span></span><br><span class="line"><span class="comment">        85[&quot;car_in_redis_prefix:16&quot;, &quot;car_in_redis_prefix:19&quot;]</span></span><br><span class="line"><span class="comment">        86[&quot;car_in_redis_prefix:17&quot;]</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, List&lt;Object&gt;&gt; stringListMap = strategy.groupData(keys);</span><br><span class="line">        <span class="comment">//变量map</span></span><br><span class="line">        Set&lt;String&gt; mapKeySet = stringListMap.keySet();</span><br><span class="line">        Iterator&lt;String&gt; iterator = mapKeySet.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            List&lt;Object&gt; objects = stringListMap.get(iterator.next());</span><br><span class="line">            <span class="comment">//遍历list--&gt;redis里面具体的key</span></span><br><span class="line">            <span class="keyword">for</span> (Object object : objects) &#123;</span><br><span class="line">                <span class="comment">//根据大key获取数据</span></span><br><span class="line">                BoundHashOperations&lt;Object, String, ShopCar&gt; ops = redisTemplate.boundHashOps(object);</span><br><span class="line">                <span class="comment">//获取当前大Key下面所有的value</span></span><br><span class="line">                List&lt;ShopCar&gt; shopCars = ops.values();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*   同步这个list到数据库里面就OK了</span></span><br><span class="line"><span class="comment">                        1.redis有 mysql没有---&gt; mysql新增数据</span></span><br><span class="line"><span class="comment">                        2.redis有 mysql也有---&gt; 数据完全一致,数据部分不一致--&gt;全部更新</span></span><br><span class="line"><span class="comment">                        3.redis做了删除  mysql还有---&gt;把mysql的删除</span></span><br><span class="line"><span class="comment">                    解决方案:</span></span><br><span class="line"><span class="comment">                        对于以上 1 ,2的情况 mysql可以使用新增或者更新</span></span><br><span class="line"><span class="comment">                            insertOrUpdate--&gt;以主键为标准,如果数据有就更新数据,如果数据没有就新增数据</span></span><br><span class="line"><span class="comment">                            实现原理  ON DUPLICATE KEY UPDATE/ REPLACE INTO</span></span><br><span class="line"><span class="comment">                        对于情况3: 可以采用逻辑删除--&gt;</span></span><br><span class="line"><span class="comment">                                存储在redis里面的数据当用户删除的时候只是改变数据的状态 [展示的时候只是展示isDelete=0]</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">//1.筛选出shopCars 里面isDelete=1的数据的id---&gt;去数据库里面删除的</span></span><br><span class="line">                List&lt;Long&gt; deleteIds = shopCars.stream().filter(x -&gt; x.getIsDelete() == <span class="number">1</span>).map(ShopCar::getId).collect(Collectors.toList());</span><br><span class="line">                <span class="keyword">if</span> (deleteIds != <span class="literal">null</span> &amp;&amp; deleteIds.size() &gt; <span class="number">0</span>)</span><br><span class="line">                    <span class="built_in">super</span>.deleteBatchIds(deleteIds);</span><br><span class="line">                <span class="comment">//2.筛选出shopCars 里面isDelete=0的数据 --&gt;更新或者新增到数据库的</span></span><br><span class="line">                List&lt;ShopCar&gt; updateList = shopCars.stream().filter(x -&gt; x.getIsDelete() == <span class="number">0</span>).collect(Collectors.toList());</span><br><span class="line">                <span class="built_in">super</span>.insertOrUpdateBatch(updateList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在xxl-job中进行调用，数据同步：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mliutm.gift.xxljob;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mliutm.gift.service.IShopCarService;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: mliutm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2024年01月17日 16:52:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@describe</span>: 同步数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncData</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IShopCarService shopCarService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;syncData-mliutm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncData</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;数据同步开始！！&quot;</span>);</span><br><span class="line">        shopCarService.syncData();</span><br><span class="line">        System.out.println(<span class="string">&quot;数据同步结束！！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试：</strong></p><ul><li>先删除redis中已经有的购物车数据</li><li>重新添加购物车数据，此时添加的数据在redis中</li><li>启动xxl-job定时任务，同步redis中的数据到mysql中</li><li>查看数据是否同步成功</li></ul><h2 id="五-总结"><a href="#五-总结" class="headerlink" title="五 总结"></a>五 总结</h2><p>购物车就是他们crud</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/2602ce24.html">https://mliutm.github.io/breeze/2602ce24.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">任务调度</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1653549892896-dde02867edee.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/1e0bc9d2.html" title="蓉礼购-订单中心（七）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">蓉礼购-订单中心（七）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/8b290b57.html" title="蓉礼购-礼物上下架（五）"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">蓉礼购-礼物上下架（五）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/ecebeadb.html" title="BIO-NIO-AIO深入剖析"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">BIO-NIO-AIO深入剖析</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/ab319c68.html" title="SpringCloud-Alibaba快速入门"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">SpringCloud-Alibaba快速入门</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">167</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">78</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-text">购物车</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E8%B4%AD%E7%89%A9%E8%BD%A6%E9%9C%80%E6%B1%82"><span class="toc-text">一 购物车需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">二 购物车实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%B9%E6%A1%881%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%B9%E6%A1%88"><span class="toc-text">1 方案1：数据库方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%B9%E6%A1%882%EF%BC%9A-cookie-localstroge-%E6%95%B0%E6%8D%AE%E5%BA%93-%E4%B8%80%E8%88%AC%E4%B8%8D%E7%94%A8"><span class="toc-text">2 方案2： cookie&#x2F;localstroge+数据库(一般不用)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%B9%E6%A1%883-redis"><span class="toc-text">3 方案3:redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%96%B9%E6%A1%884-redis-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">4 方案4: redis+数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E6%96%B9%E6%A1%881%E5%AE%9E%E7%8E%B0"><span class="toc-text">三 方案1实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%B4%AD%E7%89%A9%E8%BD%A6%E8%AE%BE%E8%AE%A1"><span class="toc-text">1 购物车设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%95%8C%E9%9D%A2"><span class="toc-text">1 界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">3 流程设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%B4%AD%E7%89%A9%E8%BD%A6%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">2 购物车的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0"><span class="toc-text">1 添加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A0%E9%99%A4"><span class="toc-text">2 删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9"><span class="toc-text">3 修改</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-%E4%BF%AE%E6%94%B9%E6%95%B0%E7%9B%AE"><span class="toc-text">3.1 修改数目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-%E9%80%89%E4%B8%AD"><span class="toc-text">3.3 选中</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%88%97%E8%A1%A8"><span class="toc-text">4 列表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%96%B9%E6%A1%884%E5%AE%9E%E7%8E%B0"><span class="toc-text">四 方案4实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="toc-text">1 方案设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0"><span class="toc-text">2 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%90%AD%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.1 搭建微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-redis%E6%93%8D%E4%BD%9C"><span class="toc-text">2.2 redis操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5"><span class="toc-text">2.3 数据库同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%85%A5%E9%97%A8"><span class="toc-text">2.3.1 定时任务入门</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">2.3.1.1.什么是定时任务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-2-%E5%B8%B8%E8%A7%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%96%B9%E6%A1%88"><span class="toc-text">2.3.1.2.常见定时任务方案</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-3-quartz%E5%85%A5%E9%97%A8-%E5%8E%9F%E7%94%9F%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.3.1.3 quartz入门-原生实现</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-4-springboot-quartz"><span class="toc-text">2.3.1.4 springboot quartz</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-5-springboot-quartz-%E6%8C%81%E4%B9%85%E5%8C%96-%E5%9C%A8%E5%B7%B2%E7%BB%8F%E6%94%AF%E6%8C%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%8E%AF%E5%A2%83%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3.1.5 springboot quartz-持久化(在已经支持数据库的环境测试)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-Quartz%E5%AE%9E%E6%88%98"><span class="toc-text">2.3.2 Quartz实战</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-xxl-job-%E5%AE%9E%E6%88%98"><span class="toc-text">2.3.3 xxl-job 实战</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-3-1-%E6%90%AD%E5%BB%BAgift-basic-xxljob%E6%A8%A1%E5%9D%97"><span class="toc-text">2.3.3.1 搭建gift-basic-xxljob模块</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-3-2-%E4%BF%AE%E6%94%B9gift-shopcar-service%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.3.3.2 修改gift-shopcar-service服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-3-3-%E6%B3%A8%E5%86%8C%E5%88%B0%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83"><span class="toc-text">2.3.3.3 注册到调度中心</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86Redis%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5MySQL"><span class="toc-text">将Redis中的数据写入MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%80%BB%E7%BB%93"><span class="toc-text">五 总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/4edde71e.html" title="Vue2-3-Vue3状态管理Pinia（十一）"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Vue2-3-Vue3状态管理Pinia（十一）"></a><div class="content"><a class="title" href="/breeze/4edde71e.html" title="Vue2-3-Vue3状态管理Pinia（十一）">Vue2-3-Vue3状态管理Pinia（十一）</a><time datetime="2024-02-03T13:31:25.000Z" title="发表于 2024-02-03 21:31:25">2024-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/da043fa1.html" title="Vue2-3-大事件管理系统（十）"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Vue2-3-大事件管理系统（十）"></a><div class="content"><a class="title" href="/breeze/da043fa1.html" title="Vue2-3-大事件管理系统（十）">Vue2-3-大事件管理系统（十）</a><time datetime="2024-02-03T13:30:11.000Z" title="发表于 2024-02-03 21:30:11">2024-02-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>