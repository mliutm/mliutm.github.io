<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>学成在线-选课学习模块（六） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第6章 选课学习v3.11 模块需求分析1.1 模块介绍本模块实现了学生选课、下单支付、学习的整体流程。 网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。 选课：是将课程加入我的课程表的过程。 我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后"><meta property="og:type" content="article"><meta property="og:title" content="学成在线-选课学习模块（六）"><meta property="og:url" content="https://mliutm.github.io/breeze/24565a3e.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="第6章 选课学习v3.11 模块需求分析1.1 模块介绍本模块实现了学生选课、下单支付、学习的整体流程。 网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。 选课：是将课程加入我的课程表的过程。 我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><meta property="article:published_time" content="2023-10-30T05:00:33.000Z"><meta property="article:modified_time" content="2024-01-04T09:33:28.100Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/24565a3e.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"学成在线-选课学习模块（六）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-04 17:33:28"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线-选课学习模块（六）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-30T05:00:33.000Z" title="发表于 2023-10-30 13:00:33">2023-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-04T09:33:28.100Z" title="更新于 2024-01-04 17:33:28">2024-01-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">21.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>89分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="学成在线-选课学习模块（六）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="第6章-选课学习v3-1"><a href="#第6章-选课学习v3-1" class="headerlink" title="第6章 选课学习v3.1"></a><strong>第6章 选课学习v3.1</strong></h2><h3 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1 模块需求分析</strong></h3><h4 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1 模块介绍</strong></h4><p>本模块实现了学生选课、下单支付、学习的整体流程。</p><p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p><p>选课：是将课程加入我的课程表的过程。</p><p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p><p>模块整体流程如下：</p><p><img src="/breeze/24565a3e/image1.png"></p><h4 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2 业务流程</strong></h4><h5 id="1-2-1-学习引导"><a href="#1-2-1-学习引导" class="headerlink" title="1.2.1 学习引导"></a><strong>1.2.1 学习引导</strong></h5><p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p><p>流程如下：</p><p><img src="/breeze/24565a3e/image2.png"></p><p>1、进入课程详情点击马上学习</p><p><img src="/breeze/24565a3e/image3.png"></p><p>2、课程免费时引导加入我的课程表、或进入学习界面。</p><p><img src="/breeze/24565a3e/image4.png"></p><p>3、课程收费时引导去支付、或试学。</p><p><img src="/breeze/24565a3e/image5.png"></p><h5 id="1-2-2-选课流程"><a href="#1-2-2-选课流程" class="headerlink" title="1.2.2 选课流程"></a><strong>1.2.2 选课流程</strong></h5><p>选课是将课程加入我的课程表的过程。</p><p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p><p>流程如下：</p><p><img src="/breeze/24565a3e/image6.png"></p><h5 id="1-2-3-支付流程"><a href="#1-2-3-支付流程" class="headerlink" title="1.2.3 支付流程"></a><strong>1.2.3 支付流程</strong></h5><p>本项目与第三方支付平台对接完成支付操作。</p><p>流程如下：</p><p><img src="/breeze/24565a3e/image7.png"></p><h5 id="1-2-4-在线学习"><a href="#1-2-4-在线学习" class="headerlink" title="1.2.4 在线学习"></a><strong>1.2.4 在线学习</strong></h5><p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p><p>流程如下：</p><p><img src="/breeze/24565a3e/image8.png"></p><h5 id="1-2-5-免费课程续期"><a href="#1-2-5-免费课程续期" class="headerlink" title="1.2.5 免费课程续期"></a><strong>1.2.5 免费课程续期</strong></h5><p>免费课程加入我的课程表默认为1年有效期，到期用户可申请续期，流程如下：</p><p><img src="/breeze/24565a3e/image9.png"></p><h3 id="2-添加选课"><a href="#2-添加选课" class="headerlink" title="2 添加选课"></a><strong>2 添加选课</strong></h3><h4 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a><strong>2.1 需求分析</strong></h4><h5 id="2-1-1-数据模型"><a href="#2-1-1-数据模型" class="headerlink" title="2.1.1 数据模型"></a><strong>2.1.1 数据模型</strong></h5><p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p><p><img src="/breeze/24565a3e/image6-1690175549046-10.png"></p><p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p><p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p><p>1、选课记录表</p><p>当用户将课程添加到课程表时需要先创建选课记录。</p><p>结构如下：</p><p><img src="/breeze/24565a3e/image10.png"></p><p>选课类型：免费课程、收费课程。</p><p>选课状态：选课成功、待支付、选课删除。</p><p>对于免费课程：课程价格为0，有效期默认365，开始服务时间为选课时间，结束服务时间为选课时间加1年后的时间，选课状态为选课成功。</p><p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p><p>收费课程的选课记录需要支付成功后选课状态为成功。</p><p>2、我的课程表</p><p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p><p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p><p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p><p><img src="/breeze/24565a3e/image11.png"></p><h5 id="2-1-2-执行流程"><a href="#2-1-2-执行流程" class="headerlink" title="2.1.2 执行流程"></a><strong>2.1.2 执行流程</strong></h5><p>在学习引导处，可以直接将免费课程加入我的课程表，如下图：</p><p><img src="/breeze/24565a3e/image4-1690175555890-14.png"></p><p>对于收费课程先创建选课记录表，支付成功后，收到支付结果由系统自动加入我的课程表。</p><p>执行流程如下：</p><p><img src="/breeze/24565a3e/image12.png"></p><h4 id="2-2-接口开发"><a href="#2-2-接口开发" class="headerlink" title="2.2 接口开发"></a><strong>2.2 接口开发</strong></h4><h5 id="2-2-1-部署学习中心工程"><a href="#2-2-1-部署学习中心工程" class="headerlink" title="2.2.1 部署学习中心工程"></a><strong>2.2.1 部署学习中心工程</strong></h5><p>从课程资料拷贝学习中心服务工程到自己的工程目录，结构如下：</p><p><img src="/breeze/24565a3e/image13.png"></p><p>注意去修改nacos的命名空间。</p><p>创建数据库xc_learning，并导入数据</p><p>修改数据库的连接，改成自己的数据库。</p><p>nacos配置文件：learning-api-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/learning</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63020</span></span><br></pre></td></tr></table></figure><p>learning-service-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.101.65:3306/xc1010_learning?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure><h5 id="2-2-2-添加查询课程接口"><a href="#2-2-2-添加查询课程接口" class="headerlink" title="2.2.2 添加查询课程接口"></a><strong>2.2.2 添加查询课程接口</strong></h5><p>内容管理服务提供查询课程信息接口，此接口从课程发布表查询。</p><p>此接口主要提供其它微服务远程调用，所以此接口不用授权，本项目标记此类接口统一以 &#x2F;r开头。</p><p>在课程发布controller类中（CoursePublishController）定义课程发布信息查询接口。</p><blockquote><p><strong>分析：为什么在content服务的CoursePublishController中定义该接口？</strong></p><p>因为选课的时候，会涉及到收费课程和免费课程两类。这就需要在课程管理服务（content）中对课程进行查询；同时，在选课的时候，只能选择已发布的课程，所以在CoursePublishController类中定义该接口。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询课程发布信息&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/r/coursepublish/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据课程id查询课程发布信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishService.getCoursePublish(courseId);</span><br><span class="line">    <span class="keyword">return</span> coursePublish;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service如下：</p><p>如果课程发布状态正常则正常返回，否则返回空。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CoursePublish <span class="title function_">getCoursePublish</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">return</span> coursePublish;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>启动内容管理服务，使用httpclient测试</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 查询课程发布信息</span></span><br><span class="line">GET &#123;&#123;content_host&#125;&#125;/content/r/coursepublish/2</span><br></pre></td></tr></table></figure><p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理content-api工程的ResouceServerConfig类，屏蔽authenticated()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.csrf().disable()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        <span class="comment">//.antMatchers(&quot;/r/**&quot;,&quot;/course/**&quot;).authenticated()//所有/r/**的请求必须认证通过</span></span><br><span class="line">        .anyRequest().permitAll()</span><br><span class="line">        ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-2-3-测试查询课程信息接口"><a href="#2-2-3-测试查询课程信息接口" class="headerlink" title="2.2.3 测试查询课程信息接口"></a><strong>2.2.3 测试查询课程信息接口</strong></h5><p>学生中心服务远程调用内容管理服务的查询课程发布信息接口。</p><p>导入的学习中心工程已经存在ContentServiceClient 接口，通过此接口远程调用课程查询接口。</p><p>编写测试接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CoursePublish;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.feignclient.ContentServiceClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Assertions;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Feign接口测试类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/24 17:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ContentServiceClient contentServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testContentServiceClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(<span class="number">18L</span>);</span><br><span class="line">        Assertions.assertNotNull(coursepublish);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：<code>@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</code></strong></p><ul><li>在使用restful风格的接口调用时，不需要加如上注解。使用了base工程下的LocalDateTimeConfig类对LocalDateTime进行了相应转化。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jackson.Jackson2ObjectMapperBuilderCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 序列化内容</span></span><br><span class="line"><span class="comment">     *   LocalDateTime -&gt; String</span></span><br><span class="line"><span class="comment">     * 服务端返回给客户端内容</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocalDateTimeSerializer <span class="title function_">localDateTimeSerializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 反序列化内容</span></span><br><span class="line"><span class="comment">     *   String -&gt; LocalDateTime</span></span><br><span class="line"><span class="comment">     * 客户端传入服务端数据</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocalDateTimeDeserializer <span class="title function_">localDateTimeDeserializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title function_">jackson2ObjectMapperBuilderCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder -&gt; &#123;</span><br><span class="line">            builder.serializerByType(LocalDateTime.class, localDateTimeSerializer());</span><br><span class="line">            builder.deserializerByType(LocalDateTime.class, localDateTimeDeserializer());</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>但是使用feign进行远程调用的时候，必须加上该注解。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br></pre></td></tr></table></figure></blockquote><p>&#x3D;&#x3D;在进行feign远程调用时会将字符串转成LocalDateTime，在CoursePublish 类中LocalDateTime的属性上边添加如下代码：&#x3D;&#x3D;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br></pre></td></tr></table></figure><p>修改后的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.po;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 课程发布</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(&quot;course_publish&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublish</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上架时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime onlineDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下架时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING,pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime offlineDate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="2-2-4-添加选课接口"><a href="#2-2-4-添加选课接口" class="headerlink" title="2.2.4 添加选课接口"></a><strong>2.2.4 添加选课接口</strong></h5><h6 id="2-2-4-1-接口分析"><a href="#2-2-4-1-接口分析" class="headerlink" title="2.2.4.1 接口分析"></a><strong>2.2.4.1 接口分析</strong></h6><p>本接口支持免费课程选课、收费课程选课。</p><p>免费课程选课：添加选课记录、添加我的课程表。</p><p>收费课程选课：添加选课记录。</p><h6 id="2-2-4-2-接口定义"><a href="#2-2-4-2-接口定义" class="headerlink" title="2.2.4.2 接口定义"></a><strong>2.2.4.2 接口定义</strong></h6><p>1、请求参数：课程id、当前用户id</p><p>2、响应结果：选课记录信息、学习资格</p><p>学习资格：[{“code”:”702001”,”desc”:”正常学习”},{“code”:”702002”,”desc”:”没有选课或选课后没有支付”},{“code”:”702003”,”desc”:”已过期需要申请续期或重新支付”}]</p><p>接口定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.XcUser;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.util.SecurityUtil;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 我的课程表接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/2 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;我的课程表接口&quot;, tags = &quot;我的课程表接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCourseTablesController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加选课&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/choosecourse/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>  &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service接口定义：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.po.XcChooseCourse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.po.XcCourseTables;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 我的课程表service接口，选课相关的接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/2 16:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyCourseTablesService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 添加选课</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/24 17:33</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service接口执行流程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CoursePublish;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.feignclient.ContentServiceClient;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.mapper.XcChooseCourseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.mapper.XcCourseTablesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.po.XcChooseCourse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.po.XcCourseTables;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Mr.Huang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@projectName</span>: xuecheng-plus-project</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@packageName</span>: com.xuecheng.learning.service.impl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: MyCourseTablesServiceImpl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@describe</span>: 选课相关接口实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023年07月25日 12:05:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span>: 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCourseTablesServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MyCourseTablesService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XcChooseCourseMapper chooseCourseMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XcCourseTablesMapper courseTablesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注入远程调用内容管理</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ContentServiceClient contentServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 选课调用内容管理查询课程的收费规则</span></span><br><span class="line">        <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">        <span class="keyword">if</span> (coursepublish == <span class="literal">null</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取收费规则</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;201000&quot;</span>.equals(charge)) &#123;  <span class="comment">// 免费课程</span></span><br><span class="line">            <span class="comment">// 如果课程免费， 向选课记录表、我的课程表写数据</span></span><br><span class="line">            <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> addFreeCourse(userId, coursepublish);<span class="comment">// 向选课记录表写</span></span><br><span class="line">            <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTables(xcChooseCourse);    <span class="comment">// 向我的课程表写</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果课程收费，向选课记录表写数据</span></span><br><span class="line">            <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> addChargeCourse(userId, coursepublish);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断学生的学习资格</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-3-添加免费课程"><a href="#2-2-4-3-添加免费课程" class="headerlink" title="2.2.4.3 添加免费课程"></a><strong>2.2.4.3 添加免费课程</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addFreeCoruse</span><span class="params">(String userId, CoursePublish coursepublish)</span> &#123;</span><br><span class="line">    <span class="comment">//查询选课记录表是否存在免费的且选课成功的订单</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper = queryWrapper.eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">&quot;700001&quot;</span>)<span class="comment">//免费课程</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">&quot;701001&quot;</span>);<span class="comment">//选课成功</span></span><br><span class="line">    <span class="comment">// 这里对id没有进行唯一约束，所以可能查询出多条结果，用集合接收</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span> (xcChooseCourses != <span class="literal">null</span> &amp;&amp; xcChooseCourses.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果集合里面有（多条）数据，返回一个即可</span></span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//添加选课记录信息</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setCoursePrice(<span class="number">0f</span>);<span class="comment">//免费课程价格为0</span></span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">&quot;700001&quot;</span>);<span class="comment">//免费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">&quot;701001&quot;</span>);<span class="comment">//选课成功</span></span><br><span class="line"></span><br><span class="line">    xcChooseCourse.setValidDays(<span class="number">365</span>);<span class="comment">//免费课程默认365</span></span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(<span class="number">365</span>));</span><br><span class="line">    xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-4-添加我的课程表"><a href="#2-2-4-4-添加我的课程表" class="headerlink" title="2.2.4.4 添加我的课程表"></a><strong>2.2.4.4 添加我的课程表</strong></h6><p>我的课程表的记录来源于选课记录，选课记录成功将课程信息添加到我的课程表。</p><p>如果我的课程表已存在课程可能已经过期，如果有新的选课记录则需要更新我的课程表中的现有信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加到我的课程表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xcChooseCourse 选课记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.po.XcCourseTables</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/3 11:24</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> XcCourseTables <span class="title function_">addCourseTabls</span><span class="params">(XcChooseCourse xcChooseCourse)</span>&#123;</span><br><span class="line">        <span class="comment">//选课记录完成且未过期可以添加课程到课程表</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> xcChooseCourse.getStatus();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;701001&quot;</span>.equals(status))&#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;选课未成功，无法添加到课程表&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//查询我的课程表</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(xcChooseCourse.getUserId(), xcChooseCourse.getCourseId());</span><br><span class="line">        <span class="keyword">if</span>(xcCourseTables!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> xcCourseTables;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTablesNew</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcCourseTables</span>();</span><br><span class="line">        <span class="comment">// 这里可以使用BeanUtils进行拷贝，会节省很多代码</span></span><br><span class="line">        <span class="comment">// BeanUtils.copyProperties(xcCourseTables, xcCourseTablesNew);</span></span><br><span class="line">        <span class="comment">// 但是一定要注意：对于没有的属性要先拷贝在set</span></span><br><span class="line">        xcCourseTablesNew.setChooseCourseId(xcChooseCourse.getId());	<span class="comment">// 记录选课表的主键</span></span><br><span class="line">        xcCourseTablesNew.setUserId(xcChooseCourse.getUserId());</span><br><span class="line">        xcCourseTablesNew.setCourseId(xcChooseCourse.getCourseId());</span><br><span class="line">        xcCourseTablesNew.setCompanyId(xcChooseCourse.getCompanyId());</span><br><span class="line">        xcCourseTablesNew.setCourseName(xcChooseCourse.getCourseName());</span><br><span class="line">        xcCourseTablesNew.setCreateDate(LocalDateTime.now());</span><br><span class="line">        xcCourseTablesNew.setValidtimeStart(xcChooseCourse.getValidtimeStart());</span><br><span class="line">        xcCourseTablesNew.setValidtimeEnd(xcChooseCourse.getValidtimeEnd());</span><br><span class="line">        xcCourseTablesNew.setCourseType(xcChooseCourse.getOrderType());</span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> courseTablesMapper.insert(xcCourseTablesNew);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加到我的课程表失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesNew;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据课程和用户查询我的课程表中某一门课程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.learning.model.po.XcCourseTables</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/2 17:07</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> XcCourseTables <span class="title function_">getXcCourseTables</span><span class="params">(String userId,Long courseId)</span>&#123;</span><br><span class="line">        <span class="comment">// 因为这里的id使用了唯一约束，查询到的结果一定是唯一的，所以用selectOne</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> courseTablesMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcCourseTables&gt;().eq(XcCourseTables::getUserId, userId).eq(XcCourseTables::getCourseId, courseId));</span><br><span class="line">        <span class="keyword">return</span> xcCourseTables;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-5-添加收费课程"><a href="#2-2-4-5-添加收费课程" class="headerlink" title="2.2.4.5 添加收费课程"></a><strong>2.2.4.5 添加收费课程</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加收费课程</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourse <span class="title function_">addChargeCoruse</span><span class="params">(String userId,CoursePublish coursepublish)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果存在收费的选课记录且选课状态为待支付交易记录直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;XcChooseCourse&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper = queryWrapper.eq(XcChooseCourse::getUserId, userId)</span><br><span class="line">        .eq(XcChooseCourse::getCourseId, coursepublish.getId())</span><br><span class="line">        .eq(XcChooseCourse::getOrderType, <span class="string">&quot;700002&quot;</span>)<span class="comment">//收费订单</span></span><br><span class="line">        .eq(XcChooseCourse::getStatus, <span class="string">&quot;701002&quot;</span>);<span class="comment">//待支付</span></span><br><span class="line">    List&lt;XcChooseCourse&gt; xcChooseCourses = xcChooseCourseMapper.selectList(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span> (xcChooseCourses != <span class="literal">null</span> &amp;&amp; xcChooseCourses.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> xcChooseCourses.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">xcChooseCourse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourse</span>();</span><br><span class="line">    xcChooseCourse.setCourseId(coursepublish.getId());</span><br><span class="line">    xcChooseCourse.setCourseName(coursepublish.getName());</span><br><span class="line">    xcChooseCourse.setCoursePrice(coursepublish.getPrice());</span><br><span class="line">    xcChooseCourse.setUserId(userId);</span><br><span class="line">    xcChooseCourse.setCompanyId(coursepublish.getCompanyId());</span><br><span class="line">    xcChooseCourse.setOrderType(<span class="string">&quot;700002&quot;</span>);<span class="comment">//收费课程</span></span><br><span class="line">    xcChooseCourse.setCreateDate(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setStatus(<span class="string">&quot;701002&quot;</span>);<span class="comment">//待支付</span></span><br><span class="line"></span><br><span class="line">    xcChooseCourse.setValidDays(coursepublish.getValidDays());</span><br><span class="line">    xcChooseCourse.setValidtimeStart(LocalDateTime.now());</span><br><span class="line">    xcChooseCourse.setValidtimeEnd(LocalDateTime.now().plusDays(coursepublish.getValidDays()));</span><br><span class="line">    xcChooseCourseMapper.insert(xcChooseCourse);</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-6-获取学习资格"><a href="#2-2-4-6-获取学习资格" class="headerlink" title="2.2.4.6 获取学习资格"></a><strong>2.2.4.6 获取学习资格</strong></h6><p>定义获取学习资格接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyCourseTablesService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 判断学习资格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> XcCourseTablesDto 学习资格状态 [&#123;&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;&#125;,&#123;&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;&#125;,&#123;&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;&#125;]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/10/3 7:37</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 判断学习资格</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> XcCourseTablesDto 学习资格状态 [&#123;&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;&#125;,&#123;&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;&#125;,&#123;&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;&#125;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/3 7:37</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearningStatus</span><span class="params">(String userId, Long courseId)</span>&#123;</span><br><span class="line">    <span class="comment">//查询我的课程表</span></span><br><span class="line">    <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> getXcCourseTables(userId, courseId);</span><br><span class="line">    <span class="keyword">if</span>(xcCourseTables==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcCourseTablesDto</span>();</span><br><span class="line">        <span class="comment">//没有选课或选课后没有支付</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">&quot;702002&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcCourseTablesDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(xcCourseTables,xcCourseTablesDto);</span><br><span class="line">    <span class="comment">//是否过期,true过期，false未过期</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isExpires</span> <span class="operator">=</span> xcCourseTables.getValidtimeEnd().isBefore(LocalDateTime.now());</span><br><span class="line">    <span class="keyword">if</span>(!isExpires)&#123;</span><br><span class="line">        <span class="comment">//正常学习</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">&quot;702001&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//已过期</span></span><br><span class="line">        xcCourseTablesDto.setLearnStatus(<span class="string">&quot;702003&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> xcCourseTablesDto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-7-service接口完善"><a href="#2-2-4-7-service接口完善" class="headerlink" title="2.2.4.7 service接口完善"></a><strong>2.2.4.7 service接口完善</strong></h6><p>完善Service接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(String userId, Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">    <span class="comment">//课程收费标准</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">    <span class="comment">//选课记录</span></span><br><span class="line">    <span class="type">XcChooseCourse</span> <span class="variable">chooseCourse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;201000&quot;</span>.equals(charge)) &#123;<span class="comment">//课程免费</span></span><br><span class="line">        <span class="comment">//添加免费课程</span></span><br><span class="line">        chooseCourse = addFreeCoruse(userId, coursepublish);</span><br><span class="line">        <span class="comment">//添加到我的课程表</span></span><br><span class="line">        <span class="type">XcCourseTables</span> <span class="variable">xcCourseTables</span> <span class="operator">=</span> addCourseTabls(chooseCourse);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//添加收费课程</span></span><br><span class="line">        chooseCourse = addChargeCoruse(userId, coursepublish);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">XcChooseCourseDto</span> <span class="variable">xcChooseCourseDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcChooseCourseDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(chooseCourse,xcChooseCourseDto);</span><br><span class="line">    <span class="comment">//获取学习资格</span></span><br><span class="line">    <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> getLearningStatus(userId, courseId);</span><br><span class="line">    xcChooseCourseDto.setLearnStatus(xcCourseTablesDto.getLearnStatus());</span><br><span class="line">    <span class="keyword">return</span> xcChooseCourseDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="2-2-4-8-完善controller"><a href="#2-2-4-8-完善controller" class="headerlink" title="2.2.4.8 完善controller"></a><strong>2.2.4.8 完善controller</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MyCourseTablesService courseTablesService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;添加选课&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/choosecourse/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> XcChooseCourseDto <span class="title function_">addChooseCourse</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//获取登录用户（由用户选课）</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请登录后继续选课&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="keyword">return</span>  courseTablesService.addChooseCourse(userId, courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询学习资格&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/choosecourse/learnstatus/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> XcCourseTablesDto <span class="title function_">getLearnstatus</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请登录后继续选课&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="keyword">return</span>  courseTablesService.getLearningStatus(userId, courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-接口测试"><a href="#2-3-接口测试" class="headerlink" title="2.3 接口测试"></a><strong>2.3 接口测试</strong></h4><h5 id="2-3-1-单元测试"><a href="#2-3-1-单元测试" class="headerlink" title="2.3.1 单元测试"></a><strong>2.3.1 单元测试</strong></h5><p>1、准备测试环境</p><p>发布两门课程，一门为免费，一门为收费。</p><p>小技巧：可以更改课程发布表已有课程的收费标准进行测试。</p><p>2、测试添加免费课程</p><p>成功：选课记录表一条记录、我的课程表一条记录。</p><p>3、测试添加收费课程</p><p>成功：选课记录表一条记录</p><p>4、重复添加选课</p><p>重复添加相同的课程，观察是否存在异常。</p><p>5、生成令牌，为方便生成令牌暂时将PasswordAuthServiceImpl类中的验证码屏蔽</p><p>6、使用httpclient测试如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 添加选课</span></span><br><span class="line">POST &#123;&#123;learning_host&#125;&#125;/learning/choosecourse/2</span><br><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltcInhjX3N5c21hbmFnZXJcIixcInhjX3N5c21hbmFnZXJfdXNlclwiLFwieGNfc3lzbWFuYWdlcl91c2VyX2FkZFwiLFwieGNfc3lzbWFuYWdlcl91c2VyX2VkaXRcIixcInhjX3N5c21hbmFnZXJfdXNlcl92aWV3XCIsXCJ4Y19zeXNtYW5hZ2VyX3VzZXJfZGVsZXRlXCIsXCJ4Y19zeXNtYW5hZ2VyX2RvY1wiLFwieGNfc3lzbWFuYWdlcl9sb2dcIixcInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VcIixcInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfYWRkXCIsXCJ4Y190ZWFjaG1hbmFnZXJfY291cnNlX2Jhc2VcIixcInhjX3N5c21hbmFnZXJfY29tcGFueVwiLFwieGNfdGVhY2htYW5hZ2VyX2NvdXJzZV9saXN0XCJdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS54dWVjaGVuZy1wbHVzLmNvbS9kZGRmXCIsXCJ1dHlwZVwiOlwiMTAxMDAxXCJ9Iiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NzI5OTQwNiwiYXV0aG9yaXRpZXMiOlsieGNfc3lzbWFuYWdlcl9kb2MiLCJ4Y19zeXNtYW5hZ2VyX3VzZXJfdmlldyIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2UiLCJ4Y19zeXNtYW5hZ2VyX3VzZXJfYWRkIiwieGNfc3lzbWFuYWdlcl9jb21wYW55IiwieGNfc3lzbWFuYWdlcl91c2VyX2RlbGV0ZSIsInhjX3N5c21hbmFnZXJfdXNlciIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfYmFzZSIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfbGlzdCIsInhjX3N5c21hbmFnZXIiLCJ4Y19zeXNtYW5hZ2VyX2xvZyIsInhjX3N5c21hbmFnZXJfdXNlcl9lZGl0IiwieGNfdGVhY2htYW5hZ2VyX2NvdXJzZV9hZGQiXSwianRpIjoiOTYyOTYzMWQtYjRiMC00NTlkLTgzYzktM2Q4MmRiNmI4NDEzIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.b77ZreiNlPoN-_dnAWxuBfH32tPIoRwg2ePgKn_aZ8c</span><br></pre></td></tr></table></figure><h5 id="2-3-2-前后端联调"><a href="#2-3-2-前后端联调" class="headerlink" title="2.3.2 前后端联调"></a><strong>2.3.2 前后端联调</strong></h5><p>测试流程：</p><p>1、启动认证服务、网关服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门免费课程、一门收费课程</p><p>3、进入课程详情界面，点击“马上学习”</p><p>4、报名成功，自动跳转到学习界面。</p><p>5、观察选课记录表、我的课程表数据是否正确。</p><p>对于免费课程在课程详情页面点击“马上学习”，通过引导界面添加选课。</p><p>1、进入课程详情点击马上学习</p><p><img src="/breeze/24565a3e/image3-1690175565921-18.png"></p><p>2、课程免费时引导加入我的课程表、或进入学习界面。</p><p><img src="/breeze/24565a3e/image4-1690175568804-20.png"></p><h3 id="3-支付"><a href="#3-支付" class="headerlink" title="3 支付"></a><strong>3 支付</strong></h3><h4 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a><strong>3.1 需求分析</strong></h4><h5 id="3-1-1-执行流程"><a href="#3-1-1-执行流程" class="headerlink" title="3.1.1 执行流程"></a><strong>3.1.1 执行流程</strong></h5><p>用户去学习收费课程时引导其去支付，如下图：</p><p><img src="/breeze/24565a3e/image5-1690175570343-22.png"></p><p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p><p><img src="/breeze/24565a3e/image14.png"></p><p>1、请求学习中心服务创建选课记录</p><p>2、请求订单服务创建商品订单、生成支付二维码。</p><p>3、用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。</p><p>4、前端唤起支付客户端，用户输入密码完成支付。</p><p>5、第三方支付平台支付完成发起支付通知。</p><p>6、订单支付服务接收第三方支付通知结果。</p><p>7、用户在前端查询支付结果，请求订单支付服务查询支付结果。</p><p>8、订单支付服务向学习中心服务通知支付结果。</p><p>9、学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表。</p><h5 id="3-1-2-通用订单服务设计"><a href="#3-1-2-通用订单服务设计" class="headerlink" title="3.1.2 通用订单服务设计"></a><strong>3.1.2 通用订单服务设计</strong></h5><p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p><p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p><p><img src="/breeze/24565a3e/image15.png"></p><p>所有收费业务最终转换为商品订单记录在订单服务的商品订单表。</p><p><img src="/breeze/24565a3e/image16.png"></p><p>以选课为例，选课记录表的ID记录在商品订单表的out_business_id字段。</p><p><img src="/breeze/24565a3e/image17.png"></p><h4 id="3-2-支付接口调研"><a href="#3-2-支付接口调研" class="headerlink" title="3.2 支付接口调研"></a><strong>3.2 支付接口调研</strong></h4><h5 id="3-2-1-微信支付接口调研"><a href="#3-2-1-微信支付接口调研" class="headerlink" title="3.2.1 微信支付接口调研"></a><strong>3.2.1 微信支付接口调研</strong></h5><p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p><p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p><p>微信目前提供的支付方式如下：</p><p>地址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p><p><img src="/breeze/24565a3e/image18.png"></p><p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p><p><img src="/breeze/24565a3e/image19.png"></p><p>2、JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款</p><p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p><p>PC网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><p><img src="/breeze/24565a3e/image20.png"></p><p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p><p><img src="/breeze/24565a3e/image21.png"></p><p>4、Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p><p><img src="/breeze/24565a3e/image22.png"></p><p>5、APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p><p><img src="/breeze/24565a3e/image23.png"></p><p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p><p><img src="/breeze/24565a3e/image24.png"></p><p>&#x3D;&#x3D;以上接口native和JSAPI都可以实现pc网站实现扫码支付，两者区别是什么？怎么选择？&#x3D;&#x3D;</p><p>JSAPI除了在pc网站扫码支付还可以实现公众号页面内支付，可以实现在手机端H5页面唤起微信客户端完成支付。</p><p>本项目选择JSAPI支付接口。</p><p>接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</a></p><p>&#x3D;&#x3D;如何开通JSAPI支付接口?&#x3D;&#x3D;</p><p>以企业身份注册微信公众号<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p><p><img src="/breeze/24565a3e/image25.png"></p><p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p><p>需要提供营业执照、身份证等信息。</p><p><img src="/breeze/24565a3e/image26.png"></p><p>点击申请接入，需要注册微信商户号。</p><p><img src="/breeze/24565a3e/image27.png"></p><p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p><p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none</a></p><p>开通微信支付后即可在微信商户平台（pay.weixin.qq.com）开通JSAPI支付。</p><p>登录商品平台，进入产品中心，开通JSAPI支付：</p><p><img src="/breeze/24565a3e/image28.png"></p><p>注意：JSAPI支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p><p>最后在公众号开发信息中获取：开发者id、开发者密码。</p><h5 id="3-2-2-支付宝接口调研"><a href="#3-2-2-支付宝接口调研" class="headerlink" title="3.2.2 支付宝接口调研"></a><strong>3.2.2 支付宝接口调研</strong></h5><p>支付宝支付产品如下：</p><p>文档：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productSetV2.htm">https://b.alipay.com/signing/productSetV2.htm</a></p><p><img src="/breeze/24565a3e/image29.png"></p><p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p><p>1、电脑网站支付</p><p>PC网站轻松收款，资金马上到账：用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p><p><img src="/breeze/24565a3e/image30.png"></p><p>2、手机网站支付</p><p>用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验。</p><p><img src="/breeze/24565a3e/image31.png"></p><p>对比两种支付方式：手机网站支付方式可以在H5网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p><p>本项目选择手机网站支付方式。</p><p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p><p>&#x3D;&#x3D;如何开通支付宝手机网站支付接口？&#x3D;&#x3D;</p><p>进入网址：<a target="_blank" rel="noopener" href="https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001">https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</a></p><p>点击：立即开通</p><p>上传营业执照等资料，提交审核，根据提示进行开通。</p><p><img src="/breeze/24565a3e/image32.png"></p><h4 id="3-3-准备开发环境"><a href="#3-3-准备开发环境" class="headerlink" title="3.3 准备开发环境"></a><strong>3.3 准备开发环境</strong></h4><h5 id="3-3-1-支付宝开发环境"><a href="#3-3-1-支付宝开发环境" class="headerlink" title="3.3.1 支付宝开发环境"></a><strong>3.3.1 支付宝开发环境</strong></h5><p>第三方支付接口流程大同小异，考虑开发及教学的方便性，支付宝提供支付宝沙箱环境开发支付接口，在教学中接入支付宝手机网站支付接口。</p><p>1、配置沙箱环境</p><p>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。</p><p>接入手机网站支付需要具备如下条件：</p><p>申请前必须拥有经过实名认证的支付宝账户；</p><p>企业或个体工商户可申请；</p><p>需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；</p><p>网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；</p><p>网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；</p><p>如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。</p><p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203">https://docs.open.alipay.com/203</a></p><p>本文档使用支付宝沙箱进行开发测试，这里主要介绍支付宝沙箱环境配置。</p><p>详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/200/105311/">https://docs.open.alipay.com/200/105311/</a></p><p>2、模拟器</p><p>下载模拟器：<a target="_blank" rel="noopener" href="http://mumu.163.com/">http://mumu.163.com/</a></p><p>安装模拟器，安装在没有空格和中文的目录。</p><p>安装成功，启动模拟器</p><p><img src="/breeze/24565a3e/image33.png"></p><p>下一步在模拟器安装支付宝：</p><p>选择课程资料中支付宝安装包wallet_101521226_client_release_201812261416.apk（沙箱版本）</p><p><img src="/breeze/24565a3e/image34.png"></p><p>安装成功后支付宝客户端的快捷方式出现在桌面上。</p><p><img src="/breeze/24565a3e/image35.png"></p><p>使用沙箱环境的买家账号登录沙箱版本的支付宝。</p><p>查看沙箱环境的账号：</p><p><img src="/breeze/24565a3e/image36.png"></p><h5 id="3-3-2-创建订单服务"><a href="#3-3-2-创建订单服务" class="headerlink" title="3.3.2 创建订单服务"></a><strong>3.3.2 创建订单服务</strong></h5><p>拷贝课程资料目录下的订单服务工程xuecheng-plus-orders到自己的工程目录。</p><p><img src="/breeze/24565a3e/image37.png"></p><p>创建xc_orders数据库，并导入xcplus_orders.sql</p><p>修改nacos中orders-service-dev.yaml的数据库连接参数。</p><h4 id="3-4-支付接口测试"><a href="#3-4-支付接口测试" class="headerlink" title="3.4 支付接口测试"></a><strong>3.4 支付接口测试</strong></h4><h5 id="3-4-1-阅读接口定义"><a href="#3-4-1-阅读接口定义" class="headerlink" title="3.4.1 阅读接口定义"></a><strong>3.4.1 阅读接口定义</strong></h5><p>手机网站支付接入流程详细参见：<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105285/">https://docs.open.alipay.com/203/105285/</a></p><p>1、接口交互流程如下：</p><p><img src="/breeze/24565a3e/image38.png"></p><p>1）用户在商户的H5网站下单支付后，商户系统按照<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090">手机网站支付接口alipay.trade.wap.pay</a>API的参数规范生成订单数据</p><p>2）前端页面通过Form表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝H5收银台页面，如果用户手机上安装了支付宝APP，则自动唤起支付宝APP。</p><p>3）输入支付密码完成支付。</p><p>4）用户在支付宝APP或H5收银台完成支付后，会根据商户在手机网站支付API中传入的前台回跳地址return_url自动跳转回商户页面，同时在URL请求中以Query String的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口alipay.trade.wap.pay”<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/107090#s2">前台回跳参数</a>。</p><p>5）支付宝还会根据原始支付API中传入的异步通知地址notify_url，通过POST请求的形式将支付结果作为参数通知到商户系统，详情见<a target="_blank" rel="noopener" href="https://docs.open.alipay.com/203/105286">支付结果异步通知</a>。</p><p>2、接口定义</p><p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p><p>接口定义：外部商户请求支付宝创建订单并支付</p><p>公共参数</p><p><strong>请求地址</strong>：</p><p>开发中使用沙箱地址：<a target="_blank" rel="noopener" href="https://openapi.alipaydev.com/gateway.do">https://openapi.alipaydev.com/gateway.do</a></p><p>请求参数：</p><p>详细查阅<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/107090">https://opendocs.alipay.com/open/203/107090</a></p><p>一部分由sdk设置，一部分需要编写程序时指定。</p><p><img src="/breeze/24565a3e/image39.png"></p><p><img src="/breeze/24565a3e/image40.png"></p><p><img src="/breeze/24565a3e/image41.png"></p><p><img src="/breeze/24565a3e/image42.png"></p><p>其它扩展参数参见接口文档。</p><p>3、示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                   HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> ... <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    alipayRequest.setReturnUrl(<span class="string">&quot;http://domain.com/CallBack/return_url.jsp&quot;</span>);</span><br><span class="line">    alipayRequest.setNotifyUrl(<span class="string">&quot;http://domain.com/CallBack/notify_url.jsp&quot;</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;    \&quot;out_trade_no\&quot;:\&quot;20150320010101002\&quot;,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;    \&quot;total_amount\&quot;:88.88,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +</span><br><span class="line">                                <span class="string">&quot;  &#125;&quot;</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayServiceEnvConstants.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-4-2-下单执行流程"><a href="#3-4-2-下单执行流程" class="headerlink" title="3.4.2 下单执行流程"></a><strong>3.4.2 下单执行流程</strong></h5><p>根据接口描述，支付宝下单接口的执行流程如下：</p><p><img src="/breeze/24565a3e/image43.png"></p><h5 id="3-4-3-支付接口测试"><a href="#3-4-3-支付接口测试" class="headerlink" title="3.4.3 支付接口测试"></a><strong>3.4.3 支付接口测试</strong></h5><h6 id="3-4-3-1-编写下单代码"><a href="#3-4-3-1-编写下单代码" class="headerlink" title="3.4.3.1 编写下单代码"></a><strong>3.4.3.1 编写下单代码</strong></h6><p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口。</p><p>在订单服务api工程添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 支付宝SDK --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.73.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>下载示例代码<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p><p>拷贝示例代码，修改、测试。</p><p>拷贝AlipayConfig.java到订单服务的service工程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeWapPayRequest;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.orders.config.AlipayConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试支付宝接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/20 22:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过Response的方式响应数据的，并没有返回json格式的数据给前端，所以用@Controller</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/alipaytest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                       HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException, AlipayApiException &#123;</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY,AlipayConfig.SIGNTYPE);</span><br><span class="line">        <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span></span><br><span class="line">        <span class="comment">//        alipayRequest.setNotifyUrl(&quot;http://domain.com/CallBack/notify_url.jsp&quot;);//在公共参数中设置回跳和通知地址</span></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;    \&quot;out_trade_no\&quot;:\&quot;202210100010101002\&quot;,&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;    \&quot;total_amount\&quot;:0.1,&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> +</span><br><span class="line">                                    <span class="string">&quot;  &#125;&quot;</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">        httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET);</span><br><span class="line">        httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">        httpResponse.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在nacos中配置支付参数(顶格配置)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pay:</span></span><br><span class="line">  <span class="attr">alipay:</span></span><br><span class="line">    <span class="attr">APP_ID:</span> <span class="number">9021000123615440</span></span><br><span class="line">    <span class="attr">APP_PRIVATE_KEY:</span> <span class="string">MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCBMCj7EnLu6/H4n37Uyf6qBrhLUNKXK7JKoQuGgeY7ltyMO+Ok/nOarGl1d9d3NAFHK03aGXMZ/8ynWQ4fdOu778ckV+d+1+pHVi0F7+/DLQUZI1GUuCAuOF40FAwakYJtbVXMaCiAy/N9fIjmA6AQLsP+UaX8qQ4KAFJgJUFg6tsr4ln0C95wNJrh5AAUyIoQ/gCYxuWmPEZREv6M+f+cnSuX9NrbxUsLV3aidmCdK/sJ7wxw9/N4tMtzGfqIkDKYoTg/8WQMg3ep2pEazILye8K3/AAj0NYNTqV0BRosVEYJb5i8zCa4PPSBjm6O9+MzB1buUvpPri4mFbou38hVAgMBAAECggEAGI436+lI0WMlvjVK3VV7w4O9egtly/gxToAn+awtP/xf9YPYtF7tSGQnM33RBcZry8ROavtVZoa5tsF1rsMBn9pmxuCyjuipjl+x9SPzNe0TwAB3nEYXT9HFDi8VUeOAoB4dJdpSgJDDuoF2YAomXY0WEfwhCdJ0abA/+Ch8sdgMOz3hxBsni7EvaTRiaNDEMJclNr6xIc4S/dH9RHyUyjhJtxuy30l6H4eMhWmzaCUFSLpDvmQwh1tiDEVp7xJcf8T8ns8bkdTzj7THda+heBU8dKtp+NglG589ItaVM/9QdhwKyPzwy/71s2CQwOJ/MMVNy4wuOAru5Fvol4l+DQKBgQDWKwEb5sFUWy0ohLEClEm9K4Ud2q/0bJrXcn4Bf8ZVDnnPaVFMcW5ZvF6igtApl7Wkq+cK45J86mXe0zLKsJJCTLC4HmUrGVUWBcuqxrhlAmBTuUtwZ4vLE6tYuQqATDE4agOXkVGnN2aQyhdRvrokRMl7PdYZHHwE/Ju6k2pQnwKBgQCaa+0UVZHQ/DWZ+lA951kRtpwX08XFAqc7iTb84Jwj6UIgNQWK3EP3RJ8FYmn2yHWBrDxmkOlw+bVCKel7/p8GGSYRcv7oeYKm15JhMQRpvBlzG2GSbBlaY0gpkQpsnGlozCaBGOgEYqdLJtLzb4ZEhnNRxtjzm9uFOR6m0bC+iwKBgQCSzA1Ji6SuZoSQhksyImRcxszKhtAecKa90FtwOZ2/RVnXAjBYflOOLKCNMa7vI268/ZszCoOpHZ1P22GwLtFBooFq4mKj5Qw+OSC94NIZYkSWfqan2EGoo8XJ3aPGBvOh4ICvzkqynDWwPuU3Ac1i+MdFsz/iHHUhkehIPa0crwKBgQCL6gXhSrbX1+zpGrfhnuBBAGfl3uduXb0QYH8GGKzgjNRxQhlHe9PJEs/SnRzNkUuGtnvzopEg39+vlzIKOuXzLI4leUAlexM6AFCM51DMTLXyaXi6pl9CWnpjzxrW1dFcNr0cc2ilsI1Ltl2kXAQXyopqKfUgpLL9vodbNtshiQKBgBbadUNwrumpzxkFXBsI6YwyWT3Epdxx1gyf3ZBUe3aZ+BwmeZP2nJJESvvGcLN8kD0BxxhQ3nrbC4I0j6QkJDVJxtP9mgm68dW9zK6lLEdnnuOSFMDXcEa1uqHdVkZeFpmkNU6gko0DW9gL4IfvhFdA/MlndhwUc3pVph2HlTrX</span></span><br><span class="line">    <span class="attr">APP_PUBLIC_KEY:</span> <span class="string">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgTAo+xJy7uvx+J9+1Mn+qga4S1DSlyuySqELhoHmO5bcjDvjpP5zmqxpdXfXdzQBRytN2hlzGf/Mp1kOH3Tru+/HJFfnftfqR1YtBe/vwy0FGSNRlLggLjheNBQMGpGCbW1VzGgogMvzfXyI5gOgEC7D/lGl/KkOCgBSYCVBYOrbK+JZ9AvecDSa4eQAFMiKEP4AmMblpjxGURL+jPn/nJ0rl/Ta28VLC1d2onZgnSv7Ce8McPfzeLTLcxn6iJAymKE4P/FkDIN3qdqRGsyC8nvCt/wAI9DWDU6ldAUaLFRGCW+YvMwmuDz0gY5ujvfjMwdW7lL6T64uJhW6Lt/IVQIDAQAB</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="3-4-3-2-生成二维码"><a href="#3-4-3-2-生成二维码" class="headerlink" title="3.4.3.2 生成二维码"></a><strong>3.4.3.2 生成二维码</strong></h6><p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p><p>ZXing是一个开源的类库，是用Java编写的多格式的1D &#x2F; 2D条码图像处理库，使用ZXing可以生成、识别QR Code（二维码）。常用的二维码处理库还有zbar，近几年已经不再更新代码，下边介绍ZXing生成二维码的方法。</p><p>1）引入依赖</p><p>在base工程pom.xml中添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）生成二维码方法</p><p>拷贝课程资料中utils下的QRCodeUtil.java到base工程util包下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.zxing.BarcodeFormat;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.EncodeHintType;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.client.j2se.MatrixToImageWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.common.BitMatrix;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.QRCodeWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 二维码生成工具</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/3 0:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QRCodeUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成二维码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 二维码对应的URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width   二维码图片宽度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height  二维码图片高度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createQRCode</span><span class="params">(String content, <span class="type">int</span> width, <span class="type">int</span> height)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resultImage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//除了尺寸，传入内容不能为空</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(content)) &#123;</span><br><span class="line">            <span class="type">ServletOutputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="comment">//二维码参数</span></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">            HashMap&lt;EncodeHintType, Comparable&gt; hints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">//指定字符编码为“utf-8”</span></span><br><span class="line">            hints.put(EncodeHintType.CHARACTER_SET, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="comment">//L M Q H四个纠错等级从低到高，指定二维码的纠错等级为M</span></span><br><span class="line">            <span class="comment">//纠错级别越高，可以修正的错误就越多，需要的纠错码的数量也变多，相应的二维吗可储存的数据就会减少</span></span><br><span class="line">            hints.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.M);</span><br><span class="line">            <span class="comment">//设置图片的边距</span></span><br><span class="line">            hints.put(EncodeHintType.MARGIN, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//zxing生成二维码核心类</span></span><br><span class="line">                <span class="type">QRCodeWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeWriter</span>();</span><br><span class="line">                <span class="comment">//把输入文本按照指定规则转成二维吗</span></span><br><span class="line">                <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> writer.encode(content, BarcodeFormat.QR_CODE, width, height, hints);</span><br><span class="line">                <span class="comment">//生成二维码图片流</span></span><br><span class="line">                <span class="type">BufferedImage</span> <span class="variable">bufferedImage</span> <span class="operator">=</span> MatrixToImageWriter.toBufferedImage(bitMatrix);</span><br><span class="line">                <span class="comment">//输出流</span></span><br><span class="line">                ImageIO.write(bufferedImage, <span class="string">&quot;png&quot;</span>, os);</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 原生转码前面没有 data:image/png;base64 这些字段，返回给前端是无法被解析，所以加上前缀</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                resultImage = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;data:image/png;base64,&quot;</span> + EncryptUtil.encodeBase64(os.toByteArray()));</span><br><span class="line">                <span class="keyword">return</span> resultImage;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;生成二维码出错&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    stream.flush();</span><br><span class="line">                    stream.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 会生成一个字符串，将该字符串在浏览器打开会得到一个二维码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">        System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://www.itcast.cn/&quot;</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试根据内容生成二维码方法，在QRCodeUtil中添加main方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://www.itcast.cn/&quot;</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行main方法输入二维码图片的base64串，如下：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABQElEQVR42u2YPZKDMAyF5aFIuUfIUThafDSOwhEoUzC8fZKMySSbrVI8ZuICBX8uIvtZPxjeDfuSf8liPi7LFSgrzRTvV3XCKawXYLptFobviz6ZzB2xEfTjhyS9OwXB3A7jbMSngLOQ0I4v2AZf96wqTWJ9+9/dYEHSx2RYqfg/oqUgiX3nFBVfcCepcSbiJP67iwZ1G+5+Am7kyTzW9OcW/kRAX+QJ953+uCl8zO5PV5UsaffUp8rqP5+jiySJU8jtNxcNrysetCNK6A/V4lEQeU+xa0eZREE1tOTpFYod0VKXsKCqvRqMkW5pkza8Ggy3WgEuTvZcz0dcUBc+9MneL1DqkXjQz0eaZA1LqVtmzcMffTKPiPwz1mh2zkGyNwtT9kguTVI7LWv6ul7DCpOjX9iaGV66HDny/ZL1WfILfc/hMHLUpekAAAAASUVORK5CYII=xxxxxxxxxx3 1运行main方法输入二维码图片的base64串，如下：Bash2data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABQElEQVR42u2YPZKDMAyF5aFIuUfIUThafDSOwhEoUzC8fZKMySSbrVI8ZuICBX8uIvtZPxjeDfuSf8liPi7LFSgrzRTvV3XCKawXYLptFobviz6ZzB2xEfTjhyS9OwXB3A7jbMSngLOQ0I4v2AZf96wqTWJ9+9/dYEHSx2RYqfg/oqUgiX3nFBVfcCepcSbiJP67iwZ1G+5+Am7kyTzW9OcW/kRAX+QJ953+uCl8zO5PV5UsaffUp8rqP5+jiySJU8jtNxcNrysetCNK6A/V4lEQeU+xa0eZREE1tOTpFYod0VKXsKCqvRqMkW5pkza8Ggy3WgEuTvZcz0dcUBc+9MneL1DqkXjQz0eaZA1LqVtmzcMffTKPiPwz1mh2zkGyNwtT9kguTVI7LWv6ul7DCpOjX9iaGV66HDny/ZL1WfILfc/hMHLUpekAAAAASUVORK5CYII=3</span><br></pre></td></tr></table></figure><p>将base64串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至<a target="_blank" rel="noopener" href="http://www.itcast.cn/%E3%80%82">http://www.itcast.cn/。</a></p><p><img src="/breeze/24565a3e/image44.png"></p><h6 id="3-4-3-3-接口测试"><a href="#3-4-3-3-接口测试" class="headerlink" title="3.4.3.3 接口测试"></a><strong>3.4.3.3 接口测试</strong></h6><p>1、生成订单服务下单接口的二维码</p><p>修改二维码生成的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">QRCodeUtil</span> <span class="variable">qrCodeUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>();</span><br><span class="line">    System.out.println(qrCodeUtil.createQRCode(<span class="string">&quot;http://localhost:63030/orders/alipaytest&quot;</span>, <span class="number">200</span>, <span class="number">200</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：<a href="http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig">http://localhost:63030地址用模拟器无法访问，进入cmd命令状态，输入命令ipconfig</a> -all 查看本地网卡分配的局域网ip地址，将上边的地址修改如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.101.1:63030/orders/alipaytest</span><br></pre></td></tr></table></figure><p>运行main方法，复制输出到控制台的base64串。</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABxUlEQVR42u2YO46EMBBEGxE45AjcBC6GhCUuNtzER3DoANFbZT4zu9KmNavVOLAwj6BV/TXmvy37kL9Oopl1sS+DWV/M2oRzKyWL+95tfXDfenyzJK/vlCTZ0G1WGpzDDlKA9ST2YbfJrMnz2wiE8WQw8A2E/lkc6kQ66afnBKTGKCwaru179ApIXVBnzNb7gy+/ZbCAQJgB5zLCyrD6ZnSSlPAxm1VNyphh28NmKUFI7F3EQ55qrXJfL3VUBOGZJyssF74C45tWSjbEBW2DJslG94QPtQTNYsyzH9WSrgmXOiqCCBlgFmIUhMLwKCVcSFHkxsaagcY1vmSwgkRDZE5WO4YzT6tYSuIprNTEzskBedq5lNS4wEs2TOiEbT1tUxGslaW6OoX98+5ZKhLpmhYFi8LsTNY7T1WE7apNzE5UCgiDD2cpca+T612v0zNGZYQWMVDhJG7h2dE1BOoMSIujUjQcZUYxOWcXBodzeuKmJdddhtNTqZNcc1cxDTnuMmwbxr7dup5wjl8S44J9O75Mdkpyzo1hr/eqV9tUBE+8waBy80p1T3YictxpDyexcQUXk+Muw9m5RohZnWKU5PMX55+RLyKnzJvqtaeFAAAAAElFTkSuQmCC</span><br></pre></td></tr></table></figure><p>打开模拟器，在模拟器中打开浏览器，将base64串复制到浏览器的地址栏。</p><p><img src="/breeze/24565a3e/image45.png"></p><p>使用截屏工具进行截屏，稍后使用支付宝沙箱客户端扫此图片。</p><p><img src="/breeze/24565a3e/image46.png"></p><p>2、启动订单服务</p><p>3、打开模拟器，在模拟器中打开支付宝沙箱客户端，并使用沙箱客户端账号密码登录。</p><p><img src="/breeze/24565a3e/image47.png"></p><p>点击扫一扫选择相册中刚才截屏的二维码</p><p><img src="/breeze/24565a3e/image48.png"></p><p><img src="/breeze/24565a3e/image49.png"></p><p>扫码后如果提示系统繁忙再重试</p><p><img src="/breeze/24565a3e/image50.png"></p><p>如果提示请求勿重复提交则需要修改下单测试代码中指定的out_trade_no商品订单号，订单号在每个商户是唯一的，每次支付前修改out_trade_no 为一个没有使用过的订单号。</p><p><img src="/breeze/24565a3e/image51.png"></p><p>修改订单号后重启订单服务，再使用沙箱支付宝客户端扫码</p><p><img src="/breeze/24565a3e/image52.png"></p><p>输入支付密码进行支付。</p><p>支付密码为沙箱账号的支付密码，此支付所扣款为沙箱账号的虚拟货币余额。</p><p><img src="/breeze/24565a3e/image53.png"></p><p>支付成功界面：</p><p><img src="/breeze/24565a3e/image54.png"></p><h5 id="3-4-4-支付结果查询接口"><a href="#3-4-4-支付结果查询接口" class="headerlink" title="3.4.4 支付结果查询接口"></a><strong>3.4.4 支付结果查询接口</strong></h5><p>支付完成可以调用第三方支付平台的支付结果查询接口 查询支付结果。</p><p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a></p><p>示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(<span class="string">&quot;https://openapi.alipay.com/gateway.do&quot;</span>,<span class="string">&quot;app_id&quot;</span>,<span class="string">&quot;your private_key&quot;</span>,<span class="string">&quot;json&quot;</span>,<span class="string">&quot;GBK&quot;</span>,<span class="string">&quot;alipay_public_key&quot;</span>,<span class="string">&quot;RSA2&quot;</span>);</span><br><span class="line"><span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line"><span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, <span class="string">&quot;20150320010101001&quot;</span>);</span><br><span class="line"><span class="comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span></span><br><span class="line">request.setBizContent(bizContent.toString());</span><br><span class="line"><span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line"><span class="keyword">if</span>(response.isSuccess())&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用成功&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>刚才订单付款成功，可以使用out_trade_no商品订单号或支付宝的交易流水号trade_no去查询支付结果。</p><p>out_trade_no商品订单号: 是在下单请求时指定的商品订单号。</p><p>支付宝的交易流水号trade_no：是支付完成后支付宝通知支付结果时发送的trade_no</p><p>我们使用out_trade_no商品订单号去查询，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayApiException;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.AlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.DefaultAlipayClient;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.request.AlipayTradeQueryRequest;</span><br><span class="line"><span class="keyword">import</span> com.alipay.api.response.AlipayTradeQueryResponse;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 支付宝查询接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 17:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span></span><br><span class="line">    String APP_ID;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span></span><br><span class="line">    String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">    String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryPayResult</span><span class="params">()</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE); <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">        <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, <span class="string">&quot;202210100010101002&quot;</span>);</span><br><span class="line">        <span class="comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span></span><br><span class="line">        request.setBizContent(bizContent.toString());</span><br><span class="line">        <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> alipayClient.execute(request);</span><br><span class="line">        <span class="keyword">if</span> (response.isSuccess()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用成功&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">            <span class="comment">//转map</span></span><br><span class="line">            <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class);</span><br><span class="line">            <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">&quot;alipay_trade_query_response&quot;</span>);</span><br><span class="line">            <span class="comment">//支付结果</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_status&quot;</span>);</span><br><span class="line">            System.out.println(trade_status);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行代码，输出如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 调用成功</span></span><br><span class="line">TRADE_SUCCESS</span><br></pre></td></tr></table></figure><p>输出结果即是调用支付宝查询接口查询到的支付结果</p><p><img src="/breeze/24565a3e/image55.png"></p><p>参考文档<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/02ivbt">https://opendocs.alipay.com/open/02ivbt</a> 查阅每个参数的意义。</p><p>我们主要需要下边的参数：</p><p>“out_trade_no” : “20220520010101026”,</p><p>“trade_no”:”2022100422001422760505740639” ： 支付宝交易流水号</p><p>“total_amount” : “1.30”</p><p>“trade_status” : “TRADE_SUCCESS”： 交易状态</p><p>交易状态类型：</p><p>交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）</p><p>TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</p><p>TRADE_SUCCESS（交易支付成功）</p><p>TRADE_FINISHED（交易结束，不可退款）</p><h5 id="3-4-5-支付结果通知接口"><a href="#3-4-5-支付结果通知接口" class="headerlink" title="3.4.5 支付结果通知接口"></a><strong>3.4.5 支付结果通知接口</strong></h5><h6 id="3-4-5-1-准备环境"><a href="#3-4-5-1-准备环境" class="headerlink" title="3.4.5.1 准备环境"></a><strong>3.4.5.1 准备环境</strong></h6><p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过return_url、notify_url进行通知，使用return_url不能保证通知到位，推荐使用notify_url完成支付结构通知。</p><p><img src="/breeze/24565a3e/image56.png"></p><p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。详情可查看 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01raw4">支付宝异步通知说明</a> 。</p><p>文档：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286">https://opendocs.alipay.com/open/203/105286</a></p><p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p><p>在通知返回参数列表中，除去sign、sign_type两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</p><p>将签名参数（sign）使用 base64 解码为字节码串；</p><p>使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</p><p>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</p><p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p><p>通过验证out_trade_no、total_amount、appid参数的正确性判断通知请求的合法性。</p><p>验证的过程可以参考sdk demo代码，下载 sdk demo代码，<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105910">https://opendocs.alipay.com/open/203/105910</a></p><p><img src="/breeze/24565a3e/image57.png"></p><p>参考demo中的alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p><p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p><p>此接口仍然使用内网穿透技术。</p><h6 id="3-4-5-2-编写测试代码"><a href="#3-4-5-2-编写测试代码" class="headerlink" title="3.4.5.2 编写测试代码"></a><strong>3.4.5.2 编写测试代码</strong></h6><p>1、在下单请求时设置通知地址request.setNotifyUrl(“商户自己的notify_url地址”);</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/alipaytest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">alipaytest</span><span class="params">(HttpServletRequest httpRequest,</span></span><br><span class="line"><span class="params">                       HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="comment">//构造sdk的客户端对象</span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(serverUrl, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, CHARSET, ALIPAY_PUBLIC_KEY, sign_type); <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    <span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span></span><br><span class="line">    alipayRequest.setNotifyUrl(<span class="string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;</span>);<span class="comment">//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、编写接收通知接口，接收参数并验签</p><p>参考课程资料下的alipay.trade.wap.pay-java-utf-8\WebContent\notify_url.jsp</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接收通知</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/paynotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paynotify</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException &#123;</span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span></span><br><span class="line">        <span class="comment">//valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;gbk&quot;);</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span></span><br><span class="line">    <span class="comment">//计算得出通知验证结果</span></span><br><span class="line">    <span class="comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verify_result) &#123;<span class="comment">//验证成功</span></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">//请在这里加上商户的业务逻辑程序代码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//支付宝交易号</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;<span class="comment">//交易结束</span></span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span></span><br><span class="line">            <span class="comment">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;<span class="comment">//交易成功</span></span><br><span class="line">            System.out.println(trade_status);</span><br><span class="line">            <span class="comment">//判断该笔订单是否在商户网站中已经做过处理</span></span><br><span class="line">            <span class="comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span></span><br><span class="line">            <span class="comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span></span><br><span class="line">            <span class="comment">//如果有做过处理，不执行商户的业务程序</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//注意：</span></span><br><span class="line">            <span class="comment">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span></span><br><span class="line">        &#125;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-4-5-3-通知接口测试"><a href="#3-4-5-3-通知接口测试" class="headerlink" title="3.4.5.3 通知接口测试"></a><strong>3.4.5.3 通知接口测试</strong></h6><p>1、重启订单服务，并在接收通知接口中打上断点</p><p>2、配置内网穿透的本地端口为订单服务端口，启动内网穿透客户端。</p><p>3、打开模拟器、支付宝沙箱，扫码、支付。</p><p>4、观察接收订单支付数据等是否正常。</p><h4 id="3-5-生成支付二维码"><a href="#3-5-生成支付二维码" class="headerlink" title="3.5 生成支付二维码"></a><strong>3.5 生成支付二维码</strong></h4><h5 id="3-5-1-需求分析"><a href="#3-5-1-需求分析" class="headerlink" title="3.5.1 需求分析"></a><strong>3.5.1 需求分析</strong></h5><h6 id="3-5-1-1-执行流程"><a href="#3-5-1-1-执行流程" class="headerlink" title="3.5.1.1 执行流程"></a><strong>3.5.1.1 执行流程</strong></h6><p>再次打开课程支付引导界面，&#x3D;&#x3D;点击“支付宝支付”按钮系统该如何处理？&#x3D;&#x3D;</p><p><img src="/breeze/24565a3e/image5-1690175690928-68.png"></p><p>点击“支付宝支付”此时打开支付二维码，用户扫码支付。</p><p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付交易记录。</p><p>生成二维码执行流程如下：</p><p><img src="/breeze/24565a3e/image58.png"></p><p>执行流程：</p><p>1、前端调用学习中心服务的添加选课接口。</p><p>2、添加选课成功请求订单服务生成支付二维码接口。</p><p>3、生成二维码接口：创建商品订单、生成支付交易记录、生成二维码。</p><p>4、将二维码返回到前端，用户扫码。</p><p>用户扫码支付流程如下：</p><p><img src="/breeze/24565a3e/image43-1690175695499-71.png"></p><p>执行流程：</p><p>1、用户输入支付密码，支付成功。</p><p>2、接收第三方平台通知的支付结果。</p><p>3、根据支付结果更新支付交易记录的支付状态为支付成功。</p><h6 id="3-5-1-2-数据模型"><a href="#3-5-1-2-数据模型" class="headerlink" title="3.5.1.2 数据模型"></a><strong>3.5.1.2 数据模型</strong></h6><p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付交易记录表。</p><p><img src="/breeze/24565a3e/image59.png"></p><p>订单表：记录订单信息</p><p><img src="/breeze/24565a3e/image60.png"></p><p>订单明细表记录订单的详细信息</p><p><img src="/breeze/24565a3e/image61.png"></p><p>支付交易记录表记录每次支付的交易明细</p><p><img src="/breeze/24565a3e/image62.png"></p><p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p><p>1、时间戳+随机数</p><p>年月日时分秒毫秒+随机数</p><p>2、高并发场景</p><p>年月日时分秒毫秒+随机数+redis自增序列</p><p>3、订单号中加上业务标识</p><p>订单号加上业务标识方便客服，比如：第10位是业务类型，第11位是用户类型等。</p><p>4、雪花算法</p><p>雪花算法是推特内部使用的分布式环境下的唯一ID生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下ID不重复。</p><p>本项目订单号生成采用雪花算法。</p><p>将资料中的雪花算法工具类IdWorkerUtils拷贝到base模块的util包下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * snow flow .</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IdWorkerUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">WORKER_ID_BITS</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DATACENTERIDBITS</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MAX_WORKER_ID</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; WORKER_ID_BITS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MAX_DATACENTER_ID</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; DATACENTERIDBITS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_BITS</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">WORKER_ID_SHIFT</span> <span class="operator">=</span> SEQUENCE_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DATACENTER_ID_SHIFT</span> <span class="operator">=</span> SEQUENCE_BITS + WORKER_ID_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIMESTAMP_LEFT_SHIFT</span> <span class="operator">=</span> SEQUENCE_BITS + WORKER_ID_BITS + DATACENTERIDBITS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_MASK</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; SEQUENCE_BITS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">IdWorkerUtils</span> <span class="variable">ID_WORKER_UTILS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdWorkerUtils</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> workerId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> datacenterId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> idepoch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">IdWorkerUtils</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(RANDOM.nextInt((<span class="type">int</span>) MAX_WORKER_ID), RANDOM.nextInt((<span class="type">int</span>) MAX_DATACENTER_ID), <span class="number">1288834974657L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">IdWorkerUtils</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> workerId, <span class="keyword">final</span> <span class="type">long</span> datacenterId, <span class="keyword">final</span> <span class="type">long</span> idepoch)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (workerId &gt; MAX_WORKER_ID || workerId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;worker Id can&#x27;t be greater than %d or less than 0&quot;</span>, MAX_WORKER_ID));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (datacenterId &gt; MAX_DATACENTER_ID || datacenterId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;datacenter Id can&#x27;t be greater than %d or less than 0&quot;</span>, MAX_DATACENTER_ID));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.workerId = workerId;</span><br><span class="line">        <span class="built_in">this</span>.datacenterId = datacenterId;</span><br><span class="line">        <span class="built_in">this</span>.idepoch = idepoch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets instance.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the instance</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IdWorkerUtils <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ID_WORKER_UTILS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(String.format(<span class="string">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span>, lastTimestamp - timestamp));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; SEQUENCE_MASK;</span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ((timestamp - idepoch) &lt;&lt; TIMESTAMP_LEFT_SHIFT)</span><br><span class="line">            | (datacenterId &lt;&lt; DATACENTER_ID_SHIFT)</span><br><span class="line">            | (workerId &lt;&lt; WORKER_ID_SHIFT) | sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">tilNextMillis</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> lastTimestamp)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line">        <span class="keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timeGen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Build part number string.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">buildPartNumber</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(ID_WORKER_UTILS.nextId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create uuid string.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createUUID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(ID_WORKER_UTILS.nextId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(IdWorkerUtils.getInstance().nextId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-5-2-接口定义"><a href="#3-5-2-接口定义" class="headerlink" title="3.5.2 接口定义"></a><strong>3.5.2 接口定义</strong></h5><p>在订单服务中定义生成支付二维码接口。</p><p>请求：订单信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.orders.model.po.XcOrders;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 创建商品订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 10:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddOrderDto</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Float totalPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String orderType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String orderName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String orderDescrip;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单明细json，不可为空</span></span><br><span class="line"><span class="comment">     * [&#123;&quot;goodsId&quot;:&quot;&quot;,&quot;goodsType&quot;:&quot;&quot;,&quot;goodsName&quot;:&quot;&quot;,&quot;goodsPrice&quot;:&quot;&quot;,&quot;goodsDetail&quot;:&quot;&quot;&#125;,&#123;...&#125;]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String orderDetail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 外部系统业务id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String outBusinessId;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>响应：支付交易记录信息及二维码信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayRecordDto</span> <span class="keyword">extends</span> <span class="title class_">XcPayRecord</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//二维码</span></span><br><span class="line">    <span class="keyword">private</span> String qrcode;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;订单支付接口&quot;, tags = &quot;订单支付接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;生成支付二维码&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/generatepaycode&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;</span><br><span class="line">		<span class="comment">// 调用service，完成插入订单信息，插入支付记录，生成支付二维码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用户扫码请求下单，定义下单接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;扫码下单接口&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/requestpay&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo,HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-5-3-接口实现"><a href="#3-5-3-接口实现" class="headerlink" title="3.5.3 接口实现"></a><strong>3.5.3 接口实现</strong></h5><h6 id="3-5-3-1-保存商品订单"><a href="#3-5-3-1-保存商品订单" class="headerlink" title="3.5.3.1 保存商品订单"></a><strong>3.5.3.1 保存商品订单</strong></h6><p>定义保存订单信息接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 创建商品订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> addOrderDto 订单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> PayRecordDto 支付交易记录(包括二维码)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 11:02</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId,AddOrderDto addOrderDto)</span>;</span><br></pre></td></tr></table></figure><p>在保存订单接口中需要完成创建商品订单、创建支付交易记录，接口实现方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcOrdersMapper ordersMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcOrdersGoodsMapper ordersGoodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    XcPayRecordMapper payRecordMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加商品订单,插入订单表，包括订单主表和订单明细表</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加支付交易记录</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成二维码</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写创建商品订单方法，商品订单的数据来源于选课记录，在订单表需要存入选课记录的ID，这里需要作好幂等处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">saveXcOrders</span><span class="params">(String userId,AddOrderDto addOrderDto)</span>&#123;</span><br><span class="line">    <span class="comment">//幂等性处理</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">order</span> <span class="operator">=</span> getOrderByBusinessId(addOrderDto.getOutBusinessId());</span><br><span class="line">    <span class="keyword">if</span>(order!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">    order = <span class="keyword">new</span> <span class="title class_">XcOrders</span>();</span><br><span class="line">    <span class="comment">//生成订单号.利用雪花算法</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> IdWorkerUtils.getInstance().nextId();</span><br><span class="line">    order.setId(orderId);</span><br><span class="line">    order.setTotalPrice(addOrderDto.getTotalPrice());</span><br><span class="line">    order.setCreateDate(LocalDateTime.now());</span><br><span class="line">    order.setStatus(<span class="string">&quot;600001&quot;</span>);<span class="comment">//未支付</span></span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setOrderType(addOrderDto.getOrderType());</span><br><span class="line">    order.setOrderName(addOrderDto.getOrderName());</span><br><span class="line">    order.setOrderDetail(addOrderDto.getOrderDetail());</span><br><span class="line">    order.setOrderDescrip(addOrderDto.getOrderDescrip());</span><br><span class="line">    order.setOutBusinessId(addOrderDto.getOutBusinessId());<span class="comment">//选课记录id</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> ordersMapper.insert(order);</span><br><span class="line">    <span class="keyword">if</span> (insert &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;添加订单失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">orderDetailJson</span> <span class="operator">=</span> addOrderDto.getOrderDetail();</span><br><span class="line">    List&lt;XcOrdersGoods&gt; xcOrdersGoodsList = JSON.parseArray(orderDetailJson, XcOrdersGoods.class);</span><br><span class="line">    xcOrdersGoodsList.forEach(goods-&gt;&#123;</span><br><span class="line">        <span class="type">XcOrdersGoods</span> <span class="variable">xcOrdersGoods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcOrdersGoods</span>();</span><br><span class="line">        BeanUtils.copyProperties(goods,xcOrdersGoods);</span><br><span class="line">        xcOrdersGoods.setOrderId(orderId);<span class="comment">//订单号</span></span><br><span class="line">        ordersGoodsMapper.insert(xcOrdersGoods);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据业务id查询订单，业务id是选课记录表中的主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> businessId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> XcOrders <span class="title function_">getOrderByBusinessId</span><span class="params">(String businessId)</span> &#123;</span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> ordersMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcOrders&gt;().eq(XcOrders::getOutBusinessId, businessId));</span><br><span class="line">    <span class="keyword">return</span> orders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-5-3-2-创建支付交易记录"><a href="#3-5-3-2-创建支付交易记录" class="headerlink" title="3.5.3.2 创建支付交易记录"></a><strong>3.5.3.2 创建支付交易记录</strong></h6><p>&#x3D;&#x3D;为什么创建支付交易记录？&#x3D;&#x3D;</p><p>在请求微信或支付宝下单接口时需要传入 商品订单号，在与第三方支付平台对接时发现，当用户支付失败或因为其它原因最终该订单没有支付成功，此时再次调用第三方支付平台的下单接口发现报错“订单号已存在”，此时如果我们传入一个没有使用过的订单号就可以解决问题，但是商品订单已经创建，因为没有支付成功重新创建一个新订单是不合理的。</p><p>解决以上问题的方案是：</p><p>1、用户每次发起都创建一个新的支付交易记录 ，此交易记录与商品订单关联。</p><p>2、将支付交易记录的流水号传给第三方支付系统下单接口，这样就即使没有支付成功就不会出现上边的问题。</p><p>3、需要提醒用户不要重复支付。</p><p><img src="/breeze/24565a3e/image63.png"></p><p>编写创建支付交易记录的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">createPayRecord</span><span class="params">(XcOrders orders)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果此订单不存在，不能添加支付记录</span></span><br><span class="line">    <span class="keyword">if</span>(orders==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;订单不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果此订单支付结果为成功，不再添加支付记录，避免重复支付</span></span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">&quot;600002&quot;</span>))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;订单已支付&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">    <span class="comment">//生成支付交易流水号，将来要传给支付宝</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">payNo</span> <span class="operator">=</span> IdWorkerUtils.getInstance().nextId();</span><br><span class="line">    payRecord.setPayNo(payNo);</span><br><span class="line">    payRecord.setOrderId(orders.getId());<span class="comment">//商品订单号</span></span><br><span class="line">    payRecord.setOrderName(orders.getOrderName());</span><br><span class="line">    payRecord.setTotalPrice(orders.getTotalPrice());</span><br><span class="line">    payRecord.setCurrency(<span class="string">&quot;CNY&quot;</span>);</span><br><span class="line">    payRecord.setCreateDate(LocalDateTime.now());</span><br><span class="line">    payRecord.setStatus(<span class="string">&quot;601001&quot;</span>);<span class="comment">//未支付</span></span><br><span class="line">    payRecord.setUserId(orders.getUserId());</span><br><span class="line">    payRecordMapper.insert(payRecord);</span><br><span class="line">    <span class="keyword">return</span> payRecord;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-5-3-3-生成支付二维码"><a href="#3-5-3-3-生成支付二维码" class="headerlink" title="3.5.3.3 生成支付二维码"></a><strong>3.5.3.3 生成支付二维码</strong></h6><p>1、在nacos中orders-service-dev.yaml配置二维码的url</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pay:</span></span><br><span class="line"> <span class="attr">qrcodeurl:</span> <span class="string">http://192.168.137.1/api/orders/requestpay?payNo=%s</span></span><br></pre></td></tr></table></figure><p>2、完善创建订单service方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;pay.qrcodeurl&#125;&quot;)</span></span><br><span class="line">String qrcodeurl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">createOrder</span><span class="params">(String userId, AddOrderDto addOrderDto)</span> &#123;</span><br><span class="line">    <span class="comment">// 插入订单表，包括订单主表和订单明细表</span></span><br><span class="line">    <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> saveXcOrders(userId, addOrderDto);</span><br><span class="line">    <span class="keyword">if</span>(orders==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;订单创建失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(orders.getStatus().equals(<span class="string">&quot;600002&quot;</span>))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;订单已支付&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成支付记录</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> createPayRecord(orders);</span><br><span class="line">    <span class="comment">//生成二维码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">qrCode</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//url要可以被模拟器访问到，url为下单接口(稍后定义)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> String.format(qrcodeurl, payRecord.getPayNo());</span><br><span class="line">        qrCode = <span class="keyword">new</span> <span class="title class_">QRCodeUtil</span>().createQRCode(url, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;生成二维码出错&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(payRecord,payRecordDto);</span><br><span class="line">    payRecordDto.setQrcode(qrCode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-5-3-4-生成二维码接口完善"><a href="#3-5-3-4-生成二维码接口完善" class="headerlink" title="3.5.3.4 生成二维码接口完善"></a><strong>3.5.3.4 生成二维码接口完善</strong></h6><p>完善生成支付二维码controller接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;生成支付二维码&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/generatepaycode&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">generatePayCode</span><span class="params">(<span class="meta">@RequestBody</span> AddOrderDto addOrderDto)</span> &#123;</span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请登录后继续选课&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orderService.createOrder(user.getId(), addOrderDto);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-5-3-5-扫码下单接口完善"><a href="#3-5-3-5-扫码下单接口完善" class="headerlink" title="3.5.3.5 扫码下单接口完善"></a><strong>3.5.3.5 扫码下单接口完善</strong></h6><p>生成了支付二维码，用户扫码请求第三方支付平台下单、支付。</p><p>1、定义查询支付交易记录的Service接口与实现方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 查询支付交易记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo  交易记录号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.orders.model.po.XcPayRecord</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/20 23:38</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> XcPayRecord <span class="title function_">getPayRecordByPayno</span><span class="params">(String payNo)</span> &#123;</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">xcPayRecord</span> <span class="operator">=</span> payRecordMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));</span><br><span class="line">    <span class="keyword">return</span> xcPayRecord;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2 定义下单接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.APP_ID&#125;&quot;)</span></span><br><span class="line">String APP_ID;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.APP_PRIVATE_KEY&#125;&quot;)</span></span><br><span class="line">String APP_PRIVATE_KEY;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;pay.alipay.ALIPAY_PUBLIC_KEY&#125;&quot;)</span></span><br><span class="line">String ALIPAY_PUBLIC_KEY;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(&quot;扫码下单接口&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/requestpay&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestpay</span><span class="params">(String payNo,HttpServletResponse httpResponse)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//如果payNo不存在则提示重新发起支付</span></span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> orderService.getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span>(payRecord == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请重新点击支付获取二维码&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> payRecord.getStatus();</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;601002&quot;</span>.equals(status))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;订单已支付，请勿重复支付。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构造sdk的客户端对象</span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, AlipayConfig.FORMAT, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE);<span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeWapPayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeWapPayRequest</span>();<span class="comment">//创建API对应的request</span></span><br><span class="line">    <span class="comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span></span><br><span class="line">    <span class="comment">//        alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;);//在公共参数中设置回跳和通知地址</span></span><br><span class="line">    alipayRequest.setBizContent(<span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; \&quot;out_trade_no\&quot;:\&quot;&quot;</span>+payRecord.getPayNo()+<span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; \&quot;total_amount\&quot;:\&quot;&quot;</span>+payRecord.getTotalPrice()+<span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; \&quot;subject\&quot;:\&quot;&quot;</span>+payRecord.getOrderName()+<span class="string">&quot;\&quot;,&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; \&quot;product_code\&quot;:\&quot;QUICK_WAP_PAY\&quot;&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; &#125;&quot;</span>);<span class="comment">//填充业务参数</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">form</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//请求支付宝下单接口,发起http请求</span></span><br><span class="line">        form = client.pageExecute(alipayRequest).getBody(); <span class="comment">//调用SDK生成表单</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    httpResponse.setContentType(<span class="string">&quot;text/html;charset=&quot;</span> + AlipayConfig.CHARSET);</span><br><span class="line">    httpResponse.getWriter().write(form);<span class="comment">//直接将完整的表单html输出到页面</span></span><br><span class="line">    httpResponse.getWriter().flush();</span><br><span class="line">    httpResponse.getWriter().close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-5-4-支付测试"><a href="#3-5-4-支付测试" class="headerlink" title="3.5.4 支付测试"></a><strong>3.5.4 支付测试</strong></h5><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>3、使用资料目录中的新模板course_template.ftl</p><p>测试流程：</p><p>1、进入收费课程详细页面，点击马上学习。</p><p>2、跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付交易记录是否创建成功。</p><p>3、观察生成二维码是否成功</p><p>4、使用模拟器扫码测试，是否可以正常支付。</p><p>如果报订单参数异常报如下错误，需要检查请求支付宝的下单数据是否正确。</p><p><img src="/breeze/24565a3e/image64.png"></p><h4 id="3-6-查询支付结果"><a href="#3-6-查询支付结果" class="headerlink" title="3.6 查询支付结果"></a><strong>3.6 查询支付结果</strong></h4><h5 id="3-6-1-接口定义"><a href="#3-6-1-接口定义" class="headerlink" title="3.6.1 接口定义"></a><strong>3.6.1 接口定义</strong></h5><p>根据前边我们调研的获取支付结果的接口，包括：主动查询支付结果、被动接收支付结果。</p><p>这里先实现主动查询支付结果，当支付完成用户点击“支付结果”将请求第三方支付平台查询支付结果。</p><p>在OrderController类中定义接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询支付结果&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payresult&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询支付结果</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-6-2-接口实现"><a href="#3-6-2-接口实现" class="headerlink" title="3.6.2 接口实现"></a><strong>3.6.2 接口实现</strong></h5><h6 id="3-6-2-1-service总体接口"><a href="#3-6-2-1-service总体接口" class="headerlink" title="3.6.2.1 service总体接口"></a><strong>3.6.2.1 service总体接口</strong></h6><p>1、定义查询支付结果的service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求支付宝查询支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付记录id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付记录信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>;</span><br></pre></td></tr></table></figure><p>2、service实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">queryPayResult</span><span class="params">(String payNo)</span>&#123;</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span> (payRecord == <span class="literal">null</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请重新点击支付获取二维码&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> payRecord.getStatus();</span><br><span class="line">    <span class="comment">//如果支付成功直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;601002&quot;</span>.equals(status)) &#123;</span><br><span class="line">        <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">        BeanUtils.copyProperties(payRecord, payRecordDto);</span><br><span class="line">        <span class="keyword">return</span> payRecordDto;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从支付宝查询支付结果</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> queryPayResultFromAlipay(payNo);</span><br><span class="line">    <span class="comment">//保存支付结果</span></span><br><span class="line">    currentProxy.saveAliPayStatus( payStatusDto);</span><br><span class="line">    <span class="comment">//重新查询支付记录</span></span><br><span class="line">    payRecord = getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayRecordDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(payRecord, payRecordDto);</span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求支付宝查询支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付交易号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PayStatusDto <span class="title function_">queryPayResultFromAlipay</span><span class="params">(String payNo)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存支付宝支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payStatusDto  支付结果信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 16:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> ;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="3-6-2-2-查询支付结果"><a href="#3-6-2-2-查询支付结果" class="headerlink" title="3.6.2.2 查询支付结果"></a><strong>3.6.2.2 查询支付结果</strong></h6><p>定义从支付宝查询支付结果的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求支付宝查询支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payNo 支付交易号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 支付结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PayStatusDto <span class="title function_">queryPayResultFromAlipay</span><span class="params">(String payNo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//========请求支付宝查询支付结果=============</span></span><br><span class="line">    <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(AlipayConfig.URL, APP_ID, APP_PRIVATE_KEY, <span class="string">&quot;json&quot;</span>, AlipayConfig.CHARSET, ALIPAY_PUBLIC_KEY, AlipayConfig.SIGNTYPE); <span class="comment">//获得初始化的AlipayClient</span></span><br><span class="line">    <span class="type">AlipayTradeQueryRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradeQueryRequest</span>();</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">bizContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    bizContent.put(<span class="string">&quot;out_trade_no&quot;</span>, payNo);</span><br><span class="line">    request.setBizContent(bizContent.toString());</span><br><span class="line">    <span class="type">AlipayTradeQueryResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = alipayClient.execute(request);</span><br><span class="line">        <span class="keyword">if</span> (!response.isSuccess()) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;请求支付查询查询失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;请求支付宝查询支付结果异常:&#123;&#125;&quot;</span>, e.toString(), e);</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请求支付查询查询失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取支付结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">resultJson</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">    <span class="comment">//转map</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> JSON.parseObject(resultJson, Map.class);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">alipay_trade_query_response</span> <span class="operator">=</span> (Map) resultMap.get(<span class="string">&quot;alipay_trade_query_response&quot;</span>);</span><br><span class="line">    <span class="comment">//支付结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_status&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;total_amount&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> (String) alipay_trade_query_response.get(<span class="string">&quot;trade_no&quot;</span>);</span><br><span class="line">    <span class="comment">//保存支付结果</span></span><br><span class="line">    <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">    payStatusDto.setOut_trade_no(payNo);</span><br><span class="line">    payStatusDto.setTrade_status(trade_status);</span><br><span class="line">    payStatusDto.setApp_id(APP_ID);</span><br><span class="line">    payStatusDto.setTrade_no(trade_no);</span><br><span class="line">    payStatusDto.setTotal_amount(total_amount);</span><br><span class="line">    <span class="keyword">return</span> payStatusDto;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-6-2-3-保存支付结果"><a href="#3-6-2-3-保存支付结果" class="headerlink" title="3.6.2.3 保存支付结果"></a><strong>3.6.2.3 保存支付结果</strong></h6><p>1、定义保存支付结果的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存支付宝支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> payStatusDto  支付结果信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/4 16:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> ;</span><br></pre></td></tr></table></figure><p>2、编写接口实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> &#123;</span><br><span class="line">    <span class="comment">//支付流水号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payNo</span> <span class="operator">=</span> payStatusDto.getOut_trade_no();</span><br><span class="line">    <span class="type">XcPayRecord</span> <span class="variable">payRecord</span> <span class="operator">=</span> getPayRecordByPayno(payNo);</span><br><span class="line">    <span class="keyword">if</span> (payRecord == <span class="literal">null</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;支付记录找不到&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支付结果</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> payStatusDto.getTrade_status();</span><br><span class="line">    log.debug(<span class="string">&quot;收到支付结果:&#123;&#125;,支付记录:&#123;&#125;&#125;&quot;</span>, payStatusDto.toString(),payRecord.toString());</span><br><span class="line">    <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//支付金额变为分</span></span><br><span class="line">        <span class="type">Float</span> <span class="variable">totalPrice</span> <span class="operator">=</span> payRecord.getTotalPrice() * <span class="number">100</span>;</span><br><span class="line">        <span class="type">Float</span> <span class="variable">total_amount</span> <span class="operator">=</span> Float.parseFloat(payStatusDto.getTotal_amount()) * <span class="number">100</span>;</span><br><span class="line">        <span class="comment">//校验是否一致</span></span><br><span class="line">        <span class="keyword">if</span> (!payStatusDto.getApp_id().equals(APP_ID) || totalPrice.intValue() != total_amount.intValue()) &#123;</span><br><span class="line">            <span class="comment">//校验失败</span></span><br><span class="line">            log.info(<span class="string">&quot;校验支付结果失败,支付记录:&#123;&#125;,APP_ID:&#123;&#125;,totalPrice:&#123;&#125;&quot;</span> ,payRecord.toString(),payStatusDto.getApp_id(),total_amount.intValue());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;校验支付结果失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;更新支付结果,支付交易流水号:&#123;&#125;,支付结果:&#123;&#125;&quot;</span>, payNo, trade_status);</span><br><span class="line">        <span class="type">XcPayRecord</span> <span class="variable">payRecord_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcPayRecord</span>();</span><br><span class="line">        payRecord_u.setStatus(<span class="string">&quot;601002&quot;</span>);<span class="comment">//支付成功</span></span><br><span class="line">        payRecord_u.setOutPayChannel(<span class="string">&quot;Alipay&quot;</span>);</span><br><span class="line">        payRecord_u.setOutPayNo(payStatusDto.getTrade_no());<span class="comment">//支付宝交易号</span></span><br><span class="line">        payRecord_u.setPaySuccessTime(LocalDateTime.now());<span class="comment">//通知时间</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">update1</span> <span class="operator">=</span> payRecordMapper.update(payRecord_u, <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcPayRecord&gt;().eq(XcPayRecord::getPayNo, payNo));</span><br><span class="line">        <span class="keyword">if</span> (update1 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;更新支付记录状态成功:&#123;&#125;&quot;</span>, payRecord_u.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;更新支付记录状态失败:&#123;&#125;&quot;</span>, payRecord_u.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;更新支付记录状态失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关联的订单号</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> payRecord.getOrderId();</span><br><span class="line">        <span class="type">XcOrders</span> <span class="variable">orders</span> <span class="operator">=</span> ordersMapper.selectById(orderId);</span><br><span class="line">        <span class="keyword">if</span> (orders == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;根据支付记录[&#123;&#125;&#125;]找不到订单&quot;</span>, payRecord_u.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;根据支付记录找不到订单&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">XcOrders</span> <span class="variable">order_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XcOrders</span>();</span><br><span class="line">        order_u.setStatus(<span class="string">&quot;600002&quot;</span>);<span class="comment">//支付成功</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> ordersMapper.update(order_u, <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcOrders&gt;().eq(XcOrders::getId, orderId));</span><br><span class="line">        <span class="keyword">if</span> (update &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;更新订单表状态成功,订单号:&#123;&#125;&quot;</span>, orderId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;更新订单表状态失败,订单号:&#123;&#125;&quot;</span>, orderId);</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;更新订单表状态失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-6-3-接口测试"><a href="#3-6-3-接口测试" class="headerlink" title="3.6.3 接口测试"></a><strong>3.6.3 接口测试</strong></h5><p>1、完善接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询支付结果&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payresult&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> PayRecordDto <span class="title function_">payresult</span><span class="params">(String payNo)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//调用支付宝接口查询</span></span><br><span class="line">    <span class="type">PayRecordDto</span> <span class="variable">payRecordDto</span> <span class="operator">=</span> orderService.queryPayResult(payNo);</span><br><span class="line">    <span class="keyword">return</span> payRecordDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、测试流程</p><p>完成生成支付二维码</p><p>用支付宝扫码但不支付</p><p>使用httpclient请求查询支付结果，查询失败</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 查询支付结果</span></span><br><span class="line">GET &#123;&#123;orders_host&#125;&#125;/orders/payresult?payNo=1628648111951941632</span><br><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS41MXh1ZWNoZW5nLmNuL2RkZGZcIixcInV0eXBlXCI6XCIxMDEwMDFcIn0iLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjc3MTQwMDI1LCJhdXRob3JpdGllcyI6WyJwMSJdLCJqdGkiOiJmYThiMmY1OS03ZTQ5LTRmODUtOTBlMC05NzYwNjlkYjE3ODIiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.89sp5lPdFafZ_HdGhe8Cpv0anMJC3vT4PtaGMHgCkr8</span><br></pre></td></tr></table></figure><p>用支付宝扫码再次完成支付</p><p>使用httpclient请求查询支付结果，支付结果为成功，并更新支付记录状态和订单状态。</p><p>3、使用前后端联调</p><p>拷贝资料目录中LocalDateTimeConfig.java到base工程下，处理long转string精度损失的问题。</p><p>使用最新的门户代码xc-ui-pc-static-portal.zip</p><h4 id="3-7-接收支付通知"><a href="#3-7-接收支付通知" class="headerlink" title="3.7 接收支付通知"></a><strong>3.7 接收支付通知</strong></h4><h5 id="3-7-1-接口定义"><a href="#3-7-1-接口定义" class="headerlink" title="3.7.1 接口定义"></a><strong>3.7.1 接口定义</strong></h5><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入NotifyUrl，这里有两个url：NotifyUrl和ReturnUrl，ReturnUrl是支付完成后支付系统携带支付结果重定向到ReturnUrl地址，NotifyUrl是支付完成后支付系统在后台定时去通知，使用NotifyUrl比使用ReturnUrl有保证。</p><p>根据接口描述：<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/203/105286%E7%9A%84%E5%86%85%E5%AE%B9%E4%B8%8B%E8%BE%B9%E5%9C%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%9A%84%E6%8E%A5%E5%8F%A3%E3%80%82">https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</a></p><p>首先在下单时指定NotifyUrl:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/receivenotify&quot;);</span><br></pre></td></tr></table></figure><p>接收支付结果通知接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;接收支付结果通知&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/receivenotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivenotify</span><span class="params">(HttpServletRequest request,HttpServletResponse out)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException &#123;</span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验签</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verify_result) &#123;<span class="comment">//验证成功</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//支付宝交易号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//appid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">app_id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;app_id&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//total_amount</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;total_amount&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交易成功处理</span></span><br><span class="line">        <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理逻辑。。。</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-7-2-接口实现"><a href="#3-7-2-接口实现" class="headerlink" title="3.7.2 接口实现"></a><strong>3.7.2 接口实现</strong></h5><p>完善contorller接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;接收支付结果通知&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/receivenotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receivenotify</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> UnsupportedEncodingException, AlipayApiException &#123;</span><br><span class="line">    Map&lt;String,String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">    <span class="type">Map</span> <span class="variable">requestParams</span> <span class="operator">=</span> request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">iter</span> <span class="operator">=</span> requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) iter.next();</span><br><span class="line">        String[] values = (String[]) requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验签</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">verify_result</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, ALIPAY_PUBLIC_KEY, AlipayConfig.CHARSET, <span class="string">&quot;RSA2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verify_result) &#123;<span class="comment">//验证成功</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;out_trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//支付宝交易号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_no</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_no&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;trade_status&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//appid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">app_id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;app_id&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//total_amount</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(request.getParameter(<span class="string">&quot;total_amount&quot;</span>).getBytes(<span class="string">&quot;ISO-8859-1&quot;</span>),<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交易成功处理</span></span><br><span class="line">        <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">PayStatusDto</span> <span class="variable">payStatusDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayStatusDto</span>();</span><br><span class="line">            payStatusDto.setOut_trade_no(out_trade_no);</span><br><span class="line">            payStatusDto.setTrade_status(trade_status);</span><br><span class="line">            payStatusDto.setApp_id(app_id);</span><br><span class="line">            payStatusDto.setTrade_no(trade_no);</span><br><span class="line">            payStatusDto.setTotal_amount(total_amount);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理逻辑。。。</span></span><br><span class="line">            orderService.saveAliPayStatus(payStatusDto);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-7-3-接口测试"><a href="#3-7-3-接口测试" class="headerlink" title="3.7.3 接口测试"></a><strong>3.7.3 接口测试</strong></h5><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>测试流程：</p><p>1、对选课进行支付</p><p>2、支付成功跟踪service方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p><p>支付成功更新订单表的状态为空。</p><h3 id="4-支付通知"><a href="#4-支付通知" class="headerlink" title="4 支付通知"></a><strong>4 支付通知</strong></h3><h4 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1 需求分析</strong></h4><p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p><p>下图使用了消息队列完成支付结果通知：</p><p><img src="/breeze/24565a3e/image65.png"></p><p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p><p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p><p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p><p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p><h4 id="4-2-技术方案"><a href="#4-2-技术方案" class="headerlink" title="4.2 技术方案"></a><strong>4.2 技术方案</strong></h4><p>使用消息队列进行异步通知需要保证消息的可靠性，即生产端将消息成功通知到消费端。</p><p>消息从生产端发送到消费端经历了如下过程：</p><p>1、消息发送到交换机</p><p>2、消息由交换机发送到队列</p><p>3、消息者收到消息进行处理</p><p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用RabbitMQ可以通过如下方面保证消息的可靠性。</p><p>1、生产者确认机制</p><p>发送消息前使用数据库事务将消息保证到数据库表中</p><p>成功发送到交换机将消息从数据库中删除</p><p>2、mq持久化</p><p>mq收到消息进行持久化，当mq重启即使消息没有消费完也不会丢失。</p><p>需要配置交换机持久化、队列持久化、发送消息时设置持久化。</p><p>3、消费者确认机制</p><p>消费者消费成功自动发送ack，否则重试消费。</p><h4 id="4-3-发送支付结果"><a href="#4-3-发送支付结果" class="headerlink" title="4.3 发送支付结果"></a><strong>4.3 发送支付结果</strong></h4><h5 id="4-3-1-订单服务集成MQ"><a href="#4-3-1-订单服务集成MQ" class="headerlink" title="4.3.1 订单服务集成MQ"></a><strong>4.3.1 订单服务集成MQ</strong></h5><p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p><p>1、订单服务创建支付结果通知交换机。</p><p>2、学习中心服务绑定队列到交换机。</p><p>项目使用RabbitMQ作为消息队列，在课前下发的虚拟上已经安装了RabbitMQ.</p><p>执行docker start rabbitmq 启动RabbitMQ。访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:15672/">http://192.168.101.65:15672/</a></p><p>账户密码：guest&#x2F;guest</p><p>交换机为Fanout广播模式。</p><p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p><p>1、首先在订单服务添加消息队列依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、在nacos配置rabbitmq-dev.yaml为通用配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">false</span> <span class="comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">mandatory:</span> <span class="literal">false</span> <span class="comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">none</span> <span class="comment">#出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启消费者失败重试</span></span><br><span class="line">          <span class="attr">initial-interval:</span> <span class="string">1000ms</span> <span class="comment">#初识的失败等待时长为1秒</span></span><br><span class="line">          <span class="attr">multiplier:</span> <span class="number">1</span> <span class="comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span></span><br><span class="line">          <span class="attr">max-attempts:</span> <span class="number">3</span> <span class="comment">#最大重试次数</span></span><br><span class="line">          <span class="attr">stateless:</span> <span class="literal">true</span> <span class="comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span></span><br></pre></td></tr></table></figure><p>3、在订单服务接口工程引入rabbitmq-dev.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>4、在订单服务service工程编写MQ配置类，配置交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.orders.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/23 16:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">&quot;paynotify_exchange_fanout&quot;</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;payresult_notify&quot;</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;paynotify_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 获取RabbitTemplate</span></span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> applicationContext.getBean(RabbitTemplate.class);</span><br><span class="line">        <span class="comment">//消息处理service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> applicationContext.getBean(MqMessageService.class);</span><br><span class="line">        <span class="comment">// 设置ReturnCallback</span></span><br><span class="line">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 投递失败，记录日志</span></span><br><span class="line">            log.info(<span class="string">&quot;消息发送失败，应答码&#123;&#125;，原因&#123;&#125;，交换机&#123;&#125;，路由键&#123;&#125;,消息&#123;&#125;&quot;</span>,</span><br><span class="line">                     replyCode, replyText, exchange, routingKey, message.toString());</span><br><span class="line">            <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.toString(), MqMessage.class);</span><br><span class="line">            <span class="comment">//将消息再添加到消息表</span></span><br><span class="line">            mqMessageService.addMessage(mqMessage.getMessageType(),mqMessage.getBusinessKey1(),mqMessage.getBusinessKey2(),mqMessage.getBusinessKey3());</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启订单服务，登录rabbitmq，查看交换机自动创建成功</p><p><img src="/breeze/24565a3e/image66.png"></p><p>查看队列自动成功</p><p><img src="/breeze/24565a3e/image67.png"></p><h5 id="4-3-2-发送支付结果"><a href="#4-3-2-发送支付结果" class="headerlink" title="4.3.2 发送支付结果"></a><strong>4.3.2 发送支付结果</strong></h5><p>在OrderService中定义接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送通知结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>;</span><br></pre></td></tr></table></figure><p>编写接口实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、消息体，转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> JSON.toJSONString(message);</span><br><span class="line">    <span class="comment">//设置消息持久化</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">msgObj</span> <span class="operator">=</span> MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        .setDeliveryMode(MessageDeliveryMode.PERSISTENT)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">// 2.全局唯一的消息ID，需要封装到CorrelationData中</span></span><br><span class="line">    <span class="type">CorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(message.getId().toString());</span><br><span class="line">    <span class="comment">// 3.添加callback</span></span><br><span class="line">    correlationData.getFuture().addCallback(</span><br><span class="line">        result -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(result.isAck())&#123;</span><br><span class="line">                <span class="comment">// 3.1.ack，消息成功</span></span><br><span class="line">                log.debug(<span class="string">&quot;通知支付结果消息发送成功, ID:&#123;&#125;&quot;</span>, correlationData.getId());</span><br><span class="line">                <span class="comment">//删除消息表中的记录</span></span><br><span class="line">                mqMessageService.completed(message.getId());</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 3.2.nack，消息失败</span></span><br><span class="line">                log.error(<span class="string">&quot;通知支付结果消息发送失败, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(), result.getReason());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        ex -&gt; log.error(<span class="string">&quot;消息发送异常, ID:&#123;&#125;, 原因&#123;&#125;&quot;</span>,correlationData.getId(),ex.getMessage())</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(PayNotifyConfig.PAYNOTIFY_EXCHANGE_FANOUT, <span class="string">&quot;&quot;</span>, msgObj,correlationData);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>订单服务收到第三方平台的支付结果时，在saveAliPayStatus方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAliPayStatus</span><span class="params">(PayStatusDto payStatusDto)</span> &#123;</span><br><span class="line">    .......</span><br><span class="line">        <span class="comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">&quot;payresult_notify&quot;</span>, orders.getOutBusinessId(), orders.getOrderType(), <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//通知消息</span></span><br><span class="line">    notifyPayResult(mqMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置交换机和队列</p><p>在order-service工程配置</p><p>消息发送方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送通知结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyPayResult</span><span class="params">(MqMessage message)</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="4-4-接收支付结果"><a href="#4-4-接收支付结果" class="headerlink" title="4.4 接收支付结果"></a><strong>4.4 接收支付结果</strong></h4><h5 id="4-4-1-学习中心服务集成MQ"><a href="#4-4-1-学习中心服务集成MQ" class="headerlink" title="4.4.1 学习中心服务集成MQ"></a><strong>4.4.1 学习中心服务集成MQ</strong></h5><p>1、在学习中心服务添加消息队列依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、在学习中心服务接口工程引入rabbitmq-dev.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">rabbitmq-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>3、添加配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/23 16:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="operator">=</span> <span class="string">&quot;paynotify_exchange_fanout&quot;</span>;</span><br><span class="line">    <span class="comment">//支付结果通知消息类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MESSAGE_TYPE</span> <span class="operator">=</span> <span class="string">&quot;payresult_notify&quot;</span>;</span><br><span class="line">    <span class="comment">//支付通知队列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYNOTIFY_QUEUE</span> <span class="operator">=</span> <span class="string">&quot;paynotify_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明交换机，且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_EXCHANGE_FANOUT)</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">paynotify_exchange_fanout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(PAYNOTIFY_EXCHANGE_FANOUT, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支付通知队列,且持久化</span></span><br><span class="line">    <span class="meta">@Bean(PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">course_publish_queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(PAYNOTIFY_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//交换机和支付通知队列绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding_course_publish_queue</span><span class="params">(<span class="meta">@Qualifier(PAYNOTIFY_QUEUE)</span> Queue queue, <span class="meta">@Qualifier(PAYNOTIFY_EXCHANGE_FANOUT)</span> FanoutExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-4-2-接收支付结果"><a href="#4-4-2-接收支付结果" class="headerlink" title="4.4.2 接收支付结果"></a><strong>4.4.2 接收支付结果</strong></h5><p>监听MQ，接收支付结果，定义ReceivePayNotifyService类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.config.PayNotifyConfig;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 接收支付结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/23 19:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceivePayNotifyService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyCourseTablesService myCourseTablesService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听消息队列接收支付结果通知</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = PayNotifyConfig.PAYNOTIFY_QUEUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(Message message, Channel channel)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取消息</span></span><br><span class="line">        <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> JSON.parseObject(message.getBody(), MqMessage.class);</span><br><span class="line">        log.debug(<span class="string">&quot;学习中心服务接收支付结果:&#123;&#125;&quot;</span>, mqMessage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//消息类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">messageType</span> <span class="operator">=</span> mqMessage.getMessageType();</span><br><span class="line">        <span class="comment">//订单类型,60201表示购买课程</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">businessKey2</span> <span class="operator">=</span> mqMessage.getBusinessKey2();</span><br><span class="line">        <span class="comment">//这里只处理支付结果通知</span></span><br><span class="line">        <span class="keyword">if</span> (PayNotifyConfig.MESSAGE_TYPE.equals(messageType) &amp;&amp; <span class="string">&quot;60201&quot;</span>.equals(businessKey2)) &#123;</span><br><span class="line">            <span class="comment">//选课记录id</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">choosecourseId</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line">            <span class="comment">//添加选课</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> myCourseTablesService.saveChooseCourseStauts(choosecourseId);</span><br><span class="line">            <span class="keyword">if</span>(!b)&#123;</span><br><span class="line">                <span class="comment">//添加选课失败，抛出异常，消息重回队列</span></span><br><span class="line">                XueChengPlusException.cast(<span class="string">&quot;收到支付结果，添加选课失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-5-通知支付结果测试"><a href="#4-5-通知支付结果测试" class="headerlink" title="4.5 通知支付结果测试"></a><strong>4.5 通知支付结果测试</strong></h4><p>测试准备：</p><p>1、找一门已发布的收费课程。</p><p>2、如果在我的课程表存储则删除。</p><p>3、删除此课程的选课记录及订单信息。</p><p>测试流程：</p><p>1、进入课程详细页面，点击马上学习，生成二维码进行支付。</p><p>2、支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p><p>3、观察学习中心服务控制台是否接收到消息。</p><p>4、观察数据库中的消息表的相应记录是否已删除。</p><p>消费重试测试：</p><p>1、在学习中心服务接收支付结果方法中制造异常。</p><p>2、重新执行上边的测试流程，观察是否消费重试。</p><h3 id="5-在线学习"><a href="#5-在线学习" class="headerlink" title="5 在线学习"></a><strong>5 在线学习</strong></h3><h4 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a><strong>5.1 需求分析</strong></h4><p>用户通过课程详情界面点击马上学习 进入 视频插放界面进行视频点播。</p><p>获取视频资源时进行学习资格校验，如下图：</p><p><img src="/breeze/24565a3e/image8-1690175727679-82.png"></p><p>拥有学习资格则继续播放视频，不具有学习资格则引导去购买、续期等操作。</p><p>&#x3D;&#x3D;如何判断是否拥有学习资格？&#x3D;&#x3D;</p><p>首先判断是否为试学视频，如果为试学视频则可以正常学习。</p><p>如果为非试学课程首先判断用户是否登录，如果已登录则判断是否选课，如果已经选课且没有过期可以正常学习。</p><p>详细流程如下图：</p><p><img src="/breeze/24565a3e/image68.png"></p><h4 id="5-2-查询课程信息"><a href="#5-2-查询课程信息" class="headerlink" title="5.2 查询课程信息"></a><strong>5.2 查询课程信息</strong></h4><p>在视频点播页面需要查询课程信息，课程上线后也需要访问&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><p>课程预览时请求获取课程的接口为：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><p>在nginx中进行配置：</p><p>&#x2F;open、&#x2F;api在nginx的配置如下：(已经配置的不要重复配置)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#api</span><br><span class="line">location /api/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">#openapi</span><br><span class="line">location /open/content/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/content/open/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">location /open/media/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/media/open/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><p>下边实现&#x2F;api&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId} 获取课程发布信息接口。</p><p>进入内容管理服务api工程CoursePublishController 类，定义查询课程预览信息接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;获取课程发布信息&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询课程发布信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishService.getCoursePublish(courseId);</span><br><span class="line">    <span class="keyword">if</span> (coursePublish == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDto</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程基本信息</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseBaseInfoDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(coursePublish, courseBase);</span><br><span class="line">    <span class="comment">//课程计划</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplans = JSON.parseArray(coursePublish.getTeachplan(), TeachplanDto.class);</span><br><span class="line">    <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDto</span>();</span><br><span class="line">    coursePreviewInfo.setCourseBase(courseBase);</span><br><span class="line">    coursePreviewInfo.setTeachplans(teachplans);</span><br><span class="line">    <span class="keyword">return</span> coursePreviewInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启内容管理服务，进入学习界面查看课程计划、课程名称等信息是否显示正常。</p><h4 id="5-3-获取视频"><a href="#5-3-获取视频" class="headerlink" title="5.3 获取视频"></a><strong>5.3 获取视频</strong></h4><h5 id="5-3-1-需求分析"><a href="#5-3-1-需求分析" class="headerlink" title="5.3.1 需求分析"></a><strong>5.3.1 需求分析</strong></h5><p><img src="/breeze/24565a3e/image69.png"></p><h5 id="5-3-2-接口定义"><a href="#5-3-2-接口定义" class="headerlink" title="5.3.2 接口定义"></a><strong>5.3.2 接口定义</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.XcUser;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.LearningService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.service.MyCourseTablesService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.util.SecurityUtil;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 学习过程管理接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/2 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;学习过程管理接口&quot;, tags = &quot;学习过程管理接口&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLearningController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LearningService learningService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取视频&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getvideo</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId,<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long teachplanId, <span class="meta">@PathVariable(&quot;mediaId&quot;)</span> String mediaId)</span> &#123;</span><br><span class="line">        <span class="comment">//登录用户</span></span><br><span class="line">        <span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(user != <span class="literal">null</span>)&#123;</span><br><span class="line">            userId = user.getId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取视频</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义service接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcChooseCourseDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.learning.model.dto.XcCourseTablesDto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 学习过程管理service接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/2 16:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LearningService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 获取教学视频</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> teachplanId 课程计划id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaId 视频文件id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.String&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/5 9:08</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getVideo</span><span class="params">(String userId,Long courseId,Long teachplanId,String mediaId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-3-获取视频远程接口"><a href="#5-3-3-获取视频远程接口" class="headerlink" title="5.3.3 获取视频远程接口"></a><strong>5.3.3 获取视频远程接口</strong></h5><p>在学习中心服务service工程中定义媒资管理Feignclient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CoursePublish;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资管理服务远程接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/open/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable(&quot;mediaId&quot;)</span> String mediaId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>FeignClient接口的降级类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.learning.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.po.CoursePublish;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/3 8:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MediaServiceClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(String mediaId)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;远程调用媒资管理服务熔断异常：&#123;&#125;&quot;</span>,throwable.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-4-学习资格校验"><a href="#5-3-4-学习资格校验" class="headerlink" title="5.3.4 学习资格校验"></a><strong>5.3.4 学习资格校验</strong></h5><p>编写获取视频的接口实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getVideo</span><span class="params">(String userId,Long courseId,Long teachplanId, String mediaId)</span> &#123;</span><br><span class="line">    <span class="comment">//查询课程信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursepublish</span> <span class="operator">=</span> contentServiceClient.getCoursepublish(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursepublish==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程信息不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//校验学习资格</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果登录</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(userId))&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否选课，根据选课情况判断学习资格</span></span><br><span class="line">        <span class="type">XcCourseTablesDto</span> <span class="variable">xcCourseTablesDto</span> <span class="operator">=</span> myCourseTablesService.(userId, courseId);</span><br><span class="line">        <span class="comment">//学习资格状态 [&#123;&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;&#125;,&#123;&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;&#125;,&#123;&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;&#125;]</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">learnStatus</span> <span class="operator">=</span> xcCourseTablesDto.getLearnStatus();</span><br><span class="line">        <span class="keyword">if</span>(learnStatus.equals(<span class="string">&quot;702001&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(learnStatus.equals(<span class="string">&quot;702003&quot;</span>))&#123;</span><br><span class="line">            RestResponse.validfail(<span class="string">&quot;您的选课已过期需要申请续期或重新支付&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//未登录或未选课判断是否收费</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">charge</span> <span class="operator">=</span> coursepublish.getCharge();</span><br><span class="line">    <span class="keyword">if</span>(charge.equals(<span class="string">&quot;201000&quot;</span>))&#123;<span class="comment">//免费可以正常学习</span></span><br><span class="line">        <span class="keyword">return</span> mediaServiceClient.getPlayUrlByMediaId(mediaId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RestResponse.validfail(<span class="string">&quot;请购买课程后继续学习&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-5-测试"><a href="#5-3-5-测试" class="headerlink" title="5.3.5 测试"></a><strong>5.3.5 测试</strong></h5><p>1、完善接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;获取视频&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/open/learn/getvideo/&#123;courseId&#125;/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getvideo</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId, <span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long teachplanId, <span class="meta">@PathVariable(&quot;mediaId&quot;)</span> String mediaId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">        userId = user.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取视频</span></span><br><span class="line">    <span class="keyword">return</span> learningService.getVideo(userId, courseId, teachplanId, mediaId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、测试准备</p><p>选课成功一门课程。</p><p>没有选课的免费课程、收费课程各一门，其中收费课程具有试学课程。</p><p>3、测试项目</p><p>1）选课成功的课程是否可以正常获取视频</p><p>2）免费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p><p>3）收费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程id为不存在进行测试，测试完再恢复原样。</p><h4 id="5-4-我的课表"><a href="#5-4-我的课表" class="headerlink" title="5.4 我的课表"></a><strong>5.4 我的课表</strong></h4><h5 id="5-4-1-需求分析"><a href="#5-4-1-需求分析" class="headerlink" title="5.4.1 需求分析"></a><strong>5.4.1 需求分析</strong></h5><h6 id="5-4-1-1-业务流程"><a href="#5-4-1-1-业务流程" class="headerlink" title="5.4.1.1 业务流程"></a><strong>5.4.1.1 业务流程</strong></h6><p>登录网站，点击“我的学习”进入个人中心，</p><p><img src="/breeze/24565a3e/image70.png"></p><p>个人中心首页显示我的课程表：</p><p><img src="/breeze/24565a3e/image71.png"></p><p>我的课表中显示了选课成功的免费课程、收费课程。最近学习课程显示了当前用户最近学习的课程信息。</p><p>点击继续学习进入当前学习章节的视频继续学习。</p><p>点击课程评价进入课程评价界面。</p><h6 id="5-4-1-2-配置nginx"><a href="#5-4-1-2-配置nginx" class="headerlink" title="5.4.1.2 配置nginx"></a><strong>5.4.1.2 配置nginx</strong></h6><p>在nginx配置用户中心server ,如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server <span class="punctuation">&#123;</span></span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  ucenter<span class="number">.51</span>xuecheng.cn;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line">    location / <span class="punctuation">&#123;</span></span><br><span class="line">    alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/ucenter/;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">location /include <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass   http<span class="punctuation">:</span><span class="comment">//127.0.0.1;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">location /img/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass   http<span class="punctuation">:</span><span class="comment">//127.0.0.1/static/img/;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">location /api/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="5-4-2-接口定义"><a href="#5-4-2-接口定义" class="headerlink" title="5.4.2 接口定义"></a><strong>5.4.2 接口定义</strong></h5><p>在MyCourseTablesController中定义我的课程表接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;我的课程表&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/mycoursetable&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycoursetable</span><span class="params">(MyCourseTableParams params)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-3-接口开发"><a href="#5-4-3-接口开发" class="headerlink" title="5.4.3 接口开发"></a><strong>5.4.3 接口开发</strong></h5><h6 id="5-4-3-1DAO"><a href="#5-4-3-1DAO" class="headerlink" title="5.4.3.1DAO"></a><strong>5.4.3.1DAO</strong></h6><p>使用自动生成的mapper即可实现分页查询。</p><h6 id="5-4-3-2-Service"><a href="#5-4-3-2-Service" class="headerlink" title="5.4.3.2 Service"></a><strong>5.4.3.2 Service</strong></h6><p>在service中定义我的课程表接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 我的课程表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.learning.model.po.XcCourseTables&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/27 9:24</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycourestabls</span><span class="params">(MyCourseTableParams params)</span>;</span><br></pre></td></tr></table></figure><p>编写接口实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycourestabls</span><span class="params">( MyCourseTableParams params)</span>&#123;</span><br><span class="line">    <span class="comment">//页码</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">pageNo</span> <span class="operator">=</span> params.getPage();</span><br><span class="line">    <span class="comment">//每页记录数,固定为4</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="comment">//分页条件</span></span><br><span class="line">    Page&lt;XcCourseTables&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageNo, pageSize);</span><br><span class="line">    <span class="comment">//根据用户id查询</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> params.getUserId();</span><br><span class="line">    LambdaQueryWrapper&lt;XcCourseTables&gt; lambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;XcCourseTables&gt;().eq(XcCourseTables::getUserId, userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    Page&lt;XcCourseTables&gt; pageResult = courseTablesMapper.selectPage(page, lambdaQueryWrapper);</span><br><span class="line">    List&lt;XcCourseTables&gt; records = pageResult.getRecords();</span><br><span class="line">    <span class="comment">//记录总数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">    PageResult&lt;XcCourseTables&gt; courseTablesResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(records, total, pageNo, pageSize);</span><br><span class="line">    <span class="keyword">return</span> courseTablesResult;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完善接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;我的课程表&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/mycoursetable&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PageResult&lt;XcCourseTables&gt; <span class="title function_">mycoursetable</span><span class="params">(MyCourseTableParams params)</span> &#123;</span><br><span class="line">    <span class="comment">//登录用户</span></span><br><span class="line">    SecurityUtil.<span class="type">XcUser</span> <span class="variable">user</span> <span class="operator">=</span> SecurityUtil.getUser();</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请登录后继续选课&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//设置当前的登录用户</span></span><br><span class="line">    params.setUserId(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> myCourseTablesService.mycourestabls(params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-4-接口测试"><a href="#5-4-4-接口测试" class="headerlink" title="5.4.4 接口测试"></a><strong>5.4.4 接口测试</strong></h5><p>登录网站，点击“我的学习”进入个人中心，查看我的课程表中课程是否是当前用户所选课程。</p><p><img src="/breeze/24565a3e/image71-1690175740331-88.png"></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/24565a3e.html">https://mliutm.github.io/breeze/24565a3e.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1688475747590-d0db5e2412cb.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/67f5d99d.html" title="学成在线-项目部署模块（七）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">学成在线-项目部署模块（七）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/ef2dc3df.html" title="学成在线-认证授权模块（五）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线-认证授权模块（五）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/ecebeadb.html" title="BIO-NIO-AIO深入剖析"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">BIO-NIO-AIO深入剖析</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/ab319c68.html" title="SpringCloud-Alibaba快速入门"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">SpringCloud-Alibaba快速入门</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3-1"><span class="toc-text">第6章 选课学习v3.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">1 模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1 模块介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-%E5%AD%A6%E4%B9%A0%E5%BC%95%E5%AF%BC"><span class="toc-text">1.2.1 学习引导</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-%E9%80%89%E8%AF%BE%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2.2 选课流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2.3 支付流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-4-%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0"><span class="toc-text">1.2.4 在线学习</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-5-%E5%85%8D%E8%B4%B9%E8%AF%BE%E7%A8%8B%E7%BB%AD%E6%9C%9F"><span class="toc-text">1.2.5 免费课程续期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B7%BB%E5%8A%A0%E9%80%89%E8%AF%BE"><span class="toc-text">2 添加选课</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">2.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">2.1.1 数据模型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">2.1.2 执行流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">2.2 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E9%83%A8%E7%BD%B2%E5%AD%A6%E4%B9%A0%E4%B8%AD%E5%BF%83%E5%B7%A5%E7%A8%8B"><span class="toc-text">2.2.1 部署学习中心工程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E6%B7%BB%E5%8A%A0%E6%9F%A5%E8%AF%A2%E8%AF%BE%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.2 添加查询课程接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E6%B5%8B%E8%AF%95%E6%9F%A5%E8%AF%A2%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.3 测试查询课程信息接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E6%B7%BB%E5%8A%A0%E9%80%89%E8%AF%BE%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.2.4 添加选课接口</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-1-%E6%8E%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="toc-text">2.2.4.1 接口分析</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">2.2.4.2 接口定义</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-3-%E6%B7%BB%E5%8A%A0%E5%85%8D%E8%B4%B9%E8%AF%BE%E7%A8%8B"><span class="toc-text">2.2.4.3 添加免费课程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-4-%E6%B7%BB%E5%8A%A0%E6%88%91%E7%9A%84%E8%AF%BE%E7%A8%8B%E8%A1%A8"><span class="toc-text">2.2.4.4 添加我的课程表</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-5-%E6%B7%BB%E5%8A%A0%E6%94%B6%E8%B4%B9%E8%AF%BE%E7%A8%8B"><span class="toc-text">2.2.4.5 添加收费课程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-6-%E8%8E%B7%E5%8F%96%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%A0%BC"><span class="toc-text">2.2.4.6 获取学习资格</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-7-service%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">2.2.4.7 service接口完善</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-8-%E5%AE%8C%E5%96%84controller"><span class="toc-text">2.2.4.8 完善controller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3 接口测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3.1 单元测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="toc-text">2.3.2 前后端联调</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%94%AF%E4%BB%98"><span class="toc-text">3 支付</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">3.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">3.1.1 执行流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-%E9%80%9A%E7%94%A8%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1"><span class="toc-text">3.1.2 通用订单服务设计</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="toc-text">3.2 支付接口调研</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="toc-text">3.2.1 微信支付接口调研</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-%E6%94%AF%E4%BB%98%E5%AE%9D%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%A0%94"><span class="toc-text">3.2.2 支付宝接口调研</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%87%86%E5%A4%87%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-text">3.3 准备开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-%E6%94%AF%E4%BB%98%E5%AE%9D%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-text">3.3.1 支付宝开发环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.3.2 创建订单服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.4 支付接口测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-%E9%98%85%E8%AF%BB%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">3.4.1 阅读接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-%E4%B8%8B%E5%8D%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">3.4.2 下单执行流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-3-%E6%94%AF%E4%BB%98%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.4.3 支付接口测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-3-1-%E7%BC%96%E5%86%99%E4%B8%8B%E5%8D%95%E4%BB%A3%E7%A0%81"><span class="toc-text">3.4.3.1 编写下单代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-3-2-%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-text">3.4.3.2 生成二维码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-3-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.4.3.3 接口测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-4-%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3"><span class="toc-text">3.4.4 支付结果查询接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-5-%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E6%8E%A5%E5%8F%A3"><span class="toc-text">3.4.5 支付结果通知接口</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-5-1-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text">3.4.5.1 准备环境</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-5-2-%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-text">3.4.5.2 编写测试代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-4-5-3-%E9%80%9A%E7%9F%A5%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.4.5.3 通知接口测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-text">3.5 生成支付二维码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">3.5.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-1-1-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">3.5.1.1 执行流程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-1-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.5.1.2 数据模型</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">3.5.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-3-%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.5.3 接口实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-3-1-%E4%BF%9D%E5%AD%98%E5%95%86%E5%93%81%E8%AE%A2%E5%8D%95"><span class="toc-text">3.5.3.1 保存商品订单</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-3-2-%E5%88%9B%E5%BB%BA%E6%94%AF%E4%BB%98%E4%BA%A4%E6%98%93%E8%AE%B0%E5%BD%95"><span class="toc-text">3.5.3.2 创建支付交易记录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-3-3-%E7%94%9F%E6%88%90%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="toc-text">3.5.3.3 生成支付二维码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-3-4-%E7%94%9F%E6%88%90%E4%BA%8C%E7%BB%B4%E7%A0%81%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">3.5.3.4 生成二维码接口完善</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-5-3-5-%E6%89%AB%E7%A0%81%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">3.5.3.5 扫码下单接口完善</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-4-%E6%94%AF%E4%BB%98%E6%B5%8B%E8%AF%95"><span class="toc-text">3.5.4 支付测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">3.6 查询支付结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">3.6.1 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-2-%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.6.2 接口实现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-6-2-1-service%E6%80%BB%E4%BD%93%E6%8E%A5%E5%8F%A3"><span class="toc-text">3.6.2.1 service总体接口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-6-2-2-%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">3.6.2.2 查询支付结果</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-6-2-3-%E4%BF%9D%E5%AD%98%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">3.6.2.3 保存支付结果</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.6.3 接口测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-text">3.7 接收支付通知</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-7-1-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">3.7.1 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-7-2-%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.7.2 接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-7-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.7.3 接口测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5"><span class="toc-text">4 支付通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">4.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">4.2 技术方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E5%8F%91%E9%80%81%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">4.3 发送支付结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-1-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90MQ"><span class="toc-text">4.3.1 订单服务集成MQ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-2-%E5%8F%91%E9%80%81%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">4.3.2 发送支付结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">4.4 接收支付结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-1-%E5%AD%A6%E4%B9%A0%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90MQ"><span class="toc-text">4.4.1 学习中心服务集成MQ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-2-%E6%8E%A5%E6%94%B6%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C"><span class="toc-text">4.4.2 接收支付结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E9%80%9A%E7%9F%A5%E6%94%AF%E4%BB%98%E7%BB%93%E6%9E%9C%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5 通知支付结果测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0"><span class="toc-text">5 在线学习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E6%9F%A5%E8%AF%A2%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="toc-text">5.2 查询课程信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E8%8E%B7%E5%8F%96%E8%A7%86%E9%A2%91"><span class="toc-text">5.3 获取视频</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.3.1 需求分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.3.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-3-%E8%8E%B7%E5%8F%96%E8%A7%86%E9%A2%91%E8%BF%9C%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="toc-text">5.3.3 获取视频远程接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-4-%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%A0%BC%E6%A0%A1%E9%AA%8C"><span class="toc-text">5.3.4 学习资格校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-5-%E6%B5%8B%E8%AF%95"><span class="toc-text">5.3.5 测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E6%88%91%E7%9A%84%E8%AF%BE%E8%A1%A8"><span class="toc-text">5.4 我的课表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.4.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-1-1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">5.4.1.1 业务流程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-1-2-%E9%85%8D%E7%BD%AEnginx"><span class="toc-text">5.4.1.2 配置nginx</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.4.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">5.4.3 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-3-1DAO"><span class="toc-text">5.4.3.1DAO</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-4-3-2-Service"><span class="toc-text">5.4.3.2 Service</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-4-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.4 接口测试</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>