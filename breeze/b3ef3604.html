<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>SpringCloud-oauth-JWT | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简介 常见的认证授权方案（重要）  Oauth2（重要）  Springcloud oauth2+token（重要）  Springcloud oauth2+jwt（重要）  微服务间的授权（重要）-比较难  服务间临时授权（重要）-比较难  项目实战（重要）   一. 常见的认证授权方案有状态的Session1.1 普通session-全栈不集群项目  1 集群 nok  2 前后端分离没法直接"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud-oauth-JWT"><meta property="og:url" content="https://mliutm.github.io/breeze/b3ef3604.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="简介 常见的认证授权方案（重要）  Oauth2（重要）  Springcloud oauth2+token（重要）  Springcloud oauth2+jwt（重要）  微服务间的授权（重要）-比较难  服务间临时授权（重要）-比较难  项目实战（重要）   一. 常见的认证授权方案有状态的Session1.1 普通session-全栈不集群项目  1 集群 nok  2 前后端分离没法直接"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1645943020355-305df166473d.jpg"><meta property="article:published_time" content="2024-01-14T07:33:00.000Z"><meta property="article:modified_time" content="2024-01-15T12:02:59.439Z"><meta property="article:author" content="清风"><meta property="article:tag" content="oauth2"><meta property="article:tag" content="jwt"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1645943020355-305df166473d.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/b3ef3604.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"SpringCloud-oauth-JWT",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-15 20:02:59"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1645943020355-305df166473d.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud-oauth-JWT</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-14T07:33:00.000Z" title="发表于 2024-01-14 15:33:00">2024-01-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-15T12:02:59.439Z" title="更新于 2024-01-15 20:02:59">2024-01-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E8%83%BD%E6%8F%90%E5%8D%87/">技能提升</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>66分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="SpringCloud-oauth-JWT"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul><li><p>常见的认证授权方案（重要）</p></li><li><p>Oauth2（重要）</p></li><li><p>Springcloud oauth2+token（重要）</p></li><li><p>Springcloud oauth2+jwt（重要）</p></li><li><p>微服务间的授权（重要）-比较难</p></li><li><p>服务间临时授权（重要）-比较难</p></li><li><p>项目实战（重要）</p></li></ul><h1 id="一-常见的认证授权方案"><a href="#一-常见的认证授权方案" class="headerlink" title="一. 常见的认证授权方案"></a>一. 常见的认证授权方案</h1><h2 id="有状态的Session"><a href="#有状态的Session" class="headerlink" title="有状态的Session"></a>有状态的Session</h2><h3 id="1-1-普通session-全栈不集群项目"><a href="#1-1-普通session-全栈不集群项目" class="headerlink" title="1.1 普通session-全栈不集群项目"></a>1.1 普通session-全栈不集群项目</h3><p><img src="/breeze/b3ef3604/image1.png"></p><p><img src="/breeze/b3ef3604/image1-1705316044238-2.png"></p><p>1 集群 nok</p><blockquote><p>2 前后端分离没法直接使用 nok</p></blockquote><p>3 不支持app端 nok</p><h3 id="1-2共享Session-全栈集群"><a href="#1-2共享Session-全栈集群" class="headerlink" title="1.2共享Session-全栈集群"></a>1.2共享Session-全栈集群</h3><h4 id="1-2-1-tomcat-redis-session-manager"><a href="#1-2-1-tomcat-redis-session-manager" class="headerlink" title="1.2.1 tomcat-redis-session-manager"></a>1.2.1 tomcat-redis-session-manager</h4><p><img src="/breeze/b3ef3604/image2.jpeg" alt="IMG_256"></p><p>1 集群 ok</p><blockquote><p>2 前后端分离没法直接使用 nok</p></blockquote><p>3 不支持app端 nok</p><h4 id="1-2-2-Spring-Session"><a href="#1-2-2-Spring-Session" class="headerlink" title="1.2.2 Spring Session"></a>1.2.2 Spring Session</h4><p><img src="/breeze/b3ef3604/image4.png"></p><p>1 集群 ok</p><blockquote><p>2 前后端分离没法直接使用 nok</p></blockquote><p>3 不支持app端 nok</p><h2 id="无状态token"><a href="#无状态token" class="headerlink" title="无状态token"></a>无状态token</h2><p>1集群 ok</p><blockquote><p>2 前后端分离没法直接使用 ok</p></blockquote><p>3 不支持app端 ok</p><h3 id="2-1普通token（redis-key为token值认证和授权信息）-服务端token"><a href="#2-1普通token（redis-key为token值认证和授权信息）-服务端token" class="headerlink" title="2.1普通token（redis key为token值认证和授权信息）-服务端token"></a>2.1普通token（redis key为token值认证和授权信息）-服务端token</h3><p><img src="/breeze/b3ef3604/image5.png"></p><p>每次都要查询redis使用jwt来优化，jwt是一个特殊token，我们可以把用户写入到payload，以后获取jwt，就可以直接解析用户。</p><h3 id="2-2-JwtToken-redis可以不存-客户端token"><a href="#2-2-JwtToken-redis可以不存-客户端token" class="headerlink" title="2.2 JwtToken(redis可以不存)-客户端token"></a>2.2 JwtToken(redis可以不存)-客户端token</h3><p><img src="/breeze/b3ef3604/image6.png"></p><p>Redis只是保存客户端登录状态,但是不需要用户和权限，可以用来做一个账号只能同一类型一个设备登录。</p><h2 id="选型"><a href="#选型" class="headerlink" title="选型"></a>选型</h2><p>我们是前后端分离项目，并且为了效率期间我们使用Jwt Token,当然要想实现Jwt token我们可以自己实现。<strong>也可以使用框架实现。并且我们是在Springcloud中，所有我们直接使用Springcloud oauth2这个框架，不仅支持jwt,还支持Springcloud oauth还是实现三方登录。</strong>接下来我们就先了解oauth2,再来看Springcloud oauth2。</p><h1 id="二-OAUTH2"><a href="#二-OAUTH2" class="headerlink" title="二. OAUTH2"></a>二. OAUTH2</h1><h3 id="什么是Oauth2"><a href="#什么是Oauth2" class="headerlink" title="什么是Oauth2"></a>什么是Oauth2</h3><p>阮一峰 博客： <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html"><em>http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</em></a></p><p>OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。与以往的授权方式不同之处是OAUTH的授权不会使第三方触及到用户的帐号信息（如用户名与密码），即第三方无需使用用户的用户名与密码就可以申请获得该用户资源的授权，因此OAUTH是安全的，oAuth是Open Authorization的简写，目前的版本是2.0版。</p><p>Oauth2是一个三方登录协议（在其他地方登录就不需要登录），并且它的版本是 Oauth的2的版本。</p><p>我们是微服务项目，在一个授权中心登录了，访问其他微服务就不需要登录了。这不就是TMD三方登录。</p><p>单点登录: 偏向于c端,用户呈现.</p><h3 id="为什么需要Oauth2"><a href="#为什么需要Oauth2" class="headerlink" title="为什么需要Oauth2"></a>为什么需要Oauth2</h3><p>以后我们平台的课程等，可能提供给第三方集成。</p><h4 id="传统认知模式"><a href="#传统认知模式" class="headerlink" title="传统认知模式"></a>传统认知模式</h4><p><img src="/breeze/b3ef3604/image7.png"></p><p>三方平台需要获取账号和密码，如果三方平台被黑，导致账号不安全。</p><h4 id="Oauth2授权码模式"><a href="#Oauth2授权码模式" class="headerlink" title="Oauth2授权码模式"></a>Oauth2授权码模式</h4><p><img src="/breeze/b3ef3604/image8.png"></p><h3 id="Oauth2授权模式"><a href="#Oauth2授权模式" class="headerlink" title="Oauth2授权模式"></a>Oauth2授权模式</h3><h4 id="Oauth2相关概念"><a href="#Oauth2相关概念" class="headerlink" title="Oauth2相关概念"></a>Oauth2相关概念</h4><ul><li>Third-party application</li></ul><p>第三方应用程序，本文中又称”客户端”（client），即栗子中的”云打印”。</p><ul><li>HTTP service</li></ul><p>HTTP服务提供商，本文中简称”服务提供商”，即上一节例子中的QQ。</p><ul><li>Resource Owner</li></ul><p>资源所有者，本文中又称”用户”（user）。</p><ul><li>User Agent</li></ul><p>用户代理，如浏览器,移动端等。</p><ul><li>Authorization server</li></ul><p>认证服务器，即服务提供商专门用来处理认证的服务器QQ。</p><ul><li>Resource server</li></ul><p>资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器QQ</p><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a></p><p>或见“理解OAuth 2.0 - 阮一峰的网络日志.pdf”</p><p>客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。OAuth 2.0定义了四种授权方式。</p><h4 id="3-1-授权码模式（authorization-code）-微信登录"><a href="#3-1-授权码模式（authorization-code）-微信登录" class="headerlink" title="3.1.授权码模式（authorization code）-微信登录"></a>3.1.授权码模式（authorization code）-微信登录</h4><p>授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的认授权流程如下：</p><p><img src="/breeze/b3ef3604/image9.png" alt="IMG_256"></p><ul><li>授权流程：</li></ul><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="variable">A</span>）用户访问客户端，后者将前者导向认证服务器。</span><br><span class="line">（<span class="variable">B</span>）用户选择是否给予客户端授权。</span><br><span class="line">（<span class="built_in">C</span>）假设用户给予授权，认证服务器将用户导向客户端事先指定的<span class="string">&quot;重定向URI&quot;</span>（<span class="variable">redirection</span> <span class="variable">URI</span>），同时附上一个授权码。</span><br><span class="line">（<span class="built_in">D</span>）客户端收到授权码，附上早先的<span class="string">&quot;重定向URI&quot;</span>，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</span><br><span class="line">（<span class="built_in">E</span>）认证服务器核对了授权码和重定向<span class="variable">URI</span>，确认无误后，向客户端发送访问令牌（<span class="variable">access</span> <span class="variable">token</span>）和更新令牌（<span class="variable">refresh</span> <span class="variable">token</span>）。</span><br></pre></td></tr></table></figure><ul><li>下面是上面这些步骤所需要的参数。</li></ul><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">A步骤中，客户端申请认证的URI，包含以下参数：</span><br><span class="line">response_type：表示授权类型，必选项，此处的值固定为<span class="string">&quot;code&quot;</span></span><br><span class="line">client_id：表示客户端的ID，必选项</span><br><span class="line">redirect_uri：表示重定向URI，可选项</span><br><span class="line">scope：表示申请的权限范围，可选项</span><br><span class="line">state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。</span><br><span class="line">获取授权码如:</span><br><span class="line">/authorize?response_type<span class="operator">=</span>code&amp;client_id<span class="operator">=</span>s<span class="number">6</span>BhdRkqt<span class="number">3</span>&amp;state<span class="operator">=</span>xyz&amp;redirect_uri<span class="operator">=</span>https<span class="variable">%3</span>A<span class="variable">%2</span>F<span class="variable">%2</span>Fclient<span class="variable">%2</span>Eexample<span class="variable">%2</span>Ecom<span class="variable">%2</span>Fcb HTTP/<span class="number">1.1</span>Host: server.example.com</span><br><span class="line">D步骤中，客户端向认证服务器申请令牌的HTTP请求，包含以下参数：</span><br><span class="line">grant_type：表示使用的授权模式，必选项，此处的值固定为<span class="string">&quot;authorization_code&quot;</span>。</span><br><span class="line">code：表示上一步获得的授权码，必选项。</span><br><span class="line">redirect_uri：表示重定向URI，必选项，且必须与A步骤中的该参数值保持一致。</span><br><span class="line">client_id：表示客户端ID，必选项。</span><br><span class="line">获取令牌如：</span><br><span class="line">grant_type<span class="operator">=</span>authorization_code&amp;code<span class="operator">=</span>SplxlOBeZQQYbYS<span class="number">6</span>WxSbIA</span><br><span class="line">&amp;redirect_uri<span class="operator">=</span>https<span class="variable">%3</span>A<span class="variable">%2</span>F<span class="variable">%2</span>Fclient<span class="variable">%2</span>Eexample<span class="variable">%2</span>Ecom<span class="variable">%2</span>Fcb</span><br></pre></td></tr></table></figure><p>三方系统</p><h4 id="3-2-简化模式（implicit）-基本不用-不安全-也没那么简单"><a href="#3-2-简化模式（implicit）-基本不用-不安全-也没那么简单" class="headerlink" title="3.2.简化模式（implicit）-基本不用,不安全,也没那么简单"></a>3.2.简化模式（implicit）-基本不用,不安全,也没那么简单</h4><p>简化模式（implicit grant type）不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了”授权码”这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。</p><p><img src="/breeze/b3ef3604/image10.png" alt="IMG_256"></p><p><strong>自家系统</strong></p><h4 id="3-3-密码模式（resource-owner-password-credentials）-qq三方登录"><a href="#3-3-密码模式（resource-owner-password-credentials）-qq三方登录" class="headerlink" title="3.3.密码模式（resource owner password credentials） qq三方登录"></a>3.3.密码模式（resource owner password credentials） qq三方登录</h4><p>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</p><p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p><p><img src="/breeze/b3ef3604/image11.png" alt="IMG_256"></p><h4 id="3-4-客户端模式（client-credentials）"><a href="#3-4-客户端模式（client-credentials）" class="headerlink" title="3.4.客户端模式（client credentials）"></a>3.4.客户端模式（client credentials）</h4><p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。</p><p><img src="/breeze/b3ef3604/image12.png" alt="IMG_256"></p><h1 id="三-Spring-Cloud-OAUTH2"><a href="#三-Spring-Cloud-OAUTH2" class="headerlink" title="三. Spring Cloud OAUTH2"></a>三. Spring Cloud OAUTH2</h1><p>Spring Cloud OAUTH2是一个实现了OAUTH2协议产品，并且默认他是基于Spring Security实现。你可以这样理解Spring Security提供了基本认证与授权，Spring Cloud OAUTH2对它进行了封装，让他支持OAUTH2协议的认证与授权。</p><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><h4 id="1-1-Springcloud-Oauth2介绍"><a href="#1-1-Springcloud-Oauth2介绍" class="headerlink" title="1.1.Springcloud-Oauth2介绍"></a>1.1.Springcloud-Oauth2介绍</h4><p>Springcloud Oauth2实现了Oatuh2，Spingcloud Oauth2分为两个大块，一者为认证授权(Authorization Server)服务和资源服务(Resource server)，认证授权服务一般负责执行认证逻辑(登录)和加载用户的权限(给用户授权)，以及认证成功后的令牌颁发 ，而资源服务器一般指的是我们系统中的微服务(被访问的微服务)，在资源服务器需要对用户的令牌(认证成功与否)，以及授权(是不是有访问权限)做检查 。</p><h4 id="1-2-Oauth2认证解决方案"><a href="#1-2-Oauth2认证解决方案" class="headerlink" title="1.2.Oauth2认证解决方案"></a>1.2.Oauth2认证解决方案</h4><p>这里我们需要准备四个服务，1.授权服务 2.资源服务，3.网关，4注册中心，一共4个服务。授权服务和资源服务的流程图： 本来就有这个环境，不需要搭建</p><p><img src="/breeze/b3ef3604/image13.png"></p><p>认证授权服务：可以单独搞一个</p><p><img src="/breeze/b3ef3604/image14.png" alt="1574947164373"></p><p>我们这里以Oauth2授权码模式为例</p><h3 id="2-环境准备-略过直接在项目中"><a href="#2-环境准备-略过直接在项目中" class="headerlink" title="2.环境准备-略过直接在项目中"></a>2.环境准备-略过直接在项目中</h3><p>注意：没有SpringCloud基础的同学先去学SpringCloud</p><p>搭建基本项目结构如下</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">security-parent  <span class="comment">//父工程</span></span><br><span class="line">    security-auth-<span class="keyword">server</span>  <span class="comment">//统一认证微服务</span></span><br><span class="line">    security-eureka-<span class="keyword">server</span>  <span class="comment">//注册中心</span></span><br><span class="line">    security-resource-<span class="keyword">server</span>  <span class="comment">//资源微服务</span></span><br><span class="line">    security-zuul-<span class="keyword">server</span>  <span class="comment">//网关</span></span><br></pre></td></tr></table></figure><h4 id="2-1-搭建父工程"><a href="#2-1-搭建父工程" class="headerlink" title="2.1.搭建父工程"></a>2.1.搭建父工程</h4><p>管理SpringBoot和SpringCloud相关依赖，管理公共依赖，以及依赖版本统一管理</p><ul><li>Pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Finchley.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2搭建EurekaServer注册中心"><a href="#2-2搭建EurekaServer注册中心" class="headerlink" title="2.2搭建EurekaServer注册中心"></a>2.2搭建EurekaServer注册中心</h4><p>微服务注册中心服务</p><ul><li>Pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>启动类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span> <span class="comment">#禁用注册中心向自己注册</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span>  <span class="comment">#不让注册中心获取服务的注册列表</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span></span><br><span class="line">      <span class="comment">#注册中心的注册地址 ，其他微服务需要向这个地址注册</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="搭建ZuulServer网关微服务"><a href="#搭建ZuulServer网关微服务" class="headerlink" title="搭建ZuulServer网关微服务"></a>搭建ZuulServer网关微服务</h4><p>微服务统一访问入口，后面实现统一鉴权操作。</p><ul><li>Pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>启动类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">zuul-server:2000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">&quot;*&quot;</span>   <span class="comment">#禁止使用服务名字进行访问</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">&quot;/servers&quot;</span>  <span class="comment">#统一的前缀</span></span><br><span class="line">  <span class="attr">routes:</span> <span class="comment">#配置路由，指定服务的访问路径</span></span><br><span class="line">    <span class="attr">resource1-server:</span> <span class="string">&quot;/resources/**&quot;</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-server</span></span><br></pre></td></tr></table></figure><h4 id="2-4-搭建AuthServer认证授权微服务"><a href="#2-4-搭建AuthServer认证授权微服务" class="headerlink" title="2.4.搭建AuthServer认证授权微服务"></a>2.4.搭建AuthServer认证授权微服务</h4><p>认证微服务，实现认证逻辑，用户授权，令牌颁发等</p><ol><li>导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>配置类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(AuthServerApplication.class) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>yml配置</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">auth-server:3000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-server</span></span><br></pre></td></tr></table></figure><h4 id="2-5-搭建ResourceServer资源微服务"><a href="#2-5-搭建ResourceServer资源微服务" class="headerlink" title="2.5.搭建ResourceServer资源微服务"></a>2.5.搭建ResourceServer资源微服务</h4><p>资源服务(用户，订单，支付等都是资源服务)，需要对用户的请求进行鉴权成功后才能访问。</p><ol><li>导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>配置类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Resource1ServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Resource1ServerApplication.class) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>yml配置</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">resource1-server:4000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resource1-server</span></span><br></pre></td></tr></table></figure><p>启动测试<a target="_blank" rel="noopener" href="http://localhost:1000/">http://localhost:1000/</a></p><p><img src="/breeze/b3ef3604/image15.png"></p><h3 id="3-认证服务AuthServer搭建-直接从这儿开始做-gift-auth"><a href="#3-认证服务AuthServer搭建-直接从这儿开始做-gift-auth" class="headerlink" title="3.认证服务AuthServer搭建-直接从这儿开始做(gift-auth)"></a>3.认证服务AuthServer搭建-直接从这儿开始做(gift-auth)</h3><p>在搭建好的 security-auth-server工程 ， 集成MyBatis，security和oauth2</p><h4 id="集成MyBatis"><a href="#集成MyBatis" class="headerlink" title="集成MyBatis"></a><del>集成MyBatis</del></h4><ul><li><p>完成User，Role,Permission的domain,mapper映射器，Mapper.xml等相关组件的创建</p></li><li><p>Pom.xml : 需要集成Oauth2,Security,Mybatis ， 增加如下依赖：</p></li></ul><p>[</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mysql 数据库驱动. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>主启动类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;cn.ronghuanet.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(AuthServerApplication.class) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>配置文件：集成EurekaClient,Mybatis</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">auth-server:3000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:cn/mliutm/mapper/*Mapper.xml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql:///auth-rbac</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-server</span></span><br></pre></td></tr></table></figure><h4 id="AuthServer支持Spring-security"><a href="#AuthServer支持Spring-security" class="headerlink" title="AuthServer支持Spring security"></a>AuthServer支持Spring security</h4><h5 id="3-2-1定义UserDetailsService"><a href="#3-2-1定义UserDetailsService" class="headerlink" title="3.2.1定义UserDetailsService"></a>3.2.1定义UserDetailsService</h5><p>复写loadUserByUsername，根据用户名从数据库中获取认证的用户对象，并且加载用户的权限信息，把用户的认证信息和权限信息封装成UserDetaials返回。</p><p>在前面的章节已经学习过UserDetailsService的配置这里不在赘述配置如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.userdetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.Permission;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.User;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.mapper.PermissionMapper;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCrypt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionMapper permissionMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载数据库中的认证的用户的信息：用户名，密码，用户的权限列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username: 该方法把username传入进来，</span></span><br><span class="line"><span class="comment">        我们通过username查询用户的信息(密码，权限列表等)</span></span><br><span class="line"><span class="comment">        然后封装成 UserDetails进行返回 ，交给security 。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">//User是security内部的对象，UserDetails的实现类 ，</span></span><br><span class="line">        <span class="comment">//用来封装用户的基本信息（用户名，密码，权限列表）</span></span><br><span class="line">        <span class="comment">//public User(String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        userFromDB = userMapper.selectByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> == userFromDB)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;无效的用户&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//模拟存储在数据库的用户的密码：123</span></span><br><span class="line">        <span class="comment">//String password = passwordEncoder.encode(&quot;123&quot;);</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userFromDB.getPassword();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户的权限</span></span><br><span class="line">        List&lt;Permission&gt; permission = permissionMapper.selectPermissionsByUserId(userFromDB.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用户的权限列表,暂时为空</span></span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        permission.forEach(e-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户：&quot;</span>+userFromDB.getUsername()+<span class="string">&quot; 加载权限：&quot;</span>+e.getExpression());</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(e.getExpression()));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        org.springframework.security.core.userdetails.<span class="type">User</span>  <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.core.userdetails.User (username,password, authorities);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>认证服务在处理认证逻辑的时候会通过该userDetailService加载用户在数据库中的认证信息实现身份认证，同时在整个方法中也加载了用户的权限列表，后续当用户发起对资源服务的访问时，是否能够授权成功就跟用户的权限列表息息相关了。</p><h5 id="3-2-2-spring-security配置"><a href="#3-2-2-spring-security配置" class="headerlink" title="3.2.2.spring security配置"></a>3.2.2.spring security配置</h5><p>在前面的章节已经学习过WebSecurity的配置这里不在赘述，配置如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Security配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity(debug = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码 编码器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//授权规则配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        http.csrf().disable()   <span class="comment">//屏蔽跨域防护</span></span><br><span class="line">            .authorizeRequests()          <span class="comment">//对请求做授权处理</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/login&quot;</span>).permitAll()  <span class="comment">//登录路径放行</span></span><br><span class="line">            <span class="comment">// .antMatchers(&quot;/login.html&quot;).permitAll()//对登录页面跳转路径放行</span></span><br><span class="line">            .anyRequest().authenticated() <span class="comment">//其他路径都要拦截</span></span><br><span class="line">            .and().formLogin()  <span class="comment">//允许表单登录， 设置登陆页</span></span><br><span class="line">            .successForwardUrl(<span class="string">&quot;/loginSuccess&quot;</span>) <span class="comment">// 设置登陆成功页（对应//controller），一定要有loginSuccess这个路径</span></span><br><span class="line">            .and().logout().permitAll();    <span class="comment">//登出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置认证管理器，授权模式为“poassword”时会用到</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><font color="red">注意：loginSuccess需要对应一个controller</font></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loginSuccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loginSuccess</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;登錄成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：<a target="_blank" rel="noopener" href="http://localhost:3000/login">http://localhost:3000/login</a></p><h4 id="3-4-AuthorizationServer-授权服务配置"><a href="#3-4-AuthorizationServer-授权服务配置" class="headerlink" title="3.4.AuthorizationServer-授权服务配置"></a>3.4.AuthorizationServer-授权服务配置</h4><h5 id="1-授权服务配置类-AuthorizationServerConfigurerAdapter"><a href="#1-授权服务配置类-AuthorizationServerConfigurerAdapter" class="headerlink" title="1.授权服务配置类-AuthorizationServerConfigurerAdapter"></a>1.授权服务配置类-AuthorizationServerConfigurerAdapter</h5><p>SpringSecurityOauth2提供了AuthorizationServerConfigurerAdapter适配器类来作为认证授权服务的配置,其中有三个方法源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span>  &#123;</span><br><span class="line">    <span class="comment">//客户端详情：配置客户端请求的参数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span>...	</span><br><span class="line"><span class="comment">//授权服务端点：配置授权码和令牌的管理/存储方式</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span>...</span><br><span class="line">    <span class="comment">//授权服务安全配置：配置哪些路径放行(检查token的路径要放行)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>作用分别如下：</p><ul><li><p>ClientDetailsServiceConfigurer ：用来配置客户端详情服务：如配置客户端id(client_id)资源id、客户端密钥(secrect)、授权方式、scope等,可以基于内存或jdbc。(可以理解为是对浏览器向授权服务器获取授权码或令牌时需要提交的参数配置)</p></li><li><p>AuthorizationServerEndpointsConfigurer:配置令牌的访问端点url和令牌服务，如配置如何管理授权码(内存或jdbc)，如何管理令牌(存储方式，有效时间等等)</p></li><li><p>AuthorizationServerSecurityConfigurer: 用来配置令牌端点的安全约束，如配置对获取授权码，检查token等某些路径进行放行</p><p><strong>授权服务配置分析</strong></p><p><img src="/breeze/b3ef3604/image16.png"></p><p><img src="/breeze/b3ef3604/image17.png"></p></li></ul><p><strong>定义配置类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//授权服务配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//开启授权服务配置</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="授权服务配置-客户端详情"><a href="#授权服务配置-客户端详情" class="headerlink" title="授权服务配置-客户端详情"></a>授权服务配置-客户端详情</h5><p><img src="/breeze/b3ef3604/image18.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一.客户端详情配置=================================================================================</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.定义客户端详情服务，基于数据库,自动加载oauth_client_details表中的数据</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ClientDetailsService  <span class="title function_">clientDetailsService</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">JdbcClientDetailsService</span> <span class="variable">jdbcClientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">    <span class="comment">//数据库的secret秘钥是密文</span></span><br><span class="line">    jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">    <span class="keyword">return</span> jdbcClientDetailsService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    clients.withClientDetails(clientDetailsService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ClientDetailsServiceConfigurer 是这对于客户端详情的配置，我们通过withClientDetails关联一个JdbcClientDetailsService，默认会去找数据库中的名字为 oauth_client_details 表中的数据作为客户端详情的配置，见 JdbcClientDetailsService类的源代码，所以我们需要在数据库执行以下sql创建表：并填充好数据</p><p><img src="/breeze/b3ef3604/image19.png"></p><p>因为在jdbcClientDetailsService设置了setPasswordEncoder(passwordEncoder);，所以数据库中的client_secret需要是密文加密的，加密如：BCrypt.hashpw(“secret”, BCrypt.gensalt())</p><p>oauth_client_details解释：</p><table><thead><tr><th>字段名</th><th>字段约束</th><th>详细描述</th><th>范例</th></tr></thead><tbody><tr><td>client_id</td><td>主键，必须唯一，不能为空</td><td>用于唯一标识每一个客户端(client)；注册时必须填写(也可以服务端自动生成)，这个字段是必须的，实际应用也有叫app_key</td><td>OaH1heR2E4eGnBr87Br8FHaUFrA2Q0kE8HqZgpdg8Sw</td></tr><tr><td>resource_ids</td><td>不能为空，用逗号分隔</td><td>客户端能访问的资源id集合，注册客户端时，根据实际需要可选择资源id，也可以根据不同的额注册流程，赋予对应的额资源id</td><td>order-resource,pay-resource</td></tr><tr><td>client_secret</td><td>必须填写</td><td>注册填写或者服务端自动生成，实际应用也有叫app_secret, 必须要有前缀代表加密方式</td><td>{bcrypt}gY&#x2F;Hauph1tqvVWiH4atxteSH8sRX03IDXRIQi03DVTFGzKfz8ZtGi</td></tr><tr><td>scope</td><td>不能为空，用逗号分隔</td><td>指定client的权限范围，比如读写权限，比如移动端还是web端权限</td><td>read,write &#x2F; web,mobile</td></tr><tr><td>authorized_grant_types</td><td>不能为空</td><td>可选值 授权码模式:authorization_code,密码模式:password,刷新token: refresh_token, 隐式模式: implicit: 客户端模式: client_credentials。支持多个用逗号分隔</td><td>implicit”,”client_credentials”,”password”, “authorization_code”, “refresh_token”</td></tr><tr><td>web_server_redirect_uri</td><td>可为空</td><td>客户端重定向uri，authorization_code和implicit需要该值进行校验，注册时填写，</td><td><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=httt://baidu.com">httt:&#x2F;&#x2F;baidu.com</a></td></tr><tr><td>authorities</td><td>可为空</td><td>指定用户的权限范围，如果授权的过程需要用户登陆，该字段不生效，implicit和client_credentials需要</td><td>ROLE_ADMIN,ROLE_USER</td></tr><tr><td>access_token_validity</td><td>可空</td><td>设置access_token的有效时间(秒),默认(606012,12小时)</td><td>3600</td></tr><tr><td>refresh_token_validity</td><td>可空</td><td>设置refresh_token有效期(秒)，默认(606024*30, 30填)</td><td>7200</td></tr><tr><td>additional_information</td><td>可空</td><td>附加数据，值必须是json格式</td><td>{“key”, “value”}</td></tr><tr><td>autoapprove</td><td>false&#x2F;true&#x2F;read&#x2F;write</td><td>默认false,适用于authorization_code模式,设置用户是否自动approval操作,设置true跳过用户确认授权操作页面，直接跳到redirect_uri</td><td>false</td></tr></tbody></table><p>客户端请求授权码url如：</p><table><thead><tr><th></th></tr></thead><tbody><tr><td><a target="_blank" rel="noopener" href="http://localhost:3000/oauth/authorize?client_id=webapp&response_type=code&redirect_uri=http://www.baidu.com">http://localhost:3000/oauth/authorize?client_id=webapp&amp;response_type=code&amp;redirect_uri=http://www.baidu.com</a></td></tr></tbody></table><h5 id="3-授权服务配置-配置令牌和授权码"><a href="#3-授权服务配置-配置令牌和授权码" class="headerlink" title="3.授权服务配置-配置令牌和授权码"></a>3.授权服务配置-配置令牌和授权码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//二.授权服务端点配置==============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    endpoints</span><br><span class="line">        <span class="comment">//1.密码授权模式需要</span></span><br><span class="line">        .authenticationManager(authenticationManager)</span><br><span class="line">        <span class="comment">//2.授权码模式服务</span></span><br><span class="line">        .authorizationCodeServices(authorizationCodeServices())</span><br><span class="line">        <span class="comment">//3.配置令牌管理服务</span></span><br><span class="line">        .tokenServices(tokenService())</span><br><span class="line">        <span class="comment">//允许post方式请求</span></span><br><span class="line">        .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//授权码的管理服务 ,默认读取 oauth_code表</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthorizationCodeServices <span class="title function_">authorizationCodeServices</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcAuthorizationCodeServices</span>(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//令牌的管理服务</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenService</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//创建默认的令牌服务</span></span><br><span class="line">    <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">    <span class="comment">//指定客户端详情配置</span></span><br><span class="line">    services.setClientDetailsService(clientDetailsService());</span><br><span class="line">    <span class="comment">//支持产生刷新token</span></span><br><span class="line">    services.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//token存储方式</span></span><br><span class="line">    services.setTokenStore(tokenStore());</span><br><span class="line">    <span class="keyword">return</span> services;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//基于内存的Token存储</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryTokenStore</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AuthorizationServerEndpointsConfigurer是针对于授权服务的端点配置，主要是配置授权码和令牌该如何管理</p><p><strong>API介绍：</strong></p><ul><li><p>AuthenticationManager</p><p>认证管理器“password”模式会用到认证管理器</p></li><li><p>TokenStore : token存储方式</p><p>该接口提供了三个默认实现：InMemoryTokenStore基于存储的token存储方案，</p><p>JdbcTokenStore基于数据库的token存储方案，JwtToeknStore基于JWT的存储方案</p></li><li><p>AuthorizationCodeServices</p><p>授权码服务，提供了InMemoryAuthorizationCodeServices基于内存和基于数据库 JdbcAuthorizationCodeServices的授权码存储方案，JdbcAuthorizationCodeServices 是基于数据库的存储方案，所以要导入授权码SQL脚本,JdbcAuthorizationCodeServices 默认读取数据库中的 oauth_code 表中的数据作为授权码的存储表</p></li><li><p>AuthorizationServerTokenServices</p><p>该接口用来配置授权服务器令牌，如配置是否支持Token,Token的存储方式(内 存,jdbc,),token加密，token过期等</p></li></ul><h5 id="4-授权服务配置-端点安全配置"><a href="#4-授权服务配置-端点安全配置" class="headerlink" title="4.授权服务配置-端点安全配置"></a>4.授权服务配置-端点安全配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//三.授权服务安全配置===========================================================@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    security</span><br><span class="line">            <span class="comment">//对应k/oauth/check_toen ，路径公开</span></span><br><span class="line">            .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">            <span class="comment">//允许客户端进行表单身份验证,使用表单认证申请令牌</span></span><br><span class="line">            .allowFormAuthenticationForClients();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AuthorizationServerSecurityConfigurer:用来配置令牌端点的安全策略，我们对&#x2F;oauth&#x2F;token_key端点和&#x2F;oauth&#x2F;check_token端点进行公开，目的是后续资源服务需要通过该端点进行远程校验Token。</p><p><strong>配置总结</strong></p><p>授权服务配置了三个东西</p><ul><li><p>ClientDetailsServiceConfigurer :配置客户端信息，如同做微信登录的时候获取授权码和令牌时需要传入很多的参数，这些参数就是客户端详情配置的参数</p></li><li><p>AuthorizationServerEndpointsConfigurer:配置token相关端点，以及token如何存取，以及客户端支持哪些类型token</p></li><li><p>AuthorizationServerSecurityConfigurer:配置了端点就要对端点配置约束</p></li></ul><p><strong>Oauth2授权服务配置最佳实践</strong></p><ul><li>创建配置类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.client.JdbcClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.code.AuthorizationCodeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.AuthorizationServerTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">//授权服务配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//开启授权服务配置</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//1.客户端详情配置==============================</span></span><br><span class="line">    <span class="comment">//数据源</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource ;</span><br><span class="line">    <span class="comment">//编码器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="comment">//1.1.定义ClientDetailsService 客户端详情配置服务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ClientDetailsService <span class="title function_">clientDetailsService</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//JdbcClientDetailsService的作用是去数据库加载客户端配置，加载表 oauth_client_details</span></span><br><span class="line">        <span class="type">JdbcClientDetailsService</span> <span class="variable">jdbcClientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">        <span class="keyword">return</span> jdbcClientDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.2.配置客户端详情</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ClientDetailsService:就是提供客户端详情配置的一个服务</span></span><br><span class="line">        clients.withClientDetails(clientDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.服务端点：授权码，令牌管理配置======================</span></span><br><span class="line">    <span class="comment">//2.1.认证管理器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="comment">//2.2.定义 JdbcAuthorizationCodeServices 授权码的服务，基于数据库存储</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationCodeServices  <span class="title function_">authorizationCodeServices</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcAuthorizationCodeServices</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.3.定义AuthorizationServerTokenServices ，令牌的服务配置</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenService</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建默认的令牌服务</span></span><br><span class="line">        <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">        <span class="comment">//指定客户端详情配置</span></span><br><span class="line">        services.setClientDetailsService(clientDetailsService());</span><br><span class="line">        <span class="comment">//支持产生刷新token</span></span><br><span class="line">        services.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//token存储方式</span></span><br><span class="line">        services.setTokenStore(tokenStore());</span><br><span class="line">        <span class="keyword">return</span> services;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.4.配置令牌的存储</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryTokenStore</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.5.配置授权码和令牌端点服务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints</span><br><span class="line">            <span class="comment">//密码授权模式需要</span></span><br><span class="line">            .authenticationManager(authenticationManager)</span><br><span class="line">            <span class="comment">//授权码模式服务</span></span><br><span class="line">            .authorizationCodeServices(authorizationCodeServices())</span><br><span class="line">            <span class="comment">//配置令牌管理服务</span></span><br><span class="line">            .tokenServices(tokenService())</span><br><span class="line">            <span class="comment">//允许post方式请求</span></span><br><span class="line">            .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.授权服务安全配置，url是否放行等==============================    @Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        security</span><br><span class="line">            <span class="comment">//对应/oauth/token_key 公开</span></span><br><span class="line">            .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">            <span class="comment">//对应/oauth/check_token ，路径公开</span></span><br><span class="line">            .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">            <span class="comment">//允许客户端进行表单身份验证,使用表单认证申请令牌</span></span><br><span class="line">            .allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>创建客户端详情配置表SQL</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_client_details`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_client_details` (</span><br><span class="line">    `client_id` <span class="type">varchar</span>(<span class="number">48</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_ids` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `client_secret` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `authorized_grant_types` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `web_server_redirect_uri` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `authorities` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `access_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `refresh_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `additional_information` <span class="type">varchar</span>(<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `autoapprove` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`client_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;`	</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;webapp&#x27;</span>, <span class="string">&#x27;res1&#x27;</span>, <span class="string">&#x27;$2a$10$GPHeNpkKAUJDJcC2XafjkuTyh/P01s2ZoIu0/IsPs6WcXtnv8LNgm&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;client_credentials,password,authorization_code,refresh_token&#x27;</span>, <span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;7200&#x27;</span>, <span class="string">&#x27;72000&#x27;</span>, <span class="keyword">null</span>, <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;webapp2&#x27;</span>, <span class="string">&#x27;res2&#x27;</span>, <span class="string">&#x27;$2a$10$GPHeNpkKAUJDJcC2XafjkuTyh/P01s2ZoIu0/IsPs6WcXtnv8LNgm&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;client_credentials,password,authorization_code,refresh_token&#x27;</span>, <span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;7200&#x27;</span>, <span class="string">&#x27;72000&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);	</span><br></pre></td></tr></table></figure><ul><li>创建授权码SQL</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_code`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_code` (</span><br><span class="line">    `code` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;授权码(未加密)&#x27;</span>,</span><br><span class="line">    `authentication` <span class="type">varbinary</span>(<span class="number">5000</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;AuthorizationRequestHolder.java对象序列化后的二进制数据&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><h4 id="3-5-授权测试"><a href="#3-5-授权测试" class="headerlink" title="3.5.授权测试"></a>3.5.授权测试</h4><h5 id="3-5-1-授权码方式获取Token"><a href="#3-5-1-授权码方式获取Token" class="headerlink" title="3.5.1.授权码方式获取Token"></a>3.5.1.授权码方式获取Token</h5><p>先进行登录</p><p><img src="/breeze/b3ef3604/image20.png"></p><p>第一步，通过浏览器获取授权码，GET访问：</p><blockquote><p><a target="_blank" rel="noopener" href="http://localhost:1100/oauth/authorize?client_id=webapp2&response_type=code&redirect_uri=http://www.baidu.com">http://localhost:1100/oauth/authorize?client_id=webapp2&amp;response_type=code&amp;redirect_uri=http://www.baidu.com</a> ，操作如下：<img src="/breeze/b3ef3604/wps3.jpg" alt="img"> <img src="/breeze/b3ef3604/wps4.jpg" alt="img"></p></blockquote><p>第二步使用Postmain获取令牌，Post访问：</p><blockquote><p>Url: <a target="_blank" rel="noopener" href="http://localhost:3000/oauth/token">http://localhost:1100/oauth/token</a>?client_id&#x3D;webapp2&amp;client_secret&#x3D;123&amp;grant_type&#x3D;authorization_code&amp;code&#x3D;gD8ZbB&amp;redirect_uri&#x3D;<a target="_blank" rel="noopener" href="http://www.baidu.com/">http://www.baidu.com</a> ，操作如下：<img src="/breeze/b3ef3604/wps6.jpg" alt="img"></p></blockquote><p>可以看到这里已经获取到令牌，授权服务的配置暂时告一段落,后续我们就可以带着令牌访问资源服务</p><p>注意：内容格式为“x-www-form-urlencoded”</p><p><a target="_blank" rel="noopener" href="http://localhost:3000/oauth/check_token?token=token%E5%80%BC">http://localhost:3000/oauth/check_token?token=token值</a></p><p><img src="/breeze/b3ef3604/image24.png"></p><h5 id="3-5-2-密码授权模式"><a href="#3-5-2-密码授权模式" class="headerlink" title="3.5.2.密码授权模式"></a>3.5.2.密码授权模式</h5><p>在授权服务中我们配置了”password”密码模式,”authorization_code”授权码模式两种方式，接下来是测试“password”模式获取，将grant_type修改为“password” 添加username和password两个参数，去掉code参数</p><p><a target="_blank" rel="noopener" href="http://localhost:4020/oauth/token?client_id=admin&client_secret=1&grant_type=password&username=18244444444&password=123456">http://localhost:4020/oauth/token?client_id=admin&amp;client_secret=1&amp;grant_type=password&amp;username=18244444444&amp;password=123456</a></p><p><img src="/breeze/b3ef3604/image25.png"></p><h5 id="3-5-3-刷新token"><a href="#3-5-3-刷新token" class="headerlink" title="3.5.3.刷新token"></a>3.5.3.刷新token</h5><p><a target="_blank" rel="noopener" href="http://localhost:3000/oauth/token">http://localhost:3000/oauth/token</a>?grant_type&#x3D;refresh_token&amp;refresh_token&#x3D;刷新Token值&amp;client_id&#x3D;webapp&amp;client_secret&#x3D;secret</p><h3 id="4-资源服务搭建-gift-sysmanage-service等"><a href="#4-资源服务搭建-gift-sysmanage-service等" class="headerlink" title="4.资源服务搭建-gift-sysmanage-service等"></a>4.资源服务搭建-gift-sysmanage-service等</h3><p>当客户端(web端，mobile移动端)带着Token向资源服务器发起请求获取资源,资源服务器需要对请求中的Token进行校验以及对资源进行授权，如果Token校验和授权都通过即可返回相应的数据给客户端。</p><h4 id="4-1-项目修改"><a href="#4-1-项目修改" class="headerlink" title="4.1.项目修改"></a>4.1.项目修改</h4><ul><li>Pom.xml</li></ul><p>修改 security-resource-server工程，除了集成EurekaClient以外，还需要集成security以及Oauth2 ， 在pom中导入如下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：其实spring-cloud-starter-oauth2依赖中已经导入了spring-boot-starter-security</p><ul><li>主配置类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//资源服务器配置</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ResourceServerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">resource-server:4000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resources-server</span></span><br></pre></td></tr></table></figure><h4 id="4-2-Oauth2资源配置"><a href="#4-2-Oauth2资源配置" class="headerlink" title="4.2.Oauth2资源配置"></a>4.2.Oauth2资源配置</h4><p>在资源服务中我们需要解决的问题是，当请求进来，请求是需要携带token，我们需要配置资源服务如何对token进行校验和授权。在Oauth2中，对资源服务进行配置的类为：</p><p>ResourceServerConfigurerAdapter,该类的源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title class_">ResourceServerConfigurer</span> &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span></span><br><span class="line"> <span class="keyword">throws</span> Exception &#123; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，上面是源码，不要乱拷贝，API介绍：</p><ul><li><p>ResourceServerConfigurerAdapter : 资源服务配置适配器类，用于实现资源服务器的安全访问配置，通过继承该类并结合@EnableResourceServer注解开启资源服务配置。</p></li><li><p>ResourceServerSecurityConfigurer : 资源服务器安全配置器,如配置token校验规则。</p></li></ul><p><strong>oauth2资源服务配置最佳实践</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.RemoteTokenServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;</span><br><span class="line"></span><br><span class="line"><span class="comment">//资源服务配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//开启资源服务配置</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="comment">//开启方法授权</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//1.资源服务安全配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.1资源服务令牌验证服务,通过远程校验令牌</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ResourceServerTokenServices <span class="title function_">resourceServerTokenServices</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//使用远程服务请求授权服务器校验token ， 即：资源服务和授权服务器不在一个主机</span></span><br><span class="line">        <span class="type">RemoteTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteTokenServices</span>();</span><br><span class="line">        <span class="comment">//授权服务地址 , 当浏览器访问某个资源时就会调用该远程授权服务地址去校验token</span></span><br><span class="line">        <span class="comment">//要求请求中必须携带token</span></span><br><span class="line">        services.setCheckTokenEndpointUrl(<span class="string">&quot;http://localhost:3000/oauth/check_token&quot;</span>);</span><br><span class="line">        <span class="comment">//客户端id，对应认证服务的客户端详情配置的clientId</span></span><br><span class="line">        services.setClientId(<span class="string">&quot;webapp&quot;</span>);</span><br><span class="line">        <span class="comment">//密钥，对应认证服务的客户端详情配置的clientId</span></span><br><span class="line">        services.setClientSecret(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> services;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//我的资源名称是什么</span></span><br><span class="line">        resources.resourceId(<span class="string">&quot;res1&quot;</span>);</span><br><span class="line">        <span class="comment">//用来校验，解析Token的服务</span></span><br><span class="line">        resources.tokenServices(resourceServerTokenServices());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.资源服务的资源的授权配置，比如那些资源放行，那些资源需要什么权限等等</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">            <span class="comment">//校验scope必须为all ， 对应认证服务的客户端详情配置的clientId</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/**&quot;</span>).access(<span class="string">&quot;#oauth2.hasScope(&#x27;all&#x27;)&quot;</span>)</span><br><span class="line">            <span class="comment">//关闭跨域伪造检查</span></span><br><span class="line">            .and().csrf().disable()</span><br><span class="line">            <span class="comment">//把session设置为无状态，意思是使用了token，那么session不再做数据的记录</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里通过 ResourceServerSecurityConfigurer 指定了 ResourceServerTokenServices ，即指定了资源服务令牌验证方案，然后使用了 RemoteTokenServices 远程校验方案，当请求到达资源服务器，资源服务会带着请求中的token，向认证服务器发起远程校验(&#x2F;oauth&#x2F;check_token)</p><ul><li>ResourceServerSecurityConfigurer ：指定了资源的ID，这里需要跟认证服务中配置的资源ID一致见：AuthorizationServerConfig.configure配置的resourceIds</li></ul><p>&nbsp;</p><ul><li><p>通过tokenServices指定令牌校验服务</p></li><li><p>ResourceServerTokenServices ：令牌校验服务配置</p></li></ul><p><strong>注意</strong>：这里在配置类上开启了@EnableGlobalMethodSecurity(prePostEnabled &#x3D; true)，因为我这里使用方法授权的方式指明我们的controller方法需要什么样的权限才能访问，当然也可以使用web授权的方式(回顾web授权和方法授权)</p><h4 id="4-3-编写资源controller"><a href="#4-3-编写资源controller" class="headerlink" title="4.3.编写资源controller"></a><strong>4.3.编写资源controller</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/employee/list&quot;)</span></span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;employee:list&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;您的token验证通过,已经访问到真正的资源 employee:list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/employee/add&quot;)</span></span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;employee:add&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">add</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;您的token验证通过,已经访问到真正的资源 employee:add&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该Controller作为测试返回数据，当客户端请求“oauth-resource”过来，如果Token校验成功，将会看到“”您的token验证通过,已经访问到真正的资源””</p><h4 id="4-4-测试"><a href="#4-4-测试" class="headerlink" title="4.4.测试"></a>4.4.测试</h4><p>向资源服务器发起请求，请求头携带：Authorization&#x3D;Bearer token值 ，如下：</p><p><img src="/breeze/b3ef3604/image26.png"></p><p>这里我们已经成功的访问到真正的资源 ， 请求资源之前，资源服务器会发送远程请求到授权服务器验证token的合法性，并且根据当前token获取权限列表，然后在进行授权，如果权限列表拥有资源(controller的方法)所需要的权限，即可访问成功 。</p><p>错误示范：</p><p>如果Token是无效的会出现如下信息：</p><p><img src="/breeze/b3ef3604/image27.png"></p><p>如果Token中的权限不包含资源所需要的权限会出现如下信息：</p><p><img src="/breeze/b3ef3604/image28.png"></p><p>思考：那是不是每个资源服务(微服务)都需要做如上的配置呢?</p><h3 id="5-小结"><a href="#5-小结" class="headerlink" title="5.小结"></a>5.小结</h3><p>我们基于Oauth2配置授权服务器和资源服务器完成了请求授权并获取资源的操作，整个流程如下：</p><p><img src="/breeze/b3ef3604/image29.png"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#默认启动是dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">$&#123;spring.profiles.active&#125;</span> <span class="comment">#环境 java -jar -d spring.profiles.active=test gift-eureak.jar</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">application-auth</span> <span class="comment">#gitee上面名称</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://127.0.0.1:1010</span> <span class="comment">#配置服务器,相当于连上仓库</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span> <span class="comment">#覆盖bean配置</span></span><br></pre></td></tr></table></figure><h1 id="四-Spring-Cloud-OAUTH2-JWT令牌"><a href="#四-Spring-Cloud-OAUTH2-JWT令牌" class="headerlink" title="四. Spring Cloud-OAUTH2+JWT令牌"></a>四. Spring Cloud-OAUTH2+JWT令牌</h1><h3 id="1-认识JWT"><a href="#1-认识JWT" class="headerlink" title="1.认识JWT"></a>1.认识JWT</h3><h4 id="1-1-为什么要用JWT令牌"><a href="#1-1-为什么要用JWT令牌" class="headerlink" title="1.1.为什么要用JWT令牌"></a>1.1.为什么要用JWT令牌</h4><p>根据前面的案例，我们每次访问资源都要通过资源服务器远程调用认证服务器进行token的校验和授权才能访问到资源。但是如果我们的访问比较频繁，并发比较高，那么这种权限校验方式无疑比较消耗性能。而JWT就是用来解决远程校验令牌的问题。</p><p><img src="/breeze/b3ef3604/image30.png"></p><h4 id="1-2-什么是JWT"><a href="#1-2-什么是JWT" class="headerlink" title="1.2.什么是JWT"></a>1.2.什么是JWT</h4><p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p><p>JWT 以 JSON 对象的形式安全传递信息。因为存在数字签名，因此所传递的信息是安全的。客户端身份经过服务器验证通过后，会生成带有签名的 JSON 对象并将它返回给客户端。客户端在收到这个 JSON 对象后存储起来。</p><p>在以后的请求中客户端将 JSON 对象连同请求内容一起发送给服务器，服务器收到请求后通过 JSON 对象标识用户，如果验证不通过则不返回请求的数据。</p><p>总结：使用JWT生成的Token是安全的，可以理解成就是在我们之前的Token基础上做了加密处理,实现了数据的安全传输 ， 也实现了资源服务器对Token的自校验</p><h4 id="1-3-JWT特点"><a href="#1-3-JWT特点" class="headerlink" title="1.3.JWT特点"></a>1.3.JWT特点</h4><ul><li><p>基于JSON，方便解析</p></li><li><p>可以在令牌中定义内容，方便扩展</p></li><li><p>使用加密算法即数字签名，JWT防篡改</p></li><li><p>资源服务使用JWT可以不依赖认证服务即可完成授权</p></li></ul><h4 id="1-4-JWT组成"><a href="#1-4-JWT组成" class="headerlink" title="1.4.JWT组成"></a>1.4.JWT组成</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/99a458c62aa4">https://www.jianshu.com/p/99a458c62aa4</a></p><p>JWT包含三部分组成</p><ul><li><p><strong>头部</strong> (header)： JSON格式，描述JWT的最基本的信息，如签名算法等效果如下：</p><p>{“type”:”JWT”,”alg”:”HS256”} 这里指明了签名算法是HS256算法。在使用过程中会对该 JSON进行BASE64编码如：yJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</p></li><li><p><strong>载荷</strong>(playload) ：JSON格式，包含了需要的数据内容，也需要BASE64编码。包含三部分</p><ul><li>标准中注册的声明（建议但不强制使用）</li></ul></li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">iss:</span> <span class="keyword">jwt签发者</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">sub: </span><span class="keyword">jwt所面向的用户, </span>zs</span><br><span class="line"><span class="symbol">aud:</span> 接收<span class="keyword">jwt的一方</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">exp:</span> <span class="keyword">jwt的过期时间，这个过期时间必须要大于签发时间</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">nbf:</span> 定义在什么时间之前，该<span class="keyword">jwt都是不可用的.</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">iat:</span> <span class="keyword">jwt的签发时间</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">jti: </span><span class="keyword">jwt的唯一身份标识，主要用来作为一次性token。</span></span><br></pre></td></tr></table></figure><ul><li><p>公共的声明 ：公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</p><ul><li>私有的声明 ：私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</li></ul></li></ul><p>定义一个payload: 如 {“sub”:”1234”,”name”:”xxx”,”admin”:true} 进行Base64编码后得到JWT第二部分如 <code>eyJzdWIiOiIxMjM0NTY3ODkbmFtZSI6IkpvaG4gRG9lIiwiYW...</code></p><p><strong>签名</strong> (signature)： 通过指定的算法生成哈希，以确保数据不会被篡改。jwt的第三部分是一个签证信息，通过指定的算法生成哈希，以确保数据不会被篡改，signature部分是将前两个部分的json拼接中间加一点，再将这个拼接后的字符串用alg中的算法签名后的密文构成JWT第三部分如：<code>ThecMfgYjtoys3JX7dpx3hu6pUm0piZ0tXXr</code></p><p>最后JWT构建的内容编码后的字符串</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“eyJhbGciOiJIUzI<span class="number">1</span><span class="symbol">NiJ9</span>.eyJqdGkiOiI<span class="number">4</span>ODgiLCJzdWIiOiLlsI_<span class="symbol">nmb0</span>iLCJpYXQiOjE<span class="number">1</span><span class="symbol">NTc5</span>MDQxODF<span class="number">9.</span>ThecMfgYjtoys<span class="number">3</span>JX<span class="number">7</span>dpx<span class="number">3</span>hu<span class="number">6</span>pU<span class="name">m0</span>piZ<span class="number">0</span>tXXreFU_u<span class="number">3</span>Y”</span><br></pre></td></tr></table></figure><p>Jwt怎么保证数据安全？ 数字签名，第三部分是base64(第一部分).base64(第二部门)的特定加密算法进行签名，以后token来获取第一部分和第二部分的加密签名来比对，看他是否一样，如果一样没有被篡改，否则篡改。</p><p><a target="_blank" rel="noopener" href="https://www.jiamisoft.com/blog/27553-mac.html">简述MAC算法</a></p><h3 id="2-授权服务配置JWT"><a href="#2-授权服务配置JWT" class="headerlink" title="2 授权服务配置JWT"></a>2 授权服务配置JWT</h3><p>修改认证服务 security-auth-server</p><h4 id="基于JWT的TokenStore配置"><a href="#基于JWT的TokenStore配置" class="headerlink" title="基于JWT的TokenStore配置"></a>基于JWT的TokenStore配置</h4><p>修改认证服务指定把Token存储方案由InMemoryTokenStore修改为JwtTokenStore,修改 AuthorizationServerConfig配置类，定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JwtTokenStore是以JWT方式存储令牌 ， JwtTokenStore需要一个 令牌转换器对象JwtAccessTokenConverter(JWT令牌校验工具) ，该对象把JWT编码的令牌值和OAuth身份验证信息进行互相转换，定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sign_key</span>  <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JWT令牌校验工具</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">    <span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line">    jwtAccessTokenConverter.setSigningKey(sign_key);</span><br><span class="line">    <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JwtAccessTokenConverter负责把JWT编码的令牌值和OAuth身份验证信息进行互相转换 ， 并且JWT提供了签名机制让数据传输跟安全，所有这里的转换器需要设置前面的密钥：SigningKey ，这里简单使用对称密钥(支持非对称)设置为 “123” 。</p><p>注意：授权服务的签名密钥要跟资源服务的签名密钥一致。</p><h4 id="2-2-令牌管理服务修改"><a href="#2-2-令牌管理服务修改" class="headerlink" title="2.2.令牌管理服务修改"></a>2.2.<strong>令牌管理服务修改</strong></h4><p>因为现在使用了JWT模式的令牌存储方案，那么在令牌管理服务AuthorizationServerTokenServices的配置中需要指定JwtAccessTokenConverter ， 因为 AuthorizationServerTokenServices的作用是创建,获取,刷新Token，既然我们的TokenStore使用了JWT方案并指定了token转换器，那么我们的AuthorizationServerTokenServices也要指定相同的token转换器,修改 AuthorizationServerTokenServices 的定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置令牌管理服务</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">authorizationServerTokenServices</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建默认的令牌服务</span></span><br><span class="line">    <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">    <span class="comment">//设置客户端信息服务</span></span><br><span class="line">    services.setClientDetailsService(clientDetailsService);</span><br><span class="line">    <span class="comment">//支持token刷新</span></span><br><span class="line">    services.setSupportRefreshToken(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//token存储方式</span></span><br><span class="line">    services.setTokenStore(tokenStore);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置token增强 - 设置token转换器</span></span><br><span class="line">    <span class="type">TokenEnhancerChain</span> <span class="variable">tokenEnhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();  </span><br><span class="line">    tokenEnhancerChain.setTokenEnhancers(Arrays.asList(jwtAccessTokenConverter()));</span><br><span class="line">    services.setTokenEnhancer(tokenEnhancerChain);  <span class="comment">//jwtAccessTokenConverter()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//token有效时间2小时</span></span><br><span class="line">    services.setAccessTokenValiditySeconds(<span class="number">72000</span>);</span><br><span class="line">    <span class="comment">//属性令牌默认有效时间</span></span><br><span class="line">    services.setRefreshTokenValiditySeconds(<span class="number">200000</span>);</span><br><span class="line">    <span class="keyword">return</span> services;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3.测试"></a>2.3.测试</h4><p>经过如上步骤，我们已经把token修改为JWT方案，重新走一遍测试流程，</p><p>获取授权码</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/oauth/authorize?client_id=webapp&amp;response_type=code&amp;redirect_uri=http://www.baidu.com</span><br></pre></td></tr></table></figure><p>获取token</p><table><thead><tr><th><a target="_blank" rel="noopener" href="http://localhost:3000/oauth/token?client_id=webapp&client_secret=secret&grant_type=authorization_code&code=%E6%8E%88%E6%9D%83%E7%A0%81&redirect_uri=http://www.baidu.com">http://localhost:3000/oauth/token?client_id=webapp&amp;client_secret=secret&amp;grant_type=authorization_code&amp;code=授权码&amp;redirect_uri=http://www.baidu.com</a></th></tr></thead><tbody><tr><td><img src="/breeze/b3ef3604/image-20240115183335849.png" alt="image-20240115183335849"></td></tr></tbody></table><p>校验token</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">http</span>://localhost:<span class="number">3000</span>/oauth/check_token?<span class="keyword">token</span>=<span class="keyword">token</span>值</span><br></pre></td></tr></table></figure><p>访问资源 ，请求头带参数： “Authorization&#x3D; Bearer token的值“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:4000/oauth-resource</span><br></pre></td></tr></table></figure><h3 id="3-资源服务配置JWT"><a href="#3-资源服务配置JWT" class="headerlink" title="3.资源服务配置JWT"></a>3.资源服务配置JWT</h3><p>我们之前的资源服务使用的远程校验方式去校验token(非JWT令牌)的正确性，以及token对应认证信息(用户名,权限等)都是远程获取的，而现在我们的令牌是在认证服务方使用JWT方式生成的，并且使用了签名机制，而JWT令牌的特点就是所有的认证信息包含在令牌中，所以这里我们要修改资源服务校验令牌的方式，不再需要远程校验，修改如下</p><h4 id="3-1-定义JwtAccessTokenConverter"><a href="#3-1-定义JwtAccessTokenConverter" class="headerlink" title="3.1.定义JwtAccessTokenConverter"></a>3.1.定义JwtAccessTokenConverter</h4><p>修改资源服务 security-resource-server ,在资源服务也定义一份和授权服务一样的 TokenStore和JwtAccessTokenConverter ,在资源服务的配置类ResourceServerConfig中加如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改JWT令牌</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sign_key</span>  <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JWT令牌校验工具</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">    <span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line">    jwtAccessTokenConverter.setSigningKey(sign_key);</span><br><span class="line">    <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的签名密钥，tokenStore,令牌转换器和认证服务都是一样的。</p><h4 id="3-2-修改ResourceServerSecurityConfigurer"><a href="#3-2-修改ResourceServerSecurityConfigurer" class="headerlink" title="3.2.修改ResourceServerSecurityConfigurer"></a>3.2.修改ResourceServerSecurityConfigurer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//资源服务器安全性配置</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//资源ID</span></span><br><span class="line">    resources.resourceId(RESOURCE_ID)</span><br><span class="line">        .tokenStore(tokenStore())</span><br><span class="line">        <span class="comment">//验证令牌的服务，令牌验证通过才允许获取资源</span></span><br><span class="line">        <span class="comment">//.tokenServices(resourceServerTokenServices())</span></span><br><span class="line">        <span class="comment">//无状态</span></span><br><span class="line">        .stateless(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：这里吧ResourceServerSecurityConfigurer配置中的</p><p>.tokenServices(resourceServerTokenServices())注释掉，意思是不在使用远程的令牌校验方式 ，而是使用.tokenStore(tokenStore())的校验 - 客户端自己校验</p><h4 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3.测试"></a>3.3.测试</h4><p>重新走一遍流程即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//权限异常处理</span></span><br><span class="line"><span class="comment">//处理系统异常 Exception</span></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span><span class="comment">//处理GlobalException</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">exceptionHandler</span><span class="params">(Exception e)</span>&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="comment">//权限异常处理 AccessDeniedException</span></span><br><span class="line">    <span class="keyword">if</span> (e.getClass().getName().contains(<span class="string">&quot;AccessDeniedException&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me()</span><br><span class="line">            .setSuccess(<span class="literal">false</span>)</span><br><span class="line">            .setCode(ErrorCode.CODE_403_SYSTEM_ERROR.getCode())</span><br><span class="line">            .setMessage(ErrorCode.CODE_403_SYSTEM_ERROR.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.me()</span><br><span class="line">        .setSuccess(<span class="literal">false</span>)</span><br><span class="line">        .setCode(ErrorCode.CODE_500_SYSTEM_ERROR.getCode())</span><br><span class="line">        .setMessage(ErrorCode.CODE_500_SYSTEM_ERROR.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-抽取资源服务公共模块"><a href="#4-抽取资源服务公共模块" class="headerlink" title="4.抽取资源服务公共模块"></a>4.抽取资源服务公共模块</h3><h4 id="4-1-创建项目并且导入jar"><a href="#4-1-创建项目并且导入jar" class="headerlink" title="4.1 创建项目并且导入jar"></a>4.1 创建项目并且导入jar</h4><p><img src="/breeze/b3ef3604/image32.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--springcloud oauth2的依赖包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-2-实现"><a href="#4-2-实现" class="headerlink" title="4.2 实现"></a>4.2 实现</h4><h5 id="4-2-1-父模块"><a href="#4-2-1-父模块" class="headerlink" title="4.2.1 父模块"></a>4.2.1 父模块</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.contstants.giftResourceConstants;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.ResourceServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">//资源服务配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//开启资源服务配置</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="comment">//开启方法授权</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//转换器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建</span></span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        <span class="comment">//设置秘钥</span></span><br><span class="line">        jwtAccessTokenConverter.setSigningKey(giftResourceConstants.JWT_SIGNING_KEY);</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构造jwttokenstore</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;oauth2.resourceId&#125;&quot;)</span> <span class="comment">//从配置文件中获取值</span></span><br><span class="line">    <span class="keyword">private</span> String resourceId;</span><br><span class="line">    <span class="comment">//1.资源服务安全配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//配置资源id，对应oauth_client_details表中resource_ids</span></span><br><span class="line">        resources.resourceId(resourceId);</span><br><span class="line">        <span class="comment">//远程发请求去获取token中用户和权限</span></span><br><span class="line">        resources.tokenStore(tokenStore());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResourceId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> resourceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceId</span><span class="params">(String resourceId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceId = resourceId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.mliutm.gift.contstants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">giftResourceConstants</span> &#123;</span><br><span class="line">    <span class="comment">//Jwt秘钥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">final</span>  <span class="type">String</span> <span class="variable">JWT_SIGNING_KEY</span> <span class="operator">=</span> <span class="string">&quot;mliutm_gift&amp;%%$##@@#%%%&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="4-2-2-资源服务模块"><a href="#4-2-2-资源服务模块" class="headerlink" title="4.2.2 资源服务模块"></a>4.2.2 资源服务模块</h5><p>1）依赖公共资源模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--不需要了，有公共的资源配置--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.mliutm.gift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gift-resource-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>yml配置</p><p>bootstrap.yml</p><p><img src="/breeze/b3ef3604/image33.png"></p></li></ol><p>3）java配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">BaseResourceServerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2 资源服务的资源的授权配置，比如那些资源放行，那些资源需要什么权限等等</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            <span class="comment">//关闭跨域伪造检查</span></span><br><span class="line">            .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-测试"><a href="#4-3-测试" class="headerlink" title="4.3 测试"></a>4.3 测试</h4><p>和原来一样</p><h1 id="五-微服务之间的授权"><a href="#五-微服务之间的授权" class="headerlink" title="五. 微服务之间的授权"></a>五. 微服务之间的授权</h1><h3 id="1-概述-1"><a href="#1-概述-1" class="headerlink" title="1.概述"></a>1.概述</h3><h4 id="1-1-微服务之间为什么需要授权"><a href="#1-1-微服务之间为什么需要授权" class="headerlink" title="1.1.微服务之间为什么需要授权"></a>1.1.微服务之间为什么需要授权</h4><p>当先向客户端资源服务（courseService）发起请求，请求头携带Token，在资源服务(A)需要校验Token进行访问授权，但是我们一个请求往往是需要多个微服务一起完成，如果A服务调用B服务调用C服务，那么A服务校验Token之后，B服务需不需要也校验Token呢？答案是当然的，因为每个微服务都是独立的都需要做好权限校验工作？那么如何实现服务之间的授权？</p><p><img src="/breeze/b3ef3604/image34.png"></p><h4 id="1-2-解决方案"><a href="#1-2-解决方案" class="headerlink" title="1.2.解决方案"></a>1.2.解决方案</h4><ul><li>方案一：服务之间临时token</li></ul><p>解决一就是在A服务调用B服务的时候是通过Feign实现调用，底层也是Http协议，那么我们就可以使用Feign请求拦截器拦截到Feign的请求，给请求头添加Token。</p><p>如果只是服务之间授权，没有用户上下文的参与，我们可以在Feign的拦截器中使用“客户端模式”从认证服务获取Token，然后把Token添加到请求服务B的请求头中，这样一来，B服务就可以对请求中的Token进行校验从而进行授权。如图：</p><p><img src="/breeze/b3ef3604/image35.png"></p><p>但是这种方案也有一定的问题，就是消费者服务需要额外发起请求向认证服务获取Token，并且需要对Token做缓存和定时刷新来保证Token的重用和保证Token失效，这样一来就增加了额外的网络开销和代码量，如果请求有用户参与，那么就不能采用从认证服务重新获取Token，而是需要将客户端带过来的Token通过请求头带给后续请求的服务，因为我们需要通过客户端的Token校验当前用户的权限。</p><ul><li><p>方案二（先玩这种）：</p><p>方案二采用直接把客户端提交给资源服务的Token继续向下游资源服务提交，那么久需要在消费者服务A向提供者服务器B发起请求(Feign)的时候进行拦截(Feign的拦截器)，在拦截器中获取请求头中的Token添加到Fiegn的请求头中，这样一来Token就由A服务传递给了B服务，B服务就可以对Token进行校验了。如图：</p><p><img src="/breeze/b3ef3604/image36.png"></p><p>方式二减少了向认证服务器获取令牌的网络开销，从代码量和性能上来说，方式二都略胜一筹，我们选择方式二。</p></li></ul><h3 id="2-服务提供者"><a href="#2-服务提供者" class="headerlink" title="2.服务提供者"></a><del>2.服务提供者</del></h3><h4 id="2-1-搭建项目"><a href="#2-1-搭建项目" class="headerlink" title="2.1.搭建项目"></a>2.1.搭建项目</h4><p>服务提供者相当于上面所说的“服务B”，我们将security-resources-server作为服务消费者，创建项目security-resources-server-2作为服务提供者，服务提供和的搭建方式同security-resources-server也需要集成“Oauth2的资源配置”，并且暴露资源访问接口让security-resources-server远程调用。</p><ul><li>创建新项目：Pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>配置类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//资源服务器配置</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerApplication2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ResourceServerApplication2.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:1000/eureka/</span> <span class="comment">#注册中心地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">resource-server2:5000</span>  <span class="comment">#指定服务的id</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resources-server2</span></span><br></pre></td></tr></table></figure><h4 id="2-2-Oauth2资源配置"><a href="#2-2-Oauth2资源配置" class="headerlink" title="2.2.Oauth2资源配置"></a>2.2.Oauth2资源配置</h4><p>其实每个资源服务的配置大多一样，所以可以抽取公共的资源配置模块，这里为了不增加复杂度就没有抽取了，而是把security-resources-server的资源配置复制过来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//资源服务配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span>   <span class="comment">//开启资源服务配置</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span>  <span class="comment">//开启方法授权</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置资源id ,跟AuthorizationServerConfig.configure配置的resourceIds一样</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RESOURCE_ID</span> <span class="operator">=</span> <span class="string">&quot;res1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sign_key</span>  <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    <span class="comment">//资源服务器安全性配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//资源ID</span></span><br><span class="line">        resources.resourceId(RESOURCE_ID)</span><br><span class="line">            .tokenStore(tokenStore())</span><br><span class="line">            <span class="comment">//验证令牌的服务，令牌验证通过才允许获取资源</span></span><br><span class="line">            <span class="comment">//.tokenServices(resourceServerTokenServices())</span></span><br><span class="line">            <span class="comment">//无状态,仅在这些(RESOURCE_ID对应的资源)资源上使用允许使用token校验</span></span><br><span class="line">            .stateless(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改JWT令牌,基于JWT的验证方案----------------------------</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//JWT令牌校验工具</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        <span class="comment">//设置JWT签名密钥。它可以是简单的MAC密钥，也可以是RSA密钥</span></span><br><span class="line">        jwtAccessTokenConverter.setSigningKey(sign_key);</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SpringSecurity的相关配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">            <span class="comment">//校验scope必须为all ， 对应认证服务的客户端详情配置的clientId</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/**&quot;</span>).access(<span class="string">&quot;#oauth2.hasScope(&#x27;all&#x27;)&quot;</span>)</span><br><span class="line">            <span class="comment">//关闭跨域伪造检查</span></span><br><span class="line">            .and().csrf().disable()</span><br><span class="line">            <span class="comment">//把session设置为无状态，意思是使用了token，那么session不再做数据的记录</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-编写Controller"><a href="#2-3-编写Controller" class="headerlink" title="2.3.编写Controller"></a>2.3.编写Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Resource2Controller</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth-resource2&quot;)</span></span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;dept:list&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">resources</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oauth-resource2：您的token验证通过,已经访问到真正的资源&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里指定了“<strong>oauth-resource2</strong>”资源需要“<strong>dept:list</strong>”才能访问。</p><h3 id="3-服务消费者"><a href="#3-服务消费者" class="headerlink" title="3.服务消费者"></a><del>3.服务消费者</del></h3><h4 id="3-1-导入依赖"><a href="#3-1-导入依赖" class="headerlink" title="3.1.导入依赖"></a>3.1.导入依赖</h4><p>我们修改security-resources-server服务，使用Feign去调用security-resources-server2服务实现服务之间的通信，所以这里需要集成Feign，修改security-resources-server如下：</p><ul><li>Pom.xml 加入Feign的依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-2-集成Feign"><a href="#3-2-集成Feign" class="headerlink" title="3.2.集成Feign"></a>3.2.集成Feign</h4><ul><li>配置类开启Feign - @EnableFeignClients</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ResourceServerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编写Feign客户端接口 ： 调用security-resources-server2</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用 security-resources-server-2服务的Feign接口</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;resources-server2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Resource2FeignClient</span> &#123;</span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/oauth-resource2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">resources</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-3-服务通信"><a href="#3-3-服务通信" class="headerlink" title="3.3.服务通信"></a>3.3.服务通信</h4><p>修改ResourceController,使用Resource2FeignClient 实现服务远程调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Resource2FeignClient resource2FeignClient ;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth-resource&quot;)</span></span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;employee:list&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">resources</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resource2FeignClient.resources();</span><br><span class="line">        <span class="comment">//return &quot;您的token验证通过,已经访问到真正的资源&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-4-测试通信"><a href="#3-4-测试通信" class="headerlink" title="3.4.测试通信"></a>3.4.测试通信</h4><p>走一遍测试流程，最终效果如下：</p><p><img src="/breeze/b3ef3604/image37.png"></p><p>这里出现了没有访问权限，我们的请求线路是</p><p>Postmain -&gt; resources-server(&#x2F;oauth-resource) -&gt; resources-server-2(&#x2F;oauth-resource2)</p><p>其实我们的Token中是包含了 resources-server(&#x2F;oauth-resource)说需要的权限</p><p>“employee:list”,出现无选项访问是在resources-server调用resources-server2的时候，由于resources-server2集成了oauth2的资源服务器配置，而resources-server并没有传递Token给resources-server2，所以出现了访问失败。下面我们就来实现服务之间的授权。</p><h3 id="拦截器配置"><a href="#拦截器配置" class="headerlink" title="拦截器配置"></a>拦截器配置</h3><p>根据我们之前分析的服务授权方案，我们需要在消费者向提供者发起请求前，使用Feign的拦截器从请求头中获取Token，然后带着Token向提供者发起请求，但是此种情况在微服务中大量存在，所以我们这决定讲上述业务抽取成公共的模块，消费者服务进行依赖即可。</p><h4 id="4-1-创建模块"><a href="#4-1-创建模块" class="headerlink" title="4.1.创建模块"></a>4.1.创建模块</h4><p>创建新的模块security-feign-oauth2-common，导入依赖</p><ul><li>Pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-2-定义Feign的拦截器-直接从这儿开始（课程服务）"><a href="#4-2-定义Feign的拦截器-直接从这儿开始（课程服务）" class="headerlink" title="4.2.定义Feign的拦截器-直接从这儿开始（课程服务）"></a>4.2.<strong>定义Feign的拦截器-直接从这儿开始（课程服务）</strong></h4><p>我们需要在资源服务提供者方定义Feign拦截器,在拦截器中像认证服务发送请求获取Token(client_credentials客户端模式),请求头添加Token，然后再把Token添加到请求头中，另外我们在这里做了Token缓存，定时30分钟刷新Token。另外我们这里获取token使用的是“client_credentials”客户端模式，因为服务和服务之间是绝对信任的，所以无需复杂的授权码模式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Fiegn拦截器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultOAuth2FeignRequestInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头中的token</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHORIZATION_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Authorization&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.获取请求对象</span></span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">servletRequestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> servletRequestAttributes.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.从请求头获取到令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> request.getHeader(AUTHORIZATION_HEADER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.把令牌添加到Fiegn的请求头</span></span><br><span class="line">        requestTemplate.header(AUTHORIZATION_HEADER,authorization);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-Feign拦截器配置"><a href="#4-3-Feign拦截器配置" class="headerlink" title="4.3.Feign拦截器配置"></a>4.3.Feign拦截器配置</h4><p>需要把我们自定义的Feign拦截器类配置成Bean,需要的参数从配置文件中加载。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Feign的拦截器配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignInterceptorConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">oAuth2RequestInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2FeignRequestInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-资源服务依赖拦截器模块"><a href="#4-4-资源服务依赖拦截器模块" class="headerlink" title="4.4.资源服务依赖拦截器模块"></a>4.4.资源服务依赖拦截器模块</h4><p>修改服务消费者“security-resources-server”，依赖拦截器模块</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.mliutm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>security-feign-interceptor-token<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="4-5-测试服务之间授权"><a href="#4-5-测试服务之间授权" class="headerlink" title="4.5.测试服务之间授权"></a>4.5.测试服务之间授权</h4><p>发起请求调用,查看提供者服务是否能够降权成功，并且访问到资源。</p><h3 id="Hystrix导致Token转发失败"><a href="#Hystrix导致Token转发失败" class="headerlink" title="Hystrix导致Token转发失败"></a><del>Hystrix导致Token转发失败</del></h3><h4 id="Hystrix引发的问题"><a href="#Hystrix引发的问题" class="headerlink" title="Hystrix引发的问题"></a>Hystrix引发的问题</h4><p>上面的案例中我们的“security-resources-server”消费者服务并没有集成Hystrix，如果我们集成了Hystrix那么在Feign的拦截器中是没办法获取到请求头中的信息的，这是因为Hystrix默认的隔离策略是线程池，每个请都会被分配到一个新的线程，导致请对象无法获取，解决方案有两种，一是使用信号量隔离，在配置文件中加入如下配置：</p><p>“hystrix.command.default.execution.isolation.strategy&#x3D;SEMAPHORE”，解决方案二是修改Hystrix的隔离策略,我们这里使用第二种方式，因为使用信号量隔离会让请求变成单线程执行，官方也不推荐。</p><p><img src="/breeze/b3ef3604/image38.png" alt="IMG_256"></p><p>解决方案：</p><p><img src="/breeze/b3ef3604/image39.png"></p><h4 id="5-2-集成Hystrix"><a href="#5-2-集成Hystrix" class="headerlink" title="5.2.集成Hystrix"></a>5.2.集成Hystrix</h4><p>修改工程“security-resources-server”消费者服务，我们让Feign集成Hystrix</p><ul><li>开启Hystrix</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="5-3-Feign接口指定Fallback"><a href="#5-3-Feign接口指定Fallback" class="headerlink" title="5.3.Feign接口指定Fallback"></a>5.3.Feign接口指定Fallback</h4><p>修改 ResourceFeignClient 接口，指定fallback实现托底</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用 security-resources-server-2服务的Feign接口</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;resources-server2&quot;,fallback = ResourceFeignClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResourceFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这是一个测试方法，如果资源服务器对token校验通过就能够访问该资源</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/oauth-resource2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">resources</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-4-编写降级类"><a href="#5-4-编写降级类" class="headerlink" title="5.4.编写降级类"></a>5.4.编写降级类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceFeignClientFallback</span> <span class="keyword">implements</span> <span class="title class_">Resource2FeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">resources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;资源服务 resources-server2 不可用&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-5测试Hystrix导入转发失败"><a href="#5-5测试Hystrix导入转发失败" class="headerlink" title="5.5测试Hystrix导入转发失败"></a>5.5测试Hystrix导入转发失败</h4><p>重新走一遍测试流程，发现返回的结果为“资源服务 resources-server2 不可用”，即返回了托底数据，这是因为Hystrix的隔离策略导致了Feign拦截器状态请求失败，如果在拦截器中去打印authorization（Token） 你看到的将是空值。</p><h4 id="5-6-定义Hystrix隔离策略-直接从这儿开始"><a href="#5-6-定义Hystrix隔离策略-直接从这儿开始" class="headerlink" title="5.6.定义Hystrix隔离策略-直接从这儿开始"></a>5.6.定义Hystrix隔离策略-直接从这儿开始</h4><p>在模块“security-feign-interceptor-token”拦截器模块中定义隔离策略类，该类的作用是：将现有的并发策略作为新并发策略的成员变量,在新并发策略中,返回现有并发策略的线程池、Queue;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignHystrixConcurrencyStrategy</span> <span class="keyword">extends</span> <span class="title class_">HystrixConcurrencyStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HystrixConcurrencyStrategy hystrixConcurrencyStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FeignHystrixConcurrencyStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.hystrixConcurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.hystrixConcurrencyStrategy <span class="keyword">instanceof</span> FeignHystrixConcurrencyStrategy) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">HystrixCommandExecutionHook</span> <span class="variable">commandExecutionHook</span> <span class="operator">=</span></span><br><span class="line">                HystrixPlugins.getInstance().getCommandExecutionHook();</span><br><span class="line">            <span class="type">HystrixEventNotifier</span> <span class="variable">eventNotifier</span> <span class="operator">=</span> HystrixPlugins.getInstance().getEventNotifier();</span><br><span class="line">            <span class="type">HystrixMetricsPublisher</span> <span class="variable">metricsPublisher</span> <span class="operator">=</span> HystrixPlugins.getInstance().getMetricsPublisher();</span><br><span class="line">            <span class="type">HystrixPropertiesStrategy</span> <span class="variable">propertiesStrategy</span> <span class="operator">=</span></span><br><span class="line">                HystrixPlugins.getInstance().getPropertiesStrategy();</span><br><span class="line"></span><br><span class="line">            HystrixPlugins.reset();</span><br><span class="line">            <span class="type">HystrixPlugins</span> <span class="variable">instance</span> <span class="operator">=</span> HystrixPlugins.getInstance();</span><br><span class="line">            instance.registerConcurrencyStrategy(<span class="built_in">this</span>);</span><br><span class="line">            instance.registerCommandExecutionHook(commandExecutionHook);</span><br><span class="line">            instance.registerEventNotifier(eventNotifier);</span><br><span class="line">            instance.registerMetricsPublisher(metricsPublisher);</span><br><span class="line">            instance.registerPropertiesStrategy(propertiesStrategy);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;策略注册失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Callable&lt;T&gt; <span class="title function_">wrapCallable</span><span class="params">(Callable&lt;T&gt; callable)</span> &#123;</span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WrappedCallable</span>&lt;&gt;(callable, requestAttributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">getThreadPool</span><span class="params">(HystrixThreadPoolKey threadPoolKey,</span></span><br><span class="line"><span class="params">                                            HystrixProperty&lt;Integer&gt; corePoolSize,</span></span><br><span class="line"><span class="params">                                            HystrixProperty&lt;Integer&gt; maximumPoolSize,</span></span><br><span class="line"><span class="params">                                            HystrixProperty&lt;Integer&gt; keepAliveTime,</span></span><br><span class="line"><span class="params">                                            TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hystrixConcurrencyStrategy.getThreadPool(threadPoolKey, corePoolSize, maximumPoolSize, keepAliveTime,</span><br><span class="line">                                                             unit, workQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">getThreadPool</span><span class="params">(HystrixThreadPoolKey threadPoolKey,</span></span><br><span class="line"><span class="params">                                            HystrixThreadPoolProperties threadPoolProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hystrixConcurrencyStrategy.getThreadPool(threadPoolKey, threadPoolProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BlockingQueue&lt;Runnable&gt; <span class="title function_">getBlockingQueue</span><span class="params">(<span class="type">int</span> maxQueueSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hystrixConcurrencyStrategy.getBlockingQueue(maxQueueSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; HystrixRequestVariable&lt;T&gt; <span class="title function_">getRequestVariable</span><span class="params">(HystrixRequestVariableLifecycle&lt;T&gt; rv)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.hystrixConcurrencyStrategy.getRequestVariable(rv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WrappedCallable</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;T&gt; target;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> RequestAttributes requestAttributes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">WrappedCallable</span><span class="params">(Callable&lt;T&gt; target, RequestAttributes requestAttributes)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.target = target;</span><br><span class="line">            <span class="built_in">this</span>.requestAttributes = requestAttributes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> T <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">                <span class="keyword">return</span> target.call();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                RequestContextHolder.resetRequestAttributes();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="5-7-测试"><a href="#5-7-测试" class="headerlink" title="5.7.测试"></a>5.7.测试</h4><p>发起请求调用,查看提供者服务是否能够降权成功，并且访问到资源。</p><h2 id="5-8-抽取公共client-common"><a href="#5-8-抽取公共client-common" class="headerlink" title="5.8 抽取公共client-common"></a>5.8 抽取公共client-common</h2><h3 id="1-抽取"><a href="#1-抽取" class="headerlink" title="1 抽取"></a>1 抽取</h3><p><img src="/breeze/b3ef3604/image40.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--写feign接口，导入openFeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/breeze/b3ef3604/image41.png"></p><h3 id="2-引用"><a href="#2-引用" class="headerlink" title="2 引用"></a>2 引用</h3><p><img src="/breeze/b3ef3604/image42.png"></p><h1 id="六-封装用户上下文-UserContextInfoHolder"><a href="#六-封装用户上下文-UserContextInfoHolder" class="headerlink" title="六. 封装用户上下文-UserContextInfoHolder"></a>六. 封装用户上下文-UserContextInfoHolder</h1><h2 id="gift-resource-common"><a href="#gift-resource-common" class="headerlink" title="gift-resource-common"></a>gift-resource-common</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginContextInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long loginUserId;</span><br><span class="line">    <span class="keyword">private</span> String loginUsername;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Long employeeId;</span><br><span class="line">    <span class="keyword">private</span> String empUsername;</span><br><span class="line">    <span class="keyword">private</span> Long tenantId;</span><br><span class="line">    <span class="keyword">private</span> String tenantName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; permissions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.58<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.holder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.vo.UserContextInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UserContextInfo类持有者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserContextInfoHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserContextInfo userContextInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取UserContextInfo</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserContextInfo  <span class="title function_">getUserContextInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> context.getAuthentication();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userContextInfoStr</span> <span class="operator">=</span> (String) authentication.getPrincipal(); <span class="comment">//Username-yaosang110</span></span><br><span class="line">        <span class="type">UserContextInfo</span> <span class="variable">userContextInfo</span> <span class="operator">=</span> JSONObject</span><br><span class="line">            .parseObject(userContextInfoStr, UserContextInfo.class);</span><br><span class="line">        <span class="keyword">return</span>  userContextInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gift-auth-service-4020-UserDetailsService返回用户信息"><a href="#gift-auth-service-4020-UserDetailsService返回用户信息" class="headerlink" title="gift-auth-service-4020 UserDetailsService返回用户信息"></a>gift-auth-service-4020 UserDetailsService返回用户信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.userdetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.clients.SysmanageServiceClient;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.domain.LoginUser;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.domain.Permission;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.exception.ValidUtils;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.mapper.LoginUserMapper;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.mapper.PermissionMapper;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.gift.vo.UserContextInfo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.EntityWrapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.bouncycastle.asn1.x500.style.RFC4519Style.l;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginUserMapper loginUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionMapper permissionMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysmanageServiceClient sysmanageServiceClient;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">//加载认证信息</span></span><br><span class="line">        List&lt;LoginUser&gt; loginUsers = loginUserMapper</span><br><span class="line">            .selectList(<span class="keyword">new</span> <span class="title class_">EntityWrapper</span>&lt;LoginUser&gt;().eq(<span class="string">&quot;username&quot;</span>, username));</span><br><span class="line">        ValidUtils.assertListNotNull(loginUsers, <span class="string">&quot;请输入用户名或密码！&quot;</span>);</span><br><span class="line">        <span class="comment">//加载权限信息</span></span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> loginUsers.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//yaosang110   new Xxx();</span></span><br><span class="line">        <span class="type">UserContextInfo</span> <span class="variable">userContextInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserContextInfo</span>();</span><br><span class="line">        userContextInfo.setLoginUserId(loginUser.getId());</span><br><span class="line">        userContextInfo.setLoginUsername(loginUser.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (loginUser.getType()==<span class="number">0</span>)&#123; <span class="comment">//管理员</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//只有管理员才有权限控制，用户登录就能他能操作的</span></span><br><span class="line">            List&lt;Permission&gt; permissions = permissionMapper.loadPermissionsByUserId(loginUser.getId());</span><br><span class="line">            List&lt;String&gt; permissionSns = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            permissions.forEach(permission -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sn</span> <span class="operator">=</span> permission.getSn();</span><br><span class="line">                authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(sn));</span><br><span class="line">                permissionSns.add(sn);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 远程调用Sysmanage的接口 loginId--employee-tenantId-TenantName</span></span><br><span class="line">            Map&lt;String, Object&gt; result = sysmanageServiceClient</span><br><span class="line">                .getEmpAndTenant(loginUser.getId());</span><br><span class="line">            <span class="type">Long</span> <span class="variable">tenantId</span> <span class="operator">=</span> Long.valueOf(result.get(<span class="string">&quot;tenantId&quot;</span>).toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">tenantName</span> <span class="operator">=</span> result.get(<span class="string">&quot;tenantName&quot;</span>).toString();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">employeeId</span> <span class="operator">=</span> Long.valueOf(result.get(<span class="string">&quot;employeeId&quot;</span>).toString());</span><br><span class="line">            <span class="type">String</span> <span class="variable">empUsername</span> <span class="operator">=</span> result.get(<span class="string">&quot;empUsername&quot;</span>).toString();</span><br><span class="line">            userContextInfo.setTenantId(tenantId);</span><br><span class="line">            userContextInfo.setTenantName(tenantName);</span><br><span class="line">            userContextInfo.setEmployeeId(employeeId);</span><br><span class="line">            userContextInfo.setEmpUsername(empUsername);</span><br><span class="line">            userContextInfo.setPermissions(permissionSns);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(JSON.toJSONString(userContextInfo),loginUser.getPassword(),authorities);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//@TODO 自己做</span></span><br><span class="line">            userContextInfo.setUserId(<span class="literal">null</span>);</span><br><span class="line">            userContextInfo.setUsername(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(JSON.toJSONString(userContextInfo),loginUser.getPassword(),<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.mliutm.gift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gift-sysmanage-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthServiceApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(AuthServiceApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gift-sysmanage-feign"><a href="#gift-sysmanage-feign" class="headerlink" title="gift-sysmanage-feign"></a>gift-sysmanage-feign</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.mliutm.gift<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gift-sysmanage-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--feign的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.clients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;sysmanage-service&quot;,fallbackFactory = SysmanageServiceClientFallBackFactory.class )</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SysmanageServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sysService/empAndTenant/&#123;loginUserId&#125;&quot;)</span></span><br><span class="line">    Map&lt;String,Object&gt; <span class="title function_">getEmpAndTenant</span><span class="params">(<span class="meta">@PathVariable(&quot;loginUserId&quot;)</span> Long loginUserId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.clients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysmanageServiceClientFallBackFactory</span> <span class="keyword">implements</span></span><br><span class="line">    <span class="title class_">FallbackFactory</span>&lt;SysmanageServiceClient&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SysmanageServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SysmanageServiceClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getEmpAndTenant</span><span class="params">(Long loginUserId)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gift-sysmanage-service-4010"><a href="#gift-sysmanage-service-4010" class="headerlink" title="gift-sysmanage-service-4010"></a>gift-sysmanage-service-4010</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysmanageServiceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ITenantService tenantService;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sysService/empAndTenant/&#123;loginUserId&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;sysService:getEmpAndTenant&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getEmpAndTenant</span><span class="params">(<span class="meta">@PathVariable(&quot;loginUserId&quot;)</span> Long loginUserId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tenantService.getEmpAndTenant(loginUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getEmpAndTenant</span><span class="params">(Long loginUserId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tenantMapper.loadByLoginId(loginUserId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  Mapper 接口</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yaosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-01-31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TenantMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Tenant&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Tenant&gt; <span class="title function_">loadPageList</span><span class="params">(Page&lt;Tenant&gt; page, TenantQuery query)</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String,Object&gt; <span class="title function_">loadByLoginId</span><span class="params">(Long loginUserId)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Map&lt;String,String&gt; loadByLoginId(Long loginUserId);</span></span><br><span class="line"><span class="comment"> Long tenantId = Long.valueOf(result.get(&quot;tenantId&quot;));</span></span><br><span class="line"><span class="comment">        String tenantName = result.get(&quot;tenantName&quot;);</span></span><br><span class="line"><span class="comment">        Long employeeId = Long.valueOf(result.get(&quot;employeeId&quot;));</span></span><br><span class="line"><span class="comment">        String empUsername = result.get(&quot;empUsername&quot;);</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadByLoginId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;map&quot;</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    e.id employeeId,</span><br><span class="line">    e.username empUsername,</span><br><span class="line">    t.id tenantId,</span><br><span class="line">    t.company_name tenantName</span><br><span class="line">    FROM</span><br><span class="line">    t_employee e</span><br><span class="line">    LEFT JOIN t_tenant t ON e.tenant_id = t.id</span><br><span class="line">    WHERE</span><br><span class="line">    login_id = #&#123;loginUserId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="七-服务之间临时授权"><a href="#七-服务之间临时授权" class="headerlink" title="七.服务之间临时授权"></a>七.服务之间临时授权</h1><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>客户端向认证中心发起请求获取Token,由于加载权限的时候租户信息在系统管理服务，这就意味着认证中心需要通过Feign调用系统管理，如果系统管理做了授权，那么认证中心就必须带着Token去访问，那这里就会产生一个问题，本来认证中心需要加载权限生成Token,而加载权限的时候又必须先传入一个Token过去，这不就矛盾了吗？如何解决？</p><p>我们可以在认证服务调用系统服务的时候通过拦截器拦截Feign，然后使用客户端模式生成临时的Token去访问系统服务，加载到权限再为用户生成Token。</p><p><img src="/breeze/b3ef3604/image43.png"></p><h3 id="2-编码实战"><a href="#2-编码实战" class="headerlink" title="2.编码实战"></a>2.编码实战</h3><p>如何生成临时的Token?使用客户端模式向认证服务器发送请求Http即可如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://localhost:<span class="number">4020</span>/oauth/token?client_id=temp&amp;client_secret=<span class="number">1</span>&amp;grant_type=client_credentials</span><br></pre></td></tr></table></figure><h4 id="准备工具-gift-basic-util"><a href="#准备工具-gift-basic-util" class="headerlink" title="准备工具 gift-basic-util"></a>准备工具 gift-basic-util</h4><h5 id="导入Http依赖"><a href="#导入Http依赖" class="headerlink" title="导入Http依赖"></a>导入Http依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.73<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="封装Http工具"><a href="#封装Http工具" class="headerlink" title="封装Http工具"></a>封装Http工具</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.gift.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送Post请求，注意：参数使用？方式带着URL后面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,String&gt; <span class="title function_">sendPost</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="comment">// 获得Http客户端(可以理解为:你得先有一个浏览器;注意:实际上HttpClient与浏览器是不一样的)</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClientBuilder.create().build();</span><br><span class="line">        <span class="comment">// 创建Post请求</span></span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">        <span class="comment">// 响应模型</span></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 由客户端执行(发送)Post请求</span></span><br><span class="line">            response = httpClient.execute(httpPost);</span><br><span class="line">            <span class="comment">// 从响应模型中获取响应实体</span></span><br><span class="line">            <span class="type">HttpEntity</span> <span class="variable">responseEntity</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line">            <span class="keyword">if</span> (responseEntity != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> JSON.parseObject(EntityUtils.toString(responseEntity),Map.class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 释放资源</span></span><br><span class="line">                <span class="keyword">if</span> (httpClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                    httpClient.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加拦截器-gift-auth-service-4020"><a href="#添加拦截器-gift-auth-service-4020" class="headerlink" title="添加拦截器-gift-auth-service-4020"></a>添加拦截器-gift-auth-service-4020</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2FeignRequestInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TEMPTOKENURL</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:1110/oauth/token?client_id=%s&amp;client_secret=%s&amp;grant_type=client_credentials&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头中的token</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHORIZATION_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Authorization&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">        <span class="comment">//requestTemplate:feign底层用来发请求的http客户端</span></span><br><span class="line">        <span class="comment">//使用客户端模式生成一个临时的Token</span></span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; tokenMap = HttpUtil.sendPost(String.format(TEMPTOKENURL, <span class="string">&quot;temp&quot;</span>, <span class="string">&quot;123&quot;</span>));</span><br><span class="line">        ValidUtils.assertNotNull(tokenMap,<span class="string">&quot;服务调用失败[临时Token获取失败]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;Feign拦截器添加请求头：&#123;&#125;&quot;</span>,tokenMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.添加到Feign的请求头</span></span><br><span class="line">        requestTemplate.header(AUTHORIZATION_HEADER,<span class="string">&quot;Bearer &quot;</span>+tokenMap.get(<span class="string">&quot;access_token&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置客户端详情"><a href="#配置客户端详情" class="headerlink" title="配置客户端详情"></a>配置客户端详情</h4><p>我们要为临时Token准备一个客户端详情配置</p><p><img src="/breeze/b3ef3604/image44.png"></p><p>解释：temp作为临时的Token，可以在authorities配置默认权限</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/b3ef3604.html">https://mliutm.github.io/breeze/b3ef3604.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/oauth2/">oauth2</a><a class="post-meta__tags" href="/tags/jwt/">jwt</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1645943020355-305df166473d.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/1a45f578.html" title="JVM优化"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM优化</div></div></a></div><div class="next-post pull-right"><a href="/breeze/797f8627.html" title="MySQL单机优化"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL单机优化</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%96%B9%E6%A1%88"><span class="toc-text">一. 常见的认证授权方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84Session"><span class="toc-text">有状态的Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%99%AE%E9%80%9Asession-%E5%85%A8%E6%A0%88%E4%B8%8D%E9%9B%86%E7%BE%A4%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.1 普通session-全栈不集群项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E5%85%B1%E4%BA%ABSession-%E5%85%A8%E6%A0%88%E9%9B%86%E7%BE%A4"><span class="toc-text">1.2共享Session-全栈集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-tomcat-redis-session-manager"><span class="toc-text">1.2.1 tomcat-redis-session-manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-Spring-Session"><span class="toc-text">1.2.2 Spring Session</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81token"><span class="toc-text">无状态token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E6%99%AE%E9%80%9Atoken%EF%BC%88redis-key%E4%B8%BAtoken%E5%80%BC%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83%E4%BF%A1%E6%81%AF%EF%BC%89-%E6%9C%8D%E5%8A%A1%E7%AB%AFtoken"><span class="toc-text">2.1普通token（redis key为token值认证和授权信息）-服务端token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-JwtToken-redis%E5%8F%AF%E4%BB%A5%E4%B8%8D%E5%AD%98-%E5%AE%A2%E6%88%B7%E7%AB%AFtoken"><span class="toc-text">2.2 JwtToken(redis可以不存)-客户端token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E5%9E%8B"><span class="toc-text">选型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-OAUTH2"><span class="toc-text">二. OAUTH2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFOauth2"><span class="toc-text">什么是Oauth2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Oauth2"><span class="toc-text">为什么需要Oauth2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E8%AE%A4%E7%9F%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">传统认知模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Oauth2%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-text">Oauth2授权码模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oauth2%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">Oauth2授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Oauth2%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">Oauth2相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%EF%BC%88authorization-code%EF%BC%89-%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">3.1.授权码模式（authorization code）-微信登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E7%AE%80%E5%8C%96%E6%A8%A1%E5%BC%8F%EF%BC%88implicit%EF%BC%89-%E5%9F%BA%E6%9C%AC%E4%B8%8D%E7%94%A8-%E4%B8%8D%E5%AE%89%E5%85%A8-%E4%B9%9F%E6%B2%A1%E9%82%A3%E4%B9%88%E7%AE%80%E5%8D%95"><span class="toc-text">3.2.简化模式（implicit）-基本不用,不安全,也没那么简单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%EF%BC%88resource-owner-password-credentials%EF%BC%89-qq%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95"><span class="toc-text">3.3.密码模式（resource owner password credentials） qq三方登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F%EF%BC%88client-credentials%EF%BC%89"><span class="toc-text">3.4.客户端模式（client credentials）</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-Spring-Cloud-OAUTH2"><span class="toc-text">三. Spring Cloud OAUTH2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1.概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Springcloud-Oauth2%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1.Springcloud-Oauth2介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Oauth2%E8%AE%A4%E8%AF%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">1.2.Oauth2认证解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-%E7%95%A5%E8%BF%87%E7%9B%B4%E6%8E%A5%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD"><span class="toc-text">2.环境准备-略过直接在项目中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%90%AD%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="toc-text">2.1.搭建父工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E6%90%AD%E5%BB%BAEurekaServer%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">2.2搭建EurekaServer注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAZuulServer%E7%BD%91%E5%85%B3%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">搭建ZuulServer网关微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%90%AD%E5%BB%BAAuthServer%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.4.搭建AuthServer认证授权微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%90%AD%E5%BB%BAResourceServer%E8%B5%84%E6%BA%90%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.5.搭建ResourceServer资源微服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1AuthServer%E6%90%AD%E5%BB%BA-%E7%9B%B4%E6%8E%A5%E4%BB%8E%E8%BF%99%E5%84%BF%E5%BC%80%E5%A7%8B%E5%81%9A-gift-auth"><span class="toc-text">3.认证服务AuthServer搭建-直接从这儿开始做(gift-auth)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90MyBatis"><span class="toc-text">集成MyBatis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AuthServer%E6%94%AF%E6%8C%81Spring-security"><span class="toc-text">AuthServer支持Spring security</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1%E5%AE%9A%E4%B9%89UserDetailsService"><span class="toc-text">3.2.1定义UserDetailsService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-spring-security%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2.2.spring security配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-AuthorizationServer-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-text">3.4.AuthorizationServer-授权服务配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%B1%BB-AuthorizationServerConfigurerAdapter"><span class="toc-text">1.授权服务配置类-AuthorizationServerConfigurerAdapter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%A6%E6%83%85"><span class="toc-text">授权服务配置-客户端详情</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE-%E9%85%8D%E7%BD%AE%E4%BB%A4%E7%89%8C%E5%92%8C%E6%8E%88%E6%9D%83%E7%A0%81"><span class="toc-text">3.授权服务配置-配置令牌和授权码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE-%E7%AB%AF%E7%82%B9%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">4.授权服务配置-端点安全配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E6%8E%88%E6%9D%83%E6%B5%8B%E8%AF%95"><span class="toc-text">3.5.授权测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-1-%E6%8E%88%E6%9D%83%E7%A0%81%E6%96%B9%E5%BC%8F%E8%8E%B7%E5%8F%96Token"><span class="toc-text">3.5.1.授权码方式获取Token</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-2-%E5%AF%86%E7%A0%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">3.5.2.密码授权模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5-3-%E5%88%B7%E6%96%B0token"><span class="toc-text">3.5.3.刷新token</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA-gift-sysmanage-service%E7%AD%89"><span class="toc-text">4.资源服务搭建-gift-sysmanage-service等</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%A1%B9%E7%9B%AE%E4%BF%AE%E6%94%B9"><span class="toc-text">4.1.项目修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-Oauth2%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-text">4.2.Oauth2资源配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E7%BC%96%E5%86%99%E8%B5%84%E6%BA%90controller"><span class="toc-text">4.3.编写资源controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">4.4.测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%B0%8F%E7%BB%93"><span class="toc-text">5.小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-Spring-Cloud-OAUTH2-JWT%E4%BB%A4%E7%89%8C"><span class="toc-text">四. Spring Cloud-OAUTH2+JWT令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%A4%E8%AF%86JWT"><span class="toc-text">1.认识JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8JWT%E4%BB%A4%E7%89%8C"><span class="toc-text">1.1.为什么要用JWT令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AFJWT"><span class="toc-text">1.2.什么是JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-JWT%E7%89%B9%E7%82%B9"><span class="toc-text">1.3.JWT特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-JWT%E7%BB%84%E6%88%90"><span class="toc-text">1.4.JWT组成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AEJWT"><span class="toc-text">2 授权服务配置JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJWT%E7%9A%84TokenStore%E9%85%8D%E7%BD%AE"><span class="toc-text">基于JWT的TokenStore配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%BB%A4%E7%89%8C%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E4%BF%AE%E6%94%B9"><span class="toc-text">2.2.令牌管理服务修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3.测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AEJWT"><span class="toc-text">3.资源服务配置JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%AE%9A%E4%B9%89JwtAccessTokenConverter"><span class="toc-text">3.1.定义JwtAccessTokenConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E4%BF%AE%E6%94%B9ResourceServerSecurityConfigurer"><span class="toc-text">3.2.修改ResourceServerSecurityConfigurer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%B5%8B%E8%AF%95"><span class="toc-text">3.3.测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8A%BD%E5%8F%96%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97"><span class="toc-text">4.抽取资源服务公共模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E4%B8%94%E5%AF%BC%E5%85%A5jar"><span class="toc-text">4.1 创建项目并且导入jar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-%E7%88%B6%E6%A8%A1%E5%9D%97"><span class="toc-text">4.2.1 父模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="toc-text">4.2.2 资源服务模块</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E6%B5%8B%E8%AF%95"><span class="toc-text">4.3 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-text">五. 微服务之间的授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0-1"><span class="toc-text">1.概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%8E%88%E6%9D%83"><span class="toc-text">1.1.微服务之间为什么需要授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">1.2.解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-text">2.服务提供者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-text">2.1.搭建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Oauth2%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.Oauth2资源配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E7%BC%96%E5%86%99Controller"><span class="toc-text">2.3.编写Controller</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">3.服务消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">3.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E9%9B%86%E6%88%90Feign"><span class="toc-text">3.2.集成Feign</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1"><span class="toc-text">3.3.服务通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%B5%8B%E8%AF%95%E9%80%9A%E4%BF%A1"><span class="toc-text">3.4.测试通信</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">拦截器配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="toc-text">4.1.创建模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%AE%9A%E4%B9%89Feign%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8-%E7%9B%B4%E6%8E%A5%E4%BB%8E%E8%BF%99%E5%84%BF%E5%BC%80%E5%A7%8B%EF%BC%88%E8%AF%BE%E7%A8%8B%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-text">4.2.定义Feign的拦截器-直接从这儿开始（课程服务）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-Feign%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">4.3.Feign拦截器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E4%BE%9D%E8%B5%96%E6%8B%A6%E6%88%AA%E5%99%A8%E6%A8%A1%E5%9D%97"><span class="toc-text">4.4.资源服务依赖拦截器模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E6%B5%8B%E8%AF%95%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E6%8E%88%E6%9D%83"><span class="toc-text">4.5.测试服务之间授权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hystrix%E5%AF%BC%E8%87%B4Token%E8%BD%AC%E5%8F%91%E5%A4%B1%E8%B4%A5"><span class="toc-text">Hystrix导致Token转发失败</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Hystrix%E5%BC%95%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">Hystrix引发的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E9%9B%86%E6%88%90Hystrix"><span class="toc-text">5.2.集成Hystrix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-Feign%E6%8E%A5%E5%8F%A3%E6%8C%87%E5%AE%9AFallback"><span class="toc-text">5.3.Feign接口指定Fallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E7%BC%96%E5%86%99%E9%99%8D%E7%BA%A7%E7%B1%BB"><span class="toc-text">5.4.编写降级类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5%E6%B5%8B%E8%AF%95Hystrix%E5%AF%BC%E5%85%A5%E8%BD%AC%E5%8F%91%E5%A4%B1%E8%B4%A5"><span class="toc-text">5.5测试Hystrix导入转发失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-%E5%AE%9A%E4%B9%89Hystrix%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5-%E7%9B%B4%E6%8E%A5%E4%BB%8E%E8%BF%99%E5%84%BF%E5%BC%80%E5%A7%8B"><span class="toc-text">5.6.定义Hystrix隔离策略-直接从这儿开始</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-%E6%B5%8B%E8%AF%95"><span class="toc-text">5.7.测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8-%E6%8A%BD%E5%8F%96%E5%85%AC%E5%85%B1client-common"><span class="toc-text">5.8 抽取公共client-common</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8A%BD%E5%8F%96"><span class="toc-text">1 抽取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%95%E7%94%A8"><span class="toc-text">2 引用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD-%E5%B0%81%E8%A3%85%E7%94%A8%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87-UserContextInfoHolder"><span class="toc-text">六. 封装用户上下文-UserContextInfoHolder</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gift-resource-common"><span class="toc-text">gift-resource-common</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gift-auth-service-4020-UserDetailsService%E8%BF%94%E5%9B%9E%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">gift-auth-service-4020 UserDetailsService返回用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gift-sysmanage-feign"><span class="toc-text">gift-sysmanage-feign</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gift-sysmanage-service-4010"><span class="toc-text">gift-sysmanage-service-4010</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83-%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E4%B8%B4%E6%97%B6%E6%8E%88%E6%9D%83"><span class="toc-text">七.服务之间临时授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BC%96%E7%A0%81%E5%AE%9E%E6%88%98"><span class="toc-text">2.编码实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E5%85%B7-gift-basic-util"><span class="toc-text">准备工具 gift-basic-util</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5Http%E4%BE%9D%E8%B5%96"><span class="toc-text">导入Http依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Http%E5%B7%A5%E5%85%B7"><span class="toc-text">封装Http工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%8B%A6%E6%88%AA%E5%99%A8-gift-auth-service-4020"><span class="toc-text">添加拦截器-gift-auth-service-4020</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%A6%E6%83%85"><span class="toc-text">配置客户端详情</span></a></li></ol></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1645943020355-305df166473d.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>