<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>SpringCloud-Alibaba快速入门 | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloud Alibabaeureka ribbon&#x2F;openFeign  hystrix zuul config 内容 SpringCloud Alibaba介绍 Nacos服务注册与发现-注册中心替换eureka Nacos配置中心-替换config server springcloud gateway-替换zuul Sentinel熔断限流-替换hystrix ribb"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud-Alibaba快速入门"><meta property="og:url" content="https://mliutm.github.io/breeze/ab319c68.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="SpringCloud Alibabaeureka ribbon&#x2F;openFeign  hystrix zuul config 内容 SpringCloud Alibaba介绍 Nacos服务注册与发现-注册中心替换eureka Nacos配置中心-替换config server springcloud gateway-替换zuul Sentinel熔断限流-替换hystrix ribb"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1692708632140-ee01624d558d.jpg"><meta property="article:published_time" content="2024-01-13T07:02:17.000Z"><meta property="article:modified_time" content="2024-01-13T12:09:03.647Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1692708632140-ee01624d558d.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/ab319c68.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"SpringCloud-Alibaba快速入门",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-13 20:09:03"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1692708632140-ee01624d558d.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud-Alibaba快速入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-13T07:02:17.000Z" title="发表于 2024-01-13 15:02:17">2024-01-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-13T12:09:03.647Z" title="更新于 2024-01-13 20:09:03">2024-01-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringCloud/">SpringCloud</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>49分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="SpringCloud-Alibaba快速入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SpringCloud-Alibaba"><a href="#SpringCloud-Alibaba" class="headerlink" title="SpringCloud Alibaba"></a>SpringCloud Alibaba</h1><p>eureka ribbon&#x2F;openFeign hystrix zuul config</p><h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ul><li>SpringCloud Alibaba介绍</li><li><strong>Nacos</strong>服务注册与发现-注册中心替换eureka</li><li>Nacos配置中心-替换config server</li><li>springcloud <strong>gateway</strong>-替换zuul</li><li><strong>Sentinel</strong>熔断限流-替换hystrix</li><li>ribbon&#x2F;open feign是通用的-<strong>dubbo</strong></li></ul><h2 id="一-SpringCloudAlibaba介绍"><a href="#一-SpringCloudAlibaba介绍" class="headerlink" title="一.SpringCloudAlibaba介绍"></a>一.SpringCloudAlibaba介绍</h2><h3 id="1-SpringCloudAlibaba认识"><a href="#1-SpringCloudAlibaba认识" class="headerlink" title="1.SpringCloudAlibaba认识"></a>1.SpringCloudAlibaba认识</h3><h4 id="1-1-为什么会出现SpringCloudAlibaba"><a href="#1-1-为什么会出现SpringCloudAlibaba" class="headerlink" title="1.1.为什么会出现SpringCloudAlibaba"></a>1.1.为什么会出现SpringCloudAlibaba</h4><p>​	早期在国内做分布式(微服务)应用Dubbo是比较热门的框架，被许多互联网公司所采用，并产生了许多衍生版本，如网易，京东，新浪，当当等等，奈何在2014年10月Dubbo停止维护，在Dubbo停更的时间里Spring Cloud快速追赶上。在2017年9月，阿里宣布重启Dubbo项目，计划对Dubbo进行持续更新维护。2018.2月，阿里将Dubbo捐献给Apache基金会，Dubbo成为Apache孵化器项目。</p><p>所以当前微服务架构，Dubbo和SpringCloud比较火，另外还有Thrift、gRPC等等 。很多人把SpringCloud 和Dubbo进行对比，其实两个框架并没有太大的可比性，因为他们的定位不同。Spring Cloud是一个完整的微服务解决方案,它提供了微服务各问题的解决方案集合，而Dubbo是一个高性能的RPC框架，它有着很多功能的缺失。</p><p>但是很多企业一边想要Dubbo的高性能RPC ，一边又想要Spring Cloud 完整的生态，然后在项目中出现了两个微服务框架的身影 。甚至市面上出现了一些Dubbo和Spring Cloud的融合方案，但是最终都不是特别成熟。直到Spring Cloud官方出现了Spring Cloud Alibaba 才算是吧Dubbo和Spring Cloud真正的融合在一起。</p><p>​ <strong>使用springcloud alibaba你就可以使用dubbo来做远程调用!!</strong></p><h4 id="1-2-什么是-Spring-Cloud-Alibaba"><a href="#1-2-什么是-Spring-Cloud-Alibaba" class="headerlink" title="1.2.什么是 Spring Cloud Alibaba"></a>1.2.什么是 Spring Cloud Alibaba</h4><p>下面是Spring Cloud 官方对Spring Cloud Alibaba的介绍</p><blockquote><p>Spring Cloud Alibaba旨在为微服务开发提供一站式解决方案。该项目包括开发分布式应用程序和服务所需的组件，以便开发人员可以使用Spring Cloud编程模型轻松开发分布式应用程序。使用Spring Cloud Alibaba，您只需要添加一些注释和配置，就可以为您的应用程序使用Alibaba的分布式解决方案，并使用Alibaba中间件构建自己的分布式系统。</p></blockquote><p>Spring Cloud Alibaba其实是阿里的微服务解决方案，是阿里巴巴结合自身微服务实践,开源的微服务全家桶，在Spring Cloud项目中孵化成为Spring Cloud的子项目。第一代的Spring Cloud(springcloud netflix)标准中很多组件已经停更,如：Eureak,zuul等。所以Spring Cloud Alibaba很有可能成为Spring Cloud第二代的标准实现，所以许多组件在业界逐渐开始使用，已有很多成功案例。<strong>值得一提的是Spring Cloud Alibaba对Dubbo做了很好的兼容</strong>，同时也提供了一些强大的功能，如 Sentinel 流控 ，Seata 分布式事务，Nacos 服务发现与注册等等。</p><p><strong>Spring Cloud Alibaba的功能</strong></p><p>Spring Cloud Alibaba是阿里巴巴结合自身的微服务实践开源的微服务全家桶，我个人觉得其组件比Spring Cloud 中的组件更加好用和强大。并且对的Spring Cloud组件做了很好的兼容。比如在Spirng Cloud Alibaba中依然可以使用Feign作为服务调用方式，使用Eureak做服务注册发现等等。Spring Cloud Alibaba主要的功能如下：</p><ul><li>服务注册和发现(nacos)：可以注册服务，并且客户可以使用Spring托管的bean（自动集成功能区）发现实例。注册中心</li><li>分布式配置（nacos）：支持分布式系统中的外部配置，配置更改时自动刷新。 配置中心</li><li>流控制和服务降级(Sentinel )：支持WebServlet，**WebFlux–&gt;(比Springmvc更高级)**，OpenFeign，RestTemplate，Dubbo访问限制和降级流的功能。它可以在运行时通过控制台实时修改限制和降级流的规则，并且还支持监视限制和降级度量标准。 - 服务熔断限流hystrix</li><li>Rpc服务：扩展Spring Cloud客户端RestTemplate(ribbon)和OpenFeign以支持调<strong>用Dubbo RPC服务。</strong></li><li>分布式事务（seata）：支持高性能且易于使用的分布式事务解决方案。</li><li>事件驱动：支持构建与共享消息系统连接的高度可扩展的事件驱动微服务。</li><li>阿里云对象存储：大规模，安全，低成本，高度可靠的云存储服务。支持随时随地在任何应用程序中存储和访问任何类型的数据。</li><li>阿里云SchedulerX：准确，高度可靠，高可用性的计划作业调度服务，响应时间在几秒钟内。</li><li>阿里云短信：阿里云短信服务覆盖全球，提供便捷，高效，智能的通信功能，帮助企业快速联系客户。</li><li>gateway网关</li></ul><h3 id="2-SpringCloud-netflix和SpringCloudAlibaba"><a href="#2-SpringCloud-netflix和SpringCloudAlibaba" class="headerlink" title="2.SpringCloud netflix和SpringCloudAlibaba"></a>2.SpringCloud netflix和SpringCloudAlibaba</h3><h4 id="2-1-两代技术对比"><a href="#2-1-两代技术对比" class="headerlink" title="2.1.两代技术对比"></a>2.1.两代技术对比</h4><p>下面是SpringCloud 和 Spring Cloud Alibaba(命名 Dubbo Spring Cloud )的功能对比</p><table><thead><tr><th>功能组件</th><th>Spring Cloud netflix</th><th>Spring Cloud alibaba</th></tr></thead><tbody><tr><td>分布式配置（Distributed configuration）</td><td>springcloud config</td><td>Nacos</td></tr><tr><td>服务注册与发现（Service registration and discovery）</td><td>Eureka</td><td>Nacos</td></tr><tr><td>网关</td><td>zuul</td><td>springcloud cloud gateway</td></tr><tr><td>负载均衡（Load balancing）</td><td>Ribbon（随机、轮询等算法）</td><td>ribbon&#x2F;Dubbo 内建实现（随机、轮询等算法 + 权重等特性）</td></tr><tr><td>服务熔断（Circuit Breakers）</td><td>hystrix</td><td>Alibaba Sentinel 等</td></tr><tr><td>服务调用（Service-to-service calls）</td><td>Open Feign、RestTemplate</td><td>Open Feign、RestTemplate、dubbo</td></tr><tr><td>链路跟踪（Tracing）</td><td>Spring Cloud Sleuth + Zipkin</td><td>Zipkin、opentracing,skyworking 等</td></tr></tbody></table><h4 id="2-2-Spring-Cloud-Alibaba的版本"><a href="#2-2-Spring-Cloud-Alibaba的版本" class="headerlink" title="2.2.Spring Cloud Alibaba的版本"></a>2.2.Spring Cloud Alibaba的版本</h4><p>Spring Cloud Alibaba是Spring Cloud的子项目 ，Spring Cloud 基于Spring Boot，所以我们在选择版本的时候需要考虑三个框架的版本，目前官方给出的版本如下：</p><table><thead><tr><th>Spring Cloud Version</th><th>Spring Cloud Alibaba Version</th><th>Spring Boot Version</th></tr></thead><tbody><tr><td>Spring Cloud Hoxton(ribbon,openFeign)</td><td>2.2.x.RELEASE(nacos)</td><td><strong>2.2.x.RELEASE</strong></td></tr><tr><td>Spring Cloud Greenwich</td><td>2.1.x.RELEASE</td><td>2.1.x.RELEASE</td></tr><tr><td>Spring Cloud Finchley</td><td>2.0.x.RELEASE</td><td>2.0.x.RELEASE</td></tr><tr><td>Spring Cloud Edgware</td><td>1.5.x.RELEASE</td><td>1.5.x.RELEASE</td></tr></tbody></table><h2 id="二-Nacos服务注册与发现"><a href="#二-Nacos服务注册与发现" class="headerlink" title="二.Nacos服务注册与发现"></a>二.Nacos服务注册与发现</h2><h3 id="1-Nacos认识与安装"><a href="#1-Nacos认识与安装" class="headerlink" title="1.Nacos认识与安装"></a>1.Nacos认识与安装</h3><h4 id="1-1-什么是Nacos"><a href="#1-1-什么是Nacos" class="headerlink" title="1.1.什么是Nacos"></a>1.1.什么是Nacos</h4><p>我们学习了netflix 的 Eureka 组件作为微服务的服务发现。Nacos和Eureka有着相同的能力，甚至更为强大，作为Dubbo 生态系统中重要的注册中心实现。官方对它有如下定义：</p><blockquote><p>Nacos致力于帮助您发现，配置和管理微服务。它提供了一组简单有用的功能，使您能够实现动态服务发现，服务配置，服务元数据和流量管理。<br>Nacos使构建，交付和管理微服务平台变得更容易，更快捷。它是通过微服务或云原生方法支持以服务为中心的现代应用程序体系结构的基础架构。</p></blockquote><p>这里我们看到Nacos不仅是服务发现组件，同时也是一个配置管理组件，也就是说它不仅可以用来取代Eureka作为注册中心， 也可以用来取代Spring Cloud Config 做配置统一管理。本篇文章意在探讨Nacos的服务注册与发现功能。</p><h4 id="1-2-Nacos服务端安装"><a href="#1-2-Nacos服务端安装" class="headerlink" title="1.2.Nacos服务端安装"></a>1.2.Nacos服务端安装</h4><p>官方提供了Nacos的服务端供我们下载使用，我们启动Nacos后将我们的微服务注册进入Nacos即可。</p><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p><p>启动Nacos：解压后，</p><ul><li><p>windows执行bin目录下的startup命令 ：startup.cmd -m standalone</p></li><li><p>linux 执行 ：sh startup.sh -m standalone</p></li></ul><p>访问Nacos，端口8848：<a target="_blank" rel="noopener" href="http://127.0.0.1:8848/nacos/index.html">http://127.0.0.1:8848/nacos/index.html</a> ，用户名和密码都是：nacos<br><img src="/breeze/ab319c68/20200416193039921.png" alt="在这里插入图片描述"></p><p>登录成功之后</p><p><img src="/breeze/ab319c68/20200416193215863.png" alt="在这里插入图片描述"></p><h3 id="2-项目结构搭建"><a href="#2-项目结构搭建" class="headerlink" title="2.项目结构搭建"></a>2.项目结构搭建</h3><h4 id="2-1-服务调用流程"><a href="#2-1-服务调用流程" class="headerlink" title="2.1.服务调用流程"></a>2.1.服务调用流程</h4><p>我们这里要演示的案例是两个服务的通信，用户服务(user-server)作为服务提供者需要编写接口返回User实体对象，订单服务(order-server)作为消费者需要调用用户服务获取User实体对象，浏览器调用订单服务，订单服务调用用户服务或到User实体后返回给容器，用户和订单都注册到Nacos中，如下：<br><img src="/breeze/ab319c68/20200621230337114.png" alt="在这里插入图片描述"><br>注意：这里的订单服务和用户服务都用到了User实体，所以为了让User实体共用，我们为User实体抽取了一个公共的user-common模块，用户服务和订单服务都去依赖这个模块即可使用User实体。</p><h4 id="2-2-项目结构搭建"><a href="#2-2-项目结构搭建" class="headerlink" title="2.2.项目结构搭建"></a>2.2.项目结构搭建</h4><p>我们根据上面的图例来搭建项目环境，这里使用多模块方式演示，搭建父工程，提供者服务，消费者服务，以及公共的user-common模块，结构如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">springcloudalibaba-parent</span><br><span class="line">pom.xml</span><br><span class="line">	springcloudalibaba-order-common			<span class="comment">//公共的order实体，服务调用传输对象</span></span><br><span class="line">	springcloudalibaba-order-server-<span class="number">10020</span>	<span class="comment">//提供者服务</span></span><br><span class="line">	springcloudalibaba-user-server-<span class="number">10010</span>		<span class="comment">//消费者服务</span></span><br></pre></td></tr></table></figure><p><strong>父工程搭建</strong><br>搭建父工程springcloudalibaba-parent并管理相关依赖，Spring boot版本为2.1.3.RELEASE，Spring Cloud 版本为Greenwich.SR1，Alibaba版本为2.1.0.RELEASE ，父工程的pom如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--公共的一些配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--SpringBoot--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span> org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--SpringCloud--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--导入lombok--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3-服务注册到Nacos-重要"><a href="#3-服务注册到Nacos-重要" class="headerlink" title="3.服务注册到Nacos(重要)"></a>3.服务注册到Nacos(重要)</h3><h4 id="3-1-导入依赖"><a href="#3-1-导入依赖" class="headerlink" title="3.1.导入依赖"></a>3.1.导入依赖</h4><p>修改springcloudalibaba-user-server-1010导入服务发现依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud <span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--加入WEB依赖是为了方便后面写Controller--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-2-主配置类"><a href="#3-2-主配置类" class="headerlink" title="3.2.主配置类"></a>3.2.主配置类</h4><p>创建配置类加上@EnableDiscoveryClient注解开启服务发现功能，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务注册与发现</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServerApplication1010</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserServerApplication1010.class) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-配置文件"><a href="#3-3-配置文件" class="headerlink" title="3.3.配置文件"></a>3.3.配置文件</h4><p>配置文件主要配置端口，服务名，已经nacos注册中心地址</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>	<span class="comment">#注册中心地址</span></span><br></pre></td></tr></table></figure><h4 id="3-4-启动测试"><a href="#3-4-启动测试" class="headerlink" title="3.4.启动测试"></a>3.4.启动测试</h4><p>启动服务提供者，观察Nacos服务列表 ， user-server已经注册进去了<br><img src="/breeze/ab319c68/20200416194645223.png" alt="在这里插入图片描述"></p><p>扩展1:namespace+group</p><p><img src="/breeze/ab319c68/1669602750200.png" alt="1669602750200"></p><p>扩展2:nacos集群-使用nginx来做负载均衡器</p><p><img src="/breeze/ab319c68/1669604782882.png" alt="1669604782882"></p><h3 id="4-服务通信"><a href="#4-服务通信" class="headerlink" title="4.服务通信"></a>4.服务通信</h3><p>服务通信可以使用Ribbon,<strong>OpenFeign</strong>，甚至Dubbo，使用方式和在SpirngCloudNetflix中没有任何区别。</p><p>​ 和原来一个吊样</p><p><img src="/breeze/ab319c68/Users\Administrator\AppData\Roaming\Typora\typora-user-images\1701227257007.png" alt="1701227257007"></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39940489/article/details/123915730">https://blog.csdn.net/qq_39940489/article/details/123915730</a></p><h2 id="三-Nacos配置管理"><a href="#三-Nacos配置管理" class="headerlink" title="三.Nacos配置管理"></a>三.Nacos配置管理</h2><h3 id="1-Nacos配置中心"><a href="#1-Nacos配置中心" class="headerlink" title="1.Nacos配置中心"></a>1.Nacos配置中心</h3><h4 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1.概述"></a>1.1.概述</h4><p>在《SpringCloud极简入门》中我们通过Spring Cloud Config作为统一配置文件管理中心，其实我们总结一下发现Spring Cloud Config使用起来总归比较麻烦。Nacos作为Spring Cloud Alibaba的一个重要组件，它不仅可以用作服务注册与发现，也可以用来替代Spring Cloud Config作为统一配置文件管理，而且他的使用更为简单和人性化。</p><h4 id="1-2-Nacos添加配置"><a href="#1-2-Nacos添加配置" class="headerlink" title="1.2.Nacos添加配置"></a>1.2.Nacos添加配置</h4><p>第一步：打开Nacos监控面板 - 进入配置列表 -点击 <strong>“+”</strong> 图标添加配置 如下：<br><img src="/breeze/ab319c68/20200420001512530.png" alt="在这里插入图片描述"></p><p>第二步：填写Data ID,选择YAML,编辑配置文件内容</p><p><img src="/breeze/ab319c68/20200419231241782.png" alt="在这里插入图片描述"></p><p>这里定义了一个名字为application-user-dev.yaml的配置，使用的是YAML格式。</p><ul><li><p><code>Data ID</code> : 非常重要，可以看做是配置的文件的名字，在程序中拉取配置文件的时候需要指定Data ID。</p></li><li><p><code>Group</code> : 分组，默认是 DEFAULT_GROUP , 可以针对不同的项目指定不同的配置组。</p></li></ul><h3 id="2-客户端接入配置中心-重要"><a href="#2-客户端接入配置中心-重要" class="headerlink" title="2.客户端接入配置中心(重要)"></a>2.客户端接入配置中心(重要)</h3><h4 id="2-1-导入依赖"><a href="#2-1-导入依赖" class="headerlink" title="2.1.导入依赖"></a>2.1.导入依赖</h4><p>修改工程 springcloudalibaba-user-server-1010 ，添加配置中心依赖nacos-config，完整pom.xml如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        配置中心客户端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 服务注册与发现--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud <span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloudalibaba-user-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-编写Controller"><a href="#2-2-编写Controller" class="headerlink" title="2.2.编写Controller"></a>2.2.编写Controller</h4><p>下面的Controller用来做配置刷新测试，<code>temp.notify</code>对应了配置文件中的配置项目。<code>@RefreshScope</code>注解是用来做配置自动刷新。那么当我们修改了Nacos中的配置文件，Controller中读取到的配置<code>temp.notify</code>将会自动变化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span>  <span class="comment">//刷新配置</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;temp.notify&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String notify;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;测试配置notify=&quot;</span>notify);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs:&quot;</span>+id, <span class="string">&quot;我是zs&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-3-修改yml配置"><a href="#2-3-修改yml配置" class="headerlink" title="2.3.修改yml配置"></a>2.3.修改yml配置</h4><p>注意，将原来的配置文件修改成bootstrap.yml，然后增加如下内容：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#注册中心</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置中心</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#配置文件格式</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">application-user</span> <span class="comment">#配置前缀 ，默认使用sring.application.name</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment">#默认分组</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#如何查找配置文件:application-user + dev + yaml=application-user-dev.yaml 正好和Nacos配置的DataId一致</span></span><br></pre></td></tr></table></figure><p>提示：客户端是如何从Nacos中找到配置文件的呢？</p><ul><li><code>spring.cloud.nacos.config.server-addr</code> ：配置了Nacos的地址</li><li><code>spring.cloud.nacos.config.file-extension</code>：指定了配置文件的格式为YAML,默认是properties,</li><li><code>spring.cloud.nacos.config.prefix</code>：配置前缀，如果不配置前缀默认会把 服务名即<code>spring.application.name</code>的值作为前缀</li><li><code>spring.cloud.nacos.config.group</code> ：分组名，默认是DEFAULT_GROUP对应了Nacos配置中的Group</li><li><code>spring.profiles.active</code>：配置了环境为dev .该配置可以实现多配置多环境管理</li></ul><p>根据如上配置，那么config客户端会将：前缀+环境+后缀 拼接成的文件名“<code>application-user-dev.yaml</code>” 去Nacos上查找是否有对应Data ID的配置文件。</p><h4 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4.测试"></a>2.4.测试</h4><p>启动Nacos，启动 springcloudalibaba-user-server-1010 工程 ， 修改Nacos中的配置文件内容，然后访问 <code>http://localhost:1010/user/11</code> ,观察控制台打印的 “notify”的值会发生变化。</p><h4 id="2-5-注意细节"><a href="#2-5-注意细节" class="headerlink" title="2.5.注意细节"></a>2.5.注意细节</h4><ul><li>云端配置文件的后缀应该是 yaml而不是yml</li><li>客户端配置需要指定：spring.profiles.active&#x3D;dev 环境名</li><li>客户端配置 ：前缀 + 环境名 + 后缀应该和云端配置文件的DataId一致</li></ul><h3 id="3-命名空间"><a href="#3-命名空间" class="headerlink" title="3.命名空间"></a>3.命名空间</h3><p>命名空间可以用来隔离不同项目的配置文件，在Nacos中配置了命名空间后，那么Java客户端需要指定命名空间后才能拉取到该命名空间下的配置文件。</p><h4 id="3-1-创建命名空间"><a href="#3-1-创建命名空间" class="headerlink" title="3.1.创建命名空间"></a>3.1.创建命名空间</h4><p>修改Nacos，添加命名空间如下：<br><img src="/breeze/ab319c68/20200419234933509.png" alt="在这里插入图片描述"><br>这里建立了一个名字为“test”的命名空间，点击确定，然后你需要关注一下命名空间的ID，这个是需要在Java客户端进行配置的。如下：<br><img src="/breeze/ab319c68/20200419235309627.png" alt="在这里插入图片描述"></p><h4 id="3-2-在命名空间创建配置"><a href="#3-2-在命名空间创建配置" class="headerlink" title="3.2.在命名空间创建配置"></a>3.2.在命名空间创建配置</h4><p>进入配置列表 ，切换到新建立的命名空间“test”，然后创建配置，如下：<br><img src="/breeze/ab319c68/20200420000735171.png" alt="在这里插入图片描述"><br>需要注意后缀是yaml<br><img src="/breeze/ab319c68/20200420000902461.png" alt="在这里插入图片描述"></p><p>需要注意：这里的配置文件名也叫 application-user-dev.yaml,但是他是属于 “test”这个命名空间的 ， 我们之前在 默认的“public”命名空间中也有一个同名的配置。</p><h4 id="3-3-客户端配置"><a href="#3-3-客户端配置" class="headerlink" title="3.3.客户端配置"></a>3.3.客户端配置</h4><p>这里需要指定一下从哪个命名空间拉取配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#注册中心</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置中心</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#配置文件格式</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">application-user</span> <span class="comment">#配置前缀 ，默认使用sring.application.name</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span> <span class="comment">#默认分组</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">8ef8c1e5-6d20-4efc-80c8-2b2c05541fa3</span> <span class="comment">#命名空间的ID</span></span><br></pre></td></tr></table></figure><p>注意：这里的namespace对应了 Nacos中“test”这个命名空间的ID，意思是从“test”这个命名空间去找 application-user-dev.yaml的配置文件。</p><h4 id="3-4-启动测试-1"><a href="#3-4-启动测试-1" class="headerlink" title="3.4.启动测试"></a>3.4.启动测试</h4><p>启动Nacos，启动 springcloudalibaba-user-server-1010 工程 ， 修改Nacos中的配置文件内容，然后访问 <code>http://localhost:1010/user/11</code> ,观察控制台打印的 “notify”的值</p><p><strong>对应配置而言，可以通过namespace,group,dataid的不同区分不同环境！</strong></p><ul><li><strong>区分项目 namespace</strong></li><li><strong>区分环境 group(采纳)&#x2F;dataid(上个项目)</strong></li></ul><p><strong>对于服务发现而言，不同组不能相互嗲用。</strong></p><ul><li><strong>区分项目 namespace</strong></li><li><strong>区分环境:开发环境(dev-group) 测试环境，线上环境 通过组来区分就欧克 group</strong></li></ul><h2 id="四-Sentienl限流"><a href="#四-Sentienl限流" class="headerlink" title="四.Sentienl限流"></a>四.Sentienl限流</h2><h3 id="1-Sentinel和Hystrix"><a href="#1-Sentinel和Hystrix" class="headerlink" title="1.Sentinel和Hystrix"></a>1.Sentinel和Hystrix</h3><h4 id="1-1-限流和熔断"><a href="#1-1-限流和熔断" class="headerlink" title="1.1.限流和熔断"></a>1.1.限流和熔断</h4><p>限流 ， 限制流量，这里的流量我们可以理解成请求数量，其实就是限制服务器的请求并发数量，为什么要这么做？如果不做限流，那么在大量并发请求下我们的服务器会慢慢的变慢然后顶不住压力而挂掉(类似堵车)。并不是说并发越大越好，有的时候我们的项目规模和业务决定了我们不需要那么大的并发性，当大量的并发请求访问到服务器时我们需要把部分请求拒绝在外，这个是流量限制 - 限流。</p><p>熔断机制在在[《Spring Cloud 极简入门》)中有详细的解释，熔断机制是对服务调用链路的保护机制，如果链路上的某个服务不可访问，调用超时，发生异常等，服务会进行发熔断，触发降级返回托底数据。简单理解就是当服务器不可访问，可以返回一些预先准备好的兜底数据给用户，比如友好的提示信息，不至于直接向客户抛出异常。</p><h4 id="1-2-Hystrix的熔断和资源隔离"><a href="#1-2-Hystrix的熔断和资源隔离" class="headerlink" title="1.2.Hystrix的熔断和资源隔离"></a>1.2.Hystrix的熔断和资源隔离</h4><p>其实在[《Spring Cloud 极简入门》]中我们已经学习过Hystrix的熔断和资源隔离机制，它的资源隔离可以通过线程池隔离和信号量隔离两种方式来实现对流量的控制。Hystrix相比Sentinel来说它的线程池隔离(限流)会造成线程上下切换对资源的消耗比较大；Hystrix使用的信号量进行资源的隔离效果不错，但是无法对慢调用进行自动降级。</p><p>​	Hystrix相较于Sentinel功能弱.</p><p>​ Hystrix没有很好可视化界面. Hystrix dashbord. Sentinel比较漂亮</p><p><img src="/breeze/ab319c68/1ebb25473f9b44f88f691fe004239088.png" alt="img"></p><h4 id="1-3-Sentinel介绍"><a href="#1-3-Sentinel介绍" class="headerlink" title="1.3.Sentinel介绍"></a>1.3.Sentinel介绍</h4><p>Sentinel诞生于阿里巴巴，其主要<code>目标是流量控制和服务熔断</code>，2018年，Sentinel演变为一个开源项目现如今成为了Spring Cloud Alibaba的一个子项目。<code>Sentinel是通过限制并发线程的数量来减少不稳定资源的影响</code>，而不是使用线程池，省去了线程切换的性能开销。</p><p>当资源的响应时间变长时，线程将开始被占用。当线程数累积到一定数量时，新的传入请求将被拒绝。反之亦然，当资源恢复并变得稳定时，占用的线程也将被释放，新请求将被接受。</p><p>除了限制并发性外，Sentinel可以根据响应时间降级不稳定资源也是保证可靠性的有效方法。当资源的响应时间太大时，将在指定的时间窗口中拒绝所有对该资源的访问。– 熔断机制</p><p>此外，Sentinel支持的熔断降级维度更多，可对多种指标进行流控、熔断，且提供了实时监控和控制面板，功能更为强大。</p><h3 id="2-Sentinel限流实战-重要"><a href="#2-Sentinel限流实战-重要" class="headerlink" title="2.Sentinel限流实战(重要)"></a>2.Sentinel限流实战(重要)</h3><h4 id="2-1-Sentinel-Server服务端"><a href="#2-1-Sentinel-Server服务端" class="headerlink" title="2.1.Sentinel Server服务端"></a>2.1.Sentinel Server服务端</h4><p>其实原来hystrix也有管理端hytsrix dashbord,但是丑得批爆！</p><p>​ <img src="/breeze/ab319c68/1682494223917.png" alt="1682494223917"></p><p>​ 多个微服务聚合:</p><p>​ <img src="/breeze/ab319c68/1682494354748.png" alt="1682494354748"></p><p>Sentinel 提供了现成的服务端供我们使用，<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases/download/1.6.0/sentinel-dashboard-1.6.0.jar">点我下载地址</a>，下载之后通过命令行启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar -Dserver.port=1111 sentinel-dashboard-1.6.0.jar</span><br></pre></td></tr></table></figure><p>访问：<code>http://127.0.0.1:1111</code> 进入控制台，使用 sentinel&#x2F;sentinel登录。<br><img src="/breeze/ab319c68/2020042423114142.png" alt="在这里插入图片描述"></p><p>注意：只有1.6.0及以上版本才有这个登录页面。默认用户名和密码都是<code>sentinel</code>。对于用户登录的相关配置可以在启动命令中增加下面的参数来进行配置：</p><ul><li><p><code>-Dsentinel.dashboard.auth.username=sentinel</code>: 用于指定控制台的登录用户名为 sentinel；</p></li><li><p><code>-Dsentinel.dashboard.auth.password=123456</code>: 用于指定控制台的登录密码为 123456；如果省略这两个参数，默认用户和密码均为 sentinel</p></li><li><p><code>-Dserver.servlet.session.timeout=7200</code>: 用于指定 Spring Boot 服务端 session 的过期时间，如 7200 表示 7200 秒；60m 表示 60 分钟，默认为 30 分钟；</p></li><li><p><code>-Dserver.port=1111</code>：配置端口</p></li></ul><p>主页面效果<br><img src="/breeze/ab319c68/20200424231037143.png" alt="在这里插入图片描述"></p><h4 id="2-2-Sentinel-客户端接入"><a href="#2-2-Sentinel-客户端接入" class="headerlink" title="2.2.Sentinel 客户端接入"></a>2.2.Sentinel 客户端接入</h4><h5 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1.导入依赖"></a>1.导入依赖</h5><p>修改用户服务 springcloudalibaba-user-server-1010 ,加入sentinel依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="2-配置Sentinel"><a href="#2-配置Sentinel" class="headerlink" title="2.配置Sentinel"></a>2.配置Sentinel</h5><p>修改yml配置，添加senticel服务控制台地址</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:1111</span></span><br></pre></td></tr></table></figure><h5 id="3-资源限流"><a href="#3-资源限流" class="headerlink" title="3.资源限流"></a>3.资源限流</h5><p>Sentinel为我们提供了 <code>@SentinelResource</code> 注解标记需要限流的资源。 修改UserController，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="comment">//限流降级</span></span><br><span class="line"><span class="meta">@SentinelResource(value=&quot;user&quot;,blockHandler=&quot;exceptionHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    System.out.println(notify);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs:&quot;</span>+id, <span class="string">&quot;我是zs&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// 限流与阻塞处理 : 参数要和 被降级的方法参数一样</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">exceptionHandler</span><span class="params">(<span class="meta">@PathVariable</span> Long id, BlockException ex)</span> &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">    System.out.println(<span class="string">&quot;限流了...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(-<span class="number">1L</span>,<span class="string">&quot;限流了&quot;</span>,<span class="string">&quot;限流了&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示：这里通过<code>@SentinelResource</code>的value属性为资源取名为 “user” ，后续我们可以根据该资源名来进行限流。</p><p>同时这里通过 <code>blockHandler</code> 属性我配置了一个限流降级方法，即当“user”资源触发限流了会调用<code>blockHandler</code>指向的降级方法返回托底数据，不至于抛出默认的限流异常信息给客户端(一串英文用户也看不懂) ,需要注意的是：降级方法要和被限流的方法参数一致，然后加上 BlockException异常对象。</p><p>当然，也可以通过 blockHandlerClass 属性把降级方法写在一个专门的类中,里面方法必须是static，如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value=&quot;user&quot;,blockHandler=&quot;exceptionHandler&quot;</span></span><br><span class="line"><span class="meta">,blockHandlerClass=ExceptionUtil.Class)</span></span><br></pre></td></tr></table></figure><p>降级类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExceptionUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> User <span class="title function_">exceptionHandler</span><span class="params">(Long id ,lockException ex)</span> &#123;</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-Sentinel设置限流策略"><a href="#2-3-Sentinel设置限流策略" class="headerlink" title="2.3.Sentinel设置限流策略"></a>2.3.Sentinel设置限流策略</h4><p>启动应用 springcloudalibaba-user-server-1010 ,然后通过浏览器访问 <code>http://localhost:1010/user/11</code> ,然后登录Sentinel控制台，在“实时监控”列表中可以看到资源的相关监控信息的<br><img src="/breeze/ab319c68/20200424231506516.png" alt="在这里插入图片描述"></p><p>在 “族点链路” 列表中可以看到资源的调用链 ,并且可以通过“流控”按钮设置流控规则<br><img src="/breeze/ab319c68/20200424231726888.png" alt="在这里插入图片描述"><br>也可以在“流量控制”菜单中我们可以针对资源进行限流规则的设置。如下：<br><img src="/breeze/ab319c68/20200424193526109.png" alt="在这里插入图片描述"><br>这里我添加了一个流控规则，资源名对应客户端 <code>@SentinelResource(value=&quot;user&quot;..</code> 注解的资源，通过QPS限流(每秒请求数量)，阈值是 1 ，意思是“user”这个资源每秒只能有1个请求进来，多余的请求会触发限流，返回降级数据。</p><h4 id="2-4-限流测试"><a href="#2-4-限流测试" class="headerlink" title="2.4.限流测试"></a>2.4.限流测试</h4><p>通过浏览器频发访问 “user”资源，当QPS大于1就会触发限流，效果如下：<br><img src="/breeze/ab319c68/20200424193844541.png" alt="在这里插入图片描述"></p><h3 id="3-Sentinel流控模式-了解-触发条件"><a href="#3-Sentinel流控模式-了解-触发条件" class="headerlink" title="3.Sentinel流控模式(了解)-触发条件"></a>3.Sentinel流控模式(了解)-触发条件</h3><h4 id="3-1-直接"><a href="#3-1-直接" class="headerlink" title="3.1.直接"></a>3.1.直接</h4><p>Sentinel默认的流控处理就是【直接-&gt;快速失败】，QPS（query peer seconds）达到阈值，当前资源直接失败。在流控规则中配置如下：<br><img src="/breeze/ab319c68/20200424224855218.png" alt="在这里插入图片描述"></p><h4 id="3-2-关联-你关联的到达一定并发-限制自己"><a href="#3-2-关联-你关联的到达一定并发-限制自己" class="headerlink" title="3.2.关联-你关联的到达一定并发,限制自己"></a>3.2.关联-你关联的到达一定并发,限制自己</h4><p>关联的资源达到某个阈值，限流自己，如：限流的资源是<code>/user/delete</code> ，关联的资源是<code>/user/list</code>，当<code>/user/list</code>达到阈值，限流<code>user/delete</code> ， 举例： 支付并发太高，可以限制下单的流量 下单关联支付,支付并发过高,限制下单<br><img src="/breeze/ab319c68/2020042422514056.png" alt="在这里插入图片描述"></p><h4 id="3-3-链路-你调用的到达一定并发-限制自己"><a href="#3-3-链路-你调用的到达一定并发-限制自己" class="headerlink" title="3.3.链路-你调用的到达一定并发,限制自己"></a>3.3.链路-你调用的到达一定并发,限制自己</h4><p>限流线路调用链路的入口，如 <code>/user/list</code> 资源中 调用了 <code>/dept/list</code> ，对<code>/dept/list</code>添加限流，当<code>/dept/list</code>达到阈值，其实限流的是<code>/user/list</code>，因为他是访问的入口<br><img src="/breeze/ab319c68/20200424225347309.png" alt="在这里插入图片描述"></p><h3 id="4-Sentinel流控效果-了解-做出响应"><a href="#4-Sentinel流控效果-了解-做出响应" class="headerlink" title="4.Sentinel流控效果(了解)-做出响应"></a>4.Sentinel流控效果(了解)-做出响应</h3><h4 id="4-1-快速失败"><a href="#4-1-快速失败" class="headerlink" title="4.1.快速失败"></a>4.1.快速失败</h4><p>快速失败:(RuleConstant.CONTROL_BEHAVIOR_DEFAULT)是默认的流控方式，当流量达到阀值直接返回异常，QPS达到任何规则阈值后，后续请求就会立即拒绝，并抛出FlowException 异常。简单理解：并发太高，直接请求拒绝</p><h4 id="4-2-Warm-Up预热"><a href="#4-2-Warm-Up预热" class="headerlink" title="4.2.Warm Up预热"></a>4.2.Warm Up预热</h4><p>Warm Up预热:(RuleConstant.CONTROL_BEHAVIOR_WARM_UP)方式，根据<strong>codeFacto</strong>r（默认3）的值，从（阀值&#x2F;codeFactor）为初始阀值，经过预热时长，才到达设置的QPS的阀值，即预热&#x2F;冷启动方式。简单理解：慢慢的增大处理并发的能力 10&#x2F;3 10 3<br><img src="/breeze/ab319c68/20200424225831661.png" alt="在这里插入图片描述"><br>提示：初始的QPS阈值为 100 &#x2F; 3 &#x3D;33 ，10秒后 QPS阈值达到 100.</p><p>当系统长期并发不高，流量突然增加可能会直接把系统压垮。通过”冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值的上限，给系统一个预热的时间，避免冷系统被压垮。</p><h4 id="4-3-排队等待"><a href="#4-3-排队等待" class="headerlink" title="4.3.排队等待"></a>4.3.排队等待</h4><p>排队等(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)，忽然增加的请求并发量达到了限流阈值后续请求会被拒绝，有时候我们可能更希望后续的请求可以加入队列进行排队，慢慢执行，而不是直接拒绝请求，这种方式后严格控制请求通过的时间间隔，也即是让请求以均匀的速度通过，对应的是漏桶算法，这种方式主要用于处理间隔性突发的流量，例如消息队列。 简单理解：突发流量处理不过来，让请求排队。<br><img src="/breeze/ab319c68/20200424230647590.png" alt="在这里插入图片描述"><br>提示：QPS阈值为100，超过的请求会排队，排队超时时间为 10S</p><h3 id="5-热点限流-扩展"><a href="#5-热点限流-扩展" class="headerlink" title="5.热点限流(扩展)"></a>5.热点限流(扩展)</h3><p>还有一种特殊的动态限流规则，用于限制动态的热点资源 ， 比如对同一个用户的请求频率做限定，比如对参数进行限定，比如对参数的值做限定(比如对商品ID为1的资源做限流)。</p><h4 id="5-1-参数限流"><a href="#5-1-参数限流" class="headerlink" title="5.1.参数限流"></a>5.1.参数限流</h4><p>参数限流就是 对资源的参数进行限流，我们来编写一个方法，接受两个参数：p1,和p2并设置好限流降级。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//限流降级</span></span><br><span class="line"><span class="meta">@SentinelResource(value=&quot;/parameterLimit&quot;,blockHandler=&quot;parameterLimitHandler&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(value=&quot;/parameterLimit&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">parameterLimit</span><span class="params">(<span class="meta">@RequestParam(&quot;p1&quot;)</span> String p1 ,<span class="meta">@RequestParam(&quot;p2&quot;)</span> String p2)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;parameterLimit方法调用成功...&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 限流与阻塞处理</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">parameterLimitHandler</span><span class="params">(<span class="meta">@RequestParam(&quot;p1&quot;)</span> String p1 ,<span class="meta">@RequestParam(&quot;p2&quot;)</span> String p2,BlockException ex)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;限流了...&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置热点规则 ， 对第一个参数限流 ， 当第一个参数超过了1的QPS就熔断降级。<br><img src="/breeze/ab319c68/20200425232333228.png" alt="在这里插入图片描述"></p><h4 id="5-2-参数值限流"><a href="#5-2-参数值限流" class="headerlink" title="5.2.参数值限流"></a>5.2.参数值限流</h4><p>对某一个参数的值满足某种条件的时候就进行限流，如下配置</p><p><img src="/breeze/ab319c68/20200425232749902.png" alt="在这里插入图片描述"><br>意思是第一个参数的值为 <strong>haha</strong> 的时候限流阈值为10 ， 超过 QPS &gt; 10的并发就限流。</p><p>举例：应用场景比如说商品名称为“华为p40”的商品并发特别高，我们可以针对参数商品名为“华为p40”的商品进行限流。</p><h3 id="6-系统规则-扩展"><a href="#6-系统规则-扩展" class="headerlink" title="6.系统规则(扩展)"></a>6.系统规则(扩展)</h3><h4 id="6-1-配置全局限流规则"><a href="#6-1-配置全局限流规则" class="headerlink" title="6.1.配置全局限流规则"></a>6.1.配置全局限流规则</h4><p>系统规则可以看做是总的限流策略，所有的只要都要受到系统规则的限制。<br><img src="/breeze/ab319c68/20200425233121705.png" alt="在这里插入图片描述"><br>上面的意思是最大并发只能允许 10 个线程数，并且是作用于全局的。</p><p>默认没有流控!!!!!!!!!! 针对服务全局配置1000qps,并且出问题跳转到自定义”系统繁忙稍后欧重试界面”,对服务中需要高并发支持单独配置流控! 还针对热点进行热点限流.</p><h3 id="7-Gateway使用Sentinel限流-重要"><a href="#7-Gateway使用Sentinel限流-重要" class="headerlink" title="7.Gateway使用Sentinel限流(重要)"></a>7.Gateway使用Sentinel限流(重要)</h3><p>Spring Cloud Gateway 作为微服务的网关，它是微服务的访问入口，当请求的流量洪峰到来我们可以在Gateway网关层通过Sentinel对请求进行流控，把好第一道关。</p><h4 id="7-1-导入依赖"><a href="#7-1-导入依赖" class="headerlink" title="7.1.导入依赖"></a>7.1.导入依赖</h4><p>这里我们需要导入sentinel基础依赖和 sentinel-gateway 整合依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    限流和gataway使用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>	</span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="7-2-配置Sentinel地址"><a href="#7-2-配置Sentinel地址" class="headerlink" title="7.2.配置Sentinel地址"></a>7.2.配置Sentinel地址</h4><p>修改yml配置，增加Sentinel服务地址</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">      <span class="attr">sentinel:</span></span><br><span class="line">          <span class="attr">transport:</span></span><br><span class="line">            <span class="attr">dashboard:</span> <span class="string">localhost:1111</span></span><br></pre></td></tr></table></figure><h4 id="7-3-配置限流规则"><a href="#7-3-配置限流规则" class="headerlink" title="7.3.配置限流规则"></a>7.3.配置限流规则</h4><p>启动Gateway，登录sentinel控制台，对url资源进行流控限制，配置方式和前面的配置方式一样，童鞋们可以自己测试一下。</p><h3 id="8-限流算法"><a href="#8-限流算法" class="headerlink" title="8 限流算法"></a>8 限流算法</h3><p>Spring Cloud Alibaba Sentinel底层采用了以下几种流行的限流算法：</p><ol><li><strong>直接计数（Direct Count）：基于固定时间窗口的计数器算法，根据单位时间内的请求数量进行限流。这是最简单直接的一种算法，但不支持动态参数调整。</strong></li><li>滑动窗口（Sliding Window）：通过滑动时间窗口内的请求数量来判断是否进行限流，支持按时间窗口和请求个数进行配置。Sentinel使用双向队列存储时间窗口内的请求记录，并根据请求的时间戳进行滑动。</li><li>令牌桶（Token Bucket）：基于令牌桶算法，使用令牌桶中的令牌数量来控制单位时间内的请求速率。Sentinel底层实现了一个简化版的令牌桶算法，可以动态调整令牌生成速率和桶容量。–<strong>sentinel最常用的</strong></li><li>漏桶（Leaky Bucket）：基于漏桶算法，通过固定速率的流出速度来控制单位时间内的请求速率。Sentinel底层实现了一个简化版的漏桶算法，可以动态调整漏桶的流出速率和桶容量。</li></ol><p>此外，Sentinel还支持系统自适应限流算法，该算法会根据系统的负载情况自动调整限流策略，例如根据平均响应时间、QPS等指标进行动态调整。</p><p>以上是Spring Cloud Alibaba Sentinel底层常用的限流算法。可以根据具体场景和需求选择适合的算法进行配置。</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/blueheartstone/article/details/126286750">https://blog.csdn.net/blueheartstone/article/details/126286750</a></p><h2 id="五-Sentinel熔断"><a href="#五-Sentinel熔断" class="headerlink" title="五.Sentinel熔断"></a>五.Sentinel熔断</h2><h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h3><h4 id="1-1-什么是熔断"><a href="#1-1-什么是熔断" class="headerlink" title="1.1.什么是熔断"></a>1.1.什么是熔断</h4><p>在上一章节我们探讨了Sentinel的流控(限流)功能，Sentinel除了流控还提供了服务熔断和降级机制，服务之间的调用关系错综复杂，微服务的调用链上的某些服务资源不稳定(宕机，异常，超时)可能会导致可能请求的失败和请求的堆积，调用链产生连锁反应可能会导致整个微服务架构瘫痪。服务熔断降级机制是保障高可用的重要措施之一。</p><h4 id="1-2-Sentinel熔断"><a href="#1-2-Sentinel熔断" class="headerlink" title="1.2.Sentinel熔断"></a>1.2.Sentinel熔断</h4><p>Sentinel的服务熔断机制会对调用链上的某个不稳定(宕机，异常，超时)的资源，做出请求限制，快速失败，避免影响到其它的服务而导致级联错误。资源熔断后，在后续的一定时间(时间窗口)之内，对该服务的请求都自动熔断，抛出 DegradeException异常。</p><p>Sentinel拥有比Hystrix更强大和丰富的功能，能满足我们的各种应用场景，并且经历过淘宝双十一的考验，是微服务架构中熔断机制的不二选择。</p><h3 id="2-Sentnel熔断实战（重要）"><a href="#2-Sentnel熔断实战（重要）" class="headerlink" title="2.Sentnel熔断实战（重要）"></a>2.Sentnel熔断实战（重要）</h3><h4 id="2-1-资源熔断降级"><a href="#2-1-资源熔断降级" class="headerlink" title="2.1.资源熔断降级"></a>2.1.资源熔断降级</h4><p>修改springcloudalibaba-user-1010工程，修改UserController ，通过<code>@SentinelResource</code>注解的<code>fallback</code> 属性指定降级方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限流降级</span></span><br><span class="line"> <span class="keyword">public</span> User <span class="title function_">exceptionHandler</span><span class="params">(<span class="meta">@PathVariable</span> Long id, BlockException ex)</span> &#123;</span><br><span class="line">     ex.printStackTrace();</span><br><span class="line">     System.out.println(<span class="string">&quot;限流了...&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(-<span class="number">1L</span>,<span class="string">&quot;限流了&quot;</span>,<span class="string">&quot;限流了&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 熔断降级，参数和返回值与源方法一致</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getByIdfallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">     System.out.println(notify);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs:&quot;</span>+id, <span class="string">&quot;熔断托底了&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"> <span class="comment">//限流降级</span></span><br><span class="line"> <span class="meta">@SentinelResource(value=&quot;user&quot;,blockHandler=&quot;exceptionHandler&quot;,fallback = &quot;getByIdfallback&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">     <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;	<span class="comment">//方法异常，触发熔断</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs:&quot;</span>+id, <span class="string">&quot;我是zs&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>提示：方法中通过 <code>int i = 1 / 0;</code> 模拟异常，然后会熔断触发降级调用降级方法 。 通过 <code>fallback</code> 属性指定熔断的降级方法 ，熔断方法参数也要和被熔断方法参数一致。</p><p>注意：这里可以通过 <code>@SentinelResource</code>注解的 <code>exceptionsToTrace</code> 属性忽略异常，即针对某个异常不熔断。</p><h4 id="2-2-配置降级策略"><a href="#2-2-配置降级策略" class="headerlink" title="2.2.配置降级策略"></a>2.2.配置降级策略</h4><p>在Sentinel控制台，在<strong>族点链路</strong>菜单中找到“<strong>user</strong>”资源，然后点击“<strong>降级</strong>”按钮添加降级策略，如下：<br><img src="/breeze/ab319c68/20200425132046460.png" alt="在这里插入图片描述"><br>这里的降级策略为“RT”，大概意思是：如果并发数大于5 (QPS &gt; 5) ，然后平均响应时间大于200毫秒，那么接下来的2秒钟之内对该资源的请求会被熔断降级。</p><h4 id="2-3-测试熔断"><a href="#2-3-测试熔断" class="headerlink" title="2.3.测试熔断"></a>2.3.测试熔断</h4><p>启动springcloudalibaba-user-1010工程，访问 <code>http://localhost:1010/user/2</code> ,浏览器返回：<br><img src="/breeze/ab319c68/20200425132819867.png" alt="在这里插入图片描述"><br>这里已经返回了托底数据，其实是因为“user”资源方法中抛出了异常，触发了熔断降级。</p><h3 id="3-熔断规则"><a href="#3-熔断规则" class="headerlink" title="3.熔断规则"></a>3.熔断规则</h3><p>资源在什么情况下会触发熔断降级？调用异常，达到流控，调用超时 都会触发熔断降级，在上面的案例中我们看到资源的降级策略有 RT,异常比例，异常数三种方式，我们可以通过这三种方式来定义资源是否稳定，决定是否要进行熔断降级。</p><h4 id="3-1-平均响应RT"><a href="#3-1-平均响应RT" class="headerlink" title="3.1.平均响应RT"></a>3.1.平均响应RT</h4><blockquote><p>平均响应时间 (DEGRADE_GRADE_RT)：当资源的平均响应时间超过阈值（DegradeRule 中的 count，以 ms 为单位）之后，资源进入准降级状态。如果接下来 1s 内持续进入 5 个请求（即 QPS &gt;&#x3D; 5），它们的 RT 都持续超过这个阈值，那么在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 DegradeException）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt&#x3D;xxx 来配置。</p></blockquote><p>是不是很生涩难懂？我们根据下面这个配置来理解：<br><img src="/breeze/ab319c68/20200425134216138.png" alt="在这里插入图片描述"><br>我们挑关键信息来理解上面那句话<br>这里配置的RT是200意思是对资源的多次请求平均响应时间都超过200毫秒，意思是 1s 内持续进入 5 个请求（即 QPS &gt;&#x3D; 5），这五个请求的平均响应时间都超过了200，后续的2秒之内(时间窗口)请求这个方法都被熔断，触发降级</p><p>总结一下：RT其实就是<strong>平均相应时间太长</strong>资源熔断。</p><h4 id="3-2-异常比例"><a href="#3-2-异常比例" class="headerlink" title="3.2.异常比例"></a>3.2.异常比例</h4><blockquote><p>异常比例(DEGRADE_GRADE_EXCEPTION_RATIO)：每秒请求量 &gt; 5 ,当资源的每秒异常总数占通过量的比值超过阈值（DegradeRule 中的 count）之后，资源进入降级状态，即在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p></blockquote><p>根据下面这个配置来理解<br><img src="/breeze/ab319c68/2020042522463519.png" alt="在这里插入图片描述"><br>上面配置的意思就是“user”这个资源的异常比例超过了0.2，即10个请求有两个都异常了，资源被熔断，在接下来的2秒钟之后请求这个方法都被熔断，触发降级。</p><p>总结一下：异常比例就是按<strong>照资源的请求失败率</strong>来熔断。</p><h4 id="3-3-异常数"><a href="#3-3-异常数" class="headerlink" title="3.3.异常数"></a>3.3.异常数</h4><blockquote><p>异常数 (DEGRADE_GRADE_EXCEPTION_COUNT)：当资源近 1 分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 timeWindow 小于 60s，则结束熔断状态后仍可能再进入熔断状态。</p></blockquote><p>根据下面这个配置来理解<br><img src="/breeze/ab319c68/20200425230228273.png" alt="在这里插入图片描述"><br>这里的意思是一分钟(61s)超过5个异常请求，服务进行熔断。后续请求都拒绝。</p><p>注意：异常降级仅针对业务异常，对 Sentinel 限流降级本身的异常（BlockException）不生效</p><p>总结一下：异常数就是按照 <strong>一分钟的异常的数量</strong> 来熔断。</p><h4 id="3-4-慢调用比例"><a href="#3-4-慢调用比例" class="headerlink" title="3.4.慢调用比例"></a>3.4.慢调用比例</h4><p>熔断策略慢调用比例是以慢调用数量的比例作为阈值，首先需要设置最大 RT（即最大的响应时间，用于鉴定是否是慢调用），请求的响应时间大于该值则统计为慢调用。当单位统计时长（statIntervalMs）内请求数大于设置的最小请求数，并且慢调用的比例大于比例阈值，则接下来的请求会自动熔断，熔断时间为设置的熔断时长。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若在HALF-OPEN状态下有一个请求响应时间小于 最大RT 则结束熔断，否则继续熔断。</p><p><img src="/breeze/ab319c68/1690384242776.png" alt="1690384242776"></p><p>字段说明表格</p><p>字段名	说明<br>资源名	访问的请求路径<br>熔断策略	熔断规则配置后，进行熔断的方式策略，本文主要分析慢调用比例<br>最大RT	最大响应时间，单位：毫秒数，用于鉴定是否是慢调用<br>比例阈值	值的是慢调用的比例阈值，是触发熔断的其中一个条件<br>熔断时长	当条件满足后需要进行熔断的熔断时长，单位：秒<br>最小请求数	在统计时长的时间内，请求数要大于该值，才会判断慢调用比例是否大于比例阈值， 所以最小请求数是触发熔断的另外一个条件<br>统计时长	触发熔断需要统计请求数的时长，单位：毫秒<br><img src="/breeze/ab319c68/1690384277430.png" alt="1690384277430"></p><h3 id="4-openFeign整合Sentinel熔断-重要"><a href="#4-openFeign整合Sentinel熔断-重要" class="headerlink" title="4.openFeign整合Sentinel熔断(重要)"></a>4.openFeign整合Sentinel熔断(重要)</h3><p>Spring Cloud Alibaba是Spring Cloud的一个子项目，OpenFeign是Spring Cloud的客户端负载均衡器，使用Spring Cloud Alibaba依然可以很方便的集成OpenFeign，如果要使用OpenFeign作为服务客户端负载均衡，那么我们需要考虑OpenFeign开启Sentinel进行服务熔断降级。</p><h4 id="4-1-开启Sentinel"><a href="#4-1-开启Sentinel" class="headerlink" title="4.1.开启Sentinel"></a>4.1.开启Sentinel</h4><p>OpenFeign与Sentinel组件集成除了引**入<code>sentinel-starter</code>**依赖关系之外，还需要在属性文件中启用Sentinel支持：<code>feign.sentinel.enabled=true</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#熔断</span></span><br></pre></td></tr></table></figure><h4 id="4-2-给Feign接口降级"><a href="#4-2-给Feign接口降级" class="headerlink" title="4.2.给Feign接口降级"></a>4.2.给Feign接口降级</h4><p>这里跟Feign开启<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014494148/article/details/105088732">Hystrix</a>降级一样，还是可以使用fallback属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;user-server&quot;,fallback = UserClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-编写降级类"><a href="#4-3-编写降级类" class="headerlink" title="4.3.编写降级类"></a>4.3.编写降级类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientFallback</span> <span class="keyword">implements</span> <span class="title class_">UserClient</span> &#123;    </span><br><span class="line">	<span class="meta">@Override</span>    </span><br><span class="line">	<span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span> &#123;        </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(-<span class="number">1L</span>,<span class="string">&quot;无此用户&quot;</span>,<span class="string">&quot;无此用户&quot;</span>);    </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里我们已经完成了Feign和Sentinel的兼容使用，是不是很简单呢，因为它的集成方式和Hystrix简直一模一样</p><h2 id="六-服务网关SpringCloud-Gateway"><a href="#六-服务网关SpringCloud-Gateway" class="headerlink" title="六 服务网关SpringCloud Gateway"></a>六 服务网关SpringCloud Gateway</h2><h3 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1.基本概念"></a>1.基本概念</h3><h4 id="1-1-Zuul与Gateway"><a href="#1-1-Zuul与Gateway" class="headerlink" title="1.1.Zuul与Gateway"></a>1.1.Zuul与Gateway</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014494148/article/details/105098362">Zuul</a>是Netflix的开源项目，Spring Cloud将其收纳成为自己的一个子组件。zuul用的是多线程阻塞模型，它本质上就是一个同步 Servlet，这样的模型比较简单，他的问题是多线程之间上下文切换是有开销的，线程越多开销就越大。线程池数量固定意味着能力接受的请求数固定，当后台请求变慢，面对大量的请求，线程池中的线程容易被耗尽，后续的请求会被拒绝。</p><p>在Zuul 2.0中它采用了 Netty 实现异步非阻塞编程模型(NIO)，异步非阻塞模式对线程的消耗比较少，对线程上线文切换的消耗也比较小，并且可以接受更多的请求。它的问题就是线程模型比较复杂，要求深究底层原理需要花一些功夫。</p><p>Spring Cloud Gateway是Spring Cloud自己的产物，基于Spring 5 和Spring Boot 2.0 开发，Spring Cloud Gateway的出现是为了代替zuul,在Spring Cloud 高版本中没有对zuul 2.0进行集成，SpringCloud Gateway使用了高性能的Reactor模式通信框架Netty。</p><p>Spring Cloud Gateway 的目标，不仅提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控&#x2F;指标，和限流。</p><p>所以说其实Gateway和zuul 2.0差别不是特别大，都是采用Netty高性能通信框架，性能都挺不错</p><p><strong>spring5的mvc框架是Spring WebFlux,不是springmvc，所以不需要导入web！</strong></p><h4 id="1-2-Spring-Cloud-Gataway的特点"><a href="#1-2-Spring-Cloud-Gataway的特点" class="headerlink" title="1.2.Spring Cloud Gataway的特点"></a>1.2.Spring Cloud Gataway的特点</h4><p>在Spring Cloud官方定义了SpringCloud Gateway 的如下特点：</p><ul><li>基于 Spring 5，Project Reactor , Spring Boot 2.0</li><li>默认集成 Spring Cloud DiscoveryClient</li><li>默认集成 Hystrix 断路器</li><li>Predicates(断言) 和 Filters 作用于特定路由，易于编写的 Predicates 和 Filters</li><li>支持动态路由、限流、路径重写</li></ul><h4 id="1-3-Spring-Cloud-Gataway的核心概念"><a href="#1-3-Spring-Cloud-Gataway的核心概念" class="headerlink" title="1.3.Spring Cloud Gataway的核心概念"></a>1.3.Spring Cloud Gataway的核心概念</h4><p>Spring Cloud Gataway有几个核心组成：</p><ul><li>Filter（过滤器）：</li></ul><p>Spring Cloud Gateway的Filter和Zuul的过滤器类似，可以在请求发出前后进行一些业务上的处理 ,这里分为两种类型的Filter，分别是Gateway Filter网关filter和Global Filter全局Filter, 他们的区别在后续会讲到。</p><ul><li>Route（路由）：</li></ul><p>网关配置的基本组成模块，和Zuul的路由配置模块类似。一个Route模块由一个 ID，一个目标 URI，一组断言和一组过滤器定义。如果断言为真，则路由匹配，目标URI会被访问。说白了就是把url请求路由到对应的资源(服务)，或者说是一个请求过来Gateway应该怎么把这个请求转发给下游的微服务，转发给谁。</p><ul><li>Predicate（断言）：</li></ul><p>这是一个 Java 8 的 Predicate，可以使用它来匹配来自 HTTP 请求的任何内容，例如 headers 或参数。断言的输入类型是一个 ServerWebExchange。简单理解就是处理HTTP请求的匹配规则，在什么样的请情况下才能命中资源继续访问。</p><h4 id="1-4-Spring-Cloud-Gateway的工作方式"><a href="#1-4-Spring-Cloud-Gateway的工作方式" class="headerlink" title="1.4.Spring Cloud Gateway的工作方式"></a>1.4.Spring Cloud Gateway的工作方式</h4><p>Spring Cloud Gateway 的工作原理跟 Zuul 的差不多，最大的区别就是 Gateway 的 Filter 只有 pre 和 post 两种，下面是官方的执行流程图：<br><img src="/breeze/ab319c68/20200417111957878.png" alt="在这里插入图片描述"><br>客户端向Spring Cloud Gateway发出请求。如果网关处理程序映射确定请求与路由匹配，则将其发送到网关Web处理程序。该处理程序通过特定于请求的过滤器链来运行请求。筛选器由虚线分隔的原因是，筛选器可以在发送代理请求之前和之后运行逻辑。所有“前置”过滤器逻辑均被执行。然后发出代理请求。发出代理请求后，将运行“后”过滤器逻辑。</p><h3 id="2-Spring-Cloud-Gataway入门"><a href="#2-Spring-Cloud-Gataway入门" class="headerlink" title="2. Spring Cloud Gataway入门"></a>2. Spring Cloud Gataway入门</h3><h4 id="2-1-创建工程导入依赖"><a href="#2-1-创建工程导入依赖" class="headerlink" title="2.1.创建工程导入依赖"></a>2.1.创建工程导入依赖</h4><p>工程名：springcloud-gateway-server-1110 ，导入gataway基础依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这他妈的就相当于Eurekaclient--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud <span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--gateway--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--拉取配置中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud <span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-2-主配置类"><a href="#2-2-主配置类" class="headerlink" title="2.2.主配置类"></a>2.2.主配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//服务注册与发现</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayServerApplication1110</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayServerApplication1110 .class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-yml配置"><a href="#2-3-yml配置" class="headerlink" title="2.3.yml配置"></a>2.3.yml配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>	<span class="comment">#注册中心地址</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">0f800d23-c0dd-4eb8-b0c0-1de010bab3ef</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">sb</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#false 不开放服务名访问方式</span></span><br><span class="line">          <span class="attr">lower-case-service-id:</span> <span class="literal">true</span> <span class="comment">#服务名小写</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">xxxx</span> <span class="comment">#指定服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://order-service</span> <span class="comment">#去注册中心找这个服务名</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，匹配访问的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/services/order/**</span>    <span class="comment">#服务访问路径</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=2</span>    <span class="comment">#请求转发的时候会去掉 /user访问路径</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">yyyy</span> <span class="comment">#指定服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span> <span class="comment">#去注册中心找这个服务名</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，匹配访问的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/services/user/**</span>    <span class="comment">#服务访问路径</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=2</span>    <span class="comment">#请求转发的时候会去掉 /user访问路径</span></span><br></pre></td></tr></table></figure><p>这里除了要注册到nacos以外，还需要配置Gataway的路由</p><ul><li><code>spring.cloud.gateway.discovery.locator.enabled=false</code>: 不开放服务名访问方式</li><li><code>spring.cloud.gateway.discovery.locator.lower-case-service-id: true</code> 忽略服务名大小写，大写小写都可以匹配</li><li><code>spring.cloud.gateway.routes.id</code> : 指定了路由的服务名，可以自己定义</li><li><code>spring.cloud.gateway.routes.uri=lb://user-server</code> : 去注册中心找服务，采用负载均衡的方式请求。其实就是找要调用的服务。</li><li><code>spring.cloud.gateway.routes.predicates</code>: 断言，这里使用的Path&#x3D;&#x2F;user&#x2F;**，即匹配访问的路径如果匹配&#x2F;user&#x2F;就可以将请求路由(分发)到user-server这个服务上。</li><li><code>spring.cloud.gateway.routes.filters</code> :这里使用StripPrefix&#x3D;1主要是处理前缀 &#x2F;user ,访问目标服务的时候会去掉前缀访问。这个需要根据url情况来定义。</li></ul><h4 id="2-5-访问测试"><a href="#2-5-访问测试" class="headerlink" title="2.5.访问测试"></a>2.5.访问测试</h4><p>启动注册中心，启动用户服务，启动网关访问：<code>http://localhost:1110/user/user/1</code>,请求将会打到用户服务上，并返回用户数据。</p><h3 id="3-Predicate断言工厂"><a href="#3-Predicate断言工厂" class="headerlink" title="3. Predicate断言工厂"></a>3. Predicate断言工厂</h3><h4 id="3-1-什么是断言工厂"><a href="#3-1-什么是断言工厂" class="headerlink" title="3.1.什么是断言工厂"></a>3.1.什么是断言工厂</h4><p>什么是断言工程，在Spring Cloud Gateway<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/#gateway-request-predicates-factories">官方文档</a>有如下解释：</p><blockquote><p>Spring Cloud Gateway将路由作为Spring WebFlux HandlerMapping基础架构的一部分进行匹配。Spring Cloud Gateway包括许多内置的路由断言工厂。所有这些断言都与HTTP请求的不同属性匹配。您可以将多个路由断言工厂与逻辑and语句结合使用。</p></blockquote><p>这里不难理解，其实断言工厂就是用来判断http请求的匹配方式。比如我们再上面案例中配置的：“<code>Path=/user/**</code>” ，就是使用的是 “<code>Path Route Predicate Factory</code>” 路径匹配工厂，意思是http请求的资源地址必须是 &#x2F;user 才会被匹配到对应的路由，然后继续执行对应的服务获取资源。</p><p>在Spring Cloud Gateway中，针对不同的场景内置的路由断言工厂，比如</p><ul><li><code>Query Route Predicate Factory</code>：根据查询参数来做路由匹配</li><li><code>Path Route Predicate Factory</code>: 更加路径来匹配</li><li><code>RemoteAddr Route Predicate Factory</code>：根据ip来做路由匹配</li><li><code>Header Route Predicate Factory</code>：根据请求头中的参数来路由匹配</li><li><code>Host Route Predicate Factory</code>：根据主机名来进行路由匹配</li><li><code>Method Route Predicate Factory</code> ：根据方法来路由匹配</li><li><code>Cookie Route Predicate Factory</code>：根据cookie中的属性值来匹配</li><li><code>Before Route Predicate Factory</code>：指定时间之间才能匹配</li><li><code>After Route Predicate Factory</code>： 指定时间之前才能匹配</li><li><code>Weight Route Predicate Factory</code>： 根据权重把流量分发到不同的主机</li></ul><h4 id="3-2-根据查询参数断言-Query-Route-Predicate-Factory"><a href="#3-2-根据查询参数断言-Query-Route-Predicate-Factory" class="headerlink" title="3.2.根据查询参数断言- Query Route Predicate Factory"></a>3.2.根据查询参数断言- Query Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://order-service</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Query=green</span></span><br></pre></td></tr></table></figure><p>上面配置表达的试试是如果请求参数中包含了 green，那么就会断言成功，从而执行uri后面的地址。</p><h4 id="3-3-根据path断言-Path-Route-Predicate-Factory-重要"><a href="#3-3-根据path断言-Path-Route-Predicate-Factory-重要" class="headerlink" title="3.3.根据path断言-Path Route Predicate Factory(重要)"></a>3.3.根据path断言-<strong>Path</strong> Route Predicate Factory(重要)</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route</span></span><br><span class="line">        <span class="string">uri:lb://order-service</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/red/&#123;segment&#125;,/blue/&#123;segment&#125;,/blue/**</span></span><br></pre></td></tr></table></figure><p>请求路径如: <code>/red/1</code>或<code>/red/blue</code>或<code>/blue/green</code> 就可以断言成功</p><h4 id="3-4-根据权重比例断言-Weight-Route-Predicate-Factory"><a href="#3-4-根据权重比例断言-Weight-Route-Predicate-Factory" class="headerlink" title="3.4.根据权重比例断言-Weight Route Predicate Factory"></a>3.4.根据权重比例断言-Weight Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_high</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://weighthigh.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/apis/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_low</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://weightlow.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/apis/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>第一个参数是组名,同一个组的才会走权重计算</p><p>大约80％的请求转发到<a target="_blank" rel="noopener" href="https://weighthigh.org/">weighthigh.org</a>，将大约20％的流量<a target="_blank" rel="noopener" href="https://weighlow.org/">转发</a>到<a target="_blank" rel="noopener" href="https://weighlow.org/">weightlow.org。</a></p><p><a target="_blank" rel="noopener" href="http://www.xbhp.cn/news/179315.html">http://www.xbhp.cn/news/179315.html</a></p><h4 id="3-5-根据远程ip断言-RemoteAddr-Route-Predicate-Factory"><a href="#3-5-根据远程ip断言-RemoteAddr-Route-Predicate-Factory" class="headerlink" title="3.5.根据远程ip断言 - RemoteAddr Route Predicate Factory"></a>3.5.根据远程ip断言 - RemoteAddr Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure><p>如果请求的远程地址为 <code>192.168.1.1</code>到<code>192.168.1.24</code>之间，则此路由匹配</p><h4 id="3-6-指定时间之后断言-After-Route-Predicate-Factory"><a href="#3-6-指定时间之后断言-After-Route-Predicate-Factory" class="headerlink" title="3.6.指定时间之后断言-After Route Predicate Factory"></a>3.6.指定时间之后断言-After Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure><p>在atfer配置的时间之后才能访问</p><h4 id="3-7-在指定时间之前断言-Before-Route-Predicate-Factory"><a href="#3-7-在指定时间之前断言-Before-Route-Predicate-Factory" class="headerlink" title="3.7.在指定时间之前断言-Before Route Predicate Factory"></a>3.7.在指定时间之前断言-Before Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">before_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Before=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure><p>在before配置的时间之前才能访问</p><h4 id="3-8-在指定时间段之间断言-Between-Route-Predicate-Factory"><a href="#3-8-在指定时间段之间断言-Between-Route-Predicate-Factory" class="headerlink" title="3.8.在指定时间段之间断言-Between Route Predicate Factory"></a>3.8.在指定时间段之间断言-Between Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">between_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Between=2017-01-20T17:42:47.789-07:00[America/Denver],</span> <span class="number">2017-01-21T17:42:47.789-07:00</span>[<span class="string">America/Denver</span>]</span><br></pre></td></tr></table></figure><p>请求时间在两个时间之内者允许访问</p><h4 id="3-9-根据cookie断言-Cookie-Route-Predicate-Factory"><a href="#3-9-根据cookie断言-Cookie-Route-Predicate-Factory" class="headerlink" title="3.9.根据cookie断言-Cookie Route Predicate Factory"></a>3.9.根据cookie断言-Cookie Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cookie_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.p</span></span><br></pre></td></tr></table></figure><p>cookies中必须有Cookie配置的属性才能匹配</p><h4 id="3-10-根据请求头断言-Header-Route-Predicate-Factory"><a href="#3-10-根据请求头断言-Header-Route-Predicate-Factory" class="headerlink" title="3.10.根据请求头断言-Header Route Predicate Factory"></a>3.10.根据请求头断言-Header Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure><p>请求头必须出现 X-Request-Id 才可以访问</p><h4 id="3-11-根据主机断言-Host-Route-Predicate-Factory"><a href="#3-11-根据主机断言-Host-Route-Predicate-Factory" class="headerlink" title="3.11.根据主机断言-Host Route Predicate Factory"></a>3.11.根据主机断言-Host Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">host_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Host=**.somehost.org,**.anotherhost.org</span></span><br></pre></td></tr></table></figure><p>如果请求的主机头具有值**.somehost.org,或者**.anotherhost.org这匹配路由</p><h4 id="3-12-根据请求方式断言-Method-Route-Predicate-Factory"><a href="#3-12-根据请求方式断言-Method-Route-Predicate-Factory" class="headerlink" title="3.12.根据请求方式断言-Method Route Predicate Factory"></a>3.12.根据请求方式断言-Method Route Predicate Factory</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">method_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Method=GET,POST</span></span><br></pre></td></tr></table></figure><p>只允许 GET和POST请求</p><h3 id="4-Gateway-的-Filter-过滤器（重要）"><a href="#4-Gateway-的-Filter-过滤器（重要）" class="headerlink" title="4.Gateway 的 Filter 过滤器（重要）"></a>4.Gateway 的 Filter 过滤器（重要）</h3><p>Gateway的Filter的zuul的Filter有相似之处，与zuul不同的是，Gateway的filter从生命周期上可以为“pre”和“post”类型。根据作用范围可分为针对于单个路由的gateway filter，和针对于所有路由的Global Filer。 <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/#gatewayfilter-factories">官网文档</a></p><h4 id="4-1-Gateway-filter"><a href="#4-1-Gateway-filter" class="headerlink" title="4.1.Gateway filter"></a>4.1.Gateway filter</h4><p>针对单个路由的Filter, 它允许以某种方式修改HTTP请求或HTTP响应。过滤器可以作用在某些特定的请求路径上。Gateway内置了很多的GatewayFilter工厂。如果要使用这些Filter只需要在配置文件配置GatewayFilter Factory的名称。下面拿一个内置的Gateway Filter举例：</p><p><strong>AddRequestHeader GatewayFilter Factory</strong><br>该Filter是Gateway内置的，它的作用是在请求头加上指定的属性。配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-red,</span> <span class="string">blue</span></span><br></pre></td></tr></table></figure><p>在<code>spring.cloud.gateway.routes.filters</code>配置项配置了一个<code>AddRequestHeader</code> ,他是“<code>AddRequestHeader GatewayFilter Factory</code>”的名称，意思是在请求头中添加一个“<code>X-Request-red</code>”的属性，值为<code>blue</code> 。</p><p>其他的Filter可以去看 AbstractGatewayFilterFactory 的实现类。</p><h4 id="4-2-自定义Gateway-Filter-局部过滤器"><a href="#4-2-自定义Gateway-Filter-局部过滤器" class="headerlink" title="4.2.自定义Gateway Filter-局部过滤器"></a>4.2.自定义Gateway Filter-局部过滤器</h4><p>在Spring Cloud Gateway自定义过滤器，过滤器需要实现GatewayFilter和Ordered这两个接口。我们下面来演示自定义filter计算请求的耗时。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestTimeFilter</span> <span class="keyword">implements</span> <span class="title class_">GatewayFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">log</span> <span class="operator">=</span> LogFactory.getLog(GatewayFilter.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">COUNT_Start_TIME</span> <span class="operator">=</span> <span class="string">&quot;countStartTime&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//开始时间</span></span><br><span class="line">        exchange.getAttributes().put(COUNT_Start_TIME, System.currentTimeMillis());</span><br><span class="line">        <span class="comment">//执行完成之后</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange).then(</span><br><span class="line">                Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">                    <span class="comment">//开始时间</span></span><br><span class="line">                    <span class="type">Long</span> <span class="variable">startTime</span> <span class="operator">=</span> exchange.getAttribute(COUNT_Start_TIME);</span><br><span class="line">                    <span class="comment">//结束时间</span></span><br><span class="line">                    Long endTime=(System.currentTimeMillis() - startTime);</span><br><span class="line">                    <span class="keyword">if</span> (startTime != <span class="literal">null</span>) &#123;</span><br><span class="line">                        log.info(exchange.getRequest().getURI().getRawPath() + <span class="string">&quot;: &quot;</span> + endTime + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示： getOrder返回filter的优先级，越大的值优先级越低 ， 在filterI方法中计算了请求的开始时间和结束时间</p><p>最后我们还需要把该Filter配置在对应的路由上，配置如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置TokenCheckFilter作用于那个访问规则上</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customerRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes()</span><br><span class="line">                .route(r -&gt; r.path(<span class="string">&quot;/user/**&quot;</span>)  <span class="comment">// 只有/user/**的请求才会经过RequestTimeFilter</span></span><br><span class="line">                        .filters(f -&gt; f.stripPrefix(<span class="number">1</span>)</span><br><span class="line">                                .filter(<span class="keyword">new</span> <span class="title class_">RequestTimeFilter</span>())</span><br><span class="line">                                .addResponseHeader(<span class="string">&quot;X-Response-test&quot;</span>, <span class="string">&quot;test&quot;</span>))</span><br><span class="line">                        .uri(<span class="string">&quot;lb://user-server&quot;</span>)</span><br><span class="line">                        .order(<span class="number">0</span>)</span><br><span class="line">                        .id(<span class="string">&quot;test-RequestTimeFilter&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>提示：这里将 RequestTimeFilter 添加到 “&#x2F;user&#x2F;**”这里路由上，当请求包含&#x2F;user就会触发Filter的执行。</p><h4 id="4-3-自定义GlobalFilter-重点-全局过滤器"><a href="#4-3-自定义GlobalFilter-重点-全局过滤器" class="headerlink" title="4.3.自定义GlobalFilter(重点)-全局过滤器"></a>4.3.自定义GlobalFilter(重点)-全局过滤器</h4><p>GlobalFilter:<strong>全局过滤器，不需要在配置文件中配置</strong>，作用在所有的路由上，最终通过GatewayFilterAdapter包装成GatewayFilterChain可识别的过滤器，它为请求业务以及路由的URI转换为真实业务服务的请求地址的核心过滤器，不需要配置，系统初始化时加载，并作用在每个路由上。<br>这里我们模拟了一个登陆检查的Filter.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> , Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//从请求头中获取token</span></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> exchange.getRequest().getHeaders();</span><br><span class="line">        List&lt;String&gt; strings = headers.get(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有拦截</span></span><br><span class="line">        <span class="keyword">if</span> (strings==<span class="literal">null</span>|| strings.size()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//否则放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果请求参数中没有 authToken ，就返回没有权限的状态。</p><h3 id="5-Gateway跨域配置"><a href="#5-Gateway跨域配置" class="headerlink" title="5.Gateway跨域配置"></a>5.Gateway跨域配置</h3><p>所谓的跨域是因为浏览器的同源(同一个域)策略限制，其实就是同源策略会阻止一个域的javascript脚本和另外一个域的内容进行交互 ，在前后端分离的项目架构中就会出现跨域问题，因为Gateway 网关是微服务的访问入口，所以我们只需要在Gateway配置跨域即可：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.2.RELEASE/reference/html/#cors-configuration">官方文档</a></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">globalcors:</span> <span class="comment">#跨域配置</span></span><br><span class="line">            <span class="attr">cors-configurations:</span></span><br><span class="line">              <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">                <span class="attr">allowedOrigins:</span> <span class="string">&quot;https://docs.spring.io&quot;</span> <span class="comment">#允许的站点</span></span><br><span class="line">                <span class="attr">allowedMethods:</span>	<span class="comment">#允许的请求方式</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">PUT</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">HEAD</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">CONNECT</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">TRACE</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">OPTIONS</span></span><br><span class="line">                <span class="attr">allowHeaders:</span>	<span class="comment">#允许的请求头</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">Content-Type</span></span><br></pre></td></tr></table></figure><p>提示：运行跨域访问的站点：<a target="_blank" rel="noopener" href="https://docs.spring.io/">https://docs.spring.io</a> ，同时把常见的请求方式都开放。</p><h3 id="6-Gateway超时"><a href="#6-Gateway超时" class="headerlink" title="6.Gateway超时"></a>6.Gateway超时</h3><p>超时配置在微服务调用和数据读取的时候显得尤为重要，下面演示Gateway中的全局超时设置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">httpclient:</span></span><br><span class="line">        <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">response-timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure><p>指定路由超时配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span> </span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">per_route_timeouts</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">              <span class="attr">pattern:</span> <span class="string">/delay/&#123;timeout&#125;</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">response-timeout:</span> <span class="number">200</span></span><br><span class="line">          <span class="attr">connect-timeout:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure><h2 id="六-总结"><a href="#六-总结" class="headerlink" title="六.总结"></a>六.总结</h2><h3 id="1-重点内容"><a href="#1-重点内容" class="headerlink" title="1.重点内容"></a>1.重点内容</h3><ul><li>Nacos服务注册</li><li>Nacos配置管理</li><li>Sentinel限流</li><li>Sentinel熔断</li></ul><h3 id="2-面试必备"><a href="#2-面试必备" class="headerlink" title="2.面试必备"></a>2.面试必备</h3><ul><li>SpringCloud和SpringCoudAlibaba的区别</li><li>Nacos用来做什么？</li><li>Sentinel可以如何限流?? qps 最大线程</li><li>Sentinel的流控模式有哪些？ 直接 关联 链路</li><li>Sentinel的流控效果有哪些 直接失败 队列排队(突发流量) 预热(一直稳定访问突然变高)</li><li>sentinel熔断策略 错误数 错误比例 慢调用比例</li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/ab319c68.html">https://mliutm.github.io/breeze/ab319c68.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1692708632140-ee01624d558d.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/caed5b03.html" title="蓉礼购-技术变更（四）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">蓉礼购-技术变更（四）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/e1631c9.html" title="缓存双写一致性"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">缓存双写一致性</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/ecebeadb.html" title="BIO-NIO-AIO深入剖析"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">BIO-NIO-AIO深入剖析</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div><div><a href="/breeze/a197ec68.html" title="for和forEach的区别和使用"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-16</div><div class="title">for和forEach的区别和使用</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-Alibaba"><span class="toc-text">SpringCloud Alibaba</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-text">内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-SpringCloudAlibaba%E4%BB%8B%E7%BB%8D"><span class="toc-text">一.SpringCloudAlibaba介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SpringCloudAlibaba%E8%AE%A4%E8%AF%86"><span class="toc-text">1.SpringCloudAlibaba认识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0SpringCloudAlibaba"><span class="toc-text">1.1.为什么会出现SpringCloudAlibaba</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AF-Spring-Cloud-Alibaba"><span class="toc-text">1.2.什么是 Spring Cloud Alibaba</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SpringCloud-netflix%E5%92%8CSpringCloudAlibaba"><span class="toc-text">2.SpringCloud netflix和SpringCloudAlibaba</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E4%B8%A4%E4%BB%A3%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94"><span class="toc-text">2.1.两代技术对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Spring-Cloud-Alibaba%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-text">2.2.Spring Cloud Alibaba的版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-text">二.Nacos服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Nacos%E8%AE%A4%E8%AF%86%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="toc-text">1.Nacos认识与安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFNacos"><span class="toc-text">1.1.什么是Nacos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Nacos%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%89%E8%A3%85"><span class="toc-text">1.2.Nacos服务端安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-text">2.项目结构搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">2.1.服务调用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-text">2.2.项目结构搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0Nacos-%E9%87%8D%E8%A6%81"><span class="toc-text">3.服务注册到Nacos(重要)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">3.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">3.2.主配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">3.3.配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-text">3.4.启动测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1"><span class="toc-text">4.服务通信</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-Nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-text">三.Nacos配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">1.Nacos配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1.1.概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Nacos%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-text">1.2.Nacos添加配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E9%87%8D%E8%A6%81"><span class="toc-text">2.客户端接入配置中心(重要)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">2.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E7%BC%96%E5%86%99Controller"><span class="toc-text">2.2.编写Controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E4%BF%AE%E6%94%B9yml%E9%85%8D%E7%BD%AE"><span class="toc-text">2.3.修改yml配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">2.4.测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%B3%A8%E6%84%8F%E7%BB%86%E8%8A%82"><span class="toc-text">2.5.注意细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-text">3.命名空间</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-text">3.1.创建命名空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%9C%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2.在命名空间创建配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="toc-text">3.3.客户端配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95-1"><span class="toc-text">3.4.启动测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-Sentienl%E9%99%90%E6%B5%81"><span class="toc-text">四.Sentienl限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Sentinel%E5%92%8CHystrix"><span class="toc-text">1.Sentinel和Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E9%99%90%E6%B5%81%E5%92%8C%E7%86%94%E6%96%AD"><span class="toc-text">1.1.限流和熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Hystrix%E7%9A%84%E7%86%94%E6%96%AD%E5%92%8C%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB"><span class="toc-text">1.2.Hystrix的熔断和资源隔离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Sentinel%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.3.Sentinel介绍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Sentinel%E9%99%90%E6%B5%81%E5%AE%9E%E6%88%98-%E9%87%8D%E8%A6%81"><span class="toc-text">2.Sentinel限流实战(重要)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-Sentinel-Server%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">2.1.Sentinel Server服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-Sentinel-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5"><span class="toc-text">2.2.Sentinel 客户端接入</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1.导入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AESentinel"><span class="toc-text">2.配置Sentinel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%B5%84%E6%BA%90%E9%99%90%E6%B5%81"><span class="toc-text">3.资源限流</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-Sentinel%E8%AE%BE%E7%BD%AE%E9%99%90%E6%B5%81%E7%AD%96%E7%95%A5"><span class="toc-text">2.3.Sentinel设置限流策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E9%99%90%E6%B5%81%E6%B5%8B%E8%AF%95"><span class="toc-text">2.4.限流测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Sentinel%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F-%E4%BA%86%E8%A7%A3-%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-text">3.Sentinel流控模式(了解)-触发条件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E7%9B%B4%E6%8E%A5"><span class="toc-text">3.1.直接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%85%B3%E8%81%94-%E4%BD%A0%E5%85%B3%E8%81%94%E7%9A%84%E5%88%B0%E8%BE%BE%E4%B8%80%E5%AE%9A%E5%B9%B6%E5%8F%91-%E9%99%90%E5%88%B6%E8%87%AA%E5%B7%B1"><span class="toc-text">3.2.关联-你关联的到达一定并发,限制自己</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E9%93%BE%E8%B7%AF-%E4%BD%A0%E8%B0%83%E7%94%A8%E7%9A%84%E5%88%B0%E8%BE%BE%E4%B8%80%E5%AE%9A%E5%B9%B6%E5%8F%91-%E9%99%90%E5%88%B6%E8%87%AA%E5%B7%B1"><span class="toc-text">3.3.链路-你调用的到达一定并发,限制自己</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Sentinel%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C-%E4%BA%86%E8%A7%A3-%E5%81%9A%E5%87%BA%E5%93%8D%E5%BA%94"><span class="toc-text">4.Sentinel流控效果(了解)-做出响应</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-text">4.1.快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-Warm-Up%E9%A2%84%E7%83%AD"><span class="toc-text">4.2.Warm Up预热</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-text">4.3.排队等待</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%83%AD%E7%82%B9%E9%99%90%E6%B5%81-%E6%89%A9%E5%B1%95"><span class="toc-text">5.热点限流(扩展)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-text">5.1.参数限流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E5%8F%82%E6%95%B0%E5%80%BC%E9%99%90%E6%B5%81"><span class="toc-text">5.2.参数值限流</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99-%E6%89%A9%E5%B1%95"><span class="toc-text">6.系统规则(扩展)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E9%99%90%E6%B5%81%E8%A7%84%E5%88%99"><span class="toc-text">6.1.配置全局限流规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Gateway%E4%BD%BF%E7%94%A8Sentinel%E9%99%90%E6%B5%81-%E9%87%8D%E8%A6%81"><span class="toc-text">7.Gateway使用Sentinel限流(重要)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">7.1.导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-%E9%85%8D%E7%BD%AESentinel%E5%9C%B0%E5%9D%80"><span class="toc-text">7.2.配置Sentinel地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-%E9%85%8D%E7%BD%AE%E9%99%90%E6%B5%81%E8%A7%84%E5%88%99"><span class="toc-text">7.3.配置限流规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95"><span class="toc-text">8 限流算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-Sentinel%E7%86%94%E6%96%AD"><span class="toc-text">五.Sentinel熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1.概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%86%94%E6%96%AD"><span class="toc-text">1.1.什么是熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Sentinel%E7%86%94%E6%96%AD"><span class="toc-text">1.2.Sentinel熔断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Sentnel%E7%86%94%E6%96%AD%E5%AE%9E%E6%88%98%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">2.Sentnel熔断实战（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E8%B5%84%E6%BA%90%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-text">2.1.资源熔断降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E9%85%8D%E7%BD%AE%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="toc-text">2.2.配置降级策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B5%8B%E8%AF%95%E7%86%94%E6%96%AD"><span class="toc-text">2.3.测试熔断</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-text">3.熔断规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%B9%B3%E5%9D%87%E5%93%8D%E5%BA%94RT"><span class="toc-text">3.1.平均响应RT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-text">3.2.异常比例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-text">3.3.异常数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-text">3.4.慢调用比例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-openFeign%E6%95%B4%E5%90%88Sentinel%E7%86%94%E6%96%AD-%E9%87%8D%E8%A6%81"><span class="toc-text">4.openFeign整合Sentinel熔断(重要)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%BC%80%E5%90%AFSentinel"><span class="toc-text">4.1.开启Sentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E7%BB%99Feign%E6%8E%A5%E5%8F%A3%E9%99%8D%E7%BA%A7"><span class="toc-text">4.2.给Feign接口降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E7%BC%96%E5%86%99%E9%99%8D%E7%BA%A7%E7%B1%BB"><span class="toc-text">4.3.编写降级类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3SpringCloud-Gateway"><span class="toc-text">六 服务网关SpringCloud Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">1.基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Zuul%E4%B8%8EGateway"><span class="toc-text">1.1.Zuul与Gateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Spring-Cloud-Gataway%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text">1.2.Spring Cloud Gataway的特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Spring-Cloud-Gataway%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">1.3.Spring Cloud Gataway的核心概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-Spring-Cloud-Gateway%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-text">1.4.Spring Cloud Gateway的工作方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Spring-Cloud-Gataway%E5%85%A5%E9%97%A8"><span class="toc-text">2. Spring Cloud Gataway入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">2.1.创建工程导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">2.2.主配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-yml%E9%85%8D%E7%BD%AE"><span class="toc-text">2.3.yml配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">2.5.访问测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Predicate%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-text">3. Predicate断言工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-text">3.1.什么是断言工厂</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%A0%B9%E6%8D%AE%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E6%96%AD%E8%A8%80-Query-Route-Predicate-Factory"><span class="toc-text">3.2.根据查询参数断言- Query Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%A0%B9%E6%8D%AEpath%E6%96%AD%E8%A8%80-Path-Route-Predicate-Factory-%E9%87%8D%E8%A6%81"><span class="toc-text">3.3.根据path断言-Path Route Predicate Factory(重要)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%A0%B9%E6%8D%AE%E6%9D%83%E9%87%8D%E6%AF%94%E4%BE%8B%E6%96%AD%E8%A8%80-Weight-Route-Predicate-Factory"><span class="toc-text">3.4.根据权重比例断言-Weight Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E6%A0%B9%E6%8D%AE%E8%BF%9C%E7%A8%8Bip%E6%96%AD%E8%A8%80-RemoteAddr-Route-Predicate-Factory"><span class="toc-text">3.5.根据远程ip断言 - RemoteAddr Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E4%B9%8B%E5%90%8E%E6%96%AD%E8%A8%80-After-Route-Predicate-Factory"><span class="toc-text">3.6.指定时间之后断言-After Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-%E5%9C%A8%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E4%B9%8B%E5%89%8D%E6%96%AD%E8%A8%80-Before-Route-Predicate-Factory"><span class="toc-text">3.7.在指定时间之前断言-Before Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-8-%E5%9C%A8%E6%8C%87%E5%AE%9A%E6%97%B6%E9%97%B4%E6%AE%B5%E4%B9%8B%E9%97%B4%E6%96%AD%E8%A8%80-Between-Route-Predicate-Factory"><span class="toc-text">3.8.在指定时间段之间断言-Between Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-9-%E6%A0%B9%E6%8D%AEcookie%E6%96%AD%E8%A8%80-Cookie-Route-Predicate-Factory"><span class="toc-text">3.9.根据cookie断言-Cookie Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-10-%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%96%AD%E8%A8%80-Header-Route-Predicate-Factory"><span class="toc-text">3.10.根据请求头断言-Header Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-11-%E6%A0%B9%E6%8D%AE%E4%B8%BB%E6%9C%BA%E6%96%AD%E8%A8%80-Host-Route-Predicate-Factory"><span class="toc-text">3.11.根据主机断言-Host Route Predicate Factory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-12-%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F%E6%96%AD%E8%A8%80-Method-Route-Predicate-Factory"><span class="toc-text">3.12.根据请求方式断言-Method Route Predicate Factory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Gateway-%E7%9A%84-Filter-%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-text">4.Gateway 的 Filter 过滤器（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-Gateway-filter"><span class="toc-text">4.1.Gateway filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E8%87%AA%E5%AE%9A%E4%B9%89Gateway-Filter-%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">4.2.自定义Gateway Filter-局部过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E8%87%AA%E5%AE%9A%E4%B9%89GlobalFilter-%E9%87%8D%E7%82%B9-%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">4.3.自定义GlobalFilter(重点)-全局过滤器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Gateway%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-text">5.Gateway跨域配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Gateway%E8%B6%85%E6%97%B6"><span class="toc-text">6.Gateway超时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%80%BB%E7%BB%93"><span class="toc-text">六.总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%87%8D%E7%82%B9%E5%86%85%E5%AE%B9"><span class="toc-text">1.重点内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9D%A2%E8%AF%95%E5%BF%85%E5%A4%87"><span class="toc-text">2.面试必备</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1692708632140-ee01624d558d.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>