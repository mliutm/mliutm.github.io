<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>蓉车宝-用户模块-注册（十） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="蓉车宝-用户模块-注册内容 用户模块需求分析（掌握）  注册-分析与设计（掌握）  注册-发送图片验证码设计&amp;实现（掌握）  注册-发送短信验证码设计&amp;实现（掌握）  注册-完整实现（掌握）   一.用户模块需求分析1.功能点分析 用户注册 ​	登录信息 ​	基本信息 ​	安全信息  用户登录 ​	账号登录 ​    验证码登录-自己做  reids.set(logincode+p"><meta property="og:type" content="article"><meta property="og:title" content="蓉车宝-用户模块-注册（十）"><meta property="og:url" content="https://mliutm.github.io/breeze/ea1d6962.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="蓉车宝-用户模块-注册内容 用户模块需求分析（掌握）  注册-分析与设计（掌握）  注册-发送图片验证码设计&amp;实现（掌握）  注册-发送短信验证码设计&amp;实现（掌握）  注册-完整实现（掌握）   一.用户模块需求分析1.功能点分析 用户注册 ​	登录信息 ​	基本信息 ​	安全信息  用户登录 ​	账号登录 ​    验证码登录-自己做  reids.set(logincode+p"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><meta property="article:published_time" content="2023-11-20T12:59:01.000Z"><meta property="article:modified_time" content="2023-12-27T03:26:55.784Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/ea1d6962.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"蓉车宝-用户模块-注册（十）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-12-27 11:26:55"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">蓉车宝-用户模块-注册（十）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-20T12:59:01.000Z" title="发表于 2023-11-20 20:59:01">2023-11-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-27T03:26:55.784Z" title="更新于 2023-12-27 11:26:55">2023-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E8%93%89%E8%BD%A6%E5%AE%9D/">蓉车宝</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>41分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="蓉车宝-用户模块-注册（十）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="蓉车宝-用户模块-注册"><a href="#蓉车宝-用户模块-注册" class="headerlink" title="蓉车宝-用户模块-注册"></a>蓉车宝-用户模块-注册</h1><h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ul><li><p>用户模块需求分析（掌握）</p></li><li><p>注册-分析与设计（掌握）</p></li><li><p>注册-发送图片验证码设计&amp;实现（掌握）</p></li><li><p>注册-发送短信验证码设计&amp;实现（掌握）</p></li><li><p>注册-完整实现（掌握）</p></li></ul><h2 id="一-用户模块需求分析"><a href="#一-用户模块需求分析" class="headerlink" title="一.用户模块需求分析"></a>一.用户模块需求分析</h2><h3 id="1-功能点分析"><a href="#1-功能点分析" class="headerlink" title="1.功能点分析"></a>1.功能点分析</h3><ul><li><p>用户注册</p><p>​	登录信息</p><p>​	基本信息</p><p>​	安全信息</p></li><li><p>用户登录</p><p>​	账号登录</p><p>​ 验证码登录-自己做 reids.set(logincode+phone,xxx)</p><p>三方登录-使用三方app（微信，qq，支付宝等） - 实现</p><p>​	扫码登录-自己app扫描页面 - 暂时不实现</p></li><li><p>找回密码</p></li><li><p>修改密码</p></li><li><p>用户管理</p><p>后台要禁用等功能</p></li><li><p>用户地址管理</p></li><li><p>收藏</p><p>​	商品收藏</p><p>​	店铺收藏</p><p>​	服务收藏</p><p>​	车辆收藏</p></li><li><p>足迹</p></li></ul><p>PS：<code>其实后台管理都要有对应的模块进行管理 用户模块 地址管理模块 收藏模块 足迹模块</code></p><h3 id="2-表分析"><a href="#2-表分析" class="headerlink" title="2.表分析"></a>2.表分析</h3><p><img src="/breeze/ea1d6962/image-20220914145218059.png" alt="image-20220914145218059"></p><p><img src="/breeze/ea1d6962/image-20220914150250228.png" alt="image-20220914150250228"></p><p>​ 我们<code>只讲注册和登录</code>。因为其他的都是crud。 但是以后写简历项目时，要说做的是用户模块，里面才是具体的功能。</p><h2 id="二-注册分析与设计"><a href="#二-注册分析与设计" class="headerlink" title="二.注册分析与设计"></a>二.注册分析与设计</h2><h3 id="1-分析需求"><a href="#1-分析需求" class="headerlink" title="1.分析需求"></a>1.分析需求</h3><ul><li>界面</li></ul><p><img src="/breeze/ea1d6962/1688698781296.png" alt="1688698781296"></p><ul><li>注册页面整增加图形验证码功能</li></ul><p>这里为了更贴近企业级业务，我们在注册页面整增加图形验证码功能</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;clearfix&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;input left&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>  <span class="attr">name</span>=<span class="string">&quot;verify&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;输入验证码&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100px;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;imageCode&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​ &#x3D;&#x3D;流程：先校验图片验证码获取手机验证码，校验短信验证码，提交注册&#x3D;&#x3D;</p><h3 id="2-设计"><a href="#2-设计" class="headerlink" title="2.设计"></a>2.设计</h3><p>界面设计（ui）设计表（后台） 流程设计（后台）</p><p>​	&#x3D;&#x3D;这里强调一下：在企业中，可不是拿到需求就开发。开发的流程是需求分析-&gt;界面原型t图设计-&gt;界面效果图-&gt;表设计-&gt;流程设计-&gt;开发。&#x3D;&#x3D;</p><p>以后你们在拿到需求之后，也要认真分析清楚，在动手开发，分析永远先行，要不可能做完了却满足不了要求。</p><h4 id="2-1-数据库表设计三范式"><a href="#2-1-数据库表设计三范式" class="headerlink" title="2.1.数据库表设计三范式"></a>2.1.数据库表设计三范式</h4><p>​	范式就是规范，就是要遵守的原则。一般要遵守有三种范式</p><p>​ 1NF(1范式): 设计数据库表的列的时候，这些列不可拆分。 列的原子性，其实这种范式可以不用管，关系型数据库默认都满足。</p><p>​ 2NF(2范式)：表中行是唯一，通常设计一个主键来实现。</p><p>​ 3NF(3范式)： 如果一张表的数据能够通过其他表推导出来，不应该单独设计，通过外键的方式关联查询出来。</p><p>​	反3NF：正常情况来说，我们必须遵循3NF，但是有的时候我们为了增强查询效率，会设计一些冗余字段，变多表查询为单表查询。</p><h4 id="2-2-表设计"><a href="#2-2-表设计" class="headerlink" title="2.2. 表设计"></a>2.2. 表设计</h4><p>​ 为了分析注册相关的表，我们这里以登录业务线为主题来分析表。因为注册的目的就是为了后面登录系统，注册和登录是一体的。</p><p><img src="/breeze/ea1d6962/image-20211026100355290.png" alt="image-20211026100355290"></p><ul><li>用户表</li></ul><p><img src="/breeze/ea1d6962/image-20211026100516183.png" alt="image-20211026100516183"></p><ul><li><p>登录表</p><p><img src="/breeze/ea1d6962/image-20211026100606342.png" alt="image-20211026100606342"></p></li></ul><p>​ Type，我们的设计就算你是管理员，你想消费，你也要注册用户，意味着eployee和user中分别有记录。 也就会造成logininfo有相同电话或用户名或email等两个记录，通过type进行区分。</p><p>​ 注意：	<code>以后只要在eployee或user操作时涉及到登录信息都要同步操作logininfo。比如添加员工也要在logininfo添加一条记录，注册用户也要在logininfo中添加。同理删除或修改也要同步。</code></p><h4 id="2-3-注册主流程设计"><a href="#2-3-注册主流程设计" class="headerlink" title="2.3.注册主流程设计"></a>2.3.注册主流程设计</h4><p><img src="/breeze/ea1d6962/image-20211026091658462.png" alt="image-20211026091658462"></p><h2 id="三-图片验证码设计-实现"><a href="#三-图片验证码设计-实现" class="headerlink" title="三.图片验证码设计&amp;实现"></a>三.图片验证码设计&amp;实现</h2><p>要想实现图片验证码，一般就两种实现方案：</p><ul><li><p>在线接口（用别人的）</p><p>eg：<a target="_blank" rel="noopener" href="https://dun.163.com/product/captcha?from=baiduP2_YZM_CP2996">https://dun.163.com/product/captcha?from=baiduP2_YZM_CP2996</a></p><p>找它提供的文档，然后对接即可—-然后给钱，哈哈哈</p></li><li><p>我们自己研究-java实现图形验证码</p><p>eg：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hxw6/p/10151766.html">https://www.cnblogs.com/hxw6/p/10151766.html</a></p><p>所以，接下来我们要来探讨的是自行研究图形验证码</p></li></ul><h3 id="1-非前后端分离项目验证码方案"><a href="#1-非前后端分离项目验证码方案" class="headerlink" title="1.非前后端分离项目验证码方案"></a>1.非前后端分离项目验证码方案</h3><p><img src="/breeze/ea1d6962/image-20211026091359596.png" alt="image-20211026091359596"></p><p><img src="/breeze/ea1d6962/image-20211026092603016.png" alt="image-20211026092603016"></p><ol><li>前端发送图片验证码获取请求</li><li>后端收到请求，生成图片验证码的值</li><li>把图片验证码的值存储到Session</li><li>把图片验证码的值合并到一个图片中</li><li>通过Response把图片使用流的方式响应给前端</li><li>前端展示图片，用户输入图片验证码的值</li><li>前台提交注册请求 ，验证图片验证码，后端把前端传入的图片验证码的值和Session中的图片验证码的值做比较</li></ol><p>前端</p><p>​ static&#x2F;regiger.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">changeCode</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;123&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> xmlhttp;</span></span><br><span class="line"><span class="language-javascript">            xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">            xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;/validateCode/img&quot;</span>,<span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">            xmlhttp.<span class="property">responseType</span> = <span class="string">&quot;blob&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            xmlhttp.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> blob = <span class="variable language_">this</span>.<span class="property">response</span>;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;validateCode&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    img.<span class="property">src</span> = <span class="variable language_">window</span>.<span class="property">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            xmlhttp.<span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;register&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    验证码:<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/validateCode/img&quot;</span> <span class="attr">id</span>=<span class="string">&quot;validateCode&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;changeCode()&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/validateCode&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ValidateCodeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/img&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">imgeCode</span><span class="params">(HttpSession session, HttpServletResponse response)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//产生验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> VerifyCodeUtils.generateVerifyCode(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//存放session</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;verifyCode&quot;</span>,verifyCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把验证码最为图片响应给客户端</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">            VerifyCodeUtils.outputImage(<span class="number">200</span>,<span class="number">40</span>,os,verifyCode);</span><br><span class="line">            os.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-前后端分离验证码方案"><a href="#2-前后端分离验证码方案" class="headerlink" title="2.前后端分离验证码方案"></a>2.前后端分离验证码方案</h3><p><em><strong>思考问题</strong></em></p><ol><li><p>现在还能用Response把图片响应给 <code>&lt;img/&gt;</code> 标签吗 ， 不能，因为我们前端使用Ajax发请求了？怎么响应：把图片基于Base64编码，把编码后的字符串响应给前端，一样的能展示<strong>base64图片代替流响应</strong></p></li><li><p>还能用session存储图片验证码的值吗？不能，我们使用Redis存储图片验证码</p></li><li><p><em><strong>图片验证码在Redis的key如何生成</strong></em>？(需求：不准出现大量无用的key在Redis，多个页面的图片验证码也不能覆盖)</p><p>即：</p><ul><li><p>不管什么情况，只要打开一个注册页面，那么就应该有一个唯一的KEY,及时多个人打开多个注册页面，也是不同的key</p></li><li><p>同一个电脑，同一个浏览器， 同一个页面 ，多次获取图片验证码，使用同一个key</p></li><li><p>我们在前端使用UUID来生成后端Redis的key，同一个页面使用唯一的一个KEY。</p></li></ul></li></ol><p><em><strong>解决方案</strong></em></p><p><img src="/breeze/ea1d6962/image-20211026093247211.png" alt="image-20211026093247211"></p><h3 id="3-图片验证码流程"><a href="#3-图片验证码流程" class="headerlink" title="3.图片验证码流程"></a>3.图片验证码流程</h3><p><img src="/breeze/ea1d6962/image-20211026093323741.png" alt="image-20211026093323741"></p><ol><li><p>请求图片验证码之前判断localStorage是否有KEY,如果没就创建，然后保存localStorage,如果有自己直接作为参数发送Ajax请求获取图片验证码</p></li><li><p>前端通过ajax发送一个图片验证码请求,携带者KEY</p></li><li><p>后端收到请求，生成图片验证码的值</p></li><li><p>把图片验证码的值存储到Redis，以前段传入的key作为Redis的key</p></li><li><p>把图片验证码的值合并到一个图片中</p></li><li><p>把图片基于Base64编码层字符串，响应给前端</p></li><li><p>前端拿到base64字符串，进行图片的展示，用户输入图片验证码</p></li></ol><p>前台提交注册请求 ，验证图片验证码(key也要携带)，后端把前端传入的图片验证码的值和Redis中的图片验证码的值做比较</p><p><img src="/breeze/ea1d6962/image-20220914170254650.png" alt="image-20220914170254650"></p><h3 id="4-相关技术准备"><a href="#4-相关技术准备" class="headerlink" title="4.相关技术准备"></a>4.相关技术准备</h3><h4 id="4-1-随机字符串"><a href="#4-1-随机字符串" class="headerlink" title="4.1.随机字符串"></a>4.1.随机字符串</h4><p>​ 用来生成数字验证码</p><p><strong>StrUtils</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itsource.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mliutm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/26-16:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把逗号分隔的字符串转换字符串数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] splitStr2StrArr(String str,String split) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str != <span class="literal">null</span> &amp;&amp; !str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> str.split(split);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把逗号分隔字符串转换List的Long</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Long&gt; <span class="title function_">splitStr2LongArr</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        String[] strings = splitStr2StrArr(str,<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (strings == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String string : strings) &#123;</span><br><span class="line">            result.add(Long.parseLong(string));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把逗号分隔字符串转换List的Long</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Long&gt; <span class="title function_">splitStr2LongArr</span><span class="params">(String str,String split)</span> &#123;</span><br><span class="line">        String[] strings = splitStr2StrArr(str,split);</span><br><span class="line">        <span class="keyword">if</span> (strings == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String string : strings) &#123;</span><br><span class="line">            result.add(Long.parseLong(string));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getRandomString</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;0123456789&quot;</span>;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> random.nextInt(<span class="number">10</span>);</span><br><span class="line">            sb.append(str.charAt(number));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getComplexRandomString</span><span class="params">(<span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> random.nextInt(<span class="number">62</span>);</span><br><span class="line">            sb.append(str.charAt(number));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">convertPropertiesToHtml</span><span class="params">(String properties)</span>&#123;</span><br><span class="line">        <span class="comment">//1:容量:6:32GB_4:样式:12:塑料壳</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String[] propArr = properties.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String props : propArr) &#123;</span><br><span class="line">            String[] valueArr = props.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            sBuilder.append(valueArr[<span class="number">1</span>]).append(<span class="string">&quot;:&quot;</span>).append(valueArr[<span class="number">3</span>]).append(<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="4-2-画图形验证码"><a href="#4-2-画图形验证码" class="headerlink" title="4.2.画图形验证码"></a>4.2.画图形验证码</h4><p>直接使用工具类：</p><p><strong>VerifyCodeUtils</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itsource.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.geom.AffineTransform;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Wzy</span></span><br><span class="line"><span class="comment"> * on 2018/5/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyCodeUtils</span> &#123;</span><br><span class="line">    <span class="comment">//使用到Algerian字体，系统里没有的话需要安装字体，字体只显示大写，去掉了1,0,i,o几个容易混淆的字符</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VERIFY_CODES</span> <span class="operator">=</span> <span class="string">&quot;23456789ABCDEFGHJKLMNPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用系统默认字符源生成验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize 验证码长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateVerifyCode</span><span class="params">(<span class="type">int</span> verifySize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> generateVerifyCode(verifySize, VERIFY_CODES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用指定源生成验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> verifySize 验证码长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources    验证码字符源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateVerifyCode</span><span class="params">(<span class="type">int</span> verifySize, String sources)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sources == <span class="literal">null</span> || sources.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            sources = VERIFY_CODES;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">codesLen</span> <span class="operator">=</span> sources.length();</span><br><span class="line">        <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">verifyCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(verifySize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; verifySize; i++) &#123;</span><br><span class="line">            verifyCode.append(sources.charAt(rand.nextInt(codesLen - <span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> verifyCode.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 输出指定验证码图片流</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">outputImage</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, OutputStream os, String code)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">verifySize</span> <span class="operator">=</span> code.length();</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(w, h, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">Graphics2D</span> <span class="variable">g2</span> <span class="operator">=</span> image.createGraphics();</span><br><span class="line">        g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">        Color[] colors = <span class="keyword">new</span> <span class="title class_">Color</span>[<span class="number">5</span>];</span><br><span class="line">        Color[] colorSpaces = <span class="keyword">new</span> <span class="title class_">Color</span>[]&#123;Color.WHITE, Color.CYAN,</span><br><span class="line">                                          Color.GRAY, Color.LIGHT_GRAY, Color.MAGENTA, Color.ORANGE,</span><br><span class="line">                                          Color.PINK, Color.YELLOW&#125;;</span><br><span class="line">        <span class="type">float</span>[] fractions = <span class="keyword">new</span> <span class="title class_">float</span>[colors.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; colors.length; i++) &#123;</span><br><span class="line">            colors[i] = colorSpaces[rand.nextInt(colorSpaces.length)];</span><br><span class="line">            fractions[i] = rand.nextFloat();</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(fractions);</span><br><span class="line"></span><br><span class="line">        g2.setColor(Color.GRAY);<span class="comment">// 设置边框色</span></span><br><span class="line">        g2.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Color</span> <span class="variable">c</span> <span class="operator">=</span> getRandColor(<span class="number">200</span>, <span class="number">250</span>);</span><br><span class="line">        g2.setColor(c);<span class="comment">// 设置背景色</span></span><br><span class="line">        g2.fillRect(<span class="number">0</span>, <span class="number">2</span>, w, h - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绘制干扰线</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        g2.setColor(getRandColor(<span class="number">160</span>, <span class="number">200</span>));<span class="comment">// 设置线条的颜色</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(w - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(h - <span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">xl</span> <span class="operator">=</span> random.nextInt(<span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">yl</span> <span class="operator">=</span> random.nextInt(<span class="number">12</span>) + <span class="number">1</span>;</span><br><span class="line">            g2.drawLine(x, y, x + xl + <span class="number">40</span>, y + yl + <span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加噪点</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">yawpRate</span> <span class="operator">=</span> <span class="number">0.05f</span>;<span class="comment">// 噪声率</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">area</span> <span class="operator">=</span> (<span class="type">int</span>) (yawpRate * w * h);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; area; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> random.nextInt(w);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> random.nextInt(h);</span><br><span class="line">            <span class="type">int</span> <span class="variable">rgb</span> <span class="operator">=</span> getRandomIntColor();</span><br><span class="line">            image.setRGB(x, y, rgb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        shear(g2, w, h, c);<span class="comment">// 使图片扭曲</span></span><br><span class="line"></span><br><span class="line">        g2.setColor(getRandColor(<span class="number">100</span>, <span class="number">160</span>));</span><br><span class="line">        <span class="type">int</span> <span class="variable">fontSize</span> <span class="operator">=</span> h - <span class="number">4</span>;</span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(<span class="string">&quot;Algerian&quot;</span>, Font.ITALIC, fontSize);</span><br><span class="line">        g2.setFont(font);</span><br><span class="line">        <span class="type">char</span>[] chars = code.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; verifySize; i++) &#123;</span><br><span class="line">            <span class="type">AffineTransform</span> <span class="variable">affine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AffineTransform</span>();</span><br><span class="line">            affine.setToRotation(Math.PI / <span class="number">4</span> * rand.nextDouble() * (rand.nextBoolean() ? <span class="number">1</span> : -<span class="number">1</span>), (w / verifySize) * i + fontSize / <span class="number">2</span>, h / <span class="number">2</span>);</span><br><span class="line">            g2.setTransform(affine);</span><br><span class="line">            g2.drawChars(chars, i, <span class="number">1</span>, ((w - <span class="number">10</span>) / verifySize) * i + <span class="number">5</span>, h / <span class="number">2</span> + fontSize / <span class="number">2</span> - <span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        g2.dispose();</span><br><span class="line">        ImageIO.write(image, <span class="string">&quot;jpg&quot;</span>, os);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Color <span class="title function_">getRandColor</span><span class="params">(<span class="type">int</span> fc, <span class="type">int</span> bc)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fc &gt; <span class="number">255</span>)</span><br><span class="line">            fc = <span class="number">255</span>;</span><br><span class="line">        <span class="keyword">if</span> (bc &gt; <span class="number">255</span>)</span><br><span class="line">            bc = <span class="number">255</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">g</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> fc + random.nextInt(bc - fc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Color</span>(r, g, b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getRandomIntColor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] rgb = getRandomRgb();</span><br><span class="line">        <span class="type">int</span> <span class="variable">color</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> c : rgb) &#123;</span><br><span class="line">            color = color &lt;&lt; <span class="number">8</span>;</span><br><span class="line">            color = color | c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] getRandomRgb() &#123;</span><br><span class="line">        <span class="type">int</span>[] rgb = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            rgb[i] = random.nextInt(<span class="number">255</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rgb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shear</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line">        shearX(g, w1, h1, color);</span><br><span class="line">        shearY(g, w1, h1, color);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shearX</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> random.nextInt(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">borderGap</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">frames</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> random.nextInt(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; h1; i++) &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="type">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                * Math.sin((<span class="type">double</span>) i / (<span class="type">double</span>) period</span><br><span class="line">                           + (<span class="number">6.2831853071795862D</span> * (<span class="type">double</span>) phase)</span><br><span class="line">                           / (<span class="type">double</span>) frames);</span><br><span class="line">            g.copyArea(<span class="number">0</span>, i, w1, <span class="number">1</span>, (<span class="type">int</span>) d, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">                g.setColor(color);</span><br><span class="line">                g.drawLine((<span class="type">int</span>) d, i, <span class="number">0</span>, i);</span><br><span class="line">                g.drawLine((<span class="type">int</span>) d + w1, i, w1, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shearY</span><span class="params">(Graphics g, <span class="type">int</span> w1, <span class="type">int</span> h1, Color color)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">period</span> <span class="operator">=</span> random.nextInt(<span class="number">40</span>) + <span class="number">10</span>; <span class="comment">// 50;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">borderGap</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">frames</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">phase</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; w1; i++) &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">d</span> <span class="operator">=</span> (<span class="type">double</span>) (period &gt;&gt; <span class="number">1</span>)</span><br><span class="line">                * Math.sin((<span class="type">double</span>) i / (<span class="type">double</span>) period</span><br><span class="line">                           + (<span class="number">6.2831853071795862D</span> * (<span class="type">double</span>) phase)</span><br><span class="line">                           / (<span class="type">double</span>) frames);</span><br><span class="line">            g.copyArea(i, <span class="number">0</span>, <span class="number">1</span>, h1, <span class="number">0</span>, (<span class="type">int</span>) d);</span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;</span><br><span class="line">                g.setColor(color);</span><br><span class="line">                g.drawLine(i, (<span class="type">int</span>) d, i, <span class="number">0</span>);</span><br><span class="line">                g.drawLine(i, (<span class="type">int</span>) d + h1, i, h1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取随机验证码及其加密图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">VerifyCode</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, <span class="type">int</span> size)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> generateVerifyCode(size).toLowerCase();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        outputImage(w, h, data, code);</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(data.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取随机验证码及其加密图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">VerifyCode</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, String code)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        outputImage(w, h, data, code);</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(data.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取随机验证码及其加密图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteArrayOutputStream <span class="title function_">VerifyCodeImg</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, <span class="type">int</span> size)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> generateVerifyCode(size).toLowerCase();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        outputImage(w, h, data, code);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">        <span class="comment">//单体项目验证码实现-响应流</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        String code = generateVerifyCode(4).toLowerCase();</span></span><br><span class="line"><span class="comment">        System.out.println(code);</span></span><br><span class="line"><span class="comment">        ByteArrayOutputStream data = new ByteArrayOutputStream();</span></span><br><span class="line"><span class="comment">        outputImage(100, 20, data, code);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        FileOutputStream fileOutputStream = null;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">        fileOutputStream = new FileOutputStream(&quot;D:\\1.jpg&quot;);</span></span><br><span class="line"><span class="comment">        fileOutputStream.write(data.toByteArray());</span></span><br><span class="line"><span class="comment">        &#125; catch (FileNotFoundException e) &#123;</span></span><br><span class="line"><span class="comment">         e.printStackTrace();</span></span><br><span class="line"><span class="comment">        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="comment">         e.printStackTrace();</span></span><br><span class="line"><span class="comment">         &#125;*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//响应base64编码字符串</span></span><br><span class="line">        <span class="comment">//System.out.println(VerifyCode(80, 30, 6));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>工具类中使用到了Graphics2D（画图）、BASE64Encoder（base64编码器）</p><p><strong>RedisUtils</strong>这里没用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itsource.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取连接池对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">RedisUtils</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">JedisPool</span> <span class="variable">jedisPool</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//1 创建连接池配置对象</span></span><br><span class="line">        <span class="type">JedisPoolConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        <span class="comment">//2 进行配置-四个配置</span></span><br><span class="line">        config.setMaxIdle(<span class="number">1</span>);<span class="comment">//最小连接数</span></span><br><span class="line">        config.setMaxTotal(<span class="number">11</span>);<span class="comment">//最大连接数</span></span><br><span class="line">        config.setMaxWaitMillis(<span class="number">10</span> * <span class="number">1000L</span>);<span class="comment">//最长等待时间</span></span><br><span class="line">        config.setTestOnBorrow(<span class="literal">true</span>);<span class="comment">//测试连接时是否畅通</span></span><br><span class="line">        <span class="comment">//3 通过配置对象创建连接池对象</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties = <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(RedisUtils.class.getClassLoader().getResourceAsStream(<span class="string">&quot;redis.properties&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;redis.host&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;redis.port&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;redis.password&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">timeout</span> <span class="operator">=</span> properties.getProperty(<span class="string">&quot;redis.timeout&quot;</span>);</span><br><span class="line">        System.out.println(host);</span><br><span class="line">        System.out.println(port);</span><br><span class="line">        System.out.println(password);</span><br><span class="line">        System.out.println(timeout);</span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(config, host, Integer.valueOf(port),Integer.valueOf(timeout), password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取连接</span></span><br><span class="line">    <span class="keyword">public</span> Jedis <span class="title function_">getSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭资源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeSource</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="literal">null</span>) &#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置字符值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        jedis.del(key);</span><br><span class="line">        closeSource(jedis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置字符值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        jedis.set(key, value);</span><br><span class="line">        closeSource(jedis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">byte</span>[] key, <span class="type">byte</span>[] value)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        jedis.set(key, value);</span><br><span class="line">        closeSource(jedis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[]  get(<span class="type">byte</span>[] key) &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jedis.get(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeSource(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置字符值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> jedis.get(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeSource(jedis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, String value, Integer time)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> getSource();</span><br><span class="line">        jedis.setex(key,time,value);</span><br><span class="line">        closeSource(jedis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-Redis"><a href="#4-3-Redis" class="headerlink" title="4.3.Redis"></a>4.3.Redis</h4><ul><li>1）导入jar</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!--spirngboot springdata对redis支持--&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​ 2）做配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">2000ms</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><p>​ 3）RedisTemplate</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTest</span> <span class="keyword">extends</span> <span class="title class_">BaseTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(template);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-图片验证码实现"><a href="#5-图片验证码实现" class="headerlink" title="5.图片验证码实现"></a>5.图片验证码实现</h3><h4 id="5-1-搭建用户模块"><a href="#5-1-搭建用户模块" class="headerlink" title="5.1.搭建用户模块"></a>5.1.搭建用户模块</h4><p>直接使用Mybatis代码自动生成工具生成</p><h5 id="1-User-loginInfo"><a href="#1-User-loginInfo" class="headerlink" title="1. User loginInfo"></a>1. User loginInfo</h5><h5 id="2-配置yml"><a href="#2-配置yml" class="headerlink" title="2.配置yml"></a>2.配置yml</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type-aliases-package:</span> </span><br><span class="line">	<span class="string">cn.ronghuanet.org.domain,cn.ronghuanet.org.query,cn.ronghuanet.user.domain,cn.ronghuanet.user.query</span></span><br></pre></td></tr></table></figure><h4 id="5-2-前台实现"><a href="#5-2-前台实现" class="headerlink" title="5.2.前台实现"></a>5.2.前台实现</h4><p>集成vue和axios</p><p>​	1）拷贝vue&amp;axios js库</p><pre><code>      从pethome_admin nodemodul拷贝
</code></pre><p>​	2）在register.html配置</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入vue和axios--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./plugins/vue/dist/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./plugins/axios/dist/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;script&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--//给vue添加一个全局属性--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Vue.prototype.$http=axios;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--//配置axios的全局基本路径--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--axios.defaults.baseURL=&#x27;http://localhost:80/&#x27;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;/script&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./js/common.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">             //配置axios的前缀</span><br><span class="line">   axios.default.baseURI=&#x27;http://localhost:8080;</span><br><span class="line">   //把axios配置为全局变量</span><br><span class="line">   Vue.prototype.$http = axios //给Vue这个类添加一个原型的属性,这个类的对象都能调用</span><br><span class="line">   //屏蔽vue的警告</span><br><span class="line">   Vue.config.productionTip = false</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--vue的js写法--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//创建vue是需要给他传递一个对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>:<span class="string">&quot;#registerDiv&quot;</span>, <span class="comment">//id在hmtl模板中要对应</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>:&#123; <span class="comment">//数据模型</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">msg</span>:<span class="string">&quot;zs&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>:&#123;<span class="comment">//方法</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">mounted</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">alert</span>(<span class="variable language_">this</span>.<span class="property">$http</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​	3）添加methods</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">createUuid</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">var</span> s = [];</span><br><span class="line">   <span class="keyword">var</span> hexDigits = <span class="string">&quot;0123456789abcdefghi&quot;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">36</span>; i++) &#123;</span><br><span class="line">      s[i] = hexDigits.<span class="title function_">substr</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">0x10</span>), <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   s[<span class="number">14</span>] = <span class="string">&quot;4&quot;</span>; <span class="comment">// bits 12-15 of the time_hi_and_version field to 0010</span></span><br><span class="line">   s[<span class="number">19</span>] = hexDigits.<span class="title function_">substr</span>((s[<span class="number">19</span>] &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>, <span class="number">1</span>); <span class="comment">// bits 6-7 of the clock_seq_hi_and_reserved to 01</span></span><br><span class="line">   s[<span class="number">8</span>] = s[<span class="number">13</span>] = s[<span class="number">18</span>] = s[<span class="number">23</span>] = <span class="string">&quot;-&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> uuid = s.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title function_">getImageCode</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="comment">//发送请求到后台获取数据  VerifycodeController</span></span><br><span class="line">   <span class="keyword">let</span> imageCodeKey = <span class="variable language_">sessionStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;registerImageCodeKey&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span>(!imageCodeKey || imageCodeKey === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">      imageCodeKey = <span class="variable language_">this</span>.<span class="title function_">createUuid</span>();</span><br><span class="line">      <span class="variable language_">sessionStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;registerImageCodeKey&quot;</span>,imageCodeKey);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">get</span>(<span class="string">&quot;/verifyCode/image/&quot;</span>+imageCodeKey).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">imageCode</span> = <span class="variable language_">this</span>.<span class="property">imageCodePrefix</span>+res.<span class="property">data</span>;</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3-后台实现"><a href="#5-3-后台实现" class="headerlink" title="5.3. 后台实现"></a>5.3. 后台实现</h4><h5 id="1-图片验证码Controller"><a href="#1-图片验证码Controller" class="headerlink" title="1.图片验证码Controller"></a>1.图片验证码Controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IVerifyCodeService verifyCodeService;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/img/&#123;key&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getImgeCode</span><span class="params">(<span class="meta">@PathVariable(&quot;key&quot;)</span> String key)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64ImageCode</span> <span class="operator">=</span> verifyCodeService.getImageCode(key);</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me().setResult(base64ImageCode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;获取图片验证码失败!&quot;</span>+e.getMessage())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-图片验证码Service"><a href="#2-图片验证码Service" class="headerlink" title="2. 图片验证码Service"></a>2. 图片验证码Service</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VerifyCodeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IVerifyCodeService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getImageCode</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//生成4为验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">verifyCode</span> <span class="operator">=</span> VerifyCodeUtils.generateVerifyCode(<span class="number">4</span>);</span><br><span class="line">        <span class="comment">//验证吗放入redis，并且3分钟过期时间</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;imgVerifyCode_&quot;</span>+key,verifyCode,<span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//把验证码合成图片并加密为base64数据进行返回</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Data</span> <span class="operator">=</span> VerifyCodeUtils.VerifyCode(<span class="number">100</span>,<span class="number">20</span>,verifyCode);</span><br><span class="line">        <span class="keyword">return</span> base64Data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四-短信验证码设计-实现"><a href="#四-短信验证码设计-实现" class="headerlink" title="四.短信验证码设计&amp;实现"></a>四.短信验证码设计&amp;实现</h2><h3 id="1-短信验证码方案思考"><a href="#1-短信验证码方案思考" class="headerlink" title="1.短信验证码方案思考"></a>1.短信验证码方案思考</h3><p>​ 1.短信验证码的大致流程？</p><p>​ 2.按钮倒计时效果如何实现？</p><p>​ 3.短信验证码后台如何存储？Redis</p><p>​ 4.如果使用Redis存储,Redis的key如何创建?不同的页面的短信验证码的key不能覆盖</p><h3 id="2-短信验证码流程"><a href="#2-短信验证码流程" class="headerlink" title="2.短信验证码流程"></a>2.短信验证码流程</h3><p><img src="/breeze/ea1d6962/image-20211026104824452.png" alt="image-20211026104824452"></p><p>我们约定：</p><pre><code>  	验证码有效时间：3分钟
 
  	重发时间：1分钟
</code></pre><p>当前时间 验证码 过期时间</p><pre><code>  15    9727   18
  
  16    ？？？用原来还是新的
</code></pre><p>原来验证码还有效，方案设计</p><pre><code>   方案1：每次都是新的
   
        	15    9727   18  后到
   
           16    8848   19  先到
</code></pre><p>​ 真正存放8848，但是用户最后收到是9727。在每条短信后面加发送时间，由用户自行判断选择。</p><pre><code>   方案2：用没有过期那个 **采纳**
   
             15    9727   18  后到
   
           16    9727   19  先到
   
   方案3：两个都能用-可以但是存放数据变多
</code></pre><p>实现流程详解：</p><ol><li>前台发起验证码发送申请(Ajax)，并且按钮倒计时、禁用</li><li>后台接收到请求，判断图片验证码是否合法</li><li>判断上一次是否有一个未使用的有效验证码</li><li>如果有，并且过了重发时间(两次发送时间大于60S)使用上一次有效验证码</li><li>如果没有，创建一个新的短信验证码</li><li>把短信验证码存储到Redis,格式如： SMS:18244229575&#x3D;{code:”1234” , sendTime: “mills”}</li><li>调用第三方短信网关发送短信验证码</li><li>DB存储验证码发送记录作为结算依据</li></ol><h3 id="3-技术准备"><a href="#3-技术准备" class="headerlink" title="3.技术准备"></a>3.技术准备</h3><h4 id="3-1-随机数"><a href="#3-1-随机数" class="headerlink" title="3.1 随机数"></a>3.1 随机数</h4><p><img src="/breeze/ea1d6962/image-20220915105848348.png" alt="image-20220915105848348"></p><h4 id="3-2-redis-spring-data-redis"><a href="#3-2-redis-spring-data-redis" class="headerlink" title="3.2 redis-spring data redis"></a>3.2 redis-spring data redis</h4><p>​ redisTemplate</p><h4 id="3-3-短信接口"><a href="#3-3-短信接口" class="headerlink" title="3.3.短信接口"></a>3.3.短信接口</h4><p>​ 短信验证，只有三大运营商具有短信发送的能力。要发送短信只有找三大运营，或者<strong>中间商</strong>。简单说就是要找第三方的短信平台。常见的有阿里云，京东智联云，乐讯通等等非常多.我们项目中使用网建短信通：<a target="_blank" rel="noopener" href="http://sms.webchinese.com.cn/Rates.shtml">http://sms.webchinese.com.cn/Rates.shtml</a></p><p>​ 注册以后查看API接口</p><p><img src="/breeze/ea1d6962/image-20211026102351685.png" alt="image-20211026102351685"></p><p>下载官方案例：</p><p><img src="/breeze/ea1d6962/image-20211026102443665.png" alt="image-20211026102443665"></p><p><img src="/breeze/ea1d6962/image-20211026102523675.png" alt="image-20211026102523675"></p><p>设置签名</p><p><img src="/breeze/ea1d6962/image-20211026102605379.png" alt="image-20211026102605379"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-httpclient/commons-httpclient --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-httpclient<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信常量类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsContants</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UID</span> <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">    <span class="comment">//秘钥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">&quot;yyyy&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建议自己从官网copy</span></span><br><span class="line"><span class="keyword">package</span> cn.ronghuanet.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.httpclient.Header;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.httpclient.HttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.httpclient.NameValuePair;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.httpclient.methods.PostMethod;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 短信发送工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送短信</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phones 手机们 a,b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 发送内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String  <span class="title function_">sendSms</span><span class="params">(String phones,String content)</span>&#123;</span><br><span class="line">        <span class="type">PostMethod</span> <span class="variable">post</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>();</span><br><span class="line">            post = <span class="keyword">new</span> <span class="title class_">PostMethod</span>(<span class="string">&quot;http://utf8.api.smschinese.cn&quot;</span>);</span><br><span class="line">            post.addRequestHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;application/x-www-form-urlencoded;charset=utf8&quot;</span>);<span class="comment">//在头文件中设置转码</span></span><br><span class="line">            NameValuePair[] data =&#123; <span class="keyword">new</span> <span class="title class_">NameValuePair</span>(<span class="string">&quot;Uid&quot;</span>, SmsContants.UID),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NameValuePair</span>(<span class="string">&quot;Key&quot;</span>, SmsContants.KEY),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NameValuePair</span>(<span class="string">&quot;smsMob&quot;</span>,phones),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">NameValuePair</span>(<span class="string">&quot;smsText&quot;</span>,content)&#125;;</span><br><span class="line">            post.setRequestBody(data);</span><br><span class="line"></span><br><span class="line">            client.executeMethod(post);</span><br><span class="line">            <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> post.getStatusCode();</span><br><span class="line">            System.out.println(<span class="string">&quot;statusCode:&quot;</span>+statusCode); <span class="comment">//200 404 400</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(post.getResponseBodyAsString().getBytes(<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (post != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                post.releaseConnection();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(SmsUtil</span><br><span class="line">                .sendSms(<span class="string">&quot;13330964748&quot;</span>, <span class="string">&quot;您的验证码为：8848&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-发送短信验证码前台"><a href="#4-发送短信验证码前台" class="headerlink" title="4.发送短信验证码前台"></a>4.发送短信验证码前台</h3><p>按钮倒计时分析</p><p>​	1) 点击按钮，判断手机号，图片验证码不可为空</p><p>​	2) 禁用按钮</p><p>​	3) 发送Ajax请求发送短信 ：参数？手机号，图片验证码的值，图片验证码的key</p><p>​	4) 如果发送成功</p><p>​ a. 给出提示</p><p>​ b. 进入倒计时</p><p>​ c. 倒计时完成：重置按钮，清除倒计时</p><p>​	5) 如果发送失败</p><p>​ a. 给出提示</p><p>​ b. 重置按钮</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">sendMsg</span>(<span class="params">event</span>)&#123;</span><br><span class="line">        <span class="comment">//1.判断手机号不为空</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">formParams</span>.<span class="property">phone</span>)&#123;</span><br><span class="line">          <span class="title function_">alert</span>(<span class="string">&quot;手机号不能为空&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.判断图片验证码不为空</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">formParams</span>.<span class="property">imageCode</span>)&#123;</span><br><span class="line">          <span class="title function_">alert</span>(<span class="string">&quot;图片验证码不能为空&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.获取按钮，禁用按钮</span></span><br><span class="line">        <span class="keyword">var</span> sendBtn = $(event.<span class="property">currentTarget</span>);</span><br><span class="line">        sendBtn.<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> param = &#123;</span><br><span class="line">          <span class="attr">phone</span>: <span class="variable language_">this</span>.<span class="property">formParams</span>.<span class="property">phone</span>,</span><br><span class="line">          <span class="attr">imageCode</span>:<span class="variable language_">this</span>.<span class="property">formParams</span>.<span class="property">imageCode</span>,</span><br><span class="line">          <span class="attr">imageCodeKey</span>:<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;registerImageCodeKey&quot;</span>)  <span class="comment">//&quot;reg_xxxx&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//4.发送ajax请求</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">post</span>(<span class="string">&quot;/verifyCode/sms/register&quot;</span>,param).<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">          <span class="keyword">var</span> ajaxResult = res.<span class="property">data</span>;</span><br><span class="line">          <span class="keyword">if</span>(ajaxResult.<span class="property">success</span>)&#123;</span><br><span class="line">            <span class="title function_">alert</span>(<span class="string">&quot;手机验证码已经发送到您的手机，请在5分钟内使用&quot;</span>);</span><br><span class="line">            <span class="comment">//4.1.发送成：倒计时</span></span><br><span class="line">            <span class="keyword">var</span> time = <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> interval = <span class="variable language_">window</span>.<span class="built_in">setInterval</span>( <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">              <span class="comment">//每一条倒计时减一</span></span><br><span class="line">              time = time - <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">              <span class="comment">//把倒计时时间搞到按钮上</span></span><br><span class="line">              sendBtn.<span class="title function_">text</span>(time+<span class="string">&quot;秒后重发&quot;</span>);</span><br><span class="line"></span><br><span class="line">              <span class="comment">//4.2.倒计时完成恢复按钮</span></span><br><span class="line">              <span class="keyword">if</span>(time &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                sendBtn.<span class="title function_">text</span>(<span class="string">&quot;重新发送&quot;</span>);</span><br><span class="line">                sendBtn.<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">                <span class="comment">//清除定时器</span></span><br><span class="line">                <span class="variable language_">window</span>.<span class="built_in">clearInterval</span>(interval);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,<span class="number">1000</span>);</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//4.3.发送失败：提示，恢复按钮</span></span><br><span class="line">            sendBtn.<span class="title function_">attr</span>(<span class="string">&quot;disabled&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">            <span class="title function_">alert</span>(<span class="string">&quot;发送失败:&quot;</span>+ajaxResult.<span class="property">msg</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><h3 id="5-发送短信验证码后台"><a href="#5-发送短信验证码后台" class="headerlink" title="5.发送短信验证码后台"></a>5.发送短信验证码后台</h3><h4 id="4-1-后台设计"><a href="#4-1-后台设计" class="headerlink" title="4.1.后台设计"></a>4.1.后台设计</h4><p><img src="/breeze/ea1d6962/image-20211026105544224.png" alt="image-20211026105544224"></p><h4 id="4-2-后台实现"><a href="#4-2-后台实现" class="headerlink" title="4.2.后台实现"></a>4.2.后台实现</h4><h5 id="1-发送短信验证码controller"><a href="#1-发送短信验证码controller" class="headerlink" title="1.发送短信验证码controller"></a>1.发送短信验证码controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送注册短信验证码</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/sms/register&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> AjaxResult <span class="title function_">sendSmsCodeRegister</span><span class="params">(<span class="meta">@RequestBody</span> SmsCodeDto smsCodeDto)</span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> verifyCodeService.sendSmsCodeRegister(smsCodeDto);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">           <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;发送注册短信验证码失败!&quot;</span>+e.getMessage());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h5 id="2-发送短信验证码service"><a href="#2-发送短信验证码service" class="headerlink" title="2.发送短信验证码service"></a>2.发送短信验证码service</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogininfoMapper logininfoMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">sendSmsCodeRegister</span><span class="params">(SmsCodeDto smsCodeDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> smsCodeDto.getMobile();</span><br><span class="line">        <span class="type">String</span> <span class="variable">imageCodekey</span> <span class="operator">=</span> smsCodeDto.getImageCodeKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">imageCode</span> <span class="operator">=</span> smsCodeDto.getImageCode();</span><br><span class="line">        <span class="comment">//1 校验</span></span><br><span class="line">        <span class="comment">//1.0 空判断</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(mobile)||StringUtils.isEmpty(imageCodekey)||StringUtils.isEmpty(imageCode))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;非法请求，参数异常！&quot;</span>);</span><br><span class="line">        <span class="comment">//1.1 判断图片验证码是否正确</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">imageCodeOfRedis</span> <span class="operator">=</span> (String) redisTemplate.opsForValue()</span><br><span class="line">                .get(<span class="string">&quot;imgVerifyCode_&quot;</span>+imageCodekey);</span><br><span class="line">        <span class="keyword">if</span> (!imageCode.trim().equalsIgnoreCase(imageCodeOfRedis))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;请输入正确图片验证码！&quot;</span>);</span><br><span class="line">        <span class="comment">//1.2 判断手机号是否已经被注册</span></span><br><span class="line">        <span class="type">Logininfo</span> <span class="variable">logininfo</span> <span class="operator">=</span> logininfoMapper.loadUserByMobile(mobile);</span><br><span class="line">        <span class="keyword">if</span>(logininfo!=<span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;该手机号已经被注册！请登录后使用！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 判断原来的验证码是否存在</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span><span class="string">&quot;register_sms_code_&quot;</span> + mobile;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">smsCodeOfRedis</span> <span class="operator">=</span> (String) redisTemplate.opsForValue()</span><br><span class="line">                .get(key);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(smsCodeOfRedis)) &#123;</span><br><span class="line">            <span class="comment">//2.1 如果不存在就产生新的</span></span><br><span class="line">            code = StrUtils.getRandomString(<span class="number">6</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//2.2 如果存在，判断是否已过重发时间，如果没有过报错，过了直接原来的</span></span><br><span class="line">            code = smsCodeOfRedis.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>];              <span class="comment">//code:time</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">time</span> <span class="operator">=</span> smsCodeOfRedis.split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>];              <span class="comment">//code:time</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis()-<span class="keyword">new</span> <span class="title class_">Date</span>(Long.valueOf(time)).getTime() &lt;= <span class="number">60</span>*<span class="number">1000</span>*resendTime)  <span class="comment">//60*1000</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;非法请求，请勿乱搞！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 记录验证码到redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(key,code+<span class="string">&quot;:&quot;</span>+System.currentTimeMillis(),expireTime, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 调用短信接口进行发送</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> String.format(<span class="string">&quot;你的验证码为%s,请在%s分钟之内使用！&quot;</span>, code, expireTime);</span><br><span class="line">        <span class="comment">//SmsUtil.sendSms(mobile,content);</span></span><br><span class="line">        System.out.println(<span class="string">&quot;已经成功发送了一条短信,内容为&quot;</span>+content);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5 记录发送记录 @TODO</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="3-yml配置"><a href="#3-yml配置" class="headerlink" title="3.yml配置"></a>3.yml配置</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sms:</span></span><br><span class="line">  <span class="attr">code:</span></span><br><span class="line">    <span class="attr">register:</span></span><br><span class="line">      <span class="attr">resend-time:</span> <span class="number">1</span> <span class="comment">#单位分</span></span><br><span class="line">      <span class="attr">expire-time:</span> <span class="number">5</span> <span class="comment">#单位分</span></span><br></pre></td></tr></table></figure><h2 id="五-完成注册功能"><a href="#五-完成注册功能" class="headerlink" title="五.完成注册功能"></a>五.完成注册功能</h2><h3 id="1-Md5技术"><a href="#1-Md5技术" class="headerlink" title="1.Md5技术"></a>1.Md5技术</h3><p>​	1 不可逆加密技术，只能加密不能解密。 只能做比对，一般用来加密用户登录密码。</p><p>​ 我们要做的是把传入进行加密和数据库查询出来密文进行比对判断密码是否正确。</p><p>​	2 盐值：同一种加密算法，由于不同的盐值，加密出来就不一样。</p><p>​ 1）整个系统使用同一个盐值，多个用户共用-定义一个常量</p><p>​ 2）每个用户都有自己盐值，就算是相同的密码，两个用用户加密出来也不一样。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.ronghuanet.basic.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MD5Utils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encrypByMd5</span><span class="params">(String context)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">            md.update(context.getBytes());<span class="comment">//update处理  </span></span><br><span class="line">            <span class="type">byte</span> [] encryContext = md.digest();<span class="comment">//调用该方法完成计算  </span></span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> i;  </span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>; offset &lt; encryContext.length; offset++) &#123;<span class="comment">//做相应的转化（十六进制）  </span></span><br><span class="line">                i = encryContext[offset];  </span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">0</span>) i += <span class="number">256</span>;  </span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">16</span>) buf.append(<span class="string">&quot;0&quot;</span>);  </span><br><span class="line">                buf.append(Integer.toHexString(i));  </span><br><span class="line">           &#125;  </span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block  </span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span>  <span class="literal">null</span>;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    <span class="comment">//1 生成随机盐值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pwd</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> StrUtils.getComplexRandomString(<span class="number">32</span>);</span><br><span class="line">    <span class="comment">//2 通过这个盐值加密</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">md5Pwd</span> <span class="operator">=</span> MD5Utils.encrypByMd5(pwd +<span class="string">&quot;yhp&quot;</span>+ salt+<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    System.out.println(md5Pwd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码比对</span></span><br><span class="line">    <span class="comment">//1 查询盐值-就是salt</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">saltTmp</span> <span class="operator">=</span> salt;</span><br><span class="line">    <span class="comment">//3 加密比对</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pwdTmp</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">inputMd5Pwd</span> <span class="operator">=</span> MD5Utils.encrypByMd5(pwdTmp +<span class="string">&quot;yhp&quot;</span>+ saltTmp+<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (inputMd5Pwd.equals(md5Pwd))&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;登录成功!&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><a href="#" class="headerlink"></a></h4><p>跳转到注册页面index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;am-btn-warning btn&quot;</span> <span class="attr">href</span>=<span class="string">&quot;register.html&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-前台提交数据"><a href="#2-前台提交数据" class="headerlink" title="2.前台提交数据"></a>2.前台提交数据</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">register</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">//空校验略过</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">post</span>(<span class="string">&quot;/user/register/phone&quot;</span>,<span class="variable language_">this</span>.<span class="property">formParams</span>)</span><br><span class="line">                .<span class="title function_">then</span>(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span><br><span class="line">                    result = result.<span class="property">data</span>;</span><br><span class="line">                    <span class="keyword">if</span> (result.<span class="property">success</span>)</span><br><span class="line">                        <span class="title function_">alert</span>(<span class="string">&quot;注册成功！请登录&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="title function_">alert</span>(<span class="string">&quot;注册失败&quot;</span>+result.<span class="property">message</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_">catch</span>(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span><br><span class="line">                    <span class="title function_">alert</span>(<span class="string">&quot;系统异常&quot;</span>)</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure><h3 id="3-后台数据处理"><a href="#3-后台数据处理" class="headerlink" title="3.后台数据处理"></a>3.后台数据处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneRegisterDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    <span class="keyword">private</span> String smsCode;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String confirmPassword;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//电话注册</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register/phone&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">registerPhone</span><span class="params">(<span class="meta">@RequestBody</span> PhoneRegisterDto phoneRegisterDto)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> userService.registerPhone(phoneRegisterDto);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;注册失败！&quot;</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BaseServiceImpl</span>&lt;User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogininfoMapper logininfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">registerPhone</span><span class="params">(PhoneRegisterDto phoneRegisterDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> phoneRegisterDto.getMobile();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> phoneRegisterDto.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> phoneRegisterDto.getPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">confirmPassword</span> <span class="operator">=</span> phoneRegisterDto.getConfirmPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">smsCode</span> <span class="operator">=</span> phoneRegisterDto.getSmsCode();</span><br><span class="line">        <span class="comment">//1 校验</span></span><br><span class="line">        <span class="comment">//1.1 null检验</span></span><br><span class="line">        <span class="comment">//1.2 密码与确认密码校验</span></span><br><span class="line">        <span class="keyword">if</span> (!password.trim().equals(confirmPassword.trim()))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;两次密码不一致！&quot;</span>);</span><br><span class="line">        <span class="comment">//1.3 短信验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span><span class="string">&quot;register_sms_code_&quot;</span> + mobile;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">smsCodeOfRedis</span> <span class="operator">=</span> (String) redisTemplate.opsForValue() <span class="comment">//code:time</span></span><br><span class="line">                .get(key);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(smsCodeOfRedis)||</span><br><span class="line">                !smsCodeOfRedis.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>].equals(smsCode))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;短信验证码过期或者错误！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.4 用户是否存在（用户名）</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userByDb</span> <span class="operator">=</span> userMapper.loadByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (userByDb!=<span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;该用户名对应的用户已经存在，不能注册！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 保存登录信息</span></span><br><span class="line">        <span class="type">Logininfo</span> <span class="variable">logininfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Logininfo</span>();</span><br><span class="line">        logininfo.setUsername(username);</span><br><span class="line">        logininfo.setPhone(mobile);</span><br><span class="line">        <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> StrUtils.getComplexRandomString(<span class="number">32</span>);</span><br><span class="line">        salt = <span class="string">&quot;yaosang&quot;</span> + salt + <span class="string">&quot;jfjfjfjfj&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">securityPwd</span> <span class="operator">=</span> MD5Utils.encrypByMd5(password + salt);</span><br><span class="line">        logininfo.setSalt(salt);</span><br><span class="line">        logininfo.setPassword(securityPwd);</span><br><span class="line"></span><br><span class="line">        logininfo.setType(Logininfo.LOGININFO_TYPE_USER);</span><br><span class="line">        logininfo.setDisable(<span class="number">1</span>);</span><br><span class="line">        logininfoMapper.save(logininfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 保存用户信息</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        BeanUtils.copyProperties(logininfo,user);</span><br><span class="line">        user.setId(<span class="literal">null</span>);</span><br><span class="line">        user.setCreatetime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        user.setLogininfoId(logininfo.getId());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 已注册0 已激活2 禁用-1</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        user.setState(<span class="number">2</span>);</span><br><span class="line">        userMapper.save(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 发通知-短信，邮件通知</span></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-同步修改登录信息（自研）"><a href="#3-同步修改登录信息（自研）" class="headerlink" title="3.同步修改登录信息（自研）"></a>3.同步修改登录信息（自研）</h3><p>​ 前面分析表的时候说过：在employee或user操作时涉及到登录信息都要同步操作logininfo</p><p>所以我们需要在UserServiceImpl和EmployeeServiceImpl中复写add、update、delete等相关方法。在操作employee或user表时涉及到登录信息都要同步操作logininfo。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ronghuanet.org.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.basic.util.MD5Utils;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.basic.util.StrUtils;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.org.domain.Employee;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.org.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.org.service.IEmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.basic.service.impl.BaseServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.domain.Logininfo;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.mapper.LogininfoMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  服务实现类</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yaosang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-09-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BaseServiceImpl</span>&lt;Employee&gt; <span class="keyword">implements</span> <span class="title class_">IEmployeeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//做增删改的时候不仅要操作本表，还要操作logininfo的表</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogininfoMapper logininfoMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(Employee employee)</span> &#123;</span><br><span class="line">        <span class="type">Logininfo</span> <span class="variable">logininfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Logininfo</span>();</span><br><span class="line">        logininfo.setUsername(employee.getUsername());</span><br><span class="line">        logininfo.setPhone(employee.getPhone());</span><br><span class="line">        <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> StrUtils.getComplexRandomString(<span class="number">32</span>);</span><br><span class="line">        salt = <span class="string">&quot;yaosang&quot;</span> + salt + <span class="string">&quot;jfjfjfjfj&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">securityPwd</span> <span class="operator">=</span> MD5Utils.encrypByMd5(employee.getPassword() + salt);</span><br><span class="line">        logininfo.setSalt(salt);</span><br><span class="line">        logininfo.setPassword(securityPwd);</span><br><span class="line"></span><br><span class="line">        logininfo.setType(Logininfo.LOGININFO_TYPE_ADMIN);</span><br><span class="line">        logininfo.setDisable(<span class="number">1</span>);</span><br><span class="line">        logininfoMapper.save(logininfo);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//要保存登录信息id，还要把密码加密处理</span></span><br><span class="line">        employee.setLogininfoId(logininfo.getId());</span><br><span class="line">        employee.setSalt(salt);</span><br><span class="line">        employee.setPassword(securityPwd);</span><br><span class="line">        employeeMapper.save(employee);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(Serializable id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.loadById(id);</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">logininfoId</span> <span class="operator">=</span> employee.getLogininfoId();</span><br><span class="line"></span><br><span class="line">        logininfoMapper.remove(logininfoId);</span><br><span class="line">        employeeMapper.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.update(employee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="六-注册通知"><a href="#六-注册通知" class="headerlink" title="六.注册通知"></a>六.注册通知</h2><h2 id="一-需求"><a href="#一-需求" class="headerlink" title="一  需求"></a>一 需求</h2><p>​	注册完成后，给用户发送短信、邮件等信息，告知用户已经注册，可以使用！可以发一下，赠送连接让他操作。</p><h2 id="二-设计"><a href="#二-设计" class="headerlink" title="二  设计"></a>二 设计</h2><h3 id="1-方案1：同步执行"><a href="#1-方案1：同步执行" class="headerlink" title="1 方案1：同步执行"></a>1 方案1：同步执行</h3><p><img src="/breeze/ea1d6962/image-20220916094035054.png" alt="image-20220916094035054"></p><h3 id="2-方案2：-异步执行"><a href="#2-方案2：-异步执行" class="headerlink" title="2 方案2： 异步执行"></a>2 方案2： 异步执行</h3><p><img src="/breeze/ea1d6962/image-20220916094559570.png" alt="image-20220916094559570"></p><h3 id="3-方案3：-消息队列-采纳"><a href="#3-方案3：-消息队列-采纳" class="headerlink" title="3 方案3： 消息队列-采纳"></a>3 方案3： 消息队列-采纳</h3><p><img src="/breeze/ea1d6962/image-20220916094949170.png" alt="image-20220916094949170"></p><h2 id="三-实现"><a href="#三-实现" class="headerlink" title="三 实现"></a>三 实现</h2><h3 id="1-导入jar"><a href="#1-导入jar" class="headerlink" title="1 导入jar"></a>1 导入jar</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spirngboot集成rabbitmq--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-做配置"><a href="#2-做配置" class="headerlink" title="2 做配置"></a>2 做配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtualHost:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure><h3 id="3-发送消息"><a href="#3-发送消息" class="headerlink" title="3 发送消息"></a>3 发送消息</h3><p><strong>交换机配置类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ronghuanet.user.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterNoticeRabbitmqConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_INFORM_EMAIL</span> <span class="operator">=</span> <span class="string">&quot;queue_inform_email_register&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_INFORM_SMS</span> <span class="operator">=</span> <span class="string">&quot;queue_inform_sms_register&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_TOPICS_INFORM</span> <span class="operator">=</span> <span class="string">&quot;exchange_topics_inform_register&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机配置</span></span><br><span class="line"><span class="comment">     * ExchangeBuilder提供了fanout、direct、topic、header交换机类型的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the exchange</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(EXCHANGE_TOPICS_INFORM)</span>  <span class="comment">//bead的名称和交换机名字一直</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">EXCHANGE_TOPICS_INFORM</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//durable(true)持久化，消息队列重启后交换机仍然存在</span></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(EXCHANGE_TOPICS_INFORM).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明队列</span></span><br><span class="line">    <span class="meta">@Bean(QUEUE_INFORM_SMS)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">QUEUE_INFORM_SMS</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE_INFORM_SMS,<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明队列</span></span><br><span class="line">    <span class="meta">@Bean(QUEUE_INFORM_EMAIL)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">QUEUE_INFORM_EMAIL</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE_INFORM_EMAIL,<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * channel.queueBind(INFORM_QUEUE_SMS,&quot;inform_exchange_topic&quot;,&quot;inform.#.sms.#&quot;);</span></span><br><span class="line"><span class="comment">     * 绑定队列到交换机 .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue    the queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange the exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">BINDING_QUEUE_INFORM_SMS</span><span class="params">(<span class="meta">@Qualifier(QUEUE_INFORM_SMS)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@Qualifier(EXCHANGE_TOPICS_INFORM)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;inform.#.sms.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">BINDING_QUEUE_INFORM_EMAIL</span><span class="params">(<span class="meta">@Qualifier(QUEUE_INFORM_EMAIL)</span> Queue queue,</span></span><br><span class="line"><span class="params">                                              <span class="meta">@Qualifier(EXCHANGE_TOPICS_INFORM)</span> Exchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;inform.#.email.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>RabbitMQ配置类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ronghuanet.user.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListenerConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.RabbitListenerEndpointRegistrar;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.converter.MappingJackson2MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.handler.annotation.support.DefaultMessageHandlerMethodFactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConverterConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitListenerConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下配置RabbitMQ消息服务</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultMessageHandlerMethodFactory <span class="title function_">myHandlerMethodFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMessageHandlerMethodFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMessageHandlerMethodFactory</span>();</span><br><span class="line">        <span class="comment">// 这里的转换器设置实现了 通过 @Payload 注解 自动反序列化message body</span></span><br><span class="line">        factory.setMessageConverter(<span class="keyword">new</span> <span class="title class_">MappingJackson2MessageConverter</span>());</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureRabbitListeners</span><span class="params">(RabbitListenerEndpointRegistrar registrar)</span> &#123;</span><br><span class="line">        registrar.setMessageHandlerMethodFactory(myHandlerMethodFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SimpleRabbitListenerContainerFactory <span class="title function_">rabbitListenerContainerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SimpleRabbitListenerContainerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRabbitListenerContainerFactory</span>();</span><br><span class="line">        factory.setConnectionFactory(connectionFactory);</span><br><span class="line">        factory.setConcurrentConsumers(<span class="number">3</span>);</span><br><span class="line">        factory.setMaxConcurrentConsumers(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTemplate <span class="title function_">rabbitTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>(connectionFactory);</span><br><span class="line">        <span class="comment">// 这里的转换器设置实现了发送消息时自动序列化消息对象为message body</span></span><br><span class="line">        template.setMessageConverter(jsonMessageConverter());</span><br><span class="line">        template.setMandatory(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterNoticeDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String receiver; <span class="comment">//收件人  手机或者邮箱</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> AjaxResult <span class="title function_">registerPhone</span><span class="params">(PhoneRegisterDto phoneRegisterDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mobile</span> <span class="operator">=</span> phoneRegisterDto.getMobile();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> phoneRegisterDto.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> phoneRegisterDto.getPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">confirmPassword</span> <span class="operator">=</span> phoneRegisterDto.getConfirmPassword();</span><br><span class="line">        <span class="type">String</span> <span class="variable">smsCode</span> <span class="operator">=</span> phoneRegisterDto.getSmsCode();</span><br><span class="line">        <span class="comment">//1 校验</span></span><br><span class="line">        <span class="comment">//1.1 null检验</span></span><br><span class="line">        <span class="comment">//1.2 密码与确认密码校验</span></span><br><span class="line">        <span class="keyword">if</span> (!password.trim().equals(confirmPassword.trim()))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;两次密码不一致！&quot;</span>);</span><br><span class="line">        <span class="comment">//1.3 短信验证码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span><span class="string">&quot;register_sms_code_&quot;</span> + mobile;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">smsCodeOfRedis</span> <span class="operator">=</span> (String) redisTemplate.opsForValue() <span class="comment">//code:time</span></span><br><span class="line">                .get(key);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(smsCodeOfRedis)||</span><br><span class="line">                !smsCodeOfRedis.split(<span class="string">&quot;:&quot;</span>)[<span class="number">0</span>].equals(smsCode))</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;短信验证码过期或者错误！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.4 用户是否存在（用户名）</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">userByDb</span> <span class="operator">=</span> userMapper.loadByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (userByDb!=<span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> AjaxResult.me().setSuccess(<span class="literal">false</span>).setMessage(<span class="string">&quot;该用户名对应的用户已经存在，不能注册！&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 保存登录信息</span></span><br><span class="line">        <span class="type">Logininfo</span> <span class="variable">logininfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Logininfo</span>();</span><br><span class="line">        logininfo.setUsername(username);</span><br><span class="line">        logininfo.setPhone(mobile);</span><br><span class="line">        <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> StrUtils.getComplexRandomString(<span class="number">32</span>);</span><br><span class="line">        salt = <span class="string">&quot;yaosang&quot;</span> + salt + <span class="string">&quot;jfjfjfjfj&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">securityPwd</span> <span class="operator">=</span> MD5Utils.encrypByMd5(password + salt);</span><br><span class="line">        logininfo.setSalt(salt);</span><br><span class="line">        logininfo.setPassword(securityPwd);</span><br><span class="line"></span><br><span class="line">        logininfo.setType(Logininfo.LOGININFO_TYPE_USER);</span><br><span class="line">        logininfo.setDisable(<span class="number">1</span>);</span><br><span class="line">        logininfoMapper.save(logininfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 保存用户信息</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        BeanUtils.copyProperties(logininfo,user);</span><br><span class="line">        user.setId(<span class="literal">null</span>);</span><br><span class="line">        user.setCreatetime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        user.setLogininfoId(logininfo.getId());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 已注册0 已激活2 禁用-1</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        user.setState(<span class="number">2</span>);</span><br><span class="line">        userMapper.save(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 发通知-短信，邮件通知</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RegisterNoticeRabbitmqConfig.EXCHANGE_TOPICS_INFORM,</span><br><span class="line">                <span class="string">&quot;inform.sms&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">RegisterNoticeDto</span>(mobile,<span class="string">&quot;收到短信通知：你好！你注册的账号已经完成，可以正常使用了！&quot;</span>));  <span class="comment">//收件人（phone） 消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RegisterNoticeRabbitmqConfig.EXCHANGE_TOPICS_INFORM,</span><br><span class="line">                <span class="string">&quot;inform.email&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">RegisterNoticeDto</span>(mobile,<span class="string">&quot;收到邮件通知：你好！你注册的账号已经完成，可以正常使用了！&quot;</span>));  <span class="comment">//收件人（email） 消息内容</span></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.me();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="4-接收消息"><a href="#4-接收消息" class="headerlink" title="4 接收消息"></a>4 接收消息</h3><p><strong>使用Email</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ronghuanet.user.rabbitmq.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.config.RegisterNoticeRabbitmqConfig;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.dto.RegisterNoticeDto;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterNoticeEmailReceiveHandler</span> &#123;</span><br><span class="line">    <span class="comment">//监听email队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;RegisterNoticeRabbitmqConfig.QUEUE_INFORM_EMAIL&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive_email</span><span class="params">(RegisterNoticeDto registerNoticeDto, Message message, Channel channel)</span> &#123;</span><br><span class="line">        System.out.println(registerNoticeDto.getReceiver());</span><br><span class="line">        System.out.println(registerNoticeDto.getContent());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//就可以使用email技术进行发送 @TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>使用短信</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ronghuanet.user.rabbitmq.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.config.RegisterNoticeRabbitmqConfig;</span><br><span class="line"><span class="keyword">import</span> com.ronghuanet.user.dto.RegisterNoticeDto;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterNoticeSmsReceiveHandler</span> &#123;</span><br><span class="line">    <span class="comment">//监听email队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;RegisterNoticeRabbitmqConfig.QUEUE_INFORM_SMS&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive_email</span><span class="params">(RegisterNoticeDto registerNoticeDto, Message message, Channel channel)</span> &#123;</span><br><span class="line">        System.out.println(registerNoticeDto.getReceiver());</span><br><span class="line">        System.out.println(registerNoticeDto.getContent());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//就可以使用短信技术进行发送 @TODO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四总结"><a href="#四总结" class="headerlink" title="四总结"></a>四总结</h2><p><img src="/breeze/ea1d6962/image-20231120205957770.png" alt="image-20231120205957770"></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/ea1d6962.html">https://mliutm.github.io/breeze/ea1d6962.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1653549892896-dde02867edee.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/df114463.html" title="蓉车宝-用户模块-账号登录（十一）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">蓉车宝-用户模块-账号登录（十一）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/8e2f6954.html" title="蓉车宝-车辆详情（九）"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">蓉车宝-车辆详情（九）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/ecebeadb.html" title="BIO-NIO-AIO深入剖析"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">BIO-NIO-AIO深入剖析</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/ab319c68.html" title="SpringCloud-Alibaba快速入门"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">SpringCloud-Alibaba快速入门</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%89%E8%BD%A6%E5%AE%9D-%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97-%E6%B3%A8%E5%86%8C"><span class="toc-text">蓉车宝-用户模块-注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-text">内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">一.用户模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD%E7%82%B9%E5%88%86%E6%9E%90"><span class="toc-text">1.功能点分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%A1%A8%E5%88%86%E6%9E%90"><span class="toc-text">2.表分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%B3%A8%E5%86%8C%E5%88%86%E6%9E%90%E4%B8%8E%E8%AE%BE%E8%AE%A1"><span class="toc-text">二.注册分析与设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%86%E6%9E%90%E9%9C%80%E6%B1%82"><span class="toc-text">1.分析需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AE%BE%E8%AE%A1"><span class="toc-text">2.设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1%E4%B8%89%E8%8C%83%E5%BC%8F"><span class="toc-text">2.1.数据库表设计三范式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-text">2.2. 表设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B3%A8%E5%86%8C%E4%B8%BB%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">2.3.注册主流程设计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AE%BE%E8%AE%A1-%E5%AE%9E%E7%8E%B0"><span class="toc-text">三.图片验证码设计&amp;实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9D%9E%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%A1%B9%E7%9B%AE%E9%AA%8C%E8%AF%81%E7%A0%81%E6%96%B9%E6%A1%88"><span class="toc-text">1.非前后端分离项目验证码方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E9%AA%8C%E8%AF%81%E7%A0%81%E6%96%B9%E6%A1%88"><span class="toc-text">2.前后端分离验证码方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-text">3.图片验证码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF%E5%87%86%E5%A4%87"><span class="toc-text">4.相关技术准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%9A%8F%E6%9C%BA%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">4.1.随机字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E7%94%BB%E5%9B%BE%E5%BD%A2%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">4.2.画图形验证码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-Redis"><span class="toc-text">4.3.Redis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.图片验证码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E6%90%AD%E5%BB%BA%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="toc-text">5.1.搭建用户模块</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-User-loginInfo"><span class="toc-text">1. User loginInfo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AEyml"><span class="toc-text">2.配置yml</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E5%89%8D%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.2.前台实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E5%90%8E%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.3. 后台实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81Controller"><span class="toc-text">1.图片验证码Controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81Service"><span class="toc-text">2. 图片验证码Service</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AE%BE%E8%AE%A1-%E5%AE%9E%E7%8E%B0"><span class="toc-text">四.短信验证码设计&amp;实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E6%96%B9%E6%A1%88%E6%80%9D%E8%80%83"><span class="toc-text">1.短信验证码方案思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-text">2.短信验证码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8A%80%E6%9C%AF%E5%87%86%E5%A4%87"><span class="toc-text">3.技术准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%9A%8F%E6%9C%BA%E6%95%B0"><span class="toc-text">3.1 随机数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-redis-spring-data-redis"><span class="toc-text">3.2 redis-spring data redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E7%9F%AD%E4%BF%A1%E6%8E%A5%E5%8F%A3"><span class="toc-text">3.3.短信接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E5%89%8D%E5%8F%B0"><span class="toc-text">4.发送短信验证码前台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81%E5%90%8E%E5%8F%B0"><span class="toc-text">5.发送短信验证码后台</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1"><span class="toc-text">4.1.后台设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%90%8E%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2.后台实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81controller"><span class="toc-text">1.发送短信验证码controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81service"><span class="toc-text">2.发送短信验证码service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-yml%E9%85%8D%E7%BD%AE"><span class="toc-text">3.yml配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%AE%8C%E6%88%90%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-text">五.完成注册功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Md5%E6%8A%80%E6%9C%AF"><span class="toc-text">1.Md5技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%89%8D%E5%8F%B0%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE"><span class="toc-text">2.前台提交数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%8E%E5%8F%B0%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">3.后台数据处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%8C%E6%AD%A5%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%EF%BC%88%E8%87%AA%E7%A0%94%EF%BC%89"><span class="toc-text">3.同步修改登录信息（自研）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%B3%A8%E5%86%8C%E9%80%9A%E7%9F%A5"><span class="toc-text">六.注册通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E9%9C%80%E6%B1%82"><span class="toc-text">一 需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%AE%BE%E8%AE%A1"><span class="toc-text">二 设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%B9%E6%A1%881%EF%BC%9A%E5%90%8C%E6%AD%A5%E6%89%A7%E8%A1%8C"><span class="toc-text">1 方案1：同步执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%B9%E6%A1%882%EF%BC%9A-%E5%BC%82%E6%AD%A5%E6%89%A7%E8%A1%8C"><span class="toc-text">2 方案2： 异步执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%B9%E6%A1%883%EF%BC%9A-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E9%87%87%E7%BA%B3"><span class="toc-text">3 方案3： 消息队列-采纳</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%AE%9E%E7%8E%B0"><span class="toc-text">三 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5jar"><span class="toc-text">1 导入jar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%81%9A%E9%85%8D%E7%BD%AE"><span class="toc-text">2 做配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text">3 发送消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-text">4 接收消息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E6%80%BB%E7%BB%93"><span class="toc-text">四总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>