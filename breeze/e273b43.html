<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>学成在线-媒资管理模块（三） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第3章媒资管理模块v3.11 模块需求分析1.1 模块介绍媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下： 媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理"><meta property="og:type" content="article"><meta property="og:title" content="学成在线-媒资管理模块（三）"><meta property="og:url" content="https://mliutm.github.io/breeze/e273b43.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="第3章媒资管理模块v3.11 模块需求分析1.1 模块介绍媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下： 媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><meta property="article:published_time" content="2023-10-30T03:30:33.000Z"><meta property="article:modified_time" content="2023-10-31T16:04:06.186Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1653549892896-dde02867edee.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/e273b43.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"学成在线-媒资管理模块（三）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-11-01 00:04:06"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线-媒资管理模块（三）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-30T03:30:33.000Z" title="发表于 2023-10-30 11:30:33">2023-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-31T16:04:06.186Z" title="更新于 2023-11-01 00:04:06">2023-11-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">34.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>133分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="学成在线-媒资管理模块（三）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="第3章媒资管理模块v3-1"><a href="#第3章媒资管理模块v3-1" class="headerlink" title="第3章媒资管理模块v3.1"></a><strong>第3章媒资管理模块v3.1</strong></h2><h3 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1 模块需求分析</strong></h3><h4 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1 模块介绍</strong></h4><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p><p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink">媒体</a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p><p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p><p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p><p>媒资查询：教学机构查询自己所拥有的媒资信息。</p><p>文件上传：包括上传图片、上传文档、上传视频。</p><p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p><p>文件删除：教学机构删除自己上传的媒资文件。</p><p>下图是课程编辑与发布的整体流程，通过下图可以看到媒资管理在整体流程的位置：</p><p><img src="/breeze/e273b43/image1.png"></p><h4 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2 业务流程</strong></h4><h5 id="1-2-1-上传图片"><a href="#1-2-1-上传图片" class="headerlink" title="1.2.1 上传图片"></a><strong>1.2.1 上传图片</strong></h5><p>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统。</p><p>下图是上传图片的界面：</p><p><img src="/breeze/e273b43/image2.png"></p><h5 id="1-2-2-上传视频"><a href="#1-2-2-上传视频" class="headerlink" title="1.2.2 上传视频"></a><strong>1.2.2 上传视频</strong></h5><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p><p>点击“媒资管理”</p><p><img src="/breeze/e273b43/image3.png"></p><p>进入媒资管理列表页面查询本机构上传的媒资文件。</p><p><img src="/breeze/e273b43/image4.png"></p><p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p><p><img src="/breeze/e273b43/image5.png"></p><p>点击“上传视频”打开上传页面</p><p><img src="/breeze/e273b43/image6.png"></p><p>3、选择要上传的文件，自动执行文件上传，视频上传成功会自动处理。</p><p><img src="/breeze/e273b43/image7.png"></p><h5 id="1-2-3-处理视频"><a href="#1-2-3-处理视频" class="headerlink" title="1.2.3 处理视频"></a><strong>1.2.3 处理视频</strong></h5><p>对需要转码处理的视频系统会自动对其处理，处理后生成视频的URL。</p><p>处理视频没有用户界面，完全是后台自动执行。</p><h5 id="1-2-4-审核媒资"><a href="#1-2-4-审核媒资" class="headerlink" title="1.2.4 审核媒资"></a><strong>1.2.4 审核媒资</strong></h5><p>审核媒资包括程序自动审核和人工审核，程序可以通过鉴黄接口(<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)%E5%AE%A1%E6%A0%B8%E8%A7%86%E9%A2%91%EF%BC%8C%E5%AF%B9%E6%9C%89%E5%BC%82%E8%AE%AE%E7%9A%84%E8%A7%86%E9%A2%91%E7%94%B1%E4%BA%BA%E5%B7%A5%E8%BF%9B%E8%A1%8C%E5%AE%A1%E6%A0%B8%E3%80%82">https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。</a></p><p>1.运营用户登入运营平台并进入媒资管理页面，查找待审核媒资</p><p><img src="/breeze/e273b43/image8.png"></p><p>2.点击列表中媒资名称链接，可预览该媒资，若是视频，则播放视频。</p><p><img src="/breeze/e273b43/image9.png"></p><p>3.点击列表中某媒资后的”审核” 按钮，既完成媒资的审批过程。</p><p><img src="/breeze/e273b43/image10.png"></p><p>点击“审核”，选择审核结果，输入审核意见。</p><p><img src="/breeze/e273b43/image11.png"></p><h5 id="1-2-5-绑定媒资"><a href="#1-2-5-绑定媒资" class="headerlink" title="1.2.5 绑定媒资"></a><strong>1.2.5 绑定媒资</strong></h5><p>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后点课程计划名称则在线播放视频。如下图：</p><p><img src="/breeze/e273b43/image12.png"></p><p>如何将课程计划绑定媒资呢？</p><p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p><p><img src="/breeze/e273b43/image13.png"></p><p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p><p><img src="/breeze/e273b43/image14.png"></p><p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p><p><img src="/breeze/e273b43/image15.png"></p><p>课程计划关联视频后如下图：</p><p><img src="/breeze/e273b43/image16.png"></p><h4 id="1-3-数据模型"><a href="#1-3-数据模型" class="headerlink" title="1.3 数据模型"></a><strong>1.3 数据模型</strong></h4><p>本模块媒资文件相关的数据表如下：</p><p><img src="/breeze/e273b43/image17.png"></p><p>媒资文件表：存储文件信息，包括图片、视频、文档等。</p><p>media_process: 待处理视频表。</p><p>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</p><p>媒资文件与课程计划绑定关系表如下：</p><p><img src="/breeze/e273b43/image18.png"></p><h3 id="2-搭建模块环境"><a href="#2-搭建模块环境" class="headerlink" title="2 搭建模块环境"></a><strong>2 搭建模块环境</strong></h3><h4 id="2-1-架构的问题分析"><a href="#2-1-架构的问题分析" class="headerlink" title="2.1 架构的问题分析"></a><strong>2.1 架构的问题分析</strong></h4><p>当前要开发的是媒资管理服务，目前为止共三个微服务：内容管理、系统管理、媒资管理，如下图：</p><p><img src="/breeze/e273b43/image19.png"></p><p>后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：</p><p>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是localhost</p><p><img src="/breeze/e273b43/image20.png"></p><p>当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p><p>基于这个问题可以采用网关来解决，如下图：</p><p><img src="/breeze/e273b43/image21.png"></p><p>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：</p><p><img src="/breeze/e273b43/image22.png"></p><p>在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p><p>为什么所有的请求先到网关呢？</p><p>&#x3D;&#x3D;有了网关就可以对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本，比如：400电话，路由的试可以根据请求路径进行路由、根据host地址进行路由等， 当微服务有多个实例时可以通过负载均衡算法进行路由&#x3D;&#x3D;，如下：</p><p><img src="/breeze/e273b43/image23.png"></p><p>另外，网关还可以实现权限控制、限流等功能。</p><blockquote><p><strong>网关的作用：</strong></p><ol><li>对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本</li><li>实现权限控制</li><li>限流</li></ol></blockquote><p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心，整体的架构图如下：</p><p><img src="/breeze/e273b43/image24.png"></p><p>流程如下：</p><p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p><p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p><p>3、请求到达网关，网关将请求路由到具体的微服务。</p><p>要使用网关首先搭建Nacos，Nacos有两个作用：</p><p>1、服务发现中心。</p><p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p><p>2、配置中心。</p><p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p><h4 id="2-2-搭建Nacos"><a href="#2-2-搭建Nacos" class="headerlink" title="2.2 搭建Nacos"></a><strong>2.2 搭建Nacos</strong></h4><h5 id="2-2-1-服务发现中心"><a href="#2-2-1-服务发现中心" class="headerlink" title="2.2.1 服务发现中心"></a><strong>2.2.1 服务发现中心</strong></h5><p>Spring Cloud ：一套规范</p><p>Spring Cloud alibaba: nacos服务注册中心，配置中心</p><p>根据上节讲解的网关的架构图，要使用网关首先搭建Nacos。</p><p>首先搭建Nacos服务发现中心。</p><p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p><p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p><p>group：用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p><p>首先在nacos配置namespace:</p><p>登录Centos，启动Naocs，使用sh &#x2F;data&#x2F;soft&#x2F;restart.sh将自动启动Nacos。</p><p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8848/nacos/">http://192.168.101.65:8848/nacos/</a></p><p>账号密码：nacos&#x2F;nacos</p><p>登录成功，点击左侧菜单“命名空间”进入命名空间管理界面，</p><p><img src="/breeze/e273b43/image25.png"></p><p>点击“新建命名空间”，填写命名空间的相关信息。如下图：</p><p><img src="/breeze/e273b43/image26.png"></p><p>使用相同的方法再创建“测试环境”、”生产环境”的命名空间。</p><p><img src="/breeze/e273b43/image27.png"></p><p><img src="/breeze/e273b43/image28.png"></p><p>创建成功，如下图：</p><p><img src="/breeze/e273b43/image29.png"></p><p>在教学中可以创建具体班级的命名空间，假如创建1010班级的命名空间，如下：</p><p><img src="/breeze/e273b43/image30.png"></p><p>注意：如果使用dev1010命名空间，在下边的配置中对namespace配置为dev1010。</p><p>首先完成各服务注册到Naocs，下边将内容管理服务注册到nacos中。</p><p>1) 在xuecheng-plus-parent中添加依赖管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2）在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加nacos-discovery依赖，该依赖的作用是将本地实例注册到nacos中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3）配置nacos的地址</p><p>在系统管理的接口工程的配置文件中配置如下信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure><p>在内容管理的接口工程的配置文件中配置如下信息：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br></pre></td></tr></table></figure><p>4）重启内容管理服务、系统管理服务。</p><p>待微服务启动成功，进入Nacos服务查看服务列表</p><p><img src="/breeze/e273b43/image31.png"></p><p>在 “开发环境” 命名空间下有两个服务这说明内容管理微服务和系统管理微服务在Nacos注册成功。</p><p>点击其它一个微服务的“详情”</p><p><img src="/breeze/e273b43/image32.png"></p><p>通过上图可以查看微服务实例的地址。</p><h5 id="2-2-2-配置中心"><a href="#2-2-2-配置中心" class="headerlink" title="2.2.2 配置中心"></a><strong>2.2.2 配置中心</strong></h5><h6 id="2-2-2-1-配置三要素"><a href="#2-2-2-1-配置三要素" class="headerlink" title="2.2.2.1 配置三要素"></a><strong>2.2.2.1 配置三要素</strong></h6><p>搭建完成Nacos服务发现中心，下边搭建Nacos为配置中心，其目的就是通过Nacos去管理项目的所有配置。</p><p><strong><font color="red">在nacos上进行配置文件的配置是为了增强代码的复用性。让多个不同的实例共享这一份配置文件。</font></strong></p><p>&#x3D;&#x3D;先将项目中的<strong>配置文件分分类</strong>：&#x3D;&#x3D;</p><p>1<strong>、每个项目特有的配置</strong></p><p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p><p>比如：spring.application.name每个项目都需要配置但值不一样，以及有些项目需要连接数据库而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p><p><strong>2、项目所公用的配置</strong></p><p>是指在若干项目中配置内容相同的配置。比如：redis的配置，很多项目用的同一套redis服务所以配置也一样。</p><p>另外还需要知道nacos如何去定位一个具体的配置文件，即：namespace、group、dataid.</p><p>1、通过namespace、group找到具体的环境和具体的项目。</p><p>2、通过dataid找到具体的配置文件，dataid有三部分组成</p><p>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</p><p>content-service：第一部分，它是在application.yaml中配置的应用名，即spring.application.name的值。</p><p>dev：第二部分，它是环境名，通过spring.profiles.active指定，</p><p>Yaml: 第三部分，它是配置文件 的后缀，目前nacos支持properties、yaml等格式类型，本项目选择yaml格式类型。</p><p>所以，如果我们要配置content-service工程的配置文件:</p><p>在开发环境中配置content-service-dev.yaml</p><p>在测试环境中配置content-service-test.yaml</p><p>在生产环境中配置content-service-prod.yaml</p><p>我们启动项目中传入spring.profiles.active的参数决定引用哪个环境的配置文件，例如：传入spring.profiles.active&#x3D;dev表示使用dev环境的配置文件即content-service-dev.yaml。</p><h6 id="2-2-2-2-配置content-service"><a href="#2-2-2-2-配置content-service" class="headerlink" title="2.2.2.2 配置content-service"></a><strong>2.2.2.2 配置content-service</strong></h6><p>下边以开发环境为例对content-service工程的配置文件进行配置，进入nacos，进入开发环境。</p><p><img src="/breeze/e273b43/image33.png"></p><p>点击加号，添加一个配置</p><p><img src="/breeze/e273b43/image34.png"></p><p>输入data id、group以及配置文件内容。</p><p>为什么没在nacos中配置下边的内容 ？</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br></pre></td></tr></table></figure><p>因为刚才说了dataid第一部分就是spring.application.name，nacos 客户端要根据此值确定配置文件 名称，所以spring.application.name不在nacos中配置，而是要在工程的本地进行配置。</p><p>在content-service工程的test&#x2F;resources 中添加bootstrap.yaml，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#profiles默认为dev</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p><strong>打断点执行<code>content-service</code>工程下的<code>test</code>中的方法，看能否查询出数据，若能，则说明配置成功。</strong></p><p>在内容管理模块的接口工程和service工程配置依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加nacos-config依赖，该依赖的作用是使用nacos配置中心，例如使用nacos中的配置文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置完成，运行content-service工程 的单元测试文件，能否正常测试，跟踪单元测试方法可以正常读取数据库的数据，说明从nacos读取配置信息正常。</p><p>通过运行观察控制台打印出下边的信息，NacosRestTemplate.java通过Post方式与nacos服务端交互读取配置信息。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:476] - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener, body: &#123;Listening-Configs=content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, tenant=dev&#125;</span><br></pre></td></tr></table></figure><p><strong>此时content-api-dev.yaml文件内容如下：</strong></p><blockquote><p>如果没有在该文件中进行数据源的配置的话，<code>ContentApplication</code>服务会启动失败</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/content</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63040</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.101.65:3306/xcplus_content?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure><p><strong>测试：</strong></p><p>通过访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html%EF%BC%8C%E5%AF%B9%E8%AF%A5%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%E8%8B%A5%E8%83%BD%E6%9F%A5%E8%AF%A2%E5%88%B0%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%88%99%E8%AF%B4%E6%98%8E%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F%E3%80%82">http://localhost:63040/content/swagger-ui.html，对该页面的查询接口进行测试。若能查询到数据，则说明配置成功。</a></p><h6 id="2-2-2-3配置content-api"><a href="#2-2-2-3配置content-api" class="headerlink" title="2.2.2.3配置content-api"></a><strong>2.2.2.3配置content-api</strong></h6><p>以相同的方法配置content-api工程的配置文件，在nacos中的开发环境中配置content-api-dev.yaml，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/content</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63040</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># swagger 文档配置</span></span><br><span class="line"><span class="attr">swagger:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">&quot;学成在线内容管理系统&quot;</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span></span><br><span class="line">  <span class="attr">base-package:</span> <span class="string">com.xuecheng.content</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在content-api工程 的本地配置bootstrap.yaml，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意：因为api接口工程依赖了service工程 的jar，所以这里使用extension-configs扩展配置文件 的方式引用service工程所用到的配置文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">   <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">   <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果添加多个扩展文件，继续在下添加即可，如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension-configs:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">	<span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">	<span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">填写文件</span> <span class="string">dataid</span></span><br><span class="line">	<span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">	<span class="attr">refresh:</span> <span class="literal">true</span>           </span><br></pre></td></tr></table></figure><p>启动content-api工程，查询控制台是否打印出了请求nacos的日志，如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:476] - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener</span><br></pre></td></tr></table></figure><p><strong>测试：并使用Httpclient或swagger测试课程查询接口是否可以正常查询。</strong></p><p>通过访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html%EF%BC%8C%E5%AF%B9%E8%AF%A5%E9%A1%B5%E9%9D%A2%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E3%80%82%E8%8B%A5%E8%83%BD%E6%9F%A5%E8%AF%A2%E5%88%B0%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%88%99%E8%AF%B4%E6%98%8E%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F%E3%80%82">http://localhost:63040/content/swagger-ui.html，对该页面的查询接口进行测试。若能查询到数据，则说明配置成功。</a></p><p>需要说明的是：在<code>content-api</code>服务的本地配置文件和远程配置文件中，都没有进行数据源的相关配置。只在<code>content-service</code>的远程配置文件中进行了数据源的配置，然后在<code>content-api</code>的本地配置文件中对<code>content-service</code>的配置文件进行了应用。所以此时<code>content-api</code>服务和<code>content-service</code>服务共用了同一个数据源。此时，经过上述测试，文件配置成功。</p><h5 id="2-2-3-公用配置"><a href="#2-2-3-公用配置" class="headerlink" title="2.2.3 公用配置"></a><strong>2.2.3 公用配置</strong></h5><p>还有一个优化的点是如何在nacos中配置项目的公用配置呢？</p><p>nacos提供了shared-configs可以引入公用配置。</p><p>在content-api中配置了swagger，所有的接口工程 都需要配置swagger，这里就可以将swagger的配置定义为一个公用配置，哪个项目用引入即可。</p><p>单独在xuecheng-plus-common分组下创建xuecheng-plus的公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p><p><img src="/breeze/e273b43/image35.png"></p><p>自己做的时候，把上述图片中的<code>title</code>和<code>description</code>进行了修改</p><p>删除接口工程中对swagger的配置。</p><p>项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件 中引入公用配置，如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p>再以相同 的方法配置日志的公用配置。</p><p><img src="/breeze/e273b43/image36.png"></p><p>在接口工程和业务工程，引入loggin-dev.yaml公用配置文件</p><p><img src="/breeze/e273b43/image37.png"></p><p><strong>测试：</strong>配置完成，重启content-api接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/swagger-ui.html">http://localhost:63040/content/swagger-ui.html</a> 查看swagger接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常。</p><h5 id="2-2-4-配置优先级"><a href="#2-2-4-配置优先级" class="headerlink" title="2.2.4 配置优先级"></a><strong>2.2.4 配置优先级</strong></h5><p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，SpringBoot读取配置文件 的顺序如下：</p><p><img src="/breeze/e273b43/image38.png"></p><p>引入配置文件的形式有：</p><p>1、以项目应用名方式引入</p><p>2、以扩展配置文件方式引入</p><p>3、以共享配置文件 方式引入</p><p>4、本地配置文件</p><p>&#x3D;&#x3D;各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。&#x3D;&#x3D;</p><p>有时候我们在测试程序时直接在本地加一个配置进行测试，比如下边的例子：</p><p>我们想启动两个内容管理微服务，此时需要在本地指定不同的端口，通过VM Options参数，在IDEA配置启动参数</p><p><img src="/breeze/e273b43/image39.png"></p><p>通过-D指定参数名和参数值，参数名即在bootstrap.yml中配置的server.port。</p><p><img src="/breeze/e273b43/image40.png"></p><p>启动ContentApplication2，发现端口仍然是63040，这说明本地的配置没有生效。</p><p>这时我们想让本地最优先，可以在nacos配置文件 中配置如下即可实现：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>再次启动ContentApplication2，端口为63041。</p><h5 id="2-2-5-导入配置文件"><a href="#2-2-5-导入配置文件" class="headerlink" title="2.2.5 导入配置文件"></a><strong>2.2.5 导入配置文件</strong></h5><p>课程资料中提供了系统用的所有配置文件nacos_config_export.zip，下边将nacos_config_export.zip导入nacos。</p><p>进入具体的命名空间，点击“导入配置”</p><p><img src="/breeze/e273b43/image41.png"></p><p>打开导入窗口</p><p><img src="/breeze/e273b43/image42.png"></p><p>相同的配置选择覆盖配置。</p><p>点击“上传文件”选择资料中的nacos_config_export.zip开始导入。</p><h5 id="2-2-6-作业"><a href="#2-2-6-作业" class="headerlink" title="2.2.6 作业"></a><strong>2.2.6 作业</strong></h5><p>按照上边的方法 自行将系统管理服务的配置信息在nacos上进行配置。</p><ol><li><p>首先在<code>system-api</code>服务的pom.xml文件中，添加如下两个依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加nacos-discovery依赖，将本地实例注册到nacos中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 添加nacos-config依赖，该依赖的作用是使用nacos配置中心，例如使用nacos中的配置文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>然后配置的<code>system-aip</code>服务下的<code>bootstrap.yml</code>文件如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释掉的部分，直接在nacos中进行配置。服务启动后会先加载本地的bootstrap.yml文件，根据该文件中配置的nacos的地址，及配置文件的id，去nacos中拉取对应的配置文件，然后和本地的application.yml配置文件中的配置相结合。然后再创建spring容器，接着创建bean.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#server:</span></span><br><span class="line"><span class="comment">#  servlet:</span></span><br><span class="line"><span class="comment">#    context-path: /system</span></span><br><span class="line"><span class="comment">#  port: 63110</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个必须在本地的文件中进行配置，为了发现nacos的地址以及要拉取的nacos中的配置文件的id</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-aip</span>  <span class="comment"># 服务名 注意这里是system-aip</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span>  <span class="comment"># 服务注册相关配置</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span> <span class="comment"># 配置文件相关配置</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">system-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">swagger-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 环境名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 日志文件配置路径</span></span><br><span class="line"><span class="comment">#logging:</span></span><br><span class="line"><span class="comment">#  config: classpath:log4j2-dev.xml</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## swagger 文档配置</span></span><br><span class="line"><span class="comment">#swagger:</span></span><br><span class="line"><span class="comment">#  title: &quot;学成在线内容管理系统&quot;</span></span><br><span class="line"><span class="comment">#  description: &quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span></span><br><span class="line"><span class="comment">#  base-package: com.xuecheng.content</span></span><br><span class="line"><span class="comment">#  enabled: true</span></span><br><span class="line"><span class="comment">#  version: 1.0.0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><strong>需要说明的是：</strong></p><p>要在本地应用程序中拉取Nacos中的配置文件，必须在本地的<code>bootstrap.properties/yaml</code> 或 <code>application.properties/yaml</code> 文件中配置 Nacos Server 的地址及要读取的配置文件 ID，以便启动集成了Spring Cloud Config 功能的应用程序时能够获取配置信息。</p><p>此外，不一定要使用 <code>bootstrap.properties/yaml</code> 文件，还可以使用 <code>application.properties/yaml</code> 文件来配置 Nacos Server 的地址和配置文件 ID，并指定 <code>spring.config.name</code> 和 <code>spring.application.name</code> 属性，但一般情况下为了更好地隔离配置，建议将所有需要放在 Bootstrap 阶段加载的属性放在 <code>bootstrap.properties/yaml</code> 文件中。</p></blockquote></li><li><p>配置nacos中的<code>system-aip-dev.yaml</code>文件，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/system</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63110</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 这里不需要进行数据库的配置，因为在 system-aip 服务中，引入了 system-service 的依赖。而在 system-service 中，进行了数据库的配置</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>system-service</code>服务的pom.xml文件中，引入如下依赖（必须要引入这个依赖，不然在该服务下创建<code>bootstrap.yml</code>文件不会起作用）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加nacos-config依赖，该依赖的作用是使用nacos配置中心，例如使用nacos中的配置文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>system-service</code>服务的bootstrap.yml文件中，写入以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#spring:</span></span><br><span class="line"><span class="comment">#  application:</span></span><br><span class="line"><span class="comment">#    name: system-service</span></span><br><span class="line"><span class="comment">#  datasource:</span></span><br><span class="line"><span class="comment">#    driver-class-name: com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment">#    url: jdbc:mysql://192.168.101.65:3306/xcplus_system?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line"><span class="comment">#    username: root</span></span><br><span class="line"><span class="comment">#    password: mysql</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="comment">#logging:</span></span><br><span class="line"><span class="comment">#  config: classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#微服务配置  这部分内容需要在本地配置，因为需要拉取nacos中的配置文件</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span> <span class="comment"># 服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span>  <span class="comment"># 服务注册相关配置</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span> <span class="comment"># 配置文件相关配置</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 环境名</span></span><br></pre></td></tr></table></figure></li><li><p>配置nacos中的<code>system-service-dev.yaml</code>文件，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.101.65:3306/xcplus_system?serverTimezone=UTC&amp;userUnicode=true&amp;useSSL=false&amp;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>测试：看服务能否正常启动即可</strong></p><h4 id="2-3-搭建Gateway"><a href="#2-3-搭建Gateway" class="headerlink" title="2.3 搭建Gateway"></a><strong>2.3 搭建Gateway</strong></h4><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p><p>新建一个网关工程。</p><p><img src="/breeze/e273b43/image43.png"></p><p>工程结构</p><p><img src="/breeze/e273b43/image44.png"></p><p>添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-plus-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--服务发现中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置网关的bootstrap.yaml配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-plus-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p>在nacos上配置网关路由策略：</p><p><img src="/breeze/e273b43/image45.png"></p><p>详细配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">63010</span> <span class="comment"># 网关端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line"><span class="comment">#      filter:</span></span><br><span class="line"><span class="comment">#        strip-prefix:</span></span><br><span class="line"><span class="comment">#          enabled: true</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">content-api</span> <span class="comment"># 路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://content-api</span> <span class="comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/content/**</span> <span class="comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">system-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://system-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/system/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">media-api</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8081</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://media-api</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/media/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - StripPrefix=1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>启动网关工程，通过网关工程访问微服务进行测试。</p><p>在http-client-env.json中配置网关的地址</p><p><img src="/breeze/e273b43/image46.png"></p><p>使用httpclient测试课程查询 接口，如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">### 课程查询列表</span><br><span class="line">POST <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>gateway_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;courseName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>运行，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">transfer-encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Sun<span class="punctuation">,</span> <span class="number">11</span> Sep <span class="number">2022</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">54</span><span class="punctuation">:</span><span class="number">32</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;203001&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p><p><img src="/breeze/e273b43/image47.png"></p><p>启动前端工程，测试之前开发内容管理模块的功能。</p><p>观察网关控制台，通过网关转发课程查询的日志如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Handler is being applied: &#123;uri=http://192.168.101.1:63040/content/course/list?pageNo=2&amp;pageSize=1, method=POST&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-搭建媒资工程"><a href="#2-4-搭建媒资工程" class="headerlink" title="2.4 搭建媒资工程"></a><strong>2.4 搭建媒资工程</strong></h4><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目。</p><p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p><p>右键pom.xml转为maven工程。</p><p><img src="/breeze/e273b43/image48.png"></p><p>下边做如下配置：</p><p>1、创建媒资数据库xc_media，并导入资料目录中的xcplus_media.sql</p><p>2、修改nacos上的media-service-dev.yaml配置文件中的数据库链接信息</p><p>重启media-api工程只要能正常启动成功即可，稍后根据需求写接口。</p><p>可以利用swagger进行访问，路径：<a target="_blank" rel="noopener" href="http://localhost:63050/media/swagger-ui.html">http://localhost:63050/media/swagger-ui.html</a></p><h3 id="3-分布式文件系统"><a href="#3-分布式文件系统" class="headerlink" title="3 分布式文件系统"></a><strong>3 分布式文件系统</strong></h3><h4 id="3-1-什么是分布式文件系统"><a href="#3-1-什么是分布式文件系统" class="headerlink" title="3.1 什么是分布式文件系统"></a><strong>3.1 什么是分布式文件系统</strong></h4><p>要理解分布式文件系统首先了解什么是文件系统。</p><p>查阅百度百科：</p><p><img src="/breeze/e273b43/image49.png"></p><p>&#x3D;&#x3D;文件系统是负责管理和存储文件的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。&#x3D;&#x3D;</p><p>下图指示了文件系统所处的位置：</p><p><img src="/breeze/e273b43/image50.png"></p><p>常见的文件系统：FAT16&#x2F;FAT32、NTFS、HFS、UFS、APFS、XFS、Ext4等 。</p><p>现在有个问题，一般短视频平台拥有大量的视频、图片，这些视频文件、图片文件该如何存储呢？如何存储可以满足互联网上海量用户的浏览。</p><p>今天讲的分布式文件系统就是海量用户查阅海量文件的方案。</p><p>我们阅读百度百科去理解分布式文件系统的定义：</p><p><img src="/breeze/e273b43/image51.png"></p><p>通过概念可以简单理解为：&#x3D;&#x3D;一个计算机无法存储海量的文件，通过网络将若干计算机组织起来共同去存储海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，&#x3D;&#x3D;如下图：</p><p><img src="/breeze/e273b43/image52.png"></p><p>好处：</p><p>1、一台计算机的文件系统处理能力扩充到多台计算机同时处理。</p><p>2、一台计算机挂了还有另外副本计算机提供数据。</p><p>3、每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</p><p>市面上有哪些分布式文件系统的产品呢？</p><p>1、NFS</p><p>阅读百度百科：</p><p><img src="/breeze/e273b43/image53.png"></p><p><img src="/breeze/e273b43/image54.png"></p><p>特点：</p><p>1）在客户端上映射NFS服务器的驱动器。</p><p>2）客户端通过网络访问NFS服务器的硬盘完全透明。</p><p>2、GFS</p><p><img src="/breeze/e273b43/image55.png"></p><p><img src="/breeze/e273b43/image56.png"></p><p>1）GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成。</p><p>2）master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中。</p><p>3）用户从master中获取数据元信息，向chunkserver存储数据。</p><p>3) HDFS</p><p>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p><p>下图是HDFS的架构图：</p><p><img src="/breeze/e273b43/image57.png"></p><p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点和若干数据结点组成。</p><p>2) 名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p><p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p><h3 id="4、云计算厂家"><a href="#4、云计算厂家" class="headerlink" title="4、云计算厂家"></a><strong>4、云计算厂家</strong></h3><p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</p><p><em>官方网站：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">https://www.aliyun.com/product/oss</a></em></p><p>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入BOS，并对数据进行管理和处理。BOS支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。</p><p><em>官方网站：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html">https://cloud.baidu.com/product/bos.html</a></em></p><h4 id="4-1-MinIO"><a href="#4-1-MinIO" class="headerlink" title="4.1 MinIO"></a><strong>4.1 MinIO</strong></h4><h5 id="4-1-1-介绍"><a href="#4-1-1-介绍" class="headerlink" title="4.1.1 介绍"></a><strong>4.1.1 介绍</strong></h5><p>本项目采用MinIO构建分布式文件系统，MinIO 是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器&#x2F;虚拟机镜像等。</p><p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容 Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</p><p>官网：<a target="_blank" rel="noopener" href="https://min.io/">https://min.io</a></p><p>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p><p>MinIO集群采用去中心化共享架构，每个结点是对等关系，通过Nginx可对MinIO进行负载均衡访问。</p><p>去中心化有什么好处？</p><p>在大数据领域，通常的设计理念都是无中心和分布式。Minio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p><p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，&#x3D;&#x3D;分布式Minio避免了单点故障&#x3D;&#x3D;。如下图：</p><p><img src="/breeze/e273b43/image58.png"></p><p>Minio使用<strong>纠删码</strong>技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各个节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，<strong>除了将文件本身分成4个数据块，还会生成4个校验块，数据块和校验块会分散的存储在这8块硬盘上。</strong></p><p>使用纠删码的好处是即便丢失一半数量（N&#x2F;2）的硬盘，仍然可以恢复数据。 比如上边集合中有4个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</p><h5 id="4-2-2-数据恢复演示"><a href="#4-2-2-数据恢复演示" class="headerlink" title="4.2.2 数据恢复演示"></a><strong>4.2.2 数据恢复演示</strong></h5><p>下边在本机演示MinIO恢复数据的过程，在本地创建4个目录表示4个硬盘。</p><p><img src="/breeze/e273b43/image59.png"></p><p>下载minio，下载地址在<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/%EF%BC%8C%E5%8F%AF%E4%BB%8E%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99%E6%89%BE%E5%88%B0MinIO%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6minio.zip%E8%A7%A3%E5%8E%8B%E5%8D%B3%E5%8F%AF%E4%BD%BF%E7%94%A8%EF%BC%8CCMD%E8%BF%9B%E5%85%A5%E6%9C%89minio.exe%E7%9A%84%E7%9B%AE%E5%BD%95%EF%BC%8C%E8%BF%90%E8%A1%8C%E4%B8%8B%E8%BE%B9%E7%9A%84%E5%91%BD%E4%BB%A4%EF%BC%9A">https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</a></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Plain Text</span><br><span class="line">minio.exe server D:<span class="keyword">\develop</span><span class="keyword">\minio</span><span class="built_in">_</span>data<span class="keyword">\data</span>1  D:<span class="keyword">\develop</span><span class="keyword">\minio</span><span class="built_in">_</span>data<span class="keyword">\data</span>2  D:<span class="keyword">\develop</span><span class="keyword">\minio</span><span class="built_in">_</span>data<span class="keyword">\data</span>3  D:<span class="keyword">\develop</span><span class="keyword">\minio</span><span class="built_in">_</span>data<span class="keyword">\data</span>4</span><br></pre></td></tr></table></figure><p>启动结果如下：</p><p><img src="/breeze/e273b43/image60.png"></p><p>说明如下：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WARNING: MINIO<span class="built_in">_</span>ACCESS<span class="built_in">_</span>KEY and MINIO<span class="built_in">_</span>SECRET<span class="built_in">_</span>KEY are deprecated.</span><br><span class="line">         Please use MINIO<span class="built_in">_</span>ROOT<span class="built_in">_</span>USER and MINIO<span class="built_in">_</span>ROOT<span class="built_in">_</span>PASSWORD</span><br><span class="line">Formatting 1st pool, 1 set(s), 4 drives per set.</span><br><span class="line">WARNING: Host local has more than 2 drives of set. A host failure will result in data becoming unavailable.</span><br><span class="line">WARNING: Detected default credentials &#x27;minioadmin:minioadmin&#x27;, we recommend that you change these values with &#x27;MINIO<span class="built_in">_</span>ROOT<span class="built_in">_</span>USER&#x27; and &#x27;MINIO<span class="built_in">_</span>ROOT<span class="built_in">_</span>PASSWORD&#x27; environment variables</span><br></pre></td></tr></table></figure><p>1）老版本使用的MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY不推荐使用，推荐使用MINIO_ROOT_USER 和MINIO_ROOT_PASSWORD设置账号和密码。</p><p>2）pool即minio节点组成的池子，当前有一个pool和4个硬盘组成的set集合</p><p>3）因为集合是4个硬盘，大于2的硬盘损坏数据将无法恢复。</p><p>4）账号和密码默认为minioadmin、minioadmin，可以在环境变量中设置通过’MINIO_ROOT_USER’ and ‘MINIO_ROOT_PASSWORD’ 进行设置。</p><p>下边输入<a href="http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin">http://localhost:9000进行登录，账号和密码为：minioadmin/minioadmin</a></p><p><img src="/breeze/e273b43/image61.png"></p><p>登录成功：</p><p><img src="/breeze/e273b43/image62.png"></p><p>下一步创建bucket，桶，它相当于存储文件的目录，可以创建若干的桶。</p><p><img src="/breeze/e273b43/image63.png"></p><p>输入bucket的名称，点击“CreateBucket”，创建成功</p><p><img src="/breeze/e273b43/image64.png"></p><p>点击“upload”上传文件。</p><p>下边上传几个文件</p><p><img src="/breeze/e273b43/image65.png"></p><p>下边去四个目录观察文件的存储情况</p><p><img src="/breeze/e273b43/image66.png"></p><p>我们发现上传的1.mp4文件存储在了四个目录，即四个硬盘上。</p><p>下边测试minio的数据恢复过程：</p><p>1、首先删除一个目录。</p><p>删除目录后仍然可以在web控制台上传文件和下载文件。</p><p>稍等片刻删除的目录自动恢复。</p><p>2、删除两个目录。</p><p>删除两个目录也会自动恢复。</p><p>3、删除三个目录 。</p><p>由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。</p><p>此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p><h5 id="4-2-3-测试Docker环境"><a href="#4-2-3-测试Docker环境" class="headerlink" title="4.2.3 测试Docker环境"></a><strong>4.2.3 测试Docker环境</strong></h5><p>开发阶段和生产阶段统一使用Docker下的MINIO。</p><p>在下发的虚拟机中已安装了MinIO的镜像和容器，执行sh &#x2F;data&#x2F;soft &#x2F;restart.sh启动Docker下的MinIO</p><p>启动完成登录MinIO查看是否正常。</p><p>访问<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/">http://192.168.101.65:9000</a></p><p><img src="/breeze/e273b43/image67.png"></p><p>本项目创建两个buckets：</p><p>mediafiles： 普通文件</p><p>video：视频文件</p><h5 id="4-2-4-SDK"><a href="#4-2-4-SDK" class="headerlink" title="4.2.4 SDK"></a><strong>4.2.4 SDK</strong></h5><h6 id="4-2-4-1上传文件"><a href="#4-2-4-1上传文件" class="headerlink" title="4.2.4.1上传文件"></a><strong>4.2.4.1上传文件</strong></h6><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p><p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p><p>最低需求Java 1.8或更高版本:</p><p>maven依赖如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在media-service工程添加此依赖。</p><p>参数说明：</p><p>需要三个参数才能连接到minio服务。</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>参数</td><td>说明</td></tr><tr><td>Endpoint</td><td>对象存储服务的URL</td></tr><tr><td>Access Key</td><td>Access key就像用户ID，可以唯一标识你的账户。</td></tr><tr><td>Secret Key</td><td>Secret key是你账户的密码。</td></tr></tbody></table><p>官方的示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span></span><br><span class="line">            <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">                MinioClient.builder()</span><br><span class="line">                .endpoint(<span class="string">&quot;https://play.min.io&quot;</span>)</span><br><span class="line">                .credentials(<span class="string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span>, <span class="string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">            <span class="comment">// Make &#x27;asiatrip&#x27; bucket if not exist.</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">                minioClient.bucketExists(BucketExistsArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">            <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">                <span class="comment">// Make a new bucket called &#x27;asiatrip&#x27;.</span></span><br><span class="line">                minioClient.makeBucket(MakeBucketArgs.builder().bucket(<span class="string">&quot;asiatrip&quot;</span>).build());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Bucket &#x27;asiatrip&#x27; already exists.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Upload &#x27;/home/user/Photos/asiaphotos.zip&#x27; as object name &#x27;asiaphotos-2015.zip&#x27; to bucket</span></span><br><span class="line">            <span class="comment">// &#x27;asiatrip&#x27;.</span></span><br><span class="line">            minioClient.uploadObject(</span><br><span class="line">                UploadObjectArgs.builder()</span><br><span class="line">                .bucket(<span class="string">&quot;asiatrip&quot;</span>)</span><br><span class="line">                .object(<span class="string">&quot;asiaphotos-2015.zip&quot;</span>)</span><br><span class="line">                .filename(<span class="string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span>)</span><br><span class="line">                .build());</span><br><span class="line">            System.out.println(</span><br><span class="line">                <span class="string">&quot;&#x27;/home/user/Photos/asiaphotos.zip&#x27; is successfully uploaded as &quot;</span></span><br><span class="line">                + <span class="string">&quot;object &#x27;asiaphotos-2015.zip&#x27; to bucket &#x27;asiatrip&#x27;.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MinioException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);</span><br><span class="line">            System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考示例在media-service工程中 测试上传文件功能，</p><p>首先创建一个用于测试的bucket</p><p><img src="/breeze/e273b43/image68.png"></p><p>点击“Manage”修改bucket的访问权限</p><p><img src="/breeze/e273b43/image69.png"></p><p>选择public权限</p><p><img src="/breeze/e273b43/image70.png"></p><p>在xuecheng-plus-media-service工程 的test下编写测试代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.BucketExistsArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MakeBucketArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.errors.MinioException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试MinIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/11 21:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">        MinioClient.builder()</span><br><span class="line">        .endpoint(<span class="string">&quot;http://192.168.101.65:9000&quot;</span>)</span><br><span class="line">        .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                <span class="comment">//.object(&quot;test001.mp4&quot;)</span></span><br><span class="line">                .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">                .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">                .contentType(<span class="string">&quot;video/mp4&quot;</span>)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">                .build();</span><br><span class="line">            minioClient.uploadObject(testbucket);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行upload方法，分别测试向桶的根目录上传文件以及子目录上传文件。</p><p>上传成功，通过web控制台查看文件，并预览文件。</p><p>说明：</p><p>设置contentType可以通过com.j256.simplemagic.ContentType枚举类查看常用的mimeType（媒体类型）</p><p>通过扩展名得到mimeType，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line"><span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br></pre></td></tr></table></figure><p>完善上边的代码 如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(<span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;<span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">            .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">            <span class="comment">//                    .object(&quot;test001.mp4&quot;)</span></span><br><span class="line">            .object(<span class="string">&quot;001/test001.mp4&quot;</span>)<span class="comment">//添加子目录</span></span><br><span class="line">            .filename(<span class="string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span>)</span><br><span class="line">            .contentType(mimeType)<span class="comment">//默认根据扩展名确定文件内容类型，也可以指定</span></span><br><span class="line">            .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="4-2-4-2-删除文件"><a href="#4-2-4-2-删除文件" class="headerlink" title="4.2.4.2 删除文件"></a><strong>4.2.4.2 删除文件</strong></h6><p>下边测试删除文件</p><p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#removeObject">https://docs.min.io/docs/java-client-api-reference#removeObject</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        minioClient.removeObject(</span><br><span class="line">            RemoveObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;001/test001.mp4&quot;</span>).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;删除失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="4-2-4-3-查询文件"><a href="#4-2-4-3-查询文件" class="headerlink" title="4.2.4.3 查询文件"></a><strong>4.2.4.3 查询文件</strong></h6><p>通过查询文件查看文件是否存在minio中。</p><p>参考：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-api-reference#getObject">https://docs.min.io/docs/java-client-api-reference#getObject</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).object(<span class="string">&quot;test001.mp4&quot;</span>).build();</span><br><span class="line">    <span class="keyword">try</span>(</span><br><span class="line">        <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1_2.mp4&quot;</span>));</span><br><span class="line">    ) &#123;</span><br><span class="line">        IOUtils.copy(inputStream,outputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意IOUtils工具类的使用：</strong></p><p>这里将输入流拷贝到了输出流里面，把文件拷贝进了本机的指定目录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="type">GetObjectResponse</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">&gt;<span class="comment">// 指定输出流</span></span><br><span class="line">&gt;<span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\服务器\\minioRepository\\palace01\\文咏珊01.png&quot;</span>));</span><br><span class="line">&gt;org.apache.commons.io.IOUtils.copy(inputStream, outputStream);</span><br></pre></td></tr></table></figure></blockquote><p>如下方式进行文件一致性的比较，文件是一样的，但是为什么md5的值不一样呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询远程服务器获取到的流对象</span></span><br><span class="line"><span class="type">GetObjectResponse</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定输出流(下载到本地)</span></span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\服务器\\minioRepository\\palace01\\文咏珊01.png&quot;</span>));</span><br><span class="line">org.apache.commons.io.IOUtils.copy(inputStream, outputStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验文件的完整性，对文件的内容进行md5加密</span></span><br><span class="line"><span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(inputStream);    <span class="comment">// 对minio中的文件进行md5加密</span></span><br><span class="line"><span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(<span class="keyword">new</span> <span class="title class_">FileInputStream</span></span><br><span class="line">                                      (<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\服务器\\minioRepository\\palace01\\文咏珊01.png&quot;</span>))); <span class="comment">// 对本地下载的文件进行md5加密</span></span><br><span class="line"><span class="keyword">if</span>(source_md5.equals(local_md5))&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;下载成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>解释：</strong></p><p>如果将远程流对象中的内容进行md5加密，然后下载到本地后，将远程流对象中数据的md5与本地流对象中数据的md5进行比较，发现值不一样，那么可能是以下原因：</p><ol><li>远程流对象和本地流对象之间传输的过程中发生了意外错误，例如数据损坏、传输失败等情况；</li><li>在文件传输或文件保存的操作中，可能对数据源进行了处理或者修改，如压缩、编码转换和加密等操作，导致文件内容被改变，从而导致MD5值不同；</li><li>如果对相同数据进行多次MD5哈希计算，由于MD5算法的性质，会有一定概率出现哈希碰撞（collision），即不同文件的MD5值相同。</li></ol><p>为了确保数据的完整性和正确性，在进行文件传输时最好采用合适的传输协议和加密方法。同时，在使用MD5哈希算法对文件进行加密和校验时，应该注意对哈希函数的调用方法，以确保哈希结果的精确一致性，并尽量避免使用过于简单的密码。</p></blockquote><p>校验文件的完整性，对文件计算出md5值，比较原始文件的md5和目标文件的md5，一致则说明完整</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验文件的完整性对文件的内容进行md5（这个校验方式也有问题，不可取）</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1.mp4&quot;</span>)); <span class="comment">// 这个是从本地上传到远程的文件（这个是本地文件）</span></span><br><span class="line"><span class="type">String</span> <span class="variable">source_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream1);</span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\upload\\1a.mp4&quot;</span>)); <span class="comment">// 这个是从远程下载到本地的文件</span></span><br><span class="line"><span class="type">String</span> <span class="variable">local_md5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line"><span class="keyword">if</span>(source_md5.equals(local_md5))&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;下载成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><blockquote><p><strong>对上述代码进行解释：</strong></p><p>所以上述代码的意思是：获取到预上传文件的md5值，然后将上传的远程的文件再下载到本地，然后再获取下载到本地的文件的md5值，这显然是不合理的。正确的做法应该是，获取到远程的预下载文件的md5值，将文件下载到本地后，再获取下载到本地的文件的md5值，然后将这两个md5的值进行比较，若相同，则说名文件在传输的过程中没有损坏，下载成功。</p><p><strong>需要说明的是：</strong></p><p>md5只是校验文件的一种手段。不一定非得通过这种方式来判断文件的完整性。</p></blockquote><h3 id="5-上传图片"><a href="#5-上传图片" class="headerlink" title="5 上传图片"></a><strong>5 上传图片</strong></h3><h4 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a><strong>5.1 需求分析</strong></h4><h5 id="5-1-1-业务流程"><a href="#5-1-1-业务流程" class="headerlink" title="5.1.1 业务流程"></a><strong>5.1.1 业务流程</strong></h5><p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p><p>如下图：</p><p><img src="/breeze/e273b43/image71.png"></p><p>上传课程图片总体上包括两部分：</p><p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在媒资管理数据库保存文件信息。</p><p>2、上传图片成功保存图片地址到课程基本信息表中。</p><p>详细流程如下：</p><p><img src="/breeze/e273b43/image72.png"></p><p>1、前端进入上传图片界面</p><p>2、上传图片，请求媒资管理服务。</p><p>3、媒资管理服务将图片文件存储在MinIO。</p><p>4、媒资管理记录文件信息到数据库。</p><p>5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。</p><h5 id="5-1-2-数据模型"><a href="#5-1-2-数据模型" class="headerlink" title="5.1.2 数据模型"></a><strong>5.1.2 数据模型</strong></h5><p>涉及到的数据表有：课程信息表中的图片字段、媒资数据库的文件表，下边主要看媒资数据库的文件表。</p><p><img src="/breeze/e273b43/image73.png"></p><p>各字段描述如下：</p><p><img src="/breeze/e273b43/image74.png"></p><h4 id="5-2-准备环境"><a href="#5-2-准备环境" class="headerlink" title="5.2 准备环境"></a><strong>5.2 准备环境</strong></h4><p>首先在minio配置bucket，bucket名称为：mediafiles，并设置bucket的权限为公开。</p><p><img src="/breeze/e273b43/image75.png"></p><p>在nacos配置中minio的相关信息，进入media-service-dev.yaml:</p><p><img src="/breeze/e273b43/image76.png"></p><p>配置信息如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minio:</span><br><span class="line">  endpoint: http:<span class="comment">//192.168.101.65:9000</span></span><br><span class="line">  accessKey: minioadmin</span><br><span class="line">  secretKey: minioadmin</span><br><span class="line">  bucket:</span><br><span class="line">    files: mediafiles</span><br><span class="line">    videofiles: video</span><br></pre></td></tr></table></figure><p>在media-service工程编写minio的配置类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> minio配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 19:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建MinioClient对象</span></span><br><span class="line">    <span class="comment">// 创建这个对象的参数从配置文件中获取</span></span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">            MinioClient.builder()</span><br><span class="line">            .endpoint(endpoint)</span><br><span class="line">            .credentials(accessKey, secretKey)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">return</span> minioClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>服务启动流程说明：</strong></p><p>服务启动后先加载本地的<code>bootstrap.yml</code>文件，获取nacos的地址及nacos中配置文件的id，然后拉取nacos中的配置文件和本地的<code>application.yml</code>合并，接着创建<code>spring</code>容器，然后创建bean。</p><p><strong>参数说明：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line">&gt;<span class="keyword">private</span> String endpoint;</span><br><span class="line">&gt;<span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line">&gt;<span class="keyword">private</span> String accessKey;</span><br><span class="line">&gt;<span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line">&gt;<span class="keyword">private</span> String secretKey;</span><br></pre></td></tr></table></figure><p>由上面的启动流程可知，创建bean是服务启动流程的最后一步，所以上面的<code>@Value</code>注解，就可以获取到配置文件中对应的参数信息。然后通过这些参数就可以完成<code>MinioClient</code>客户端对象的创建。</p></blockquote><blockquote><p><strong>@RefreshScope是什么注解？什么时候使用？怎么使用？</strong></p><p><code>@RefreshScope</code> 是 Spring Cloud 提供的一个特殊的注解，用于实现配置热加载。</p><p>当我们在 Spring Boot 应用中使用 <code>@Value</code> 读取配置文件时，如果配置已经发生了变化，需要重启应用才能使新配置生效。但是当我们使用 <code>@RefreshScope</code> 注解时，就可以实现在应用运行期间动态更新配置，而不必重启应用，从而节省了服务的停机时间。</p><p>具体使用方法如下：</p><ol><li>在 Spring 配置类上标注 <code>@RefreshScope</code> 注解，例如：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>将需要动态更新的属性注入到 Spring 容器中，例如：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;my.config.item&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configItem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>在使用了 <code>@Value</code> 注解的业务代码中，加入 <code>@RefreshScope</code> 注解，并通过调用 <code>/actuator/refresh</code> 端点来刷新配置，例如：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;my.config.item&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configItem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;my.config.item=&quot;</span> + configItem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>通过发送 POST 请求到 <code>/actuator/refresh</code> 端点来刷新配置，例如：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:<span class="comment">//localhost:8080/actuator/refresh</span></span><br></pre></td></tr></table></figure><p>注意：需要在应用引入 <code>spring-boot-starter-actuator</code> 依赖，并且开启 actuator 的 <code>POST</code> 接口。</p><p>当收到刷新请求后，Spring Cloud 会自动调用 <code>@RefreshScope</code> 标记的 Bean 的 <code>refresh()</code> 方法来重新加载配置。在此之后，我们就可以使用新的配置项了。</p></blockquote><h4 id="5-3-接口定义"><a href="#5-3-接口定义" class="headerlink" title="5.3 接口定义"></a><strong>5.3 接口定义</strong></h4><p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p><p>首先分析接口：</p><p>请求地址：&#x2F;media&#x2F;upload&#x2F;coursefile</p><p>请求内容：<strong>Content-Type:</strong> multipart&#x2F;form-data;</p><p>form-data; name&#x3D;”filedata”; filename&#x3D;”具体的文件名称”</p><p>响应参数：文件信息，如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;001001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fileId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timelength&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-09-12T21:57:18&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fileSize&quot;</span><span class="punctuation">:</span> <span class="number">248329</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>定义上传响应模型类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件成功响应结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileResultDto</span> <span class="keyword">extends</span> <span class="title class_">MediaFiles</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>Dto：</strong></p><p>数据传输对象，常用于在不同层之间数据的传输</p><p>如果需要扩展属性的话，一定不能在<code>MediaFiles</code>类中添加，因为该类中的属性是与数据库表中的字段对应的，不能随意修改。此时，就可以在继承该类的Dto类中添加需要新增的属性。</p></blockquote><p>定义接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>对上述代码的解释：</strong></p><ul><li>@RequestMapping(value &#x3D; “&#x2F;upload&#x2F;coursefile”, consumes &#x3D; MediaType.MULTIPART_FORM_DATA_VALUE)</li></ul><p>这段代码表示在 Spring MVC 中使用 @RequestMapping 注解定义一个 POST 请求，该请求路径为 “&#x2F;upload&#x2F;coursefile” ，并且<strong>指定该接口只接收 Content-Type 为 multipart&#x2F;form-data 的请求</strong>。</p><p>其中，**@RequestMapping 注解通过 consumes 属性来指定所能处理的请求类型**。&#x3D;&#x3D;consumes 属性可以接受一个字符串数组作为参数，每个字符串代表一个 MIME 类型或者是 MIME 类型的通配符。如果请求中的 Content-Type 不匹配 consumes 属性中指定的 MIME 类型，则 Spring 将返回一个 415 Unsupported Media Type 的错误响应。&#x3D;&#x3D;在上面的代码中，我们将 consumes 属性指定为 MediaType.MULTIPART_FORM_DATA_VALUE，表示该请求只能接收 Content-Type 为 multipart&#x2F;form-data 的内容。</p><p>此外，因为这个请求是一个上传文件的操作，所以需要使用 multipart&#x2F;form-data 编码格式来发送数据，Spring 提供了 MultipartFile 参数类型来接收客户端发来的文件数据。例如以下示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">&gt;<span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">   <span class="comment">// 处理上传文件的逻辑</span></span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure><p>其中，@RequestPart(“filedata”) 注解用来将名为 “filedata” 的表单项映射到 MultipartFile 类型的参数上。当客户端提交包含名为 “filedata” 的表单项的 multipart&#x2F;form-data 类型的请求时，Spring 会自动将表单项映射到 MultipartFile 对象上，并将其传递给 upload() 方法处理。</p><ul><li>@RequestPart(“filedata”) MultipartFile upload</li></ul><p>指定该接口只接收 Content-Type 为 multipart&#x2F;form-data 的请求。而通过 @RequestPart 注解，我们可以将客户端提交的 multipart&#x2F;form-data 类型的请求中名为 “filedata” 的文件项映射到 MultipartFile 对象类型的参数 upload 上。</p><p>@RequestPart 注解主要用于处理复杂的 multipart 请求，在处理此类请求时常常涉及到许多不同的部分，例如文件、JSON 数据、XML 数据或其他自定义数据等。&#x3D;&#x3D;与 @RequestParam 注解不同，@RequestPart 注解支持项混合类型的表单数据，而不仅仅是字符串类型。&#x3D;&#x3D;此外，如果你需要自定义 multipart 请求的处理过程，那么 @RequestPart 注解也提供了更大的灵活性和可扩展性。</p><p>在上述示例中，使用 @RequestPart 注解将名为 “filedata” 的表单项映射到 MultipartFile 类型的参数 file 上，从而获取客户端上传文件的信息。&#x3D;&#x3D;由于它支持将不同类型的组件注入到控制器方法的参数中，因此 @RequestPart 注解具有更高的灵活性和组件化能力。&#x3D;&#x3D;</p></blockquote><p>接口定义好后可以用httpclient工具测试一下</p><p>使用httpclient测试</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;filedata&quot;; filename=&quot;1.jpg&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/1.jpg</span><br></pre></td></tr></table></figure><h4 id="5-4-接口开发"><a href="#5-4-接口开发" class="headerlink" title="5.4 接口开发"></a><strong>5.4 接口开发</strong></h4><h5 id="5-4-1-DAO开发"><a href="#5-4-1-DAO开发" class="headerlink" title="5.4.1 DAO开发"></a><strong>5.4.1 DAO开发</strong></h5><p>根据需求分析DAO层实现向media_files表插入一条记录，使用media_files表生成的mapper即可。</p><h5 id="5-4-2-Service开发"><a href="#5-4-2-Service开发" class="headerlink" title="5.4.2 Service开发"></a><strong>5.4.2 Service开发</strong></h5><p>Service方法需要提供一个更加通用的保存文件的方法。</p><p>定义请求参数类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/12 18:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileParamsDto</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件名称</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件类型（文档，音频，视频）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String fileType;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 文件大小</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Long fileSize;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 标签</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上传人</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 备注</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义service方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span>;</span><br></pre></td></tr></table></figure><p>实现方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MinioClient minioClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通文件桶</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String bucket_Files;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件默认存储目录路径 年/月/日 （每天一个路径）</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getDefaultFolderPath</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()).replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;/&quot;</span>)+<span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> folder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取文件的md5</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFileMd5</span><span class="params">(File file)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="keyword">return</span> fileMd5;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个获取文件扩展名的方法，因为不止一个地方会获取文件的扩展名，所以自定义一个方法来实现该功能，提高代码的复用性</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getMimeType</span><span class="params">(String extension)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(extension==<span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// 避免后面出现空指针异常，这里如果extension是空的话，就给它赋一个空字符串</span></span><br><span class="line">        extension = <span class="string">&quot;&quot;</span>;	</span><br><span class="line">    <span class="comment">//根据扩展名取出mimeType</span></span><br><span class="line">    <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(extension);</span><br><span class="line">    <span class="comment">//通用mimeType，字节流</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> MediaType.APPLICATION_OCTET_STREAM_VALUE;</span><br><span class="line">    <span class="keyword">if</span>(extensionMatch!=<span class="literal">null</span>)&#123;</span><br><span class="line">        mimeType = extensionMatch.getMimeType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mimeType;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件写入minIO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath  文件地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String localFilePath,String mimeType,String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UploadObjectArgs</span> <span class="variable">testbucket</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">            .bucket(bucket)</span><br><span class="line">            .object(objectName)</span><br><span class="line">            .filename(localFilePath)</span><br><span class="line">            .contentType(mimeType)</span><br><span class="line">            .build();</span><br><span class="line">        minioClient.uploadObject(testbucket);</span><br><span class="line">        log.debug(<span class="string">&quot;上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;&quot;</span>,bucket,objectName);</span><br><span class="line">        System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;上传文件到minio出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误原因:&#123;&#125;&quot;</span>,bucket,objectName,e.getMessage(),e);</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;上传文件到文件系统失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        <span class="comment">// uploadFileParamsDto中没有的属性，进行手动设置</span></span><br><span class="line">        <span class="comment">// 文件id</span></span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        <span class="comment">// filed_id</span></span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        <span class="comment">// 机构id</span></span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        <span class="comment">// url</span></span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        <span class="comment">// 桶</span></span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        <span class="comment">// file_path</span></span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        <span class="comment">// 上传时间</span></span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        <span class="comment">// 审核状态</span></span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFilePath);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line">    <span class="comment">//文件的md5值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> getFileMd5(file);</span><br><span class="line">    <span class="comment">//文件的默认目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">defaultFolderPath</span> <span class="operator">=</span> getDefaultFolderPath();</span><br><span class="line">    <span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line">    <span class="type">String</span>  <span class="variable">objectName</span> <span class="operator">=</span> defaultFolderPath + fileMd5 + exension;</span><br><span class="line">    <span class="comment">//将文件上传到minio</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> addMediaFilesToMinIO(localFilePath, mimeType, bucket_files, objectName);</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(file.length());</span><br><span class="line">    <span class="comment">//将文件信息存储到数据库</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;文件上传后保存信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备返回数据</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();</span><br><span class="line">    BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);</span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-3-完善接口层"><a href="#5-4-3-完善接口层" class="headerlink" title="5.4.3 完善接口层"></a><strong>5.4.3 完善接口层</strong></h5><p>完善接口层代码 ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;folder&quot;,required=false)</span> String folder,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    uploadFileParamsDto.setFileSize(filedata.getSize());</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001001&quot;</span>);</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    uploadFileParamsDto.setFilename(filedata.getOriginalFilename());<span class="comment">//文件名称</span></span><br><span class="line">    <span class="comment">//文件大小</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">fileSize</span> <span class="operator">=</span> filedata.getSize();</span><br><span class="line">    uploadFileParamsDto.setFileSize(fileSize);</span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    filedata.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="comment">//上传文件</span></span><br><span class="line">    <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> mediaFileService.uploadFile(companyId, uploadFileParamsDto, absolutePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-4-接口测试"><a href="#5-4-4-接口测试" class="headerlink" title="5.4.4 接口测试"></a><strong>5.4.4 接口测试</strong></h5><p>1、首先使用httpclient测试</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;filedata&quot;; filename=&quot;1.jpg&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; d:/develop/upload/1.jpg</span><br></pre></td></tr></table></figure><p>2、再进行前后端联调测试</p><p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p><p><img src="/breeze/e273b43/image2-1685854591145-77.png"></p><p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p><p><img src="/breeze/e273b43/image4-1685854593135-79.png"></p><h5 id="5-4-5-Service事务优化"><a href="#5-4-5-Service事务优化" class="headerlink" title="5.4.5 Service事务优化"></a><strong>5.4.5 Service事务优化</strong></h5><p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p><p>目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。（&#x3D;&#x3D;因为该方法会通过网络访问minio，通过网络访问，时间可长可短，可能导致数据库的事务持续时间很长。&#x3D;&#x3D;）</p><p><strong><font color="red">所以：在开发中，涉及到了网络访问，不能直接使用事务控制。</font></strong></p><p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p><p>优化后如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 先查一下该文件信息是否已经在数据库保存过了，所已保存过，就不在保存了</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>,mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们人为在int insert &#x3D; mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码int a&#x3D;1&#x2F;0;</p><p>测试是否事务控制。很遗憾，事务控制失败。</p><p>方法上已经添加了@Transactional注解为什么该方法不能被事务控制呢？</p><p>如果是在uploadFile方法上添加@Transactional注解就可以控制事务，去掉则不行。</p><p><font color="red">现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</font></p><p>下边分析原因：</p><p>如果在uploadFile方法上添加@Transactional注解，代理对象执行此方法前会开启事务，如下图：</p><p><img src="/breeze/e273b43/image77.png"></p><p>如果在uploadFile方法上没有@Transactional注解，代理对象执行此方法前不进行事务控制，如下图：</p><p><img src="/breeze/e273b43/image78.png"></p><p>&#x3D;&#x3D;<strong>所以判断该方法是否可以事务控制必须保证是通过代理对象调用此方法，且此方法上添加了@Transactional注解。</strong>&#x3D;&#x3D;</p><ol><li>该方法要加@Transactional注解</li><li>必须是代码对象调用该方法</li></ol><p>现在在addMediaFilesToDb方法上添加@Transactional注解，也不会进行事务控制是因为并不是通过代理对象执行的addMediaFilesToDb方法。为了判断在uploadFile方法中去调用addMediaFilesToDb方法是否是通过代理对象去调用，我们可以打断点跟踪。</p><p><img src="/breeze/e273b43/image79.png"></p><p>我们发现在uploadFile方法中去调用addMediaFilesToDb方法不是通过代理对象去调用。</p><p>&#x3D;&#x3D;如何解决呢？通过代理对象去调用addMediaFilesToDb方法即可解决。&#x3D;&#x3D;</p><p>在MediaFileService的实现类中注入MediaFileService的代理对象，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MediaFileService currentProxy;	<span class="comment">// 注入的就是代理对象</span></span><br></pre></td></tr></table></figure><p>将addMediaFilesToDb方法提成接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 将文件信息添加到文件表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto  上传文件的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket  桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.media.model.po.MediaFiles</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/12 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)</span>;</span><br></pre></td></tr></table></figure><p>调用addMediaFilesToDb方法的代码处改为如下：</p><p><strong>通过自己来调用自己，解决事务失效的问题</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line"><span class="comment">//写入文件表</span></span><br><span class="line"><span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> currentProxy.addMediaFilesToDb(companyId, fileMd5, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line"> ....</span><br></pre></td></tr></table></figure><p>再次测试事务是否可以正常控制。</p><blockquote><p><strong>事务生效必须满足两点：</strong></p><ol><li>在需要被事务控制的方法上，添加<code>@Transactional</code>注解</li><li>必须是代理对象调用该方法</li></ol><p><strong>可以通过自己（注入了自己的代理对象）来调用自己，解决事务失效的问题</strong></p></blockquote><h3 id="6-上传视频"><a href="#6-上传视频" class="headerlink" title="6 上传视频"></a><strong>6 上传视频</strong></h3><h4 id="6-1-需求分析"><a href="#6-1-需求分析" class="headerlink" title="6.1 需求分析"></a><strong>6.1 需求分析</strong></h4><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p><p>点击“媒资管理”</p><p><img src="/breeze/e273b43/image3-1685854604048-84.png"></p><p>进入媒资管理列表页面查询本机构上传的媒资文件。</p><p><img src="/breeze/e273b43/image4-1685854605982-86.png"></p><p>2、教育机构用户在”媒资管理”页面中点击 “上传视频” 按钮。</p><p><img src="/breeze/e273b43/image5-1685854607610-88.png"></p><p>点击“上传视频”打开上传页面</p><p><img src="/breeze/e273b43/image6-1685854610067-90.png"></p><p>3、选择要上传的文件，自动执行文件上传。</p><p><img src="/breeze/e273b43/image7-1685854611864-92.png"></p><p>4、视频上传成功会自动处理，处理完成可以预览视频。</p><p><img src="/breeze/e273b43/image80.png"></p><h4 id="6-2-断点续传技术"><a href="#6-2-断点续传技术" class="headerlink" title="6.2 断点续传技术"></a><strong>6.2 断点续传技术</strong></h4><h5 id="6-2-1-什么是断点续传"><a href="#6-2-1-什么是断点续传" class="headerlink" title="6.2.1 什么是断点续传"></a><strong>6.2.1 什么是断点续传</strong></h5><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p><p>什么是断点续传：</p><p>引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p><p>断点续传流程如下图：</p><p><img src="/breeze/e273b43/image81.png"></p><p>流程如下：</p><p>1、前端上传前先把文件分成块</p><p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p><p>3、各分块上传完成最后在服务端合并文件</p><h5 id="6-2-2-分块与合并测试"><a href="#6-2-2-分块与合并测试" class="headerlink" title="6.2.2 分块与合并测试"></a><strong>6.2.2 分块与合并测试</strong></h5><p>为了更好的理解文件分块上传的原理，下边用java代码测试文件的分块与合并。</p><p>文件分块的流程如下：</p><p>1、获取源文件长度</p><p>2、根据设定的分块文件的大小计算出块数</p><p>3、从源文件读数据依次向每一个块文件写数据。</p><p>测试代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件上传处理测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 9:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFileTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试文件分块方法</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChunk</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkPath</span> <span class="operator">=</span> <span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath);</span><br><span class="line">        <span class="keyword">if</span> (!chunkFolder.exists()) &#123;</span><br><span class="line">            chunkFolder.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分块大小</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkSize</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//分块数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">chunkNum</span> <span class="operator">=</span> (<span class="type">long</span>) Math.ceil(sourceFile.length() * <span class="number">1.0</span> / chunkSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;分块总数：&quot;</span>+chunkNum);</span><br><span class="line">        <span class="comment">//缓冲区大小</span></span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="comment">// 使用RandomAccessFile访问文件，该流具有读和写两个功能</span></span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(sourceFile, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="comment">//分块</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkNum; i++) &#123;</span><br><span class="line">            <span class="comment">//创建分块文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkPath + i);</span><br><span class="line">            <span class="keyword">if</span>(file.exists())&#123;</span><br><span class="line">                file.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">newFile</span> <span class="operator">=</span> file.createNewFile();</span><br><span class="line">            <span class="keyword">if</span> (newFile) &#123;</span><br><span class="line">                <span class="comment">//向分块文件中写数据</span></span><br><span class="line">                <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(file, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line">                    <span class="keyword">if</span> (file.length() &gt;= chunkSize) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                raf_write.close();</span><br><span class="line">                System.out.println(<span class="string">&quot;完成分块&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件合并流程：</p><p>1、找到要合并的文件并按文件合并的先后进行排序。</p><p>2、创建合并文件</p><p>3、依次从合并的文件中读取数据向合并文件写入数</p><p>文件合并的测试代码 ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试文件合并方法</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMerge</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//块文件目录</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/chunk/&quot;</span>);</span><br><span class="line">    <span class="comment">//原始文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span>);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/develop/bigfile_test/nacos01.mp4&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mergeFile.exists()) &#123;</span><br><span class="line">        mergeFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建新的合并文件</span></span><br><span class="line">    mergeFile.createNewFile();</span><br><span class="line">    <span class="comment">//用于写文件</span></span><br><span class="line">    <span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="comment">//指针指向文件顶端</span></span><br><span class="line">    raf_write.seek(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//缓冲区</span></span><br><span class="line">    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">//分块列表</span></span><br><span class="line">    File[] fileArray = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">// 转成集合，便于排序</span></span><br><span class="line">    List&lt;File&gt; fileList = Arrays.asList(fileArray);</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    Collections.sort(fileList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;File&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(File o1, File o2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(o1.getName()) - Integer.parseInt(o2.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//合并文件</span></span><br><span class="line">    <span class="keyword">for</span> (File chunkFile : fileList) &#123;</span><br><span class="line">        <span class="type">RandomAccessFile</span> <span class="variable">raf_read</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = raf_read.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        raf_read.close();</span><br><span class="line">    &#125;</span><br><span class="line">    raf_write.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验文件</span></span><br><span class="line">    <span class="keyword">try</span> (</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(originalFile);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">mergeFileStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);</span><br><span class="line"></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="comment">//取出原始文件的md5</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(fileInputStream);</span><br><span class="line">        <span class="comment">//取出合并文件的md5进行比较</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mergeFileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(mergeFileStream);</span><br><span class="line">        <span class="keyword">if</span> (originalMd5.equals(mergeFileMd5)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;合并文件失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6-2-3-视频上传流程"><a href="#6-2-3-视频上传流程" class="headerlink" title="6.2.3 视频上传流程"></a><strong>6.2.3 视频上传流程</strong></h5><p>下图是上传视频的整体流程：</p><p><img src="/breeze/e273b43/image82.png"></p><p>1、前端对文件进行分块。</p><p>2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。</p><p>3、如果分块文件不存在则前端开始上传</p><p>4、前端请求媒资服务上传分块。</p><p>5、媒资服务将分块上传至MinIO。</p><p>6、前端将分块上传完毕请求媒资服务合并分块。</p><p>7、媒资服务判断分块上传完成则请求MinIO合并文件。</p><p>8、合并完成校验合并后的文件是否完整，如果完整则上传完成，否则删除文件。</p><h5 id="6-2-4-minio合并文件测试"><a href="#6-2-4-minio合并文件测试" class="headerlink" title="6.2.4 minio合并文件测试"></a><strong>6.2.4 minio合并文件测试</strong></h5><p>1、将分块文件上传至minio</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将分块文件上传至minio</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadChunk</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFolderPath</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\upload\\chunk\\&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">chunkFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(chunkFolderPath);</span><br><span class="line">    <span class="comment">//分块文件</span></span><br><span class="line">    File[] files = chunkFolder.listFiles();</span><br><span class="line">    <span class="comment">//将分块文件上传至minio</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs</span><br><span class="line">                .builder()</span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                .object(<span class="string">&quot;chunk/&quot;</span> + i)</span><br><span class="line">                .filename(files[i].getAbsolutePath())</span><br><span class="line">                .build();</span><br><span class="line">            <span class="comment">// 上传文件</span></span><br><span class="line">            minioClient.uploadObject(uploadObjectArgs);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传分块成功&quot;</span>+i);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、通过minio的合并文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//合并文件，要求分块文件最小5M</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_merge</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">        .limit(<span class="number">6</span>)</span><br><span class="line">        .map(i -&gt; ComposeSource.builder()</span><br><span class="line">             .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">             .object(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i)))</span><br><span class="line">             .build())</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定合并后的objectName等信息</span></span><br><span class="line">    <span class="type">ComposeObjectArgs</span> <span class="variable">composeObjectArgs</span> <span class="operator">=</span> ComposeObjectArgs</span><br><span class="line">        .builder()</span><br><span class="line">        .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">        .object(<span class="string">&quot;merge01.mp4&quot;</span>)</span><br><span class="line">        .sources(sources).build();</span><br><span class="line">    <span class="comment">// 合并文件</span></span><br><span class="line">    minioClient.composeObject(composeObjectArgs);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//清除分块文件</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_removeObjects</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//合并分块完成将分块文件清除</span></span><br><span class="line">    List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">        .limit(<span class="number">6</span>)</span><br><span class="line">        .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i))))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;testbucket&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">    Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">    results.forEach(r-&gt;&#123;</span><br><span class="line">        <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            deleteError = r.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>代码分析：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;List&lt;ComposeSource&gt; sources = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">&gt;.limit(<span class="number">6</span>)</span><br><span class="line">&gt;.map(i -&gt; ComposeSource.builder()</span><br><span class="line">   .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">   .object(<span class="string">&quot;chunk/&quot;</span>.concat(Integer.toString(i)))</span><br><span class="line">   .build())</span><br><span class="line">&gt;.collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>这段代码使用 Java 8 中的 Stream API，创建了一个包含若干个 ComposeSource 对象的 List。</p><p>首先，Stream.iterate(0, i -&gt; ++i) 创建了一个无限长度的流，其中元素从 0 开始不断自增。接着，通过 limit(6) 方法将流元素数量限制为 6，避免无限循环。</p><p>接下来使用 map 方法将每个整数元素转换成一个 ComposeSource 对象。具体实现是通过调用 ComposeSource 类的 builder() 方法创建一个 Builder 对象，然后设置 bucket 和 object 字段的值并返回一个 ComposeSource 对象。</p><p>最后，使用 collect 方法将转换后的 ComposeSource 对象收集到一个 List 集合中并返回。</p><p>因此，上述代码的作用是创建一个包含 6 个 ComposeSource 对象的 List，这些对象的 bucket 值都为 “testbucket”，object 值分别为 “chunk&#x2F;1”、”chunk&#x2F;2”、”chunk&#x2F;3”、”chunk&#x2F;4”、”chunk&#x2F;5”、”chunk&#x2F;6”。该 List 可以用于进行某些操作，比如存储到数据库或远程服务等情形。</p></blockquote><p>使用minio合并文件报错：java.lang.IllegalArgumentException: source testbucket&#x2F;chunk&#x2F;0: size 1048576 must be greater than 5242880</p><p>minio合并文件默认分块最小5M，我们将分块改为5M再次测试。</p><h4 id="6-3-接口定义"><a href="#6-3-接口定义" class="headerlink" title="6.3 接口定义"></a><strong>6.3 接口定义</strong></h4><p>根据上传视频流程，定义接口，与前端的约定是操作成功返回{code:0}否则返回{code:-1}</p><p>从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p><p>定义接口如下：</p><p>现在<code>xuechneg-plus-base</code>模块下，添加模型类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 通用结果类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 14:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestResponse</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 响应编码,0为正常,-1错误</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 响应提示信息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 响应内容</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">0</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 错误信息的封装</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">validfail</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setCode(-<span class="number">1</span>);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">validfail</span><span class="params">(T result,String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setCode(-<span class="number">1</span>);</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加正常响应数据（包含响应内容）</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> RestResponse Rest服务封装相应数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T result,String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加正常响应数据（不包含响应内容）</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> RestResponse Rest服务封装相应数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">isSuccessful</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.code == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfo;</span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件上传接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;大文件上传接口&quot;, tags = &quot;大文件上传接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFilesController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                    <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>@RequestParam注解是接收什么类型的参数的？</strong></p><p>@RequestParam 注解用于从请求参数中获取单个值，可以用来接收以下类型的参数：</p><ul><li>基本数据类型：byte、short、int、long、float、double 等；</li><li>对应包装类：Byte、Short、Integer、Long、Float、Double 等；</li><li>String 类型；</li><li>如果参数是数组或集合，则该注解需要指定多次。</li></ul><p>在 Spring MVC 中的控制器方法中，通过使用 @RequestParam 注解，可以方便地获取 HTTP 请求中提交的参数值，并将其映射到对应的方法参数上。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">&gt;<span class="keyword">public</span> String <span class="title function_">getUser</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> <span class="type">int</span> userId, Model model)</span> &#123;</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserById(userId);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure><p>在上述例子中，@RequestParam(“id”) 注解表示从请求参数中获取名为 “id” 的参数值，转换成 int 类型后赋值给 userId 参数。这样就能够获得由客户端传递过来的 id 参数值，然后根据该 id 值查找对应的用户信息。</p><p><strong>接收url中的参数，用什么注解?</strong></p><p>接收 URL 中的参数可以使用 <code>@PathVariable</code> 注解。这个注解用于将 URI 模板变量绑定到控制器处理方法的参数上，从而获得 URI 中的动态数据。</p><p>例如，在处理 REST 风格的 API 中，可以通过以下方式来接收 id 参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">&gt;<span class="keyword">public</span> String <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> userId, Model model)</span> &#123;</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUserById(userId);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line">&gt;&#125;</span><br></pre></td></tr></table></figure><p>在上述例子中，<code>@PathVariable(&quot;id&quot;)</code> 注解表示将 URI 模板变量 <code>&#123;id&#125;</code> 绑定到 userId 参数上，此时 userId 参数的值就是用户请求中 URL 的 &#x2F;user&#x2F;{id} 中的 {id} 内容。</p><p>需要注意的是，<code>@PathVariable</code> 注解的参数名称必须与 URI 中的变量名相同，否则无法正确绑定。当然也可以通过 <code>@PathVariable</code> 注解的<code>value</code>属性指定参数名，例如：<code>@PathVariable(value = &quot;id&quot;)</code>。</p></blockquote><h4 id="6-4-上传分块开发"><a href="#6-4-上传分块开发" class="headerlink" title="6.4 上传分块开发"></a><strong>6.4 上传分块开发</strong></h4><h5 id="6-4-1-DAO开发"><a href="#6-4-1-DAO开发" class="headerlink" title="6.4.1 DAO开发"></a><strong>6.4.1 DAO开发</strong></h5><p>向媒资数据库的文件表插入记录，使用自动生成的Mapper接口即可满足要求。</p><h5 id="6-4-2-Service开发"><a href="#6-4-2-Service开发" class="headerlink" title="6.4.2 Service开发"></a><strong>6.4.2 Service开发</strong></h5><h6 id="6-4-2-1-检查文件和分块"><a href="#6-4-2-1-检查文件和分块" class="headerlink" title="6.4.2.1 检查文件和分块"></a><strong>6.4.2.1 检查文件和分块</strong></h6><p>接口完成进行接口实现，首先实现检查文件方法和检查分块方法。</p><p>在MediaFileService中定义service接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查文件是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:38</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 检查分块是否存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件的md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkIndex  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:39</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br></pre></td></tr></table></figure><p>service接口实现方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="comment">//查询文件信息</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//桶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">        <span class="comment">//存储目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">        <span class="comment">//文件流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = minioClient.getObject(</span><br><span class="line">                GetObjectArgs.builder()</span><br><span class="line">                .bucket(bucket)</span><br><span class="line">                .object(filePath)</span><br><span class="line">                .build());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//文件已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//文件不存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件目录</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件流</span></span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fileInputStream = minioClient.getObject(</span><br><span class="line">            GetObjectArgs.builder()</span><br><span class="line">            .bucket(bucket_video)</span><br><span class="line">            .object(chunkFilePath)</span><br><span class="line">            .build());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//分块已存在</span></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分块未存在</span></span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到分块文件的目录</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h6 id="6-4-2-2-上传分块"><a href="#6-4-2-2-上传分块" class="headerlink" title="6.4.2.2 上传分块"></a><strong>6.4.2.2 上传分块</strong></h6><p>定义service接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunk  分块序号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localChunkFilePath  分块文件本地路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,String localChunkFilePath)</span>;</span><br></pre></td></tr></table></figure><p>接口实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, String localChunkFilePath)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//得到分块文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunk; <span class="comment">// 注意这里的chunk是分块文件的序号，不是目录</span></span><br><span class="line">    <span class="comment">//mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//将文件存储至minIO</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> addMediaFilesToMinIO(localChunkFilePath, mimeType, bucket_videoFiles, chunkFilePath);</span><br><span class="line">    <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;上传分块文件失败:&#123;&#125;&quot;</span>, chunkFilePath);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;上传分块失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.debug(<span class="string">&quot;上传分块文件成功:&#123;&#125;&quot;</span>,chunkFilePath);</span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="6-4-2-3-上传分块测试"><a href="#6-4-2-3-上传分块测试" class="headerlink" title="6.4.2.3 上传分块测试"></a><strong>6.4.2.3 上传分块测试</strong></h6><p>完善接口层：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;文件上传前检查文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkFile(fileMd5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;分块文件上传前的检测&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                        <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.checkChunk(fileMd5,chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;上传分块文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tempFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    <span class="comment">//上传的文件拷贝到临时文件</span></span><br><span class="line">    file.transferTo(tempFile);</span><br><span class="line">    <span class="comment">//文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">absolutePath</span> <span class="operator">=</span> tempFile.getAbsolutePath();</span><br><span class="line">    <span class="keyword">return</span> mediaFileService.uploadChunk(fileMd5,chunk,absolutePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>启动前端工程，进入上传视频界面进行前后端联调测试。</p><blockquote><p><strong><font color="red">总结一下文件上传的流程：</font></strong></p><ol><li>本地上传文件到前端</li><li>前端将上传的文件进行分块</li><li>然后将分块的文件传给媒资服务</li><li>媒资服务接收分块文件并保存到本地临时文件</li><li>媒资服务将文件上传到minio（<font color="red">注意：这里还没有将文件信息保存到表中。要将文件合并之后，才会将信息合并到表中</font>）</li></ol></blockquote><p>前端对文件分块的大小为5MB，SpringBoot web默认上传文件的大小限制为1MB，这里需要在media-api工程修改配置如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">50MB</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">50MB</span></span><br></pre></td></tr></table></figure><p>max-file-size：单个文件的大小限制</p><p>Max-request-size: 单次请求的大小限制</p><h4 id="6-5-合并分块开发"><a href="#6-5-合并分块开发" class="headerlink" title="6.5 合并分块开发"></a><strong>6.5 合并分块开发</strong></h4><h5 id="6-5-1-service开发"><a href="#6-5-1-service开发" class="headerlink" title="6.5.1 service开发"></a><strong>6.5.1 service开发</strong></h5><p>定义service接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 合并分块</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId  机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5  文件md5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 15:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId,String fileMd5,<span class="type">int</span> chunkTotal,UploadFileParamsDto uploadFileParamsDto)</span>;</span><br></pre></td></tr></table></figure><p>service实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">    <span class="comment">//=====获取分块文件路径=====</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">    <span class="comment">//组成将分块文件路径组成 List&lt;ComposeSource&gt;</span></span><br><span class="line">    List&lt;ComposeSource&gt; sourceObjectList = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">        .limit(chunkTotal)</span><br><span class="line">        .map(i -&gt; ComposeSource.builder()</span><br><span class="line">             .bucket(bucket_videoFiles)</span><br><span class="line">             .object(chunkFileFolderPath.concat(Integer.toString(i)))</span><br><span class="line">             .build())</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//=====合并=====</span></span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//合并文件路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mergeFilePath</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//合并文件</span></span><br><span class="line">        <span class="type">ObjectWriteResponse</span> <span class="variable">response</span> <span class="operator">=</span> minioClient.composeObject(</span><br><span class="line">            ComposeObjectArgs.builder()</span><br><span class="line">            .bucket(bucket_videoFiles)</span><br><span class="line">            .object(mergeFilePath)</span><br><span class="line">            .sources(sourceObjectList)</span><br><span class="line">            .build());</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件成功:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;合并文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;合并文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ====验证md5====</span></span><br><span class="line">    <span class="comment">//下载合并后的文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> downloadFileFromMinIO(bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="keyword">if</span>(minioFile == <span class="literal">null</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;下载合并后文件失败,mergeFilePath:&#123;&#125;&quot;</span>,mergeFilePath);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;下载合并后文件失败。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">newFileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(minioFile)) &#123;</span><br><span class="line">        <span class="comment">//minio上文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Hex</span> <span class="operator">=</span> DigestUtils.md5Hex(newFileInputStream);</span><br><span class="line">        <span class="comment">//比较md5值，不一致则说明文件不完整</span></span><br><span class="line">        <span class="keyword">if</span>(!fileMd5.equals(md5Hex))&#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件大小</span></span><br><span class="line">        uploadFileParamsDto.setFileSize(minioFile.length());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;校验文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;&quot;</span>,fileMd5,e.getMessage(),e);</span><br><span class="line">        <span class="keyword">return</span> RestResponse.validfail(<span class="literal">false</span>, <span class="string">&quot;文件合并校验失败，最终上传失败。&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(minioFile!=<span class="literal">null</span>)&#123;</span><br><span class="line">            minioFile.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//文件入库</span></span><br><span class="line">    currentProxy.addMediaFilesToDb(companyId,fileMd5,uploadFileParamsDto,bucket_videoFiles,mergeFilePath);</span><br><span class="line">    <span class="comment">//=====清除分块文件=====</span></span><br><span class="line">    clearChunkFiles(chunkFileFolderPath,chunkTotal);</span><br><span class="line">    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从minio下载文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 下载后的文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(String bucket,String objectName)</span>&#123;</span><br><span class="line">    <span class="comment">//临时文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">minioFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> minioClient.getObject(GetObjectArgs.builder()</span><br><span class="line">                                                   .bucket(bucket)</span><br><span class="line">                                                   .object(objectName)</span><br><span class="line">                                                   .build());</span><br><span class="line">        <span class="comment">//创建临时文件</span></span><br><span class="line">        minioFile=File.createTempFile(<span class="string">&quot;minio&quot;</span>, <span class="string">&quot;.merge&quot;</span>);</span><br><span class="line">        outputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(minioFile);</span><br><span class="line">        IOUtils.copy(stream,outputStream);</span><br><span class="line">        <span class="keyword">return</span> minioFile;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(outputStream!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到合并后的文件的地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileMd5 文件id即md5值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileExt 文件扩展名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getFilePathByMd5</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清除分块文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkFileFolderPath 分块文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chunkTotal 分块文件总数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearChunkFiles</span><span class="params">(String chunkFileFolderPath,<span class="type">int</span> chunkTotal)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;DeleteObject&gt; deleteObjects = Stream.iterate(<span class="number">0</span>, i -&gt; ++i)</span><br><span class="line">            .limit(chunkTotal)</span><br><span class="line">            .map(i -&gt; <span class="keyword">new</span> <span class="title class_">DeleteObject</span>(chunkFileFolderPath.concat(Integer.toString(i))))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="type">RemoveObjectsArgs</span> <span class="variable">removeObjectsArgs</span> <span class="operator">=</span> RemoveObjectsArgs.builder().bucket(<span class="string">&quot;video&quot;</span>).objects(deleteObjects).build();</span><br><span class="line">        Iterable&lt;Result&lt;DeleteError&gt;&gt; results = minioClient.removeObjects(removeObjectsArgs);</span><br><span class="line">        results.forEach(r-&gt;&#123;</span><br><span class="line">            <span class="type">DeleteError</span> <span class="variable">deleteError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                deleteError = r.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.error(<span class="string">&quot;清楚分块文件失败,objectname:&#123;&#125;&quot;</span>,deleteError.objectName(),e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;清楚分块文件失败,chunkFileFolderPath:&#123;&#125;&quot;</span>,chunkFileFolderPath,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6-5-2-接口层完善"><a href="#6-5-2-接口层完善" class="headerlink" title="6.5.2 接口层完善"></a><strong>6.5.2 接口层完善</strong></h5><p>下边完善接口层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;合并文件&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line"><span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(<span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">                                <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">    uploadFileParamsDto.setFileType(<span class="string">&quot;001002&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setTags(<span class="string">&quot;课程视频&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setRemark(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    uploadFileParamsDto.setFilename(fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mediaFileService.mergechunks(companyId,fileMd5,chunkTotal,uploadFileParamsDto);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6-5-2-合并分块测试"><a href="#6-5-2-合并分块测试" class="headerlink" title="6.5.2 合并分块测试"></a><strong>6.5.2 合并分块测试</strong></h5><p>下边进行前后端联调：</p><p>1、上传一个视频测试合并分块的执行逻辑</p><p>进入service方法逐行跟踪。</p><p>2、断点续传测试</p><p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p><p><img src="/breeze/e273b43/image83.png"></p><h3 id="7-视频处理"><a href="#7-视频处理" class="headerlink" title="7 视频处理"></a><strong>7 视频处理</strong></h3><h4 id="7-1-视频转码需求"><a href="#7-1-视频转码需求" class="headerlink" title="7.1 视频转码需求"></a><strong>7.1 视频转码需求</strong></h4><h5 id="7-1-1-什么是视频编码"><a href="#7-1-1-什么是视频编码" class="headerlink" title="7.1.1 什么是视频编码"></a><strong>7.1.1 什么是视频编码</strong></h5><p>视频上传成功后需要对视频进行转码处理。</p><p>什么是视频编码？查阅百度百科如下：</p><p><img src="/breeze/e273b43/image84.png"></p><p>详情参考 ：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038">https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038</a></p><p>首先我们要分清文件格式和编码格式：</p><p>文件格式：是指.mp4、.avi、.rmvb等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p><p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi的视频文件原来的编码是a，通过编码后编码格式变为b，音频原来为c，通过编码后变为d。</p><p>音视频编码格式各类繁多，主要有几下几类：</p><p>MPEG系列</p><p>（由ISO[国际标准组织机构]下属的MPEG[运动图象专家组]开发 ）视频编码方面主要是Mpeg1（vcd用的就是它）、Mpeg2（DVD使用）、Mpeg4（的DVDRIP使用的都是它的变种，如：divx，xvid等）、Mpeg4 AVC（正热门）；音频编码方面主要是MPEG Audio Layer 1&#x2F;2、MPEG Audio Layer 3（大名鼎鼎的mp3）、MPEG-2 AAC 、MPEG-4 AAC等等。注意：DVD音频没有采用Mpeg的。</p><p>H.26X系列</p><p>（由ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p><p>包括H.261、H.262、H.263、H.263+、H.263++、H.264（就是MPEG4 AVC-合作的结晶）</p><p>目前最常用的编码标准是视频H.264，音频AAC。</p><p>提问：</p><p>H.264是编码格式还是文件格式？</p><p>mp4是编码格式还是文件格式？</p><h5 id="7-1-2-FFmpeg-的基本使用"><a href="#7-1-2-FFmpeg-的基本使用" class="headerlink" title="7.1.2 FFmpeg 的基本使用"></a><strong>7.1.2 FFmpeg 的基本使用</strong></h5><p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目 使用FFmpeg对视频进行编码 。</p><p><img src="/breeze/e273b43/image85.png"></p><p>FFmpeg被许多开源项目采用，QQ影音、暴风影音、VLC等。</p><p>下载：FFmpeg <a target="_blank" rel="noopener" href="https://www.ffmpeg.org/download.html#build-windows">https://www.ffmpeg.org/download.html#build-windows</a></p><p>请从常用工具软件目录找到ffmpeg.exe，并将ffmpeg.exe加入环境变量path中。</p><p>测试是否正常：cmd运行 ffmpeg -version</p><p><img src="/breeze/e273b43/image86.png"></p><p>安装成功，作下简单测试</p><p>将一个.avi文件转成mp4、mp3、gif等。</p><p>比如我们将nacos.avi文件转成mp4，运行如下命令：</p><p>D:\soft\ffmpeg\ffmpeg.exe -i 1.avi 1.mp4</p><p>可以将ffmpeg.exe配置到环境变量path中，进入视频目录直接运行：ffmpeg.exe -i 1.avi 1.mp4</p><p>转成mp3：ffmpeg -i nacos.avi nacos.mp3</p><p>转成gif：ffmpeg -i nacos.avi nacos.gif</p><p>官方文档（英文）：<a target="_blank" rel="noopener" href="http://ffmpeg.org/ffmpeg.html">http://ffmpeg.org/ffmpeg.html</a></p><h5 id="7-1-3-视频处理工具类"><a href="#7-1-3-视频处理工具类" class="headerlink" title="7.1.3 视频处理工具类"></a><strong>7.1.3 视频处理工具类</strong></h5><p>将课程资料的工具类中的util拷贝至base工程。</p><p><img src="/breeze/e273b43/image87.png"></p><p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p><p>下边看下这个类的代码，并进行测试。</p><p>我们要通过ffmpeg对视频转码，Java程序调用ffmpeg，使用java.lang.ProcessBuilder去完成，具体在Mp4VideoUtil类的63行，下边进行简单的测试，下边的代码运行本机安装的QQ软件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line">builder.command(<span class="string">&quot;C:\\Program Files (x86)\\Tencent\\QQ\\Bin\\QQScLauncher.exe&quot;</span>);</span><br><span class="line"><span class="comment">//将标准输入流和错误输入流合并，通过标准输入流程读取信息</span></span><br><span class="line">builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> builder.start();</span><br></pre></td></tr></table></figure><p>对Mp4VideoUtil类需要学习使用方法，下边代码将一个avi视频转为mp4视频，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//ffmpeg的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ffmpeg_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span>;<span class="comment">//ffmpeg的安装位置</span></span><br><span class="line">    <span class="comment">//源avi视频的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">video_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_name</span> <span class="operator">=</span> <span class="string">&quot;nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//创建工具类对象</span></span><br><span class="line">    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpeg_path,video_path,mp4_name,mp4_path);</span><br><span class="line">    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> videoUtil.generateMp4();</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行main方法，最终在控制台输出 success 表示执行成功。</p><h4 id="7-2-分布式任务处理"><a href="#7-2-分布式任务处理" class="headerlink" title="7.2 分布式任务处理"></a><strong>7.2 分布式任务处理</strong></h4><h5 id="7-2-1-什么是分布式任务调度"><a href="#7-2-1-什么是分布式任务调度" class="headerlink" title="7.2.1 什么是分布式任务调度"></a><strong>7.2.1 什么是分布式任务调度</strong></h5><p>对一个视频的转码可以理解为一个任务的执行，如果视频的数量比较多，如何去高效处理一批任务呢？</p><p>1、多线程</p><p>多线程是充分利用单机的资源。</p><p>2、分布式加多线程</p><p>充分利用多台计算机，每台计算机使用多线程处理。</p><p>方案2可扩展性更强。</p><p>方案2是一种分布式任务调度的处理方案。</p><p>什么是分布式任务调度？</p><p>我们可以先思考一下下面业务场景的解决方案：</p><p>每隔24小时执行数据备份任务。</p><p>12306网站会根据车次不同，设置几个时间点分批次放票。</p><p>某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p><p>商品成功发货后，需要向客户发送短信提醒。</p><p>类似的场景还有很多，我们该如何实现？</p><p><strong>多线程方式实现：</strong></p><p>学过多线程的同学，可能会想到，我们可以开启一个线程，每sleep一段时间，就去检查是否已到预期执行时间。</p><p>以下代码简单实现了任务调度的功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    </span><br><span class="line">    <span class="comment">//任务执行间隔时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeInterval</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(timeInterval);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p><p>Jdk也为我们提供了相关支持，如Timer、ScheduledExecutor，下边我们了解下。</p><p><strong>Timer方式实现</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();  </span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">            <span class="comment">//TODO：something</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;, <span class="number">1000</span>, <span class="number">2000</span>);  <span class="comment">//1秒后开始调度，每2秒执行一次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Timer 的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行。</p><p><strong>ScheduledExecutor方式实现</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    service.scheduleAtFixedRate(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>,</span><br><span class="line">        <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java 5 推出了基于线程池设计的 ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p><p>Timer 和 ScheduledExecutor 都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每月第一天凌晨1点执行任务、复杂调度任务的管理、任务间传递数据等等。</p><p><strong>第三方Quartz方式实现，项目地址：<a target="_blank" rel="noopener" href="https://github.com/quartz-scheduler/quartz">https://github.com/quartz-scheduler/quartz</a></strong></p><p>Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p><p>下边是一个例子代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span> <span class="keyword">throws</span> SchedulerException &#123;</span><br><span class="line">    <span class="comment">//创建一个Scheduler</span></span><br><span class="line">    <span class="type">SchedulerFactory</span> <span class="variable">schedulerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>();</span><br><span class="line">    <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactory.getScheduler();</span><br><span class="line">    <span class="comment">//创建JobDetail</span></span><br><span class="line">    <span class="type">JobBuilder</span> <span class="variable">jobDetailBuilder</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class);</span><br><span class="line">    jobDetailBuilder.withIdentity(<span class="string">&quot;jobName&quot;</span>,<span class="string">&quot;jobGroupName&quot;</span>);</span><br><span class="line">    <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> jobDetailBuilder.build();</span><br><span class="line">    <span class="comment">//创建触发的CronTrigger 支持按日历调度</span></span><br><span class="line">    <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger()</span><br><span class="line">        .withIdentity(<span class="string">&quot;triggerName&quot;</span>, <span class="string">&quot;triggerGroupName&quot;</span>)</span><br><span class="line">        .startNow()</span><br><span class="line">        .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/2 * * * * ?&quot;</span>))</span><br><span class="line">        .build();</span><br><span class="line">    scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">    scheduler.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p><p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p><p><strong>什么是分布式任务调度？</strong></p><p>通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p><p><img src="/breeze/e273b43/image88.png"></p><p><strong>分布式调度要实现的目标：</strong></p><p>不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p><p>1、并行任务调度</p><p>并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p><p>如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p><p>2、高可用</p><p>若某一个实例宕机，不影响其他实例来执行任务。</p><p>3、弹性扩容</p><p>当集群中增加实例就可以提高并执行任务的处理效率。</p><p>4、任务管理与监测</p><p>对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p><p>5、避免任务重复执行</p><p>当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p><h5 id="7-2-2-XXL-JOB介绍"><a href="#7-2-2-XXL-JOB介绍" class="headerlink" title="7.2.2 XXL-JOB介绍"></a><strong>7.2.2 XXL-JOB介绍</strong></h5><p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p><p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p><p>文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</a></p><p>XXL-JOB主要有调度中心、执行器、任务：</p><p><img src="/breeze/e273b43/image89.png"></p><p><strong>调度中心：</strong></p><p>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p><p>主要职责为执行器管理、任务管理、监控运维、日志管理等</p><p><strong>任务执行器：</strong></p><p>负责接收调度请求并执行任务逻辑；</p><p>只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p><p><strong>任务：</strong>负责执行具体的业务处理。</p><p>调度中心与执行器之间的工作流程如下：</p><p><img src="/breeze/e273b43/image90.png"></p><p><strong>执行流程：</strong></p><p>1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p><p>2.达到任务触发条件，调度中心下发任务</p><p>3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p><p>4.执行器消费内存队列中的执行结果，主动上报给调度中心</p><p>5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p><h5 id="7-2-3-搭建XXL-JOB"><a href="#7-2-3-搭建XXL-JOB" class="headerlink" title="7.2.3 搭建XXL-JOB"></a><strong>7.2.3 搭建XXL-JOB</strong></h5><h6 id="7-2-3-1-调度中心"><a href="#7-2-3-1-调度中心" class="headerlink" title="7.2.3.1 调度中心"></a><strong>7.2.3.1 调度中心</strong></h6><p>首先下载XXL-JOB</p><p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></p><p>码云：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></p><p>项目使用2.3.1版本： <a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></p><p>也可从课程资料目录获取，解压xxl-job-2.3.1.zip</p><p>使用IDEA打开解压后的目录</p><p><img src="/breeze/e273b43/image91.png"></p><p>xxl-job-admin：调度中心</p><p>xxl-job-core：公共依赖</p><p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p><p>：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p><p>：xxl-job-executor-sample-frameless：无框架版本；</p><p>doc :文档资料，包含数据库脚本</p><p>在下发的虚拟机的MySQL中已经创建了xxl_job_2.3.1数据库</p><p><img src="/breeze/e273b43/image92.png"></p><p>如下图：</p><p><img src="/breeze/e273b43/image93.png"></p><p>执行sh &#x2F;data&#x2F;soft&#x2F;restart.sh自动启动xxl-job调度中心</p><p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:8088/xxl-job-admin/">http://192.168.101.65:8088/xxl-job-admin/</a></p><p>账号和密码：admin&#x2F;123456</p><p>如果无法使用虚拟机运行xxl-job可以在本机idea运行xxl-job调度中心。</p><h6 id="7-2-3-2-执行器"><a href="#7-2-3-2-执行器" class="headerlink" title="7.2.3.2 执行器"></a><strong>7.2.3.2 执行器</strong></h6><p>下边配置执行器，执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p><p>1、下边进入调度中心添加执行器</p><p><img src="/breeze/e273b43/image94.png"></p><p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p><p><img src="/breeze/e273b43/image95.png"></p><p>添加成功：</p><p><img src="/breeze/e273b43/image96.png"></p><p>2、首先在媒资管理模块的service工程添加依赖，在项目的父工程已约定了版本2.3.1</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3、在nacos下的media-service-dev.yaml下配置xxl-job</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-process-service</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure><p>注意配置中的appname这是执行器的应用名，port是执行器启动的端口，如果本地启动多个执行器注意端口不能重复。</p><p>4、配置xxl-job的执行器</p><p>将xxl-job示例工程下配置类拷贝到媒资管理的service工程下</p><p><img src="/breeze/e273b43/image97.png"></p><p>拷贝至：</p><p><img src="/breeze/e273b43/image98.png"></p><p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动媒资管理模块的接口工程。</p><p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p><p><img src="/breeze/e273b43/image99.png"></p><p>同时观察调度中心中的执行器界面</p><p><img src="/breeze/e273b43/image100.png"></p><p>在线机器地址处已显示1个执行器。</p><h6 id="7-2-3-3-执行任务"><a href="#7-2-3-3-执行任务" class="headerlink" title="7.2.3.3 执行任务"></a><strong>7.2.3.3 执行任务</strong></h6><p>下边编写任务，参考示例工程中任务类的编写方法，如下图：</p><p><img src="/breeze/e273b43/image101.png"></p><p>在媒资服务service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试执行器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/13 20:32</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Component</span></span><br><span class="line"> <span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleJob</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@XxlJob(&quot;testJob&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  log.info(<span class="string">&quot;开始执行.....&quot;</span>);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下边在调度中心添加任务，进入任务管理</p><p><img src="/breeze/e273b43/image102.png"></p><p>点击新增，填写任务信息</p><p><img src="/breeze/e273b43/image103.png"></p><p>注意红色标记处：</p><p>调度类型：</p><p>固定速度指按固定的间隔定时调度。</p><p>Cron，通过Cron表达式实现更丰富的定时调度策略。</p><p>Cron表达式是一个字符串，通过它可以定义调度策略，格式如下：</p><p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p><p>xxl-job提供图形界面去配置：</p><p><img src="/breeze/e273b43/image104.png"></p><p>一些例子如下：</p><p>30 10 1 * * ? 每天1点10分30秒触发</p><p>0&#x2F;30 * * * * ? 每30秒触发一次</p><p>* 0&#x2F;10 * * * ? 每10分钟触发一次</p><p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p><p>JobHandler即任务方法名，填写任务方法上边@XxlJob注解中的名称。</p><p>路由策略：当执行器集群部署时，调度中心向哪个执行器下发任务，这里选择第一个表示只向第一个执行器下发任务，路由策略的其它选项稍后在分片广播章节详细解释。</p><p>高级配置的其它配置项稍后在分片广播章节详细解释。</p><p>添加成功，启动任务</p><p><img src="/breeze/e273b43/image105.png"></p><p>通过调度日志查看任务执行情况</p><p><img src="/breeze/e273b43/image106.png"></p><p>下边启动媒资管理的service工程，启动执行器。</p><p>观察执行器方法的执行。</p><p><img src="/breeze/e273b43/image107.png"></p><p>如果要停止任务需要在调度中心操作</p><p><img src="/breeze/e273b43/image108.png"></p><p>任务跑一段时间注意清理日志</p><p><img src="/breeze/e273b43/image109.png"></p><h5 id="7-2-4-分片广播"><a href="#7-2-4-分片广播" class="headerlink" title="7.2.4 分片广播"></a><strong>7.2.4 分片广播</strong></h5><p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p><p><img src="/breeze/e273b43/image110.png"></p><p>执行器在集群部署下调度中心有哪些路由策略呢？</p><p>查看xxl-job官方文档，阅读高级配置相关的内容：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">高级配置：</span><br><span class="line">    - 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span><br><span class="line">        FIRST（第一个）：固定选择第一个机器；</span><br><span class="line">        LAST（最后一个）：固定选择最后一个机器；</span><br><span class="line">        ROUND（轮询）：；</span><br><span class="line">        RANDOM（随机）：随机选择在线的机器；</span><br><span class="line">        CONSISTENT<span class="built_in">_</span>HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span><br><span class="line">        LEAST<span class="built_in">_</span>FREQUENTLY<span class="built_in">_</span>USED（最不经常使用）：使用频率最低的机器优先被选举；</span><br><span class="line">        LEAST<span class="built_in">_</span>RECENTLY<span class="built_in">_</span>USED（最近最久未使用）：最久未使用的机器优先被选举；</span><br><span class="line">        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span><br><span class="line">        SHARDING<span class="built_in">_</span>BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span><br><span class="line"></span><br><span class="line">    - 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。</span><br><span class="line">    - 调度过期策略：</span><br><span class="line">        - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</span><br><span class="line">        - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</span><br><span class="line">    - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span><br><span class="line">        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span><br><span class="line">        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span><br><span class="line">        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span><br><span class="line">    - 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span><br><span class="line">    - 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span><br></pre></td></tr></table></figure><p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3…，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p><p>如下图：</p><p><img src="/breeze/e273b43/image111.png"></p><p>每个执行器收到调度请求同时接收分片参数。</p><p>xxl-job支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p><p><strong>作业分片适用哪些场景呢？</strong></p><p>分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p><p>广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p><p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p><p><strong>使用说明：</strong></p><p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p><p>Java语言任务获取分片参数方式：</p><p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务”ShardingJobHandler”：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2、分片广播任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 分片序号，从0开始（执行器的序号，从0开始）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="comment">// 分片总数（执行器总数）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure><p>下边测试作业分片：</p><p>1、定义作业分片的任务方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 2、分片广播任务</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分片参数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">    <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;&quot;</span>, shardIndex, shardTotal);</span><br><span class="line">    log.info(<span class="string">&quot;开始执行第&quot;</span>+shardIndex+<span class="string">&quot;批任务&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、在调度中心添加任务</p><p><img src="/breeze/e273b43/image112.png"></p><p>添加成功：</p><p><img src="/breeze/e273b43/image113.png"></p><p>启动任务，观察日志</p><p><img src="/breeze/e273b43/image114.png"></p><p>下边启动两个执行器实例，观察每个实例的执行情况</p><p>首先在nacos中配置media-service的本地优先配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置本地优先</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>将media-service启动两个实例</p><p>两个实例的在启动时注意端口不能冲突：</p><p>实例1 在VM options处添加：-Dserver.port&#x3D;63051 -Dxxl.job.executor.port&#x3D;9998</p><p>实例2 在VM options处添加：-Dserver.port&#x3D;63050 -Dxxl.job.executor.port&#x3D;9999</p><p>例如：</p><p><img src="/breeze/e273b43/image115.png"></p><p>启动两个实例</p><p>观察任务调度中心，稍等片刻执行器有两个</p><p><img src="/breeze/e273b43/image116.png"></p><p>观察两个执行实例的日志：</p><p><img src="/breeze/e273b43/image117.png"></p><p>另一实例的日志如下：</p><p><img src="/breeze/e273b43/image118.png"></p><p>从日志可以看每个实例的分片序号不同。</p><p>如果其中一个执行器挂掉，只剩下一个执行器在工作，稍等片刻调用中心发现少了一个执行器将动态调整总分片数为1。</p><p>到此作业分片任务调试完成，此时我们可以思考：</p><p><font color="red">当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</font></p><h4 id="7-3-技术方案"><a href="#7-3-技术方案" class="headerlink" title="7.3 技术方案"></a><strong>7.3 技术方案</strong></h4><h5 id="7-3-1-作业分片方案"><a href="#7-3-1-作业分片方案" class="headerlink" title="7.3.1 作业分片方案"></a><strong>7.3.1 作业分片方案</strong></h5><p>掌握了xxl-job的分片广播调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p><p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，<font color="purple">此时如何保证多个执行器不会查询到重复的任务呢？</font></p><p>XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号，在向执行器任务调度的同时下发分片总数以及分片序号等参数，执行器收到这些参数根据自己的业务需求去利用这些参数。</p><p>下图表示了多个执行器获取视频处理任务的结构：</p><p><img src="/breeze/e273b43/image119.png"></p><p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p><p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p><p>1 % 2 &#x3D; 1 执行器2执行</p><p>2 % 2 &#x3D; 0 执行器1执行</p><p>3 % 2 &#x3D; 1 执行器2执行</p><p>以此类推.</p><h5 id="7-3-2-保证任务不重复执行"><a href="#7-3-2-保证任务不重复执行" class="headerlink" title="7.3.2 保证任务不重复执行"></a><strong>7.3.2 保证任务不重复执行</strong></h5><p>&#x3D;&#x3D;通过作业分片方案保证了执行器之间查询到不重复的任务，如果一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？&#x3D;&#x3D;</p><p>首先配置调度过期策略：</p><p>查看文档如下：</p><p>- 调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</p><ul><li>忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</li><li>立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</li><li>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</li></ul><p>这里我们选择忽略，如果立即执行一次就可能重复执行相同的任务。</p><p><img src="/breeze/e273b43/image120.png"></p><p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束时调度中心进行任务调度，此时该如何处理。</p><p>查看文档如下：<br>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；<br>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；<br>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p><p>这里如果选择覆盖之前调度则可能重复执行任务，这里选择 丢弃后续调度或单机串行方式来避免任务重复执行。</p><p>只做这些配置可以保证任务不会重复执行吗？</p><p>做不到，还需要保证任务处理的幂等性，&#x3D;&#x3D;什么是任务的幂等性？&#x3D;&#x3D;任务的幂等性是指：对于数据的操作不论多少次，操作的结果始终是一致的。在本项目中要实现的是不论多少次任务调度同一个视频只执行一次成功的转码。</p><p>&#x3D;&#x3D;什么是幂等性？&#x3D;&#x3D;</p><p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p><p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p><p>解决幂等性常用的方案：</p><p>1）数据库约束，比如：唯一索引，主键。</p><p>2）乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p><p>3）唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p><p>基于以上分析，在执行器接收调度请求去执行视频处理任务时要实现视频处理的幂等性，要有办法去判断该视频是否处理完成，如果正在处理中或处理完则不再处理。这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p><h5 id="7-3-3-视频处理方案"><a href="#7-3-3-视频处理方案" class="headerlink" title="7.3.3 视频处理方案"></a><strong>7.3.3 视频处理方案</strong></h5><p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p><p><img src="/breeze/e273b43/image121.png"></p><p>上传视频成功向视频处理待处理表添加记录。</p><p>视频处理的详细流程如下：</p><p><img src="/breeze/e273b43/image122.png"></p><p>1、任务调度中心广播作业分片。</p><p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p><p>3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p><p>4、执行器启动多线程去处理任务。</p><p>5、任务处理完成，上传处理后的视频到MinIO。</p><p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p><h4 id="7-4-查询待处理任务"><a href="#7-4-查询待处理任务" class="headerlink" title="7.4 查询待处理任务"></a><strong>7.4 查询待处理任务</strong></h4><h5 id="7-4-1-需求分析"><a href="#7-4-1-需求分析" class="headerlink" title="7.4.1 需求分析"></a><strong>7.4.1 需求分析</strong></h5><p>查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试3次。</p><p>任务处理成功将待处理记录移动到历史任务表。</p><p>下图是待处理任务表：</p><p><img src="/breeze/e273b43/image123.png"></p><p>历史任务表与待处理任务表的结构相同。</p><h5 id="7-4-2添加待处理任务"><a href="#7-4-2添加待处理任务" class="headerlink" title="7.4.2添加待处理任务"></a><strong>7.4.2添加待处理任务</strong></h5><p>上传视频成功向视频处理待处理表添加记录，暂时只添加对avi视频的处理记录。</p><p>根据MIME Type去判断是否是avi视频，下边列出部分MIME Type</p><p><img src="/breeze/e273b43/image124.png"></p><p>avi视频的MIME Type是video&#x2F;x-msvideo</p><p>修改文件信息入库方法，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDb</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket, String objectName)</span> &#123;</span><br><span class="line">    <span class="comment">//从数据库查询文件</span></span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">    <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">        mediaFiles = <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//拷贝基本信息</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        <span class="comment">//媒体类型</span></span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setBucket(bucket);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002003&quot;</span>);</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//保存文件信息到文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;保存文件信息到数据库失败,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加到待处理任务表</span></span><br><span class="line">        addWaitingTask(mediaFiles);</span><br><span class="line">        log.debug(<span class="string">&quot;保存文件信息到数据库成功,&#123;&#125;&quot;</span>, mediaFiles.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加待处理任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaFiles 媒资文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWaitingTask</span><span class="params">(MediaFiles mediaFiles)</span>&#123;</span><br><span class="line">    <span class="comment">//文件名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaFiles.getFilename();</span><br><span class="line">    <span class="comment">//文件扩展名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//文件mimeType</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getMimeType(extension);</span><br><span class="line">    <span class="comment">//如果是avi视频添加到视频待处理表</span></span><br><span class="line">    <span class="keyword">if</span>(mimeType.equals(<span class="string">&quot;video/x-msvideo&quot;</span>))&#123;</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaFiles,mediaProcess);</span><br><span class="line">        mediaProcess.setStatus(<span class="string">&quot;1&quot;</span>);<span class="comment">//未处理</span></span><br><span class="line">        mediaProcess.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaProcess.setFailCount(<span class="number">0</span>);<span class="comment">//失败次数默认为0</span></span><br><span class="line">        mediaProcess.setUrl(<span class="literal">null</span>);  <span class="comment">// 这里的url先设置为空，因为url要保存的最终处理后的视频的地址</span></span><br><span class="line">        mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进行前后端测试，上传5个avi视频，观察待处理任务表是否存在记录，记录是否完成。</p><p>测试成功：</p><p><img src="/breeze/e273b43/image-20230615134135184.png" alt="image-20230615134135184"></p><p><img src="/breeze/e273b43/image-20230615134212133.png" alt="image-20230615134212133"></p><p>这里status的状态是1，表示是待处理的记录（待合并）</p><h5 id="7-4-3-查询待处理任务（重点）"><a href="#7-4-3-查询待处理任务（重点）" class="headerlink" title="7.4.3 查询待处理任务（重点）"></a><strong>7.4.3 查询待处理任务（重点）</strong></h5><p>&#x3D;&#x3D;如何保证查询到的待处理视频记录不重复？&#x3D;&#x3D;</p><p>编写根据分片参数获取待处理任务的DAO方法，定义DAO接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据分片参数获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal  分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardindex  分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 任务数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt; </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 8:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from media_process t where t.id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; and (t.status = &#x27;1&#x27; or t.status = &#x27;3&#x27;) and t.fail_count &lt; 3 limit #&#123;count&#125;&quot;)</span></span><br><span class="line">    List&lt;MediaProcess&gt; <span class="title function_">selectListByShardIndex</span><span class="params">(<span class="meta">@Param(&quot;shardTotal&quot;)</span> <span class="type">int</span> shardTotal,<span class="meta">@Param(&quot;shardIndex&quot;)</span> <span class="type">int</span> shardIndex,<span class="meta">@Param(&quot;count&quot;)</span> <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义Service接口，查询待处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件处理业务方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/10 8:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 获取记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/14 14:49</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex,<span class="type">int</span> shardTotal,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service接口实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">        <span class="keyword">return</span> mediaProcesses;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-5-开始执行任务"><a href="#7-5-开始执行任务" class="headerlink" title="7.5 开始执行任务"></a><strong>7.5 开始执行任务</strong></h4><h5 id="7-5-1-分布式锁"><a href="#7-5-1-分布式锁" class="headerlink" title="7.5.1 分布式锁"></a><strong>7.5.1 分布式锁</strong></h5><p>前边分析了保证任务不重复执行的方案，理论上每个执行器分到的任务是不重复的，但是当在执行器弹性扩容时无法绝对避免任务不重复执行，比如：原来有四个执行器正在执行任务，由于网络问题原有的0、1号执行器无法与调度中心通信，调度中心就会对执行器重新编号，原来的3、4执行器可能就会执行和0、1号执行器相同的任务。</p><p>为了避免多线程去争抢同一个任务可以使用synchronized同步锁去解决，如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(锁对象)&#123;</span><br><span class="line">   <span class="comment">// TODO 执行任务...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>synchronized只能保证同一个虚拟机中多个线程去争抢锁。</p><p><img src="/breeze/e273b43/image125.png"></p><p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。</p><p>现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p><p><img src="/breeze/e273b43/image126.png"></p><p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务。</p><p><strong>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫分布式锁。</strong></p><p>实现分布式锁的方案有很多，常用的如下：</p><p>1、基于数据库实现分布锁</p><p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，比如：多个线程同时向数据库插入主键相同的同一条记录，谁插入成功谁就获取锁，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p><p>2、基于redis实现锁</p><p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p><p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p><p>3、使用zookeeper实现</p><p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p><p>本次我们选用数据库实现分布锁，后边的模块会选用其它方案到时再详细介绍。</p><h5 id="7-5-2-开启任务"><a href="#7-5-2-开启任务" class="headerlink" title="7.5.2 开启任务"></a><strong>7.5.2 开启任务</strong></h5><p>下边基于数据库方式实现分布锁，开始执行任务将任务执行状态更新为4表示任务执行中。</p><p>下边的sql语句可以实现更新操作：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> media_process m <span class="keyword">set</span> m.status<span class="operator">=</span><span class="string">&#x27;4&#x27;</span> <span class="keyword">where</span>  m.id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure><p>如果是多个线程去执行该sql都将会执行成功，但需求是只能有一个线程抢到锁，所以此sql无法满足需求。</p><p>&#x3D;&#x3D;使用乐观锁方式实现更新操作：&#x3D;&#x3D;（实现分布式锁）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> media_process m <span class="keyword">set</span> m.status<span class="operator">=</span><span class="string">&#x27;4&#x27;</span> <span class="keyword">where</span> (m.status<span class="operator">=</span><span class="string">&#x27;1&#x27;</span> <span class="keyword">or</span> m.status<span class="operator">=</span><span class="string">&#x27;3&#x27;</span>) <span class="keyword">and</span> m.fail_count<span class="operator">&lt;</span><span class="number">3</span> <span class="keyword">and</span> m.id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure><p>多个线程同时执行上边的sql只会有一个线程执行成功。</p><p>什么是乐观锁、悲观锁？</p><p>synchronized是一种悲观锁，在执行被synchronized包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以要悲观锁。</p><p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p><p>数据库的乐观锁实现方式是在表中增加一个version字段，更新时判断是否等于某个版本，等于则更新否则更新失败，如下方式。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> t1.data1 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span>,t1.version<span class="operator">=</span><span class="string">&#x27;2&#x27;</span> <span class="keyword">where</span> t1.version<span class="operator">=</span><span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure><p>实现如下：</p><p>1、定义mapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启一个任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 更新记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update(&quot;update media_process m set m.status=&#x27;4&#x27; where (m.status=&#x27;1&#x27; or m.status=&#x27;3&#x27;) and m.fail_count&lt;3 and m.id=#&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">startTask</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、在MediaFileProcessService中定义接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  开启一个任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true开启任务成功，false开启任务失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现如下</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">startTask</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> mediaProcessMapper.startTask(id);</span><br><span class="line">    <span class="keyword">return</span> result&lt;=<span class="number">0</span>?<span class="literal">false</span>:<span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-6-更新任务状态"><a href="#7-6-更新任务状态" class="headerlink" title="7.6 更新任务状态"></a><strong>7.6 更新任务状态</strong></h4><p>任务处理完成需要更新任务处理结果，任务执行成功更新视频的URL、及任务处理结果，将待处理任务记录删除，同时向历史任务表添加记录。</p><p>在MediaFileProcessService接口添加方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存任务结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> taskId  任务id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status 任务状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fileId  文件id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url url</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> errorMsg 错误信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId,String status,String fileId,String url,String errorMsg)</span>;</span><br></pre></td></tr></table></figure><p>service接口方法实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 14:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFileProcessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MediaFileProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessHistoryMapper mediaProcessHistoryMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(Long taskId, String status, String fileId, String url, String errorMsg)</span> &#123;</span><br><span class="line">        <span class="comment">//查出任务，如果不存在则直接返回</span></span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> mediaProcessMapper.selectById(taskId);</span><br><span class="line">        <span class="keyword">if</span>(mediaProcess == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理失败，更新任务处理结果</span></span><br><span class="line">        LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapperById = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;MediaProcess&gt;().eq(MediaProcess::getId, taskId);</span><br><span class="line">        <span class="comment">//处理失败</span></span><br><span class="line">        <span class="keyword">if</span>(status.equals(<span class="string">&quot;3&quot;</span>))&#123;</span><br><span class="line">            <span class="type">MediaProcess</span> <span class="variable">mediaProcess_u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">            mediaProcess_u.setStatus(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">            mediaProcess_u.setErrormsg(errorMsg);</span><br><span class="line">            mediaProcess_u.setFailCount(mediaProcess.getFailCount()+<span class="number">1</span>);</span><br><span class="line">            mediaProcessMapper.update(mediaProcess_u,queryWrapperById);</span><br><span class="line">            log.debug(<span class="string">&quot;更新任务处理状态为失败，任务信息:&#123;&#125;&quot;</span>,mediaProcess_u);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*// 更新MediaProcess表的状态(方式一：更高效)</span></span><br><span class="line"><span class="comment">            LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span></span><br><span class="line"><span class="comment">            queryWrapper.eq(MediaProcess::getStatus, &quot;3&quot;)</span></span><br><span class="line"><span class="comment">                    .eq(MediaProcess::getFailCount, mediaProcess.getFailCount() + 1)</span></span><br><span class="line"><span class="comment">                    .eq(MediaProcess::getErrormsg, errorMsg);</span></span><br><span class="line"><span class="comment">            mediaProcessMapper.update(mediaProcess, queryWrapper);*/</span></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//任务处理成功</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileId);</span><br><span class="line">        <span class="keyword">if</span>(mediaFiles!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//更新媒资文件中的访问url</span></span><br><span class="line">            mediaFiles.setUrl(url);</span><br><span class="line">            mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理成功，更新url和状态</span></span><br><span class="line">        mediaProcess.setUrl(url);</span><br><span class="line">        mediaProcess.setStatus(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        mediaProcess.setFinishDate(LocalDateTime.now());</span><br><span class="line">        mediaProcessMapper.updateById(mediaProcess);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加到历史记录</span></span><br><span class="line">        <span class="type">MediaProcessHistory</span> <span class="variable">mediaProcessHistory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcessHistory</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);</span><br><span class="line">        mediaProcessHistoryMapper.insert(mediaProcessHistory);</span><br><span class="line">        <span class="comment">//删除mediaProcess</span></span><br><span class="line">        mediaProcessMapper.deleteById(mediaProcess.getId());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcesses = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">        <span class="keyword">return</span> mediaProcesses;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-7-视频处理"><a href="#7-7-视频处理" class="headerlink" title="7.7 视频处理"></a><strong>7.7 视频处理</strong></h4><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p><p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p><p>定义任务类VideoTask 如下：**<font color="red">该代码内容是重点，注意注意注意</font>**</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.media.service.jobhander;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.model.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileProcessService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.media.service.MediaFileService;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/15 11:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileService mediaFileService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFileProcessService mediaFileProcessService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span></span><br><span class="line">    String ffmpegpath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcessList = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//取出cpu核心数作为一次处理数据的条数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">            <span class="comment">//一次处理视频数量不要超过cpu核心数</span></span><br><span class="line">            mediaProcessList = mediaFileProcessService.getMediaProcessList(shardIndex, shardTotal, processors);</span><br><span class="line">            size = mediaProcessList.size();</span><br><span class="line">            log.debug(<span class="string">&quot;取出待处理视频任务&#123;&#125;条&quot;</span>, size);</span><br><span class="line">            <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//启动size个线程的线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">        <span class="comment">//计数器</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">        <span class="comment">//将处理任务加入线程池</span></span><br><span class="line">        mediaProcessList.forEach(mediaProcess -&gt; &#123;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//任务id</span></span><br><span class="line">                    <span class="type">Long</span> <span class="variable">taskId</span> <span class="operator">=</span> mediaProcess.getId();</span><br><span class="line">                    <span class="comment">//抢占任务</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> mediaFileProcessService.startTask(taskId);</span><br><span class="line">                    <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>, mediaProcess);</span><br><span class="line">                    <span class="comment">//下边是处理逻辑</span></span><br><span class="line">                    <span class="comment">//桶</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaProcess.getBucket();</span><br><span class="line">                    <span class="comment">//存储路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                    <span class="comment">//原始视频的md5值</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">                    <span class="comment">//原始文件名称</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaProcess.getFilename();</span><br><span class="line">                    <span class="comment">//将要处理的文件下载到服务器上</span></span><br><span class="line">                    <span class="type">File</span> <span class="variable">originalFile</span> <span class="operator">=</span> mediaFileService.downloadFileFromMinIO(mediaProcess.getBucket(), mediaProcess.getFilePath());</span><br><span class="line">                    <span class="keyword">if</span> (originalFile == <span class="literal">null</span>) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;下载待处理文件失败,originalFile:&#123;&#125;&quot;</span>, mediaProcess.getBucket().concat(mediaProcess.getFilePath()));</span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;下载待处理文件失败&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//处理下载的视频文件</span></span><br><span class="line">                    <span class="type">File</span> <span class="variable">mp4File</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mp4File = File.createTempFile(<span class="string">&quot;mp4&quot;</span>, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;创建mp4临时文件失败&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//视频处理结果</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//开始处理视频</span></span><br><span class="line">                        <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpegpath, originalFile.getAbsolutePath(), mp4File.getName(), mp4File.getAbsolutePath());</span><br><span class="line">                        <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">                        result = videoUtil.generateMp4();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        log.error(<span class="string">&quot;处理视频文件:&#123;&#125;,出错:&#123;&#125;&quot;</span>, mediaProcess.getFilePath(), e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!result.equals(<span class="string">&quot;success&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">//记录错误信息</span></span><br><span class="line">                        log.error(<span class="string">&quot;处理视频失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + filePath, result);</span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, result);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将mp4上传至minio</span></span><br><span class="line">                    <span class="comment">//mp4在minio的存储路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> getFilePath(fileId, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                    <span class="comment">//访问url</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mediaFileService.addMediaFilesToMinIO(mp4File.getAbsolutePath(), <span class="string">&quot;video/mp4&quot;</span>, bucket, objectName);</span><br><span class="line">                        <span class="comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span></span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;2&quot;</span>, fileId, url, <span class="literal">null</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;上传视频失败或入库失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;&quot;</span>, bucket + objectName, e.getMessage());</span><br><span class="line">                        <span class="comment">//最终还是失败了</span></span><br><span class="line">                        mediaFileProcessService.saveProcessFinishStatus(mediaProcess.getId(), <span class="string">&quot;3&quot;</span>, fileId, <span class="literal">null</span>, <span class="string">&quot;处理后视频上传或入库失败&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">        countDownLatch.await(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePath</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong><font color="red">注意线程池中，计数器的使用</font></strong></p></blockquote><h4 id="7-8-测试"><a href="#7-8-测试" class="headerlink" title="7.8 测试"></a><strong>7.8 测试</strong></h4><h5 id="7-8-1-基本测试"><a href="#7-8-1-基本测试" class="headerlink" title="7.8.1 基本测试"></a><strong>7.8.1 基本测试</strong></h5><p>进入xxl-job调度中心添加执行器和视频处理任务</p><p>在xxl-job配置任务调度策略：</p><p>1）配置阻塞处理策略为：丢弃后续调度。</p><p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p><p>配置完成开始测试视频处理：</p><p>1、首先上传至少4个视频，非mp4格式。</p><p>2、在xxl-job启动视频处理任务</p><p>3、观察媒资管理服务后台日志</p><h5 id="7-8-2-失败测试"><a href="#7-8-2-失败测试" class="headerlink" title="7.8.2 失败测试"></a><strong>7.8.2 失败测试</strong></h5><p>1、先停止调度中心的视频处理任务。</p><p>2、上传视频，手动修改待处理任务表中file_path字段为一个不存在的文件地址</p><p>3、启动任务</p><p>观察任务处理失败后是否会重试，并记录失败次数。</p><h5 id="7-8-3-抢占任务测试"><a href="#7-8-3-抢占任务测试" class="headerlink" title="7.8.3 抢占任务测试"></a><strong>7.8.3 抢占任务测试</strong></h5><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p><p><img src="/breeze/e273b43/image127.png"></p><p>2、在抢占任务代码处打断点并选择支持多线程方式</p><p><img src="/breeze/e273b43/image128.png"></p><p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p><p>4、启动任务</p><p>此时多个线程执行都停留在断点处</p><p><img src="/breeze/e273b43/image129.png"></p><p>依次放行，观察同一个任务只会被一个线程抢占成功。</p><p><img src="/breeze/e273b43/image130.png"></p><p><img src="/breeze/e273b43/image131.png"></p><h4 id="7-9-其它问题"><a href="#7-9-其它问题" class="headerlink" title="7.9 其它问题"></a><strong>7.9 其它问题</strong></h4><h5 id="7-9-1-任务补偿机制"><a href="#7-9-1-任务补偿机制" class="headerlink" title="7.9.1 任务补偿机制"></a><strong>7.9.1 任务补偿机制</strong></h5><p>如果有线程抢占了某个视频的处理任务，如果线程处理过程中挂掉了，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p><p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p><p>任务执行期限是处理一个视频的最大时间，比如定为30分钟，通过任务的启动时间去判断任务是否超过执行期限。</p><p>大家思考这个sql该如何实现？</p><p>大家尝试自己实现此任务补偿机制。</p><h5 id="7-9-2-达到最大失败次数"><a href="#7-9-2-达到最大失败次数" class="headerlink" title="7.9.2 达到最大失败次数"></a><strong>7.9.2 达到最大失败次数</strong></h5><p>当任务达到最大失败次数时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传mp4视频。</p><h5 id="7-9-3-分块文件清理问题"><a href="#7-9-3-分块文件清理问题" class="headerlink" title="7.9.3 分块文件清理问题"></a><strong>7.9.3 分块文件清理问题</strong></h5><p>上传一个文件进行分块上传，上传一半不传了，之前上传到minio的分块文件要清理吗？怎么做的？</p><p>1、在数据库中有一张文件表记录minio中存储的文件信息。</p><p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p><p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除minio中没有上传成功的文件目录。</p><h3 id="8-绑定媒资"><a href="#8-绑定媒资" class="headerlink" title="8 绑定媒资"></a><strong>8 绑定媒资</strong></h3><h4 id="8-1-需求分析"><a href="#8-1-需求分析" class="headerlink" title="8.1 需求分析"></a><strong>8.1 需求分析</strong></h4><h5 id="8-1-1-业务流程"><a href="#8-1-1-业务流程" class="headerlink" title="8.1.1 业务流程"></a><strong>8.1.1 业务流程</strong></h5><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p><p>如何将课程计划绑定媒资呢？</p><p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p><p>具体的业务流程如下：</p><p>1.教育机构用户进入课程管理页面并编辑某一个课程，在”课程大纲”标签页的某一小节后可点击”添加视频“。</p><p><img src="/breeze/e273b43/image13-1685854767943-146.png"></p><p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p><p><img src="/breeze/e273b43/image14-1685854769472-148.png"></p><p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p><p><img src="/breeze/e273b43/image15-1685854771545-150.png"></p><p>课程计划关联视频后如下图：</p><p><img src="/breeze/e273b43/image16-1685854773840-152.png"></p><p>点击已经绑定的视频名称即可解除绑定。</p><p><img src="/breeze/e273b43/image132.png"></p><h5 id="8-1-2-数据模型"><a href="#8-1-2-数据模型" class="headerlink" title="8.1.2 数据模型"></a><strong>8.1.2 数据模型</strong></h5><p>课程计划绑定媒资文件后存储至课程计划绑定媒资表</p><p><img src="/breeze/e273b43/image133.png"></p><h4 id="8-2-接口定义"><a href="#8-2-接口定义" class="headerlink" title="8.2 接口定义"></a><strong>8.2 接口定义</strong></h4><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以json格式请求以下参数：</p><p>提交媒资文件id、文件名称、教学计划id</p><p>示例如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mediaId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;teachplanId&quot;</span><span class="punctuation">:</span> <span class="number">257</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>此接口在内容管理模块提供。</p><p>在内容管理模块定义请求参数模型类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;BindTeachplanMediaDto&quot;, description=&quot;教学计划-媒资绑定提交数据&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BindTeachplanMediaDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;媒资文件id&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String mediaId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;媒资文件名称&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程计划标识&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> Long teachplanId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在TeachplanController类中定义接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-3-接口开发"><a href="#8-3-接口开发" class="headerlink" title="8.3 接口开发"></a><strong>8.3 接口开发</strong></h4><h5 id="8-3-1-DAO开发"><a href="#8-3-1-DAO开发" class="headerlink" title="8.3.1 DAO开发"></a><strong>8.3.1 DAO开发</strong></h5><p>对teachplanMedia表自动生成Mapper。</p><h5 id="8-3-2-Service开发"><a href="#8-3-2-Service开发" class="headerlink" title="8.3.2 Service开发"></a><strong>8.3.2 Service开发</strong></h5><p>根据需求定义service接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 教学计划绑定媒资</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bindTeachplanMediaDto</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.content.model.po.TeachplanMedia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/14 22:20</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>定义接口实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;</span><br><span class="line">    <span class="comment">//教学计划id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">teachplanId</span> <span class="operator">=</span> bindTeachplanMediaDto.getTeachplanId();</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="keyword">if</span>(teachplan==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;教学计划不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="keyword">if</span>(grade!=<span class="number">2</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//课程id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先删除原来该教学计划绑定的媒资</span></span><br><span class="line">    <span class="comment">// 因为主键是自增的，所以这里根据id删除</span></span><br><span class="line">    teachplanMediaMapper.delete(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId,teachplanId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再添加教学计划与媒资的绑定关系</span></span><br><span class="line">    <span class="type">TeachplanMedia</span> <span class="variable">teachplanMedia</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TeachplanMedia</span>();</span><br><span class="line">    teachplanMedia.setCourseId(courseId);</span><br><span class="line">    teachplanMedia.setTeachplanId(teachplanId);</span><br><span class="line">    teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());</span><br><span class="line">    teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());</span><br><span class="line">    teachplanMedia.setCreateDate(LocalDateTime.now());</span><br><span class="line">    teachplanMediaMapper.insert(teachplanMedia);</span><br><span class="line">    <span class="keyword">return</span> teachplanMedia;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="8-3-3-接口层完善"><a href="#8-3-3-接口层完善" class="headerlink" title="8.3.3 接口层完善"></a><strong>8.3.3 接口层完善</strong></h5><p>完善接口层调用Service层的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息绑定&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line">    teachplanService.associationMedia(bindTeachplanMediaDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="8-3-4-接口测试"><a href="#8-3-4-接口测试" class="headerlink" title="8.3.4 接口测试"></a><strong>8.3.4 接口测试</strong></h5><p>1、使用httpclient测试</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划绑定视频</span><br><span class="line">POST <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>media_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/media/teachplan/association/media</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mediaId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;teachplanId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>2、前后端联调</p><p>此功能较为简单推荐直接前后端联调</p><p>向指定课程计划添加视频</p><h4 id="8-4-实战（有bug）"><a href="#8-4-实战（有bug）" class="headerlink" title="8.4 实战（有bug）"></a><strong>8.4 实战</strong>（有bug）</h4><h5 id="8-4-1-需求分析"><a href="#8-4-1-需求分析" class="headerlink" title="8.4.1 需求分析"></a>8.4.1 需求分析</h5><p>根据接口定义实现解除绑定功能。</p><p>点击已经绑定的视频名称即可解除绑定。</p><p><img src="/breeze/e273b43/image132-1685854782488-156.png"></p><h5 id="8-4-2-接口定义"><a href="#8-4-2-接口定义" class="headerlink" title="8.4.2 接口定义"></a>8.4.2 接口定义</h5><p>接口定义如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete /teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br><span class="line"></span><br><span class="line">返回200状态码表示成功。</span><br></pre></td></tr></table></figure><h5 id="8-4-3-接口开发"><a href="#8-4-3-接口开发" class="headerlink" title="8.4.3 接口开发"></a>8.4.3 接口开发</h5><h6 id="8-4-3-1-Controller开发（TeachanplanController）"><a href="#8-4-3-1-Controller开发（TeachanplanController）" class="headerlink" title="8.4.3.1 Controller开发（TeachanplanController）"></a>8.4.3.1 Controller开发（TeachanplanController）</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;课程计划和媒资信息删除绑定&quot;)</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachplanId&#125;/&#123;mediaId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unAssociationMedia</span><span class="params">(<span class="meta">@PathVariable</span> Long teachplanId, <span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;teachPlanId:&#123;&#125;, mediaId:&#123;&#125;&quot;</span>,teachplanId, mediaId );</span><br><span class="line">    teachplanService.unAssociationMedia(teachplanId, mediaId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="8-4-3-2-service开发（TeachplanService）"><a href="#8-4-3-2-service开发（TeachplanService）" class="headerlink" title="8.4.3.2 service开发（TeachplanService）"></a>8.4.3.2 service开发（TeachplanService）</h6><p>定义接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 课程计划和媒资信息删除绑定</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> teachPlanId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> mediaId</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unAssociationMedia</span><span class="params">(Long teachPlanId, String mediaId)</span>;</span><br></pre></td></tr></table></figure><p>接口实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unAssociationMedia</span><span class="params">(Long teachPlanId, String mediaId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>();</span><br><span class="line">    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId).eq(TeachplanMedia::getMediaId, mediaId);</span><br><span class="line">    <span class="type">int</span> <span class="variable">delete</span> <span class="operator">=</span> teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span> (delete &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;删除媒资信息失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="8-4-3-3-接口测试"><a href="#8-4-3-3-接口测试" class="headerlink" title="8.4.3.3 接口测试"></a>8.4.3.3 接口测试</h6><p>这里在前端测试，始终获取不了<code>teachplanid</code>，<code>teachplanid</code>的位置显示null&#x3D;&#x3D;（bug）&#x3D;&#x3D;</p><p><img src="/breeze/e273b43/image-20230616155604796.png" alt="image-20230616155604796"></p><p>开发完成使用httpclient测试、前后端联调</p><p>使用文档中给的请求，删除不了，显示404</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划接触视频绑定</span><br><span class="line">DELETE &#123;&#123;media_host&#125;&#125;/media/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure><p>自己定义的请求，使用httpclient进行测试</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程计划接触视频绑定</span><br><span class="line">DELETE http://localhost:8601/api/content/teachplan/association/media/267/79f69c49fb2e1ffa931321f3acc89987</span><br></pre></td></tr></table></figure><p>数据库表中的记录成功被删除（前端页面的媒资信息显示成功删除），至此，功能开发完成。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/e273b43.html">https://mliutm.github.io/breeze/e273b43.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1653549892896-dde02867edee.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/ee0e64ec.html" title="学成在线-课程发布模块（四）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">学成在线-课程发布模块（四）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/bbb47ad7.html" title="学成在线-内容管理模块（二）"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线-内容管理模块（二）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/ecebeadb.html" title="BIO-NIO-AIO深入剖析"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">BIO-NIO-AIO深入剖析</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/ab319c68.html" title="SpringCloud-Alibaba快速入门"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">SpringCloud-Alibaba快速入门</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">169</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">31</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC3%E7%AB%A0%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3-1"><span class="toc-text">第3章媒资管理模块v3.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">1 模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1 模块介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-text">1.2.1 上传图片</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91"><span class="toc-text">1.2.2 上传视频</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91"><span class="toc-text">1.2.3 处理视频</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-4-%E5%AE%A1%E6%A0%B8%E5%AA%92%E8%B5%84"><span class="toc-text">1.2.4 审核媒资</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-5-%E7%BB%91%E5%AE%9A%E5%AA%92%E8%B5%84"><span class="toc-text">1.2.5 绑定媒资</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.3 数据模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97%E7%8E%AF%E5%A2%83"><span class="toc-text">2 搭建模块环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%9E%B6%E6%9E%84%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">2.1 架构的问题分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%90%AD%E5%BB%BANacos"><span class="toc-text">2.2 搭建Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%AD%E5%BF%83"><span class="toc-text">2.2.1 服务发现中心</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">2.2.2 配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-1-%E9%85%8D%E7%BD%AE%E4%B8%89%E8%A6%81%E7%B4%A0"><span class="toc-text">2.2.2.1 配置三要素</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-2-%E9%85%8D%E7%BD%AEcontent-service"><span class="toc-text">2.2.2.2 配置content-service</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-3%E9%85%8D%E7%BD%AEcontent-api"><span class="toc-text">2.2.2.3配置content-api</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E5%85%AC%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.3 公用配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">2.2.4 配置优先级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-%E5%AF%BC%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.2.5 导入配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-6-%E4%BD%9C%E4%B8%9A"><span class="toc-text">2.2.6 作业</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%90%AD%E5%BB%BAGateway"><span class="toc-text">2.3 搭建Gateway</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%90%AD%E5%BB%BA%E5%AA%92%E8%B5%84%E5%B7%A5%E7%A8%8B"><span class="toc-text">2.4 搭建媒资工程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">3 分布式文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">3.1 什么是分布式文件系统</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BA%91%E8%AE%A1%E7%AE%97%E5%8E%82%E5%AE%B6"><span class="toc-text">4、云计算厂家</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-MinIO"><span class="toc-text">4.1 MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1-%E4%BB%8B%E7%BB%8D"><span class="toc-text">4.1.1 介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D%E6%BC%94%E7%A4%BA"><span class="toc-text">4.2.2 数据恢复演示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-%E6%B5%8B%E8%AF%95Docker%E7%8E%AF%E5%A2%83"><span class="toc-text">4.2.3 测试Docker环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-4-SDK"><span class="toc-text">4.2.4 SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-4-1%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">4.2.4.1上传文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-4-2-%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-text">4.2.4.2 删除文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-4-3-%E6%9F%A5%E8%AF%A2%E6%96%87%E4%BB%B6"><span class="toc-text">4.2.4.3 查询文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-text">5 上传图片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">5.1.1 业务流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.1.2 数据模型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text">5.2 准备环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.3 接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">5.4 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1-DAO%E5%BC%80%E5%8F%91"><span class="toc-text">5.4.1 DAO开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2-Service%E5%BC%80%E5%8F%91"><span class="toc-text">5.4.2 Service开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-3-%E5%AE%8C%E5%96%84%E6%8E%A5%E5%8F%A3%E5%B1%82"><span class="toc-text">5.4.3 完善接口层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-4-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.4 接口测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-5-Service%E4%BA%8B%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-text">5.4.5 Service事务优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91"><span class="toc-text">6 上传视频</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">6.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E6%8A%80%E6%9C%AF"><span class="toc-text">6.2 断点续传技术</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-text">6.2.1 什么是断点续传</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-%E5%88%86%E5%9D%97%E4%B8%8E%E5%90%88%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="toc-text">6.2.2 分块与合并测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-3-%E8%A7%86%E9%A2%91%E4%B8%8A%E4%BC%A0%E6%B5%81%E7%A8%8B"><span class="toc-text">6.2.3 视频上传流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-4-minio%E5%90%88%E5%B9%B6%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="toc-text">6.2.4 minio合并文件测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">6.3 接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-text">6.4 上传分块开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-4-1-DAO%E5%BC%80%E5%8F%91"><span class="toc-text">6.4.1 DAO开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-4-2-Service%E5%BC%80%E5%8F%91"><span class="toc-text">6.4.2 Service开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#6-4-2-1-%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%92%8C%E5%88%86%E5%9D%97"><span class="toc-text">6.4.2.1 检查文件和分块</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-4-2-2-%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97"><span class="toc-text">6.4.2.2 上传分块</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-4-2-3-%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97%E6%B5%8B%E8%AF%95"><span class="toc-text">6.4.2.3 上传分块测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-%E5%90%88%E5%B9%B6%E5%88%86%E5%9D%97%E5%BC%80%E5%8F%91"><span class="toc-text">6.5 合并分块开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-5-1-service%E5%BC%80%E5%8F%91"><span class="toc-text">6.5.1 service开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-5-2-%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%AE%8C%E5%96%84"><span class="toc-text">6.5.2 接口层完善</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-5-2-%E5%90%88%E5%B9%B6%E5%88%86%E5%9D%97%E6%B5%8B%E8%AF%95"><span class="toc-text">6.5.2 合并分块测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-text">7 视频处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%E9%9C%80%E6%B1%82"><span class="toc-text">7.1 视频转码需求</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81"><span class="toc-text">7.1.1 什么是视频编码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-2-FFmpeg-%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">7.1.2 FFmpeg 的基本使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-1-3-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">7.1.3 视频处理工具类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-text">7.2 分布式任务处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">7.2.1 什么是分布式任务调度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-2-XXL-JOB%E4%BB%8B%E7%BB%8D"><span class="toc-text">7.2.2 XXL-JOB介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-3-%E6%90%AD%E5%BB%BAXXL-JOB"><span class="toc-text">7.2.3 搭建XXL-JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#7-2-3-1-%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83"><span class="toc-text">7.2.3.1 调度中心</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#7-2-3-2-%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-text">7.2.3.2 执行器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#7-2-3-3-%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-text">7.2.3.3 执行任务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-2-4-%E5%88%86%E7%89%87%E5%B9%BF%E6%92%AD"><span class="toc-text">7.2.4 分片广播</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">7.3 技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-1-%E4%BD%9C%E4%B8%9A%E5%88%86%E7%89%87%E6%96%B9%E6%A1%88"><span class="toc-text">7.3.1 作业分片方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-2-%E4%BF%9D%E8%AF%81%E4%BB%BB%E5%8A%A1%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C"><span class="toc-text">7.3.2 保证任务不重复执行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-3-3-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="toc-text">7.3.3 视频处理方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-4-%E6%9F%A5%E8%AF%A2%E5%BE%85%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1"><span class="toc-text">7.4 查询待处理任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">7.4.1 需求分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-4-2%E6%B7%BB%E5%8A%A0%E5%BE%85%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1"><span class="toc-text">7.4.2添加待处理任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-4-3-%E6%9F%A5%E8%AF%A2%E5%BE%85%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="toc-text">7.4.3 查询待处理任务（重点）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-5-%E5%BC%80%E5%A7%8B%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-text">7.5 开始执行任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-5-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">7.5.1 分布式锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-5-2-%E5%BC%80%E5%90%AF%E4%BB%BB%E5%8A%A1"><span class="toc-text">7.5.2 开启任务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-6-%E6%9B%B4%E6%96%B0%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">7.6 更新任务状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-7-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-text">7.7 视频处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-8-%E6%B5%8B%E8%AF%95"><span class="toc-text">7.8 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-8-1-%E5%9F%BA%E6%9C%AC%E6%B5%8B%E8%AF%95"><span class="toc-text">7.8.1 基本测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-8-2-%E5%A4%B1%E8%B4%A5%E6%B5%8B%E8%AF%95"><span class="toc-text">7.8.2 失败测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-8-3-%E6%8A%A2%E5%8D%A0%E4%BB%BB%E5%8A%A1%E6%B5%8B%E8%AF%95"><span class="toc-text">7.8.3 抢占任务测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-9-%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98"><span class="toc-text">7.9 其它问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#7-9-1-%E4%BB%BB%E5%8A%A1%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6"><span class="toc-text">7.9.1 任务补偿机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-9-2-%E8%BE%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E5%A4%B1%E8%B4%A5%E6%AC%A1%E6%95%B0"><span class="toc-text">7.9.2 达到最大失败次数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-9-3-%E5%88%86%E5%9D%97%E6%96%87%E4%BB%B6%E6%B8%85%E7%90%86%E9%97%AE%E9%A2%98"><span class="toc-text">7.9.3 分块文件清理问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E7%BB%91%E5%AE%9A%E5%AA%92%E8%B5%84"><span class="toc-text">8 绑定媒资</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">8.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">8.1.1 业务流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">8.1.2 数据模型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">8.2 接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">8.3 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-3-1-DAO%E5%BC%80%E5%8F%91"><span class="toc-text">8.3.1 DAO开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-3-2-Service%E5%BC%80%E5%8F%91"><span class="toc-text">8.3.2 Service开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-3-3-%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%AE%8C%E5%96%84"><span class="toc-text">8.3.3 接口层完善</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-3-4-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">8.3.4 接口测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-%E5%AE%9E%E6%88%98%EF%BC%88%E6%9C%89bug%EF%BC%89"><span class="toc-text">8.4 实战（有bug）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">8.4.1 需求分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">8.4.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">8.4.3 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#8-4-3-1-Controller%E5%BC%80%E5%8F%91%EF%BC%88TeachanplanController%EF%BC%89"><span class="toc-text">8.4.3.1 Controller开发（TeachanplanController）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#8-4-3-2-service%E5%BC%80%E5%8F%91%EF%BC%88TeachplanService%EF%BC%89"><span class="toc-text">8.4.3.2 service开发（TeachplanService）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#8-4-3-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">8.4.3.3 接口测试</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="WYDG-产品目录列表-20200506"></a><div class="content"><a class="title" href="/breeze/1d13ce0d.html" title="WYDG-产品目录列表-20200506">WYDG-产品目录列表-20200506</a><time datetime="2025-04-13T05:43:05.000Z" title="发表于 2025-04-13 13:43:05">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f268337.html" title="雨雀文件下载"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="雨雀文件下载"></a><div class="content"><a class="title" href="/breeze/6f268337.html" title="雨雀文件下载">雨雀文件下载</a><time datetime="2024-05-22T12:25:08.000Z" title="发表于 2024-05-22 20:25:08">2024-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7832219d.html" title="十万字面试总结"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="十万字面试总结"></a><div class="content"><a class="title" href="/breeze/7832219d.html" title="十万字面试总结">十万字面试总结</a><time datetime="2024-02-29T02:50:00.000Z" title="发表于 2024-02-29 10:50:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis_30道经典面试题"></a><div class="content"><a class="title" href="/breeze/7ae0ca37.html" title="Redis_30道经典面试题">Redis_30道经典面试题</a><time datetime="2024-02-29T02:45:00.000Z" title="发表于 2024-02-29 10:45:00">2024-02-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/2a548e97.html" title="面试实战"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="面试实战"></a><div class="content"><a class="title" href="/breeze/2a548e97.html" title="面试实战">面试实战</a><time datetime="2024-02-29T02:43:59.000Z" title="发表于 2024-02-29 10:43:59">2024-02-29</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1653549892896-dde02867edee.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>