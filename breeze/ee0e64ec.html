<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>学成在线-课程发布模块（四） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第4章 课程发布v3.11 模块需求分析1.1 模块介绍课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。 下边是课程编辑与发布的整体流程：  为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。 作为课程制作方即教学机构，在课程发布前通过课程预览功"><meta property="og:type" content="article"><meta property="og:title" content="学成在线-课程发布模块（四）"><meta property="og:url" content="https://mliutm.github.io/breeze/ee0e64ec.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="第4章 课程发布v3.11 模块需求分析1.1 模块介绍课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。 下边是课程编辑与发布的整体流程：  为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。 作为课程制作方即教学机构，在课程发布前通过课程预览功"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><meta property="article:published_time" content="2023-10-30T04:00:33.000Z"><meta property="article:modified_time" content="2023-11-20T13:05:52.426Z"><meta property="article:author" content="清风"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/ee0e64ec.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:200,languages:{author:"作者: 清风",link:"链接: ",source:"来源: 清风",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"学成在线-课程发布模块（四）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-11-20 21:05:52"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线-课程发布模块（四）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-30T04:00:33.000Z" title="发表于 2023-10-30 12:00:33">2023-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-20T13:05:52.426Z" title="更新于 2023-11-20 21:05:52">2023-11-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">28.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>112分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="学成在线-课程发布模块（四）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="第4章-课程发布v3-1"><a href="#第4章-课程发布v3-1" class="headerlink" title="第4章 课程发布v3.1"></a><strong>第4章 课程发布v3.1</strong></h2><h3 id="1-模块需求分析"><a href="#1-模块需求分析" class="headerlink" title="1 模块需求分析"></a><strong>1 模块需求分析</strong></h3><h4 id="1-1-模块介绍"><a href="#1-1-模块介绍" class="headerlink" title="1.1 模块介绍"></a><strong>1.1 模块介绍</strong></h4><p>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。</p><p>下边是课程编辑与发布的整体流程：</p><p><img src="/breeze/ee0e64ec/image1.png"></p><p>为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。</p><p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p><p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p><p><img src="/breeze/ee0e64ec/image2.png"></p><p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p><p>课程发布模块共包括三块功能：</p><p>1、课程预览</p><p>2、课程审核</p><p>3、课程发布</p><h4 id="1-2-业务流程"><a href="#1-2-业务流程" class="headerlink" title="1.2 业务流程"></a><strong>1.2 业务流程</strong></h4><h5 id="1-2-1-课程预览"><a href="#1-2-1-课程预览" class="headerlink" title="1.2.1 课程预览"></a><strong>1.2.1 课程预览</strong></h5><p>1.<strong>教育机构用户</strong>在课程管理中可对该机构内所管理的课程进行检索。</p><p><img src="/breeze/ee0e64ec/image3.png"></p><p>2.点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。</p><p>下图是课程详情首页，显示了课程的基本信息。</p><p><img src="/breeze/ee0e64ec/image4.png"></p><p>点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。</p><p><img src="/breeze/ee0e64ec/image5.png"></p><p>点击课程目录中的具体章节，查看视频播放是否正常</p><p><img src="/breeze/ee0e64ec/image6.png"></p><h5 id="1-2-2-课程审核"><a href="#1-2-2-课程审核" class="headerlink" title="1.2.2 课程审核"></a><strong>1.2.2 课程审核</strong></h5><p>教学机构提交课程审核后，平台运营人员登录运营平台进行课程审核，课程审核包括程序自动审核和人工审核，程序会审核内容的完整性，人员通过课程预览进行审核。</p><p>流程如下：</p><p><img src="/breeze/ee0e64ec/image7.png"></p><p>1、首先查询待审核的记录。</p><p>2、课程审核</p><p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p><p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p><p>如果课程内容没有违规信息且课程内容全面则审核通过。</p><p>课程审核通过后教学机构发布课程成功。</p><h5 id="1-2-3-课程发布"><a href="#1-2-3-课程发布" class="headerlink" title="1.2.3 课程发布"></a><strong>1.2.3 课程发布</strong></h5><p>1.<strong>教育机构用户</strong>在课程管理中可对机构内课程进行检索。</p><p><img src="/breeze/ee0e64ec/image8.png"></p><p>2.点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。</p><p><img src="/breeze/ee0e64ec/image9.png"></p><p>3、课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。</p><p><img src="/breeze/ee0e64ec/image10.png"></p><p>4 点击课程搜索页中课程列表的某个课程，可进入课程详情页。</p><p><img src="/breeze/ee0e64ec/image4-1686903127186-11.png"></p><h3 id="2-课程预览"><a href="#2-课程预览" class="headerlink" title="2 课程预览"></a><strong>2 课程预览</strong></h3><h4 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a><strong>2.1 需求分析</strong></h4><p>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题。</p><p><img src="/breeze/ee0e64ec/image4-1686903129834-13.png"></p><p>下图是课程预览的数据来源：</p><p><img src="/breeze/ee0e64ec/image11.png"></p><p>在课程预览页面点击”视频播放图片”打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。</p><p><img src="/breeze/ee0e64ec/image12.png"></p><p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：</p><p><img src="/breeze/ee0e64ec/image13.png"></p><p>说明如下：</p><p>1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。</p><p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p><p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p><p>4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播放视频。</p><h4 id="2-2-模板引擎"><a href="#2-2-模板引擎" class="headerlink" title="2.2 模板引擎"></a><strong>2.2 模板引擎</strong></h4><h5 id="2-2-1-什么是模板引擎"><a href="#2-2-1-什么是模板引擎" class="headerlink" title="2.2.1 什么是模板引擎"></a><strong>2.2.1 什么是模板引擎</strong></h5><p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p><p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p><p>早期我们采用的jsp技术就是一种模板引擎技术，如下图：</p><p><img src="/breeze/ee0e64ec/image14.png"></p><p>1、浏览器请求web服务器</p><p>2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。</p><p>3、服务器将渲染生成的页面返回给浏览器。</p><p>所以模板引擎就是：模板+数据&#x3D;输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。</p><p>常用的java模板引擎还有哪些？</p><p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p><p>本项目采用Freemarker作为模板引擎技术。</p><p>Freemarker官方地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p><p>FreeMarker 是一款 <em>模板引擎</em>： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。FreeMarker 是 <a target="_blank" rel="noopener" href="http://www.fsf.org/philosophy/free-sw.html">免费的</a>， 基于Apache许可证2.0版本发布。</p><h5 id="2-2-2-Freemarker快速入门"><a href="#2-2-2-Freemarker快速入门" class="headerlink" title="2.2.2 Freemarker快速入门"></a><strong>2.2.2 Freemarker快速入门</strong></h5><p>下边在内容管理接口层搭建Freemarker的运行环境并进行测试。</p><p>在内容管理接口工层 添加Freemarker与SpringBoot的整合包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在nacos为内容管理接口层配置freemarker，公用配置组新加一个freemarker-config-dev.yaml</p><p><img src="/breeze/ee0e64ec/image15.png"></p><p>配置信息如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">freemarker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span>   <span class="comment">#关闭模板缓存，方便测试</span></span><br><span class="line">    <span class="attr">settings:</span></span><br><span class="line">      <span class="attr">template_update_delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.ftl</span>   <span class="comment">#页面模板后缀名</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">    <span class="attr">template-loader-path:</span> <span class="string">classpath:/templates/</span>   <span class="comment">#页面模板位置(默认为 classpath:/templates/)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>在内容管理接口工程添加freemarker-config-dev.yaml</p><p><img src="/breeze/ee0e64ec/image16.png"></p><p>添加模板，在resources下创建templates目录，添加test.ftl模板文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        Hello $&#123;name&#125;!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>编写controller方法，准备模型数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.math.raw.Mod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/15 19:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testfreemarker&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        <span class="comment">//设置模型数据</span></span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line">        <span class="comment">//设置模板名称（会根据nacos配置文件中的配置，自动给模板名加上 .ftl 后缀）</span></span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/testfreemarker">http://localhost:63040/content/testfreemarker</a></p><p>屏幕输出：Hello 小明！</p><p><img src="/breeze/ee0e64ec/image17.png"></p><p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p><blockquote><p><strong>Freemarker快速入门步骤</strong></p><ol><li>引入依赖</li><li>在nacos中进行配置文件的配置</li><li>根据nacos中的配置，在指定位置添加对应的目录，在该目录下创建<code>freemarker模板</code></li><li>进行java代码的编写</li></ol></blockquote><h4 id="2-3-测试静态页面"><a href="#2-3-测试静态页面" class="headerlink" title="2.3 测试静态页面"></a><strong>2.3 测试静态页面</strong></h4><h5 id="2-3-1-部署网站门户"><a href="#2-3-1-部署网站门户" class="headerlink" title="2.3.1 部署网站门户"></a><strong>2.3.1 部署网站门户</strong></h5><p>在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求，如下图：</p><p><img src="/breeze/ee0e64ec/image18.png"></p><p>1、在本机安装 Nginx ，从课程资料目录获取nginx-1.23.1.zip并解压。</p><p>2、运行nginx-1.23.1目录下的nginx.exe。</p><p>默认端口为80，如果本机80端口被占用，则需要杀掉占用进程后再启动nginx。</p><p>如果无法杀掉80端口占用进程则需要修改nginx-1.23.1目录下conf&#x2F;nginx.conf配置文件</p><p><img src="/breeze/ee0e64ec/image19.png"></p><p>将80端口修改为空闲端口。</p><p>启动nginx，访问<a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a> 出现下边的网页表示启动成功</p><p><img src="/breeze/ee0e64ec/image20.png"></p><p>下边开始部署前端工程：</p><p>1、从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。</p><p>2、修改本机hosts文件，加入127.0.0.1 <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">www.51xuecheng.cn</a> 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn。</p><p>window10操作系统hosts文件在C:\Windows\System32\drivers\etc下</p><p>Centos7操作系统的hosts文件在&#x2F;etc目录下。</p><p>在hosts文件加入如下配置</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure><p>3、在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件。</p><p>配置内容如下，注意更改xc-ui-pc-static-portal目录的路径：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server <span class="punctuation">&#123;</span></span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  www<span class="number">.51</span>xuecheng.cn localhost;</span><br><span class="line">        #rewrite ^(.*) https<span class="punctuation">:</span><span class="comment">//$server_name$1 permanent;</span></span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        ssi on;</span><br><span class="line">        ssi_silent_errors on;</span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / <span class="punctuation">&#123;</span></span><br><span class="line">            alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        #静态资源</span><br><span class="line">        location /static/img/ <span class="punctuation">&#123;</span>  </span><br><span class="line">                alias  D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/img/;</span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">        location /static/css/ <span class="punctuation">&#123;</span>  </span><br><span class="line">                alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/css/;</span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">        location /static/js/ <span class="punctuation">&#123;</span>  </span><br><span class="line">                alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/js/;</span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">        location /static/plugins/ <span class="punctuation">&#123;</span>  </span><br><span class="line">                alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/plugins/;</span><br><span class="line">                add_header Access-Control-Allow-Origin http<span class="punctuation">:</span><span class="comment">//ucenter.51xuecheng.cn;  </span></span><br><span class="line">                add_header Access-Control-Allow-Credentials <span class="literal"><span class="keyword">true</span></span>;  </span><br><span class="line">                add_header Access-Control-Allow-Methods GET;</span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line">        location /plugins/ <span class="punctuation">&#123;</span>  </span><br><span class="line">                alias   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/plugins/;</span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        #error_page  <span class="number">404</span>              /<span class="number">404.</span>html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /<span class="number">50</span>x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line">        location = /<span class="number">50</span>x.html <span class="punctuation">&#123;</span></span><br><span class="line">            root   html;</span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">        # proxy the PHP scripts to Apache listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">80</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ <span class="punctuation">&#123;</span></span><br><span class="line">        #    proxy_pass   http<span class="punctuation">:</span><span class="comment">//127.0.0.1;</span></span><br><span class="line">        #<span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9000</span></span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ <span class="punctuation">&#123;</span></span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">9000</span>;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #<span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files<span class="punctuation">,</span> if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht <span class="punctuation">&#123;</span></span><br><span class="line">        #    deny  all;</span><br><span class="line">        #<span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>启动nginx:</p><p>进入任务管理器，杀死nginx的两个进程</p><p><img src="/breeze/ee0e64ec/image21.png"></p><p>杀死后再次双击nginx.exe。</p><p>启动成功在任务管理器会出现nginx的进程。</p><p>日志文件在nginx安装目录下的logs目录：</p><p><img src="/breeze/ee0e64ec/image22.png"></p><p>启动成功访问<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/">http://www.51xuecheng.cn</a></p><p><img src="/breeze/ee0e64ec/image23.png"></p><h5 id="2-3-2-课程详情页面"><a href="#2-3-2-课程详情页面" class="headerlink" title="2.3.2 课程详情页面"></a><strong>2.3.2 课程详情页面</strong></h5><p>course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。</p><p>course_template.html文件在xc-ui-pc-static-portal\course目录下</p><p><img src="/breeze/ee0e64ec/image24.png"></p><p>通过浏览器访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/course_template.html">http://www.51xuecheng.cn/course/course_template.html</a></p><p>效果如下：</p><p><img src="/breeze/ee0e64ec/image25.png"></p><p>出现这个画面说明模板文件正常浏览是没有问题的。</p><h5 id="2-3-3-文件服务器"><a href="#2-3-3-文件服务器" class="headerlink" title="2.3.3 文件服务器"></a><strong>2.3.3 文件服务器</strong></h5><p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问。如下图：</p><p><img src="/breeze/ee0e64ec/image26.png"></p><p>在hosts文件配置如下内容，如果已存在不要重复配置。</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.51xuecheng.cn file.51xuecheng.cn</span><br></pre></td></tr></table></figure><p>在nginx.conf中配置文件服务器的代理地址</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#文件服务</span><br><span class="line">upstream fileserver<span class="punctuation">&#123;</span></span><br><span class="line">    server <span class="number">192.168</span><span class="number">.101</span><span class="number">.65</span><span class="punctuation">:</span><span class="number">9000</span> weight=<span class="number">10</span>;</span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">server <span class="punctuation">&#123;</span></span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  file<span class="number">.51</span>xuecheng.cn;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    ssi on;</span><br><span class="line">    ssi_silent_errors on;</span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line">    location /video <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass   http<span class="punctuation">:</span><span class="comment">//fileserver;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">location /mediafiles <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass   http<span class="punctuation">:</span><span class="comment">//fileserver;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>配置完毕，重新加载nginx配置文件。</p><p>通过cmd进入nginx.exe所在目录,运行如下命令</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure><p>通过<a target="_blank" rel="noopener" href="http://file.51xuecheng.cn/mediafiles">http://file.51xuecheng.cn/mediafiles</a></p><p>在媒资数据库的文件表中找一个图片的地址进行测试。</p><h5 id="2-3-4-视频播放页面"><a href="#2-3-4-视频播放页面" class="headerlink" title="2.3.4 视频播放页面"></a><strong>2.3.4 视频播放页面</strong></h5><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p><p><a target="_blank" rel="noopener" href="http://51xuecheng.cn/course/course_template.html">http://51xuecheng.cn/course/course_template.html</a></p><p><img src="/breeze/ee0e64ec/image27.png"></p><p>首先在nginx.conf中配置视频播放页面的地址</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /course/preview/learning.html <span class="punctuation">&#123;</span></span><br><span class="line">    alias D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal/course/learning.html;</span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">location /course/search.html <span class="punctuation">&#123;</span>  </span><br><span class="line">    root   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal;</span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">location /course/learning.html <span class="punctuation">&#123;</span>  </span><br><span class="line">    root   D<span class="punctuation">:</span>/itcast2022/xc_edu3<span class="number">.0</span>/code_1/xc-ui-pc-static-portal;</span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><p>加载nginx配置文件</p><p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图：</p><p><img src="/breeze/ee0e64ec/image12-1686903180915-32.png"></p><p>下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址（找到自己的minio中存在视频的地址）。</p><p><img src="/breeze/ee0e64ec/image28.png"></p><p>配置完成，刷新页面，观察视频是否可以正常播放。</p><p><img src="/breeze/ee0e64ec/image29.png"></p><p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p><h4 id="2-4-接口定义"><a href="#2-4-接口定义" class="headerlink" title="2.4 接口定义"></a><strong>2.4 接口定义</strong></h4><h5 id="2-4-1-定义课程预览接口"><a href="#2-4-1-定义课程预览接口" class="headerlink" title="2.4.1 定义课程预览接口"></a><strong>2.4.1 定义课程预览接口</strong></h5><p>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。</p><p>下边对课程预览接口进行分析：</p><p>1、请求参数</p><p>传入课程id，表示要预览哪一门课程。</p><p>2、响应结果</p><p>输出课程详情页面到浏览器。</p><p>响应页面到浏览器使用freemarker模板引擎技术实现，首先从课程资料目录下获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources&#x2F;templates下，并将其在本目录复制一份命名为course_template.ftl</p><p><img src="/breeze/ee0e64ec/image30.png"></p><p>下边开始定义接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">        modelAndView.addObject(<span class="string">&quot;model&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/coursepreview/74">http://localhost:63040/content/coursepreview/74</a></p><p>如下图：</p><p><img src="/breeze/ee0e64ec/image31.png"></p><p>课程预览页面内容没有样式，稍后解决这个问题。</p><h5 id="2-4-2-配置反向代理"><a href="#2-4-2-配置反向代理" class="headerlink" title="2.4.2 配置反向代理"></a><strong>2.4.2 配置反向代理</strong></h5><p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问。</p><p><img src="/breeze/ee0e64ec/image32.png"></p><p>这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览。</p><p>1、在Nginx下配置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 后台网关，访问网关，通过网关去转发请求</span><br><span class="line"># 也可以直接配置内容服务的地址，但是这样配置会比较繁琐，因为还会有媒资服务等需要进行单独配置。直接配置网关，通过网关去转发请求，一劳永逸。</span><br><span class="line">upstream gatewayserver<span class="punctuation">&#123;</span></span><br><span class="line">    server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="punctuation">:</span><span class="number">63010</span> weight=<span class="number">10</span>;</span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">server <span class="punctuation">&#123;</span></span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    server_name  www<span class="number">.51</span>xuecheng.cn localhost;</span><br><span class="line">    ....</span><br><span class="line">    #api，所有以api开头的请求，全部转发到网关</span><br><span class="line">    location /api/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>2、重新加载Nginx配置文件：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.exe -s reload</span><br></pre></td></tr></table></figure><p>3、启动微服务网关</p><p>4、此时访问新地址： <a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/74">http://www.51xuecheng.cn/api/content/coursepreview/74</a></p><p>输出如下，页面样式正常。</p><p><img src="/breeze/ee0e64ec/image33.png"></p><blockquote><p><strong>这里我们是通过域名<code>www.51xuecheng.cn</code>进行访问的，然后通过网关转发请求去访问content服务。因为是通过域名进行访问的，所以自然会加载该域名下的所有静态资源。可以在nginx.conf文件中查看配置的详细信息。</strong></p></blockquote><p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。</p><p>目前的方式是通过Nginx访问网关，由网关再将请求转发到微服务，Nginx是整个的项目最前方的代理服务器，如下图：</p><p><img src="/breeze/ee0e64ec/image34.png"></p><h4 id="2-5-接口开发"><a href="#2-5-接口开发" class="headerlink" title="2.5 接口开发"></a><strong>2.5 接口开发</strong></h4><h5 id="2-5-1-数据模型"><a href="#2-5-1-数据模型" class="headerlink" title="2.5.1 数据模型"></a><strong>2.5.1 数据模型</strong></h5><p>课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示。如下图：</p><p><img src="/breeze/ee0e64ec/image11-1686903200088-41.png"></p><p>在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p><p>所以首先定义一个数据模型类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.model.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览数据模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePreviewDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程基本信息,课程营销信息</span></span><br><span class="line">    CourseBaseInfoDto courseBase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程计划信息</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplans;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//师资信息暂时不加...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CourseBaseInfoDto：包括了课程基本信息、营销信息。</p><p>List&lt;TeachplanDto&gt; ：包括了课程计划列表。</p><h5 id="2-5-2-Service接口"><a href="#2-5-2-Service接口" class="headerlink" title="2.5.2 Service接口"></a><strong>2.5.2 Service接口</strong></h5><p>Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto 对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览、发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 获取课程预览信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> com.xuecheng.content.model.dto.CoursePreviewDto</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/16 15:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseBaseInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.TeachplanTreeDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CourseBaseInfoService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.TeachplanService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 15:37</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CoursePublishService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TeachplanService teachplanService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getCoursePreviewInfo</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//课程基本信息、营销信息</span></span><br><span class="line">        <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//课程计划信息</span></span><br><span class="line">        List&lt;TeachplanDto&gt; teachplanTree= teachplanService.findTeachplanTree(courseId);</span><br><span class="line"></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePreviewDto</span>();</span><br><span class="line">        coursePreviewDto.setCourseBase(courseBaseInfo);</span><br><span class="line">        coursePreviewDto.setTeachplans(teachplanTree);</span><br><span class="line">        <span class="keyword">return</span> coursePreviewDto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-5-3-接口层完善"><a href="#2-5-3-接口层完善" class="headerlink" title="2.5.3 接口层完善"></a><strong>2.5.3 接口层完善</strong></h5><p>接口层Controller调用Service方法获取模板引擎需要的模型数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/coursepreview/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取课程预览信息</span></span><br><span class="line">    <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">modelAndView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>();</span><br><span class="line">    modelAndView.addObject(<span class="string">&quot;model&quot;</span>,coursePreviewInfo);</span><br><span class="line">    modelAndView.setViewName(<span class="string">&quot;course_template&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-5-4-前后端联调"><a href="#2-5-4-前后端联调" class="headerlink" title="2.5.4 前后端联调"></a><strong>2.5.4 前后端联调</strong></h5><p>原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下：</p><p><img src="/breeze/ee0e64ec/image35.png"></p><p>重启前端工程，进入课程列表点击”预览”按钮，正常打开课程预览页面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/2">http://www.51xuecheng.cn/api/content/coursepreview/2</a></p><p><img src="/breeze/ee0e64ec/image3-1686903205403-44.png"></p><h5 id="2-5-5-编写模板"><a href="#2-5-5-编写模板" class="headerlink" title="2.5.5 编写模板"></a><strong>2.5.5 编写模板</strong></h5><p>模型数据准备好后下一步将模型数据填充到course_template.ftl上，填充时注意不要一次填充太多，一边填充一边刷新调试。</p><p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p><p>修改模板后需要编译，如下图：</p><p><img src="/breeze/ee0e64ec/image36.png"></p><p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划。</p><p><img src="/breeze/ee0e64ec/image37.png"></p><p>完整的course_template.ftl模板在课程资料目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p><blockquote><p><strong><font color="red">注意：使用<code>freemarker</code>模板，进行数据填充的时候，如果数据为空，则可能会报错。此时可以使用空字符串填充</font></strong></p><p><strong>如：<code>&lt;span class=&quot;new-pic&quot;&gt;特惠价格￥$&#123;model.courseBase.price&#125;&lt;/span&gt;</code>这里<code>$&#123;model.courseBase.price&#125;</code>获取的数据可能为空，此时可以用空字符填充</strong></p><p><strong>使用方法：<code>&lt;span class=&quot;new-pic&quot;&gt;特惠价格￥$&#123;model.courseBase.price!&#39;&#39;&#125;&lt;/span&gt;</code>在数据后面加 <code>!&#39;&#39;</code> 即可</strong></p></blockquote><h5 id="2-5-6-视频播放页面接口"><a href="#2-5-6-视频播放页面接口" class="headerlink" title="2.5.6 视频播放页面接口"></a><strong>2.5.6 视频播放页面接口</strong></h5><p>从课程详情页面进入视频播放页面，如下图：</p><p><img src="/breeze/ee0e64ec/image38.png"></p><p>在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：</p><p>获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/open/content/course/whole/课程id</span><br><span class="line"></span><br><span class="line">响应：同课程预览service接口返回数据</span><br></pre></td></tr></table></figure><p>根据课程计划获取视频地址接口：&#x2F;open&#x2F;media&#x2F;preview&#x2F;{mediaId}</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/open/media/preview/课程计划id</span><br><span class="line"></span><br><span class="line">响应：</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;success&quot;</span><span class="punctuation">,</span><span class="attr">&quot;result&quot;</span><span class="punctuation">:</span><span class="string">&quot;视频的url&quot;</span><span class="punctuation">,</span><span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>1、在nginx配置如下地址（这两个地址是公开的，不用登录，谁都可以访问）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#openapi</span><br><span class="line">location /open/content/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/content/open/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br><span class="line">location /open/media/ <span class="punctuation">&#123;</span></span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//gatewayserver/media/open/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><p>配置运行nginx.exe -s reload加载nginx的配置文件</p><p>2、在内容管理接口层定义CourseOpenController类，并定义接口：获取课程信息接口：&#x2F;open&#x2F;content&#x2F;course&#x2F;whole&#x2F;{courseId}</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;课程公开查询接口&quot;,tags = &quot;课程公开查询接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseBaseInfoService courseBaseInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/course/whole/&#123;courseId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CoursePreviewDto <span class="title function_">getPreviewInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span> &#123;</span><br><span class="line">        <span class="comment">//获取课程预览信息</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(courseId);</span><br><span class="line">        <span class="keyword">return</span> coursePreviewInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、在媒资管理服务media-api工程定义MediaOpenController类，并定义接口&#x2F;open&#x2F;media&#x2F;preview&#x2F;</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(value = &quot;媒资文件管理接口&quot;,tags = &quot;媒资文件管理接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/open&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaOpenController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MediaFileService mediaFileService;    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;预览文件&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询媒资文件信息</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFileService.getFileById(mediaId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> RestResponse.validfail(<span class="string">&quot;找不到异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取出视频播放地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> mediaFiles.getUrl();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(url)) &#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;该视频正在处理中&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、在MediaFileService中自定义一个方法，并实现</p><p>定义方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据媒资id查询媒资信息</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> mediaId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">MediaFiles <span class="title function_">getFileById</span><span class="params">(String mediaId)</span>;</span><br></pre></td></tr></table></figure><p>实现上述方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String mediaId)</span> &#123;</span><br><span class="line">    <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(mediaId);</span><br><span class="line">    <span class="keyword">return</span> mediaFiles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、测试</p><p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p><p>&#x3D;&#x3D;<strong>这里在课程中，提交视频后，在课程预览中会有bug，<font color="red">请求不到视频</font>，抽时间改一下这个bug</strong>&#x3D;&#x3D;</p><blockquote><p><strong>注意：修改域名之后，媒资模块就没有办法提交视频了。报413错误</strong></p><p><strong>原因：</strong>nginx上传文件的最大限制为1M，需要修改一下配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">include       mime.types;</span><br><span class="line">default_type  application/octet-stream;</span><br><span class="line">client_max_body_size 10M;                    <span class="comment">#上传文件大小限制</span></span><br><span class="line">sendfile        on;                          <span class="comment">#设置为on表示启动高效传输文件的模式</span></span><br><span class="line">keepalive_timeout  1080;                     <span class="comment">#保持连接的时间，默认65s</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><h3 id="3-课程审核"><a href="#3-课程审核" class="headerlink" title="3 课程审核"></a><strong>3 课程审核</strong></h3><h4 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a><strong>3.1 需求分析</strong></h4><h5 id="3-1-1-业务流程"><a href="#3-1-1-业务流程" class="headerlink" title="3.1.1 业务流程"></a><strong>3.1.1 业务流程</strong></h5><p>根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图：</p><p><img src="/breeze/ee0e64ec/image7-1686903214583-49.png"></p><p>为什么课程审核通过才可以发布呢？</p><p>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</p><p>如何控制课程审核通过才可以发布课程呢？</p><p>在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p><p>下边是课程状态的转化关系：</p><p><img src="/breeze/ee0e64ec/image39.png"></p><p>说明如下：</p><p>1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。</p><p>2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。</p><p>3、当课程状态为已提交时运营平台人员对课程进行审核。</p><p>4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。</p><p>5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。</p><p>6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。</p><p>7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“</p><p>8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。</p><h5 id="3-1-2-数据模型"><a href="#3-1-2-数据模型" class="headerlink" title="3.1.2 数据模型"></a><strong>3.1.2 数据模型</strong></h5><p>通过业务流程的分析，现在我们思考：</p><p>1、课程提交审核后还允许修改课程吗？</p><p>如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。</p><p>如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？如下图：</p><p><img src="/breeze/ee0e64ec/image40.png"></p><p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。</p><p>为了解决这个问题，专门设计课程预发布表。</p><p>**如下图<font color="red">这个图是重点，一定要理解思想</font>**：</p><p><img src="/breeze/ee0e64ec/image41.png"></p><p>提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。</p><p>课程审核人员从预发布表查询信息进行审核。</p><p>课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p><p>课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。</p><p>2、提交审核课程后，也修改了课程信息，可以再次提交审核吗？</p><p>这个问题在上边分析课程审核状态时已经有了答案，如下图：</p><p><img src="/breeze/ee0e64ec/image42.png"></p><p>&#x3D;&#x3D;提交审核课程后，必须等到课程审核完成才可以再次提交课程。&#x3D;&#x3D;</p><p>课程审核功能涉及教学机构提交审核，运营人员进行课程审核。在课堂上我们仅实现教学机构提交审核功能，课程审核的结果通过手动修改数据库来实现。</p><p>虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。</p><p>提交审核将信息写入课程预发布表，课程预发布表结构如下：</p><p><img src="/breeze/ee0e64ec/image43.png"></p><p>更新课程基本信息表的课程审核状态为：已经提交</p><p>课程审核后更新课程基本信息表的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录。</p><p>审核记录表结构如下：</p><p><img src="/breeze/ee0e64ec/image44.png"></p><h4 id="3-2-接口定义"><a href="#3-2-接口定义" class="headerlink" title="3.2 接口定义"></a><strong>3.2 接口定义</strong></h4><p>下边定义提交课程审核的接口，在课程发布Controller中定义接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-接口开发"><a href="#3-3-接口开发" class="headerlink" title="3.3 接口开发"></a><strong>3.3 接口开发</strong></h4><h5 id="3-3-1-Dao开发"><a href="#3-3-1-Dao开发" class="headerlink" title="3.3.1 Dao开发"></a><strong>3.3.1 Dao开发</strong></h5><p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p><p>2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。</p><p>3、更新课程基本表course_base课程审核状态为：已提交。</p><p>约束：</p><p>1、对已提交审核的课程不允许提交审核。</p><p>2、本机构只允许提交本机构的课程。</p><p>3、没有上传图片不允许提交审核。</p><p>4、没有添加课程计划不允许提交审核。</p><p>使用代码生成器生成课程发布表、课程预发布表的PO、Mpper，并拷贝到相应的工程下。</p><h5 id="3-3-2-Service开发"><a href="#3-3-2-Service开发" class="headerlink" title="3.3.2 Service开发"></a><strong>3.3.2 Service开发</strong></h5><p>在课程发布Service类中定义接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 提交审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/18 10:31</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//约束校验</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">//课程审核状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> courseBase.getAuditStatus();</span><br><span class="line">    <span class="comment">//当前审核状态为已提交不允许再次提交</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;202003&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;当前为等待审核状态，审核完成可以再次提交。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span>(!courseBase.getCompanyId().equals(companyId))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程图片是否填写</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(courseBase.getPic()))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;提交失败，请上传课程图片&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加课程预发布记录</span></span><br><span class="line">    <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublishPre</span>();</span><br><span class="line">    <span class="comment">//课程基本信息加部分营销信息</span></span><br><span class="line">    <span class="type">CourseBaseInfoDto</span> <span class="variable">courseBaseInfo</span> <span class="operator">=</span> courseBaseInfoService.getCourseBaseInfo(courseId);</span><br><span class="line">    BeanUtils.copyProperties(courseBaseInfo,coursePublishPre);</span><br><span class="line">    <span class="comment">//课程营销信息</span></span><br><span class="line">    <span class="type">CourseMarket</span> <span class="variable">courseMarket</span> <span class="operator">=</span> courseMarketMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">//转为json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">courseMarketJson</span> <span class="operator">=</span> JSON.toJSONString(courseMarket);</span><br><span class="line">    <span class="comment">//将课程营销信息json数据放入课程预发布表</span></span><br><span class="line">    coursePublishPre.setMarket(courseMarketJson);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询课程计划信息</span></span><br><span class="line">    List&lt;TeachplanDto&gt; teachplanTree = teachplanService.findTeachplanTree(courseId);</span><br><span class="line">    <span class="keyword">if</span>(teachplanTree.size()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;提交失败，还没有添加课程计划&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//转json</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">teachplanTreeString</span> <span class="operator">=</span> JSON.toJSONString(teachplanTree);</span><br><span class="line">    coursePublishPre.setTeachplan(teachplanTreeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置预发布记录状态,已提交</span></span><br><span class="line">    coursePublishPre.setStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line">    <span class="comment">//教学机构id</span></span><br><span class="line">    coursePublishPre.setCompanyId(companyId);</span><br><span class="line">    <span class="comment">//提交时间</span></span><br><span class="line">    coursePublishPre.setCreateDate(LocalDateTime.now());</span><br><span class="line">    <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPreUpdate</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublishPreUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//添加课程预发布记录</span></span><br><span class="line">        coursePublishPreMapper.insert(coursePublishPre);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        coursePublishPreMapper.updateById(coursePublishPre);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新课程基本表的审核状态</span></span><br><span class="line">    courseBase.setAuditStatus(<span class="string">&quot;202003&quot;</span>);</span><br><span class="line">    courseBaseMapper.updateById(courseBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-4-接口完善"><a href="#3-4-接口完善" class="headerlink" title="3.4 接口完善"></a><strong>3.4 接口完善</strong></h4><p>完善接口层的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/courseaudit/commit/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commitAudit</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.commitAudit(companyId,courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-5-接口测试"><a href="#3-5-接口测试" class="headerlink" title="3.5 接口测试"></a><strong>3.5 接口测试</strong></h4><p>使用前端提前课程审核：</p><p>1、找一门信息不全的课程，测试各各约束条件。</p><p>2、正常提交后，观察数据库中课程预发布表记录的内容是否完整。</p><p>3、测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确。</p><p>审核通过需手动修改数据库：</p><p>1、修改课程预发布表的状态为审核通过202004。</p><p>2、修改课程基本表的审核状态为审核通过202004。</p><h3 id="4-课程发布"><a href="#4-课程发布" class="headerlink" title="4 课程发布"></a><strong>4 课程发布</strong></h3><h4 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a><strong>4.1 需求分析</strong></h4><h5 id="4-1-1-数据模型"><a href="#4-1-1-数据模型" class="headerlink" title="4.1.1 数据模型"></a><strong>4.1.1 数据模型</strong></h5><p>教学机构人员在课程审核通过后即可发布课程，课程发布后会公开展示在网站上供学生查看、选课和学习。</p><p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p><p>如何去快速搜索课程？</p><p>打开课程详情页面仍然去查询数据库可行吗？</p><p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p><p><img src="/breeze/ee0e64ec/image45.png"></p><p>1、向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p><p>2、向Redis存储课程缓存信息。</p><p>3、向Elasticsearch存储课程索引信息。</p><p>4、请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p><p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p><p><img src="/breeze/ee0e64ec/image46.png"></p><p>redis中的课程缓存信息是将课程发布表中的数据转为json进行存储。</p><p>elasticsearch中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p><p>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面。</p><h4 id="4-2-分布式事务技术方案"><a href="#4-2-分布式事务技术方案" class="headerlink" title="4.2 分布式事务技术方案"></a><strong>4.2 分布式事务技术方案</strong></h4><h5 id="4-2-1-什么是分布式事务"><a href="#4-2-1-什么是分布式事务" class="headerlink" title="4.2.1 什么是分布式事务"></a><strong>4.2.1 什么是分布式事务</strong></h5><p>一次课程发布操作需要向数据库、redis、elasticsearch、MinIO写四份数据，这里存在分布式事务问题。</p><p>什么是分布式事务？</p><p>首先理解什么是本地事务？</p><p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又被称为本地事务。</p><p>本地事务具有ACID四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p><p>理解了本地事务，什么是分布式事务？</p><p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p><p>在分布式系统中分布式事务的场景很多：</p><p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p><p>拿转账举例：</p><p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line">//1.本地数据库操作：张三减少金额 </span><br><span class="line">//2.本地数据库操作：李四增加金额 </span><br><span class="line">commit transation; </span><br></pre></td></tr></table></figure><p>但是在分布式环境下，会变成下边这样：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">begin transaction； </span><br><span class="line">//1.本地数据库操作：张三减少金额 </span><br><span class="line">//2.远程调用：让李四增加金额 </span><br><span class="line"></span><br><span class="line">commit transation;</span><br></pre></td></tr></table></figure><p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。</p><p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应 用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。</p><p>下边的场景都会产生分布式事务：</p><p>微服务架构下：</p><p><img src="/breeze/ee0e64ec/image47.png"></p><p>单服务多数据库：</p><p><img src="/breeze/ee0e64ec/image48.png"></p><p>多服务单数据库:</p><p><img src="/breeze/ee0e64ec/image49.png"></p><h5 id="4-2-2-什么是CAP理论"><a href="#4-2-2-什么是CAP理论" class="headerlink" title="4.2.2 什么是CAP理论"></a><strong>4.2.2 什么是CAP理论</strong></h5><p>&#x3D;&#x3D;控制分布式事务首先需要理解CAP理论，什么是CAP理论？&#x3D;&#x3D;</p><p>CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p><p>使用下边的分布式系统结构 进行说明：</p><p><img src="/breeze/ee0e64ec/image50.png"></p><p>客户端经过网关访问用户服务的两个结点，&#x3D;&#x3D;一致性是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。&#x3D;&#x3D;</p><p>&#x3D;&#x3D;可用性是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。&#x3D;&#x3D;</p><p>&#x3D;&#x3D;分区容忍性也叫分区容错性，当系统采用分布式架构时由于网络通信异常导致请求中断、消息丢失，但系统依然对外提供服务。&#x3D;&#x3D;</p><p>&#x3D;&#x3D;CAP理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。&#x3D;&#x3D;</p><p>满足P那么C和A不能同时满足：</p><p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p><p><img src="/breeze/ee0e64ec/image51.png"></p><p>如果要满足C一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点2时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足C的同时无法满足A。</p><p>如果要满足A可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p><p>所以在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP。</p><h5 id="4-2-3-分布式事务控制方案"><a href="#4-2-3-分布式事务控制方案" class="headerlink" title="4.2.3 分布式事务控制方案"></a><strong>4.2.3 分布式事务控制方案</strong></h5><p>学习了CAP理论该如何控制分布式事务呢？</p><p>学习了CAP理论我们知道进行分布式事务控制要在C和A中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断。</p><p>&#x3D;&#x3D;CP的场景：满足C舍弃A，强调一致性。&#x3D;&#x3D;</p><p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p><p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p><p>&#x3D;&#x3D;AP的场景：满足A舍弃C，强调可用性。&#x3D;&#x3D;</p><p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p><p>注册送积分，注册成功积分在24分到账。</p><p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p><p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p><p>&#x3D;&#x3D;什么是BASE理论？&#x3D;&#x3D;</p><p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p><p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p><p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p><p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p><p>&#x3D;&#x3D;分布式事务控制有哪些常用的技术方案？&#x3D;&#x3D;</p><p>实现CP就是要实现强一致性:</p><p>使用Seata框架基于AT模式实现</p><p>使用Seata框架基于TCC模式实现。</p><p>实现AP则要保证最终数据一致性:</p><p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p><p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p><h5 id="4-2-4-课程发布的事务控制方案"><a href="#4-2-4-课程发布的事务控制方案" class="headerlink" title="4.2.4 课程发布的事务控制方案"></a><strong>4.2.4 课程发布的事务控制方案</strong></h5><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p><p>满足CP？</p><p>如果要满足CP就表示课程发布操作后向数据库、redis、elasticsearch、MinIO写四份数据，只要有一份写失败其它的全部回滚。</p><p>满足AP？</p><p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p><p>目前我们已经有了任务调度的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足AP即可。</p><p>下图是具体的技术方案：</p><p><img src="/breeze/ee0e64ec/image52.png"></p><p>1、在内容管理服务的数据库中添加一个消息表，消息表和课程发布表在同一个数据库。</p><p>2、点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写课程发布的消息。通过数据库进行控制，只要课程发布表插入成功消息表也插入成功，消息表的数据就记录了某门课程发布的任务。</p><p>3、启动任务调度系统定时调度内容管理服务去定时扫描消息表的记录。</p><p>4、当扫描到课程发布的消息时即开始完成向redis、elasticsearch、MinIO同步数据的操作。</p><p>5、同步数据的任务完成后删除消息表记录。</p><p>时序图如下：</p><p>下图是课程发布操作的流程：</p><p><img src="/breeze/ee0e64ec/image53.png"></p><p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p><p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p><p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p><p>4、任务完成后删除消息表记录。</p><h4 id="4-3-课程发布接口"><a href="#4-3-课程发布接口" class="headerlink" title="4.3 课程发布接口"></a><strong>4.3 课程发布接口</strong></h4><h5 id="4-3-1-接口定义"><a href="#4-3-1-接口定义" class="headerlink" title="4.3.1 接口定义"></a><strong>4.3.1 接口定义</strong></h5><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p><p>在内容管理接口工程中定义课程发布接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程预览，发布</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/16 14:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程预览发布接口&quot;,tags = &quot;课程预览发布接口&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishController</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line">        <span class="meta">@ResponseBody</span></span><br><span class="line">        <span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h5 id="4-3-2-接口开发"><a href="#4-3-2-接口开发" class="headerlink" title="4.3.2 接口开发"></a><strong>4.3.2 接口开发</strong></h5><h6 id="4-3-2-1-DAO开发"><a href="#4-3-2-1-DAO开发" class="headerlink" title="4.3.2.1 DAO开发"></a><strong>4.3.2.1 DAO开发</strong></h6><p>课程发布操作对数据库操作如下：</p><p>1、向课程发布表course_publish插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。</p><p>2、更新course_base表的课程发布状态为：已发布</p><p>3、删除课程预发布表的对应记录。</p><p>4、向mq_message消息表插入一条消息，消息类型为：course_publish</p><p>约束：</p><p>1、课程审核通过方可发布。</p><p>2、本机构只允许发布本机构的课程。</p><p>以上功能使用自动生成的mapper接口即可完成。</p><p>1、在内容管理数据库创建mq_message消息表及消息历史消息表（历史表存储已经完成的消息）。</p><p><img src="/breeze/ee0e64ec/image54.png"></p><p>消息表结构如下：</p><p><img src="/breeze/ee0e64ec/image55.png"></p><p>2、生成mq_message消息表、course_publish课程发布表的po和mapper接口</p><p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p><h6 id="4-3-2-2-Service开发"><a href="#4-3-2-2-Service开发" class="headerlink" title="4.3.2.2 Service开发"></a><strong>4.3.2.2 Service开发</strong></h6><p>定义Service接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程发布接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId 课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:23</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId,Long courseId)</span>;</span><br></pre></td></tr></table></figure><p>编写课程发布的Service方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//约束校验</span></span><br><span class="line">    <span class="comment">//查询课程预发布表</span></span><br><span class="line">    <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程审核状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line">    <span class="comment">//审核通过方可发布</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存课程发布信息</span></span><br><span class="line">    saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存消息表</span></span><br><span class="line">    saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line">    coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 保存课程发布信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublish</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">    <span class="comment">//整合课程发布信息</span></span><br><span class="line">    <span class="comment">//查询课程预发布表</span></span><br><span class="line">    <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程预发布数据为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoursePublish</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拷贝到课程发布对象</span></span><br><span class="line">    BeanUtils.copyProperties(coursePublishPre,coursePublish);</span><br><span class="line">    coursePublish.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublishUpdate</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublishUpdate == <span class="literal">null</span>)&#123;</span><br><span class="line">        coursePublishMapper.insert(coursePublish);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        coursePublishMapper.updateById(coursePublish);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新课程基本表的发布状态</span></span><br><span class="line">    <span class="type">CourseBase</span> <span class="variable">courseBase</span> <span class="operator">=</span> courseBaseMapper.selectById(courseId);</span><br><span class="line">    courseBase.setStatus(<span class="string">&quot;203002&quot;</span>);</span><br><span class="line">    courseBaseMapper.updateById(courseBase);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录，稍后实现</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="4-3-2-3-接口完善"><a href="#4-3-2-3-接口完善" class="headerlink" title="4.3.2.3 接口完善"></a><strong>4.3.2.3 接口完善</strong></h6><p>完善接口层代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;课程发布&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/coursepublish/&#123;courseId&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursepublish</span><span class="params">(<span class="meta">@PathVariable(&quot;courseId&quot;)</span> Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">    coursePublishService.publish(companyId,courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-3-3-接口测试"><a href="#4-3-3-接口测试" class="headerlink" title="4.3.3 接口测试"></a><strong>4.3.3 接口测试</strong></h5><p>先使用httpclient方法测试：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">### 课程发布</span><br><span class="line">POST &#123;&#123;content_host&#125;&#125;/content/coursepublish/2</span><br></pre></td></tr></table></figure><p>先测试约束条件：</p><p>1、在未提交审核时进行课程发布测试。</p><p>2、在课程未审核通过时进行发布。</p><p>正常流程测试：</p><p>1、提交审核课程</p><p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p><p>3、执行课程发布</p><p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p><p>使用前后端联调方式测试。</p><h4 id="4-4-消息处理SDK"><a href="#4-4-消息处理SDK" class="headerlink" title="4.4 消息处理SDK"></a><strong>4.4 消息处理SDK</strong></h4><h5 id="4-4-1-消息模块技术方案"><a href="#4-4-1-消息模块技术方案" class="headerlink" title="4.4.1 消息模块技术方案"></a><strong>4.4.1 消息模块技术方案</strong></h5><p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p><p><img src="/breeze/ee0e64ec/image56.png"></p><p>上图中红色框内的都是与消息处理相关的操作：</p><p>1、新增消息表</p><p>2、扫描消息表。</p><p>3、更新消息表。</p><p>4、删除消息表。</p><p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p><p><img src="/breeze/ee0e64ec/image57.png"></p><p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p><p>如何解决这个问题？</p><p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p><p>是做成通用的服务，还是做成通用的代码组件呢？</p><p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p><p>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，比如：fastjson、Apache commons工具包等。</p><p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p><p>如果将消息处理做一个SDK工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本。</p><p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图所示：</p><p><img src="/breeze/ee0e64ec/image58.png"></p><p>下边对消息SDK的设计内容进行说明：</p><p>sdk需要提供执行任务的逻辑吗？</p><p>拿课程发布任务举例，执行课程发布任务是要向redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在sdk中不用实现任务逻辑，只需要提供一个抽象方法由具体的执行任务方去实现。</p><p>如何保证任务的幂等性？</p><p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p><p>如何保证任务不重复执行？</p><p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，根据分片参数去获取任务，另外阻塞调度策略为丢弃任务。</p><p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p><p>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</p><p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p><p><img src="/breeze/ee0e64ec/image59.png"></p><p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务。</p><p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息SDK还具有如下接口功能：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *  服务类</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-09-21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MqMessageService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MqMessage&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表记录，采用与扫描视频处理表相同的思路</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 扫描记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List 消息记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 18:55</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MqMessage&gt; <span class="title function_">getMessageList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completed</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 完成阶段任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 消息id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int 更新成功：1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">completedStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 查询阶段状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:54</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageOne</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageTwo</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageThree</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStageFour</span><span class="params">(<span class="type">long</span> id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>消息SDK提供消息处理抽象类，此抽象类供使用方去继承使用，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 19:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqMessage 执行任务内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean true:处理成功，false处理失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 任务处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 19:47</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 扫描消息表多线程执行任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType  消息类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count  一次取出任务总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/21 20:35</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal,  String messageType,<span class="type">int</span> count,<span class="type">long</span> timeout)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//扫描消息表获取任务清单</span></span><br><span class="line">            List&lt;MqMessage&gt; messageList = mqMessageService.getMessageList(shardIndex, shardTotal,messageType, count);</span><br><span class="line">            <span class="comment">//任务个数</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> messageList.size();</span><br><span class="line">            log.debug(<span class="string">&quot;取出待处理消息&quot;</span>+size+<span class="string">&quot;条&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(size&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建线程池</span></span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">            <span class="comment">//计数器</span></span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">            messageList.forEach(message -&gt; &#123;</span><br><span class="line">                threadPool.execute(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;开始任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                    <span class="comment">//处理任务</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> execute(message);</span><br><span class="line">                        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">                            log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;)&quot;</span>,message);</span><br><span class="line">                            <span class="comment">//更新任务状态,删除消息表记录,添加到历史表</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">completed</span> <span class="operator">=</span> mqMessageService.completed(message.getId());</span><br><span class="line">                            <span class="keyword">if</span> (completed&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行成功:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                log.debug(<span class="string">&quot;任务执行失败:&#123;&#125;&quot;</span>,message);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        log.debug(<span class="string">&quot;任务出现异常:&#123;&#125;,任务:&#123;&#125;&quot;</span>,e.getMessage(),message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//计数</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                    log.debug(<span class="string">&quot;结束任务:&#123;&#125;&quot;</span>,message);</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">            countDownLatch.await(timeout,TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(<span class="string">&quot;结束....&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-4-2-消息模块SDK测试"><a href="#4-4-2-消息模块SDK测试" class="headerlink" title="4.4.2 消息模块SDK测试"></a><strong>4.4.2 消息模块SDK测试</strong></h5><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p><p><img src="/breeze/ee0e64ec/image60.png"></p><p>3、修改test下的bootstrap.yml中的数据库连接</p><p>下边测试消息SDK的接口：</p><p>1、继承MessageProcessAbstract 抽象类编写任务执行方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MqMessageService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息处理测试类，继承MessageProcessAbstract</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:44</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClass</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MqMessageService mqMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行任务</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        log.debug(<span class="string">&quot;开始执行任务:&#123;&#125;&quot;</span>,id);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取出阶段状态</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始执行第一阶段任务&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> mqMessageService.completedStageOne(id);</span><br><span class="line">            <span class="keyword">if</span>(i&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;完成第一阶段任务&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;无需执行第一阶段任务&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、编写测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.messagesdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/21 21:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageProcessClassTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageProcessClass messageProcessClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;开始执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        messageProcessClass.process(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;test&quot;</span>, <span class="number">5</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;结束执行-----》&quot;</span> + LocalDateTime.now());</span><br><span class="line">        Thread.sleep(<span class="number">9000000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、准备测试数据，在消息表添加消息类型为”test”的消息</p><p>4、执行MessageProcessClassTest 类中的test()方法，观察控制台任务执行的日志信息。</p><h5 id="4-4-3-集成消息SDK"><a href="#4-4-3-集成消息SDK" class="headerlink" title="4.4.3 集成消息SDK"></a><strong>4.4.3 集成消息SDK</strong></h5><h6 id="4-4-3-1-添加消息"><a href="#4-4-3-1-添加消息" class="headerlink" title="4.4.3.1 添加消息"></a><strong>4.4.3.1 添加消息</strong></h6><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的xuecheng-plus-message-sdk到工程目录，如下图：</p><p><img src="/breeze/ee0e64ec/image60-1686903274326-73.png"></p><p>3、在内容管理service工程中添加sdk依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-plus-message-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4、课程发布操作使用本地事务保存课程发布信息、添加消息表。</p><p>回到当初编写课程发布时的代码，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Long companyId, Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//约束校验</span></span><br><span class="line">    <span class="comment">//查询课程预发布表</span></span><br><span class="line">    <span class="type">CoursePublishPre</span> <span class="variable">coursePublishPre</span> <span class="operator">=</span> coursePublishPreMapper.selectById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(coursePublishPre == <span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//本机构只允许提交本机构的课程</span></span><br><span class="line">    <span class="keyword">if</span>(!coursePublishPre.getCompanyId().equals(companyId))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;不允许提交其它机构的课程。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//课程审核状态</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">auditStatus</span> <span class="operator">=</span> coursePublishPre.getStatus();</span><br><span class="line">    <span class="comment">//审核通过方可发布</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="string">&quot;202004&quot;</span>.equals(auditStatus))&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;操作失败，课程审核通过方可发布。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存课程发布信息</span></span><br><span class="line">    saveCoursePublish(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存消息表</span></span><br><span class="line">    saveCoursePublishMessage(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除课程预发布表对应记录</span></span><br><span class="line">    coursePublishPreMapper.deleteById(courseId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们要填充的saveCoursePublishMessage(courseId)方法，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@description</span> 保存消息表记录</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@date</span> 2022/9/20 16:32</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCoursePublishMessage</span><span class="params">(Long courseId)</span>&#123;</span><br><span class="line">    <span class="type">MqMessage</span> <span class="variable">mqMessage</span> <span class="operator">=</span> mqMessageService.addMessage(<span class="string">&quot;course_publish&quot;</span>, String.valueOf(courseId), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span>(mqMessage==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(CommonError.UNKOWN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下边进行测试：</p><p>发布一门课程，观察消息表是否正常添加消息。</p><p>需要手动修改课程审核状态为审核通过执行发布操作，发布后可以修改发布状态为下架重新发布测试。</p><blockquote><p><strong>测试步骤：</strong></p><ul><li>先将course_publish_pre表中的记录的status字段改为202004</li><li>再将course_base表中对应的记录的audit_status改为202004</li><li>在前端页面中选择刚才修改的课程（可以采用搜索的方式），点击发布</li></ul><p><strong>结果：</strong></p><ul><li>course_publish_pre中原本存在的记录（对应发布的课程）被删除了</li><li>course_publish中会新增对应的记录</li><li>mq_message表中，也会新增对应的记录</li></ul></blockquote><h6 id="4-4-3-2-课程发布任务处理"><a href="#4-4-3-2-课程发布任务处理" class="headerlink" title="4.4.3.2 课程发布任务处理"></a><strong>4.4.3.2 课程发布任务处理</strong></h6><p>在内容管理服务添加消息处理sdk的依赖即可使用它，实现sdk中的MessageProcessAbstract类，重写execte方法。</p><p>实现sdk中的MessageProcessAbstract类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.service.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.model.po.MqMessage;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.messagesdk.service.MessageProcessAbstract;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/22 10:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 课程发布任务处理，如果此方法抛出异常，说明任务执行失败</span></span><br><span class="line">    <span class="comment">// 在这个方法中分别调用了三个自定义方法，只有这三个方法都执行成功，则该方法返回true</span></span><br><span class="line">    <span class="comment">// 该方法返回true，则说明任务完成</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(MqMessage mqMessage)</span> &#123;</span><br><span class="line">        <span class="comment">//获取消息相关的业务信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">businessKey1</span> <span class="operator">=</span> mqMessage.getBusinessKey1();</span><br><span class="line">        <span class="type">long</span> <span class="variable">courseId</span> <span class="operator">=</span> Integer.parseInt(businessKey1);</span><br><span class="line">        <span class="comment">//课程静态化</span></span><br><span class="line">        generateCourseHtml(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程索引</span></span><br><span class="line">        saveCourseIndex(mqMessage,courseId);</span><br><span class="line">        <span class="comment">//课程缓存</span></span><br><span class="line">        saveCourseCache(mqMessage,courseId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="comment">//消息id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">        <span class="comment">//消息处理的service</span></span><br><span class="line">        <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">        <span class="comment">//消息幂等性处理</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">        <span class="keyword">if</span>(stageOne &gt;<span class="number">0</span>)&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;课程静态化已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存第一阶段状态</span></span><br><span class="line">        mqMessageService.completedStageOne(id);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将课程信息缓存至redis</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseCache</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;将课程信息缓存至redis,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存课程索引信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseIndex</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;保存课程索引信息,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="4-4-3-3-开启任务调度"><a href="#4-4-3-3-开启任务调度" class="headerlink" title="4.4.3.3 开启任务调度"></a><strong>4.4.3.3 开启任务调度</strong></h6><p>1、首先在内容管理service工程中添加xxl-job依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、配置执行器</p><p>在nacos中在content-service-dev.yaml中配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://192.168.101.65:8088/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">coursepublish-job</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">8999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure><p>3、从媒资管理服务层工程中拷贝一个XxlJobConfig配置类到内容管理service工程中。</p><p>在xxl-job-admin控制台中添加执行器</p><p><img src="/breeze/ee0e64ec/image61.png"></p><p>3、编写任务调度入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoursePublishTask</span> <span class="keyword">extends</span> <span class="title class_">MessageProcessAbstract</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//任务调度入口</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;CoursePublishJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">coursePublishJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();	<span class="comment">// 执行器的序号， 从0开始	</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();	<span class="comment">// 执行器的总数</span></span><br><span class="line">        log.debug(<span class="string">&quot;shardIndex=&quot;</span>+shardIndex+<span class="string">&quot;,shardTotal=&quot;</span>+shardTotal);</span><br><span class="line">        <span class="comment">// 调用抽象类（父类）的方法执行任务</span></span><br><span class="line">        <span class="comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span></span><br><span class="line">        process(shardIndex,shardTotal,<span class="string">&quot;course_publish&quot;</span>,<span class="number">30</span>,<span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br></pre></td></tr></table></figure><p>4、在xxl-job添加任务</p><p><img src="/breeze/ee0e64ec/image62.png"></p><p>任务配置如下：</p><p><img src="/breeze/ee0e64ec/image63.png"></p><p>到此SDK开发、集成完成，下一步添加课程发布后页面静态化、课程缓存、课程索引等任务。</p><h6 id="4-4-3-4-测试"><a href="#4-4-3-4-测试" class="headerlink" title="4.4.3.4 测试"></a><strong>4.4.3.4 测试</strong></h6><p>在消息表添加课程发布的消息，消息类型为course_publish,business_key1为发布课程的ID</p><p>1、测试是否可以正常调度执行。</p><p>2、测试任务幂等性</p><p>在 saveCourseCache(mqMessage,courseId);处打断点，待执行到这里观察数据库第一阶段完成的标记预期标记为1。</p><p>结束进程，再重新启动，观察第一阶段的任务预期不再执行。</p><p>3、任务执行完成删除消息表记录，插入历史表，state状态字段为1</p><h4 id="4-5-页面静态化"><a href="#4-5-页面静态化" class="headerlink" title="4.5 页面静态化"></a><strong>4.5 页面静态化</strong></h4><h5 id="4-5-1-什么是页面静态化"><a href="#4-5-1-什么是页面静态化" class="headerlink" title="4.5.1 什么是页面静态化"></a><strong>4.5.1 什么是页面静态化</strong></h5><p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</p><p>什么是页面静态化？</p><p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p><p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p><p>什么时候能用页面静态化技术？</p><p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p><p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p><h5 id="4-5-2-静态化测试"><a href="#4-5-2-静态化测试" class="headerlink" title="4.5.2 静态化测试"></a><strong>4.5.2 静态化测试</strong></h5><p>下边使用freemarker技术对页面静态化生成html页面。</p><p>在内容管理service工程中添加freemarker依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>编写测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CoursePreviewDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.service.CoursePublishService;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.TemplateException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.freemarker.FreeMarkerTemplateUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> freemarker测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 18:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FreemarkerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CoursePublishService coursePublishService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试页面静态化</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGenerateHtmlByTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException &#123;</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> coursePublishService.getCoursePreviewInfo(<span class="number">2L</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>);</span><br><span class="line">        IOUtils.copy(inputStream, outputStream);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将content-api工程下的模板拷贝到content-service工程下：</p><p><img src="/breeze/ee0e64ec/image64.png"></p><p>执行测试方法，观察D:\develop\test.html 是否成功生成。</p><h5 id="4-5-3-上传文件测试"><a href="#4-5-3-上传文件测试" class="headerlink" title="4.5.3 上传文件测试"></a><strong>4.5.3 上传文件测试</strong></h5><h6 id="4-5-3-1-配置远程调用环境"><a href="#4-5-3-1-配置远程调用环境" class="headerlink" title="4.5.3.1 配置远程调用环境"></a><strong>4.5.3.1 配置远程调用环境</strong></h6><p>静态化生成文件后需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护文件系统中的文件，所以内容管理服务对页面静态化生成html文件需要调用媒资管理服务的上传文件接口。如下图：</p><p><img src="/breeze/ee0e64ec/image53-1686903286557-79.png"></p><p>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用，</p><p>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p><p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p><p>下边先准备Feign的开发环境:</p><p>1、在内容管理content-service工程添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign支持Multipart格式传参--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign.form<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-form-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、在nacos配置feign-dev.yaml公用配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">30000</span>  <span class="comment">#熔断超时时间</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">60000</span> <span class="comment">#连接超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">60000</span> <span class="comment">#读超时时间</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br></pre></td></tr></table></figure><p>3、在内容管理service工程和内容管理api工程都引入此配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shared-configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">feign-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">    <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>4、在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</p><h6 id="4-5-3-2-扩充上传文件接口"><a href="#4-5-3-2-扩充上传文件接口" class="headerlink" title="4.5.3.2 扩充上传文件接口"></a><strong>4.5.3.2 扩充上传文件接口</strong></h6><p>现在需要将课程的静态文件上传到minio，单独存储到course目录下，文件的objectname为”课程id.html”，原有的上传文件接口需要增加一个参数 objectname。</p><p>下边扩充媒资服务的上传文件接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;上传文件&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@RequestParam(value= &quot;objectName&quot;,required=false)</span> String objectName)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service接口也增加一个参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uploadFileParamsDto 上传文件信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> localFilePath 文件磁盘路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectName  如果传入objectname要按objectname的目录去存储，如果不传就按年月日目录结构去存储</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 文件信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath,String objectName)</span>;</span><br></pre></td></tr></table></figure><p>修改原有uploadFile方法，判断如果objectName为空则采取年月日样式的路径方式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储到minio中的对象名(带目录)</span></span><br><span class="line"><span class="keyword">if</span>(StringUtils.isEmpty(objectName))&#123;</span><br><span class="line">    objectName =  defaultFolderPath + fileMd5 + extension;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//        String objectName = defaultFolderPath + fileMd5 + extension;</span></span><br></pre></td></tr></table></figure><h6 id="4-5-3-3-远程调用测试"><a href="#4-5-3-3-远程调用测试" class="headerlink" title="4.5.3.3 远程调用测试"></a><strong>4.5.3.3 远程调用测试</strong></h6><p>在content-service下编写feign接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.config.MultipartSupportConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestPart;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资管理服务远程调用接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// value = &quot;media-api&quot; 指定调用的服务的为媒资api</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/media/upload/coursefile&quot;,consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile upload,<span class="meta">@RequestParam(value = &quot;objectName&quot;,required=false)</span> String objectName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在启动类添加@EnableFeignClients注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure><p>编写测试方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.feignclient.MediaServiceClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.commons.CommonsMultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试使用feign远程上传文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignUploadTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaServiceClient mediaServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用，上传文件</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"> 	    <span class="comment">// 将file转换成MultipartFile</span></span><br><span class="line">        <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> MultipartSupportConfig.getMultipartFile(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\develop\\test.html&quot;</span>));</span><br><span class="line">        mediaServiceClient.uploadFile(multipartFile,<span class="string">&quot;course&quot;</span>,<span class="string">&quot;test.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下边进行测试，启动媒资服务，执行测试方法，上传文件成功，进入minIO查看文件</p><p><img src="/breeze/ee0e64ec/image65.png"></p><p>访问：<a target="_blank" rel="noopener" href="http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html">http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html</a></p><p>查看是否可以正常访问。</p><blockquote><p><strong>测试：</strong>此时该<code>mediafiles/course</code>目录下多了一个<code>test.html</code>文件，这里就以该文件为例进行测试</p><ul><li><p>在浏览器地址栏输入 <a target="_blank" rel="noopener" href="http://192.168.101.65:9000/mediafiles/course/test.html">http://192.168.101.65:9000/mediafiles/course/test.html</a> ，发现可以访问到html中的内容，但是没有样式</p></li><li><p>之前配置了域名，现在通过域名进行访问 <a target="_blank" rel="noopener" href="http://file.51xuecheng.cn/mediafiles/course/test.html%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%90%8C%E6%A0%B7%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E5%88%B0html%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%98%E6%98%AF%E6%B2%A1%E6%9C%89%E6%A0%B7%E5%BC%8F%EF%BC%8C%E8%80%8C%E4%B8%94%E6%9F%90%E4%BA%9B%E5%86%85%E5%AE%B9%E6%98%AF404">http://file.51xuecheng.cn/mediafiles/course/test.html，发现同样可以访问到html页面中的内容，但是还是没有样式，而且某些内容是404</a>.</p></li><li><p><strong>原因：</strong>因为访问的域名是<code>file.51xuecheng.cn</code>，而在这个虚拟主机中，并没有css样式等内容（可以再nginx.conf配置文件中进行查看）</p></li><li><p><strong>解决方法：</strong>我们发现（在nginx.conf中进行查看）在主站中是有css样式等静态资源的。所以解决页面没有样式的问题，需要在nginx中配置虚拟目录，在<a href="http://www.51xuecheng.cn中，进行如下配置：">www.51xuecheng.cn中，进行如下配置：</a></p></li><li><pre><code class="shell">
</code></pre></li></ul><p>location &#x2F;course&#x2F; {<br>proxy_pass <a target="_blank" rel="noopener" href="http://fileserver/mediafiles/course/">http://fileserver/mediafiles/course/</a>;<br>}</p><h1 id="解释："><a href="#解释：" class="headerlink" title="解释："></a>解释：</h1><h1 id="凡是以-course开头的请求，都代理到-fileserver-mediafiles-course"><a href="#凡是以-course开头的请求，都代理到-fileserver-mediafiles-course" class="headerlink" title="凡是以 &#x2F;course开头的请求，都代理到&#x2F;fileserver&#x2F;mediafiles&#x2F;course"></a>凡是以 &#x2F;course开头的请求，都代理到&#x2F;fileserver&#x2F;mediafiles&#x2F;course</h1><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt;- 使nginx配置生效</span><br><span class="line"></span><br><span class="line">&gt;- ```shell</span><br><span class="line"> nginx.exe -s reload</span><br></pre></td></tr></table></figure><ul><li>最后通过主站进行访问即可：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/test.html">http://www.51xuecheng.cn/course/test.html</a></li></ul><p><strong>结果：</strong>内容和样式都正确显示</p></blockquote><h5 id="4-5-4-熔断降级处理"><a href="#4-5-4-熔断降级处理" class="headerlink" title="4.5.4 熔断降级处理"></a><strong>4.5.4 熔断降级处理</strong></h5><h6 id="4-5-4-1-什么是熔断降级"><a href="#4-5-4-1-什么是熔断降级" class="headerlink" title="4.5.4.1 什么是熔断降级"></a><strong>4.5.4.1 什么是熔断降级</strong></h6><p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p><p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p><p><img src="/breeze/ee0e64ec/image66.png"></p><p>如何解决由于微服务异常引起的雪崩效应呢？</p><p>可以采用熔断、降级的方法去解决。</p><p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p><p>熔断：</p><p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p><p><img src="/breeze/ee0e64ec/image67.png"></p><p>降级：</p><p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p><p><img src="/breeze/ee0e64ec/image68.png"></p><p>两者都是为了保护系统，&#x3D;&#x3D;<strong>熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</strong>&#x3D;&#x3D;</p><h6 id="4-5-4-2-熔断降级处理"><a href="#4-5-4-2-熔断降级处理" class="headerlink" title="4.5.4.2 熔断降级处理"></a><strong>4.5.4.2 熔断降级处理</strong></h6><p>项目使用Hystrix框架实现熔断、降级处理，在feign-dev.yaml中配置。</p><p>1、开启Feign熔断保护</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>2、设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">30000</span>  <span class="comment">#熔断超时时间</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">60000</span> <span class="comment">#连接超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">60000</span> <span class="comment">#读超时时间</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">0</span> <span class="comment">#重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br></pre></td></tr></table></figure><p>3、定义降级逻辑</p><p>两种方法：</p><p>1）fallback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class,fallback = MediaServiceClientFallback.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaServiceClient</span>&#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>定义一个fallback类MediaServiceClientFallback，&#x3D;&#x3D;此类实现了MediaServiceClient接口。&#x3D;&#x3D;</p><p>&#x3D;&#x3D;<strong>第一种方法无法取出熔断所抛出的异常</strong>&#x3D;&#x3D;，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题。</p><p>2）fallbackFactory</p><p>第二种方法在FeignClient中指定fallbackFactory ，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;media-api&quot;,configuration = MultipartSupportConfig.class,fallbackFactory = MediaServiceClientFallbackFactory.class)</span></span><br></pre></td></tr></table></figure><p>定义MediaServiceClientFallbackFactory如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;MediaServiceClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MediaServiceClient</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(MultipartFile upload, String objectName)</span> &#123;</span><br><span class="line">                <span class="comment">//降级方法</span></span><br><span class="line">                log.debug(<span class="string">&quot;调用媒资管理服务上传文件时发生熔断，异常信息:&#123;&#125;&quot;</span>,throwable.toString(),throwable);</span><br><span class="line">                <span class="comment">// 这里返回什么内容是自定义的</span></span><br><span class="line">                <span class="comment">// return &quot;abc&quot;;	可以</span></span><br><span class="line">                <span class="comment">// return &quot;123&quot; 也可</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;	<span class="comment">// 也可</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>降级处理逻辑：</p><p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p><blockquote><p><strong>总结：</strong></p><ul><li>使用fallback进行降级无法拿到熔断的异常信息；使用fallbackFactory进行降级可以拿到熔断的异常信息。</li></ul></blockquote><p>测试：</p><p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p><h5 id="4-5-5-课程静态化开发"><a href="#4-5-5-课程静态化开发" class="headerlink" title="4.5.5 课程静态化开发"></a><strong>4.5.5 课程静态化开发</strong></h5><p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行。</p><h6 id="4-5-5-1-静态化实现"><a href="#4-5-5-1-静态化实现" class="headerlink" title="4.5.5.1 静态化实现"></a><strong>4.5.5.1 静态化实现</strong></h6><p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p><p>在课程发布的service编写这两部分内容，最后通过消息去调度执行。</p><p>1、接口定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程静态化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> courseId  课程id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> File 静态化文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/23 16:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">generateCourseHtml</span><span class="params">(Long courseId)</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传课程静态化页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file  静态化文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/23 16:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">uploadCourseHtml</span><span class="params">(Long courseId,File file)</span>;</span><br></pre></td></tr></table></figure><p>2、接口实现</p><p>将之前编写的静态化测试代码以及上传静态文件测试代码拷贝过来使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> File <span class="title function_">generateCourseHtml</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//静态化文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">htmlFile</span>  <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//配置freemarker</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模板</span></span><br><span class="line">        <span class="comment">//选指定模板路径,classpath下templates下</span></span><br><span class="line">        <span class="comment">//得到classpath路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classpath</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResource(<span class="string">&quot;/&quot;</span>).getPath();</span><br><span class="line">        configuration.setDirectoryForTemplateLoading(<span class="keyword">new</span> <span class="title class_">File</span>(classpath + <span class="string">&quot;/templates/&quot;</span>));</span><br><span class="line">        <span class="comment">//设置字符编码</span></span><br><span class="line">        configuration.setDefaultEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定模板文件名称</span></span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(<span class="string">&quot;course_template.ftl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备数据</span></span><br><span class="line">        <span class="type">CoursePreviewDto</span> <span class="variable">coursePreviewInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getCoursePreviewInfo(courseId);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;model&quot;</span>, coursePreviewInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//静态化</span></span><br><span class="line">        <span class="comment">//参数1：模板，参数2：数据模型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FreeMarkerTemplateUtils.processTemplateIntoString(template, map);</span><br><span class="line">        <span class="comment">//            System.out.println(content);</span></span><br><span class="line">        <span class="comment">//将静态化内容输出到文件中</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> IOUtils.toInputStream(content);</span><br><span class="line">        <span class="comment">//创建静态化文件</span></span><br><span class="line">        htmlFile = File.createTempFile(<span class="string">&quot;course&quot;</span>,<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;课程静态化，生成静态文件:&#123;&#125;&quot;</span>,htmlFile.getAbsolutePath());</span><br><span class="line">        <span class="comment">//输出流</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(htmlFile);</span><br><span class="line">        IOUtils.copy(inputStream, outputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;课程静态化异常:&#123;&#125;&quot;</span>,e.toString());</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;课程静态化异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> htmlFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadCourseHtml</span><span class="params">(Long courseId, File file)</span> &#123;</span><br><span class="line">    <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> MultipartSupportConfig.getMultipartFile(file);</span><br><span class="line">    <span class="type">String</span> <span class="variable">course</span> <span class="operator">=</span> mediaServiceClient.uploadFile(multipartFile, <span class="string">&quot;course/&quot;</span>+courseId+<span class="string">&quot;.html&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(course==<span class="literal">null</span>)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;上传静态文件异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完善课程发布任务CoursePublishTask类的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成课程静态化页面并上传至文件系统</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateCourseHtml</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;开始进行课程静态化,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">    <span class="comment">//消息id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">    <span class="comment">//消息处理的service</span></span><br><span class="line">    <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">    <span class="comment">//消息幂等性处理</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stageOne</span> <span class="operator">=</span> mqMessageService.getStageOne(id);</span><br><span class="line">    <span class="keyword">if</span>(stageOne == <span class="number">1</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;课程静态化已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成静态化页面</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> coursePublishService.generateCourseHtml(courseId);</span><br><span class="line">    <span class="comment">//上传静态化页面</span></span><br><span class="line">    <span class="keyword">if</span>(file!=<span class="literal">null</span>)&#123;</span><br><span class="line">        coursePublishService.uploadCourseHtml(courseId,file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存第一阶段状态</span></span><br><span class="line">    mqMessageService.completedStageOne(id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="4-5-5-2-测试"><a href="#4-5-5-2-测试" class="headerlink" title="4.5.5.2 测试"></a><strong>4.5.5.2 测试</strong></h6><p>1、启动网关、媒资管理服务工程。</p><p>2、在内容管理api工程的启动类上配置FeignClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&#123;&quot;com.xuecheng.content.feignclient&quot;&#125;)</span></span><br></pre></td></tr></table></figure><p>在bootstrap.yml引用feign-dev.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">feign-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">xuecheng-plus-common</span></span><br><span class="line">  <span class="attr">refresh:</span> <span class="literal">true</span>  <span class="comment">#profiles默认为dev</span></span><br></pre></td></tr></table></figure><p>启动内容管理接口工程。</p><p>在CoursePublishTask类的execute方法中打上断点。</p><p>3、发布一门课程，保存消息表存在未处理的处理。</p><p>4、启动xxl-job调度中心、启动课程发布任务，等待定时调度。</p><p><img src="/breeze/ee0e64ec/image69.png"></p><p>5、观察任务调度日志，观察任务是否可以正常处理。</p><p>6、处理完成进入文件系统，查询mediafiles桶内是否存在以课程id命名的html文件</p><p><img src="/breeze/ee0e64ec/image70.png"></p><p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p><p>如果存在则说明课程静态化并上传到minio成功。</p><h6 id="4-5-5-3-浏览详细页面"><a href="#4-5-5-3-浏览详细页面" class="headerlink" title="4.5.5.3 浏览详细页面"></a><strong>4.5.5.3 浏览详细页面</strong></h6><p>课程静态化成功后可以用浏览器访问html文件是否可以正常浏览，下图表示可以正常浏览。</p><p><img src="/breeze/ee0e64ec/image71.png"></p><p>页面还没有样式，需要在nginx配置虚拟目录，在<a href="http://www.51xuecheng.cn下配置：">www.51xuecheng.cn下配置：</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /course/ <span class="punctuation">&#123;</span>  </span><br><span class="line">    proxy_pass http<span class="punctuation">:</span><span class="comment">//fileserver/mediafiles/course/;</span></span><br><span class="line"><span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure><p>加载nginx配置文件</p><p>访问：<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/117.html">http://www.51xuecheng.cn/course/117.html</a></p><p>2.html为以课程id命名的html文件。</p><h3 id="5-课程搜索"><a href="#5-课程搜索" class="headerlink" title="5 课程搜索"></a><strong>5 课程搜索</strong></h3><h4 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a><strong>5.1 需求分析</strong></h4><h5 id="5-1-1-模块介绍"><a href="#5-1-1-模块介绍" class="headerlink" title="5.1.1 模块介绍"></a><strong>5.1.1 模块介绍</strong></h5><p>搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。</p><p>本项目的课程搜索支持全文检索技术，什么是全文检索？</p><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/8028630?fromModule=lemma_inlink">全文检索</a>是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p><p>全文检索可以简单理解为通过索引搜索文章。</p><p><img src="/breeze/ee0e64ec/image72.png"></p><p>全文检索的速度非常快，早期应用在搜索引擎技术中，比如：百度、google等，现在通常一些大型网站的搜索功能都是采用全文检索技术。</p><p><img src="/breeze/ee0e64ec/image73.png"></p><p>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息。</p><p><img src="/breeze/ee0e64ec/image74.png"></p><p>所以，课程搜索模块包括两部分：课程索引、课程搜索。</p><p>课程索引是将课程信息建立索引。</p><p>课程搜索是通过前端网页，通过关键字等条件去搜索课程。</p><h5 id="5-1-2-业务流程"><a href="#5-1-2-业务流程" class="headerlink" title="5.1.2 业务流程"></a><strong>5.1.2 业务流程</strong></h5><p>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。</p><p>1、课程索引</p><p>在课程发布操作执行后通过消息处理方式创建课程索引，如下图：</p><p><img src="/breeze/ee0e64ec/image75.png"></p><p>本项目使用elasticsearch作为索引及搜索服务。</p><p>2、课程搜索</p><p>课程索引创建完成，用户才可以通过前端搜索课程信息。</p><p>课程搜索可以从首页进入搜索页面。</p><p><img src="/breeze/ee0e64ec/image76.png"></p><p>下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。</p><p><img src="/breeze/ee0e64ec/image77.png"></p><h4 id="5-2-准备环境"><a href="#5-2-准备环境" class="headerlink" title="5.2 准备环境"></a><strong>5.2 准备环境</strong></h4><h5 id="5-2-1-搭建elasticsearch"><a href="#5-2-1-搭建elasticsearch" class="headerlink" title="5.2.1 搭建elasticsearch"></a><strong>5.2.1 搭建elasticsearch</strong></h5><p>在课前下发的虚拟中已经在docker容器中安装了elasticsearch和kibana。</p><p>kibana 是 ELK（Elasticsearch , Logstash, Kibana ）之一，kibana 一款开源的数据分析和可视化平台，通过可视化界面访问elasticsearch的索引库，并可以生成一个数据报表。</p><p>开发中主要使用kibana通过api对elasticsearch进行索引和搜索操作，通过浏览器访问 <a target="_blank" rel="noopener" href="http://192.168.101.65:5601/app/dev_tools#/console%E8%BF%9B%E5%85%A5kibana%E7%9A%84%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E7%95%8C%E9%9D%A2%E3%80%82">http://192.168.101.65:5601/app/dev_tools#/console进入kibana的开发工具界面。</a></p><blockquote><p><strong><font color="red">注意：这里访问kibana可能会报如下错误：<code>kibana server is not ready yet</code>,可以通过命令：<code>docker logs kibana</code>，查看错误信息</font></strong></p><p><strong>&#x3D;&#x3D;解决方法：删除索引&#x3D;&#x3D;</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">curl -XDELETE localhost:9200/.kibana_task_manager_7.12.1_001</span></span><br></pre></td></tr></table></figure><p>然后重启<code>kibana</code>即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;docker restart kibana</span><br></pre></td></tr></table></figure></blockquote><p>修改虚拟机中的启动脚本restart.sh添加</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker stop elasticsearch</span><br><span class="line">docker stop kibana</span><br><span class="line"></span><br><span class="line">docker start elasticsearch</span><br><span class="line">docker start kibana</span><br></pre></td></tr></table></figure><p><img src="/breeze/ee0e64ec/image78.png"></p><p>可通过命令：GET &#x2F;_cat&#x2F;indices?v 查看所有的索引，通过此命令判断kibana是否正常连接elasticsearch。</p><p>索引相当于MySQL中的表，Elasticsearch与MySQL之间概念的对应关系见下表：</p><p><img src="/breeze/ee0e64ec/image79.png"></p><p>要使用elasticsearch需要建立索引，Mapping相当于表结构，Mapping创建后其字段不能删除，如果要删除需要删除整个索引，下边介绍创建索引、查询索引、删除索引的方法：</p><p>1、创建索引，并指定Mapping。</p><p>PUT &#x2F;course-publish</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;charge&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scaled_float&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;scaling_factor&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;originalPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;scaled_float&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;scaling_factor&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;validDays&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、查询索引</p><p>通过 GET &#x2F;_cat&#x2F;indices?v 查询所有的索引，查找course-publish是否创建成功。</p><p>通过GET &#x2F;course-publish&#x2F;_mapping 查询course-publish的索引结构。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;course-publish&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;charge&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;companyId&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;companyName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;search_analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;createDate&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;format&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;search_analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;grade&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mt&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mtName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;search_analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;originalPrice&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;scaled_float&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;scaling_factor&quot;</span> <span class="punctuation">:</span> <span class="number">100.0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;scaled_float&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;scaling_factor&quot;</span> <span class="punctuation">:</span> <span class="number">100.0</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;remark&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;st&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;stName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;search_analyzer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;teachmode&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;users&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;validDays&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、删除索引</p><p>如果发现创建的course-publish不正确可以删除重新创建。</p><p>删除索引后当中的文档数据也同时删除，一定要谨慎操作！</p><p>删除索引命令：DELETE &#x2F;course-publish</p><h5 id="5-2-2-部署搜索工程"><a href="#5-2-2-部署搜索工程" class="headerlink" title="5.2.2 部署搜索工程"></a><strong>5.2.2 部署搜索工程</strong></h5><p>拷贝课程资料中的xuecheng-plus-search搜索工程到自己的工程目录。</p><p><img src="/breeze/ee0e64ec/image80.png"></p><p>修改bootstrap.xml中nacos的namespace为自己的命名空间。</p><p>启动网关、搜索服务。</p><p>部署完成通过httpclient进行测试</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">### 添加课程索引</span><br><span class="line">POST <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>search_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/search/index/course</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;charge&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyId&quot;</span> <span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;北京黑马程序&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2022-09-25 09:36:11&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;204001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mtName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;编程开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Spring编程思想&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;originalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">200.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">100.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有备注&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;st&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Java语言&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;203002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有标签&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;teachmode&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;200002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;validDays&quot;</span> <span class="punctuation">:</span> <span class="number">222</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 搜索课程</span><br><span class="line">GET <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>search_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/search/course/list?pageNo=<span class="number">1</span>&amp;keywords=spring</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>进入前端搜索界面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/search.html">http://www.51xuecheng.cn/course/search.html</a></p><p><img src="/breeze/ee0e64ec/image81.png"></p><h4 id="5-3-索引管理"><a href="#5-3-索引管理" class="headerlink" title="5.3 索引管理"></a><strong>5.3 索引管理</strong></h4><h5 id="5-3-1-REST-API"><a href="#5-3-1-REST-API" class="headerlink" title="5.3.1 REST API"></a><strong>5.3.1 REST API</strong></h5><h6 id="5-3-1-1-添加文档"><a href="#5-3-1-1-添加文档" class="headerlink" title="5.3.1.1 添加文档"></a><strong>5.3.1.1 添加文档</strong></h6><p>索引创建好就可以向其中添加文档，此时elasticsearch会根据索引的mapping配置对有些字段进行分词。</p><p>这里我们要向course_publish中添加课程信息。</p><p>使用rest api进行测试，如下：</p><p>使用post请求，&#x2F;course-publish&#x2F;_doc&#x2F;103 第一部分为索引名称，_doc固定，103为文档的主键id，这里为课程id。</p><p>课程内容使用json表示。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /course-publish/_doc/<span class="number">103</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;charge&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyId&quot;</span> <span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;北京黑马程序&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2022-09-25 09:36:11&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;204001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mtName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;前端开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Html参考大全&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;originalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">200.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">100.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有备注&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;st&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-1-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;HTML/CSS&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;203002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有标签&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;teachmode&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;200002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;validDays&quot;</span> <span class="punctuation">:</span> <span class="number">222</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>如果要修改文档的内容可以使用上边相同的方法，如果没有则添加，如果存在则更新。</p><h6 id="5-3-1-2-查询文档"><a href="#5-3-1-2-查询文档" class="headerlink" title="5.3.1.2 查询文档"></a><strong>5.3.1.2 查询文档</strong></h6><p>添加文档成功后可以通过主键id查询该文档的信息。</p><p>语法如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&#123;索引库名称&#125;/_doc/&#123;id&#125;</span><br></pre></td></tr></table></figure><h6 id="5-3-1-3-更新文档"><a href="#5-3-1-3-更新文档" class="headerlink" title="5.3.1.3 更新文档"></a><strong>5.3.1.3 更新文档</strong></h6><p>更新文档分为全量更新和局部更新。</p><p>全量更新是指先删除再更新，语法如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_doc/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字段1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;字段2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ... 略</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>局部更新语法如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /<span class="punctuation">&#123;</span>索引库名<span class="punctuation">&#125;</span>/_update/文档id</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span> <span class="string">&quot;新的值&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h6 id="5-3-1-4-删除文档"><a href="#5-3-1-4-删除文档" class="headerlink" title="5.3.1.4 删除文档"></a><strong>5.3.1.4 删除文档</strong></h6><p>删除文档将从索引中删除文档的记录。</p><p>语法如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /&#123;索引库名&#125;/_doc/id值</span><br></pre></td></tr></table></figure><h5 id="5-3-2-接口定义"><a href="#5-3-2-接口定义" class="headerlink" title="5.3.2 接口定义"></a><strong>5.3.2 接口定义</strong></h5><p>当课程发布时请求添加课程接口添加课程信息到索引，当课程下架时请求删除课程接口从索引中删除课程信息，这里先实现添加课程接口。</p><p>根据索引的mapping结构创建po类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.po;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.annotation.JSONField;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 课程索引信息</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseIndex</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机构ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long companyId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 公司名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 适用人群</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String users;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 大分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 大分类名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String mtName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小分类名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String stName;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程等级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 教育模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String teachmode;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程图片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程介绍</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JSONField(format=&quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收费规则，对应数据字典--203</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String charge;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 现价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Float price;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 原价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Float originalPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 课程有效期天数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer validDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建索引接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.service.IndexService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程索引接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程信息索引接口&quot;, tags = &quot;课程信息索引接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseIndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加课程索引&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;course&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-3-接口开发"><a href="#5-3-3-接口开发" class="headerlink" title="5.3.3 接口开发"></a><strong>5.3.3 接口开发</strong></h5><p>定义service接口，请求elasticsearch添加课程信息。</p><p>注意：为了适应其它文档信息，将添加文档定义为通用的添加文档接口，此接口不仅适应添加课程还适应添加其它信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程索引service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:40</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IndexService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName 索引名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 索引对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Boolean true表示成功,false失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/24 22:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">addCourseIndex</span><span class="params">(String indexName,String id,Object object)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.service.IndexService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.DocWriteResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程索引管理接口实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/25 7:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IndexService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">addCourseIndex</span><span class="params">(String indexName,String id,Object object)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(object);</span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(indexName).id(id);</span><br><span class="line">        <span class="comment">//指定索引文档内容</span></span><br><span class="line">        indexRequest.source(jsonString,XContentType.JSON);</span><br><span class="line">        <span class="comment">//索引响应对象</span></span><br><span class="line">        <span class="type">IndexResponse</span> <span class="variable">indexResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            indexResponse = client.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;添加索引出错:&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加索引出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> indexResponse.getResult().name();</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        <span class="keyword">return</span> name.equalsIgnoreCase(<span class="string">&quot;created&quot;</span>) || name.equalsIgnoreCase(<span class="string">&quot;updated&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-4-接口完善"><a href="#5-3-4-接口完善" class="headerlink" title="5.3.4 接口完善"></a><strong>5.3.4 接口完善</strong></h5><p>完善接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.execption.XueChengPlusException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.service.IndexService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程索引接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程信息索引接口&quot;, tags = &quot;课程信息索引接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseIndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String courseIndexStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    IndexService indexService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加课程索引&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;course&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> courseIndex.getId();</span><br><span class="line">        <span class="keyword">if</span>(id==<span class="literal">null</span>)&#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;课程id为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> indexService.addCourseIndex(courseIndexStore, String.valueOf(id), courseIndex);</span><br><span class="line">        <span class="keyword">if</span>(!result)&#123;</span><br><span class="line">            XueChengPlusException.cast(<span class="string">&quot;添加课程索引失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-3-5-接口测试"><a href="#5-3-5-接口测试" class="headerlink" title="5.3.5 接口测试"></a><strong>5.3.5 接口测试</strong></h5><p>使用httpclient进行测试</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">### 添加课程索引</span><br><span class="line">POST <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>search_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/search/index/course</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;charge&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyId&quot;</span> <span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;companyName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;北京黑马程序员&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2022-09-25 09:36:11&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;《Java编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;204001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span> <span class="punctuation">:</span> <span class="number">102</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mt&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mtName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;编程开发&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Java编程思想&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;originalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">200.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">100.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remark&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有备注&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;st&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Java语言&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;203002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;没有标签&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;teachmode&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;200002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;validDays&quot;</span> <span class="punctuation">:</span> <span class="number">222</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="5-4-搜索"><a href="#5-4-搜索" class="headerlink" title="5.4 搜索"></a><strong>5.4 搜索</strong></h4><h5 id="5-4-1-需求分析"><a href="#5-4-1-需求分析" class="headerlink" title="5.4.1 需求分析"></a><strong>5.4.1 需求分析</strong></h5><p>索引信息维护完成下一步定义搜索接口搜索课程信息，首先需要搞清楚搜索功能的需求。</p><p>进入搜索界面，如下图：</p><p><img src="/breeze/ee0e64ec/image82.png"></p><p>根据搜索界面可知需求如下：</p><p>1、根据一级分类、二级分类搜索课程信息。</p><p>2、根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。</p><p>3、根据难度等级搜索课程。</p><p>4、搜索结点分页显示。</p><p>技术点：</p><p>1、整体采用布尔查询。</p><p>2、根据关键字搜索，采用MultiMatchQuery，搜索name、description字段。</p><p>3、根据分类、课程等级搜索采用过滤器实现。</p><p>4、分页查询。</p><p>5、高亮显示。</p><p>为什么课程分类、课程等级等查询使用过滤器方式？</p><p>使用关键字查询需要计算相关度得分，根据课程分类、课程等级去查询不需要计算相关度得分，使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度得分，效率更高。</p><h5 id="5-4-2-接口定义"><a href="#5-4-2-接口定义" class="headerlink" title="5.4.2 接口定义"></a><strong>5.4.2 接口定义</strong></h5><p>1、定义搜索条件DTO类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 搜索课程参数dtl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:36</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchCourseParamDto</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    <span class="keyword">private</span> String keywords;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//大分类</span></span><br><span class="line">    <span class="keyword">private</span> String mt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//小分类</span></span><br><span class="line">    <span class="keyword">private</span> String st;</span><br><span class="line">    <span class="comment">//难度等级</span></span><br><span class="line">    <span class="keyword">private</span> String grade;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/25 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchPageResultDto</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">PageResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SearchPageResultDto</span><span class="params">(List&lt;T&gt; items, <span class="type">long</span> counts, <span class="type">long</span> page, <span class="type">long</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(items, counts, page, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、为了适应后期的扩展，定义搜索结果类，让它继承PageResult</p><p>接口定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.dto.SearchCourseParamDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.service.CourseSearchService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程搜索接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(value = &quot;课程搜索接口&quot;,tags = &quot;课程搜索接口&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseSearchController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;课程搜索列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;CourseIndex&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-3-基本功能实现"><a href="#5-4-3-基本功能实现" class="headerlink" title="5.4.3 基本功能实现"></a><strong>5.4.3 基本功能实现</strong></h5><p>定义service接口，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.dto.SearchCourseParamDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.dto.SearchPageResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程搜索service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CourseSearchService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 搜索课程列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchCourseParamDto 搜索条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.search.po.CourseIndex&gt; 课程列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2022/9/24 22:45</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    SearchPageResultDto&lt;CourseIndex&gt; <span class="title function_">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto searchCourseParamDto)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>搜索接口的内容较多，我们分几步实现，首先实现根据分页搜索，接口实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.dto.SearchCourseParamDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.dto.SearchPageResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.po.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.search.service.CourseSearchService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.TotalHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.text.Text;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.BoolQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.MultiMatchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightField;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 课程搜索service实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/24 22:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CourseSearchServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CourseSearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.index&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String courseIndexStore;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;elasticsearch.course.source_fields&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String sourceFields;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title function_">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置索引</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(courseIndexStore);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">        <span class="comment">//source源字段过虑</span></span><br><span class="line">        String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageParams.getPageNo();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageParams.getPageSize();</span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) ((pageNo-<span class="number">1</span>)*pageSize);</span><br><span class="line">        searchSourceBuilder.from(start);</span><br><span class="line">        searchSourceBuilder.size(Math.toIntExact(pageSize));</span><br><span class="line">        <span class="comment">//布尔查询</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求搜索</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="keyword">new</span> <span class="title class_">ArrayList</span>(),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//结果集处理</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="comment">//记录总数</span></span><br><span class="line">        <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">        <span class="comment">//数据列表</span></span><br><span class="line">        List&lt;CourseIndex&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">CourseIndex</span> <span class="variable">courseIndex</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);</span><br><span class="line">            list.add(courseIndex);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pageResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-4-基本功能测试"><a href="#5-4-4-基本功能测试" class="headerlink" title="5.4.4 基本功能测试"></a><strong>5.4.4 基本功能测试</strong></h5><p>当输入查询条件时会查询全部课程信息并支持分页查询。</p><p>1、准备测试</p><p>启动nginx、网关、搜索服务。</p><p>使用kibana通过rest api向索引库添加课程信息，或通过httpclient添加课程信息，至少添加两条信息。</p><p>2、进入搜索界面</p><p>默认查询出刚才添加的课程信息。</p><p>3、修改分页参数测试分页</p><p>打开course&#x2F; search.html页面 ，找到如下图所示位置：</p><p><img src="/breeze/ee0e64ec/image83.png"></p><p>修改pageSize为1,即一页显示一条记录。</p><p>刷新搜索界面，每页显示一条记录，如下图：</p><p><img src="/breeze/ee0e64ec/image84.png"></p><h5 id="5-4-5-根据条件搜索"><a href="#5-4-5-根据条件搜索" class="headerlink" title="5.4.5 根据条件搜索"></a><strong>5.4.5 根据条件搜索</strong></h5><p>下边实现根据关键、一级分类、二级分类、难度等级搜索。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title function_">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置索引</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(courseIndexStore);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">//source源字段过虑</span></span><br><span class="line">    String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span>(courseSearchParam==<span class="literal">null</span>)&#123;</span><br><span class="line">        courseSearchParam = <span class="keyword">new</span> <span class="title class_">SearchCourseParamDto</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;</span><br><span class="line">        <span class="comment">//匹配关键字</span></span><br><span class="line">        <span class="type">MultiMatchQueryBuilder</span> <span class="variable">multiMatchQueryBuilder</span> <span class="operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//设置匹配占比</span></span><br><span class="line">        multiMatchQueryBuilder.minimumShouldMatch(<span class="string">&quot;70%&quot;</span>);</span><br><span class="line">        <span class="comment">//提升另个字段的Boost值</span></span><br><span class="line">        multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过虑</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;stName&quot;</span>,courseSearchParam.getSt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageParams.getPageNo();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageParams.getPageSize();</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) ((pageNo-<span class="number">1</span>)*pageSize);</span><br><span class="line">    searchSourceBuilder.from(start);</span><br><span class="line">    searchSourceBuilder.size(Math.toIntExact(pageSize));</span><br><span class="line">    <span class="comment">//布尔查询</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求搜索</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="keyword">new</span> <span class="title class_">ArrayList</span>(),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//结果集处理</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//记录总数</span></span><br><span class="line">    <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">    <span class="comment">//数据列表</span></span><br><span class="line">    List&lt;CourseIndex&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">CourseIndex</span> <span class="variable">courseIndex</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        list.add(courseIndex);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-6-条件搜索测试"><a href="#5-4-6-条件搜索测试" class="headerlink" title="5.4.6 条件搜索测试"></a><strong>5.4.6 条件搜索测试</strong></h5><p>进入搜索界面，输入关键字进行测试。</p><p>一级分类、二级分类在下边的聚合搜索中测试。</p><h5 id="5-4-7-聚合搜索"><a href="#5-4-7-聚合搜索" class="headerlink" title="5.4.7 聚合搜索"></a><strong>5.4.7 聚合搜索</strong></h5><p>搜索界面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类。</p><p>1、首先在搜索结构DTO中添加一级分类、二级分类列表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.search.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/25 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchPageResultDto</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">PageResult</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//大分类列表</span></span><br><span class="line">    List&lt;String&gt; mtList;</span><br><span class="line">    <span class="comment">//小分类列表</span></span><br><span class="line">    List&lt;String&gt; stList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SearchPageResultDto</span><span class="params">(List&lt;T&gt; items, <span class="type">long</span> counts, <span class="type">long</span> page, <span class="type">long</span> pageSize)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(items, counts, page, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、搜索方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title function_">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置索引</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(courseIndexStore);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">//source源字段过虑</span></span><br><span class="line">    String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span>(courseSearchParam==<span class="literal">null</span>)&#123;</span><br><span class="line">        courseSearchParam = <span class="keyword">new</span> <span class="title class_">SearchCourseParamDto</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;</span><br><span class="line">        <span class="comment">//匹配关键字</span></span><br><span class="line">        <span class="type">MultiMatchQueryBuilder</span> <span class="variable">multiMatchQueryBuilder</span> <span class="operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//设置匹配占比</span></span><br><span class="line">        multiMatchQueryBuilder.minimumShouldMatch(<span class="string">&quot;70%&quot;</span>);</span><br><span class="line">        <span class="comment">//提升另个字段的Boost值</span></span><br><span class="line">        multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过虑</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;stName&quot;</span>,courseSearchParam.getSt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageParams.getPageNo();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageParams.getPageSize();</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) ((pageNo-<span class="number">1</span>)*pageSize);</span><br><span class="line">    searchSourceBuilder.from(start);</span><br><span class="line">    searchSourceBuilder.size(Math.toIntExact(pageSize));</span><br><span class="line">    <span class="comment">//布尔查询</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求搜索</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//聚合设置</span></span><br><span class="line">    buildAggregation(searchRequest);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="keyword">new</span> <span class="title class_">ArrayList</span>(),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//结果集处理</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//记录总数</span></span><br><span class="line">    <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">    <span class="comment">//数据列表</span></span><br><span class="line">    List&lt;CourseIndex&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">CourseIndex</span> <span class="variable">courseIndex</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        list.add(courseIndex);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取聚合结果</span></span><br><span class="line">    List&lt;String&gt; mtList= getAggregation(searchResponse.getAggregations(), <span class="string">&quot;mtAgg&quot;</span>);</span><br><span class="line">    List&lt;String&gt; stList = getAggregation(searchResponse.getAggregations(), <span class="string">&quot;stAgg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pageResult.setMtList(mtList);</span><br><span class="line">    pageResult.setStList(stList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-8-聚合搜索测试"><a href="#5-4-8-聚合搜索测试" class="headerlink" title="5.4.8 聚合搜索测试"></a><strong>5.4.8 聚合搜索测试</strong></h5><p>进入搜索界面，观察搜索请求的响应内容中是否存在mtList和stList.</p><p>观察页面一级分类、二级分类是否有分类信息。</p><p>注意：当选中一个一级分类时才会显示二级分类。</p><h5 id="5-4-9-高亮设置"><a href="#5-4-9-高亮设置" class="headerlink" title="5.4.9 高亮设置"></a><strong>5.4.9 高亮设置</strong></h5><p>最后实现关键词在课程名称中高亮显示。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SearchPageResultDto&lt;CourseIndex&gt; <span class="title function_">queryCoursePubIndex</span><span class="params">(PageParams pageParams, SearchCourseParamDto courseSearchParam)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置索引</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(courseIndexStore);</span><br><span class="line"></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="comment">//source源字段过虑</span></span><br><span class="line">    String[] sourceFieldsArray = sourceFields.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    searchSourceBuilder.fetchSource(sourceFieldsArray, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">if</span>(courseSearchParam==<span class="literal">null</span>)&#123;</span><br><span class="line">        courseSearchParam = <span class="keyword">new</span> <span class="title class_">SearchCourseParamDto</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;</span><br><span class="line">        <span class="comment">//匹配关键字</span></span><br><span class="line">        <span class="type">MultiMatchQueryBuilder</span> <span class="variable">multiMatchQueryBuilder</span> <span class="operator">=</span> QueryBuilders.multiMatchQuery(courseSearchParam.getKeywords(), <span class="string">&quot;name&quot;</span>, <span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="comment">//设置匹配占比</span></span><br><span class="line">        multiMatchQueryBuilder.minimumShouldMatch(<span class="string">&quot;70%&quot;</span>);</span><br><span class="line">        <span class="comment">//提升另个字段的Boost值</span></span><br><span class="line">        multiMatchQueryBuilder.field(<span class="string">&quot;name&quot;</span>,<span class="number">10</span>);</span><br><span class="line">        boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//过虑</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;mtName&quot;</span>,courseSearchParam.getMt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;stName&quot;</span>,courseSearchParam.getSt()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;</span><br><span class="line">        boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;grade&quot;</span>,courseSearchParam.getGrade()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//分页</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageNo</span> <span class="operator">=</span> pageParams.getPageNo();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">pageSize</span> <span class="operator">=</span> pageParams.getPageSize();</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">int</span>) ((pageNo-<span class="number">1</span>)*pageSize);</span><br><span class="line">    searchSourceBuilder.from(start);</span><br><span class="line">    searchSourceBuilder.size(Math.toIntExact(pageSize));</span><br><span class="line">    <span class="comment">//布尔查询</span></span><br><span class="line">    searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">    <span class="comment">//高亮设置</span></span><br><span class="line">    <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">//设置高亮字段</span></span><br><span class="line">    highlightBuilder.fields().add(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">    <span class="comment">//请求搜索</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">//聚合设置</span></span><br><span class="line">    buildAggregation(searchRequest);</span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(<span class="string">&quot;课程搜索异常：&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;CourseIndex&gt;(<span class="keyword">new</span> <span class="title class_">ArrayList</span>(),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//结果集处理</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//记录总数</span></span><br><span class="line">    <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">    <span class="comment">//数据列表</span></span><br><span class="line">    List&lt;CourseIndex&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">        <span class="type">CourseIndex</span> <span class="variable">courseIndex</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, CourseIndex.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取出source</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//课程id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> courseIndex.getId();</span><br><span class="line">        <span class="comment">//取出名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> courseIndex.getName();</span><br><span class="line">        <span class="comment">//取出高亮字段内容</span></span><br><span class="line">        Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">        <span class="keyword">if</span>(highlightFields!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">HighlightField</span> <span class="variable">nameField</span> <span class="operator">=</span> highlightFields.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(nameField!=<span class="literal">null</span>)&#123;</span><br><span class="line">                Text[] fragments = nameField.getFragments();</span><br><span class="line">                <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                <span class="keyword">for</span> (Text str : fragments) &#123;</span><br><span class="line">                    stringBuffer.append(str.string());</span><br><span class="line">                &#125;</span><br><span class="line">                name = stringBuffer.toString();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        courseIndex.setId(id);</span><br><span class="line">        courseIndex.setName(name);</span><br><span class="line"></span><br><span class="line">        list.add(courseIndex);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    SearchPageResultDto&lt;CourseIndex&gt; pageResult = <span class="keyword">new</span> <span class="title class_">SearchPageResultDto</span>&lt;&gt;(list, totalHits.value,pageNo,pageSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取聚合结果</span></span><br><span class="line">    List&lt;String&gt; mtList= getAggregation(searchResponse.getAggregations(), <span class="string">&quot;mtAgg&quot;</span>);</span><br><span class="line">    List&lt;String&gt; stList = getAggregation(searchResponse.getAggregations(), <span class="string">&quot;stAgg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pageResult.setMtList(mtList);</span><br><span class="line">    pageResult.setStList(stList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-4-10-高亮设置测试"><a href="#5-4-10-高亮设置测试" class="headerlink" title="5.4.10 高亮设置测试"></a><strong>5.4.10 高亮设置测试</strong></h5><p>输入关键字，观察搜索结果，标题中是否对关键字信息进行高亮显示。</p><h4 id="5-5-课程信息索引同步"><a href="#5-5-课程信息索引同步" class="headerlink" title="5.5 课程信息索引同步"></a><strong>5.5 课程信息索引同步</strong></h4><h5 id="5-5-1-技术方案"><a href="#5-5-1-技术方案" class="headerlink" title="5.5.1 技术方案"></a><strong>5.5.1 技术方案</strong></h5><p>通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是将关系数据中的数据同步到elasticsearch索引中的过程，可以简单成为索引同步。</p><p>通常项目中使用elasticsearch需要完成索引同步，索引同步的方法很多：</p><p>1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。</p><p>1）同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p><p>2）可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。</p><p>canal主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。</p><p><img src="/breeze/ee0e64ec/image85.png"></p><p>它的地址：</p><p>github地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p><p>版本下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p><p>文档地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">https://github.com/alibaba/canal/wiki/Docker-QuickStart</a></p><p>Canal基于mysql的binlog技术实现数据同步，什么是binlog，它是一个文件，二进制格式，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。</p><p>所以，使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下：</p><p><img src="/breeze/ee0e64ec/image86.png"></p><p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump</p><p>协议</p><p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</p><p>3、canal 解析 binary log 对象(原始为 byte 流)</p><p>&#x3D;&#x3D;详细使用Canal进行索引同步的步骤参考：Canal实现索引同步.pdf&#x3D;&#x3D;</p><p>&#x3D;&#x3D;资料中没有，后面自己补一下&#x3D;&#x3D;</p><p>2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</p><p>MQ：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p><p>Logstash： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p><p>任务调度：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。</p><p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p><p>如下图：</p><p><img src="/breeze/ee0e64ec/image87.png"></p><p>1、课程发布向消息表插入记录。</p><p>2、由任务调度程序通过消息处理SDK对消息记录进行处理。</p><p>3、向elasticsearch索引中保存课程信息。</p><p>如何向向elasticsearch索引中保存课程信息？</p><p>执行流程如下：</p><p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求elasticsearch向课程索引中添加文档。</p><h5 id="5-5-2-课程索引任务开发"><a href="#5-5-2-课程索引任务开发" class="headerlink" title="5.5.2 课程索引任务开发"></a><strong>5.5.2 课程索引任务开发</strong></h5><p>1、拷贝CourseIndex 模型类到内容管理model 工程的dto包下。</p><p>2、在内容管理服务中添加FeignClient</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.content.feignclient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.content.model.dto.CourseIndex;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 搜索服务远程接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Mr.M</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/20 20:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;search&quot;,fallbackFactory = SearchServiceClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SearchServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/index/course&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> CourseIndex courseIndex)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义SearchServiceClientFallbackFactory ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchServiceClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;SearchServiceClient&gt; &#123;</span><br><span class="line">    <span class="comment">// 面试可能会被问，注意</span></span><br><span class="line">    <span class="comment">// 实现的什么接口，泛型是什么</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SearchServiceClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchServiceClient</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Boolean <span class="title function_">add</span><span class="params">(CourseIndex courseIndex)</span> &#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                log.debug(<span class="string">&quot;调用搜索发生熔断走降级方法,熔断异常:&quot;</span>, throwable.getMessage());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、编写课程索引任务执行方法</p><p>完善CoursePublishTask类中的saveCourseIndex方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存课程索引信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCourseIndex</span><span class="params">(MqMessage mqMessage,<span class="type">long</span> courseId)</span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;保存课程索引信息,课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> mqMessage.getId();</span><br><span class="line">    <span class="comment">//消息处理的service</span></span><br><span class="line">    <span class="type">MqMessageService</span> <span class="variable">mqMessageService</span> <span class="operator">=</span> <span class="built_in">this</span>.getMqMessageService();</span><br><span class="line">    <span class="comment">//消息幂等性处理</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stageTwo</span> <span class="operator">=</span> mqMessageService.getStageTwo(id);</span><br><span class="line">    <span class="keyword">if</span>(stageTwo &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;课程索引已处理直接返回，课程id:&#123;&#125;&quot;</span>,courseId);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> saveCourseIndex(courseId);</span><br><span class="line">    <span class="keyword">if</span>(result)&#123;</span><br><span class="line">        <span class="comment">//保存第一阶段状态</span></span><br><span class="line">        mqMessageService.completedStageTwo(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Boolean <span class="title function_">saveCourseIndex</span><span class="params">(Long courseId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取出课程发布信息</span></span><br><span class="line">    <span class="type">CoursePublish</span> <span class="variable">coursePublish</span> <span class="operator">=</span> coursePublishMapper.selectById(courseId);</span><br><span class="line">    <span class="comment">//拷贝至课程索引对象</span></span><br><span class="line">    <span class="type">CourseIndex</span> <span class="variable">courseIndex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CourseIndex</span>();</span><br><span class="line">    BeanUtils.copyProperties(coursePublish,courseIndex);</span><br><span class="line">    <span class="comment">//远程调用搜索服务api添加课程信息到索引</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">add</span> <span class="operator">=</span> searchServiceClient.add(courseIndex);</span><br><span class="line">    <span class="keyword">if</span>(!add)&#123;</span><br><span class="line">        XueChengPlusException.cast(<span class="string">&quot;添加索引失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> add;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-5-3-测试"><a href="#5-5-3-测试" class="headerlink" title="5.5.3 测试"></a><strong>5.5.3 测试</strong></h5><p>测试流程如下：</p><p>1、启动elasticsearch、kibana。</p><p>2、启动网关、内容管理、搜索服务、nginx。</p><p>3、启动xxl-job调度中心。</p><p>4、在任务调度中心开始课程发布任务。</p><p>5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。</p><p><mark>6、经过任务调度将课程信息写入索引。</mark></p><p><mark>7、通过门户进入搜索页面，查看课程信息是否展示。（进入学成在线主页，点击课程，若该页面有对应发布的课程，则测试成功）</mark></p><blockquote><p><strong>说明：</strong></p><p>在课程列表中对相应课程点击发布后，mq_message会出现对应的预发布的记录，然后xxl-job执行器会扫描mq_message这张表，会将该表中的记录进行发布。将记录发布之后，mq_message中的记录就会被删除，然后mq_message_history这张表中，会新增对应的记录。</p></blockquote></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/ee0e64ec.html">https://mliutm.github.io/breeze/ee0e64ec.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1688475747590-d0db5e2412cb.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/ef2dc3df.html" title="学成在线-认证授权模块（五）"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">学成在线-认证授权模块（五）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/e273b43.html" title="学成在线-媒资管理模块（三）"><img class="cover" src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线-媒资管理模块（三）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/ef2dc3df.html" title="学成在线-认证授权模块（五）"><img class="cover" src="/img/photo-1645943020355-305df166473d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-30</div><div class="title">学成在线-认证授权模块（五）</div></div></a></div><div><a href="/breeze/c8b66f0a.html" title="File类"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">File类</div></div></a></div><div><a href="/breeze/fed4c017.html" title="IO流"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-15</div><div class="title">IO流</div></div></a></div><div><a href="/breeze/a4950fb1.html" title="Redis实战-黑马点评"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">Redis实战-黑马点评</div></div></a></div><div><a href="/breeze/ab319c68.html" title="SpringCloud-Alibaba快速入门"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">SpringCloud-Alibaba快速入门</div></div></a></div><div><a href="/breeze/4c9bef51.html" title="base抽取与代码生成器（三）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-28</div><div class="title">base抽取与代码生成器（三）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3-1"><span class="toc-text">第4章 课程发布v3.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">1 模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.1 模块介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="toc-text">1.2.1 课程预览</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="toc-text">1.2.2 课程审核</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-text">1.2.3 课程发布</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="toc-text">2 课程预览</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">2.1 需求分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-text">2.2 模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-text">2.2.1 什么是模板引擎</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-Freemarker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">2.2.2 Freemarker快速入门</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E6%B5%8B%E8%AF%95%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="toc-text">2.3 测试静态页面</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1-%E9%83%A8%E7%BD%B2%E7%BD%91%E7%AB%99%E9%97%A8%E6%88%B7"><span class="toc-text">2.3.1 部署网站门户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-%E8%AF%BE%E7%A8%8B%E8%AF%A6%E6%83%85%E9%A1%B5%E9%9D%A2"><span class="toc-text">2.3.2 课程详情页面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3-%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">2.3.3 文件服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-4-%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2"><span class="toc-text">2.3.4 视频播放页面</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">2.4 接口定义</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-%E5%AE%9A%E4%B9%89%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.4.1 定义课程预览接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">2.4.2 配置反向代理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">2.5 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">2.5.1 数据模型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-2-Service%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.5.2 Service接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-3-%E6%8E%A5%E5%8F%A3%E5%B1%82%E5%AE%8C%E5%96%84"><span class="toc-text">2.5.3 接口层完善</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-4-%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83"><span class="toc-text">2.5.4 前后端联调</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-5-%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF"><span class="toc-text">2.5.5 编写模板</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-6-%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.5.6 视频播放页面接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%BE%E7%A8%8B%E5%AE%A1%E6%A0%B8"><span class="toc-text">3 课程审核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">3.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">3.1.1 业务流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.1.2 数据模型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">3.2 接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">3.3 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1-Dao%E5%BC%80%E5%8F%91"><span class="toc-text">3.3.1 Dao开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2-Service%E5%BC%80%E5%8F%91"><span class="toc-text">3.3.2 Service开发</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">3.4 接口完善</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.5 接口测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-text">4 课程发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">4.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">4.1.1 数据模型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">4.2 分布式事务技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">4.2.1 什么是分布式事务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-%E4%BB%80%E4%B9%88%E6%98%AFCAP%E7%90%86%E8%AE%BA"><span class="toc-text">4.2.2 什么是CAP理论</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="toc-text">4.2.3 分布式事务控制方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-4-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E7%9A%84%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="toc-text">4.2.4 课程发布的事务控制方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%8E%A5%E5%8F%A3"><span class="toc-text">4.3 课程发布接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-1-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">4.3.1 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-2-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">4.3.2 接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-2-1-DAO%E5%BC%80%E5%8F%91"><span class="toc-text">4.3.2.1 DAO开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-2-2-Service%E5%BC%80%E5%8F%91"><span class="toc-text">4.3.2.2 Service开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-2-3-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">4.3.2.3 接口完善</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">4.3.3 接口测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86SDK"><span class="toc-text">4.4 消息处理SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-1-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">4.4.1 消息模块技术方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-2-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97SDK%E6%B5%8B%E8%AF%95"><span class="toc-text">4.4.2 消息模块SDK测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4-3-%E9%9B%86%E6%88%90%E6%B6%88%E6%81%AFSDK"><span class="toc-text">4.4.3 集成消息SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-4-3-1-%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF"><span class="toc-text">4.4.3.1 添加消息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-4-3-2-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-text">4.4.3.2 课程发布任务处理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-4-3-3-%E5%BC%80%E5%90%AF%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">4.4.3.3 开启任务调度</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-4-3-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">4.4.3.4 测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-text">4.5 页面静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-1-%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-text">4.5.1 什么是页面静态化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-2-%E9%9D%99%E6%80%81%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5.2 静态化测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-3-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5.3 上传文件测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-3-1-%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%8E%AF%E5%A2%83"><span class="toc-text">4.5.3.1 配置远程调用环境</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-3-2-%E6%89%A9%E5%85%85%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%8E%A5%E5%8F%A3"><span class="toc-text">4.5.3.2 扩充上传文件接口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-3-3-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5.3.3 远程调用测试</span></a></li></ol></li></ol></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E9%87%8A%EF%BC%9A"><span class="toc-text">解释：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%A1%E6%98%AF%E4%BB%A5-course%E5%BC%80%E5%A4%B4%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%8C%E9%83%BD%E4%BB%A3%E7%90%86%E5%88%B0-fileserver-mediafiles-course"><span class="toc-text">凡是以 &#x2F;course开头的请求，都代理到&#x2F;fileserver&#x2F;mediafiles&#x2F;course</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-4-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="toc-text">4.5.4 熔断降级处理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-text">4.5.4.1 什么是熔断降级</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-4-2-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86"><span class="toc-text">4.5.4.2 熔断降级处理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5-5-%E8%AF%BE%E7%A8%8B%E9%9D%99%E6%80%81%E5%8C%96%E5%BC%80%E5%8F%91"><span class="toc-text">4.5.5 课程静态化开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-5-1-%E9%9D%99%E6%80%81%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.5.5.1 静态化实现</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-5-2-%E6%B5%8B%E8%AF%95"><span class="toc-text">4.5.5.2 测试</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-5-5-3-%E6%B5%8F%E8%A7%88%E8%AF%A6%E7%BB%86%E9%A1%B5%E9%9D%A2"><span class="toc-text">4.5.5.3 浏览详细页面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%AF%BE%E7%A8%8B%E6%90%9C%E7%B4%A2"><span class="toc-text">5 课程搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.1 需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.1.1 模块介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2-%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">5.1.2 业务流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text">5.2 准备环境</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-%E6%90%AD%E5%BB%BAelasticsearch"><span class="toc-text">5.2.1 搭建elasticsearch</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2-%E9%83%A8%E7%BD%B2%E6%90%9C%E7%B4%A2%E5%B7%A5%E7%A8%8B"><span class="toc-text">5.2.2 部署搜索工程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text">5.3 索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1-REST-API"><span class="toc-text">5.3.1 REST API</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-1-%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-text">5.3.1.1 添加文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-2-%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">5.3.1.2 查询文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-3-%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-text">5.3.1.3 更新文档</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-4-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">5.3.1.4 删除文档</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.3.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-3-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">5.3.3 接口开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-4-%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">5.3.4 接口完善</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-5-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">5.3.5 接口测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E6%90%9C%E7%B4%A2"><span class="toc-text">5.4 搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">5.4.1 需求分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">5.4.2 接口定义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-3-%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.4.3 基本功能实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-4-%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.4 基本功能测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-5-%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2"><span class="toc-text">5.4.5 根据条件搜索</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-6-%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.6 条件搜索测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-7-%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2"><span class="toc-text">5.4.7 聚合搜索</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-8-%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.8 聚合搜索测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-9-%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE"><span class="toc-text">5.4.9 高亮设置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-10-%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4.10 高亮设置测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF%E7%B4%A2%E5%BC%95%E5%90%8C%E6%AD%A5"><span class="toc-text">5.5 课程信息索引同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-1-%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">5.5.1 技术方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-2-%E8%AF%BE%E7%A8%8B%E7%B4%A2%E5%BC%95%E4%BB%BB%E5%8A%A1%E5%BC%80%E5%8F%91"><span class="toc-text">5.5.2 课程索引任务开发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-3-%E6%B5%8B%E8%AF%95"><span class="toc-text">5.5.3 测试</span></a></li></ol></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/a9f7ca04.html" title="Vue2-3-基础（二）"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Vue2-3-基础（二）"></a><div class="content"><a class="title" href="/breeze/a9f7ca04.html" title="Vue2-3-基础（二）">Vue2-3-基础（二）</a><time datetime="2024-02-03T13:15:02.000Z" title="发表于 2024-02-03 21:15:02">2024-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="分布式任务调度--xxl-job"></a><div class="content"><a class="title" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job">分布式任务调度--xxl-job</a><time datetime="2024-01-16T12:29:19.000Z" title="发表于 2024-01-16 20:29:19">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/6f71bf87.html" title="SpringCloud-oauth2"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="SpringCloud-oauth2"></a><div class="content"><a class="title" href="/breeze/6f71bf87.html" title="SpringCloud-oauth2">SpringCloud-oauth2</a><time datetime="2024-01-16T01:50:00.000Z" title="发表于 2024-01-16 09:50:00">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="认证授权-SpringSecurity"></a><div class="content"><a class="title" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity">认证授权-SpringSecurity</a><time datetime="2024-01-16T01:41:55.000Z" title="发表于 2024-01-16 09:41:55">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7913ff38.html" title="ElasticSearch集群"><img src="/img/photo-1653549892896-dde02867edee.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ElasticSearch集群"></a><div class="content"><a class="title" href="/breeze/7913ff38.html" title="ElasticSearch集群">ElasticSearch集群</a><time datetime="2024-01-14T14:34:16.000Z" title="发表于 2024-01-14 22:34:16">2024-01-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>