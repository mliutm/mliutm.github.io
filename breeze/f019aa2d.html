<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>springcloud快速入门-负载均衡-熔断降级（二） | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 介绍 服务负载均衡ribbon&amp;openFegin;（掌握）  Hystrix断路器;（掌握）   2.服务负载均衡2.1.为什么需要负载均衡为了提高并发量，有时同一个服务提供者可以部署多个(订单服务)。这个客户端(用户服务)在调用时要根据一定的负责均衡策略完成负载调用。    服务提供者集群 部署多份，项目上线，同一个jar在多个服务器完成部署那就OK了     开发的时候，有两种方案："><meta property="og:type" content="article"><meta property="og:title" content="springcloud快速入门-负载均衡-熔断降级（二）"><meta property="og:url" content="https://mliutm.github.io/breeze/f019aa2d.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="1. 介绍 服务负载均衡ribbon&amp;openFegin;（掌握）  Hystrix断路器;（掌握）   2.服务负载均衡2.1.为什么需要负载均衡为了提高并发量，有时同一个服务提供者可以部署多个(订单服务)。这个客户端(用户服务)在调用时要根据一定的负责均衡策略完成负载调用。    服务提供者集群 部署多份，项目上线，同一个jar在多个服务器完成部署那就OK了     开发的时候，有两种方案："><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><meta property="article:published_time" content="2023-11-23T11:38:35.000Z"><meta property="article:modified_time" content="2023-11-25T05:15:55.388Z"><meta property="article:author" content="清风"><meta property="article:tag" content="springcloud"><meta property="article:tag" content="eureka"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1688475747590-d0db5e2412cb.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/f019aa2d.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:10,languages:{author:"作者: 清风",link:"链接: ",source:"来源: 清风",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"springcloud快速入门-负载均衡-熔断降级（二）",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-11-25 13:15:55"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">springcloud快速入门-负载均衡-熔断降级（二）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-23T11:38:35.000Z" title="发表于 2023-11-23 19:38:35">2023-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-25T05:15:55.388Z" title="更新于 2023-11-25 13:15:55">2023-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringCloud/">SpringCloud</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="springcloud快速入门-负载均衡-熔断降级（二）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><ol><li><p>服务负载均衡ribbon&openFegin;（掌握）</p></li><li><p>Hystrix断路器;（掌握）</p></li></ol><h2 id="2-服务负载均衡"><a href="#2-服务负载均衡" class="headerlink" title="2.服务负载均衡"></a>2.服务负载均衡</h2><h3 id="2-1-为什么需要负载均衡"><a href="#2-1-为什么需要负载均衡" class="headerlink" title="2.1.为什么需要负载均衡"></a>2.1.为什么需要负载均衡</h3><p>为了提高并发量，有时同一个服务提供者可以部署多个(订单服务)。这个客户端(用户服务)在调用时要根据一定的负责均衡策略完成负载调用。</p><p><img src="/breeze/f019aa2d/wps1.jpg" alt="img"></p><ol><li><p>服务提供者集群</p><p>部署多份，项目上线，同一个jar在多个服务器完成部署那就OK了</p></li></ol><p>开发的时候，有两种方案：</p><p>方案1：拷贝一份代码为多份，修改端口不一样。分别启动</p><p>方案2：一份代码，多份配置。 每一个配置启动一份。</p><p>2)服务消费者负载均衡调用</p><p>客户端调用没有实现负载均衡.</p><p><img src="/breeze/f019aa2d/wps2.jpg" alt="img"></p><h3 id="2-2-服务生产者集群部署"><a href="#2-2-服务生产者集群部署" class="headerlink" title="2.2.服务生产者集群部署"></a>2.2.服务生产者集群部署</h3><p>上线：直接打包，部署在多个服务器就ol。</p><p>开发：一台主机，多个端口区分。多环境配置</p><h4 id="2-2-1-配置"><a href="#2-2-1-配置" class="headerlink" title="2.2.1 配置"></a>2.2.1 配置</h4><ol><li>application-user1.yml</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">user1</span></span><br><span class="line"><span class="string">application-user1.yml</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-provider</span> <span class="comment">#不要有下划线</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">     <span class="attr">defaultZone:</span> <span class="string">http://eureka1:1010/eureka,http://eureka2:1020/eureka,http://eureka3:1030/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 当调用getHostname获取实例的hostname时，返回ip而不是host名称</span></span><br><span class="line">    <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># 指定自己的ip信息，不指定的话会自己寻找</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">user-provider:4010</span> <span class="comment">#主机名</span></span><br></pre></td></tr></table></figure><p>application-user2.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4020</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-provider</span> <span class="comment">#不要有下划线</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">     <span class="attr">defaultZone:</span> <span class="string">http://eureka1:1010/eureka,http://eureka2:1020/eureka,http://eureka3:1030/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 当调用getHostname获取实例的hostname时，返回ip而不是host名称</span></span><br><span class="line">    <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># 指定自己的ip信息，不指定的话会自己寻找</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">user-provider:4020</span> <span class="comment">#主机名</span></span><br></pre></td></tr></table></figure><ol start="2"><li><strong>controller</strong></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context; <span class="comment">//spring的容器</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Order&gt; <span class="title function_">getOrdersByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span>Long uid)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了测试效果,需要获取当前环境打印出来测试,看他是否是真的做了负载均衡</span></span><br><span class="line">        String[] activeProfiles = context.getEnvironment().getActiveProfiles();</span><br><span class="line">        <span class="keyword">if</span> (activeProfiles!=<span class="literal">null</span>&amp;&amp; activeProfiles.length&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">prifile</span> <span class="operator">=</span> activeProfiles[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>, <span class="string">&quot;订单fjfjfj-&gt;&quot;</span> +prifile, uid),</span><br><span class="line">                                 <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">2L</span>, <span class="string">&quot;订单fjfjfj-&gt;&quot;</span>+prifile, uid));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//以后调用service mapper等,现在模拟一下</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1L</span>,<span class="string">&quot;订单fjfjfj&quot;</span>,uid),</span><br><span class="line">                             <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">2L</span>,<span class="string">&quot;订单fjfjfj&quot;</span>,uid));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-启动"><a href="#2-2-2-启动" class="headerlink" title="2.2.2 启动"></a>2.2.2 启动</h4><p>改动默认启动，分别启用user1，user2</p><h3 id="2-3-服务消费者常见负载均衡实现技术"><a href="#2-3-服务消费者常见负载均衡实现技术" class="headerlink" title="2.3.服务消费者常见负载均衡实现技术"></a>2.3.服务消费者常见负载均衡实现技术</h3><h4 id="2-3-1-Ribbon"><a href="#2-3-1-Ribbon" class="headerlink" title="2.3.1. Ribbon"></a>2.3.1. Ribbon</h4><p>通过RestTmplate，以url完成服务的调用</p><h4 id="2-3-2-Feign-OpenFeign"><a href="#2-3-2-Feign-OpenFeign" class="headerlink" title="2.3.2. Feign&#x2F;OpenFeign"></a>2.3.2. Feign&#x2F;OpenFeign</h4><p>Feign&#x2F;OpenFeign底层还是ribbon,只是进行了封装,让我们以接口的方式进行调用</p><h3 id="2-4-Ribbon负载均衡调用"><a href="#2-4-Ribbon负载均衡调用" class="headerlink" title="2.4.Ribbon负载均衡调用"></a>2.4.Ribbon负载均衡调用</h3><h4 id="2-4-1-是什么"><a href="#2-4-1-是什么" class="headerlink" title="2.4.1. 是什么"></a>2.4.1. 是什么</h4><p>Ribbon是Netflix发布的云中间层服务开源项目，主要功能是提供客户端负载均衡算法。Ribbon客户端组件提供一系列完善的配置项，如，连接超时，重试等。简单的说，Ribbon是一个客户端负载均衡器，我们可以在配置文件中列出load Balancer后面所有的机器，Ribbon会自动的帮助你基于某种规则(如简单轮询，随机连接等)去连接这些机器，我们也很容易使用Ribbon实现自定义的负载均衡算法。</p><p>Ribbon是一个客户端负载均衡器,它可以按照一定规则来完成一种服务多个服务实例负载均衡调用,这些规则默认提供了很多而且还支持自定义。</p><h4 id="2-4-2-集成原理"><a href="#2-4-2-集成原理" class="headerlink" title="2.4.2. 集成原理"></a>2.4.2. 集成原理</h4><p><img src="/breeze/f019aa2d/wps3.jpg" alt="img"></p><h4 id="2-4-3-负载均衡测试"><a href="#2-4-3-负载均衡测试" class="headerlink" title="2.4.3.负载均衡测试"></a>2.4.3.负载均衡测试</h4><ol><li>导入jar</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--客户端负载均衡实现 ribbon--&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>代码</li></ol><ol><li>配置类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CfgBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span> <span class="comment">//开启负载均衡</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>controller</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多个方法调用只需改一处就ok</span></span><br><span class="line">    <span class="comment">//public static  final String URL_PREFIX = &quot;http://localhost:8001&quot;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;http://USER-PROVIDER&quot;</span>; <span class="comment">//通过服务名从注册中心获取服务列表,通过负载均衡调用</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span>Long id)</span>&#123;</span><br><span class="line">        <span class="comment">//调用远程服务 http请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> URL_PREFIX+<span class="string">&quot;/provider/user/&quot;</span>+id;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url,User.class );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>为了看到测试效果，改造了服务提供者</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.applet.AppletContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(value = &quot;id&quot;)</span>Long id)</span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(context.getEnvironment().getActiveProfiles());</span><br><span class="line">        <span class="comment">//正常来说需要调用service，进而调用mapper获取数据，现在模拟一些直接构造返回。</span></span><br><span class="line">        String[] activeProfiles = applicationContext.getEnvironment().getActiveProfiles();</span><br><span class="line">        <span class="keyword">if</span> (activeProfiles!=<span class="literal">null</span> || activeProfiles.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">profile</span> <span class="operator">=</span> activeProfiles[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs&quot;</span>+profile);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;zs&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/breeze/f019aa2d/wps4.jpg" alt="img"></p><p>不断刷新会出现轮询效果</p><h4 id="2-4-4-负载均衡策略"><a href="#2-4-4-负载均衡策略" class="headerlink" title="2.4.4.负载均衡策略"></a>2.4.4.负载均衡策略</h4><p>ribbon通过服务名获取到多个服务实例后,要根据一定规则来选择一个服务实例来完成调用.这个规则就叫负载均衡策略. 默认负载均衡策略是轮询。</p><ol><li><p>IRule</p><p>通过配置不同IRule的子类，可以选择不同负载均衡策略，也就是从服务列表以特定策略选择一个服务来完成调用。当然也可以自定义。所以负载均衡策略可以分为内置和自定义。</p></li><li><p>内置负载均衡策略</p></li></ol><table><thead><tr><th>内置负载均衡规则类</th><th>规则描述</th></tr></thead><tbody><tr><td>RoundRobinRule（默认）</td><td>简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。</td></tr><tr><td>AvailabilityFilteringRule</td><td>对以下两种服务进行忽略：（1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。注意：可以通过修改配置loadbalancer.<code>&lt;clientName&gt;</code>.connectionFailureCountThreshold来修改连接失败多少次之后被设置为短路状态。默认是3次。（2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule规则的客户端也会将其忽略。并发连接数的上线，可以由客户端的<clientname>.<clientconfignamespace>.ActiveConnectionsLimit属性进行配置。</clientconfignamespace></clientname></td></tr><tr><td>WeightedResponseTimeRule</td><td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td></tr><tr><td>ZoneAvoidanceRule</td><td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。</td></tr><tr><td>BestAvailableRule</td><td>忽略哪些短路的服务器，并选择并发数较低的服务器。</td></tr><tr><td>RandomRule</td><td>随机选择一个可用的服务器。</td></tr><tr><td>Retry</td><td>重试机制的选择逻辑</td></tr></tbody></table><p><img src="/breeze/f019aa2d/wps5.jpg" alt="img"></p><h4 id="2-4-5-优化"><a href="#2-4-5-优化" class="headerlink" title="2.4.5.优化"></a>2.4.5.优化</h4><p>1）超时配置</p><p>使用Ribbon进行服务通信时为了防止网络波动造成服务调用超时，我们可以针对Ribbon配置超时时间以及重试机制</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">3000</span>				<span class="comment">#连接超时时间  消费者连接生产者，一直连接不上的等待事件</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span>				    <span class="comment">#读取超时时间  连接上了，但是一直没有返回数据</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">2</span>				    <span class="comment">#重试机制：同一台实例最大重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">2</span> 	     <span class="comment">#重试负载均衡其他的实例最大重试次数</span></span><br><span class="line">  <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span>     <span class="comment">#是否所有操作都重试，如果设置了false,除了get请求其他的都不做重试</span></span><br><span class="line">  <span class="comment"># 一般get请求都是查询操作，基本不存在业务数据出错的风险</span></span><br><span class="line">  <span class="comment"># PUT DELETE UPDATE 涉及到数据的更改，会有重复提交的风险，如果 OkToRetryOnAllOperations 设置为true，表示所有操作都要重试，则需要进行任务幂等性校验。</span></span><br></pre></td></tr></table></figure><p><strong>什么是任务的幂等性：</strong></p><blockquote><p>幂等就是对同一数据的相同操作，无论执行多少次，产生的效果和返回的结果都是一样的。</p><p>[如何实现任务的幂等性？](<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/534651475">什么是幂等？如何解决幂等性问题？ - 知乎 (zhihu.com)</a>)</p></blockquote><p>当然也可以针对具体的服务进行超时配置：如”&lt;服务名&gt;.ribbon…”</p><p>2）饥饿加载</p><p>我们在启动服务使用Ribbon发起服务调用的时候往往会出现找不到目标服务的情况，这是因为Ribbon在进行客户端负载均衡的时候并不是启动时就创建好的，而是在实际请求的时候才会去创建，所以往往我们在发起第一次调用的时候会出现超时导致服务调用失败，我们可以通过设置Ribbon的饥饿加载来改善此情况，即在服务启动时就把Ribbon相关内容创建好。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启饥饿加载</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">user-server,yyy</span> <span class="comment">#针对于哪些服务需要饥饿加载</span></span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/29747134?from_voters_page=true">https://zhuanlan.zhihu.com/p/29747134?from_voters_page=true</a></p><h3 id="2-5-OpenFeign负载均衡"><a href="#2-5-OpenFeign负载均衡" class="headerlink" title="2.5.OpenFeign负载均衡"></a>2.5.OpenFeign负载均衡</h3><h4 id="2-5-1-是什么"><a href="#2-5-1-是什么" class="headerlink" title="2.5.1. 是什么"></a>2.5.1. 是什么</h4><p>前面的可以发现当我们通过RestTemplate调用其它服务的API时，所需要的参数须在请求的URL中进行拼接，如果参数少的话或许我们还可以忍受，一旦有多个参数的话，这时拼接请求字符串就会效率低下，并且显得好傻。</p><p><img src="/breeze/f019aa2d/wps6.jpg" alt="img"></p><p><img src="/breeze/f019aa2d/image-20231120171636452.png" alt="image-20231120171636452"></p><p>OpenFeign是一个声明式的Web Service客户端，它的目的就是让Web Service调用更加简单。Feign提供了HTTP请求的接口模板（上面标的有访问地址），通过编写简单的接口和插入注解，就可以定义好HTTP请求的参数、格式、地址等信息。而OpenFeign则会完全代理(动态代理)HTTP请求，我们只需要像调用方法一样调用它就可以完成服务请求及相关处理。Feign整合了Ribbon和Hystrix(关于Hystrix我们后面再讲)，可以让我们不再需要显式地使用这两个组件。</p><p>总起来说，Feign具有如下特性：</p><p>可插拔的注解支持，包括Feign注解和JAX-RS注解;</p><p>支持可插拔的HTTP编码器和解码器;</p><p>支持Hystrix和它的Fallback;</p><p>支持Ribbon的负载均衡;</p><p>支持HTTP请求和响应的压缩。</p><p>这看起来有点像我们springmvc模式的Controller层的RequestMapping映射。这种模式是我们非常喜欢的。Feign是用@FeignClient来映射服务的。</p><p>Open Feign是以接口方式进行服务调用,而不是通过RestTemplate来调用地址,feign底层是对ribbon进行了封装,让我们调用起来更加happy.</p><p><img src="/breeze/f019aa2d/wps7.jpg" alt="img"></p><p><strong>相关原理：</strong></p><p><img src="/breeze/f019aa2d/image-20231120172750333.png" alt="image-20231120172750333"></p><h4 id="2-5-2-操作-服务消费者"><a href="#2-5-2-操作-服务消费者" class="headerlink" title="2.5.2.操作-服务消费者"></a>2.5.2.操作-服务消费者</h4><p>拷贝一份 user-service-openfeign-2022</p><ol><li>导入jar</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--替换ribbon jar为feigin--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--feign的支持--&gt;</span>  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>配置yml</p><p>改端口端口</p></li><li><p>入口类</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;cn.mliutm.client&quot;)</span> <span class="comment">//如果是主类所在子包，可以不用加basePackages，但是最好加上</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserConsumerFeignApp5011</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserConsumerFeignApp5011.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>写代码测试</li></ol><p><img src="/breeze/f019aa2d/wps8.jpg" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.clients;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过给出线索，完全可以产生一个动态代理类并且纳入Spring管理，完对特定服务，特定地址的调用，当然底层封装是ribbon</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;USER-PROVIDER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="comment">//正常要调用service，进而调用数据库，但是现在模拟一下，直接返回</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/provider//&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line">调用</span><br><span class="line">    <span class="keyword">package</span> cn.mliutm.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.clients.UserClient;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.User;</span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/consumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常要调用service，进而调用数据库，但是现在模拟一下，直接返回</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        System.out.println(userClient.getClass());</span><br><span class="line">        <span class="keyword">return</span> userClient.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-5-3-Feign的超时配置"><a href="#2-5-3-Feign的超时配置" class="headerlink" title="2.5.3 Feign的超时配置"></a>2.5.3 Feign的超时配置</h4><p>如果在服务调用时出现了 “feign.RetryableException : Read timed out…”错误日志，说明Ribbon处理超时 ，我们可以配置Ribbon的超时时间：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">6000</span></span><br></pre></td></tr></table></figure><p>如果服务调用出现“com.netflix.hystrix.exception.HystrixRuntimeException：… timed - out and no fallback available” 错误日志，是因为Hystrix超时，默认Feign集成了Hystrix，但是高版本是关闭了Hystrix，我们可以配置Hystrix超时时间：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">   <span class="attr">hystrix:</span></span><br><span class="line">       <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启熔断支持hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">execution:</span></span><br><span class="line">          <span class="attr">isolation:</span></span><br><span class="line">            <span class="attr">thread:</span></span><br><span class="line">              <span class="attr">timeoutInMilliseconds:</span> <span class="number">6000</span>   <span class="comment">#hystrix超时时间</span></span><br></pre></td></tr></table></figure><p>测试：</p><p>启注册中心</p><p>启动服务提供者</p><p>启动服务消费者测试</p><h3 id="2-6-小结"><a href="#2-6-小结" class="headerlink" title="2.6. 小结"></a>2.6. 小结</h3><p>当对同一个服务部署多个时，就要涉及负载均衡调用了，这是可以选择Ribbon和Feign。</p><h2 id="3-Hystrix断路器-服务健壮性处理"><a href="#3-Hystrix断路器-服务健壮性处理" class="headerlink" title="3. Hystrix断路器-服务健壮性处理"></a>3. Hystrix断路器-服务健壮性处理</h2><h3 id="3-1-为什么需要Hystrix断路器"><a href="#3-1-为什么需要Hystrix断路器" class="headerlink" title="3.1.为什么需要Hystrix断路器"></a>3.1.为什么需要Hystrix断路器</h3><h4 id="3-1-1-存在问题"><a href="#3-1-1-存在问题" class="headerlink" title="3.1.1.存在问题"></a>3.1.1.存在问题</h4><p>在理想状态下，一个应用依赖的服务都是健康可用的，我们可以正常的处理所有的请求。 <img src="/breeze/f019aa2d/wps9.jpg" alt="img"></p><p>​ 当某一个服务出现延迟时，所有的请求都阻塞在依赖的服务Dependency I .</p><p>​ <img src="/breeze/f019aa2d/wps10.jpg" alt="img"></p><p>​ 当依赖I 阻塞时,大多数服务器的线程池就出现阻塞(BLOCK),影响整个线上服务的稳定性</p><p><img src="/breeze/f019aa2d/wps11.jpg" alt="img"></p><p>​</p><p>在复杂的分布式架构的应用程序有很多的依赖，都会不可避免地在某些时候失败。高并发的依赖失败时如果没有隔离措施，当前应用服务就有被拖垮的风险</p><p>​ 服务雪崩现象</p><h4 id="3-1-2-解决方案"><a href="#3-1-2-解决方案" class="headerlink" title="3.1.2. 解决方案"></a>3.1.2. 解决方案</h4><p>对依赖做隔离,Hystrix就是处理依赖隔离的框架,同时也是可以帮我们做依赖服务的治理和监控.。</p><p>当我们使用了Hystrix时，Hystrix将所有的外部调用都封装成一个HystrixCommand或者HystrixObservableCommand对象，这些外部调用将会在一个独立的线程中运行。我们可以将出现问题的服务通过熔断、降级等手段隔离开来，这样不影响整个系统的主业务</p><p><mark>Hystrix是保证微服务群健壮框架,做了隔离、限流,熔断,降级等操作.最终达到不会由于某一个服务出问题而导致服务群雪崩,让整体群死掉.</mark></p><h3 id="3-2-Hystrix简介"><a href="#3-2-Hystrix简介" class="headerlink" title="3.2. Hystrix简介"></a><strong>3.2.</strong> Hystrix简介</h3><p>Hystrix是国外知名的视频网站Netflix所开源的非常流行的高可用架构框架。Hystrix能够完美的解决分布式系统架构中打造高可用服务面临的一系列技术难题。</p><p>Hystrix “豪猪”，具有自我保护的能力。hystrix 通过如下机制来解决雪崩效应问题。</p><p><mark>资源隔离（限流）：包括线程池隔离和信号量隔离，限制调用分布式服务的资源使用，某一个调用的服务出现问题不会影响其他服务调用。</mark></p><p><mark>熔断：当失败率达到阀值自动触发降级(如因网络故障&#x2F;超时造成的失败率高)，熔断器触发的快速失败会进行快速恢复。</mark></p><p><mark>降级机制：超时降级、资源不足时(线程或信号量)降级，降级后可以配合降级接口返回托底数据。</mark></p><p>缓存：提供了请求缓存、请求合并实现。</p><h4 id="3-2-1-原理分析命令模式"><a href="#3-2-1-原理分析命令模式" class="headerlink" title="3.2.1. 原理分析命令模式"></a><strong>3.2.1.</strong> 原理分析命令模式</h4><p>Hystrix使用命令模式(继承HystrixCommand(隔离)类)来包裹具体的服务调用逻辑(run方法), 并在命令模式中添加了服务调用失败后的降级逻辑(getFallback).</p><p>同时我们在Command的构造方法中可以定义当前服务线程池和熔断器的相关参数.</p><p><img src="/breeze/f019aa2d/wps12.jpg" alt="img"></p><p>在使用了Command模式构建了服务对象之后, 服务便拥有了熔断器和线程池的功能.</p><p><img src="/breeze/f019aa2d/wps13.jpg" alt="img"></p><h4 id="3-2-2-资源隔离-限流"><a href="#3-2-2-资源隔离-限流" class="headerlink" title="3.2.2.资源隔离&amp;限流"></a>3.2.2.资源隔离&amp;限流</h4><p>（1）线程池隔离模式(默认)：使用一个线程池来存储当前请求，线程池对请求作处理，设置任务返回处理超时时间，堆积的请求先入线程池队列。这种方式要为每个依赖服务申请线程池，有一定的资源消耗，好处是可以应对突发流量（流量洪峰来临时，处理不完可将数据存储到线程池队里慢慢处理）<br>（2）信号量隔离模式：使用一个原子计数器（或信号量）记录当前有多少个线程在运行，请求来先判断计数器的数值，若超过设置的最大线程个数则丢弃该类型的新请求，若不超过则执行计数操作请求来计数器+1，请求返回计数器-1。这种方式是严格的控制线程且立即返回模式，无法应对突发流量（流量洪峰来临时，处理的线程超过数量，其他的请求会直接返回，不继续去请求依赖的服务）</p><p><img src="/breeze/f019aa2d/image-20231120173108002.png" alt="image-20231120173108002"></p><p><img src="/breeze/f019aa2d/wps15.jpg" alt="img"></p><p><strong>线程池隔离相关配置：</strong></p><p><img src="/breeze/f019aa2d/image-20231120173517636.png" alt="image-20231120173517636"></p><p><img src="/breeze/f019aa2d/wps16.jpg" alt="img"></p><h4 id="3-2-3-服务熔断"><a href="#3-2-3-服务熔断" class="headerlink" title="3.2.3. 服务熔断"></a>3.2.3. 服务熔断</h4><p>正常情况下，断路器处于关闭状态(Closed)，</p><p>如果调用持续出错或者超时，电路被打开进入熔断状态(Open)，后续一段时间内的所有调用都会被拒绝(Fail Fast)，</p><p>一段时间以后，保护器会尝试进入半熔断状态(Half-Open)，允许少量请求进来尝试，</p><p>​ 如果调用仍然失败，则回到熔断状态</p><p>​ 如果调用成功，则回到电路闭合状态;</p><p><img src="/breeze/f019aa2d/image-20231120173017846.png" alt="image-20231120173017846"></p><p>熔断的参数配置</p><p>Hystrix提供了如下的几个关键参数，来对一个熔断器进行配置：</p><blockquote><p>circuitBreaker.requestVolumeThreshold &#x2F;&#x2F;滑动窗口的大小，默认为20</p><p>circuitBreaker.sleepWindowInMilliseconds &#x2F;&#x2F;过多长时间，熔断器再次检测是否开启，默认为5000，即5s钟</p><p>circuitBreaker.errorThresholdPercentage &#x2F;&#x2F;错误率，默认50%</p></blockquote><p>3个参数放在一起，所表达的意思就是：</p><p>每当20个请求中，有50%失败时，熔断器就会打开，此时再调用此服务，将会直接返回失败，不再调远程服务。直到5s钟之后，重新检测该触发条件，判断是否把熔断器关闭，或者继续打开。</p><h4 id="3-2-4-服务降级"><a href="#3-2-4-服务降级" class="headerlink" title="3.2.4. 服务降级"></a>3.2.4. 服务降级</h4><p><mark>有了熔断和限流，就得有降级。所谓降级，就是当某个服务出错，超时、熔断之后，服务器将不再被调用，此时客户端可以自己准备一个本地的fallback回调，返回一个缺省值。</mark></p><p>这样做，虽然服务水平下降，但好歹可用，比直接挂掉要强，当然这也要看适合的业务场景。</p><p><img src="/breeze/f019aa2d/wps18.jpg" alt="img"></p><p><img src="/breeze/f019aa2d/wps19.jpg" alt="img"></p><p><img src="/breeze/f019aa2d/wps20.jpg" alt="img"></p><h3 id="3-3-Hystrix实现-服务提供者"><a href="#3-3-Hystrix实现-服务提供者" class="headerlink" title="3.3. Hystrix实现-服务提供者"></a>3.3. Hystrix实现-服务提供者</h3><p>1）拷贝服务提供者(order-service)</p><p>2）Pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--断路器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3）Yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4020</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-provider</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#显示eureka客户端真实ip</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">     <span class="comment">#defaultZone: http://localhost:1010/eureka #告诉服务提供者要把服务注册到哪</span></span><br><span class="line">     <span class="comment">#eureka集群环境</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka1:1010/eureka,http://eureka2:1011/eureka,http://eureka3:1012/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4）代码</p><p>主类:</p><p><img src="/breeze/f019aa2d/wps21.jpg" alt="img"></p><p>服务代码：</p><p><img src="/breeze/f019aa2d/wps22.jpg" alt="img"></p><p>5）测试</p><p><img src="/breeze/f019aa2d/wps23.jpg" alt="img"></p><p><img src="/breeze/f019aa2d/wps24.jpg" alt="img"></p><p>注意:</p><p>1 熔断我们是在服务提供方做</p><p>2 调用时不能使用openfeign调用(有自己熔断机制),要用ribbon调用，应该open有自己机制</p><p>我们往往会把Ribbon和Hystrix的超时配合起来配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment">#最大重试次数</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换实例的重试次数</span></span><br><span class="line">  <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">false</span> <span class="comment"># 对所有的操作请求都进行重试，</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#请求连接的超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">1800</span> <span class="comment">#请求处理的超时时间hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">3000</span> <span class="comment">#hystrix超时,置thread和semaphore两种隔离策略的超时时间</span></span><br></pre></td></tr></table></figure><h3 id="3-4-Feign实现"><a href="#3-4-Feign实现" class="headerlink" title="3.4.Feign实现"></a>3.4.Feign实现</h3><h4 id="3-4-1-为什么使用"><a href="#3-4-1-为什么使用" class="headerlink" title="3.4.1.为什么使用"></a>3.4.1.为什么使用</h4><p>问题:</p><p>每个方法都要加回调并且耦合业务代码类中</p><p>解决方案:</p><p>可以使用spring面向切面编程,为feign的接口创建一个代理对象,完成对服务调用,当发现熔断后就调用同名托底方法.</p><h4 id="3-4-2-实现-feign服务消费者实现"><a href="#3-4-2-实现-feign服务消费者实现" class="headerlink" title="3.4.2. 实现(feign服务消费者实现)"></a>3.4.2. 实现(feign服务消费者实现)</h4><ol><li><p>创建项目-拷贝feign</p></li><li><p>导入jar-没有额外的</p></li><li><p>配置</p></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span> <span class="comment">#不注册到Eureka,不在注册中心显示</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">   <span class="attr">hystrix:</span></span><br><span class="line">       <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启熔断支持</span></span><br><span class="line">   <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">remote-service:</span>           <span class="comment">#服务名，填写default为所有服务</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">execution:</span></span><br><span class="line">          <span class="attr">isolation:</span></span><br><span class="line">            <span class="attr">thread:</span></span><br><span class="line">              <span class="attr">timeoutInMilliseconds:</span> <span class="number">3000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="4"><li>入口类-不要额外</li></ol><p>​ 如果接口包结构不按照规范来,额外加入扫描包.@ComponentScan</p><ol start="5"><li>代码-公共里面实现</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.springcloud.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.springcloud.domain.User;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//UserClient 表示对那个接口进行托底处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientHystrixFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;UserClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id,<span class="string">&quot;出异常,请联系管理员!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用服务名字</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;USER-PROVIDER&quot;,fallbackFactory = UserClientHystrixFallbackFactory.class)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="6"><li>测试</li></ol><p><img src="/breeze/f019aa2d/wps25.jpg" alt="img"></p><p>把服务提供者关闭就可以测试得到效果. 或者断点超时,或者睡眠超时测试</p><p>通过feign.hystrix.enabled&#x3D;true开启Hystrix</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#开启熔断支持ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">SocketTimeout:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">execution:</span></span><br><span class="line">          <span class="attr">isolation:</span></span><br><span class="line">            <span class="attr">thread:</span></span><br><span class="line">              <span class="attr">timeoutInMilliseconds:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><h3 id="3-5-小结"><a href="#3-5-小结" class="headerlink" title="3.5. 小结"></a>3.5. 小结</h3><p>如果我们服务消费者实现的技术为ribbon,可以服务提供者方通过Hystrix的断路器，也可以在服务消费者来做，但是不能两边做。Yaosang建议在消费端(能监控服务端是否启动)，</p><p>如果我们服务消费者实现的技术为feign,必须在服务消费者通过feign的断路器,feign断路器底层还是Hystrix的断路器. 默认是关闭的，要启用。</p><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h2><h3 id="4-1-重点"><a href="#4-1-重点" class="headerlink" title="4.1. 重点"></a>4.1. 重点</h3><ol><li><p>断路器。</p></li><li><p>网关</p></li><li><p>分布式配置</p></li></ol><h3 id="4-2-难点"><a href="#4-2-难点" class="headerlink" title="4.2.难点"></a>4.2.难点</h3><ol><li>-Xms128m -Xmx128m</li></ol></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/f019aa2d.html">https://mliutm.github.io/breeze/f019aa2d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springcloud/">springcloud</a><a class="post-meta__tags" href="/tags/eureka/">eureka</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1688475747590-d0db5e2412cb.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/3448dc8c.html" title="springcloud快速入门-zuul-config（三）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">springcloud快速入门-zuul-config（三）</div></div></a></div><div class="next-post pull-right"><a href="/breeze/5a02c04f.html" title="springcloud快速入门-微服务介绍-eureka（一）"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">springcloud快速入门-微服务介绍-eureka（一）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/621a973e.html" title="SpringCloud-认识微服务（一）"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-21</div><div class="title">SpringCloud-认识微服务（一）</div></div></a></div><div><a href="/breeze/3448dc8c.html" title="springcloud快速入门-zuul-config（三）"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-23</div><div class="title">springcloud快速入门-zuul-config（三）</div></div></a></div><div><a href="/breeze/5a02c04f.html" title="springcloud快速入门-微服务介绍-eureka（一）"><img class="cover" src="/img/photo-1653549892896-dde02867edee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-23</div><div class="title">springcloud快速入门-微服务介绍-eureka（一）</div></div></a></div><div><a href="/breeze/91a9f79c.html" title="springcloud快速入门-链路追踪-ELK（四）"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-23</div><div class="title">springcloud快速入门-链路追踪-ELK（四）</div></div></a></div><div><a href="/breeze/7043968f.html" title="Nacos源码分析"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-21</div><div class="title">Nacos源码分析</div></div></a></div><div><a href="/breeze/a28d47f0.html" title="Sentinel源码分析"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-21</div><div class="title">Sentinel源码分析</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1. 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">2.服务负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">2.1.为什么需要负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%9C%8D%E5%8A%A1%E7%94%9F%E4%BA%A7%E8%80%85%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-text">2.2.服务生产者集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2.1 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%90%AF%E5%8A%A8"><span class="toc-text">2.2.2 启动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E5%B8%B8%E8%A7%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E7%8E%B0%E6%8A%80%E6%9C%AF"><span class="toc-text">2.3.服务消费者常见负载均衡实现技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-Ribbon"><span class="toc-text">2.3.1. Ribbon</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-Feign-OpenFeign"><span class="toc-text">2.3.2. Feign&#x2F;OpenFeign</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E7%94%A8"><span class="toc-text">2.4.Ribbon负载均衡调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">2.4.1. 是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E9%9B%86%E6%88%90%E5%8E%9F%E7%90%86"><span class="toc-text">2.4.2. 集成原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%B5%8B%E8%AF%95"><span class="toc-text">2.4.3.负载均衡测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-text">2.4.4.负载均衡策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-5-%E4%BC%98%E5%8C%96"><span class="toc-text">2.4.5.优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-OpenFeign%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">2.5.OpenFeign负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">2.5.1. 是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E6%93%8D%E4%BD%9C-%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-text">2.5.2.操作-服务消费者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3-Feign%E7%9A%84%E8%B6%85%E6%97%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">2.5.3 Feign的超时配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%B0%8F%E7%BB%93"><span class="toc-text">2.6. 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8-%E6%9C%8D%E5%8A%A1%E5%81%A5%E5%A3%AE%E6%80%A7%E5%A4%84%E7%90%86"><span class="toc-text">3. Hystrix断路器-服务健壮性处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Hystrix%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-text">3.1.为什么需要Hystrix断路器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="toc-text">3.1.1.存在问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">3.1.2. 解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Hystrix%E7%AE%80%E4%BB%8B"><span class="toc-text">3.2. Hystrix简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F"><span class="toc-text">3.2.1. 原理分析命令模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB-%E9%99%90%E6%B5%81"><span class="toc-text">3.2.2.资源隔离&amp;限流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-text">3.2.3. 服务熔断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-text">3.2.4. 服务降级</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Hystrix%E5%AE%9E%E7%8E%B0-%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-text">3.3. Hystrix实现-服务提供者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Feign%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.4.Feign实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8"><span class="toc-text">3.4.1.为什么使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-%E5%AE%9E%E7%8E%B0-feign%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.4.2. 实现(feign服务消费者实现)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%B0%8F%E7%BB%93"><span class="toc-text">3.5. 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%80%BB%E7%BB%93"><span class="toc-text">4.总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E9%87%8D%E7%82%B9"><span class="toc-text">4.1. 重点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%9A%BE%E7%82%B9"><span class="toc-text">4.2.难点</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="分布式任务调度--xxl-job"></a><div class="content"><a class="title" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job">分布式任务调度--xxl-job</a><time datetime="2024-01-16T12:29:19.000Z" title="发表于 2024-01-16 20:29:19">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity"><img src="/img/photo-1653549892896-dde02867edee.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="认证授权-SpringSecurity"></a><div class="content"><a class="title" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity">认证授权-SpringSecurity</a><time datetime="2024-01-16T01:41:55.000Z" title="发表于 2024-01-16 09:41:55">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7913ff38.html" title="ElasticSearch集群"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ElasticSearch集群"></a><div class="content"><a class="title" href="/breeze/7913ff38.html" title="ElasticSearch集群">ElasticSearch集群</a><time datetime="2024-01-14T14:34:16.000Z" title="发表于 2024-01-14 22:34:16">2024-01-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/37cf2cfd.html" title="Redis集群"><img src="/img/photo-1653549892896-dde02867edee.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis集群"></a><div class="content"><a class="title" href="/breeze/37cf2cfd.html" title="Redis集群">Redis集群</a><time datetime="2024-01-14T14:27:18.000Z" title="发表于 2024-01-14 22:27:18">2024-01-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/4b0178e0.html" title="数据结构与算法"><img src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="数据结构与算法"></a><div class="content"><a class="title" href="/breeze/4b0178e0.html" title="数据结构与算法">数据结构与算法</a><time datetime="2024-01-14T13:51:48.000Z" title="发表于 2024-01-14 21:51:48">2024-01-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1688475747590-d0db5e2412cb.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>