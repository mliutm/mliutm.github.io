<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>MySQL多机优化 | 清风</title><meta name="author" content="清风"><meta name="copyright" content="清风"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="数据库多机优化内容 集群与分布式概念理解  CAP&amp;Base理论  Mysql主从复制-集群  分库分表理论  Sharding-JDBC读写分离  Sharding-JDBC分库分表   一.CAP&amp;Base理论1.集群和分布式1.1.什么是分布式系统-拆子系统​	简单理解分布式就是一个计算机软件系统有多个子系统组成，每个子系统承担着部分职责，分别部署在不同的服务器上，子系统之间"><meta property="og:type" content="article"><meta property="og:title" content="MySQL多机优化"><meta property="og:url" content="https://mliutm.github.io/breeze/75a56cf8.html"><meta property="og:site_name" content="清风"><meta property="og:description" content="数据库多机优化内容 集群与分布式概念理解  CAP&amp;Base理论  Mysql主从复制-集群  分库分表理论  Sharding-JDBC读写分离  Sharding-JDBC分库分表   一.CAP&amp;Base理论1.集群和分布式1.1.什么是分布式系统-拆子系统​	简单理解分布式就是一个计算机软件系统有多个子系统组成，每个子系统承担着部分职责，分别部署在不同的服务器上，子系统之间"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mliutm.github.io/img/photo-1692708632140-ee01624d558d.jpg"><meta property="article:published_time" content="2024-01-14T13:39:03.000Z"><meta property="article:modified_time" content="2024-01-14T14:43:35.028Z"><meta property="article:author" content="清风"><meta property="article:tag" content="mysql"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://mliutm.github.io/img/photo-1692708632140-ee01624d558d.jpg"><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://mliutm.github.io/breeze/75a56cf8.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!1,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:10,languages:{author:"作者: 清风",link:"链接: ",source:"来源: 清风",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"MySQL多机优化",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-01-14 22:43:35"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/photo-1692708632140-ee01624d558d.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="清风"><span class="site-name">清风</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL多机优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-01-14T13:39:03.000Z" title="发表于 2024-01-14 21:39:03">2024-01-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-01-14T14:43:35.028Z" title="更新于 2024-01-14 22:43:35">2024-01-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E8%83%BD%E6%8F%90%E5%8D%87/">技能提升</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="MySQL多机优化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="数据库多机优化"><a href="#数据库多机优化" class="headerlink" title="数据库多机优化"></a>数据库多机优化</h1><h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><ul><li><p>集群与分布式概念理解</p></li><li><p>CAP&amp;Base理论</p></li><li><p>Mysql主从复制-集群</p></li><li><p>分库分表理论</p></li><li><p>Sharding-JDBC读写分离</p></li><li><p>Sharding-JDBC分库分表</p></li></ul><h2 id="一-CAP-Base理论"><a href="#一-CAP-Base理论" class="headerlink" title="一.CAP&amp;Base理论"></a>一.CAP&amp;Base理论</h2><h3 id="1-集群和分布式"><a href="#1-集群和分布式" class="headerlink" title="1.集群和分布式"></a>1.集群和分布式</h3><h4 id="1-1-什么是分布式系统-拆子系统"><a href="#1-1-什么是分布式系统-拆子系统" class="headerlink" title="1.1.什么是分布式系统-拆子系统"></a>1.1.什么是分布式系统-<strong>拆子系统</strong></h4><p>​	简单理解分布式就是一个计算机软件系统有多个子系统组成，每个子系统承担着部分职责，分别部署在不同的服务器上，子系统之间通过网络进行交互，共同完成完整的工作，缺一不可。 - 拆分、组合</p><p>​ 理解1：微服务架构天生是分布式系统 一般一个微服务对应一个数据库,也就是数据库也是分布式</p><h4 id="1-2-什么是集群-子系统集群"><a href="#1-2-什么是集群-子系统集群" class="headerlink" title="1.2.什么是集群-子系统集群"></a>1.2.什么是集群-子系统集群</h4><p>​	简单理解集群就是把一个计算机软件系统，部署成多份(复制)来提供工作能力，多个软件系统分别部署在不同的服务器上，每个服务器我们称之为节点，服务器之间无需通信，每个软件系统(节点)都是完整的功能，部分节点挂掉(down)，还有其他节点处理请求。- <strong>复制****、减压</strong></p><p>​ <strong>同一个子系统部署多份，减轻负载压力。</strong> 微服务中集群: 直接部署多个nacos, gateway(外置nginx负载期),某微服务直接部署多份,用户数据库进行集群</p><h3 id="2-CAP理论"><a href="#2-CAP理论" class="headerlink" title="2.CAP理论"></a>2.CAP理论</h3><h4 id="2-1-什么是CAP"><a href="#2-1-什么是CAP" class="headerlink" title="2.1.什么是CAP"></a>2.1.什么是CAP</h4><ul><li><p>一致性（Consistency）</p><p>可以理解为分布式中存在多个数据副本，当其中某个数据副本发生数据更新需要实时同步到其他节点上。多个节点数据总是保持一致。例如：同一个数据同时存在于A服务器和B服务器，那么当A服务器的数据发生改变，B服务器的数据始终保持同步。</p><p><img src="/breeze/75a56cf8/1666663707941.png" alt="1666663707941"></p></li><li><p>可用性（Availability）</p><p>客户端在任何时候访问集群，请求都可以正常返回结果，可以允许有一定的延迟。-<strong>不能上锁要能支持随时能用。</strong></p></li><li><p>分区容错性（Partition tolerance）-部署多个节点</p><p>能够容忍当服务之间通信发生故障，整个集群被分割为多个无法相互通信的分区的情况。即当集群因为网络故障被划分为多个分区，集群仍然可用。 —<strong>重试+集群</strong>(放到不同的分区更好)</p></li></ul><h4 id="2-2-常见CAP组合"><a href="#2-2-常见CAP组合" class="headerlink" title="2.2.常见CAP组合"></a>2.2.常见CAP组合</h4><p>定理：任何分布式系统只可同时满足二点，没法三者兼顾。</p><p>忠告：架构师不要将精力浪费在如何设计能满足三者的完美分布式系统，而是应该进行取舍。<br><img src="/breeze/75a56cf8/1635909825807.png" alt="1635909825807"></p><p>1、满足CA舍弃P，也就是满足一致性和可用性，舍弃容错性。但是这也就意味着你的系统不是分布式的了，因为涉及分布式的想法就是把功能分开，部署到不同的机器上。<code>单个mysql服务器</code></p><p>2、满足CP舍弃A，也就是满足一致性和容错性，舍弃可用性。如果你的系统允许有段时间的访问失效等问题，这个是可以满足的。就好比多个人并发买票，后台网络出现故障，你买的时候系统就崩溃了。 redis.set(key,value) 当我在进行操作的时候其他的要进行等待或者超时异常：<code>如 Redis zookeeper consol nacos</code>(默认ap，可以修改cp，可配置)</p><p>3、满足AP舍弃C，也就是满足可用性和容错性，舍弃一致性。这也就是意味着你的系统在并发访问的时候可能会出现数据不一致的情况。 <code>Mysql主从同步 eureaka,</code>nacos默认实现也是ap</p><p>​	因为网络不可控问题，分区容错总是存在的，所以对于一个分布式系统来说，必须具备分区容错性，即需要在AP和CP做选择。 一般选**ap,**但是要使用最终一致性这种弱一致性</p><h3 id="3-Base理论"><a href="#3-Base理论" class="headerlink" title="3.Base理论"></a>3.Base理论</h3><h4 id="3-1-强一致性和最终一致性"><a href="#3-1-强一致性和最终一致性" class="headerlink" title="3.1.强一致性和最终一致性"></a>3.1.强一致性和最终一致性</h4><p><code>CAP理论</code>告诉我们一个分布式系统最多只能同时满足一致性( Consistency)、可用性( Availability )和分区容忍性( Partition tolerance )这三项中的两项,<code>其中AP在实际应用中较多, AP即舍弃一致性,保证可用性和分区容忍性,但是在实际生产中很多场景都要实现最终一致性</code>,比如前边我们举的例子主节点向从节点同步数据,即使不要一致性,但是最终也要将数据同步成功来保证数据一致,这种一致性和CAP中的一致性不同, CAP中的一致性要求在任何时间查询每个结点数据都必须一致,它强调的是<strong>强一致性</strong>,但是<code>最终一致性是允许可以在一段时间内每个结点的数据不一致,但是经过一段时间每个结点的数据必须一致,它强调的是最终一致性</code>。</p><p>1、强一致性–2PC分布式事务</p><p>对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是强一致性。比如小明更新V0到V1，那么小华读取的时候也应该是V1。</p><p>2、弱一致性</p><p>如果能容忍后续的部分或者全部访问不到，则是弱一致性。比如小明更新VO到V1，可以容忍那么小华读取的时候是V0。</p><p>3、最终一致性</p><p>如果经过一段时间后要求能访问到更新后的数据，则是最终一致性。比如小明更新VO到V1，可以使得小华在一段时间之后读取的时候是V1。</p><p>​	<strong>分布式系统通常为了保证系统的可用性，牺牲强一致性，采用最终一致性</strong>。</p><h4 id="3-2-Base理论"><a href="#3-2-Base理论" class="headerlink" title="3.2.Base理论"></a>3.2.Base理论</h4><p>BASE是<strong>B</strong>asically <strong>A</strong>vailable(基本可用)、<strong>S</strong>oft state(软状态)和<strong>E</strong>ventually consistent (最终一致性)三个短语的缩写。<code>BASE理论是对CAP中AP的一个扩展,通过牺牲强一致性来获得可用性,当出现故障允许部分不可用但要保证核心功能可用,允许数据在一段时间内是不一致的,但最终达到一致状态</code>。满足BASE理论的事务,我们称之为”柔性事务”。</p><p>1、基本可用</p><p>​	分布式系统在出现故障时,允许损失部分可用功能,保证核心功能可用。如,电商网站交易付款出现问题了,商品依然可以正常浏览。</p><p>2、软状态</p><p>由于不要求强一致性,所以BASE允许系统中存在中间状态(也叫软状态) ,这个状态不影响系统可用性,如订单的”支付中”、“数据同步中”等状态,待数据最终一致后状态改为“成功”状态。</p><p>3、最终一致</p><p>最终一致是指经过一段时间后,所有节点数据都将会达到一致。如订单的”支付中”状态,最终会变为“支付成功”或者”支付失败” ,使订单状态与实际交易结果达成-致,但需要一定时间的延迟等待。</p><p><strong>操作时其他可用，但是有中间状态，并且要最终一致性</strong>。p一定要满足，c和a二选1，ap用得最多，但是我们还要使用base理论来完成最终一致性</p><h2 id="二-Mysql集群"><a href="#二-Mysql集群" class="headerlink" title="二.Mysql集群"></a>二.Mysql集群</h2><h3 id="1-Mysql集群概述"><a href="#1-Mysql集群概述" class="headerlink" title="1.Mysql集群概述"></a>1.Mysql集群概述</h3><h4 id="1-1-为什么要做Mysql集群"><a href="#1-1-为什么要做Mysql集群" class="headerlink" title="1.1.为什么要做Mysql集群"></a>1.1.为什么要做Mysql集群</h4><p>1、提高并发能力</p><p>2、提高可用性，防止单点故障</p><p>3、防止数据丢失</p><h4 id="1-2-集群方案"><a href="#1-2-集群方案" class="headerlink" title="1.2.集群方案"></a>1.2.集群方案</h4><p>集群：多个服务器一起对外提供一个服务</p><p><img src="/breeze/75a56cf8/1635910110112.png" alt="1635910110112"></p><p>Mysql集群有N种方式但是整体来看,分为<strong>主从</strong>,<strong>多主</strong>，我们这里选择主从模式，因为根据2&#x2F;8原则，数据库的性能瓶颈往往都在80%的读操作上，我们可以搞多个从需要减轻读的压力</p><p>​ 建议采纳: <strong>双主多从</strong></p><p>​</p><h4 id="1-3-什么是Mysql主从？-ap系统"><a href="#1-3-什么是Mysql主从？-ap系统" class="headerlink" title="1.3.什么是Mysql主从？   ap系统"></a>1.3.什么是Mysql主从？ ap系统</h4><p>一个主(Master)多从(Slave)，主负责写操作，从负责读操作，从库的数据从主库同步复制，这样的集群模式就叫主从同步 。<strong>主从复制MySql自己就能完成，我们需要做一些配置即可。</strong></p><p>主从同步的优点是减轻读的压力，如果主库的写并发比较高或者为了解决主库单点故障，可用做成多个主库，多个主库相互复制，这样即提高了主库写的并发能力，也解决了单节点故障问题。</p><p>做了主从同步，我们的应用就需要做<strong>读写分离</strong>，写请求访问主库，读请求访问&#x2F;从库，可以借助一些框架来实现读写分离，如：msyqlproxy , mycat ,ShardingJdbc ，如下图：</p><p><img src="/breeze/75a56cf8/1635910230437.png" alt="1635910230437"></p><p>​ 主从同步（mysql自己实现），读写分离（依赖三方组件,mysqlproxy,mycat(单独服务)，shardingjdbc(jar)）</p><h3 id="2-Mysql主从搭建"><a href="#2-Mysql主从搭建" class="headerlink" title="2.Mysql主从搭建"></a>2.Mysql主从搭建</h3><h4 id="2-1-Mysql主从复制原理-ap系统"><a href="#2-1-Mysql主从复制原理-ap系统" class="headerlink" title="2.1.Mysql主从复制原理-ap系统"></a>2.1.Mysql主从复制原理-ap系统</h4><p>主从复制是通过重放binlog实现主库数据的异步复制。即当主库执行了一条sql命令，那么在从库同样的执行一遍，从而达到主从复制的效果</p><p><img src="/breeze/75a56cf8/1635910301576.png" alt="1635910301576"></p><p>主从复制步骤：</p><ol><li><p>将Master的binary-log日志文件打开，mysql会把所有的DDL,DML,TCL写入BinaryLog日志文件中</p></li><li><p>Master会生成一个 log dump 线程，用来给从库的 i&#x2F;o线程传binlog</p></li><li><p>从库的i&#x2F;o线程去请求主库的binlog，并将得到的binlog日志写到中继日志（relaylog）中</p></li><li><p>从库的sql线程，会读取relaylog文件中的日志，并解析成具体操作，通过主从的操作一致，而达到最终数据一致</p></li></ol><h4 id="2-2-准备环境"><a href="#2-2-准备环境" class="headerlink" title="2.2.准备环境"></a>2.2.准备环境</h4><p>绿色版安装参考它！—————<strong>使用这种方案</strong></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014427391/article/details/122144676">https://blog.csdn.net/u014427391/article/details/122144676</a></p><p>至少需要两台服务器,以后肯定是独立两台电脑,当然也可以使用虚拟机. 教学的时候**,可以安装多个服务(使用不同的端口)来代替服务器.**</p><p>1、分别构造主、从数据库并输出日志（方便定位问题）</p><ul><li><p>关闭MySql服务</p></li><li><p>拷贝mysql安装目录，重命名：master</p></li><li><p>修改新的Mysql的my.ini配置：端口，日志目录，安装目录，数据目录</p></li></ul><p><img src="/breeze/75a56cf8/1635910366742.png" alt="1635910366742"></p><ul><li>拷贝数据：去老的MySql的数据目录拷贝 data\mysql 和 data\performance_schema 到新的MySql的数据目录，这个是MySql的初始化数据。在my.ini中datadir就是数据目录第位置</li></ul><p>2、安装及启动</p><ul><li><p>修改master中的my.ini 路径改为master的路径</p></li><li><p>执行命令安装新的Mysql的服务 ，进入bin目录，cmd执行</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --install master --defaults-file=&quot;C:\Program Files (x86)\MySQL\master\my.ini&quot;</span><br></pre></td></tr></table></figure><p>（install&#x2F;remove of the service denied 权限不足 以管理身份运行cmd.exe）</p><h4 id="2-3-master服务器配置"><a href="#2-3-master服务器配置" class="headerlink" title="2.3.master服务器配置"></a>2.3.master服务器配置</h4><ol><li>修改master方的my.ini，在[mysqld]下</li></ol><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log-bin</span>=mysql-bin</span><br><span class="line"><span class="attr">server-id</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">innodb_flush_log_at_trx_commit</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">sync_binlog</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">binlog_ignore_db</span>=mysql</span><br><span class="line"><span class="attr">binlog_checksum</span>=none</span><br></pre></td></tr></table></figure><ol start="2"><li>重启master服务，登录</li></ol><p><img src="/breeze/75a56cf8/1635910477867.png" alt="1635910477867"></p><ol start="3"><li>授权savle服务器的使用的账号及权限</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Mysql&gt; </span><span class="language-bash">GRANT REPLICATION SLAVE ON *.* to <span class="string">&#x27;yaosang&#x27;</span>@<span class="string">&#x27;192.168.6.4&#x27;</span>identified by <span class="string">&#x27;123456&#x27;</span>;</span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>lvtest：slave连接master使用的账号</li><li>IDENTIFIED BY ‘admin’ ：slave连接master使用的密码</li><li>192.168.77.128：slave IP</li></ul><p><img src="/breeze/75a56cf8/1680059971192.png" alt="1680059971192"></p><ol start="4"><li>查询主数据库状态</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">Mysql&gt; </span><span class="language-bash">show master status;</span></span><br></pre></td></tr></table></figure><p><img src="/breeze/75a56cf8/1635910565338.png" alt="1635910565338"></p><p>记录 File 和 Position的值，File对应的是binlog文件 ， position指的是当前slave同步数据的最新行。在slave端会使用这两个信息。</p><h4 id="2-4-slave配置"><a href="#2-4-slave配置" class="headerlink" title="2.4.slave配置"></a>2.4.slave配置</h4><p>1、修改slave服务器的配置文件my.ini将 server-id &#x3D; 1修改为 server-id &#x3D; 10，并确保这个ID没有被别的MySQL服务所使用。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#log-bin=mysql-bin</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">20</span></span><br></pre></td></tr></table></figure><p>2、启动slave服务器，登录</p><p>3、在slave端，配置master链接信息 (执行语句)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Mysql&gt;  change master to</span><br><span class="line">        master_host=&#x27;172.16.6.254&#x27;,   #master IP</span><br><span class="line">        master_user=&#x27;slaveuser&#x27;,          #master数据库通过GRANT授权的账号</span><br><span class="line">        master_password=&#x27;123456&#x27;,         #master数据库通过GRANT授权的密码</span><br><span class="line">        master_port=3307,              #master数据库的端口</span><br><span class="line">        master_log_file=&#x27;mysql-bin.000001&#x27;, </span><br><span class="line">        #master数据库中通过show master status显示的File名称</span><br><span class="line">        master_log_pos=269         </span><br><span class="line">        #master数据库的通过show master status显示的Position的值</span><br></pre></td></tr></table></figure><p>4、启动同步</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mysql&gt; start slave;</span><br></pre></td></tr></table></figure><p>5、主从同步检查</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status；</span><br></pre></td></tr></table></figure><p>其中Slave_IO_Running 与 Slave_SQL_Running 的值都必须为YES，才表明状态正常。</p><p>6、 测试</p><ul><li><p>在master上，建库、建表、添加数据</p></li><li><p>刷新slave库，记录也存在</p></li></ul><p>由此，整个MySQL主从复制的过程就完成了，接下来，我们进行MySQL读写分离的安装与配置。</p><h2 id="三-分库分表实战"><a href="#三-分库分表实战" class="headerlink" title="三.分库分表实战"></a>三.分库分表实战</h2><h3 id="1-理论设计"><a href="#1-理论设计" class="headerlink" title="1. 理论设计"></a>1. 理论设计</h3><p>分库分表有两种分发,是水平和垂直.</p><h4 id="1-1-垂直分库分表-设计上的"><a href="#1-1-垂直分库分表-设计上的" class="headerlink" title="1.1 垂直分库分表-设计上的"></a>1.1 垂直分库分表-设计上的</h4><h5 id="1-1-垂直分表-宽表拆分-大表拆小表"><a href="#1-1-垂直分表-宽表拆分-大表拆小表" class="headerlink" title="1.1.垂直分表-宽表拆分[大表拆小表]"></a>1.1.垂直分表-宽表拆分[大表拆小表]</h5><p>​	垂直分表可以理解成按列分表，比如一个用户表中包括了 用户登录相关信息，用户基本资料，用户账户信息等等信息，这个表字段太多变得非常庞大，查询的时候必定会有性能影响。</p><p>t_user</p><p><img src="/breeze/75a56cf8/wpsCA68.tmp.jpg" alt="img"></p><p>再加上我们在查询的时候不会把用户的所有数据都要查出来，做登录时只需要登录相关字段，查询个人资料时就只需要基本信息，加载账户的时候只需要账户相关的字段，但是所有字段都在一个表浪费了查询的性能。针对于这种情况我们可以按照业务维度进行垂直分表，每个表有不同的列，如：</p><p>t_login</p><p><img src="/breeze/75a56cf8/wps908.tmp.jpg" alt="img"></p><p>t_user_info</p><p><img src="/breeze/75a56cf8/wps909.tmp.jpg" alt="img"></p><p>t_account</p><p><img src="/breeze/75a56cf8/wps90A.tmp.jpg" alt="img"></p><p>上面的分表的方式就是垂直分表 ， 多个包之间外键关联，如果表关系是一对一，使用相同的ID也可以。</p><p>把一些大字段单独设置出来！平时不用查询，如果硬是要查使用跨表查询</p><h5 id="1-2-垂直分库-按业务分库"><a href="#1-2-垂直分库-按业务分库" class="headerlink" title="1.2.垂直分库-按业务分库"></a>1.2.垂直分库-按业务分库</h5><p>一个mysql服务,要安装在一台服务器上面,这台服务器资源(内存,cpu等)是有限的.当数据库的并发请求非常高。</p><p><img src="/breeze/75a56cf8/wpsB614.tmp.jpg" alt="img"></p><p>一个mysql数据处理不了就可以考虑使用多个mysql服务来分担压力，垂直分库就是把一个数据库中的N张表，按照模块&#x2F;业务 划分到多个Mysql数据库，每个数据库都有自己的服务器，进行分布式部署。</p><p><img src="/breeze/75a56cf8/wpsDD06.tmp.jpg" alt="img"></p><p>[<code>注意</code>]微服务架构:天然就是分库. 它要求各自服务都要有自己数据库.</p><h4 id="1-2-水平分库分表-海量表拆分小表"><a href="#1-2-水平分库分表-海量表拆分小表" class="headerlink" title="1.2.水平分库分表 -海量表拆分小表"></a>1.2.水平分库分表 -海量表拆分小表</h4><h5 id="1-2-1-水平分表"><a href="#1-2-1-水平分表" class="headerlink" title="1.2.1.水平分表"></a>1.2.1.水平分表</h5><p>水平分表可以理解成按行分表，一个表中的数据量一千万行，查询注定慢，我们可以把这个表中的数据拆分成10个小表，每个表一百万行数据，每个小表拥有相同的列，如：</p><p><img src="/breeze/75a56cf8/1666683670510.png" alt="1666683670510"></p><p>水平分表会带来很多的问题？比如按什么规则来分表，场景的分表规则有：</p><ol><li>按区间范围分表</li></ol><p>一般在有严格的自增id需求上，如按照user_id水平分表：</p><ul><li><p>table_1 user_id从1~100w</p></li><li><p>table_2 user_id从100W+1~200w</p></li><li><p>table_3 user_id从200W+1~300w</p></li></ul><p>实现方式有：</p><ul><li>新创建一个表，该表的自增ID作为分表的ID（性能差）</li><li>使用Redis的自增incr 命令</li><li>使用UUID(比较low)</li><li>雪花算法</li></ul><ol start="2"><li>按时间分表</li></ol><p>比如一个月分一个表，那么一年也就分12张表 ，这种方式适用于时效性很强的场景，比如登录日志，一般都是看最近一个月的日志，很少去看一月前的，或者一年前的。甚至更老旧的数据可以直接删掉。</p><ol start="3"><li>Hash分表</li></ol><p></p><p>通过ID或者名称通过一定的hash算法计算出数据存储表的表名然后访问相应的表,这种方法比较通用</p><p>比如：准备好100个表 ： t_course_01 , t_course_02, … ,t_course_100</p><p>然后计算：t_course_hash(商品名+id) % 100 +1 ，余数就对应表名</p><ol start="4"><li>雪花算法</li></ol><p>Snowflake，雪花算法是由<strong>Twitter</strong>开源的分布式ID生成算法，以划分命名空间的方式将 64-bit位分割	成多个部分，每个部分代表不同的含义(41位时间戳,10位机器号，12位序列号)。而 Java中64bit的整数是Long类型，所以在 Java 中 SnowFlake 算法生成的 ID 就是 long 来存储的</p><p>分布式id生成方案 : <a target="_blank" rel="noopener" href="https://blog.csdn.net/charlesyoosky/article/details/95164847">https://blog.csdn.net/charlesyoosky/article/details/95164847</a></p><h5 id="1-2-2-水平分库"><a href="#1-2-2-水平分库" class="headerlink" title="1.2.2.水平分库"></a>1.2.2.水平分库</h5><p>即使做了水平分表，表太多也会影响数据库的效率，水平分库指定是把一个数据库中的表分到多个数据库中，数据库采用分布式部署，比如电商平台针对于商品库我们可以按照商户来分，如下：</p><p><img src="/breeze/75a56cf8/wps8DFD.tmp.jpg" alt="img"></p><p>最NB方案：垂直分库 ；水平分库 ；水平分表 ; 垂直分表 ；集群(主从同步&amp;读写分离)</p><p><img src="/breeze/75a56cf8/1635911186513.png" alt="1635911186513"></p><p>分库分表操作思路:</p><p>1 按照业务进行垂直分库 商品和店铺隔离开来 微服务架构都要这样干</p><p>2 把商品业务进行水平分库 多个商品库服务器</p><p>3 可以对水平分库后每一个数据库服务器进行集群. 多个商品库服务器群</p><p>4 进行垂直分表 把多字段表拆分少量字段表. 每一个库里面宽表进行拆分</p><p>5 进行水平分表 把海量数据表拆分为多个小表 把每一个大表进行拆分</p><p><strong>数据库优化顺序 ：</strong></p><p><strong>1)垂直分库 ，垂直分表，冗余设计(反第三范式),存储引擎,索引，SQL优化 ，缓存(热点查询)，全文检索(搜索场景)，页面静态化</strong></p><p>​ <strong>分布式项目可以直接考虑垂直分库</strong></p><p><strong>2)主从(读压力大)-集群-高并发</strong></p><p><strong>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</strong></p><p><strong>3)水平分表</strong></p><p><strong>4)水平分库</strong></p><hr><p><strong>先垂直+集群+优化技术能搞定就不要水平操作,因为操作比较复杂,要一定的分库分表策略. 实在满足不了,可以是使用水平操作.</strong></p><p>项目支持50W???,从理论上支持,项目使用</p><p>1 微服务架构,每个微服务可以按需进行集群扩展,</p><p>2 并且相关组件也可以进行按需集群 mysql es redis</p><p>3 并还使用大量优化技术. 缓存,全文检索,页面静态化(pc浏览器) 数据库优化,jvm优化等!!!</p><p>其实我们测人人员做过10W性能测试,是支持! 你用了多少设备?? 这个我不太清楚…..</p><p>jmeter:性能测试工具</p><h4 id="1-3-分库分表后问题"><a href="#1-3-分库分表后问题" class="headerlink" title="1.3.分库分表后问题"></a>1.3.分库分表后问题</h4><h5 id="1-3-1-分布式事务-垂直分库"><a href="#1-3-1-分布式事务-垂直分库" class="headerlink" title="1.3.1.分布式事务-垂直分库"></a>1.3.1.分布式事务-垂直分库</h5><p>分库后会带来一些棘手的问题：一个操作设计到多个库的话需要有分布式事务的支持</p><p>1、单数据库实例：</p><p><img src="/breeze/75a56cf8/wps6947.tmp.jpg" alt="img"></p><p>2、多数据库实例：</p><p><img src="/breeze/75a56cf8/wpsAA58.tmp.jpg" alt="img"></p><h5 id="1-3-2-跨库操作查询-垂直分库"><a href="#1-3-2-跨库操作查询-垂直分库" class="headerlink" title="1.3.2.跨库操作查询-垂直分库"></a>1.3.2.跨库操作查询-垂直分库</h5><p>一个查询的数据来源于两个库，那么需要从两个库进行查询</p><p><img src="/breeze/75a56cf8/wpsE14.tmp.jpg" alt="img"></p><p>如果是同一个库,通过反第三方式,在商品表设计冗余字段店铺名称和id就ok,以后直接查询商品表就行了.</p><p>如果不同库,也可以使用反第三范式. 改了店铺信息后同步修改商品里面店铺信息,同步在执行一条sql就行,</p><p>但是如果不同库,要远程发起请求去改… 是同一个库可以使用触发器</p><h5 id="1-3-3-跨节点操作排序分页-水平分库"><a href="#1-3-3-跨节点操作排序分页-水平分库" class="headerlink" title="1.3.3.跨节点操作排序分页-水平分库"></a>1.3.3.跨节点操作排序分页-水平分库</h5><p>一个分页查询，正好某一页的数据来源于两个库，那么需要先对两个库的数据进行合并之后，在再执行SQL进行查询操作(复制，性能不好)</p><p><img src="/breeze/75a56cf8/1635911350603.png" alt="1635911350603"></p><h5 id="1-3-4-主键重复"><a href="#1-3-4-主键重复" class="headerlink" title="1.3.4.主键重复"></a>1.3.4.主键重复</h5><p>如果水平分表之后，每个表ID都是自动增长，就会出现 商品表A的ID和商品表B的ID出现重复，需要使用全局唯一ID即：分布式ID，比如使用雪花算法来实现,自己写算法实现[不重复,最好是有规律]。</p><p><img src="/breeze/75a56cf8/wps148A.tmp.jpg" alt="img"></p><h5 id="1-3-5-公共表"><a href="#1-3-5-公共表" class="headerlink" title="1.3.5.公共表"></a>1.3.5.公共表</h5><p>如果两个库都有用到某个表，该如何处理？两个库都放这个表，使用ShardingJDBC设置公共表</p><p><img src="/breeze/75a56cf8/wps148B.tmp.jpg" alt="img"></p><p>一切以上的问题可以直接解决,当然也可以通过三方框架实现 sharding-jdbc</p><h5 id="1-3-6-水平分库分表效率说明"><a href="#1-3-6-水平分库分表效率说明" class="headerlink" title="1.3.6.水平分库分表效率说明"></a>1.3.6.水平分库分表效率说明</h5><p>​ 一定能提高效率吗?? 水平分库分表在操作之前要通过分库分表策略进行计算后再来操作.这个过程也要浪费时间.如果数据量少,没有必要水平分表分库. 500W左右 5亿–&gt;100 订单???? 商品?????</p><h3 id="2-分库分表-集群方案"><a href="#2-分库分表-集群方案" class="headerlink" title="2.分库分表&amp;集群方案"></a>2.分库分表&amp;集群方案</h3><h4 id="4-1-集群-主从同步，读写分离"><a href="#4-1-集群-主从同步，读写分离" class="headerlink" title="4.1.集群-主从同步，读写分离"></a>4.1.集群-主从同步，读写分离</h4><p>​ 主从同步由mysql自己实现，但是读写分离需要<strong>三方组件</strong>支持。</p><h4 id="4-2-分库分表-垂直方向-设计层面"><a href="#4-2-分库分表-垂直方向-设计层面" class="headerlink" title="4.2.分库分表-垂直方向-设计层面"></a>4.2.分库分表-垂直方向-设计层面</h4><p>​	当做一个独立的表或者库处理就ok，微服务架构中，都是进行了分库的。</p><h4 id="4-3-分库分表-水平方向"><a href="#4-3-分库分表-水平方向" class="headerlink" title="4.3.分库分表-水平方向"></a>4.3.分库分表-水平方向</h4><p>需要计算库和计算表，也要<strong>三方组件</strong>支持。</p><p>我们只需要实现水平分表和水平分库及读写分离。</p><h4 id="4-4-组件选择"><a href="#4-4-组件选择" class="headerlink" title="4.4.组件选择"></a>4.4.组件选择</h4><ol><li><p><strong>sharding-sphere：jar</strong>，前身是sharding-jdbc；<strong>分库分表,读写分离</strong>，当当网开源框架，文档丰富，使用成本低。 jar</p></li><li><p>TDDL：jar，Taobao Distribute Data Layer；淘宝业务框架，TDDL复杂度相对较高。当前公布的文档较少，只开源动态数据源，分表分库部分还未开源，还需要依赖diamond，不推荐使用。</p></li><li><p>Mycat：中间件。 使用起来比较复杂,需要安装额外的环境,不稳定，第三方应用，考虑中间件备份与集群</p><p>单独部署组件,对它集群</p></li><li><p>Mysql-proxy(基本淘汰)：mysql-proxy是官方提供的mysql中间件产品可以实现负<strong>载平衡，读写分离</strong>，failover等，但其不支持大数据量的分库分表且性能较差。</p></li></ol><h3 id="3-Sharding-sphere简介"><a href="#3-Sharding-sphere简介" class="headerlink" title="3.Sharding-sphere简介"></a>3.Sharding-sphere简介</h3><h4 id="5-1-什么是Sharding-sphere"><a href="#5-1-什么是Sharding-sphere" class="headerlink" title="5.1.什么是Sharding-sphere"></a>5.1.什么是Sharding-sphere</h4><p>官网：<a target="_blank" rel="noopener" href="http://shardingsphere.apache.org/index_zh.html">http://shardingsphere.apache.org/index_zh.html</a></p><p><strong>Apache ShardingSphere 是一套开源的分布式数据库中间件解决方案组成的生态圈，它由 JDBC、Proxy 和 Sidecar（规划中）这 3 款相互独立，却又能够混合部署配合使用的产品组成。</strong> 它们均提供标准化的数据分片、分布式事务和数据库治理功能，可适用于如 Java 同构、异构语言、云原生等各种多样化的应用场景。</p><p>Apache ShardingSphere 定位为关系型数据库中间件，旨在充分合理地在分布式的场景下利用关系型数据库的计算和存储能力，而并非实现一个全新的关系型数据库。 它通过关注不变，进而抓住事物本质。关系型数据库当今依然占有巨大市场，是各个公司核心业务的基石，未来也难于撼动，我们目前阶段更加关注在原有基础上的增量，而非颠覆。</p><p>Apache ShardingSphere 5.x 版本开始致力于可插拔架构，项目的功能组件能够灵活的以可插拔的方式进行扩展。 目前，<strong>数据分片、读写分离</strong>、多数据副本、数据加密、影子库压测等功能，以及 MySQL、PostgreSQL、SQLServer、Oracle 等 SQL 与协议的支持，均通过插件的方式织入项目。 开发者能够像使用积木一样定制属于自己的独特系统。Apache ShardingSphere 目前已提供数十个 SPI 作为系统的扩展点，仍在不断增加中。</p><p>ShardingSphere 已于2020年4月16日成为 Apache 软件基金会的顶级项目。</p><p><img src="/breeze/75a56cf8/wpsBBB0.tmp.jpg" alt="img"></p><p><strong>Sharding-sphere是一个关系型数据库的分布式中间件。有三个部分组成，sharding-jdbc(JAVA)，sharding-proxy(异构系统)，Sharding-Sidecar(云原生)。</strong></p><h4 id="5-2-sharding-jdbc"><a href="#5-2-sharding-jdbc" class="headerlink" title="5.2.sharding-jdbc"></a>5.2.sharding-jdbc</h4><p>sharding-jdbc 是一个开源的适用于微服务的分布式数据访问基础类库（jar），它始终以云原生的基础开发套件为目标。只支持java语言</p><p>sharding-jdbc定位为轻量级java框架,使用客户端直连数据库,以jar包的形式提供服务,未使用中间层,无需额外部署,并无其他依赖,,可以理解为增强版的JDBC驱动</p><p>sharding-jdbc完整的实现了分库分表&#x2F;读写分离&#x2F;分布式主键功能,并实现了柔性事务.特点如</p><ul><li><p>适用于任何基于Java的ORM框架，如：JPA, Hibernate, <strong>Mybatis</strong>, Spring JDBC Template或直接使用JDBC。</p></li><li><p>基于任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, <strong>HikariCP</strong>等。</p></li><li><p>支持任意实现JDBC规范的数据库。目前支持<strong>MySQL</strong>，Oracle，SQLServer和PostgreSQL。</p></li></ul><h4 id="5-3-Sharding-Proxy-支持多语言"><a href="#5-3-Sharding-Proxy-支持多语言" class="headerlink" title="5.3.Sharding-Proxy-支持多语言"></a>5.3.Sharding-Proxy-支持多语言</h4><p>定位为透明化的数据库代理端，提供封装了数据库二进制协议的服务端版本，用于完成对异构语言的支持。 目前先提供MySQL版本，它可以使用任何兼容MySQL协议的访问客户端(如：MySQL Command Client, MySQL Workbench等)操作数据，对DBA更加友好。</p><p><img src="/breeze/75a56cf8/wps8D35.tmp.jpg" alt="img"></p><h4 id="5-4-Sharding-Sidecar"><a href="#5-4-Sharding-Sidecar" class="headerlink" title="5.4.Sharding-Sidecar"></a>5.4.Sharding-Sidecar</h4><p>​	定位为Kubernetes（k8s）或Mesos的云原生数据库代理，以DaemonSet的形式代理所有对数据库的访问。 通过无中心、零侵入的方案提供与数据库交互的的啮合层，即Database Mesh，又可称<strong>数据网格。</strong></p><h3 id="4-ShardingJDBC实战-读写分离-分库分表实战"><a href="#4-ShardingJDBC实战-读写分离-分库分表实战" class="headerlink" title="4.ShardingJDBC实战-读写分离&amp;分库分表实战"></a>4.ShardingJDBC实战-读写分离&amp;分库分表实战</h3><p>见word文档</p><h4 id="6-1-集成ShardingJDBC"><a href="#6-1-集成ShardingJDBC" class="headerlink" title="6.1.集成ShardingJDBC"></a>6.1.集成ShardingJDBC</h4><p>配置文档：<a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/">https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/</a></p><p>导入依赖：需要排除guava会和SpringCloud中的guava包冲突</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入shardingjdbc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.shardingsphere.datasource.names</span>=<span class="string">ds</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.jdbcUrl</span>=<span class="string">jdbc:mysql://localhost:3306/shardingjdbc_test</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">cn.ronghuanet.domain  # 配置别名包</span></span><br></pre></td></tr></table></figure><p>不再以默认的方式配置DataSource,而是以spring.shardingsphere前缀配置datasource，项目依然可以使用datasource</p><h4 id="6-2-分布式id-雪花算法"><a href="#6-2-分布式id-雪花算法" class="headerlink" title="6.2. 分布式id-雪花算法"></a>6.2. 分布式id-雪花算法</h4><p>配置多数据源，把配置改成如下效果：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.names</span>=<span class="string">ds</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3306/shardingjdbc_test</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_user.key-generator.column</span>=<span class="string">id</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_user.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br></pre></td></tr></table></figure><p>​</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.mliutm.mapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">loadById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeById</span><span class="params">(Long id)</span>;   <span class="comment">// 删除,做事务管理的</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into t_user(username,age) value(#&#123;username&#125;,#&#123;age&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUsername(<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">10</span>);</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/breeze/75a56cf8/1685590990146.png" alt="1685590990146"></p><h4 id="6-3-读写分离"><a href="#6-3-读写分离" class="headerlink" title="6.3.   读写分离"></a>6.3. 读写分离</h4><h5 id="6-3-1-一主多从"><a href="#6-3-1-一主多从" class="headerlink" title="6.3.1 一主多从"></a>6.3.1 一主多从</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.shardingsphere.datasource.names</span>=<span class="string">master,slave</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.master.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.master.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.master.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3308/crm</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.master.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.master.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.slave.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.slave.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.slave.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3309/crm</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.slave.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.slave.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#配置读写分离</span></span><br><span class="line"><span class="attr">spring.shardingsphere.masterslave.name</span>=<span class="string">ms</span></span><br><span class="line"><span class="attr">spring.shardingsphere.masterslave.master-data-source-name</span>=<span class="string">master</span></span><br><span class="line"><span class="attr">spring.shardingsphere.masterslave.slave-data-source-names</span>=<span class="string">slave</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><h5 id="6-3-2-双主多从"><a href="#6-3-2-双主多从" class="headerlink" title="6.3.2 双主多从"></a>6.3.2 双主多从</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">ds_master0,</span> <span class="string">ds_slave00,</span> <span class="string">ds_slave01,</span> <span class="string">ds_master1,</span> <span class="string">ds_slave10,</span> <span class="string">ds_slave11</span></span><br><span class="line">      <span class="attr">ds_master0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db_master0</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ds_slave00:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3307/db_slave00</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ds_slave01:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3308/db_slave01</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ds_master1:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3310/db_master1</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ds_slave10:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3311/db_slave10</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ds_slave11:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">org.apache.commons.dbcp2.BasicDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3312/db_slave11</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">masterslave:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ms_group0</span></span><br><span class="line">      <span class="attr">load-balance-algorithm-type:</span> <span class="string">round_robin</span></span><br><span class="line">      <span class="attr">ha-type:</span> <span class="string">PRIMARIES_TAG</span></span><br><span class="line">      <span class="attr">write:</span> <span class="string">ds_master0</span></span><br><span class="line">      <span class="attr">readwrite-splitting:</span></span><br><span class="line">        <span class="attr">ds_master0:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ms0</span></span><br><span class="line">          <span class="attr">slave-data-source-names:</span> <span class="string">ds_slave00,</span> <span class="string">ds_slave01</span></span><br><span class="line">        <span class="attr">ds_master1:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ms1</span></span><br><span class="line">          <span class="attr">slave-data-source-names:</span> <span class="string">ds_slave10,</span> <span class="string">ds_slave11</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">上述配置中定义了六个数据源：ds_master0 和 ds_master1 分别表示两个主库，ds_slave00、ds_slave01、ds_slave10、ds_slave11 分别表示四个从库。在 masterslave 子节点中，ha-<span class="keyword">type</span> <span class="type">属性设置为 </span>PRIMARIES_TAG，表示基于标签的主库高可用方案。在数据源列表中，ds_master0 和 ds_slave00, ds_slave01 都有一个标签 <span class="string">&quot;ds0&quot;</span>，ds_master1 和 ds_slave10, ds_slave11 都有标签 <span class="string">&quot;ds1&quot;</span>。这样可以保证同一标签下的主从数据库始终保持同步。</span><br><span class="line"></span><br><span class="line">在 readwrite-splitting 子节点中，指定了读写分离的策略。在该示例中，ds_master0 与 ds_slave00、ds_slave01 组成一个名为 ms0 的读写分离组，ds_master1 与 ds_slave10、ds_slave11 组成一个名为 ms1 的读写分离组。对于读操作，可以通过 ShardingSphere-JDBC 提供的负载均衡算法（round_robin）进行路由。无论是写操作还是读操作，都可以直接使用数据源名称进行直接访问。</span><br></pre></td></tr></table></figure><h4 id="6-4-分库分表-水平方向"><a href="#6-4-分库分表-水平方向" class="headerlink" title="6.4 分库分表-水平方向"></a>6.4 分库分表-水平方向</h4><p><img src="/breeze/75a56cf8/1685603046887.png" alt="1685603046887"></p><p>application.properties配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.shardingsphere.datasource.names</span>=<span class="string">ds0,ds1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds0.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds0.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3306/card_goods_1</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds1.type</span>=<span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds1.jdbc-url</span>=<span class="string">jdbc:mysql://localhost:3306/card_goods_2</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.shardingsphere.datasource.ds1.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#水平分库</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column</span>=<span class="string">shop_id</span></span><br><span class="line"><span class="comment">#通过分库策略确定数据源,进而确定那个库</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression</span>=<span class="string">ds$-&gt;&#123;shop_id % 2&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#水平分表</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_goods.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_goods_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_goods.table-strategy.inline.sharding-column</span>=<span class="string">id</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_goods.table-strategy.inline.algorithm-expression</span>=<span class="string">t_goods_$-&gt;&#123;id % 2+1&#125;</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_goods.key-generator.column</span>=<span class="string">id</span></span><br><span class="line"><span class="attr">spring.shardingsphere.sharding.tables.t_goods.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">mapper</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Insert(&quot;insert into t_goods(name,shop_id) value(#&#123;name&#125;,#&#123;shopId&#125;)&quot;)</span></span><br><span class="line">    <span class="meta">@Options(useGeneratedKeys = true,keyColumn = &quot;id&quot;,keyProperty = &quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Goods goods)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from t_goods&quot;)</span></span><br><span class="line">    List&lt;Goods&gt; <span class="title function_">loadAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test</span><br><span class="line"><span class="keyword">package</span> cn.mliutm.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.mliutm.AppStart;</span><br><span class="line"><span class="keyword">import</span> cn.mliutm.domain.Goods;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = AppStart.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsMapperTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsMapper goodsMapper;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//表分散不均匀,雪花算法和线程id有关系,真实环境中没有问题!!  每个请求都是一个线程,先要用多线程来模拟</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">finalI</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    Goods goods;</span><br><span class="line">                    <span class="keyword">if</span> (finalI %<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                        goods = <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="literal">null</span>,<span class="string">&quot;goods&quot;</span>+ finalI,<span class="number">1L</span>);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        goods = <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="literal">null</span>,<span class="string">&quot;goods&quot;</span>+ finalI,<span class="number">2L</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    goodsMapper.save(goods);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Goods&gt; goods = goodsMapper.loadAll();</span><br><span class="line">        System.out.println(goods.size());</span><br><span class="line">        goods.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-5-注意"><a href="#6-5-注意" class="headerlink" title="6.5.注意"></a>6.5.注意</h4><p>你可能会菜的坑</p><p>1.2个库中的表都是一样的 t_order0 , t_order1</p><ol start="2"><li><p>注意表名和库名，是中划线还是下划线</p></li><li><p>Insert的SQL中是不需要为分表的字段添加值的</p></li><li><p>配置文件不要写错，核对核对再核对 ，datasource的名字和数据库的名字保持一致</p></li></ol><p>分库分表的列就不要自动递增了，也不要主键了</p><h2 id="四-总结"><a href="#四-总结" class="headerlink" title="四.总结"></a>四.总结</h2><h3 id="1-重点内容"><a href="#1-重点内容" class="headerlink" title="1.重点内容"></a>1.重点内容</h3><ul><li>CAP理论</li><li>分库分表概念</li><li>Shardingjdbc实战</li></ul><h3 id="2-面试必备"><a href="#2-面试必备" class="headerlink" title="2.面试必备"></a>2.面试必备</h3><ul><li><p>什么是CAP理论</p></li><li><p>哪些是AP，哪些是CP？讲几个案例</p></li><li><p>什么是垂直分库分表</p></li><li><p>什么是水平分库分表</p></li><li><p>多少数据量适合分表</p></li><li><p>分表的规则有哪些，你们是按照什么规则分表的，具体算法是什么</p></li><li><p>你们分表后的ID怎么生成</p></li><li><p>你们使用什么技术分表的？</p></li><li><p>ShardingJDBC读写分离怎么配置</p></li><li><p>什么是Mysql主从复制</p></li><li><p>主从复制解决什么问题，不能解决什么问题？</p></li><li><p>主从复制的原理是什么？</p></li><li><p>大概说一下主从复制要做哪些事情</p></li><li><p>你们项目用了几个数据库</p></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mliutm.github.io">清风</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mliutm.github.io/breeze/75a56cf8.html">https://mliutm.github.io/breeze/75a56cf8.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mliutm.github.io" target="_blank">清风</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="/img/photo-1692708632140-ee01624d558d.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/breeze/613abb62.html" title="基础设计模式与框架源码"><img class="cover" src="/img/photo-1692708632140-ee01624d558d.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">基础设计模式与框架源码</div></div></a></div><div class="next-post pull-right"><a href="/breeze/1a45f578.html" title="JVM优化"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JVM优化</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/breeze/797f8627.html" title="MySQL单机优化"><img class="cover" src="/img/photo-1688475747590-d0db5e2412cb.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-14</div><div class="title">MySQL单机优化</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">清风</div><div class="author-info__description">清风洒六合，邈然不可攀</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">142</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">72</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:huangpan0805@163.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div><timing></timing></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%9A%E6%9C%BA%E4%BC%98%E5%8C%96"><span class="toc-text">数据库多机优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-text">内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-CAP-Base%E7%90%86%E8%AE%BA"><span class="toc-text">一.CAP&amp;Base理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-text">1.集群和分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F-%E6%8B%86%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-text">1.1.什么是分布式系统-拆子系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%86%E7%BE%A4-%E5%AD%90%E7%B3%BB%E7%BB%9F%E9%9B%86%E7%BE%A4"><span class="toc-text">1.2.什么是集群-子系统集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-CAP%E7%90%86%E8%AE%BA"><span class="toc-text">2.CAP理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AFCAP"><span class="toc-text">2.1.什么是CAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%B8%B8%E8%A7%81CAP%E7%BB%84%E5%90%88"><span class="toc-text">2.2.常见CAP组合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Base%E7%90%86%E8%AE%BA"><span class="toc-text">3.Base理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">3.1.强一致性和最终一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-Base%E7%90%86%E8%AE%BA"><span class="toc-text">3.2.Base理论</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-Mysql%E9%9B%86%E7%BE%A4"><span class="toc-text">二.Mysql集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Mysql%E9%9B%86%E7%BE%A4%E6%A6%82%E8%BF%B0"><span class="toc-text">1.Mysql集群概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%81%9AMysql%E9%9B%86%E7%BE%A4"><span class="toc-text">1.1.为什么要做Mysql集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88"><span class="toc-text">1.2.集群方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E4%BB%80%E4%B9%88%E6%98%AFMysql%E4%B8%BB%E4%BB%8E%EF%BC%9F-ap%E7%B3%BB%E7%BB%9F"><span class="toc-text">1.3.什么是Mysql主从？ ap系统</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Mysql%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA"><span class="toc-text">2.Mysql主从搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86-ap%E7%B3%BB%E7%BB%9F"><span class="toc-text">2.1.Mysql主从复制原理-ap系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text">2.2.准备环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-master%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">2.3.master服务器配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-slave%E9%85%8D%E7%BD%AE"><span class="toc-text">2.4.slave配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E6%88%98"><span class="toc-text">三.分库分表实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%90%86%E8%AE%BA%E8%AE%BE%E8%AE%A1"><span class="toc-text">1. 理论设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E8%AE%BE%E8%AE%A1%E4%B8%8A%E7%9A%84"><span class="toc-text">1.1 垂直分库分表-设计上的</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8-%E5%AE%BD%E8%A1%A8%E6%8B%86%E5%88%86-%E5%A4%A7%E8%A1%A8%E6%8B%86%E5%B0%8F%E8%A1%A8"><span class="toc-text">1.1.垂直分表-宽表拆分[大表拆小表]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93-%E6%8C%89%E4%B8%9A%E5%8A%A1%E5%88%86%E5%BA%93"><span class="toc-text">1.2.垂直分库-按业务分库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E6%B5%B7%E9%87%8F%E8%A1%A8%E6%8B%86%E5%88%86%E5%B0%8F%E8%A1%A8"><span class="toc-text">1.2.水平分库分表 -海量表拆分小表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="toc-text">1.2.1.水平分表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93"><span class="toc-text">1.2.2.水平分库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%90%8E%E9%97%AE%E9%A2%98"><span class="toc-text">1.3.分库分表后问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93"><span class="toc-text">1.3.1.分布式事务-垂直分库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2-%E8%B7%A8%E5%BA%93%E6%93%8D%E4%BD%9C%E6%9F%A5%E8%AF%A2-%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93"><span class="toc-text">1.3.2.跨库操作查询-垂直分库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-3-%E8%B7%A8%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C%E6%8E%92%E5%BA%8F%E5%88%86%E9%A1%B5-%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93"><span class="toc-text">1.3.3.跨节点操作排序分页-水平分库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4-%E4%B8%BB%E9%94%AE%E9%87%8D%E5%A4%8D"><span class="toc-text">1.3.4.主键重复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-5-%E5%85%AC%E5%85%B1%E8%A1%A8"><span class="toc-text">1.3.5.公共表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-6-%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%95%88%E7%8E%87%E8%AF%B4%E6%98%8E"><span class="toc-text">1.3.6.水平分库分表效率说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88"><span class="toc-text">2.分库分表&amp;集群方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%EF%BC%8C%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">4.1.集群-主从同步，读写分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E5%9E%82%E7%9B%B4%E6%96%B9%E5%90%91-%E8%AE%BE%E8%AE%A1%E5%B1%82%E9%9D%A2"><span class="toc-text">4.2.分库分表-垂直方向-设计层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E6%B0%B4%E5%B9%B3%E6%96%B9%E5%90%91"><span class="toc-text">4.3.分库分表-水平方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E7%BB%84%E4%BB%B6%E9%80%89%E6%8B%A9"><span class="toc-text">4.4.组件选择</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Sharding-sphere%E7%AE%80%E4%BB%8B"><span class="toc-text">3.Sharding-sphere简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E4%BB%80%E4%B9%88%E6%98%AFSharding-sphere"><span class="toc-text">5.1.什么是Sharding-sphere</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-sharding-jdbc"><span class="toc-text">5.2.sharding-jdbc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-Sharding-Proxy-%E6%94%AF%E6%8C%81%E5%A4%9A%E8%AF%AD%E8%A8%80"><span class="toc-text">5.3.Sharding-Proxy-支持多语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-Sharding-Sidecar"><span class="toc-text">5.4.Sharding-Sidecar</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ShardingJDBC%E5%AE%9E%E6%88%98-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E6%88%98"><span class="toc-text">4.ShardingJDBC实战-读写分离&amp;分库分表实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E9%9B%86%E6%88%90ShardingJDBC"><span class="toc-text">6.1.集成ShardingJDBC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-%E5%88%86%E5%B8%83%E5%BC%8Fid-%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95"><span class="toc-text">6.2. 分布式id-雪花算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">6.3. 读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-1-%E4%B8%80%E4%B8%BB%E5%A4%9A%E4%BB%8E"><span class="toc-text">6.3.1 一主多从</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-2-%E5%8F%8C%E4%B8%BB%E5%A4%9A%E4%BB%8E"><span class="toc-text">6.3.2 双主多从</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E6%B0%B4%E5%B9%B3%E6%96%B9%E5%90%91"><span class="toc-text">6.4 分库分表-水平方向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-%E6%B3%A8%E6%84%8F"><span class="toc-text">6.5.注意</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%80%BB%E7%BB%93"><span class="toc-text">四.总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%87%8D%E7%82%B9%E5%86%85%E5%AE%B9"><span class="toc-text">1.重点内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%9D%A2%E8%AF%95%E5%BF%85%E5%A4%87"><span class="toc-text">2.面试必备</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job"><img src="/img/premium_photo-1695185954894-e9382c6f4da8.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="分布式任务调度--xxl-job"></a><div class="content"><a class="title" href="/breeze/736eb1c8.html" title="分布式任务调度--xxl-job">分布式任务调度--xxl-job</a><time datetime="2024-01-16T12:29:19.000Z" title="发表于 2024-01-16 20:29:19">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity"><img src="/img/photo-1653549892896-dde02867edee.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="认证授权-SpringSecurity"></a><div class="content"><a class="title" href="/breeze/7a1a4477.html" title="认证授权-SpringSecurity">认证授权-SpringSecurity</a><time datetime="2024-01-16T01:41:55.000Z" title="发表于 2024-01-16 09:41:55">2024-01-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/7913ff38.html" title="ElasticSearch集群"><img src="/img/photo-1653549892896-dde02867edee.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ElasticSearch集群"></a><div class="content"><a class="title" href="/breeze/7913ff38.html" title="ElasticSearch集群">ElasticSearch集群</a><time datetime="2024-01-14T14:34:16.000Z" title="发表于 2024-01-14 22:34:16">2024-01-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/37cf2cfd.html" title="Redis集群"><img src="/img/photo-1688475747590-d0db5e2412cb.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Redis集群"></a><div class="content"><a class="title" href="/breeze/37cf2cfd.html" title="Redis集群">Redis集群</a><time datetime="2024-01-14T14:27:18.000Z" title="发表于 2024-01-14 22:27:18">2024-01-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/breeze/4b0178e0.html" title="数据结构与算法"><img src="/img/photo-1645943020355-305df166473d.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="数据结构与算法"></a><div class="content"><a class="title" href="/breeze/4b0178e0.html" title="数据结构与算法">数据结构与算法</a><time datetime="2024-01-14T13:51:48.000Z" title="发表于 2024-01-14 21:51:48">2024-01-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/photo-1692708632140-ee01624d558d.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 <i id="heartbeat" class="fa fas fa-heartbeat"></i> 清风</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="/js/timing.js"></script><script id="canvas_nest" defer color="255,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!0,document.body.addEventListener("input",POWERMODE)</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="天枢,天璇,天玑,天权,玉衡,开阳,瑶光" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>